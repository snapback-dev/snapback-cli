{"version":3,"sources":["../../../packages-oss/sdk/src/session/SessionRecovery.ts","../../../packages-oss/sdk/src/session/SessionRollback.ts","../../../packages-oss/sdk/src/analysis/FileChangeAnalyzer.ts","../../../packages-oss/sdk/src/config/Thresholds.ts","../../../packages-oss/sdk/src/analysis/RiskAnalyzer.ts","../../../packages-oss/sdk/src/arch/invariant.ts","../../../packages-oss/sdk/src/arch/rules.ts","../../../packages-oss/sdk/src/auth/DeviceAuthClient.ts","../../../packages-oss/sdk/src/cache/lru-cache.ts","../../../packages-oss/sdk/src/privacy/sanitizer.ts","../../../packages-oss/sdk/src/client.ts","../../../packages-oss/sdk/src/client/ProtectionClient.ts","../../../packages-oss/sdk/src/client/SnapshotClient.ts","../../../packages-oss/sdk/src/config.ts","../../../packages-oss/sdk/src/config/ConfigDetector.ts","../../../packages-oss/sdk/src/config/SnapBackRCParser.ts","../../../packages-oss/sdk/src/core/detection/AIPresenceDetector.ts","../../../packages-oss/sdk/src/core/detection/BurstHeuristicsDetector.ts","../../../packages-oss/sdk/src/core/detection/CursorDetector.ts","../../../packages-oss/sdk/src/core/session/interfaces.ts","../../../packages-oss/sdk/src/core/session/ExperienceClassifier.ts","../../../packages-oss/sdk/src/core/session/SessionCoordinator.ts","../../../packages-oss/sdk/src/core/session/SessionSummaryGenerator.ts","../../../packages-oss/sdk/src/core/session/SessionTagger.ts","../../../packages-oss/sdk/src/encryption/EncryptionService.ts","../../../packages-oss/sdk/src/errors/index.ts","../../../packages-oss/sdk/src/utils/errorHelpers.ts","../../../packages-oss/sdk/src/utils/result.ts","../../../packages-oss/sdk/src/fs/atomic.ts","../../../packages-oss/sdk/src/helpers.ts","../../../packages-oss/sdk/src/utils/hash.ts","../../../packages-oss/sdk/src/privacy/validator.ts","../../../packages-oss/sdk/src/protection/ProtectionManager.ts","../../../packages-oss/sdk/src/utils/security.ts","../../../packages-oss/sdk/src/snapshot/SnapshotDeduplication.ts","../../../packages-oss/sdk/src/snapshot/SnapshotNaming.ts","../../../packages-oss/sdk/src/snapshot/SnapshotManager.ts","../../../packages-oss/sdk/src/storage/StorageErrors.ts","../../../packages-oss/sdk/src/storage/LocalStorage.ts","../../../packages-oss/sdk/src/storage/MemoryStorage.ts","../../../packages-oss/sdk/src/Snapback.ts","../../../packages-oss/sdk/src/session/SessionDeduplication.ts","../../../packages-oss/sdk/src/ai/SimpleChangeTracker.ts","../../../packages-oss/sdk/src/ai/AiSessionTracker.ts","../../../packages-oss/sdk/src/session/sessionAnalytics.ts","../../../packages-oss/sdk/src/session/SessionManager.ts","../../../packages-oss/sdk/src/session/index.ts","../../../packages-oss/sdk/src/snapshot/FileConflictResolver.ts","../../../packages-oss/sdk/src/utils/retry.ts","../../../packages-oss/sdk/src/snapshot/retry-hook.ts","../../../packages-oss/sdk/src/snapshot/SnapshotDeletionService.ts","../../../packages-oss/sdk/src/snapshot/SnapshotIconStrategy.ts","../../../packages-oss/sdk/src/snapshot/SnapshotNamingStrategy.ts","../../../packages-oss/sdk/src/storage/StorageBroker.ts","../../../packages-oss/sdk/src/storage/StorageBrokerAdapter.ts","../../../packages-oss/sdk/src/utils/id-generation.ts","../../../packages-oss/sdk/src/utils/PathNormalizer.ts","../../../packages/sdk/src/analysis/riskFactorDescriptions.ts","../../../packages/sdk/src/dashboard/metrics-client.ts","../../../packages/sdk/src/protection/ProtectionDecisionEngine.ts","../../../packages/sdk/src/snapshot/DiffCalculator.ts","../../../packages/sdk/src/token/TokenBucket.ts","../../../packages/sdk/src/token/RateLimiter.ts","../../../packages/sdk/src/token/DistributedTokenManager.ts"],"names":["SessionRecovery","workspaceRoot","journalDir","join","recoverAll","results","pendingDir","existsSync","files","readdir","file","endsWith","filePath","content","readFile","journal","JSON","parse","result","recoverJournal","push","error","sessionId","basename","status","filesRestored","Error","message","String","cleanupOldJournals","console","journalPath","backupExists","checkBackupsExist","backups","unlink","restoredCount","rollbackFromBackups","emitRecoveryTelemetry","backup","original","safeRename","src","dst","rename","code","copyFile","committedDir","now","Date","sevenDaysMs","timestamp","_sessionId","_filesRestored","listPendingJournals","journals","recoverJournalById","deleteJournal","pendingPath","committedPath","cleanupOrphanedBackups","cleanedCount","orphanedBackups","findOrphanedBackups","backupPath","dir","entries","withFileTypes","entry","fullPath","name","isDirectory","subBackups","includes","SessionRollback","blobStore","rollback","manifest","options","startTime","performance","success","filesReverted","filesSkipped","errors","mkdir","recursive","changes","filesChanged","writeFile","stringify","onProgress","reversedChanges","reverseChanges","stagingDir","deletedDir","stagedFiles","Map","filesToDelete","Set","i","length","change","stageChange","p","path","skipVerification","validationErrors","validateStaging","cleanupStaging","dryRun","Array","from","keys","swapResult","atomicSwap","reverted","skipped","duration","log","toFixed","reversed","reverse","map","inversed","op","hOld","hNew","undefined","sizeBefore","sizeAfter","mtimeBefore","mtimeAfter","modeBefore","modeAfter","eolBefore","eolAfter","temp","_result","stagingPath","add","hash","blobResult","get","ok","value","dirname","mtimeDate","utimes","process","platform","chmod","set","computedHash","createHash","update","digest","processed","total","size","relPath","absPath","rm","force","getPendingJournals","FileChangeAnalyzer","fileSystem","analyzeSnapshot","snapshotFiles","relativePath","snapshotContent","Object","absolutePath","analyzeFile","_error","fileName","getFileName","changeType","linesAdded","linesDeleted","icon","changeSummary","typePriority","modified","deleted","added","unchanged","sort","a","b","priorityDiff","localeCompare","absoluteFilePath","getRelativePath","fileExists","currentContent","lineCount","split","stats","calculateDiffStats","oldContent","newContent","oldLines","newLines","oldSet","newSet","line","has","parts","createChangeSummary","modifiedCount","filter","c","addedCount","deletedCount","unchangedCount","DEFAULT_THRESHOLDS_FROZEN","freeze","session","idleTimeout","minSessionDuration","maxSessionDuration","burst","timeWindow","minCharsInserted","maxKeystrokeInterval","minLinesAffected","minInsertDeleteRatio","experience","explorer","snapshotsCreated","sessionsRecorded","protectedFiles","manualRestores","aiAssistedSessions","daysSinceFirstUse","commandDiversity","intermediate","power","tagging","minBurstConfidence","minLongSessionDuration","maxShortSessionDuration","minLargeEditLines","normalization","multiFileThreshold","multiFileNormalization","longSessionNormalization","largeEditsNormalization","risk","blockingThreshold","criticalThreshold","highThreshold","mediumThreshold","securityScores","evalUsage","functionConstructor","dangerousHtml","execCommand","sqlConcat","hardcodedSecrets","weakCrypto","detection","entropyThreshold","typosquattingDistance","protection","protectedCooldown","otherCooldown","debounceWindow","resources","dedupCacheSize","snapshotMaxFiles","snapshotMaxFileSize","snapshotMaxTotalSize","diffHaloSize","trialSnapshotLimit","freeMonthlyLimit","qos","rateLimitCapacity","rateLimitRefill","eventBusTimeout","eventBusMaxRetries","errorBudgetHard","errorBudgetWarn","batchMax","batchIntervalMs","retryBaseMs","retryMaxMs","maxQueueSize","httpTimeout","docs","description","DEFAULT_THRESHOLDS","THRESHOLDS","structuredClone","createThresholds","overrides","updateThresholds","updated","assign","resetThresholds","DEFAULT_RISK_THRESHOLDS","SECURITY_PATTERNS","pattern","score","recommendation","RiskAnalyzer","thresholds","customPatterns","addPattern","analyze","_filePath","factors","recommendations","totalScore","allPatterns","matches","matchAll","match","type","getLineNumber","index","cappedScore","Math","min","severity","calculateSeverity","shouldBlock","lines","substring","getThresholds","setThresholds","globalConfig","env","NODE_ENV","includeStack","violationCounts","consoleReporter","report","violation","invariantId","context","configureInvariant","config","getInvariantConfig","resetViolationCounts","clear","getViolationCounts","invariant","condition","count","err","stack","stackLines","callerLine","Number","parseInt","reporter","softInvariant","typeInvariant","guard","actualType","actualValue","createScopedInvariant","scope","__name","scopedInvariant","id","assertDefined","assertNonEmptyString","assertPositiveNumber","isNaN","assertNonEmptyArray","isArray","assertPathWithinRoot","root","normalizedPath","replace","normalizedRoot","startsWith","SNAPBACK_LAYER_RULES","source","target","runArchCheck","rules","overrideDefaultRules","customRules","violations","ruleResults","rule","ruleViolations","checkRule","ruleId","passed","errorCount","v","rulesChecked","rulesPassed","r","durationMs","checkNoDependency","checkCycleFree","relative","sources","targets","sourceDir","patterns","escapeRegex","runGrep","globalExclude","exclude","some","ex","ruleDescription","sourceFile","targetFile","importPath","madgeModule","madge","default","fileExtensions","excludeRegExp","RegExp","detectiveOptions","ts","skipTypeImports","cycles","circular","cycle","spawn","Promise","resolve","args","proc","cwd","stdio","stdout","on","data","toString","Boolean","colonIdx","indexOf","slice","rest","lineNumIdx","lineNum","trim","str","createRule","filesIn","shouldNotDependOn","shouldBeCycleFree","withSeverity","excluding","build","DeviceAuthClient","http","state","abortController","currentInterval","httpClient","ky","create","prefixUrl","baseUrl","timeout","getState","cancel","abort","authenticate","callbacks","AbortController","deviceCodeResponse","requestDeviceCode","onDeviceCode","interval","pollForToken","onApproved","currentState","onCancelled","onError","signal","mergeSignals","response","post","json","client_id","clientId","device_code","handleAbortError","expires_in","timeoutMs","attempt","aborted","delay","onPoll","grant_type","mapTokenToAuthResult","onSlowDown","token","api_key","access_token","user_id","tier","refresh_token","ms","setTimeout","addEventListener","clearTimeout","once","signals","combined","createDeviceAuthClient","LRUCache","cache","maxSize","QuickLRU","key","enabled","item","expiry","delete","ttlSeconds","CODE_EXTENSIONS","CONFIG_EXTENSIONS","DOCUMENT_EXTENSIONS","IMAGE_EXTENSIONS","MEDIA_EXTENSIONS","ARCHIVE_EXTENSIONS","DATABASE_EXTENSIONS","BINARY_EXTENSIONS","ALL_EXTENSIONS","FILE_EXTENSION_REGEX","PrivacySanitizer","sanitize","metadata","copy","hashFilePaths","hashedPath","hashFilePath","pathHash","factor","sanitizeString","isPrivacySafe","forbiddenProps","prop","_key","crypto","sanitizeFactor","SDKConfigSchema","z","object","endpoint","string","url","apiKey","privacy","boolean","anonymizeWorkspace","ttl","record","number","retry","maxRetries","backoffMs","WorkspaceIdSchema","FilesArraySchema","array","any","LocalFallback","generateRecommendations","shouldCreateSnapshot","reason","urgency","suggestedTiming","SnapbackClient","sanitizer","localFallback","extend","headers","limit","methods","statusCodes","backoffLimit","getHttpClient","parseRetryAfter","retryAfter","test","date","getTime","max","httpRequest","requestFn","retryLimit","pRetry","AbortError","retries","minTimeout","maxTimeout","randomize","onFailedAttempt","onRetry","attemptNumber","sendMetadata","workspaceId","sanitized","f","logger","warn","accepted","rejected","getAnalytics","cacheKey","forceRefresh","analytics","getRecommendations","searchParams","snapshotRecommendations","healthCheck","version","ProtectionClient","protect","level","invalidateListCache","unprotect","cached","list","filters","put","SnapshotClient","protected","forEach","toISOString","restore","defaultConfig","createConfig","ConfigDetector","excludePatterns","configFiles","changeHandlers","detectConfigFiles","globPatterns","glob","ignore","determineConfigType","pop","parseConfigFile","parsed","valid","extractMetadata","jsonError","pkg","dependencies","devDependencies","scripts","validateConfig","warnings","parseResult","validatePackageJson","validateTsConfig","tsconfig","compilerOptions","module","onConfigChange","handler","VALID_PROTECTION_LEVELS","SnapBackRCParser","isValid","validate","ruleErrors","validateProtectionRule","settings","settingsErrors","validateSettings","policies","policyErrors","validatePolicies","prefix","debounce","excludeFrom","autoSnapshot","maxSnapshots","defaultProtectionLevel","protectionDebounce","maxStorageSize","parallelOperations","minimumProtectionLevel","merge","base","override","_provenance","baseProvenance","overrideProvenance","ignoreSet","hooks","templates","filterByPattern","AI_EXTENSION_IDS","GITHUB_COPILOT","GITHUB_COPILOT_CHAT","CLAUDE","TABNINE","CODEIUM","AMAZON_Q","CONTINUE","BLACKBOX","WINDSURF","ASSISTANT_DISPLAY_NAMES","AIPresenceDetector","extensionProvider","detectAIPresence","installedExtensionIds","getAllExtensionIds","detectedAssistants","hasAI","assistantDetails","isAIAssistantInstalled","assistantName","extensionId","getInstalledAIAssistants","installed","DEFAULT_BURST_CONFIG","BurstHeuristicsDetector","recentChanges","lastChangeTime","recordChange","charsInserted","charsDeleted","linesAffected","changeInfo","trimOldChanges","analyzeBurst","isBurst","confidence","windowChanges","totalInserted","reduce","sum","totalDeleted","totalLines","meetsCharThreshold","meetsLineThreshold","ratio","meetsRatioThreshold","intervals","avgInterval","meetsTimingThreshold","charConfidence","lineConfidence","ratioConfidence","timingConfidence","details","changeCount","cutoffTime","CursorDetector","detect","appName","getAppName","toLowerCase","hasCursor","NoOpLogger","debug","info","NodeTimerService","timeouts","nextId","callback","globalThis","setInterval","clearInterval","dispose","values","DEFAULT_EXPERIENCE_THRESHOLDS","ExperienceClassifier","storage","getExperienceTier","manualTier","metrics","getExperienceMetrics","meetsThreshold","threshold","firstUseTimestamp","commandsUsed","floor","commandsUsedRecord","totalCommands","uniqueCommands","updateExperienceMetrics","activity","current","newValue","recordCommandUsage","command","setExperienceTier","resetExperienceTier","getExperienceTierDescription","DEFAULT_CONFIG","longSessionCheckInterval","SessionCoordinator","candidates","idleTimeoutId","longSessionIntervalId","sessionStart","timers","eventEmitter","resetIdleTimer","startLongSessionMonitoring","addCandidate","uri","snapshotId","candidate","updatedAt","finalizeSession","sessionDuration","candidateCount","resetSession","randomUUID","startedAt","endedAt","changeStats","tags","storeSessionManifest","fire","fileCount","handleWindowBlur","handleGitCommit","handleTaskCompletion","handleManualFinalization","handleIdleTimeout","checkLongSession","maxDuration","getCandidateCount","getSessionStart","SessionSummaryGenerator","snapshotProvider","createSilentLogger","generateSummary","generateDetailedSummary","generateMetadataSummary","allIdentifiers","fileEntry","snapshot","fileContents","identifiers","extractTopIdentifiers","identifier","round","summary","aiTags","tag","topIdentifiers","aiPrefix","extension","extname","extractIdentifiersWithRegex","exec","isCommonKeyword","commonKeywords","SessionTagger","aiPresenceDetector","tagSession","burstResult","reasons","addReasonTags","totalAdded","aiPresence","assistant","uniqueTags","updateSessionWithTags","taggingResult","manual","EncryptionService","PBKDF2_ITERATIONS","KEY_LENGTH","ALGORITHM","IV_LENGTH","deriveKey","userSecret","salt","keyMaterial","subtle","importKey","TextEncoder","encode","iterations","generateChecksum","buffer","hashBuffer","hashArray","Uint8Array","padStart","encryptSnapshot","getRandomValues","iv","plaintext","checksum","plaintextBuffer","ciphertextBuffer","encrypt","ciphertext","decryptSnapshot","blob","decrypt","TextDecoder","decode","verifySecret","Buffer","randomBytes","cipher","createCipheriv","encrypted","concat","final","authTag","getAuthTag","algorithm","decipher","createDecipheriv","setAuthTag","decrypted","computeContentHash","SnapBackError","cause","captureStackTrace","toJSON","SnapshotError","SnapshotNotFoundError","SnapshotCreationError","SnapshotDuplicateError","existingId","SnapshotProtectedError","SnapshotRestoreError","SnapshotVersionError","supportedVersions","SnapshotVerificationError","expected","actual","StorageError","StorageFullError","required","available","retryable","StorageLockError","resource","StorageIOError","ValidationError","InputValidationError","field","PathValidationError","MissingContentError","ApiError","RateLimitError","AuthenticationError","AuthorizationError","isSnapBackError","isSnapshotError","isStorageError","isValidationError","isApiError","isRetryableError","toError","ensureSnapBackError","baseError","_stringifyError","isOk","isErr","fn","mapErr","andThen","unwrap","unwrapOr","defaultValue","unwrapOrElse","fromPromise","promise","fromPromiseWith","errorMapper","sequence","tryAll","operations","tap","tapErr","handlers","toPromise","reject","all","allOrErrors","tryCatch","tryCatchAsync","DEFAULT_MAX_SIZE","atomicWriteFile","encoding","mode","tempSuffix","tempPath","atomicWriteFileSync","contentSize","byteLength","writeFileSync","renameSync","unlinkSync","client","envelope","request","idempotentEnvelope","ensureIdempotentRequestId","evaluatePolicy","ingestTelemetry","request_id","generateRequestId","sha256","input","hashContent","hashWorkspaceId","getBlobPath","levels","segments","PrivacyValidator","isMetadataOnly","forbidden","props","getAllProps","strings","getAllStrings","looksLikeCode","obj","fullKey","codePatterns","ProtectionManager","registry","protectedFile","addedAt","getProtection","directProtection","minimatch","isProtected","getLevel","listProtected","updateLevel","existing","getConfig","updateConfig","SecurityError","validatePath","normalized","normalize","isAbsolute","sep","seg","sanitizeForJSON","SnapshotDeduplication","hashCache","cacheSize","hashFiles","sorted","action","isDuplicate","cachedId","supportsHashLookup","getByContentHash","allSnapshots","isMatch","every","recordHash","clearHash","SnapshotNaming","generateName","strategy","gitStrategy","semanticStrategy","timestampStrategy","capitalize","actionCounts","acc","primaryAction","charAt","toUpperCase","SnapshotManager","deduplication","naming","createSnapshot","createTest","params","fileInput","enableDeduplication","namingStrategy","meta","autoProtect","contentHash","save","targetPath","restoredFiles","restoreAtomic","backupDir","targetBackedUp","totalFiles","targetFilePath","progress","rollbackError","errorMessage","getStoredContentHash","search","criteria","supportsOptimizedSearch","optimizedSearch","hasContent","StorageConnectionError","StorageTransactionError","CorruptedDataError","DatabaseConstructor","loadError","loadBetterSqlite3","LocalStorage","db","dbPath","ensureInitialized","DB","initSchema","sanitizedFiles","sanitizedFileContents","sanitizedMeta","stmt","prepare","run","row","deserializeSnapshot","content_hash","query","after","before","offset","rows","snapshots","close","file_contents","MemoryStorage","_contentHash","cloneSnapshot","s","beforeMs","afterMs","Snapback","snapshotManager","protectionManager","cloudClient","analyticsClient","protectionConfig","defaultLevel","autoProtectConfigs","cloud","sdkConfig","SnapbackAnalyticsClient","fileInputs","listSnapshots","getSnapshot","deleteSnapshot","restoreSnapshot","protectSnapshot","unprotectSnapshot","protectFile","getProtectionLevel","SessionDeduplication","timeDeltaMs","minFilesForDedup","fingerprintCache","computeFingerprint","items","checkDuplicate","fingerprint","timeDelta","existingSessionId","register","unregister","getStats","LARGE_INSERT_THRESHOLD","minChars","minLines","SimpleChangeTracker","totalChars","largeInsertCount","multiLineInsertCount","event","chars","isInsert","isMultiLine","isLargeInsert","reset","light","maxTotalChars","medium","minLargeInserts","minTotalChars","heavy","maxLargeInsertsForSinglePaste","CONFIDENCE","unknown","noneWithNoProvider","noneWithProvider","inferenceOnlyCap","AiSessionTracker","detectEnv","changeTracker","isEnabled","startSession","provider","reasoning","classifyLevel","calculateConfidence","generateReasoning","_provider","_metrics","providerName","makeSafeSessionStartedEvent","makeSafeSessionFinalizedEvent","consent","extCounts","computeExtensionHistogram","ext_counts","counts","ext","getFileExtension","lastDot","lastIndexOf","lastSlash","createAiTracker","cursorDetector","VSCODE_APP_NAME","APP_NAME","getEnvVar","cursorResult","tracker","aiDetectionEnabled","SessionManager","activeSession","idleTimer","flushTimer","aiTracker","idleMs","flushBatchSize","flushIntervalMs","ignorePatterns","runCrashRecovery","catch","recovery","recovered","failed","totalFilesRestored","start","finalize","nanoid","triggers","changeBuffer","triggerBitmask","encodeTriggers","workspaceUri","startIdleTimer","startFlushTimer","emitSessionStarted","track","normalizePath","shouldIgnore","fromPath","oldUri","oldAbsPath","mtime","scheduleFlush","cancelTimers","computeDeferredHashes","aiResult","generateOfflineName","emitSessionFinalized","totalDuration","session_id","started_at","ended_at","change_count","decodeTriggers","getManifest","schema","workspace_uri","dbRowToSessionChange","snapshot_id","dot","stems","stemList","mask","trigger","rel_path","from_path","h_old","h_new","size_before","size_after","mtime_before","mtime_after","mode_before","mode_after","eol_before","eol_after","autoFinalize","FileConflictResolver","fileSearchProvider","resolveAndWrite","_originalMetadata","hasPermission","checkPermissions","resolved","parentDir","writeError","findRenamedFile","originalPath","originalFileName","originalExt","findFiles","newPath","isSimilarFileName","similarity","calculateSimilarity","access","constants","W_OK","rootDir","findExistingAncestor","dirPath","accessSync","name1","name2","base1","base2","distance","levenshteinDistance","maxLen","str1","str2","m","n","dp","fill","j","hash1","hash2","withRetry","operation","maxAttempts","baseDelayMs","maxDelayMs","jitter","calculateBackoff","baseMs","maxMs","exponential","capped","jitterAmount","random","RetryPresets","network","api","critical","fast","diagnoseSnapshotFailure","missingFiles","suggestedFix","userAction","canAutoFix","affectedFiles","absolutePaths","applyAutomaticFix","diagnosis","fromCwd","DEFAULT_RETRY_CONFIG","delayMs","exponentialBackoff","autoFix","verbose","createSnapshotWithRetry","snapshotFn","cfg","lastError","lastDiagnosis","totalAttempts","fixApplied","suggestion","diagnostics","createSnapshotWithRetrySafe","formatDiagnosis","confidencePercent","autoFixBadge","SnapshotDeletionService","confirmationService","unprotectFirst","skipConfirmation","confirmed","confirm","deleteOlderThan","keepProtected","getAll","toDelete","autoCleanup","minimumSnapshots","olderThanDays","eligibleForDeletion","maxToDelete","canDelete","SnapshotIconStrategy","ICON_MAP","color","refactor","database","TEST_FILE_REGEX","CONFIG_FILE_REGEX","STYLE_FILE_REGEX","DOC_FILE_REGEX","SQL_FILE_REGEX","SCHEMA_FILE_REGEX","API_FILE_REGEX","PACKAGE_FILES","CONFIG_FILES","BUG_FIX_KEYWORDS","REFACTOR_KEYWORDS","ADDITION_KEYWORDS","DELETION_KEYWORDS","DOC_KEYWORDS","STYLE_KEYWORDS","API_KEYWORDS","DATABASE_KEYWORDS","PACKAGE_KEYWORDS","CONFIG_KEYWORDS","classifyIcon","nameResult","classifyByName","fileResult","classifyByFiles","getIconMapping","category","getAllIconMappings","lowerName","matchesPrefixKeyword","matchesKeyword","containsTestFiles","containsPackageFiles","containsConfigFiles","containsDocFiles","containsStyleFiles","containsDatabaseFiles","containsApiFiles","keywords","k","lowerFile","execAsync","promisify","SnapshotNamingStrategy","gitTimeoutMs","maxNameLength","baseName","gitName","tryGitNaming","fileOpName","tryFileOperationNaming","contentName","tryContentAnalysisNaming","fallbackNaming","userContext","formatUserContext","isGitRepo","execGit","gitStatus","generateSingleFileGitName","generateMultiFileGitName","testFiles","isTestFile","dependencyFiles","isDependencyFile","isConfigFile","importCount","countImportChanges","structureCount","countStructureChanges","commonDir","findCommonDirectory","moduleName","extractModuleName","allCodeFiles","isCodeFile","hasAdditions","hasModifications","hasDeletions","sanitizedName","sanitizeFilename","truncatedName","truncatePath","statusSummary","dirName","getRelativeDirectory","dirPaths","segmentArrays","firstSegments","commonSegments","segment","allMatch","firstFile","part","knownCodeFiles","known","isKnownCodeExtension","codeExtensions","importRegex","fs","structureRegex","maxLength","ellipsis","filename","presetMap","credentials","testing","cleaned","compress","gzipSync","generateId","timestampPart","randomPart","ConnectionPool","connections","availableConnections","maxConnections","dbOptions","getConnection","connection","createDatabaseInstance","pragma","shift","releaseConnection","_db","cachedDatabaseConstructor","cachedDatabaseError","tryLoadBetterSqlite3","requiredModule","ctor","probe","instantiationError","isBetterSqlite3Available","getBetterSqlite3LoadError","requireDatabaseConstructor","betterSqlite3","detailedMessage","betterSqlite3Error","pathToDatabase","DatabaseCtor","StorageBroker","readConnectionPool","initialized","operationQueue","isProcessingQueue","writerId","substr","initialize","runMigrations","specificError","getDatabase","processQueue","getReadConnection","isAvailable","getLoadError","acquireLock","maxWaitTime","waitTime","releaseLock","parentId","queueOperation","preCompressedFiles","compressed","storageType","insert","transaction","createdBy","preCompressed","queryError","operationName","priority","queuedOp","lockAcquired","fileRows","fileRow","typedFileRow","decompressed","gunzipSync","diff","file_path","sortBy","sortOrder","validatedSortBy","validatedSortOrder","validSortColumns","StorageBrokerAdapter","broker","filesMap","ID_PREFIX","SESSION","SNAPSHOT","AUDIT","CHECKPOINT","randomSuffix","bytes","generateSessionId","generateSnapshotId","contractsGenerateSnapshotId","contractsGenerateId","generateAuditId","generateCheckpointId","randomId","parseIdTimestamp","parseIdPrefix","isValidId","expectedPrefix","isSnapshotId","regex","isWithin","childPath","parentPath","normalizedChild","normalizedParent","getDepth","isUnixPath","areEqual","path1","path2","norm1","norm2","isWindows","RISK_FACTOR_DESCRIPTIONS","deserialization","cryptography","describeRiskFactors","describeRiskFactor","isKnownRiskFactor","getStandardRiskFactors","createDashboardMetricsClient","orpcClient","getDashboardMetrics","dashboard","getMetrics","DefaultRiskAnalyzer","riskScore","aiContext","detected","burstPattern","changeMetrics","affectedFunctions","ProtectionDecisionEngine","riskAnalyzer","evaluate","protectionLevel","inCooldown","shouldSnapshot","shouldProceed","hasTemporaryAllowance","determineShouldSnapshot","determineShouldProceed","buildReason","buildRecommendations","DiffCalculator","calculateFileDiff","currentLines","snapshotLines","removed","preview","computeLineDiff","currentChecksum","calculateChecksum","snapshotChecksum","linesRemoved","lcs","longestCommonSubsequence","previewLines","previewLineCount","maxPreviewLines","arr1","arr2","unshift","require","generateDiffPreview","diffs","filesCreated","filesModified","filesDeleted","totalLinesAdded","totalLinesRemoved","isConsumptionAllowed","allowed","isConsumptionDenied","TokenBucket","capacity","refillRate","tokens","lastRefill","tryConsume","amount","refill","tokensRemaining","resetAt","calculateResetTime","timePassed","tokensToAdd","getConsumptionInfo","consumed","percentageUsed","remaining","tokensNeeded","secondsToReset","createTokenBucket","isRateLimitAllowed","isRateLimitDenied","RateLimiter","plans","buckets","planName","checkLimit","userId","plan","bucketKey","bucket","consumeResult","resetTime","ceil","getBucketState","resetBucket","clearAll","getActiveBucketCount","DistributedTokenManager","redis","keyPrefix","fallbackToInMemory","fallbackLimiter","redisClient","checkLimitViaRedis","checkLimitViaFallback","getRedisKey","getOrCreateBucket","expire","bucketData","cleanup"],"mappings":"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","file":"chunk-HGYKNWZZ.js","sourcesContent":["/**\n * SessionRecovery - Journal-based crash recovery for session rollbacks\n *\n * Design Principles:\n * - Automatic recovery on startup: Check for pending journals and recover\n * - Per-file backup tracking: Restore from individual .bak-{sessionId} files\n * - Safe cleanup: Only delete backups after successful recovery\n * - Privacy-safe logging: No file paths or content in telemetry\n *\n * Recovery Scenarios:\n * 1. Pending journal with backups  Rollback incomplete transaction\n * 2. Pending journal without backups  Transaction never started, safe to delete\n * 3. Committed journal  Cleanup only (already successful)\n */\n\nimport { existsSync } from \"node:fs\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\n\n/**\n * Journal entry structure (matches SessionRollback)\n */\ninterface JournalEntry {\n\tsessionId: string;\n\ttimestamp: number;\n\tworkspaceRoot: string;\n\tchanges: any[];\n\tbackups: Array<{ original: string; backup: string }>;\n\tstatus: \"pending\" | \"committed\" | \"rolled-back\";\n}\n\n/**\n * Recovery result for a single journal\n */\nexport interface RecoveryResult {\n\tsessionId: string;\n\tstatus: \"recovered\" | \"cleaned\" | \"failed\";\n\tfilesRestored: number;\n\terror?: string;\n}\n\n/**\n * SessionRecovery - Handles crash recovery for session rollbacks\n */\nexport class SessionRecovery {\n\tconstructor(\n\t\tprivate readonly workspaceRoot: string,\n\t\tprivate readonly journalDir: string = path.join(workspaceRoot, \".sb_journal\"),\n\t) {}\n\n\t/**\n\t * Recover all pending transactions\n\t *\n\t * Call this on startup to ensure workspace consistency after crashes\n\t */\n\tasync recoverAll(): Promise<RecoveryResult[]> {\n\t\tconst results: RecoveryResult[] = [];\n\n\t\ttry {\n\t\t\tconst pendingDir = path.join(this.journalDir, \"pending\");\n\n\t\t\t// Check if journal directory exists\n\t\t\tif (!existsSync(pendingDir)) {\n\t\t\t\treturn results;\n\t\t\t}\n\n\t\t\t// Read all pending journal files\n\t\t\tconst files = await fs.readdir(pendingDir);\n\n\t\t\tfor (const file of files) {\n\t\t\t\tif (!file.endsWith(\".json\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst filePath = path.join(pendingDir, file);\n\n\t\t\t\ttry {\n\t\t\t\t\tconst content = await fs.readFile(filePath, \"utf-8\");\n\t\t\t\t\tconst journal = JSON.parse(content) as JournalEntry;\n\n\t\t\t\t\tconst result = await this.recoverJournal(journal, filePath);\n\t\t\t\t\tresults.push(result);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tresults.push({\n\t\t\t\t\t\tsessionId: path.basename(file, \".json\"),\n\t\t\t\t\t\tstatus: \"failed\",\n\t\t\t\t\t\tfilesRestored: 0,\n\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Cleanup old committed journals (older than 7 days)\n\t\t\tawait this.cleanupOldJournals();\n\n\t\t\treturn results;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[SessionRecovery] Failed to recover transactions:\", error);\n\t\t\treturn results;\n\t\t}\n\t}\n\n\t/**\n\t * Recover a single journal entry\n\t */\n\tprivate async recoverJournal(journal: JournalEntry, journalPath: string): Promise<RecoveryResult> {\n\t\tconst result: RecoveryResult = {\n\t\t\tsessionId: journal.sessionId,\n\t\t\tstatus: \"cleaned\",\n\t\t\tfilesRestored: 0,\n\t\t};\n\n\t\ttry {\n\t\t\t// Check if any backups exist\n\t\t\tconst backupExists = await this.checkBackupsExist(journal.backups);\n\n\t\t\tif (!backupExists) {\n\t\t\t\t// No backups = transaction never started or already completed\n\t\t\t\t// Safe to delete journal\n\t\t\t\tawait fs.unlink(journalPath);\n\t\t\t\tresult.status = \"cleaned\";\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\t// Rollback incomplete transaction by restoring from backups\n\t\t\tconst restoredCount = await this.rollbackFromBackups(journal.backups);\n\n\t\t\tresult.filesRestored = restoredCount;\n\t\t\tresult.status = \"recovered\";\n\n\t\t\t// Delete journal after successful recovery\n\t\t\tawait fs.unlink(journalPath);\n\n\t\t\t// Emit telemetry (privacy-safe: no file paths)\n\t\t\tthis.emitRecoveryTelemetry(journal.sessionId, restoredCount);\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tresult.status = \"failed\";\n\t\t\tresult.error = error instanceof Error ? error.message : String(error);\n\n\t\t\t// Keep journal for manual recovery\n\t\t\tconsole.error(`[SessionRecovery] Failed to recover ${journal.sessionId}:`, error);\n\n\t\t\treturn result;\n\t\t}\n\t}\n\n\t/**\n\t * Check if any backup files exist\n\t */\n\tprivate async checkBackupsExist(backups: Array<{ original: string; backup: string }>): Promise<boolean> {\n\t\tfor (const backup of backups) {\n\t\t\tif (existsSync(backup.backup)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Rollback from per-file backups\n\t */\n\tprivate async rollbackFromBackups(backups: Array<{ original: string; backup: string }>): Promise<number> {\n\t\tlet restoredCount = 0;\n\n\t\tfor (const { original, backup } of backups) {\n\t\t\ttry {\n\t\t\t\t// Only restore if backup exists\n\t\t\t\tif (!existsSync(backup)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Restore from backup\n\t\t\t\tawait this.safeRename(backup, original);\n\t\t\t\trestoredCount++;\n\n\t\t\t\t// Delete backup file\n\t\t\t\tif (existsSync(backup)) {\n\t\t\t\t\tawait fs.unlink(backup);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(`[SessionRecovery] Failed to restore ${original}:`, error);\n\t\t\t\t// Continue with other files\n\t\t\t}\n\t\t}\n\n\t\treturn restoredCount;\n\t}\n\n\t/**\n\t * Safe file rename with EXDEV fallback (cross-device support for Windows)\n\t */\n\tprivate async safeRename(src: string, dst: string): Promise<void> {\n\t\ttry {\n\t\t\tawait fs.rename(src, dst);\n\t\t} catch (error: any) {\n\t\t\t// EXDEV: Cross-device link error (Windows different drives)\n\t\t\tif (error.code === \"EXDEV\") {\n\t\t\t\tawait fs.copyFile(src, dst);\n\t\t\t\tawait fs.unlink(src);\n\t\t\t} else {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Cleanup old committed journals (older than 7 days)\n\t */\n\tprivate async cleanupOldJournals(): Promise<void> {\n\t\ttry {\n\t\t\tconst committedDir = path.join(this.journalDir, \"committed\");\n\n\t\t\tif (!existsSync(committedDir)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst files = await fs.readdir(committedDir);\n\t\t\tconst now = Date.now();\n\t\t\tconst sevenDaysMs = 7 * 24 * 60 * 60 * 1000;\n\n\t\t\tfor (const file of files) {\n\t\t\t\tif (!file.endsWith(\".json\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst filePath = path.join(committedDir, file);\n\n\t\t\t\ttry {\n\t\t\t\t\tconst content = await fs.readFile(filePath, \"utf-8\");\n\t\t\t\t\tconst journal = JSON.parse(content) as JournalEntry;\n\n\t\t\t\t\t// Delete if older than 7 days\n\t\t\t\t\tif (now - journal.timestamp > sevenDaysMs) {\n\t\t\t\t\t\tawait fs.unlink(filePath);\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore errors for individual files\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore cleanup errors\n\t\t}\n\t}\n\n\t/**\n\t * Emit recovery telemetry (privacy-safe: no file paths)\n\t */\n\tprivate emitRecoveryTelemetry(_sessionId: string, _filesRestored: number): void {\n\t\t// TODO: Emit to analytics client\n\t\t// {\n\t\t//   event: 'SESSION_RECOVERY',\n\t\t//   sessionId: '[redacted]',\n\t\t//   filesRestored,\n\t\t//   timestamp: Date.now(),\n\t\t// }\n\t}\n\n\t/**\n\t * Manual recovery: Get list of pending journals\n\t */\n\tasync listPendingJournals(): Promise<JournalEntry[]> {\n\t\tconst pendingDir = path.join(this.journalDir, \"pending\");\n\n\t\ttry {\n\t\t\tif (!existsSync(pendingDir)) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst files = await fs.readdir(pendingDir);\n\t\t\tconst journals: JournalEntry[] = [];\n\n\t\t\tfor (const file of files) {\n\t\t\t\tif (!file.endsWith(\".json\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst filePath = path.join(pendingDir, file);\n\t\t\t\tconst content = await fs.readFile(filePath, \"utf-8\");\n\t\t\t\tconst journal = JSON.parse(content) as JournalEntry;\n\t\t\t\tjournals.push(journal);\n\t\t\t}\n\n\t\t\treturn journals;\n\t\t} catch {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Manual recovery: Force recover a specific journal\n\t */\n\tasync recoverJournalById(sessionId: string): Promise<RecoveryResult> {\n\t\tconst journalPath = path.join(this.journalDir, \"pending\", `${sessionId}.json`);\n\n\t\tif (!existsSync(journalPath)) {\n\t\t\treturn {\n\t\t\t\tsessionId,\n\t\t\t\tstatus: \"failed\",\n\t\t\t\tfilesRestored: 0,\n\t\t\t\terror: \"Journal not found\",\n\t\t\t};\n\t\t}\n\n\t\tconst content = await fs.readFile(journalPath, \"utf-8\");\n\t\tconst journal = JSON.parse(content) as JournalEntry;\n\n\t\treturn this.recoverJournal(journal, journalPath);\n\t}\n\n\t/**\n\t * Manual recovery: Delete a specific journal without recovery\n\t */\n\tasync deleteJournal(sessionId: string): Promise<void> {\n\t\tconst pendingPath = path.join(this.journalDir, \"pending\", `${sessionId}.json`);\n\t\tconst committedPath = path.join(this.journalDir, \"committed\", `${sessionId}.json`);\n\n\t\tif (existsSync(pendingPath)) {\n\t\t\tawait fs.unlink(pendingPath);\n\t\t}\n\n\t\tif (existsSync(committedPath)) {\n\t\t\tawait fs.unlink(committedPath);\n\t\t}\n\t}\n\n\t/**\n\t * Cleanup all orphaned backup files (.bak-* files)\n\t */\n\tasync cleanupOrphanedBackups(): Promise<number> {\n\t\tlet cleanedCount = 0;\n\n\t\ttry {\n\t\t\t// Walk workspace directory tree\n\t\t\tconst orphanedBackups = await this.findOrphanedBackups(this.workspaceRoot);\n\n\t\t\tfor (const backupPath of orphanedBackups) {\n\t\t\t\ttry {\n\t\t\t\t\tawait fs.unlink(backupPath);\n\t\t\t\t\tcleanedCount++;\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore errors for individual files\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn cleanedCount;\n\t\t} catch {\n\t\t\treturn cleanedCount;\n\t\t}\n\t}\n\n\t/**\n\t * Find orphaned backup files (*.bak-* pattern)\n\t */\n\tprivate async findOrphanedBackups(dir: string): Promise<string[]> {\n\t\tconst backups: string[] = [];\n\n\t\ttry {\n\t\t\tconst entries = await fs.readdir(dir, { withFileTypes: true });\n\n\t\t\tfor (const entry of entries) {\n\t\t\t\tconst fullPath = path.join(dir, entry.name);\n\n\t\t\t\t// Skip .git, node_modules, etc.\n\t\t\t\tif (entry.isDirectory()) {\n\t\t\t\t\tif (\n\t\t\t\t\t\tentry.name === \".git\" ||\n\t\t\t\t\t\tentry.name === \"node_modules\" ||\n\t\t\t\t\t\tentry.name === \".next\" ||\n\t\t\t\t\t\tentry.name === \"dist\" ||\n\t\t\t\t\t\tentry.name === \"build\"\n\t\t\t\t\t) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Recurse into subdirectories\n\t\t\t\t\tconst subBackups = await this.findOrphanedBackups(fullPath);\n\t\t\t\t\tbackups.push(...subBackups);\n\t\t\t\t} else if (entry.name.includes(\".bak-\")) {\n\t\t\t\t\t// Found a backup file\n\t\t\t\t\tbackups.push(fullPath);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors for individual directories\n\t\t}\n\n\t\treturn backups;\n\t}\n}\n","/**\n * SessionRollback - Per-file atomic session rollback with journal-based crash safety\n *\n * Design Principles:\n * - Per-file atomic swap: Individual .bak-{sessionId} files instead of full workspace backup\n * - Journal-based recovery: .sb_journal tracks all file operations for crash safety\n * - Cross-platform: EXDEV fallback for Windows cross-device moves\n * - Privacy-safe: No file paths or content transmitted in analytics\n *\n * Performance:\n * - Staging validation: <500ms for typical sessions (<100 files)\n * - Per-file swap: Atomic rename operations (milliseconds per file)\n * - Rollback recovery: Journal replay on crash (automatic on next startup)\n */\n\nimport { createHash } from \"node:crypto\";\nimport { existsSync } from \"node:fs\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport type { SessionChange, SessionManifestV1 } from \"@snapback-oss/contracts/session\";\nimport type { BlobStore } from \"../storage/BlobStore\";\n\n/**\n * Rollback options\n */\nexport interface RollbackOptions {\n\t/** Progress callback (0-100) */\n\tonProgress?: (percent: number) => void;\n\n\t/** Dry run mode: validate without applying changes */\n\tdryRun?: boolean;\n\n\t/** Skip hash verification (faster but less safe) */\n\tskipVerification?: boolean;\n}\n\n/**\n * Rollback result\n */\nexport interface RollbackResult {\n\t/** Whether the rollback succeeded */\n\tsuccess: boolean;\n\n\t/** Files successfully reverted */\n\tfilesReverted: string[];\n\n\t/** Files skipped due to conflicts or missing blobs */\n\tfilesSkipped: string[];\n\n\t/** Errors encountered during rollback */\n\terrors: Array<{ path: string; error: string }>;\n\n\t/** Path to journal file (for manual recovery if needed) */\n\tjournalPath?: string;\n}\n\n/**\n * Journal entry for crash recovery\n */\ninterface JournalEntry {\n\tsessionId: string;\n\ttimestamp: number;\n\tworkspaceRoot: string;\n\tchanges: SessionChange[];\n\tbackups: Array<{ original: string; backup: string }>;\n\tstatus: \"pending\" | \"committed\" | \"rolled-back\";\n}\n\n/**\n * SessionRollback - Implements selective session-scoped file restoration\n */\nexport class SessionRollback {\n\tprivate readonly journalDir: string;\n\n\tconstructor(\n\t\tprivate readonly workspaceRoot: string,\n\t\tprivate readonly blobStore: BlobStore,\n\t\tjournalDir?: string,\n\t) {\n\t\tthis.journalDir = journalDir ?? path.join(workspaceRoot, \".sb_journal\");\n\t}\n\n\t/**\n\t * Rollback a session to its starting state\n\t */\n\tasync rollback(manifest: SessionManifestV1, options?: RollbackOptions): Promise<RollbackResult> {\n\t\tconst startTime = performance.now();\n\n\t\tconst result: RollbackResult = {\n\t\t\tsuccess: false,\n\t\t\tfilesReverted: [],\n\t\t\tfilesSkipped: [],\n\t\t\terrors: [],\n\t\t};\n\n\t\ttry {\n\t\t\t// Create journal directory\n\t\t\tawait fs.mkdir(path.join(this.journalDir, \"pending\"), { recursive: true });\n\t\t\tawait fs.mkdir(path.join(this.journalDir, \"committed\"), { recursive: true });\n\n\t\t\t// Create journal entry\n\t\t\tconst journalPath = path.join(this.journalDir, \"pending\", `${manifest.sessionId}.json`);\n\t\t\tconst journal: JournalEntry = {\n\t\t\t\tsessionId: manifest.sessionId,\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tworkspaceRoot: this.workspaceRoot,\n\t\t\t\tchanges: manifest.filesChanged,\n\t\t\t\tbackups: [],\n\t\t\t\tstatus: \"pending\",\n\t\t\t};\n\n\t\t\t// Write initial journal\n\t\t\tawait fs.writeFile(journalPath, JSON.stringify(journal, null, 2));\n\t\t\tresult.journalPath = journalPath;\n\n\t\t\t// Report progress\n\t\t\toptions?.onProgress?.(10);\n\n\t\t\t// Reverse changes (apply inverse operations in reverse chronological order)\n\t\t\tconst reversedChanges = this.reverseChanges(manifest.filesChanged);\n\n\t\t\t// Create staging directory\n\t\t\tconst stagingDir = path.join(this.workspaceRoot, `.snapback-rollback-${manifest.sessionId}`);\n\t\t\tawait fs.mkdir(stagingDir, { recursive: true });\n\t\t\tconst deletedDir = path.join(stagingDir, \".deleted\");\n\t\t\tawait fs.mkdir(deletedDir, { recursive: true });\n\n\t\t\t// Prepare staged files\n\t\t\tconst stagedFiles: Map<string, { hash: string; content: Uint8Array }> = new Map();\n\t\t\tconst filesToDelete: Set<string> = new Set();\n\n\t\t\tfor (let i = 0; i < reversedChanges.length; i++) {\n\t\t\t\tconst change = reversedChanges[i];\n\t\t\t\toptions?.onProgress?.(10 + (i / reversedChanges.length) * 40);\n\n\t\t\t\ttry {\n\t\t\t\t\tawait this.stageChange(change, stagingDir, stagedFiles, filesToDelete, result);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tresult.filesSkipped.push(change.p);\n\t\t\t\t\tresult.errors.push({\n\t\t\t\t\t\tpath: change.p,\n\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Report progress\n\t\t\toptions?.onProgress?.(50);\n\n\t\t\t// Validate staging directory (verify hashes)\n\t\t\tif (!options?.skipVerification) {\n\t\t\t\tconst validationErrors = await this.validateStaging(stagedFiles);\n\t\t\t\tif (validationErrors.length > 0) {\n\t\t\t\t\t// Validation failed - abort rollback\n\t\t\t\t\tfor (const error of validationErrors) {\n\t\t\t\t\t\tresult.errors.push(error);\n\t\t\t\t\t\tresult.filesSkipped.push(error.path);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Clean up staging directory\n\t\t\t\t\tawait this.cleanupStaging(stagingDir);\n\n\t\t\t\t\t// Update journal status\n\t\t\t\t\tjournal.status = \"rolled-back\";\n\t\t\t\t\tawait fs.writeFile(journalPath, JSON.stringify(journal, null, 2));\n\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Report progress\n\t\t\toptions?.onProgress?.(60);\n\n\t\t\t// If dry run, stop here\n\t\t\tif (options?.dryRun) {\n\t\t\t\tresult.success = true;\n\t\t\t\tresult.filesReverted = Array.from(stagedFiles.keys());\n\t\t\t\tawait this.cleanupStaging(stagingDir);\n\t\t\t\tawait fs.unlink(journalPath);\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\t// Per-file atomic swap\n\t\t\tconst swapResult = await this.atomicSwap(stagedFiles, filesToDelete, journal, manifest.sessionId, options);\n\n\t\t\tresult.filesReverted = swapResult.reverted;\n\t\t\tresult.filesSkipped.push(...swapResult.skipped);\n\t\t\tresult.errors.push(...swapResult.errors);\n\t\t\tresult.success = swapResult.success;\n\n\t\t\t// Report progress\n\t\t\toptions?.onProgress?.(90);\n\n\t\t\t// Update journal status\n\t\t\tif (swapResult.success) {\n\t\t\t\tjournal.status = \"committed\";\n\t\t\t\tawait fs.writeFile(\n\t\t\t\t\tpath.join(this.journalDir, \"committed\", `${manifest.sessionId}.json`),\n\t\t\t\t\tJSON.stringify(journal, null, 2),\n\t\t\t\t);\n\t\t\t\tawait fs.unlink(journalPath);\n\n\t\t\t\t// Clean up backup files\n\t\t\t\tfor (const backup of journal.backups) {\n\t\t\t\t\tif (existsSync(backup.backup)) {\n\t\t\t\t\t\tawait fs.unlink(backup.backup);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Rollback failed - keep journal for recovery\n\t\t\t\tjournal.status = \"pending\";\n\t\t\t\tawait fs.writeFile(journalPath, JSON.stringify(journal, null, 2));\n\t\t\t}\n\n\t\t\t// Clean up staging directory\n\t\t\tawait this.cleanupStaging(stagingDir);\n\n\t\t\t// Report progress\n\t\t\toptions?.onProgress?.(100);\n\n\t\t\tconst duration = performance.now() - startTime;\n\t\t\tconsole.log(\n\t\t\t\t`[SessionRollback] rollback() took ${duration.toFixed(0)}ms (sessionId=${manifest.sessionId}, reverted=${result.filesReverted.length}, skipped=${result.filesSkipped.length})`,\n\t\t\t);\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tresult.errors.push({\n\t\t\t\tpath: \"<session>\",\n\t\t\t\terror: `Rollback failed: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t});\n\t\t\treturn result;\n\t\t}\n\t}\n\n\t/**\n\t * Reverse changes to get inverse operations\n\t */\n\tprivate reverseChanges(changes: SessionChange[]): SessionChange[] {\n\t\tconst reversed = [...changes].reverse();\n\t\treturn reversed.map((change) => {\n\t\t\t// Inverse operations:\n\t\t\t// - created  deleted\n\t\t\t// - modified  modified (with hOld/hNew swapped)\n\t\t\t// - deleted  created\n\t\t\t// - renamed  renamed (with p/from swapped)\n\n\t\t\tconst inversed: SessionChange = { ...change };\n\n\t\t\tswitch (change.op) {\n\t\t\t\tcase \"created\":\n\t\t\t\t\tinversed.op = \"deleted\";\n\t\t\t\t\tinversed.hOld = change.hNew;\n\t\t\t\t\tinversed.hNew = undefined;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"modified\":\n\t\t\t\t\t// Swap hashes and sizes\n\t\t\t\t\tinversed.hOld = change.hNew;\n\t\t\t\t\tinversed.hNew = change.hOld;\n\t\t\t\t\tinversed.sizeBefore = change.sizeAfter;\n\t\t\t\t\tinversed.sizeAfter = change.sizeBefore;\n\t\t\t\t\tinversed.mtimeBefore = change.mtimeAfter;\n\t\t\t\t\tinversed.mtimeAfter = change.mtimeBefore;\n\t\t\t\t\tinversed.modeBefore = change.modeAfter;\n\t\t\t\t\tinversed.modeAfter = change.modeBefore;\n\t\t\t\t\tinversed.eolBefore = change.eolAfter;\n\t\t\t\t\tinversed.eolAfter = change.eolBefore;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"deleted\":\n\t\t\t\t\tinversed.op = \"created\";\n\t\t\t\t\tinversed.hNew = change.hOld;\n\t\t\t\t\tinversed.hOld = undefined;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"renamed\": {\n\t\t\t\t\t// Swap path and fromPath\n\t\t\t\t\tconst temp = inversed.p;\n\t\t\t\t\tinversed.p = change.from || change.p;\n\t\t\t\t\tinversed.from = temp;\n\t\t\t\t\t// Also swap hashes\n\t\t\t\t\tinversed.hOld = change.hNew;\n\t\t\t\t\tinversed.hNew = change.hOld;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn inversed;\n\t\t});\n\t}\n\n\t/**\n\t * Stage a change for rollback\n\t */\n\tprivate async stageChange(\n\t\tchange: SessionChange,\n\t\tstagingDir: string,\n\t\tstagedFiles: Map<string, { hash: string; content: Uint8Array }>,\n\t\tfilesToDelete: Set<string>,\n\t\t_result: RollbackResult,\n\t): Promise<void> {\n\t\tconst _absPath = path.join(this.workspaceRoot, change.p);\n\t\tconst stagingPath = path.join(stagingDir, change.p);\n\n\t\tif (change.op === \"deleted\") {\n\t\t\t// Mark file for deletion\n\t\t\tfilesToDelete.add(change.p);\n\t\t\treturn;\n\t\t}\n\n\t\t// For created/modified/renamed: retrieve blob from BlobStore\n\t\tconst hash = change.hNew;\n\t\tif (!hash) {\n\t\t\tthrow new Error(`Missing hash for ${change.op} operation on ${change.p}`);\n\t\t}\n\n\t\t// Retrieve blob\n\t\tconst blobResult = await this.blobStore.get(hash);\n\t\tif (!blobResult.ok) {\n\t\t\tthrow new Error(`Failed to retrieve blob ${hash}: ${blobResult.error.message}`);\n\t\t}\n\n\t\tconst content = blobResult.value;\n\t\tif (!content) {\n\t\t\tthrow new Error(`Blob not found: ${hash}`);\n\t\t}\n\n\t\t// Create staging directory for file\n\t\tawait fs.mkdir(path.dirname(stagingPath), { recursive: true });\n\n\t\t// Write to staging\n\t\tawait fs.writeFile(stagingPath, content);\n\n\t\t// Restore metadata\n\t\tif (change.mtimeAfter) {\n\t\t\tconst mtimeDate = new Date(change.mtimeAfter);\n\t\t\tawait fs.utimes(stagingPath, mtimeDate, mtimeDate);\n\t\t}\n\n\t\tif (change.modeAfter && process.platform !== \"win32\") {\n\t\t\tawait fs.chmod(stagingPath, change.modeAfter);\n\t\t}\n\n\t\t// Add to staged files map\n\t\tstagedFiles.set(change.p, { hash, content });\n\t}\n\n\t/**\n\t * Validate staging directory (verify hashes)\n\t */\n\tprivate async validateStaging(\n\t\tstagedFiles: Map<string, { hash: string; content: Uint8Array }>,\n\t): Promise<Array<{ path: string; error: string }>> {\n\t\tconst errors: Array<{ path: string; error: string }> = [];\n\n\t\tfor (const [filePath, { hash, content }] of stagedFiles.entries()) {\n\t\t\tconst computedHash = createHash(\"sha256\").update(content).digest(\"hex\");\n\t\t\tif (computedHash !== hash) {\n\t\t\t\terrors.push({\n\t\t\t\t\tpath: filePath,\n\t\t\t\t\terror: `Hash mismatch: expected ${hash}, got ${computedHash}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn errors;\n\t}\n\n\t/**\n\t * Perform per-file atomic swap\n\t */\n\tprivate async atomicSwap(\n\t\tstagedFiles: Map<string, { hash: string; content: Uint8Array }>,\n\t\tfilesToDelete: Set<string>,\n\t\tjournal: JournalEntry,\n\t\tsessionId: string,\n\t\toptions?: RollbackOptions,\n\t): Promise<{\n\t\tsuccess: boolean;\n\t\treverted: string[];\n\t\tskipped: string[];\n\t\terrors: Array<{ path: string; error: string }>;\n\t}> {\n\t\tconst reverted: string[] = [];\n\t\tconst skipped: string[] = [];\n\t\tconst errors: Array<{ path: string; error: string }> = [];\n\n\t\ttry {\n\t\t\t// Swap staged files\n\t\t\tlet processed = 0;\n\t\t\tconst total = stagedFiles.size + filesToDelete.size;\n\n\t\t\tfor (const [relPath] of stagedFiles.entries()) {\n\t\t\t\tprocessed++;\n\t\t\t\toptions?.onProgress?.(60 + (processed / total) * 30);\n\n\t\t\t\tconst absPath = path.join(this.workspaceRoot, relPath);\n\t\t\t\tconst stagingPath = path.join(this.workspaceRoot, `.snapback-rollback-${sessionId}`, relPath);\n\t\t\t\tconst backupPath = `${absPath}.bak-${sessionId}`;\n\n\t\t\t\ttry {\n\t\t\t\t\t// Backup current file (if exists)\n\t\t\t\t\tif (existsSync(absPath)) {\n\t\t\t\t\t\tawait this.safeRename(absPath, backupPath);\n\t\t\t\t\t\tjournal.backups.push({ original: absPath, backup: backupPath });\n\t\t\t\t\t}\n\n\t\t\t\t\t// Move staged file into place\n\t\t\t\t\tawait this.safeRename(stagingPath, absPath);\n\n\t\t\t\t\treverted.push(relPath);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tskipped.push(relPath);\n\t\t\t\t\terrors.push({\n\t\t\t\t\t\tpath: relPath,\n\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t});\n\n\t\t\t\t\t// Restore from backup if swap failed\n\t\t\t\t\tif (existsSync(backupPath)) {\n\t\t\t\t\t\tawait this.safeRename(backupPath, absPath);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Delete marked files\n\t\t\tfor (const relPath of filesToDelete) {\n\t\t\t\tprocessed++;\n\t\t\t\toptions?.onProgress?.(60 + (processed / total) * 30);\n\n\t\t\t\tconst absPath = path.join(this.workspaceRoot, relPath);\n\t\t\t\tconst backupPath = `${absPath}.bak-${sessionId}`;\n\n\t\t\t\ttry {\n\t\t\t\t\t// Backup current file (rename to backup is the deletion)\n\t\t\t\t\tif (existsSync(absPath)) {\n\t\t\t\t\t\tawait this.safeRename(absPath, backupPath);\n\t\t\t\t\t\tjournal.backups.push({ original: absPath, backup: backupPath });\n\t\t\t\t\t\t// Note: File is now deleted (moved to backup), no unlink needed\n\t\t\t\t\t\treverted.push(relPath);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tskipped.push(relPath);\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tskipped.push(relPath);\n\t\t\t\t\terrors.push({\n\t\t\t\t\t\tpath: relPath,\n\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t});\n\n\t\t\t\t\t// Restore from backup if deletion failed\n\t\t\t\t\tif (existsSync(backupPath)) {\n\t\t\t\t\t\tawait this.safeRename(backupPath, absPath);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: errors.length === 0,\n\t\t\t\treverted,\n\t\t\t\tskipped,\n\t\t\t\terrors,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\t// Fatal error - rollback all changes from backups\n\t\t\tfor (const backup of journal.backups) {\n\t\t\t\tif (existsSync(backup.backup)) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.safeRename(backup.backup, backup.original);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Ignore errors during recovery\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\treverted,\n\t\t\t\tskipped,\n\t\t\t\terrors: [\n\t\t\t\t\t{\n\t\t\t\t\t\tpath: \"<session>\",\n\t\t\t\t\t\terror: `Fatal error during swap: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t\t\t},\n\t\t\t\t\t...errors,\n\t\t\t\t],\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Safe file rename with EXDEV fallback (cross-device support for Windows)\n\t */\n\tprivate async safeRename(src: string, dst: string): Promise<void> {\n\t\ttry {\n\t\t\tawait fs.rename(src, dst);\n\t\t} catch (error: any) {\n\t\t\t// EXDEV: Cross-device link error (Windows different drives)\n\t\t\tif (error.code === \"EXDEV\") {\n\t\t\t\tawait fs.copyFile(src, dst);\n\t\t\t\tawait fs.unlink(src);\n\t\t\t} else {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Clean up staging directory\n\t */\n\tprivate async cleanupStaging(stagingDir: string): Promise<void> {\n\t\ttry {\n\t\t\tif (existsSync(stagingDir)) {\n\t\t\t\tawait fs.rm(stagingDir, { recursive: true, force: true });\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore cleanup errors\n\t\t}\n\t}\n\n\t/**\n\t * Get pending journal entries (for recovery)\n\t */\n\tasync getPendingJournals(): Promise<JournalEntry[]> {\n\t\tconst pendingDir = path.join(this.journalDir, \"pending\");\n\n\t\ttry {\n\t\t\tif (!existsSync(pendingDir)) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst files = await fs.readdir(pendingDir);\n\t\t\tconst journals: JournalEntry[] = [];\n\n\t\t\tfor (const file of files) {\n\t\t\t\tif (!file.endsWith(\".json\")) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst filePath = path.join(pendingDir, file);\n\t\t\t\tconst content = await fs.readFile(filePath, \"utf-8\");\n\t\t\t\tconst journal = JSON.parse(content) as JournalEntry;\n\t\t\t\tjournals.push(journal);\n\t\t\t}\n\n\t\t\treturn journals;\n\t\t} catch {\n\t\t\treturn [];\n\t\t}\n\t}\n}\n","/**\n * FileChangeAnalyzer - Platform-agnostic file change analysis\n *\n * This module provides utilities for analyzing differences between snapshot\n * and current workspace state, enabling rich diff previews and change summaries.\n *\n * @module FileChangeAnalyzer\n */\n\n/**\n * Interface for file system providers\n *\n * Different platforms implement this interface to provide their\n * specific method of file system operations.\n */\nexport interface IFileSystemProvider {\n\t/**\n\t * Read a file's contents\n\t *\n\t * @param filePath - Absolute path to the file\n\t * @returns Promise that resolves to file contents as string\n\t */\n\treadFile(filePath: string): Promise<string>;\n\n\t/**\n\t * Check if a file exists\n\t *\n\t * @param filePath - Absolute path to the file\n\t * @returns Promise that resolves to true if file exists\n\t */\n\tfileExists(filePath: string): Promise<boolean>;\n\n\t/**\n\t * Get relative path from workspace root\n\t *\n\t * @param workspaceRoot - Workspace root directory\n\t * @param absolutePath - Absolute file path\n\t * @returns Relative path from workspace root\n\t */\n\tgetRelativePath(workspaceRoot: string, absolutePath: string): string;\n}\n\n/**\n * Type of change detected for a file\n */\nexport type FileChangeType = \"modified\" | \"added\" | \"deleted\" | \"unchanged\";\n\n/**\n * Represents a file change between snapshot and current state\n */\nexport interface FileChange {\n\t/** Absolute file path */\n\tfilePath: string;\n\n\t/** Relative file path for display */\n\trelativePath: string;\n\n\t/** File name only */\n\tfileName: string;\n\n\t/** Type of change */\n\tchangeType: FileChangeType;\n\n\t/** Number of lines added (for modified files) */\n\tlinesAdded: number;\n\n\t/** Number of lines deleted (for modified files) */\n\tlinesDeleted: number;\n\n\t/** Content from snapshot */\n\tsnapshotContent: string;\n\n\t/** Current content (if file exists) */\n\tcurrentContent?: string;\n\n\t/** Icon identifier for VS Code */\n\ticon: string;\n\n\t/** Human-readable change summary */\n\tchangeSummary: string;\n}\n\n/**\n * FileChangeAnalyzer - Analyzes file changes between snapshots and current state\n *\n * Provides platform-agnostic file change analysis using dependency injection\n * for file system operations.\n *\n * @example\n * ```typescript\n * // Node.js example\n * import { readFile } from 'fs/promises';\n * import { existsSync } from 'fs';\n * import { relative, basename } from 'path';\n *\n * const fsProvider = {\n *   readFile: (path) => readFile(path, 'utf-8'),\n *   fileExists: (path) => Promise.resolve(existsSync(path)),\n *   getRelativePath: (root, path) => relative(root, path)\n * };\n *\n * const analyzer = new FileChangeAnalyzer('/workspace', fsProvider);\n * const changes = await analyzer.analyzeSnapshot(snapshotFiles);\n * ```\n */\nexport class FileChangeAnalyzer {\n\tprivate workspaceRoot: string;\n\tprivate fileSystem: IFileSystemProvider;\n\n\t/**\n\t * Creates a new FileChangeAnalyzer\n\t *\n\t * @param workspaceRoot - Root directory of the workspace\n\t * @param fileSystem - File system provider for platform-specific operations\n\t */\n\tconstructor(workspaceRoot: string, fileSystem: IFileSystemProvider) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.fileSystem = fileSystem;\n\t}\n\n\t/**\n\t * Analyzes all files in a snapshot and compares with current state\n\t *\n\t * @param snapshotFiles - Map of relative file paths to snapshot content\n\t * @returns Promise that resolves to array of file changes with detailed analysis\n\t */\n\tasync analyzeSnapshot(snapshotFiles: Record<string, string>): Promise<FileChange[]> {\n\t\tconst changes: FileChange[] = [];\n\n\t\tfor (const [relativePath, snapshotContent] of Object.entries(snapshotFiles)) {\n\t\t\ttry {\n\t\t\t\t// Convert relative path to absolute path for file system operations\n\t\t\t\tconst absolutePath = `${this.workspaceRoot}/${relativePath}`;\n\t\t\t\tconst change = await this.analyzeFile(absolutePath, snapshotContent);\n\t\t\t\tchanges.push(change);\n\t\t\t} catch (_error) {\n\t\t\t\t// Add entry with error indicator\n\t\t\t\tchanges.push({\n\t\t\t\t\tfilePath: `${this.workspaceRoot}/${relativePath}`,\n\t\t\t\t\trelativePath,\n\t\t\t\t\tfileName: this.getFileName(relativePath),\n\t\t\t\t\tchangeType: \"unchanged\",\n\t\t\t\t\tlinesAdded: 0,\n\t\t\t\t\tlinesDeleted: 0,\n\t\t\t\t\tsnapshotContent,\n\t\t\t\t\ticon: \"error\",\n\t\t\t\t\tchangeSummary: \"Error analyzing changes\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Sort by change type priority: modified > deleted > added > unchanged\n\t\tconst typePriority: Record<FileChangeType, number> = {\n\t\t\tmodified: 0,\n\t\t\tdeleted: 1,\n\t\t\tadded: 2,\n\t\t\tunchanged: 3,\n\t\t};\n\n\t\treturn changes.sort((a, b) => {\n\t\t\tconst priorityDiff = typePriority[a.changeType] - typePriority[b.changeType];\n\t\t\tif (priorityDiff !== 0) {\n\t\t\t\treturn priorityDiff;\n\t\t\t}\n\n\t\t\t// Within same type, sort by file name\n\t\t\treturn a.fileName.localeCompare(b.fileName);\n\t\t});\n\t}\n\n\t/**\n\t * Analyzes a single file's changes\n\t *\n\t * @param absoluteFilePath - Absolute file path\n\t * @param snapshotContent - Content from snapshot\n\t * @returns Promise that resolves to detailed file change information\n\t */\n\tasync analyzeFile(absoluteFilePath: string, snapshotContent: string): Promise<FileChange> {\n\t\tconst relativePath = this.fileSystem.getRelativePath(this.workspaceRoot, absoluteFilePath);\n\t\tconst fileName = this.getFileName(relativePath);\n\n\t\t// Check if file exists in current workspace\n\t\t// Let errors propagate to caller for proper error handling\n\t\tconst fileExists = await this.fileSystem.fileExists(absoluteFilePath);\n\t\tlet currentContent: string | undefined;\n\n\t\tif (fileExists) {\n\t\t\tcurrentContent = await this.fileSystem.readFile(absoluteFilePath);\n\t\t}\n\n\t\t// Determine change type\n\t\tlet changeType: FileChangeType;\n\t\tlet icon: string;\n\t\tlet changeSummary: string;\n\t\tlet linesAdded = 0;\n\t\tlet linesDeleted = 0;\n\n\t\tif (!fileExists) {\n\t\t\t// File was deleted since snapshot\n\t\t\tchangeType = \"deleted\";\n\t\t\ticon = \"diff-removed\";\n\t\t\tconst lineCount = snapshotContent.split(\"\\n\").length;\n\t\t\tlinesDeleted = lineCount;\n\t\t\tchangeSummary = `Deleted (${lineCount} lines)`;\n\t\t} else if (currentContent === snapshotContent) {\n\t\t\t// File unchanged\n\t\t\tchangeType = \"unchanged\";\n\t\t\ticon = \"circle-outline\";\n\t\t\tchangeSummary = \"No changes\";\n\t\t} else {\n\t\t\t// File modified - calculate diff stats (currentContent is guaranteed to exist here)\n\t\t\tif (!currentContent) {\n\t\t\t\tthrow new Error(\"Unexpected: currentContent is undefined for existing file\");\n\t\t\t}\n\t\t\tchangeType = \"modified\";\n\t\t\ticon = \"diff-modified\";\n\n\t\t\tconst stats = this.calculateDiffStats(snapshotContent, currentContent);\n\t\t\tlinesAdded = stats.added;\n\t\t\tlinesDeleted = stats.deleted;\n\n\t\t\tif (linesAdded === 0 && linesDeleted === 0) {\n\t\t\t\tchangeSummary = \"Modified (whitespace only)\";\n\t\t\t} else if (linesAdded > 0 && linesDeleted > 0) {\n\t\t\t\tchangeSummary = `+${linesAdded} -${linesDeleted}`;\n\t\t\t} else if (linesAdded > 0) {\n\t\t\t\tchangeSummary = `+${linesAdded}`;\n\t\t\t} else {\n\t\t\t\tchangeSummary = `-${linesDeleted}`;\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tfilePath: absoluteFilePath,\n\t\t\trelativePath,\n\t\t\tfileName,\n\t\t\tchangeType,\n\t\t\tlinesAdded,\n\t\t\tlinesDeleted,\n\t\t\tsnapshotContent,\n\t\t\tcurrentContent,\n\t\t\ticon,\n\t\t\tchangeSummary,\n\t\t};\n\t}\n\n\t/**\n\t * Calculates simple diff statistics between two file contents\n\t *\n\t * Uses line-based comparison to estimate additions and deletions.\n\t * This is a simplified diff algorithm suitable for UI display.\n\t *\n\t * @param oldContent - Original content (snapshot)\n\t * @param newContent - Current content\n\t * @returns Object with added and deleted line counts\n\t */\n\tprivate calculateDiffStats(oldContent: string, newContent: string): { added: number; deleted: number } {\n\t\tconst oldLines = oldContent.split(\"\\n\");\n\t\tconst newLines = newContent.split(\"\\n\");\n\n\t\t// Simple line-based diff using Set for quick lookups\n\t\tconst oldSet = new Set(oldLines);\n\t\tconst newSet = new Set(newLines);\n\n\t\tlet added = 0;\n\t\tlet deleted = 0;\n\n\t\t// Count lines only in new (added)\n\t\tfor (const line of newLines) {\n\t\t\tif (!oldSet.has(line)) {\n\t\t\t\tadded++;\n\t\t\t}\n\t\t}\n\n\t\t// Count lines only in old (deleted)\n\t\tfor (const line of oldLines) {\n\t\t\tif (!newSet.has(line)) {\n\t\t\t\tdeleted++;\n\t\t\t}\n\t\t}\n\n\t\treturn { added, deleted };\n\t}\n\n\t/**\n\t * Extract file name from path\n\t *\n\t * @param filePath - File path\n\t * @returns File name only\n\t */\n\tprivate getFileName(filePath: string): string {\n\t\tconst parts = filePath.split(\"/\");\n\t\treturn parts[parts.length - 1] || filePath;\n\t}\n}\n\n/**\n * Creates a summary of changes for display\n *\n * @param changes - Array of file changes\n * @returns Human-readable change summary\n */\nexport function createChangeSummary(changes: FileChange[]): string {\n\tconst modifiedCount = changes.filter((c) => c.changeType === \"modified\").length;\n\tconst addedCount = changes.filter((c) => c.changeType === \"added\").length;\n\tconst deletedCount = changes.filter((c) => c.changeType === \"deleted\").length;\n\tconst unchangedCount = changes.filter((c) => c.changeType === \"unchanged\").length;\n\n\tconst parts: string[] = [];\n\n\tif (modifiedCount > 0) {\n\t\tparts.push(`${modifiedCount} modified`);\n\t}\n\tif (deletedCount > 0) {\n\t\tparts.push(`${deletedCount} deleted`);\n\t}\n\tif (addedCount > 0) {\n\t\tparts.push(`${addedCount} added`);\n\t}\n\tif (unchangedCount > 0 && parts.length === 0) {\n\t\tparts.push(`${unchangedCount} unchanged`);\n\t}\n\n\treturn parts.join(\", \");\n}\n","/**\n * Centralized Threshold Configuration\n *\n * This module serves as the single source of truth for all timing,\n * detection, classification, and risk thresholds across the SDK.\n *\n * These thresholds represent empirically tuned values from production usage\n * and constitute critical intellectual property. Centralizing thresholds enables:\n * - Single source of truth for all threshold values\n * - A/B testing and empirical tuning\n * - Runtime configuration via feature flags\n * - Consistent behavior across all platforms (VSCode, CLI, MCP, Web)\n *\n * All threshold values are frozen to prevent accidental modification.\n * Components can override these defaults via their configuration options.\n *\n * @module config/Thresholds\n */\n\nimport type { ExperienceMetrics } from \"../types/experience\";\n\n/**\n * Session coordinator thresholds for session lifecycle management\n */\nexport interface SessionThresholds {\n\t/** Time of inactivity before finalizing session (ms) */\n\tidleTimeout: number;\n\n\t/** Minimum duration for a valid session (ms) */\n\tminSessionDuration: number;\n\n\t/** Maximum duration before auto-finalizing session (ms) */\n\tmaxSessionDuration: number;\n}\n\n/**\n * Burst detection thresholds for identifying AI-like editing patterns\n */\nexport interface BurstThresholds {\n\t/** Time window for burst detection (ms) */\n\ttimeWindow: number;\n\n\t/** Minimum characters inserted to qualify as burst */\n\tminCharsInserted: number;\n\n\t/** Maximum time between keystrokes for burst (ms) */\n\tmaxKeystrokeInterval: number;\n\n\t/** Minimum lines affected to qualify as burst */\n\tminLinesAffected: number;\n\n\t/** Minimum insert/delete ratio for burst (e.g., 3:1) */\n\tminInsertDeleteRatio: number;\n}\n\n/**\n * Experience classification thresholds for user tiers\n */\nexport interface ExperienceThresholds {\n\t/** Thresholds for explorer tier (new users) */\n\texplorer: ExperienceMetrics;\n\n\t/** Thresholds for intermediate tier (regular users) */\n\tintermediate: ExperienceMetrics;\n\n\t/** Thresholds for power tier (advanced users) */\n\tpower: ExperienceMetrics;\n}\n\n/**\n * Session tagging thresholds for automatic tag generation\n */\nexport interface TaggingThresholds {\n\t/** Minimum burst confidence to tag as AI-assisted */\n\tminBurstConfidence: number;\n\n\t/** Minimum duration to tag as long-session (ms) */\n\tminLongSessionDuration: number;\n\n\t/** Maximum duration to tag as short-session (ms) */\n\tmaxShortSessionDuration: number;\n\n\t/** Minimum lines added to tag as large-edits */\n\tminLargeEditLines: number;\n\n\t/** Normalization constants for confidence calculations */\n\tnormalization: {\n\t\t/** File count threshold for multi-file tag */\n\t\tmultiFileThreshold: number;\n\n\t\t/** File count for normalizing multi-file confidence */\n\t\tmultiFileNormalization: number;\n\n\t\t/** Duration for normalizing long-session confidence (ms) */\n\t\tlongSessionNormalization: number;\n\n\t\t/** Line count for normalizing large-edits confidence */\n\t\tlargeEditsNormalization: number;\n\t};\n}\n\n/**\n * Risk analysis and scoring thresholds\n */\nexport interface RiskThresholds {\n\t/** Score above which operations are blocked (default: 8.0 on 0-10 scale) */\n\tblockingThreshold: number;\n\n\t/** Score threshold for critical severity (default: 7.0) */\n\tcriticalThreshold: number;\n\n\t/** Score threshold for high severity (default: 5.0) */\n\thighThreshold: number;\n\n\t/** Score threshold for medium severity (default: 3.0) */\n\tmediumThreshold: number;\n}\n\n/**\n * Security pattern risk scores (0-10 scale)\n */\nexport interface SecurityPatternScores {\n\t/** eval() usage score (default: 4.0) */\n\tevalUsage: number;\n\n\t/** Function constructor score (default: 4.0) */\n\tfunctionConstructor: number;\n\n\t/** innerHTML usage score (default: 3.0) */\n\tdangerousHtml: number;\n\n\t/** exec() command score (default: 5.0) */\n\texecCommand: number;\n\n\t/** SQL concatenation score (default: 6.0) */\n\tsqlConcat: number;\n\n\t/** Hardcoded secrets score (default: 4.0) */\n\thardcodedSecrets: number;\n\n\t/** Weak crypto score (default: 3.0) */\n\tweakCrypto: number;\n}\n\n/**\n * Detection thresholds for security analysis\n */\nexport interface DetectionThresholds {\n\t/** Shannon entropy threshold for secret detection (default: 2.5 bits per symbol) */\n\tentropyThreshold: number;\n\n\t/** Levenshtein distance threshold for typosquatting (default: 3) */\n\ttyposquattingDistance: number;\n}\n\n/**\n * Protection level and cooldown thresholds\n */\nexport interface ProtectionThresholds {\n\t/** Cooldown duration for protected files (default: 10min = 600s) */\n\tprotectedCooldown: number;\n\n\t/** Cooldown duration for other protection levels (default: 5min = 300s) */\n\totherCooldown: number;\n\n\t/** Debounce window for protection checks (default: 5s) */\n\tdebounceWindow: number;\n}\n\n/**\n * Resource limits and capacity thresholds\n */\nexport interface ResourceThresholds {\n\t/** Maximum deduplication cache size (default: 500 entries) */\n\tdedupCacheSize: number;\n\n\t/** Maximum files in snapshot (default: 10,000) */\n\tsnapshotMaxFiles: number;\n\n\t/** Maximum file size in snapshot (default: 10MB) */\n\tsnapshotMaxFileSize: number;\n\n\t/** Maximum total snapshot size (default: 500MB) */\n\tsnapshotMaxTotalSize: number;\n\n\t/** Halo size for diff context (default: 3 lines) */\n\tdiffHaloSize: number;\n\n\t/** Trial snapshot limit (default: 50) */\n\ttrialSnapshotLimit: number;\n\n\t/** Free tier monthly snapshot limit (default: 100) */\n\tfreeMonthlyLimit: number;\n}\n\n/**\n * Quality of Service (QoS) thresholds\n */\nexport interface QoSThresholds {\n\t/** Rate limiter token bucket capacity (default: 100) */\n\trateLimitCapacity: number;\n\n\t/** Rate limiter refill period (default: 60s) */\n\trateLimitRefill: number;\n\n\t/** Event bus timeout (default: 5s) */\n\teventBusTimeout: number;\n\n\t/** Event bus max retries (default: 3) */\n\teventBusMaxRetries: number;\n\n\t/** Error budget hard threshold (default: 1% = 0.01) */\n\terrorBudgetHard: number;\n\n\t/** Error budget warning threshold (default: 0.5% = 0.005) */\n\terrorBudgetWarn: number;\n\n\t/** Maximum items in batch (default: 10) */\n\tbatchMax: number;\n\n\t/** Time interval for batch flush in milliseconds (default: 1s) */\n\tbatchIntervalMs: number;\n\n\t/** Base retry delay in milliseconds (default: 100ms) */\n\tretryBaseMs: number;\n\n\t/** Maximum retry delay in milliseconds (default: 5s) */\n\tretryMaxMs: number;\n\n\t/** Maximum queue size before dropping items (default: 1000) */\n\tmaxQueueSize: number;\n\n\t/** HTTP request timeout in milliseconds (default: 30s) */\n\thttpTimeout: number;\n}\n\n/**\n * Documentation for threshold values\n */\nexport interface ThresholdDocumentation {\n\tsession: {\n\t\tidleTimeout: string;\n\t\tminSessionDuration: string;\n\t\tmaxSessionDuration: string;\n\t};\n\tburst: {\n\t\ttimeWindow: string;\n\t\tminCharsInserted: string;\n\t\tmaxKeystrokeInterval: string;\n\t\tminLinesAffected: string;\n\t\tminInsertDeleteRatio: string;\n\t};\n\texperience: {\n\t\tdescription: string;\n\t\texplorer: string;\n\t\tintermediate: string;\n\t\tpower: string;\n\t};\n\ttagging: {\n\t\tdescription: string;\n\t\tminBurstConfidence: string;\n\t\tminLongSessionDuration: string;\n\t\tmaxShortSessionDuration: string;\n\t\tminLargeEditLines: string;\n\t};\n\trisk: {\n\t\tdescription: string;\n\t\tblockingThreshold: string;\n\t\tcriticalThreshold: string;\n\t\thighThreshold: string;\n\t\tmediumThreshold: string;\n\t};\n\tdetection: {\n\t\tentropyThreshold: string;\n\t\ttyposquattingDistance: string;\n\t};\n\tprotection: {\n\t\tprotectedCooldown: string;\n\t\totherCooldown: string;\n\t\tdebounceWindow: string;\n\t};\n\tresources: {\n\t\tdedupCacheSize: string;\n\t\tsnapshotMaxFiles: string;\n\t\tdiffHaloSize: string;\n\t};\n\tqos: {\n\t\trateLimitCapacity: string;\n\t\terrorBudgetHard: string;\n\t\tbatchMax: string;\n\t\tbatchIntervalMs: string;\n\t\tretryBaseMs: string;\n\t\tretryMaxMs: string;\n\t\tmaxQueueSize: string;\n\t\thttpTimeout: string;\n\t};\n}\n\n/**\n * Complete threshold configuration\n */\nexport interface ThresholdsConfig {\n\tsession: SessionThresholds;\n\tburst: BurstThresholds;\n\texperience: ExperienceThresholds;\n\ttagging: TaggingThresholds;\n\trisk: RiskThresholds;\n\tsecurityScores: SecurityPatternScores;\n\tdetection: DetectionThresholds;\n\tprotection: ProtectionThresholds;\n\tresources: ResourceThresholds;\n\tqos: QoSThresholds;\n\tdocs: ThresholdDocumentation;\n}\n\n/**\n * Default threshold configuration (frozen and immutable)\n *\n * This constant contains the default values and is frozen to prevent modification.\n * Use THRESHOLDS for the current (potentially modified) values.\n */\nconst DEFAULT_THRESHOLDS_FROZEN: Readonly<ThresholdsConfig> = Object.freeze({\n\t/**\n\t * Session lifecycle thresholds\n\t */\n\tsession: Object.freeze({\n\t\tidleTimeout: 105000, // 105 seconds (1.75 minutes)\n\t\tminSessionDuration: 5000, // 5 seconds\n\t\tmaxSessionDuration: 3600000, // 1 hour\n\t}),\n\n\t/**\n\t * Burst detection thresholds\n\t */\n\tburst: Object.freeze({\n\t\ttimeWindow: 5000, // 5 seconds\n\t\tminCharsInserted: 100, // 100 characters\n\t\tmaxKeystrokeInterval: 200, // 200 milliseconds\n\t\tminLinesAffected: 3, // 3 lines\n\t\tminInsertDeleteRatio: 3, // 3:1 ratio (favoring insertions)\n\t}),\n\n\t/**\n\t * Experience tier thresholds\n\t */\n\texperience: Object.freeze({\n\t\texplorer: Object.freeze({\n\t\t\tsnapshotsCreated: 5,\n\t\t\tsessionsRecorded: 3,\n\t\t\tprotectedFiles: 2,\n\t\t\tmanualRestores: 1,\n\t\t\taiAssistedSessions: 0,\n\t\t\tdaysSinceFirstUse: 7,\n\t\t\tcommandDiversity: 0.3,\n\t\t}),\n\t\tintermediate: Object.freeze({\n\t\t\tsnapshotsCreated: 20,\n\t\t\tsessionsRecorded: 10,\n\t\t\tprotectedFiles: 5,\n\t\t\tmanualRestores: 5,\n\t\t\taiAssistedSessions: 2,\n\t\t\tdaysSinceFirstUse: 30,\n\t\t\tcommandDiversity: 0.6,\n\t\t}),\n\t\tpower: Object.freeze({\n\t\t\tsnapshotsCreated: 100,\n\t\t\tsessionsRecorded: 50,\n\t\t\tprotectedFiles: 20,\n\t\t\tmanualRestores: 20,\n\t\t\taiAssistedSessions: 10,\n\t\t\tdaysSinceFirstUse: 90,\n\t\t\tcommandDiversity: 0.9,\n\t\t}),\n\t}),\n\n\t/**\n\t * Session tagging thresholds\n\t */\n\ttagging: Object.freeze({\n\t\tminBurstConfidence: 0.7,\n\t\tminLongSessionDuration: 1800000, // 30 minutes\n\t\tmaxShortSessionDuration: 30000, // 30 seconds\n\t\tminLargeEditLines: 1000,\n\t\tnormalization: Object.freeze({\n\t\t\tmultiFileThreshold: 5, // Tag as multi-file if > 5 files\n\t\t\tmultiFileNormalization: 10, // Normalize confidence to 10 files\n\t\t\tlongSessionNormalization: 7200000, // Normalize to 2 hours\n\t\t\tlargeEditsNormalization: 5000, // Normalize to 5000 lines\n\t\t}),\n\t}),\n\n\t/**\n\t * Risk analysis thresholds\n\t */\n\trisk: Object.freeze({\n\t\tblockingThreshold: 8.0, // Block operations above this score (0-10 scale)\n\t\tcriticalThreshold: 7.0, // Critical severity\n\t\thighThreshold: 5.0, // High severity\n\t\tmediumThreshold: 3.0, // Medium severity\n\t}),\n\n\t/**\n\t * Security pattern scores (0-10 scale)\n\t */\n\tsecurityScores: Object.freeze({\n\t\tevalUsage: 4.0,\n\t\tfunctionConstructor: 4.0,\n\t\tdangerousHtml: 3.0,\n\t\texecCommand: 5.0,\n\t\tsqlConcat: 6.0,\n\t\thardcodedSecrets: 4.0,\n\t\tweakCrypto: 3.0,\n\t}),\n\n\t/**\n\t * Detection thresholds\n\t */\n\tdetection: Object.freeze({\n\t\tentropyThreshold: 2.5, // Shannon entropy (bits per symbol) for secret detection\n\t\ttyposquattingDistance: 3, // Levenshtein distance for dependency typosquatting\n\t}),\n\n\t/**\n\t * Protection level thresholds\n\t */\n\tprotection: Object.freeze({\n\t\tprotectedCooldown: 600000, // 10 minutes in ms\n\t\totherCooldown: 300000, // 5 minutes in ms\n\t\tdebounceWindow: 5000, // 5 seconds in ms\n\t}),\n\n\t/**\n\t * Resource limits\n\t */\n\tresources: Object.freeze({\n\t\tdedupCacheSize: 500, // Maximum cache entries\n\t\tsnapshotMaxFiles: 10000, // Maximum files in snapshot\n\t\tsnapshotMaxFileSize: 10 * 1024 * 1024, // 10MB in bytes\n\t\tsnapshotMaxTotalSize: 500 * 1024 * 1024, // 500MB in bytes\n\t\tdiffHaloSize: 3, // Context lines for diffs\n\t\ttrialSnapshotLimit: 50, // Snapshots for trial users\n\t\tfreeMonthlyLimit: 100, // Free tier monthly limit\n\t}),\n\n\t/**\n\t * Quality of Service thresholds\n\t */\n\tqos: Object.freeze({\n\t\trateLimitCapacity: 100, // Token bucket capacity\n\t\trateLimitRefill: 60000, // 60 seconds in ms\n\t\teventBusTimeout: 5000, // 5 seconds in ms\n\t\teventBusMaxRetries: 3, // Maximum retry attempts\n\t\terrorBudgetHard: 0.01, // 1% error rate threshold\n\t\terrorBudgetWarn: 0.005, // 0.5% warning threshold\n\t\tbatchMax: 10, // Maximum items in batch\n\t\tbatchIntervalMs: 1000, // 1 second batch interval\n\t\tretryBaseMs: 100, // 100ms base retry delay\n\t\tretryMaxMs: 5000, // 5 seconds max retry delay\n\t\tmaxQueueSize: 1000, // Maximum queue size\n\t\thttpTimeout: 30000, // 30 seconds HTTP timeout\n\t}),\n\n\t/**\n\t * Documentation for threshold values\n\t */\n\tdocs: Object.freeze({\n\t\tsession: Object.freeze({\n\t\t\tidleTimeout: \"Duration of inactivity before automatically finalizing a session\",\n\t\t\tminSessionDuration: \"Minimum duration required for a session to be considered valid\",\n\t\t\tmaxSessionDuration: \"Maximum duration before automatically finalizing a long-running session\",\n\t\t}),\n\t\tburst: Object.freeze({\n\t\t\ttimeWindow: \"Time window to analyze for burst patterns (rapid insertions)\",\n\t\t\tminCharsInserted: \"Minimum characters inserted within time window to qualify as burst\",\n\t\t\tmaxKeystrokeInterval: \"Maximum time between consecutive keystrokes to qualify as burst\",\n\t\t\tminLinesAffected: \"Minimum number of lines changed to qualify as burst\",\n\t\t\tminInsertDeleteRatio:\n\t\t\t\t\"Minimum ratio of inserted to deleted characters (e.g., 3:1 means 3x more insertions)\",\n\t\t}),\n\t\texperience: Object.freeze({\n\t\t\tdescription:\n\t\t\t\t\"Thresholds for classifying users into experience tiers based on usage patterns. Users must meet ALL thresholds within a tier to qualify.\",\n\t\t\texplorer: \"New users getting started with SnapBack (low activity)\",\n\t\t\tintermediate: \"Regular users with moderate experience (consistent usage)\",\n\t\t\tpower: \"Advanced users who leverage many features (high engagement)\",\n\t\t}),\n\t\ttagging: Object.freeze({\n\t\t\tdescription: \"Thresholds for automatically tagging sessions based on detected patterns and characteristics\",\n\t\t\tminBurstConfidence: \"Minimum confidence level (0-1) required to tag session as having burst patterns\",\n\t\t\tminLongSessionDuration: \"Minimum duration to classify and tag a session as 'long-session'\",\n\t\t\tmaxShortSessionDuration: \"Maximum duration to classify and tag a session as 'short-session'\",\n\t\t\tminLargeEditLines: \"Minimum lines added to classify and tag a session as having 'large-edits'\",\n\t\t}),\n\t\trisk: Object.freeze({\n\t\t\tdescription: \"Risk thresholds for security analysis and blocking operations\",\n\t\t\tblockingThreshold: \"Score above which operations are blocked (0-10 scale)\",\n\t\t\tcriticalThreshold: \"Threshold for critical severity classification\",\n\t\t\thighThreshold: \"Threshold for high severity classification\",\n\t\t\tmediumThreshold: \"Threshold for medium severity classification\",\n\t\t}),\n\t\tdetection: Object.freeze({\n\t\t\tentropyThreshold:\n\t\t\t\t\"Shannon entropy threshold (bits per symbol) for detecting potential secrets and high-entropy strings\",\n\t\t\ttyposquattingDistance:\n\t\t\t\t\"Maximum Levenshtein distance for detecting potential typosquatting in dependency names\",\n\t\t}),\n\t\tprotection: Object.freeze({\n\t\t\tprotectedCooldown: \"Cooldown period after saving protected files before next protection check\",\n\t\t\totherCooldown: \"Cooldown period for warn and watch protection levels\",\n\t\t\tdebounceWindow: \"Debounce window to prevent rapid-fire protection checks\",\n\t\t}),\n\t\tresources: Object.freeze({\n\t\t\tdedupCacheSize: \"Maximum number of entries in the deduplication cache (FIFO eviction)\",\n\t\t\tsnapshotMaxFiles: \"Maximum number of files allowed in a single snapshot operation\",\n\t\t\tdiffHaloSize: \"Number of context lines to include around changed regions in diffs\",\n\t\t}),\n\t\tqos: Object.freeze({\n\t\t\trateLimitCapacity: \"Token bucket capacity for rate limiting API requests\",\n\t\t\terrorBudgetHard: \"Hard error rate threshold triggering alerts and degradation (1% = 0.01)\",\n\t\t\tbatchMax: \"Maximum number of items to batch together before flushing\",\n\t\t\tbatchIntervalMs: \"Time interval to wait before auto-flushing a batch (milliseconds)\",\n\t\t\tretryBaseMs: \"Base delay for exponential backoff retry logic (milliseconds)\",\n\t\t\tretryMaxMs: \"Maximum delay cap for exponential backoff retries (milliseconds)\",\n\t\t\tmaxQueueSize: \"Maximum queue size before dropping new items to prevent memory overflow\",\n\t\t\thttpTimeout: \"HTTP request timeout for QoS API calls (milliseconds)\",\n\t\t}),\n\t}),\n});\n\n/**\n * Exported default thresholds (frozen for immutability)\n *\n * This is a reference to the frozen defaults, exported for inspection and testing.\n * Use THRESHOLDS for the current (potentially modified) values.\n */\nexport const DEFAULT_THRESHOLDS: Readonly<ThresholdsConfig> = DEFAULT_THRESHOLDS_FROZEN;\n\n/**\n * Current threshold configuration (mutable)\n *\n * This object holds the currently active thresholds and can be modified at runtime\n * using updateThresholds() or reset using resetThresholds().\n *\n * @example\n * ```typescript\n * import { THRESHOLDS } from '@snapback/sdk';\n *\n * const coordinator = new SessionCoordinator({\n *   config: {\n *     idleTimeout: THRESHOLDS.session.idleTimeout,\n *     minSessionDuration: THRESHOLDS.session.minSessionDuration,\n *   }\n * });\n * ```\n */\nexport const THRESHOLDS: ThresholdsConfig = structuredClone(DEFAULT_THRESHOLDS_FROZEN);\n\n/**\n * Re-export for convenience\n */\nexport default THRESHOLDS;\n\n/**\n * Create a new thresholds instance with optional overrides\n *\n * @param overrides - Partial threshold overrides\n * @returns New thresholds configuration with overrides applied\n *\n * @example\n * ```typescript\n * const testThresholds = createThresholds({\n *   risk: {\n *     blockingThreshold: 6.0, // More permissive for testing\n *     criticalThreshold: 5.0,\n *     highThreshold: 4.0,\n *     mediumThreshold: 2.0,\n *   },\n * });\n * ```\n */\nexport function createThresholds(overrides?: Partial<ThresholdsConfig>): ThresholdsConfig {\n\treturn {\n\t\tsession: { ...THRESHOLDS.session, ...overrides?.session },\n\t\tburst: { ...THRESHOLDS.burst, ...overrides?.burst },\n\t\texperience: {\n\t\t\texplorer: { ...THRESHOLDS.experience.explorer, ...overrides?.experience?.explorer },\n\t\t\tintermediate: { ...THRESHOLDS.experience.intermediate, ...overrides?.experience?.intermediate },\n\t\t\tpower: { ...THRESHOLDS.experience.power, ...overrides?.experience?.power },\n\t\t},\n\t\ttagging: {\n\t\t\t...THRESHOLDS.tagging,\n\t\t\t...overrides?.tagging,\n\t\t\tnormalization: { ...THRESHOLDS.tagging.normalization, ...overrides?.tagging?.normalization },\n\t\t},\n\t\trisk: { ...THRESHOLDS.risk, ...overrides?.risk },\n\t\tsecurityScores: { ...THRESHOLDS.securityScores, ...overrides?.securityScores },\n\t\tdetection: { ...THRESHOLDS.detection, ...overrides?.detection },\n\t\tprotection: { ...THRESHOLDS.protection, ...overrides?.protection },\n\t\tresources: { ...THRESHOLDS.resources, ...overrides?.resources },\n\t\tqos: { ...THRESHOLDS.qos, ...overrides?.qos },\n\t\tdocs: THRESHOLDS.docs, // Documentation is immutable\n\t};\n}\n\n/**\n * Update global thresholds at runtime\n *\n * Useful for feature flags, A/B testing, or environment-specific tuning.\n * Note: This mutates the global THRESHOLDS object.\n *\n * @param overrides - Partial threshold overrides to apply globally\n *\n * @example\n * ```typescript\n * // More aggressive burst detection for beta users\n * updateThresholds({\n *   burst: {\n *     timeWindow: 3000, // 3s instead of 5s\n *     minCharsInserted: 50,\n *     maxKeystrokeInterval: 150,\n *     minLinesAffected: 2,\n *     minInsertDeleteRatio: 2,\n *   },\n * });\n * ```\n */\nexport function updateThresholds(overrides: Partial<ThresholdsConfig>): void {\n\tconst updated = createThresholds(overrides);\n\t// Note: THRESHOLDS is exported as a mutable let binding\n\tObject.assign(THRESHOLDS, updated);\n}\n\n/**\n * Reset global thresholds to defaults\n *\n * Useful for testing or restoring default configuration.\n */\nexport function resetThresholds(): void {\n\tObject.assign(THRESHOLDS, DEFAULT_THRESHOLDS);\n}\n","/**\n * RiskAnalyzer - Platform-agnostic risk analysis for code security\n *\n * This module provides platform-agnostic risk analysis functionality,\n * detecting security issues in code through pattern matching and scoring.\n *\n * Key Features:\n * - Pattern-based security detection\n * - Risk scoring (0-10 scale)\n * - Severity classification (low/medium/high/critical)\n * - Configurable thresholds\n *\n * Thresholds are centralized in config/Thresholds.ts for consistency across\n * all platforms (VSCode, CLI, MCP, Web).\n *\n * @module RiskAnalyzer\n */\n\nimport { THRESHOLDS } from \"../config/Thresholds\";\n\n/**\n * Severity levels for risk analysis\n */\nexport type RiskSeverity = \"low\" | \"medium\" | \"high\" | \"critical\";\n\n/**\n * Risk factor detected in analysis\n */\nexport interface RiskFactor {\n\t/** Type of risk detected */\n\ttype: string;\n\t/** Human-readable message */\n\tmessage: string;\n\t/** Line number where issue was found (optional) */\n\tline?: number;\n\t/** Column number where issue was found (optional) */\n\tcolumn?: number;\n}\n\n/**\n * Result of risk analysis\n */\nexport interface AnalysisResult {\n\t/** Risk score (0-10 scale, where 10 is most risky) */\n\tscore: number;\n\t/** Severity classification */\n\tseverity: RiskSeverity;\n\t/** Risk factors detected */\n\tfactors: RiskFactor[];\n\t/** Recommendations for remediation */\n\trecommendations: string[];\n}\n\n/**\n * Configuration for risk analysis thresholds\n */\nexport interface RiskThresholds {\n\t/** Score threshold for blocking (default: 8.0) */\n\tblockingThreshold: number;\n\t/** Score threshold for critical severity (default: 7.0) */\n\tcriticalThreshold: number;\n\t/** Score threshold for high severity (default: 5.0) */\n\thighThreshold: number;\n\t/** Score threshold for medium severity (default: 3.0) */\n\tmediumThreshold: number;\n}\n\n/**\n * Default risk thresholds based on SnapBack's security model\n *\n * These values are sourced from the centralized THRESHOLDS configuration\n * to ensure consistency across all platforms.\n */\nexport const DEFAULT_RISK_THRESHOLDS: RiskThresholds = {\n\tblockingThreshold: THRESHOLDS.risk.blockingThreshold,\n\tcriticalThreshold: THRESHOLDS.risk.criticalThreshold,\n\thighThreshold: THRESHOLDS.risk.highThreshold,\n\tmediumThreshold: THRESHOLDS.risk.mediumThreshold,\n};\n\n/**\n * Security pattern definition\n */\ninterface SecurityPattern {\n\t/** Pattern name */\n\tname: string;\n\t/** Regular expression to match */\n\tpattern: RegExp;\n\t/** Risk score contribution (0-10) */\n\tscore: number;\n\t/** Human-readable message */\n\tmessage: string;\n\t/** Recommendation for remediation */\n\trecommendation: string;\n}\n\n/**\n * Built-in security patterns for detection\n *\n * These patterns detect common security anti-patterns. Scores are sourced from\n * centralized THRESHOLDS.securityScores for consistency.\n */\nconst SECURITY_PATTERNS: SecurityPattern[] = [\n\t{\n\t\tname: \"eval_usage\",\n\t\tpattern: /\\beval\\s*\\(/g,\n\t\tscore: THRESHOLDS.securityScores.evalUsage,\n\t\tmessage: \"eval() usage detected - high security risk\",\n\t\trecommendation:\n\t\t\t\"Avoid using eval() as it can execute arbitrary code. Use safer alternatives like JSON.parse() for data or explicit function calls.\",\n\t},\n\t{\n\t\tname: \"function_constructor\",\n\t\tpattern: /\\bnew\\s+Function\\s*\\(/g,\n\t\tscore: THRESHOLDS.securityScores.functionConstructor,\n\t\tmessage: \"Function constructor usage detected - high security risk\",\n\t\trecommendation:\n\t\t\t\"Avoid using Function constructor as it can execute arbitrary code. Use regular function declarations instead.\",\n\t},\n\t{\n\t\tname: \"dangerous_html\",\n\t\tpattern: /\\binnerHTML\\s*=/g,\n\t\tscore: THRESHOLDS.securityScores.dangerousHtml,\n\t\tmessage: \"innerHTML usage detected - XSS risk\",\n\t\trecommendation:\n\t\t\t\"Use textContent or safer DOM manipulation methods to prevent XSS attacks. If HTML is necessary, sanitize it first.\",\n\t},\n\t{\n\t\tname: \"exec_command\",\n\t\tpattern: /\\bexec\\s*\\(/g,\n\t\tscore: THRESHOLDS.securityScores.execCommand,\n\t\tmessage: \"exec() usage detected - command injection risk\",\n\t\trecommendation:\n\t\t\t\"Avoid using exec(). If shell commands are necessary, use execFile() with hardcoded command paths and validate all inputs.\",\n\t},\n\t{\n\t\tname: \"sql_concat\",\n\t\tpattern: /SELECT\\s+.+\\+\\s*['\"]/gi,\n\t\tscore: THRESHOLDS.securityScores.sqlConcat,\n\t\tmessage: \"Potential SQL injection through string concatenation\",\n\t\trecommendation: \"Use parameterized queries or prepared statements to prevent SQL injection attacks.\",\n\t},\n\t{\n\t\tname: \"hardcoded_secrets\",\n\t\tpattern: /(password|secret|api[_-]?key|token)\\s*=\\s*['\"][^'\"]+['\"]/gi,\n\t\tscore: THRESHOLDS.securityScores.hardcodedSecrets,\n\t\tmessage: \"Potential hardcoded secret detected\",\n\t\trecommendation:\n\t\t\t\"Store secrets in environment variables or secure secret management systems, never in source code.\",\n\t},\n\t{\n\t\tname: \"weak_crypto\",\n\t\tpattern: /\\b(MD5|SHA1)\\b/gi,\n\t\tscore: THRESHOLDS.securityScores.weakCrypto,\n\t\tmessage: \"Weak cryptographic algorithm detected\",\n\t\trecommendation: \"Use modern algorithms like SHA-256 or bcrypt for hashing, and AES-256 for encryption.\",\n\t},\n];\n\n/**\n * RiskAnalyzer - Analyzes code for security risks\n *\n * This class provides platform-agnostic risk analysis through pattern\n * matching and configurable thresholds. It's designed to work across\n * VSCode, CLI, MCP, and web environments.\n */\nexport class RiskAnalyzer {\n\tprivate thresholds: RiskThresholds;\n\tprivate customPatterns: SecurityPattern[] = [];\n\n\t/**\n\t * Creates a new RiskAnalyzer\n\t *\n\t * @param thresholds - Custom threshold configuration (optional)\n\t */\n\tconstructor(thresholds?: Partial<RiskThresholds>) {\n\t\tthis.thresholds = {\n\t\t\t...DEFAULT_RISK_THRESHOLDS,\n\t\t\t...thresholds,\n\t\t};\n\t}\n\n\t/**\n\t * Add a custom security pattern for detection\n\t *\n\t * @param pattern - Security pattern to add\n\t */\n\taddPattern(pattern: SecurityPattern): void {\n\t\tthis.customPatterns.push(pattern);\n\t}\n\n\t/**\n\t * Analyze content for security risks\n\t *\n\t * @param content - Code content to analyze\n\t * @param filePath - Path to the file (for context, optional)\n\t * @returns Analysis result with risk score and factors\n\t */\n\tanalyze(content: string, _filePath?: string): AnalysisResult {\n\t\tconst factors: RiskFactor[] = [];\n\t\tconst recommendations: string[] = [];\n\t\tlet totalScore = 0;\n\n\t\t// Combine built-in and custom patterns\n\t\tconst allPatterns = [...SECURITY_PATTERNS, ...this.customPatterns];\n\n\t\t// Check each pattern against content\n\t\tfor (const pattern of allPatterns) {\n\t\t\tconst matches = content.matchAll(pattern.pattern);\n\t\t\tfor (const match of matches) {\n\t\t\t\t// Add risk factor\n\t\t\t\tfactors.push({\n\t\t\t\t\ttype: pattern.name,\n\t\t\t\t\tmessage: pattern.message,\n\t\t\t\t\tline: this.getLineNumber(content, match.index || 0),\n\t\t\t\t});\n\n\t\t\t\t// Add recommendation (deduplicated)\n\t\t\t\tif (!recommendations.includes(pattern.recommendation)) {\n\t\t\t\t\trecommendations.push(pattern.recommendation);\n\t\t\t\t}\n\n\t\t\t\t// Accumulate score\n\t\t\t\ttotalScore += pattern.score;\n\t\t\t}\n\t\t}\n\n\t\t// Cap score at 10\n\t\tconst cappedScore = Math.min(totalScore, 10);\n\n\t\t// Determine severity based on thresholds\n\t\tconst severity = this.calculateSeverity(cappedScore);\n\n\t\treturn {\n\t\t\tscore: cappedScore,\n\t\t\tseverity,\n\t\t\tfactors,\n\t\t\trecommendations,\n\t\t};\n\t}\n\n\t/**\n\t * Check if a risk score should block a save operation\n\t *\n\t * @param score - Risk score to check\n\t * @returns True if score exceeds blocking threshold\n\t */\n\tshouldBlock(score: number): boolean {\n\t\treturn score > this.thresholds.blockingThreshold;\n\t}\n\n\t/**\n\t * Calculate severity based on risk score\n\t *\n\t * @param score - Risk score (0-10)\n\t * @returns Severity classification\n\t */\n\tprivate calculateSeverity(score: number): RiskSeverity {\n\t\tif (score >= this.thresholds.criticalThreshold) {\n\t\t\treturn \"critical\";\n\t\t}\n\t\tif (score >= this.thresholds.highThreshold) {\n\t\t\treturn \"high\";\n\t\t}\n\t\tif (score >= this.thresholds.mediumThreshold) {\n\t\t\treturn \"medium\";\n\t\t}\n\t\treturn \"low\";\n\t}\n\n\t/**\n\t * Get line number from character index\n\t *\n\t * @param content - Full content string\n\t * @param index - Character index\n\t * @returns Line number (1-indexed)\n\t */\n\tprivate getLineNumber(content: string, index: number): number {\n\t\tconst lines = content.substring(0, index).split(\"\\n\");\n\t\treturn lines.length;\n\t}\n\n\t/**\n\t * Get current thresholds\n\t *\n\t * @returns Current threshold configuration\n\t */\n\tgetThresholds(): RiskThresholds {\n\t\treturn { ...this.thresholds };\n\t}\n\n\t/**\n\t * Update thresholds\n\t *\n\t * @param thresholds - New threshold values\n\t */\n\tsetThresholds(thresholds: Partial<RiskThresholds>): void {\n\t\tthis.thresholds = {\n\t\t\t...this.thresholds,\n\t\t\t...thresholds,\n\t\t};\n\t}\n}\n","/**\n * Runtime Invariant System\n *\n * Provides reporting-enabled assertions that:\n * 1. Throw in development (fail fast)\n * 2. Report to telemetry in production (graceful degradation)\n * 3. Track violation patterns for automated learning\n *\n * @packageDocumentation\n */\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Invariant violation details for reporting\n */\nexport interface InvariantViolation {\n\t/** Unique identifier for this invariant */\n\tinvariantId: string;\n\t/** Human-readable message */\n\tmessage: string;\n\t/** File where violation occurred */\n\tfile?: string;\n\t/** Line number */\n\tline?: number;\n\t/** Additional context */\n\tcontext?: Record<string, unknown>;\n\t/** Timestamp */\n\ttimestamp: number;\n\t/** Stack trace (development only) */\n\tstack?: string;\n}\n\n/**\n * Invariant reporter interface\n */\nexport interface InvariantReporter {\n\t/** Report a violation */\n\treport(violation: InvariantViolation): void;\n\t/** Flush pending reports */\n\tflush?(): Promise<void>;\n}\n\n/**\n * Invariant configuration\n */\nexport interface InvariantConfig {\n\t/** Environment: development throws, production reports */\n\tenv: \"development\" | \"production\" | \"test\";\n\t/** Custom reporter (default: console) */\n\treporter?: InvariantReporter;\n\t/** Enable stack traces */\n\tincludeStack?: boolean;\n}\n\n// =============================================================================\n// Default Configuration\n// =============================================================================\n\nlet globalConfig: InvariantConfig = {\n\tenv: (process.env.NODE_ENV as InvariantConfig[\"env\"]) || \"development\",\n\tincludeStack: true,\n};\n\nconst violationCounts = new Map<string, number>();\n\n/**\n * Console reporter for development\n */\nconst consoleReporter: InvariantReporter = {\n\treport(violation) {\n\t\tconsole.error(`[INVARIANT VIOLATION] ${violation.invariantId}: ${violation.message}`);\n\t\tif (violation.file) {\n\t\t\tconsole.error(`  at ${violation.file}${violation.line ? `:${violation.line}` : \"\"}`);\n\t\t}\n\t\tif (violation.context) {\n\t\t\tconsole.error(\"  context:\", violation.context);\n\t\t}\n\t},\n};\n\n// =============================================================================\n// Core Functions\n// =============================================================================\n\n/**\n * Configure the invariant system\n */\nexport function configureInvariant(config: Partial<InvariantConfig>): void {\n\tglobalConfig = { ...globalConfig, ...config };\n}\n\n/**\n * Get current invariant configuration\n */\nexport function getInvariantConfig(): InvariantConfig {\n\treturn { ...globalConfig };\n}\n\n/**\n * Reset violation counts (for testing)\n */\nexport function resetViolationCounts(): void {\n\tviolationCounts.clear();\n}\n\n/**\n * Get violation counts by invariant ID\n */\nexport function getViolationCounts(): Map<string, number> {\n\treturn new Map(violationCounts);\n}\n\n/**\n * Core invariant function with reporting\n *\n * @param condition - Condition that must be true\n * @param invariantId - Unique identifier for this invariant\n * @param message - Human-readable message if condition fails\n * @param context - Optional additional context\n *\n * @example\n * ```typescript\n * // Basic usage\n * invariant(user != null, \"user-exists\", \"User must exist\");\n *\n * // With context\n * invariant(\n *   storage.path.startsWith(workspaceRoot),\n *   \"storage-path-valid\",\n *   \"Storage path must be within workspace\",\n *   { path: storage.path, workspaceRoot }\n * );\n * ```\n */\nexport function invariant(\n\tcondition: unknown,\n\tinvariantId: string,\n\tmessage: string,\n\tcontext?: Record<string, unknown>,\n): asserts condition {\n\tif (condition) {\n\t\treturn;\n\t}\n\n\t// Track violation count\n\tconst count = (violationCounts.get(invariantId) || 0) + 1;\n\tviolationCounts.set(invariantId, count);\n\n\t// Build violation details\n\tconst violation: InvariantViolation = {\n\t\tinvariantId,\n\t\tmessage,\n\t\tcontext,\n\t\ttimestamp: Date.now(),\n\t};\n\n\t// Add stack trace if configured\n\tif (globalConfig.includeStack) {\n\t\tconst err = new Error();\n\t\tviolation.stack = err.stack;\n\n\t\t// Extract file/line from stack\n\t\tconst stackLines = err.stack?.split(\"\\n\") || [];\n\t\tconst callerLine = stackLines[2]; // Skip Error and invariant lines\n\t\tconst match = callerLine?.match(/at\\s+(?:.+?\\s+)?\\(?(.+?):(\\d+):\\d+\\)?/);\n\t\tif (match) {\n\t\t\tviolation.file = match[1];\n\t\t\tviolation.line = Number.parseInt(match[2], 10);\n\t\t}\n\t}\n\n\t// Report violation\n\tconst reporter = globalConfig.reporter || consoleReporter;\n\treporter.report(violation);\n\n\t// Behavior based on environment\n\tif (globalConfig.env === \"development\" || globalConfig.env === \"test\") {\n\t\t// Development: throw immediately\n\t\tconst err = new Error(`Invariant violation [${invariantId}]: ${message}`);\n\t\terr.name = \"InvariantError\";\n\t\tthrow err;\n\t}\n\n\t// Production: log but don't throw (graceful degradation)\n\t// The reporter should send to telemetry\n}\n\n/**\n * Soft invariant - warns instead of throwing in development\n *\n * Use for conditions that indicate a problem but shouldn't crash the app.\n */\nexport function softInvariant(\n\tcondition: unknown,\n\tinvariantId: string,\n\tmessage: string,\n\tcontext?: Record<string, unknown>,\n): boolean {\n\tif (condition) {\n\t\treturn true;\n\t}\n\n\t// Track violation count\n\tconst count = (violationCounts.get(invariantId) || 0) + 1;\n\tviolationCounts.set(invariantId, count);\n\n\t// Build violation details\n\tconst violation: InvariantViolation = {\n\t\tinvariantId,\n\t\tmessage: `[SOFT] ${message}`,\n\t\tcontext,\n\t\ttimestamp: Date.now(),\n\t};\n\n\t// Report violation\n\tconst reporter = globalConfig.reporter || consoleReporter;\n\treporter.report(violation);\n\n\treturn false;\n}\n\n/**\n * Type guard invariant - asserts type with runtime check\n *\n * @example\n * ```typescript\n * const maybeUser = getUser();\n * typeInvariant(maybeUser, isUser, \"user-type\", \"Expected User type\");\n * // maybeUser is now typed as User\n * ```\n */\nexport function typeInvariant<T>(\n\tvalue: unknown,\n\tguard: (v: unknown) => v is T,\n\tinvariantId: string,\n\tmessage: string,\n\tcontext?: Record<string, unknown>,\n): asserts value is T {\n\tinvariant(guard(value), invariantId, message, {\n\t\t...context,\n\t\tactualType: typeof value,\n\t\tactualValue: value,\n\t});\n}\n\n/**\n * Create a scoped invariant function for a specific domain\n *\n * @example\n * ```typescript\n * const storageInvariant = createScopedInvariant(\"storage\");\n * storageInvariant(path.exists, \"path-exists\", \"Storage path must exist\");\n * // Reports as \"storage:path-exists\"\n * ```\n */\nexport function createScopedInvariant(scope: string) {\n\treturn function scopedInvariant(\n\t\tcondition: unknown,\n\t\tid: string,\n\t\tmessage: string,\n\t\tcontext?: Record<string, unknown>,\n\t): asserts condition {\n\t\tinvariant(condition, `${scope}:${id}`, message, context);\n\t};\n}\n\n// =============================================================================\n// Predefined Invariant Helpers\n// =============================================================================\n\n/**\n * Assert value is not null or undefined\n */\nexport function assertDefined<T>(\n\tvalue: T | null | undefined,\n\tinvariantId: string,\n\tmessage: string,\n): asserts value is T {\n\tinvariant(value != null, invariantId, message, { value });\n}\n\n/**\n * Assert value is a non-empty string\n */\nexport function assertNonEmptyString(value: unknown, invariantId: string, message: string): asserts value is string {\n\tinvariant(typeof value === \"string\" && value.length > 0, invariantId, message, {\n\t\tactualType: typeof value,\n\t\tlength: typeof value === \"string\" ? value.length : \"N/A\",\n\t});\n}\n\n/**\n * Assert value is a positive number\n */\nexport function assertPositiveNumber(value: unknown, invariantId: string, message: string): asserts value is number {\n\tinvariant(typeof value === \"number\" && value > 0 && !Number.isNaN(value), invariantId, message, {\n\t\tactualType: typeof value,\n\t\tvalue,\n\t});\n}\n\n/**\n * Assert array is non-empty\n */\nexport function assertNonEmptyArray<T>(value: unknown, invariantId: string, message: string): asserts value is T[] {\n\tinvariant(Array.isArray(value) && value.length > 0, invariantId, message, {\n\t\tisArray: Array.isArray(value),\n\t\tlength: Array.isArray(value) ? value.length : \"N/A\",\n\t});\n}\n\n/**\n * Assert path is within allowed root (prevents path traversal)\n */\nexport function assertPathWithinRoot(path: string, root: string, invariantId: string): void {\n\tconst normalizedPath = path.replace(/\\\\/g, \"/\");\n\tconst normalizedRoot = root.replace(/\\\\/g, \"/\");\n\n\tinvariant(\n\t\tnormalizedPath.startsWith(normalizedRoot) && !normalizedPath.includes(\"..\"),\n\t\tinvariantId,\n\t\t\"Path must be within allowed root directory\",\n\t\t{ path, root },\n\t);\n}\n","/**\n * Architecture Rules Runner\n *\n * Wraps ts-arch to provide:\n * 1. Declarative rule definitions\n * 2. Project-specific rule configuration\n * 3. Integration with SnapBack's layer architecture\n * 4. Reporting for MCP and CI integration\n *\n * @packageDocumentation\n */\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Architecture rule definition\n */\nexport interface ArchRule {\n\t/** Unique rule identifier */\n\tid: string;\n\t/** Human-readable description */\n\tdescription: string;\n\t/** Source pattern (files/folders that should NOT import target) */\n\tsource: string | string[];\n\t/** Target pattern (files/folders that should NOT be imported) */\n\ttarget: string | string[];\n\t/** Rule type */\n\ttype: \"no-dependency\" | \"cycle-free\" | \"layer-dependency\";\n\t/** Severity: error fails build, warning just reports */\n\tseverity: \"error\" | \"warning\";\n\t/** Optional: specific files to exclude from this rule */\n\texclude?: string[];\n}\n\n/**\n * Architecture rule violation\n */\nexport interface ArchViolation {\n\t/** Rule that was violated */\n\truleId: string;\n\t/** Rule description */\n\truleDescription: string;\n\t/** Severity */\n\tseverity: \"error\" | \"warning\";\n\t/** Source file that has the bad import */\n\tsourceFile: string;\n\t/** Target file that should not be imported */\n\ttargetFile?: string;\n\t/** Import path as written in code */\n\timportPath?: string;\n\t/** Line number of violation */\n\tline?: number;\n}\n\n/**\n * Architecture check result\n */\nexport interface ArchCheckResult {\n\t/** Whether all rules passed */\n\tpassed: boolean;\n\t/** Total rules checked */\n\trulesChecked: number;\n\t/** Rules that passed */\n\trulesPassed: number;\n\t/** All violations found */\n\tviolations: ArchViolation[];\n\t/** Execution time in ms */\n\tdurationMs: number;\n\t/** Detailed results per rule */\n\truleResults: Array<{\n\t\truleId: string;\n\t\tpassed: boolean;\n\t\tviolations: ArchViolation[];\n\t}>;\n}\n\n/**\n * Architecture runner configuration\n */\nexport interface ArchRunnerConfig {\n\t/** Workspace root directory */\n\tworkspaceRoot: string;\n\t/** Path to tsconfig.json (default: auto-detect) */\n\ttsconfigPath?: string;\n\t/** Custom rules to add to defaults */\n\tcustomRules?: ArchRule[];\n\t/** Override default rules entirely */\n\toverrideDefaultRules?: boolean;\n\t/** Patterns to exclude from all checks */\n\tglobalExclude?: string[];\n}\n\n// =============================================================================\n// Default SnapBack Layer Rules\n// =============================================================================\n\n/**\n * SnapBack Layer Architecture:\n *\n * Presentation (VSCode, Web, CLI)\n *     can import\n * Service (API, MCP, SDK)\n *     can import\n * Core (Guardian, Engine)\n *     can import\n * Intelligence (Validation, Learning)\n *\n * Key constraint: Presentation CANNOT import Infrastructure directly\n */\nexport const SNAPBACK_LAYER_RULES: ArchRule[] = [\n\t{\n\t\tid: \"presentation-no-infrastructure\",\n\t\tdescription: \"Presentation layer (apps/) cannot import @snapback/infrastructure directly\",\n\t\tsource: [\"apps/vscode\", \"apps/web\", \"apps/cli\"],\n\t\ttarget: [\"@snapback/infrastructure\", \"packages/infrastructure\"],\n\t\ttype: \"no-dependency\",\n\t\tseverity: \"error\",\n\t},\n\t{\n\t\tid: \"core-no-presentation\",\n\t\tdescription: \"Core packages cannot import presentation layer\",\n\t\tsource: [\"packages/core\", \"packages/intelligence\"],\n\t\ttarget: [\"apps/vscode\", \"apps/web\", \"apps/cli\"],\n\t\ttype: \"no-dependency\",\n\t\tseverity: \"error\",\n\t},\n\t{\n\t\tid: \"sdk-no-vscode\",\n\t\tdescription: \"SDK cannot import VS Code specific modules\",\n\t\tsource: [\"packages/sdk\", \"packages-oss/sdk\"],\n\t\ttarget: [\"vscode\", \"apps/vscode\"],\n\t\ttype: \"no-dependency\",\n\t\tseverity: \"error\",\n\t},\n\t{\n\t\tid: \"contracts-standalone\",\n\t\tdescription: \"Contracts package should have no internal dependencies\",\n\t\tsource: [\"packages/contracts\"],\n\t\ttarget: [\"packages/core\", \"packages/infrastructure\", \"packages/intelligence\", \"packages/sdk\", \"apps/\"],\n\t\ttype: \"no-dependency\",\n\t\tseverity: \"error\",\n\t},\n\t{\n\t\tid: \"storage-workspace-only\",\n\t\tdescription: \"Storage operations must use workspace paths, not global paths\",\n\t\tsource: [\"**/storage/**\", \"**/snapshot/**\"],\n\t\ttarget: [\"globalStorageUri\", \"globalState\"],\n\t\ttype: \"no-dependency\",\n\t\tseverity: \"warning\",\n\t},\n\t{\n\t\tid: \"no-circular-core\",\n\t\tdescription: \"Core packages must be free of circular dependencies\",\n\t\tsource: [\"packages/core/src\"],\n\t\ttarget: [],\n\t\ttype: \"cycle-free\",\n\t\tseverity: \"error\",\n\t},\n\t{\n\t\tid: \"no-circular-intelligence\",\n\t\tdescription: \"Intelligence package must be free of circular dependencies\",\n\t\tsource: [\"packages/intelligence/src\"],\n\t\ttarget: [],\n\t\ttype: \"cycle-free\",\n\t\tseverity: \"error\",\n\t},\n];\n\n// =============================================================================\n// Architecture Rules Runner\n// =============================================================================\n\n/**\n * Run architecture rules check\n *\n * Uses static analysis to verify import relationships without\n * requiring ts-arch as a runtime dependency.\n *\n * @example\n * ```typescript\n * const result = await runArchCheck({\n *   workspaceRoot: process.cwd(),\n *   customRules: [{\n *     id: \"my-rule\",\n *     description: \"Custom rule\",\n *     source: \"src/api\",\n *     target: \"src/ui\",\n *     type: \"no-dependency\",\n *     severity: \"error\"\n *   }]\n * });\n *\n * if (!result.passed) {\n *   console.error(\"Architecture violations:\", result.violations);\n * }\n * ```\n */\nexport async function runArchCheck(config: ArchRunnerConfig): Promise<ArchCheckResult> {\n\tconst startTime = Date.now();\n\n\t// Combine rules\n\tconst rules = config.overrideDefaultRules\n\t\t? config.customRules || []\n\t\t: [...SNAPBACK_LAYER_RULES, ...(config.customRules || [])];\n\n\tconst violations: ArchViolation[] = [];\n\tconst ruleResults: ArchCheckResult[\"ruleResults\"] = [];\n\n\t// Check each rule\n\tfor (const rule of rules) {\n\t\tconst ruleViolations = await checkRule(rule, config);\n\t\truleResults.push({\n\t\t\truleId: rule.id,\n\t\t\tpassed: ruleViolations.length === 0,\n\t\t\tviolations: ruleViolations,\n\t\t});\n\t\tviolations.push(...ruleViolations);\n\t}\n\n\tconst errorCount = violations.filter((v) => v.severity === \"error\").length;\n\n\treturn {\n\t\tpassed: errorCount === 0,\n\t\trulesChecked: rules.length,\n\t\trulesPassed: ruleResults.filter((r) => r.passed).length,\n\t\tviolations,\n\t\tdurationMs: Date.now() - startTime,\n\t\truleResults,\n\t};\n}\n\n/**\n * Check a single architecture rule\n */\nasync function checkRule(rule: ArchRule, config: ArchRunnerConfig): Promise<ArchViolation[]> {\n\tconst violations: ArchViolation[] = [];\n\n\tswitch (rule.type) {\n\t\tcase \"no-dependency\":\n\t\t\tviolations.push(...(await checkNoDependency(rule, config)));\n\t\t\tbreak;\n\t\tcase \"cycle-free\":\n\t\t\tviolations.push(...(await checkCycleFree(rule, config)));\n\t\t\tbreak;\n\t\tcase \"layer-dependency\":\n\t\t\t// Future: validate layer hierarchy\n\t\t\tbreak;\n\t}\n\n\treturn violations;\n}\n\n/**\n * Check no-dependency rule using grep-based static analysis\n */\nasync function checkNoDependency(rule: ArchRule, config: ArchRunnerConfig): Promise<ArchViolation[]> {\n\tconst violations: ArchViolation[] = [];\n\tconst { join, relative } = await import(\"node:path\");\n\n\tconst sources = Array.isArray(rule.source) ? rule.source : [rule.source];\n\tconst targets = Array.isArray(rule.target) ? rule.target : [rule.target];\n\n\tfor (const source of sources) {\n\t\tconst sourceDir = join(config.workspaceRoot, source);\n\n\t\tfor (const target of targets) {\n\t\t\t// Build grep pattern for import/require of target\n\t\t\tconst patterns = [\n\t\t\t\t`from ['\"]${escapeRegex(target)}`, // ES import\n\t\t\t\t`from ['\"]${escapeRegex(target)}/`, // ES import subpath\n\t\t\t\t`require\\\\(['\"]${escapeRegex(target)}`, // CommonJS require\n\t\t\t\t`require\\\\(['\"]${escapeRegex(target)}/`, // CommonJS require subpath\n\t\t\t\t`import\\\\(['\"]${escapeRegex(target)}`, // Dynamic import\n\t\t\t];\n\n\t\t\tconst pattern = patterns.join(\"|\");\n\n\t\t\ttry {\n\t\t\t\tconst result = await runGrep(sourceDir, pattern, config.globalExclude);\n\n\t\t\t\tfor (const match of result) {\n\t\t\t\t\t// Skip excluded files\n\t\t\t\t\tif (rule.exclude?.some((ex) => match.file.includes(ex))) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tviolations.push({\n\t\t\t\t\t\truleId: rule.id,\n\t\t\t\t\t\truleDescription: rule.description,\n\t\t\t\t\t\tseverity: rule.severity,\n\t\t\t\t\t\tsourceFile: relative(config.workspaceRoot, match.file),\n\t\t\t\t\t\ttargetFile: target,\n\t\t\t\t\t\timportPath: match.match,\n\t\t\t\t\t\tline: match.line,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Directory might not exist, skip\n\t\t\t}\n\t\t}\n\t}\n\n\treturn violations;\n}\n\n/**\n * Check cycle-free rule using madge\n */\nasync function checkCycleFree(rule: ArchRule, config: ArchRunnerConfig): Promise<ArchViolation[]> {\n\tconst violations: ArchViolation[] = [];\n\tconst { existsSync } = await import(\"node:fs\");\n\tconst { join, relative } = await import(\"node:path\");\n\n\tconst sources = Array.isArray(rule.source) ? rule.source : [rule.source];\n\n\tfor (const source of sources) {\n\t\tconst sourceDir = join(config.workspaceRoot, source);\n\n\t\tif (!existsSync(sourceDir)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\ttry {\n\t\t\t// Dynamic import madge\n\t\t\tconst madgeModule = await import(\"madge\");\n\t\t\tconst madge = madgeModule.default || madgeModule;\n\n\t\t\tconst result = await madge(sourceDir, {\n\t\t\t\tfileExtensions: [\"ts\", \"tsx\", \"js\", \"jsx\"],\n\t\t\t\texcludeRegExp: [\n\t\t\t\t\t/node_modules/,\n\t\t\t\t\t/dist/,\n\t\t\t\t\t/\\.next/,\n\t\t\t\t\t/\\.test\\./,\n\t\t\t\t\t/\\.spec\\./,\n\t\t\t\t\t/__tests__/,\n\t\t\t\t\t/__mocks__/,\n\t\t\t\t\t...(config.globalExclude?.map((p) => new RegExp(p)) || []),\n\t\t\t\t],\n\t\t\t\tdetectiveOptions: { ts: { skipTypeImports: true } },\n\t\t\t});\n\n\t\t\tconst cycles = result.circular() as string[][];\n\n\t\t\tfor (const cycle of cycles) {\n\t\t\t\tviolations.push({\n\t\t\t\t\truleId: rule.id,\n\t\t\t\t\truleDescription: rule.description,\n\t\t\t\t\tseverity: rule.severity,\n\t\t\t\t\tsourceFile: relative(config.workspaceRoot, join(sourceDir, cycle[0])),\n\t\t\t\t\timportPath: cycle.join(\" -> \"),\n\t\t\t\t});\n\t\t\t}\n\t\t} catch {\n\t\t\t// madge might fail for some directories\n\t\t}\n\t}\n\n\treturn violations;\n}\n\n// =============================================================================\n// Helpers\n// =============================================================================\n\ninterface GrepMatch {\n\tfile: string;\n\tline: number;\n\tmatch: string;\n}\n\n/**\n * Run grep to find import patterns\n */\nasync function runGrep(dir: string, pattern: string, exclude?: string[]): Promise<GrepMatch[]> {\n\tconst { spawn } = await import(\"node:child_process\");\n\tconst { existsSync } = await import(\"node:fs\");\n\n\tif (!existsSync(dir)) {\n\t\treturn [];\n\t}\n\n\treturn new Promise((resolve) => {\n\t\tconst args = [\n\t\t\t\"-r\", // recursive\n\t\t\t\"-n\", // line numbers\n\t\t\t\"-E\", // extended regex\n\t\t\t\"--include=*.ts\",\n\t\t\t\"--include=*.tsx\",\n\t\t\t\"--include=*.js\",\n\t\t\t\"--include=*.jsx\",\n\t\t];\n\n\t\t// Add exclusions\n\t\tfor (const ex of exclude || []) {\n\t\t\targs.push(`--exclude-dir=${ex}`);\n\t\t}\n\t\targs.push(\"--exclude-dir=node_modules\");\n\t\targs.push(\"--exclude-dir=dist\");\n\t\targs.push(\"--exclude-dir=.next\");\n\n\t\targs.push(pattern);\n\t\targs.push(dir);\n\n\t\tconst proc = spawn(\"grep\", args, {\n\t\t\tcwd: dir,\n\t\t\tstdio: [\"pipe\", \"pipe\", \"pipe\"],\n\t\t});\n\n\t\tlet stdout = \"\";\n\t\tproc.stdout?.on(\"data\", (data) => {\n\t\t\tstdout += data.toString();\n\t\t});\n\n\t\tproc.on(\"close\", () => {\n\t\t\tconst matches: GrepMatch[] = [];\n\t\t\tconst lines = stdout.split(\"\\n\").filter(Boolean);\n\n\t\t\tfor (const line of lines) {\n\t\t\t\t// Parse grep output: file:line:content\n\t\t\t\tconst colonIdx = line.indexOf(\":\");\n\t\t\t\tif (colonIdx === -1) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst file = line.slice(0, colonIdx);\n\t\t\t\tconst rest = line.slice(colonIdx + 1);\n\t\t\t\tconst lineNumIdx = rest.indexOf(\":\");\n\t\t\t\tif (lineNumIdx === -1) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst lineNum = Number.parseInt(rest.slice(0, lineNumIdx), 10);\n\t\t\t\tconst content = rest.slice(lineNumIdx + 1);\n\n\t\t\t\tmatches.push({\n\t\t\t\t\tfile,\n\t\t\t\t\tline: lineNum,\n\t\t\t\t\tmatch: content.trim(),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tresolve(matches);\n\t\t});\n\n\t\tproc.on(\"error\", () => {\n\t\t\tresolve([]);\n\t\t});\n\t});\n}\n\n/**\n * Escape string for use in regex\n */\nfunction escapeRegex(str: string): string {\n\treturn str.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n}\n\n// =============================================================================\n// Rule Builders (Fluent API)\n// =============================================================================\n\n/**\n * Fluent rule builder for creating custom rules\n *\n * @example\n * ```typescript\n * const rule = createRule(\"my-rule\", \"Description\")\n *   .filesIn(\"src/api\")\n *   .shouldNotDependOn(\"src/ui\")\n *   .withSeverity(\"error\")\n *   .build();\n * ```\n */\nexport function createRule(id: string, description: string) {\n\tconst rule: Partial<ArchRule> = { id, description, severity: \"error\" };\n\n\treturn {\n\t\tfilesIn(pattern: string | string[]) {\n\t\t\trule.source = pattern;\n\t\t\treturn this;\n\t\t},\n\t\tshouldNotDependOn(pattern: string | string[]) {\n\t\t\trule.target = pattern;\n\t\t\trule.type = \"no-dependency\";\n\t\t\treturn this;\n\t\t},\n\t\tshouldBeCycleFree() {\n\t\t\trule.type = \"cycle-free\";\n\t\t\trule.target = [];\n\t\t\treturn this;\n\t\t},\n\t\twithSeverity(severity: \"error\" | \"warning\") {\n\t\t\trule.severity = severity;\n\t\t\treturn this;\n\t\t},\n\t\texcluding(patterns: string[]) {\n\t\t\trule.exclude = patterns;\n\t\t\treturn this;\n\t\t},\n\t\tbuild(): ArchRule {\n\t\t\tif (!rule.source) {\n\t\t\t\tthrow new Error(`Rule ${id} must specify source with filesIn()`);\n\t\t\t}\n\t\t\tif (!rule.type) {\n\t\t\t\tthrow new Error(`Rule ${id} must specify constraint type`);\n\t\t\t}\n\t\t\treturn rule as ArchRule;\n\t\t},\n\t};\n}\n","/**\n * Device Authorization Client (RFC 8628)\n *\n * Shared client for device authorization flow used by CLI and VSCode extension.\n * Implements OAuth 2.0 Device Authorization Grant (RFC 8628) for devices\n * with limited input capabilities or where browser OAuth callbacks don't work.\n *\n * @see https://tools.ietf.org/html/rfc8628\n */\n\nimport ky, { type KyInstance } from \"ky\";\n\n/**\n * Device code response from authorization server (RFC 8628 Section 3.2)\n */\nexport interface DeviceCodeResponse {\n\t/** Device code for polling requests */\n\tdevice_code: string;\n\t/** User-friendly code to display for verification */\n\tuser_code: string;\n\t/** URL where user enters the user code */\n\tverification_uri: string;\n\t/** Optional: Pre-filled verification URI with user code */\n\tverification_uri_complete?: string;\n\t/** Seconds until device code expires */\n\texpires_in: number;\n\t/** Recommended polling interval in seconds (minimum 5) */\n\tinterval: number;\n}\n\n/**\n * Token response on successful authorization\n */\nexport interface TokenResponse {\n\t/** Bearer token for API access */\n\taccess_token: string;\n\t/** Token type (always \"Bearer\") */\n\ttoken_type: \"Bearer\";\n\t/** Token expiration time in seconds */\n\texpires_in?: number;\n\t/** Optional refresh token */\n\trefresh_token?: string;\n\t/** Granted scopes (space-separated) */\n\tscope?: string;\n}\n\n/**\n * RFC 8628 error codes during polling\n */\nexport type DeviceAuthError =\n\t| \"authorization_pending\"\n\t| \"slow_down\"\n\t| \"expired_token\"\n\t| \"access_denied\"\n\t| \"invalid_request\";\n\n/**\n * Error response during token polling\n */\nexport interface DeviceAuthErrorResponse {\n\terror: DeviceAuthError;\n\terror_description?: string;\n}\n\n/**\n * Auth result returned to consumers\n */\nexport interface AuthResult {\n\tapi_key: string;\n\tuser_id: string;\n\ttier: \"free\" | \"pro\" | \"enterprise\";\n\taccess_token: string;\n\trefresh_token?: string;\n\texpires_in?: number;\n}\n\n/**\n * Flow state for tracking authentication progress\n */\nexport type FlowState = \"idle\" | \"requesting_code\" | \"waiting_for_approval\" | \"approved\" | \"cancelled\" | \"error\";\n\n/**\n * Event callbacks for tracking authentication progress\n */\nexport interface DeviceAuthCallbacks {\n\t/** Called when device code is received and user should visit verification URL */\n\tonDeviceCode?: (response: DeviceCodeResponse) => void;\n\t/** Called on each poll attempt */\n\tonPoll?: (attempt: number, intervalMs: number) => void;\n\t/** Called when polling interval is increased (slow_down response) */\n\tonSlowDown?: (newIntervalMs: number) => void;\n\t/** Called when authorization succeeds */\n\tonApproved?: (result: AuthResult) => void;\n\t/** Called when an error occurs */\n\tonError?: (error: Error, code?: DeviceAuthError) => void;\n\t/** Called when flow is cancelled */\n\tonCancelled?: () => void;\n}\n\n/**\n * Configuration for DeviceAuthClient\n */\nexport interface DeviceAuthClientConfig {\n\t/** Base URL for API (e.g., \"https://api.snapback.dev/api\") */\n\tbaseUrl: string;\n\t/** Client identifier for the requesting application */\n\tclientId: string;\n\t/** Optional scopes to request */\n\tscope?: string;\n\t/** Custom HTTP client (for testing) */\n\thttpClient?: KyInstance;\n\t/** Optional AbortSignal for cancellation */\n\tsignal?: AbortSignal;\n}\n\n/**\n * Device Authorization Client\n *\n * Implements RFC 8628 OAuth 2.0 Device Authorization Grant.\n * Used by CLI and VSCode extension for authentication in environments\n * where browser OAuth callbacks don't work (WSL, Remote SSH, Codespaces).\n *\n * @example\n * ```typescript\n * const client = new DeviceAuthClient({\n *   baseUrl: \"https://api.snapback.dev/api\",\n *   clientId: \"vscode-extension\",\n * });\n *\n * const result = await client.authenticate({\n *   onDeviceCode: (response) => {\n *     console.log(`Visit ${response.verification_uri}`);\n *     console.log(`Enter code: ${response.user_code}`);\n *   },\n *   onApproved: (result) => {\n *     console.log(`Authenticated as ${result.user_id}`);\n *   },\n * });\n * ```\n */\nexport class DeviceAuthClient {\n\tprivate http: KyInstance;\n\tprivate config: DeviceAuthClientConfig;\n\tprivate state: FlowState = \"idle\";\n\tprivate abortController: AbortController | null = null;\n\tprivate currentInterval = 5000; // Default 5 seconds\n\n\tconstructor(config: DeviceAuthClientConfig) {\n\t\tthis.config = config;\n\t\tthis.http =\n\t\t\tconfig.httpClient ??\n\t\t\tky.create({\n\t\t\t\tprefixUrl: config.baseUrl,\n\t\t\t\ttimeout: 30000,\n\t\t\t});\n\t}\n\n\t/**\n\t * Get current flow state\n\t */\n\tgetState(): FlowState {\n\t\treturn this.state;\n\t}\n\n\t/**\n\t * Cancel the authentication flow\n\t */\n\tcancel(): void {\n\t\tthis.abortController?.abort();\n\t\tthis.state = \"cancelled\";\n\t}\n\n\t/**\n\t * Start device authorization flow\n\t *\n\t * @param callbacks - Event callbacks for tracking progress\n\t * @returns AuthResult on success\n\t * @throws Error on failure or cancellation\n\t */\n\tasync authenticate(callbacks?: DeviceAuthCallbacks): Promise<AuthResult> {\n\t\t// Prevent concurrent authentications\n\t\tif (this.state === \"requesting_code\" || this.state === \"waiting_for_approval\") {\n\t\t\tthrow new Error(\"Authentication already in progress\");\n\t\t}\n\n\t\tthis.abortController = new AbortController();\n\t\tthis.state = \"requesting_code\";\n\n\t\ttry {\n\t\t\t// Step 1: Request device code\n\t\t\tconst deviceCodeResponse = await this.requestDeviceCode();\n\t\t\tcallbacks?.onDeviceCode?.(deviceCodeResponse);\n\n\t\t\t// Step 2: Set up polling\n\t\t\tthis.currentInterval = deviceCodeResponse.interval * 1000;\n\t\t\tthis.state = \"waiting_for_approval\";\n\n\t\t\t// Step 3: Poll for token\n\t\t\tconst result = await this.pollForToken(deviceCodeResponse, callbacks);\n\n\t\t\tthis.state = \"approved\";\n\t\t\tcallbacks?.onApproved?.(result);\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\t// Note: state could be \"cancelled\" if cancel() was called from another context\n\t\t\tconst currentState = this.state as FlowState;\n\t\t\tif (currentState !== \"cancelled\") {\n\t\t\t\tthis.state = \"error\";\n\t\t\t}\n\n\t\t\tconst err = error instanceof Error ? error : new Error(String(error));\n\n\t\t\tif (currentState === \"cancelled\") {\n\t\t\t\tcallbacks?.onCancelled?.();\n\t\t\t} else {\n\t\t\t\tcallbacks?.onError?.(err);\n\t\t\t}\n\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\t/**\n\t * Request device code from authorization server (RFC 8628 Section 3.1)\n\t */\n\tprivate async requestDeviceCode(): Promise<DeviceCodeResponse> {\n\t\tconst signal = this.mergeSignals();\n\n\t\ttry {\n\t\t\tconst response = await this.http\n\t\t\t\t.post(\"deviceAuth/requestCode\", {\n\t\t\t\t\tjson: {\n\t\t\t\t\t\tclient_id: this.config.clientId,\n\t\t\t\t\t\tscope: this.config.scope,\n\t\t\t\t\t},\n\t\t\t\t\tsignal,\n\t\t\t\t})\n\t\t\t\t.json<DeviceCodeResponse>();\n\n\t\t\tif (!response.device_code) {\n\t\t\t\tthrow new Error(\"Invalid device code response: missing device_code\");\n\t\t\t}\n\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\tthis.handleAbortError(error);\n\t\t\tthrow new Error(`Device code request failed: ${error instanceof Error ? error.message : String(error)}`);\n\t\t}\n\t}\n\n\t/**\n\t * Poll for token with RFC 8628 compliant error handling\n\t */\n\tprivate async pollForToken(\n\t\tdeviceCodeResponse: DeviceCodeResponse,\n\t\tcallbacks?: DeviceAuthCallbacks,\n\t): Promise<AuthResult> {\n\t\tconst { device_code, expires_in } = deviceCodeResponse;\n\t\tconst startTime = Date.now();\n\t\tconst timeoutMs = expires_in * 1000;\n\t\tlet attempt = 0;\n\n\t\twhile (true) {\n\t\t\t// Check for timeout\n\t\t\tif (Date.now() - startTime > timeoutMs) {\n\t\t\t\tthrow new Error(\"Device code expired - authentication timeout\");\n\t\t\t}\n\n\t\t\t// Check for cancellation\n\t\t\tif (this.abortController?.signal.aborted) {\n\t\t\t\tthis.state = \"cancelled\";\n\t\t\t\tthrow new Error(\"Authentication cancelled\");\n\t\t\t}\n\n\t\t\t// Wait before polling\n\t\t\tawait this.delay(this.currentInterval);\n\n\t\t\tattempt++;\n\t\t\tcallbacks?.onPoll?.(attempt, this.currentInterval);\n\n\t\t\ttry {\n\t\t\t\tconst signal = this.mergeSignals();\n\n\t\t\t\tconst response = await this.http\n\t\t\t\t\t.post(\"deviceAuth/pollToken\", {\n\t\t\t\t\t\tjson: {\n\t\t\t\t\t\t\tdevice_code,\n\t\t\t\t\t\t\tgrant_type: \"urn:ietf:params:oauth:grant-type:device_code\",\n\t\t\t\t\t\t\tclient_id: this.config.clientId,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsignal,\n\t\t\t\t\t})\n\t\t\t\t\t.json<TokenResponse | DeviceAuthErrorResponse>();\n\n\t\t\t\t// Check for success\n\t\t\t\tif (\"access_token\" in response) {\n\t\t\t\t\treturn this.mapTokenToAuthResult(response);\n\t\t\t\t}\n\n\t\t\t\t// Handle RFC 8628 error codes\n\t\t\t\tif (\"error\" in response) {\n\t\t\t\t\tswitch (response.error) {\n\t\t\t\t\t\tcase \"authorization_pending\":\n\t\t\t\t\t\t\t// User hasn't approved yet - continue polling\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase \"slow_down\":\n\t\t\t\t\t\t\t// Server requested slower polling - increase interval by 5s\n\t\t\t\t\t\t\tthis.currentInterval += 5000;\n\t\t\t\t\t\t\tcallbacks?.onSlowDown?.(this.currentInterval);\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase \"access_denied\":\n\t\t\t\t\t\t\tcallbacks?.onError?.(new Error(\"Authorization denied by user\"), \"access_denied\");\n\t\t\t\t\t\t\tthrow new Error(\"Authorization denied by user\");\n\n\t\t\t\t\t\tcase \"expired_token\":\n\t\t\t\t\t\t\tcallbacks?.onError?.(new Error(\"Device code expired\"), \"expired_token\");\n\t\t\t\t\t\t\tthrow new Error(\"Device code expired on server\");\n\n\t\t\t\t\t\tcase \"invalid_request\":\n\t\t\t\t\t\t\tcallbacks?.onError?.(new Error(\"Invalid device code\"), \"invalid_request\");\n\t\t\t\t\t\t\tthrow new Error(\"Invalid device code format\");\n\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tthrow new Error(`Unknown error: ${response.error}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthis.handleAbortError(error);\n\n\t\t\t\t// Re-throw terminal errors\n\t\t\t\tif (error instanceof Error) {\n\t\t\t\t\tif (\n\t\t\t\t\t\terror.message.includes(\"cancelled\") ||\n\t\t\t\t\t\terror.message.includes(\"denied\") ||\n\t\t\t\t\t\terror.message.includes(\"expired\") ||\n\t\t\t\t\t\terror.message.includes(\"Invalid\")\n\t\t\t\t\t) {\n\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Network errors - continue polling\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Map token response to AuthResult\n\t */\n\tprivate mapTokenToAuthResult(token: TokenResponse): AuthResult {\n\t\t// In production, user_id and tier would be extracted from JWT claims\n\t\t// For now, use placeholder values that should be updated by the caller\n\t\treturn {\n\t\t\tapi_key: token.access_token,\n\t\t\tuser_id: \"user-from-token\", // Extract from JWT claims\n\t\t\ttier: \"free\", // Extract from JWT claims\n\t\t\taccess_token: token.access_token,\n\t\t\trefresh_token: token.refresh_token,\n\t\t\texpires_in: token.expires_in,\n\t\t};\n\t}\n\n\t/**\n\t * Delay execution with cancellation support\n\t */\n\tprivate delay(ms: number): Promise<void> {\n\t\treturn new Promise((resolve) => {\n\t\t\tconst timeout = setTimeout(resolve, ms);\n\n\t\t\tthis.abortController?.signal.addEventListener(\n\t\t\t\t\"abort\",\n\t\t\t\t() => {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\tresolve();\n\t\t\t\t},\n\t\t\t\t{ once: true },\n\t\t\t);\n\t\t});\n\t}\n\n\t/**\n\t * Merge configured signal with internal abort controller\n\t */\n\tprivate mergeSignals(): AbortSignal | undefined {\n\t\tconst signals: AbortSignal[] = [];\n\n\t\tif (this.abortController?.signal) {\n\t\t\tsignals.push(this.abortController.signal);\n\t\t}\n\n\t\tif (this.config.signal) {\n\t\t\tsignals.push(this.config.signal);\n\t\t}\n\n\t\tif (signals.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (signals.length === 1) {\n\t\t\treturn signals[0];\n\t\t}\n\n\t\t// For multiple signals, create a combined controller\n\t\tconst combined = new AbortController();\n\n\t\tfor (const signal of signals) {\n\t\t\tif (signal.aborted) {\n\t\t\t\tcombined.abort();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tsignal.addEventListener(\"abort\", () => combined.abort(), { once: true });\n\t\t}\n\n\t\treturn combined.signal;\n\t}\n\n\t/**\n\t * Handle abort errors consistently\n\t */\n\tprivate handleAbortError(error: unknown): void {\n\t\tif (error instanceof Error && error.name === \"AbortError\") {\n\t\t\tthis.state = \"cancelled\";\n\t\t\tthrow new Error(\"Authentication cancelled\");\n\t\t}\n\t}\n}\n\n/**\n * Create a device auth client with default configuration\n */\nexport function createDeviceAuthClient(\n\tbaseUrl: string,\n\tclientId: string,\n\toptions?: Partial<DeviceAuthClientConfig>,\n): DeviceAuthClient {\n\treturn new DeviceAuthClient({\n\t\tbaseUrl,\n\t\tclientId,\n\t\t...options,\n\t});\n}\n","import QuickLRU from \"quick-lru\";\n\nexport interface CacheConfig {\n\tenabled: boolean;\n\tttl: Record<string, number>;\n\tmaxSize?: number;\n}\n\n/**\n * Generic LRU cache with TTL support\n * @template T - The type of values stored in the cache\n */\nexport class LRUCache<T = unknown> {\n\tprivate cache: QuickLRU<string, { value: T; expiry: number }>;\n\tprivate config: CacheConfig;\n\n\tconstructor(config: CacheConfig) {\n\t\tthis.config = {\n\t\t\tmaxSize: 1000,\n\t\t\t...config,\n\t\t};\n\n\t\tthis.cache = new QuickLRU({\n\t\t\tmaxSize: this.config.maxSize || 1000,\n\t\t});\n\t}\n\n\t/**\n\t * Get a value from the cache\n\t * @returns The cached value or null if not found/expired\n\t */\n\tget(key: string): T | null {\n\t\tif (!this.config.enabled) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst item = this.cache.get(key);\n\t\tif (!item) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check if item has expired (atomic check)\n\t\tconst now = Date.now();\n\t\tif (now > item.expiry) {\n\t\t\tthis.cache.delete(key);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn item.value;\n\t}\n\n\t/**\n\t * Set a value in the cache\n\t * @param key - Cache key\n\t * @param value - Value to cache\n\t * @param ttlSeconds - Time to live in seconds (default: 300)\n\t */\n\tset(key: string, value: T, ttlSeconds = 300): void {\n\t\tif (!this.config.enabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst expiry = Date.now() + ttlSeconds * 1000;\n\t\tthis.cache.set(key, { value, expiry });\n\t}\n\n\t/**\n\t * Check if a key exists in the cache and is not expired\n\t */\n\thas(key: string): boolean {\n\t\tif (!this.config.enabled) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst item = this.cache.get(key);\n\t\tif (!item) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check if item has expired (atomic check)\n\t\tconst now = Date.now();\n\t\tif (now > item.expiry) {\n\t\t\tthis.cache.delete(key);\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Delete a key from the cache\n\t */\n\tdelete(key: string): boolean {\n\t\treturn this.cache.delete(key);\n\t}\n\n\t/**\n\t * Clear all items from the cache\n\t */\n\tclear(): void {\n\t\tthis.cache.clear();\n\t}\n\n\t/**\n\t * Get the number of items in the cache\n\t */\n\tsize(): number {\n\t\treturn this.cache.size;\n\t}\n}\n","import crypto from \"node:crypto\";\nimport type { FileMetadata } from \"@snapback-oss/contracts\";\n\n// Define file extensions by category at module level for better performance\nconst CODE_EXTENSIONS = [\n\t\"ts\",\n\t\"js\",\n\t\"jsx\",\n\t\"tsx\",\n\t\"py\",\n\t\"java\",\n\t\"c\",\n\t\"cpp\",\n\t\"h\",\n\t\"hpp\",\n\t\"rb\",\n\t\"go\",\n\t\"php\",\n\t\"pl\",\n\t\"rs\",\n\t\"swift\",\n\t\"kt\",\n\t\"dart\",\n\t\"scala\",\n\t\"sql\",\n];\n\nconst CONFIG_EXTENSIONS = [\n\t\"json\",\n\t\"env\",\n\t\"yml\",\n\t\"yaml\",\n\t\"xml\",\n\t\"html\",\n\t\"css\",\n\t\"scss\",\n\t\"less\",\n\t\"map\",\n\t\"lock\",\n\t\"conf\",\n\t\"ini\",\n\t\"bat\",\n\t\"ps1\",\n];\n\nconst DOCUMENT_EXTENSIONS = [\"md\", \"txt\", \"csv\", \"log\", \"pdf\", \"docx\", \"doc\", \"xlsx\", \"xls\", \"pptx\", \"ppt\"];\n\nconst IMAGE_EXTENSIONS = [\"svg\", \"png\", \"jpg\", \"jpeg\", \"gif\", \"bmp\", \"ico\", \"webp\", \"avif\"];\n\nconst MEDIA_EXTENSIONS = [\"mp4\", \"mov\", \"avi\", \"mkv\", \"mp3\", \"wav\", \"ogg\", \"flac\", \"aac\", \"m4a\", \"webm\"];\n\nconst ARCHIVE_EXTENSIONS = [\"zip\", \"tar\", \"gz\", \"tgz\", \"rar\", \"7z\"];\nconst DATABASE_EXTENSIONS = [\"db\", \"db3\", \"sqlite\", \"dbf\", \"bak\"];\nconst BINARY_EXTENSIONS = [\"wasm\"];\n\n// Combine all extensions and pre-compile regex pattern for performance\nconst ALL_EXTENSIONS = [\n\t...CODE_EXTENSIONS,\n\t...CONFIG_EXTENSIONS,\n\t...DOCUMENT_EXTENSIONS,\n\t...IMAGE_EXTENSIONS,\n\t...MEDIA_EXTENSIONS,\n\t...ARCHIVE_EXTENSIONS,\n\t...DATABASE_EXTENSIONS,\n\t...BINARY_EXTENSIONS,\n];\n\n// Pre-compiled regex pattern to avoid repeated RegExp construction\nconst FILE_EXTENSION_REGEX = new RegExp(`\\\\b\\\\w+\\\\.(${ALL_EXTENSIONS.join(\"|\")})\\\\b`, \"gi\");\n\nexport class PrivacySanitizer {\n\tconstructor(\n\t\tprivate config: {\n\t\t\thashFilePaths: boolean;\n\t\t\tanonymizeWorkspace: boolean;\n\t\t},\n\t) {}\n\n\t/**\n\t * Sanitize file metadata to ensure privacy\n\t * Removes any potentially sensitive data\n\t */\n\tsanitize(metadata: FileMetadata): FileMetadata {\n\t\t// Create defensive copy to prevent mutating original\n\t\tconst copy = structuredClone(metadata) as any;\n\n\t\t// Hash file path if enabled\n\t\tif (this.config.hashFilePaths && \"path\" in copy) {\n\t\t\tconst filePath = copy.path;\n\t\t\tconst hashedPath = this.hashFilePath(filePath);\n\t\t\tcopy.pathHash = hashedPath;\n\t\t\t// Keep path field but populate with hash to satisfy contracts\n\t\t\tcopy.path = hashedPath;\n\t\t}\n\n\t\t// Remove sensitive risk factors\n\t\tif (copy.risk?.factors) {\n\t\t\t// The new RiskScore has factors as objects, not strings\n\t\t\tcopy.risk.factors = copy.risk.factors.map((factor: any) => ({\n\t\t\t\t...factor,\n\t\t\t\ttype: this.sanitizeString(factor.type),\n\t\t\t}));\n\t\t}\n\n\t\treturn copy as FileMetadata;\n\t}\n\n\t/**\n\t * Validate that metadata contains no sensitive data\n\t */\n\tisPrivacySafe(metadata: any): boolean {\n\t\t// Blacklist of forbidden properties\n\t\tconst forbiddenProps = [\"content\", \"sourceCode\", \"fileContent\", \"code\", \"text\", \"body\", \"fullPath\"];\n\n\t\t// Check for forbidden properties\n\t\tfor (const prop of forbiddenProps) {\n\t\t\tif (prop in metadata) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// Allow path if it's hashed (matches pathHash)\n\t\tif (\"path\" in metadata && \"pathHash\" in metadata) {\n\t\t\t// If both exist, path should equal pathHash when hashing is enabled\n\t\t\tif (metadata.path !== metadata.pathHash) {\n\t\t\t\treturn false; // path is not hashed, forbidden\n\t\t\t}\n\t\t} else if (\"path\" in metadata && !(\"pathHash\" in metadata)) {\n\t\t\t// path exists without pathHash, forbidden\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check nested objects\n\t\tfor (const [_key, value] of Object.entries(metadata)) {\n\t\t\tif (typeof value === \"object\" && value !== null) {\n\t\t\t\tif (!this.isPrivacySafe(value)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Check for suspiciously large strings (potential code content)\n\t\t\tif (typeof value === \"string\" && value.length > 1000) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Hash file path with workspace salt\n\t */\n\tprivate hashFilePath(filePath: string): string {\n\t\treturn crypto.createHash(\"sha256\").update(filePath).digest(\"hex\");\n\t}\n\n\t/**\n\t * Sanitize string to remove specific identifiers\n\t */\n\tprivate sanitizeString(str: string): string {\n\t\t// Handle undefined or null strings\n\t\tif (!str) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\t// Prevent ReDoS by limiting input size\n\t\tif (str.length > 10000) {\n\t\t\tthrow new Error(\"Input too large for sanitization\");\n\t\t}\n\n\t\t// Replace specific file names with generic placeholders\n\t\t// Use safer regex patterns that don't cause backtracking\n\t\t// Use pre-compiled regex for better performance\n\t\treturn str\n\t\t\t.replace(/\"[^\"]*\"/g, '\"<redacted>\"') // Remove quoted strings (safer)\n\t\t\t.replace(FILE_EXTENSION_REGEX, \"<file>\") // Remove file names with known extensions\n\t\t\t.replace(/\\/[\\w/]+/g, \"<path>\"); // Remove paths (safer)\n\t}\n\n\t/**\n\t * Public method to sanitize individual risk factors\n\t * @param factor - Risk factor string to sanitize\n\t * @returns Sanitized risk factor string\n\t */\n\tpublic sanitizeFactor(factor: string): string {\n\t\treturn this.sanitizeString(factor);\n\t}\n}\n","import type { AnalyticsResponse, FileMetadata } from \"@snapback-oss/contracts\";\nimport { logger } from \"@snapback-oss/infrastructure\";\nimport ky from \"ky\";\nimport pRetry, { AbortError } from \"p-retry\";\nimport { z } from \"zod\";\nimport { LRUCache } from \"./cache/lru-cache\";\nimport { PrivacySanitizer } from \"./privacy/sanitizer\";\n\n// Zod schemas for validation\nconst SDKConfigSchema = z.object({\n\tendpoint: z.string().url(),\n\tapiKey: z.string().min(1, \"API key is required\"),\n\tprivacy: z.object({\n\t\thashFilePaths: z.boolean(),\n\t\tanonymizeWorkspace: z.boolean(),\n\t}),\n\tcache: z.object({\n\t\tenabled: z.boolean(),\n\t\tttl: z.record(z.string(), z.number()),\n\t}),\n\tretry: z.object({\n\t\tmaxRetries: z.number().min(0),\n\t\tbackoffMs: z.number().min(0),\n\t}),\n});\n\nconst WorkspaceIdSchema = z.string().min(1, \"Workspace ID is required\");\nconst FilesArraySchema = z.array(z.any()).min(1, \"At least one file is required\");\n\nexport type ClientSurface = \"vscode\" | \"mcp\" | \"cli\" | \"web\";\nexport interface Envelope {\n\tsession_id: string;\n\trequest_id: string;\n\tworkspace_id?: string;\n\tclient: ClientSurface;\n}\n\nexport interface SnapbackClientOptions {\n\tbaseUrl: string;\n\tapiKey?: string;\n\tsurface: ClientSurface;\n\tfetchImpl?: typeof fetch;\n\tnow?: () => number;\n\tbatchMax?: number;\n\tbatchIntervalMs?: number;\n\tretryBaseMs?: number;\n\tretryMaxMs?: number;\n}\n\nexport interface SDKConfig {\n\tendpoint: string;\n\tapiKey: string;\n\n\tprivacy: {\n\t\thashFilePaths: boolean;\n\t\tanonymizeWorkspace: boolean;\n\t};\n\n\tcache: {\n\t\tenabled: boolean;\n\t\tttl: Record<string, number>;\n\t};\n\n\tretry: {\n\t\tmaxRetries: number;\n\t\tbackoffMs: number;\n\t};\n}\n\n/**\n * Local fallback for when API is unavailable\n */\nclass LocalFallback {\n\tgenerateRecommendations(): AnalyticsResponse[\"snapshotRecommendations\"] {\n\t\t// In a real implementation, this would use local heuristics\n\t\treturn {\n\t\t\tshouldCreateSnapshot: false,\n\t\t\treason: \"Using local fallback - API unavailable\",\n\t\t\turgency: \"low\",\n\t\t\tsuggestedTiming: \"24h\",\n\t\t};\n\t}\n}\n\nexport class SnapbackClient {\n\tprivate sanitizer: PrivacySanitizer;\n\tprivate cache: LRUCache;\n\tprivate config: SDKConfig;\n\tprivate httpClient: typeof ky;\n\tprivate localFallback: LocalFallback;\n\n\tconstructor(config: SDKConfig) {\n\t\t// Validate config with zod\n\t\tthis.config = SDKConfigSchema.parse(config);\n\t\tthis.sanitizer = new PrivacySanitizer(config.privacy);\n\t\tthis.cache = new LRUCache(config.cache);\n\t\tthis.localFallback = new LocalFallback();\n\n\t\t// Initialize HTTP client with enhanced configuration\n\t\tthis.httpClient = ky.extend({\n\t\t\tprefixUrl: config.endpoint,\n\t\t\theaders: {\n\t\t\t\t\"X-API-Key\": config.apiKey,\n\t\t\t\t\"X-SnapBack-SDK\": \"1.0.0\",\n\t\t\t},\n\t\t\tretry: {\n\t\t\t\tlimit: config.retry.maxRetries,\n\t\t\t\tmethods: [\"get\", \"post\", \"put\", \"delete\", \"patch\"],\n\t\t\t\tstatusCodes: [408, 413, 429, 500, 502, 503, 504],\n\t\t\t\t// Add exponential backoff configuration\n\t\t\t\tbackoffLimit: config.retry.backoffMs * 10, // Maximum backoff time\n\t\t\t},\n\t\t\ttimeout: 30000, // 30 second timeout\n\t\t});\n\t}\n\n\t/**\n\t * Get the HTTP client instance\n\t * @returns The ky HTTP client instance\n\t */\n\tpublic getHttpClient(): typeof ky {\n\t\treturn this.httpClient;\n\t}\n\n\t/**\n\t * Parse Retry-After header and return delay in milliseconds\n\t * @param retryAfter Retry-After header value\n\t * @returns Delay in milliseconds\n\t */\n\tprivate parseRetryAfter(retryAfter: string): number {\n\t\t// Check if it's a number (seconds)\n\t\tif (/^\\d+$/.test(retryAfter)) {\n\t\t\treturn Number.parseInt(retryAfter, 10) * 1000;\n\t\t}\n\n\t\t// Check if it's a date\n\t\tconst date = new Date(retryAfter);\n\t\tif (!Number.isNaN(date.getTime())) {\n\t\t\treturn Math.max(0, date.getTime() - Date.now());\n\t\t}\n\n\t\t// Default to 1 second if parsing fails\n\t\treturn 1000;\n\t}\n\n\t/**\n\t * Enhanced HTTP request with custom retry logic including Retry-After handling\n\t */\n\tprivate async httpRequest<T>(\n\t\trequestFn: () => Promise<T>,\n\t\toptions?: {\n\t\t\tretryLimit?: number;\n\t\t\tonRetry?: (error: Error, attempt: number) => void;\n\t\t},\n\t): Promise<T> {\n\t\tconst retryLimit = options?.retryLimit ?? this.config.retry.maxRetries;\n\n\t\treturn pRetry(\n\t\t\tasync () => {\n\t\t\t\ttry {\n\t\t\t\t\treturn await requestFn();\n\t\t\t\t} catch (error: any) {\n\t\t\t\t\t// Handle 429 with Retry-After header\n\t\t\t\t\tif (error.response?.status === 429) {\n\t\t\t\t\t\tconst retryAfter = error.response.headers.get(\"Retry-After\");\n\t\t\t\t\t\tif (retryAfter) {\n\t\t\t\t\t\t\tconst delay = this.parseRetryAfter(retryAfter);\n\t\t\t\t\t\t\t// Wait for the specified delay before retrying\n\t\t\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, delay));\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Re-throw to trigger retry\n\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\n\t\t\t\t\t// For other errors, re-throw as AbortError to prevent retry\n\t\t\t\t\tif (error.response?.status && error.response.status >= 400 && error.response.status < 500) {\n\t\t\t\t\t\tthrow new AbortError(error);\n\t\t\t\t\t}\n\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tretries: retryLimit,\n\t\t\t\tfactor: 2,\n\t\t\t\tminTimeout: this.config.retry.backoffMs,\n\t\t\t\tmaxTimeout: this.config.retry.backoffMs * 2 ** retryLimit,\n\t\t\t\trandomize: true,\n\t\t\t\tonFailedAttempt: (error) => {\n\t\t\t\t\tif (options?.onRetry) {\n\t\t\t\t\t\toptions.onRetry(error, error.attemptNumber);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\t/**\n\t * Send file metadata batch to API\n\t * Automatically sanitizes metadata to ensure privacy\n\t */\n\tasync sendMetadata(workspaceId: string, files: FileMetadata[]): Promise<{ accepted: number; rejected: number }> {\n\t\t// Validate inputs with zod\n\t\tWorkspaceIdSchema.parse(workspaceId);\n\t\tFilesArraySchema.parse(files);\n\n\t\t// Privacy validation - ensures no file contents\n\t\tconst sanitized = files.map((f) => this.sanitizer.sanitize(f));\n\n\t\t// Validate all metadata is privacy-safe\n\t\tfor (const file of sanitized) {\n\t\t\tif (!this.sanitizer.isPrivacySafe(file)) {\n\t\t\t\tthrow new Error(\"Privacy validation failed: file contains sensitive data\");\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await this.httpRequest(\n\t\t\t\t() =>\n\t\t\t\t\tthis.httpClient\n\t\t\t\t\t\t.post(\"v1/metadata/files/batch\", {\n\t\t\t\t\t\t\tjson: {\n\t\t\t\t\t\t\t\tworkspaceId,\n\t\t\t\t\t\t\t\tfiles: sanitized,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttimeout: 30000,\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.json<{ accepted: number; rejected: number }>(),\n\t\t\t\t{\n\t\t\t\t\tonRetry: (error, attempt) => {\n\t\t\t\t\t\tlogger.warn(`Attempt ${attempt} failed. Retrying...`, { error: error.message });\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\t// Graceful degradation - don't fail if API unavailable\n\t\t\tlogger.warn(\"API metadata upload failed, continuing with local operation\", {\n\t\t\t\terror: (error as Error).message,\n\t\t\t});\n\t\t\treturn { accepted: 0, rejected: files.length };\n\t\t}\n\t}\n\n\t/**\n\t * Get analytics for workspace\n\t * Uses cache when available\n\t */\n\tasync getAnalytics(workspaceId: string, options?: { forceRefresh?: boolean }): Promise<AnalyticsResponse> {\n\t\t// Validate inputs with zod\n\t\tWorkspaceIdSchema.parse(workspaceId);\n\n\t\tconst cacheKey = `analytics:${workspaceId}`;\n\n\t\t// Check cache first\n\t\tif (!options?.forceRefresh && this.cache.has(cacheKey)) {\n\t\t\treturn this.cache.get(cacheKey) as AnalyticsResponse;\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await this.httpRequest(\n\t\t\t\t() =>\n\t\t\t\t\tthis.httpClient\n\t\t\t\t\t\t.get(`v1/analytics/workspace/${workspaceId}`, {\n\t\t\t\t\t\t\ttimeout: 30000,\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.json<AnalyticsResponse>(),\n\t\t\t\t{\n\t\t\t\t\tonRetry: (error, attempt) => {\n\t\t\t\t\t\tlogger.warn(`Analytics API attempt ${attempt} failed. Retrying...`, { error: error.message });\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\t// Cache successful response with TTL from config\n\t\t\tconst ttl = this.config.cache.ttl.analytics || 3600;\n\t\t\tthis.cache.set(cacheKey, response, ttl);\n\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\t// Return cached data if available, even if stale\n\t\t\tif (this.cache.has(cacheKey)) {\n\t\t\t\tlogger.warn(\"API unavailable, using stale cached analytics\");\n\t\t\t\treturn this.cache.get(cacheKey) as AnalyticsResponse;\n\t\t\t}\n\n\t\t\tthrow new Error(`Failed to fetch analytics: ${(error as Error).message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Get smart recommendations\n\t */\n\tasync getRecommendations(workspaceId: string): Promise<AnalyticsResponse[\"snapshotRecommendations\"]> {\n\t\t// Validate inputs with zod\n\t\tWorkspaceIdSchema.parse(workspaceId);\n\n\t\ttry {\n\t\t\tconst response = await this.httpRequest(\n\t\t\t\t() =>\n\t\t\t\t\tthis.httpClient\n\t\t\t\t\t\t.get(\"v1/intelligence/recommendations\", {\n\t\t\t\t\t\t\tsearchParams: {\n\t\t\t\t\t\t\t\tworkspaceId,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttimeout: 30000,\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.json<AnalyticsResponse>(),\n\t\t\t\t{\n\t\t\t\t\tonRetry: (error, attempt) => {\n\t\t\t\t\t\tlogger.warn(`Recommendations API attempt ${attempt} failed. Retrying...`, {\n\t\t\t\t\t\t\terror: error.message,\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\treturn response.snapshotRecommendations;\n\t\t} catch (error) {\n\t\t\t// Fallback to local heuristics\n\t\t\tlogger.warn(\"API unavailable, using local fallback for recommendations\", {\n\t\t\t\terror: (error as Error).message,\n\t\t\t});\n\t\t\treturn this.localFallback.generateRecommendations();\n\t\t}\n\t}\n\n\t/**\n\t * Health check endpoint\n\t */\n\tasync healthCheck(): Promise<{ status: \"ok\" | \"error\"; version: string }> {\n\t\ttry {\n\t\t\tconst response = await this.httpClient.get(\"health\").json<{ status: \"ok\" | \"error\"; version: string }>();\n\t\t\treturn response;\n\t\t} catch (_error) {\n\t\t\treturn { status: \"error\", version: \"unknown\" };\n\t\t}\n\t}\n}\n\n// Export SnapbackAnalyticsClient as an alias for SnapbackClient\nexport { SnapbackClient as SnapbackAnalyticsClient };\n","import type { ProtectedFile, ProtectionLevel } from \"@snapback-oss/contracts\";\nimport type { KyInstance } from \"ky\";\nimport type QuickLRU from \"quick-lru\";\n\nexport class ProtectionClient {\n\tconstructor(\n\t\tprivate http: KyInstance,\n\t\tprivate cache: QuickLRU<string, unknown>,\n\t) {}\n\n\tasync protect(path: string, level: ProtectionLevel, reason?: string): Promise<ProtectedFile> {\n\t\tconst response = await this.http\n\t\t\t.post(\"protection\", {\n\t\t\t\tjson: { path, level, reason },\n\t\t\t})\n\t\t\t.json<ProtectedFile>();\n\n\t\t// Invalidate cache\n\t\tthis.cache.delete(`protection:${path}`);\n\t\tthis.invalidateListCache();\n\n\t\treturn response;\n\t}\n\n\tasync unprotect(path: string): Promise<void> {\n\t\tawait this.http.delete(\"protection\", {\n\t\t\tjson: { path },\n\t\t});\n\n\t\t// Invalidate cache\n\t\tthis.cache.delete(`protection:${path}`);\n\t\tthis.invalidateListCache();\n\t}\n\n\tasync get(path: string): Promise<ProtectedFile | null> {\n\t\tconst cacheKey = `protection:${path}`;\n\n\t\tconst cached = this.cache.get(cacheKey);\n\t\t// Check if cached value exists (not just truthy check)\n\t\tif (cached !== undefined) {\n\t\t\t// Use special sentinel value for cached 404s\n\t\t\treturn cached === null ? null : (cached as ProtectedFile);\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await this.http\n\t\t\t\t.get(\"protection\", {\n\t\t\t\t\tsearchParams: { path },\n\t\t\t\t})\n\t\t\t\t.json<ProtectedFile>();\n\t\t\tthis.cache.set(cacheKey, response);\n\t\t\treturn response;\n\t\t} catch (error) {\n\t\t\t// If 404, cache null to prevent repeated API calls\n\t\t\tif ((error as any).response?.status === 404) {\n\t\t\t\tthis.cache.set(cacheKey, null);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tasync list(filters?: { level?: ProtectionLevel }): Promise<ProtectedFile[]> {\n\t\tconst cacheKey = `protection:list:${JSON.stringify(filters || {})}`;\n\n\t\tconst cached = this.cache.get(cacheKey);\n\t\tif (cached) {\n\t\t\treturn cached as ProtectedFile[];\n\t\t}\n\n\t\t// Filter out undefined values for searchParams\n\t\tconst searchParams: Record<string, string> = {};\n\t\tif (filters?.level) {\n\t\t\tsearchParams.level = String(filters.level);\n\t\t}\n\n\t\tconst response = await this.http\n\t\t\t.get(\"protection/list\", {\n\t\t\t\tsearchParams: Object.keys(searchParams).length > 0 ? searchParams : undefined,\n\t\t\t})\n\t\t\t.json<ProtectedFile[]>();\n\n\t\tthis.cache.set(cacheKey, response);\n\t\treturn response;\n\t}\n\n\tasync update(path: string, level: ProtectionLevel, reason?: string): Promise<ProtectedFile> {\n\t\tconst response = await this.http\n\t\t\t.put(\"protection\", {\n\t\t\t\tjson: { path, level, reason },\n\t\t\t})\n\t\t\t.json<ProtectedFile>();\n\n\t\t// Invalidate cache\n\t\tthis.cache.delete(`protection:${path}`);\n\t\tthis.invalidateListCache();\n\n\t\treturn response;\n\t}\n\n\t/**\n\t * Invalidate all protection list caches (including filtered lists)\n\t */\n\tprivate invalidateListCache(): void {\n\t\t// Iterate through all cache keys and delete those starting with \"protection:list\"\n\t\tfor (const key of this.cache.keys()) {\n\t\t\tif (key.startsWith(\"protection:list\")) {\n\t\t\t\tthis.cache.delete(key);\n\t\t\t}\n\t\t}\n\t}\n}\n","import type { Snapshot, SnapshotFilters } from \"@snapback-oss/contracts\";\nimport type { KyInstance } from \"ky\";\nimport type QuickLRU from \"quick-lru\";\n\nexport class SnapshotClient {\n\tconstructor(\n\t\tprivate http: KyInstance,\n\t\tprivate cache: QuickLRU<string, unknown>,\n\t) {}\n\n\tasync create(data: {\n\t\tfilePath: string;\n\t\tcontent: string;\n\t\tmessage?: string;\n\t\tprotected?: boolean;\n\t}): Promise<Snapshot> {\n\t\tconst response = await this.http\n\t\t\t.post(\"snapshots\", {\n\t\t\t\tjson: {\n\t\t\t\t\tfilePath: data.filePath,\n\t\t\t\t\tcontent: data.content,\n\t\t\t\t\tmessage: data.message,\n\t\t\t\t\tprotected: data.protected,\n\t\t\t\t},\n\t\t\t})\n\t\t\t.json<Snapshot>();\n\n\t\t// Invalidate all snapshot list caches (including filtered lists)\n\t\tthis.invalidateListCache();\n\n\t\treturn response;\n\t}\n\n\tasync list(filters?: SnapshotFilters): Promise<Snapshot[]> {\n\t\tconst cacheKey = `snapshots:list:${JSON.stringify(filters || {})}`;\n\n\t\tconst cached = this.cache.get(cacheKey);\n\t\tif (cached) {\n\t\t\treturn cached as Snapshot[];\n\t\t}\n\n\t\t// Filter out undefined values for searchParams\n\t\tconst searchParams: Record<string, any> = {};\n\t\tif (filters) {\n\t\t\tObject.entries(filters).forEach(([key, value]) => {\n\t\t\t\tif (value !== undefined) {\n\t\t\t\t\tif (value instanceof Date) {\n\t\t\t\t\t\t// Serialize dates to ISO strings for portable HTTP transmission\n\t\t\t\t\t\tsearchParams[key] = value.toISOString();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tsearchParams[key] = value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tconst response = await this.http\n\t\t\t.get(\"snapshots\", {\n\t\t\t\tsearchParams: Object.keys(searchParams).length > 0 ? searchParams : undefined,\n\t\t\t})\n\t\t\t.json<Snapshot[]>();\n\n\t\tthis.cache.set(cacheKey, response);\n\t\treturn response;\n\t}\n\n\tasync get(id: string): Promise<Snapshot> {\n\t\tconst cacheKey = `snapshot:${id}`;\n\n\t\tconst cached = this.cache.get(cacheKey);\n\t\tif (cached) {\n\t\t\treturn cached as Snapshot;\n\t\t}\n\n\t\tconst response = await this.http.get(`snapshots/${id}`).json<Snapshot>();\n\t\tthis.cache.set(cacheKey, response);\n\t\treturn response;\n\t}\n\n\tasync delete(id: string): Promise<void> {\n\t\tawait this.http.delete(`snapshots/${id}`);\n\n\t\t// Invalidate cache\n\t\tthis.cache.delete(`snapshot:${id}`);\n\t\tthis.invalidateListCache();\n\t}\n\n\tasync restore(id: string): Promise<{ success: boolean; restoredFiles: string[] }> {\n\t\tconst response = await this.http\n\t\t\t.post(`snapshots/${id}/restore`)\n\t\t\t.json<{ success: boolean; restoredFiles: string[] }>();\n\t\treturn response;\n\t}\n\n\tasync update(\n\t\tid: string,\n\t\tdata: {\n\t\t\tmessage?: string;\n\t\t\tprotected?: boolean;\n\t\t},\n\t): Promise<Snapshot> {\n\t\tconst response = await this.http\n\t\t\t.put(`snapshots/${id}`, {\n\t\t\t\tjson: data,\n\t\t\t})\n\t\t\t.json<Snapshot>();\n\n\t\t// Invalidate cache\n\t\tthis.cache.delete(`snapshot:${id}`);\n\t\tthis.invalidateListCache();\n\n\t\treturn response;\n\t}\n\n\t/**\n\t * Invalidate all snapshot list caches (including filtered lists)\n\t */\n\tprivate invalidateListCache(): void {\n\t\t// Iterate through all cache keys and delete those starting with \"snapshots:list\"\n\t\tfor (const key of this.cache.keys()) {\n\t\t\tif (key.startsWith(\"snapshots:list\")) {\n\t\t\t\tthis.cache.delete(key);\n\t\t\t}\n\t\t}\n\t}\n}\n","import type { SDKConfig } from \"./types\";\n\nexport const defaultConfig: SDKConfig = {\n\tendpoint: \"https://api.snapback.dev\",\n\tapiKey: \"\",\n\n\tprivacy: {\n\t\thashFilePaths: true,\n\t\tanonymizeWorkspace: false,\n\t},\n\n\tcache: {\n\t\tenabled: true,\n\t\tttl: {\n\t\t\tanalytics: 3600, // 1 hour\n\t\t\trecommendations: 1800, // 30 minutes\n\t\t\tpatterns: 7200, // 2 hours\n\t\t},\n\t},\n\n\tretry: {\n\t\tmaxRetries: 3,\n\t\tbackoffMs: 1000,\n\t},\n};\n\nexport function createConfig(overrides: Partial<SDKConfig> = {}): SDKConfig {\n\treturn {\n\t\t...defaultConfig,\n\t\t...overrides,\n\t\tprivacy: {\n\t\t\t...defaultConfig.privacy,\n\t\t\t...overrides.privacy,\n\t\t},\n\t\tcache: {\n\t\t\t...defaultConfig.cache,\n\t\t\t...overrides.cache,\n\t\t\tttl: {\n\t\t\t\t...defaultConfig.cache.ttl,\n\t\t\t\t...overrides.cache?.ttl,\n\t\t\t},\n\t\t},\n\t\tretry: {\n\t\t\t...defaultConfig.retry,\n\t\t\t...overrides.retry,\n\t\t},\n\t};\n}\n","/**\n * ConfigDetector - Platform-agnostic configuration file detection and validation\n *\n * This module provides utilities for detecting, parsing, and validating common\n * configuration files across different platforms.\n *\n * @module ConfigDetector\n */\n\n/**\n * Interface for file system providers\n *\n * Different platforms implement this interface to provide their\n * specific method of file system operations.\n */\nexport interface IFileSystemProvider {\n\t/**\n\t * Glob for files matching patterns\n\t *\n\t * @param patterns - Array of glob patterns to match\n\t * @param cwd - Current working directory\n\t * @param options - Glob options including ignore patterns\n\t * @returns Promise that resolves to array of matched file paths\n\t */\n\tglob(patterns: string[], cwd: string, options?: { ignore?: string[] }): Promise<string[]>;\n\n\t/**\n\t * Read a file's contents\n\t *\n\t * @param filePath - Path to the file\n\t * @returns Promise that resolves to file contents as string\n\t */\n\treadFile(filePath: string): Promise<string>;\n}\n\n/**\n * Configuration file metadata\n */\nexport interface ConfigFile {\n\t/** Type of configuration file */\n\ttype: string;\n\n\t/** Full path to the file */\n\tpath: string;\n\n\t/** File name */\n\tname: string;\n}\n\n/**\n * Result of parsing a configuration file\n */\nexport interface ConfigParseResult {\n\t/** Parsed content */\n\tcontent: unknown;\n\n\t/** Whether the file was successfully parsed */\n\tvalid: boolean;\n\n\t/** Error message if parsing failed */\n\terror?: string;\n\n\t/** Extracted metadata */\n\tmetadata?: Record<string, unknown>;\n}\n\n/**\n * Result of validating a configuration file\n */\nexport interface ConfigValidationResult {\n\t/** Whether the configuration is valid */\n\tvalid: boolean;\n\n\t/** List of validation errors */\n\terrors: string[];\n\n\t/** List of validation warnings */\n\twarnings: string[];\n}\n\n/**\n * Configuration change event\n */\nexport interface ConfigChange {\n\t/** Type of change */\n\ttype: \"added\" | \"modified\" | \"deleted\";\n\n\t/** Path to the changed file */\n\tfile: string;\n\n\t/** Timestamp of the change */\n\ttimestamp: number;\n}\n\n/**\n * package.json structure\n */\ninterface PackageJson {\n\tname?: string;\n\tversion?: string;\n\tdependencies?: Record<string, string>;\n\tdevDependencies?: Record<string, string>;\n\tscripts?: Record<string, string>;\n\t[key: string]: unknown;\n}\n\n/**\n * tsconfig.json structure\n */\ninterface TsConfig {\n\tcompilerOptions?: {\n\t\ttarget?: string | number;\n\t\tmodule?: string | number;\n\t\t[key: string]: unknown;\n\t};\n\t[key: string]: unknown;\n}\n\n/**\n * Generic config content\n */\ntype ConfigContent = Record<string, unknown>;\n\n/**\n * ConfigDetector options\n */\nexport interface ConfigDetectorOptions {\n\t/** Patterns to exclude from detection */\n\texclude?: string[];\n}\n\n/**\n * ConfigDetector - Platform-agnostic configuration file detection and validation\n *\n * Detects and validates common configuration files like package.json, tsconfig.json,\n * .env files, and various build tool configurations using dependency injection\n * for file system operations.\n *\n * @example\n * ```typescript\n * // Node.js example\n * import { glob } from 'fast-glob';\n * import { readFile } from 'fs/promises';\n *\n * const fsProvider = {\n *   glob: (patterns, cwd, options) => glob(patterns, { cwd, ...options }),\n *   readFile: (path) => readFile(path, 'utf-8')\n * };\n *\n * const detector = new ConfigDetector('/workspace', fsProvider);\n * const files = await detector.detectConfigFiles();\n * ```\n */\nexport class ConfigDetector {\n\tprivate workspaceRoot: string;\n\tprivate fileSystem: IFileSystemProvider;\n\tprivate excludePatterns: string[];\n\tprivate configFiles: Map<string, ConfigFile> = new Map();\n\tprivate changeHandlers: Array<(change: ConfigChange) => void> = [];\n\n\t/**\n\t * Creates a new ConfigDetector\n\t *\n\t * @param workspaceRoot - Root directory to search for configuration files\n\t * @param fileSystem - File system provider for platform-specific operations\n\t * @param options - Configuration options\n\t */\n\tconstructor(workspaceRoot: string, fileSystem: IFileSystemProvider, options?: ConfigDetectorOptions) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.fileSystem = fileSystem;\n\t\tthis.excludePatterns = options?.exclude || [\"node_modules/**\", \".git/**\", \"dist/**\", \"build/**\"];\n\t}\n\n\t/**\n\t * Detect all configuration files in the workspace\n\t *\n\t * @returns Promise that resolves to array of detected configuration files\n\t */\n\tasync detectConfigFiles(): Promise<ConfigFile[]> {\n\t\tconst patterns = [\n\t\t\t\"package.json\",\n\t\t\t\"tsconfig.json\",\n\t\t\t\".env*\",\n\t\t\t\".eslintrc*\",\n\t\t\t\".prettierrc*\",\n\t\t\t\"jest.config.*\",\n\t\t\t\"vitest.config.*\",\n\t\t\t\"webpack.config.*\",\n\t\t\t\"next.config.*\",\n\t\t\t\"vite.config.*\",\n\t\t];\n\n\t\tconst globPatterns = patterns.map((pattern) => `**/${pattern}`);\n\n\t\ttry {\n\t\t\tconst files = await this.fileSystem.glob(globPatterns, this.workspaceRoot, {\n\t\t\t\tignore: this.excludePatterns,\n\t\t\t});\n\n\t\t\tconst configFiles: ConfigFile[] = files.map((file) => {\n\t\t\t\tconst fullPath = `${this.workspaceRoot}/${file}`;\n\t\t\t\tconst type = this.determineConfigType(file);\n\t\t\t\tconst name = file.split(\"/\").pop() || file;\n\n\t\t\t\treturn {\n\t\t\t\t\ttype,\n\t\t\t\t\tpath: fullPath,\n\t\t\t\t\tname,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\t// Update internal cache\n\t\t\tthis.configFiles.clear();\n\t\t\tfor (const config of configFiles) {\n\t\t\t\tthis.configFiles.set(config.path, config);\n\t\t\t}\n\n\t\t\treturn configFiles;\n\t\t} catch (_error) {\n\t\t\t// Log error if logger is available\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Determine configuration file type from filename\n\t *\n\t * @param fileName - The file name to analyze\n\t * @returns The configuration type\n\t */\n\tprivate determineConfigType(fileName: string): string {\n\t\tif (fileName.includes(\".env\")) {\n\t\t\treturn \"env\";\n\t\t}\n\t\tif (fileName.includes(\"package.json\")) {\n\t\t\treturn \"package.json\";\n\t\t}\n\t\tif (fileName.includes(\"tsconfig\")) {\n\t\t\treturn \"tsconfig\";\n\t\t}\n\t\tif (fileName.includes(\".eslintrc\")) {\n\t\t\treturn \"eslint\";\n\t\t}\n\t\tif (fileName.includes(\".prettierrc\")) {\n\t\t\treturn \"prettier\";\n\t\t}\n\t\tif (fileName.includes(\"jest.config\")) {\n\t\t\treturn \"jest\";\n\t\t}\n\t\tif (fileName.includes(\"vitest.config\")) {\n\t\t\treturn \"vitest\";\n\t\t}\n\t\tif (fileName.includes(\"webpack.config\")) {\n\t\t\treturn \"webpack\";\n\t\t}\n\t\tif (fileName.includes(\"next.config\")) {\n\t\t\treturn \"next\";\n\t\t}\n\t\tif (fileName.includes(\"vite.config\")) {\n\t\t\treturn \"vite\";\n\t\t}\n\t\treturn \"unknown\";\n\t}\n\n\t/**\n\t * Parse a configuration file\n\t *\n\t * @param filePath - Path to the configuration file\n\t * @returns Promise that resolves to parse result\n\t */\n\tasync parseConfigFile(filePath: string): Promise<ConfigParseResult> {\n\t\ttry {\n\t\t\tconst content = await this.fileSystem.readFile(filePath);\n\n\t\t\t// Try to parse as JSON first\n\t\t\tif (filePath.endsWith(\".json\") || filePath.includes(\"package.json\") || filePath.includes(\"tsconfig\")) {\n\t\t\t\ttry {\n\t\t\t\t\tconst parsed = JSON.parse(content);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tcontent: parsed,\n\t\t\t\t\t\tvalid: true,\n\t\t\t\t\t\tmetadata: this.extractMetadata(parsed, filePath),\n\t\t\t\t\t};\n\t\t\t\t} catch (jsonError) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tcontent: null,\n\t\t\t\t\t\tvalid: false,\n\t\t\t\t\t\terror: `Invalid JSON: ${(jsonError as Error).message}`,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// For non-JSON files, return as text\n\t\t\treturn {\n\t\t\t\tcontent,\n\t\t\t\tvalid: true,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tcontent: null,\n\t\t\t\tvalid: false,\n\t\t\t\terror: `Failed to read file: ${(error as Error).message}`,\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Extract metadata from configuration content\n\t *\n\t * @param content - Parsed configuration content\n\t * @param filePath - Path to the file (used to determine type)\n\t * @returns Extracted metadata or undefined\n\t */\n\tprivate extractMetadata(content: ConfigContent, filePath: string): Record<string, unknown> | undefined {\n\t\tif (!content || typeof content !== \"object\") {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst metadata: Record<string, unknown> = {};\n\n\t\tif (filePath.includes(\"package.json\")) {\n\t\t\tconst pkg = content as PackageJson;\n\t\t\tif (pkg.dependencies) {\n\t\t\t\tmetadata.dependencies = Object.keys(pkg.dependencies);\n\t\t\t}\n\t\t\tif (pkg.devDependencies) {\n\t\t\t\tmetadata.devDependencies = Object.keys(pkg.devDependencies);\n\t\t\t}\n\t\t\tif (pkg.scripts) {\n\t\t\t\tmetadata.scripts = Object.keys(pkg.scripts);\n\t\t\t}\n\t\t}\n\n\t\treturn Object.keys(metadata).length > 0 ? metadata : undefined;\n\t}\n\n\t/**\n\t * Validate a configuration file\n\t *\n\t * @param filePath - Path to the configuration file\n\t * @returns Promise that resolves to validation result\n\t */\n\tasync validateConfig(filePath: string): Promise<ConfigValidationResult> {\n\t\tconst result: ConfigValidationResult = {\n\t\t\tvalid: true,\n\t\t\terrors: [],\n\t\t\twarnings: [],\n\t\t};\n\n\t\ttry {\n\t\t\tconst parseResult = await this.parseConfigFile(filePath);\n\n\t\t\tif (!parseResult.valid) {\n\t\t\t\tresult.valid = false;\n\t\t\t\tresult.errors.push(parseResult.error || \"Failed to parse config file\");\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\t// Add specific validation rules based on file type\n\t\t\tif (filePath.includes(\"package.json\")) {\n\t\t\t\tthis.validatePackageJson(parseResult.content as ConfigContent, result);\n\t\t\t} else if (filePath.includes(\"tsconfig\")) {\n\t\t\t\tthis.validateTsConfig(parseResult.content as ConfigContent, result);\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\tresult.valid = false;\n\t\t\tresult.errors.push(`Validation error: ${(error as Error).message}`);\n\t\t\treturn result;\n\t\t}\n\t}\n\n\t/**\n\t * Validate package.json content\n\t *\n\t * @param content - Parsed package.json content\n\t * @param result - Validation result to update\n\t */\n\tprivate validatePackageJson(content: ConfigContent, result: ConfigValidationResult): void {\n\t\tconst pkg = content as PackageJson;\n\n\t\tif (!pkg.name) {\n\t\t\tresult.errors.push(\"Missing required field: name\");\n\t\t\tresult.valid = false;\n\t\t}\n\n\t\tif (!pkg.version) {\n\t\t\tresult.errors.push(\"Missing required field: version\");\n\t\t\tresult.valid = false;\n\t\t}\n\t}\n\n\t/**\n\t * Validate tsconfig.json content\n\t *\n\t * @param content - Parsed tsconfig.json content\n\t * @param result - Validation result to update\n\t */\n\tprivate validateTsConfig(content: ConfigContent, result: ConfigValidationResult): void {\n\t\tconst tsconfig = content as TsConfig;\n\n\t\tif (tsconfig && typeof tsconfig === \"object\" && tsconfig.compilerOptions) {\n\t\t\t// Basic validation for tsconfig\n\t\t\tif (tsconfig.compilerOptions.target && typeof tsconfig.compilerOptions.target !== \"string\") {\n\t\t\t\tresult.warnings.push(\"compilerOptions.target should be a string\");\n\t\t\t}\n\n\t\t\tif (tsconfig.compilerOptions.module && typeof tsconfig.compilerOptions.module !== \"string\") {\n\t\t\t\tresult.warnings.push(\"compilerOptions.module should be a string\");\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Register a handler for configuration changes\n\t *\n\t * @param handler - Function to call when configuration changes\n\t */\n\tonConfigChange(handler: (change: ConfigChange) => void): void {\n\t\tthis.changeHandlers.push(handler);\n\t}\n}\n","/**\n * SnapBackRC Parser - Platform-agnostic .snapbackrc configuration parser\n *\n * This module provides utilities for parsing, validating, and merging\n * .snapbackrc configuration files across different platforms.\n *\n * @module SnapBackRCParser\n */\n\nimport type { ProtectionRule, SnapBackPolicies, SnapBackRC, SnapBackSettings } from \"./types\";\n\n/**\n * Result of parsing a configuration\n */\nexport interface ParseResult {\n\t/** Whether the configuration is valid */\n\tisValid: boolean;\n\n\t/** The parsed configuration (if valid) */\n\tconfig?: SnapBackRC;\n\n\t/** List of validation errors (if invalid) */\n\terrors?: string[];\n\n\t/** List of validation warnings */\n\twarnings?: string[];\n}\n\n/**\n * Options for merging configurations\n */\nexport interface MergeOptions {\n\t/** Provenance for base configuration */\n\tbaseProvenance?: string;\n\n\t/** Provenance for override configuration */\n\toverrideProvenance?: string;\n}\n\n/**\n * Valid protection levels\n */\nconst VALID_PROTECTION_LEVELS = [\"Watched\", \"Warning\", \"Protected\"] as const;\n\n/**\n * SnapBackRCParser - Parses and validates .snapbackrc configuration files\n *\n * Provides platform-agnostic parsing and validation of SnapBack configuration\n * files with support for merging multiple configurations and tracking provenance.\n *\n * @example\n * ```typescript\n * const parser = new SnapBackRCParser();\n * const result = parser.parse(configString);\n *\n * if (result.isValid) {\n *   console.log(\"Config is valid:\", result.config);\n * } else {\n *   console.error(\"Validation errors:\", result.errors);\n * }\n * ```\n */\nexport class SnapBackRCParser {\n\t/**\n\t * Parse a .snapbackrc configuration string\n\t *\n\t * @param content - The configuration file content as a string\n\t * @returns Parse result with validation status and errors\n\t */\n\tparse(content: string): ParseResult {\n\t\tconst errors: string[] = [];\n\t\tconst warnings: string[] = [];\n\n\t\t// Step 1: Parse JSON\n\t\tlet config: SnapBackRC;\n\t\ttry {\n\t\t\tconfig = JSON.parse(content) as SnapBackRC;\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tisValid: false,\n\t\t\t\terrors: [`Invalid JSON: ${error instanceof Error ? error.message : String(error)}`],\n\t\t\t};\n\t\t}\n\n\t\t// Step 2: Validate structure\n\t\tconst validationErrors = this.validate(config);\n\t\terrors.push(...validationErrors);\n\n\t\treturn {\n\t\t\tisValid: errors.length === 0,\n\t\t\tconfig: errors.length === 0 ? config : undefined,\n\t\t\terrors: errors.length > 0 ? errors : undefined,\n\t\t\twarnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\t}\n\n\t/**\n\t * Validate a configuration object\n\t *\n\t * @param config - The configuration to validate\n\t * @returns Array of validation error messages\n\t */\n\tprivate validate(config: SnapBackRC): string[] {\n\t\tconst errors: string[] = [];\n\n\t\t// Validate protection rules\n\t\tif (config.protection !== undefined) {\n\t\t\tif (!Array.isArray(config.protection)) {\n\t\t\t\terrors.push(\"protection must be an array\");\n\t\t\t} else {\n\t\t\t\tfor (let i = 0; i < config.protection.length; i++) {\n\t\t\t\t\tconst rule = config.protection[i];\n\t\t\t\t\tconst ruleErrors = this.validateProtectionRule(rule, i);\n\t\t\t\t\terrors.push(...ruleErrors);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Validate ignore patterns\n\t\tif (config.ignore !== undefined && !Array.isArray(config.ignore)) {\n\t\t\terrors.push(\"ignore must be an array of strings\");\n\t\t}\n\n\t\t// Validate settings\n\t\tif (config.settings !== undefined) {\n\t\t\tconst settingsErrors = this.validateSettings(config.settings);\n\t\t\terrors.push(...settingsErrors);\n\t\t}\n\n\t\t// Validate policies\n\t\tif (config.policies !== undefined) {\n\t\t\tconst policyErrors = this.validatePolicies(config.policies);\n\t\t\terrors.push(...policyErrors);\n\t\t}\n\n\t\treturn errors;\n\t}\n\n\t/**\n\t * Validate a single protection rule\n\t *\n\t * @param rule - The protection rule to validate\n\t * @param index - The index of the rule in the array\n\t * @returns Array of validation error messages\n\t */\n\tprivate validateProtectionRule(rule: ProtectionRule, index: number): string[] {\n\t\tconst errors: string[] = [];\n\t\tconst prefix = `protection[${index}]`;\n\n\t\t// Check required fields\n\t\tif (!rule.pattern) {\n\t\t\terrors.push(`${prefix}: pattern is required`);\n\t\t}\n\n\t\tif (!rule.level) {\n\t\t\terrors.push(`${prefix}: level is required`);\n\t\t} else if (!VALID_PROTECTION_LEVELS.includes(rule.level)) {\n\t\t\terrors.push(`${prefix}: level must be one of ${VALID_PROTECTION_LEVELS.join(\", \")} (got \"${rule.level}\")`);\n\t\t}\n\n\t\t// Validate optional fields\n\t\tif (rule.debounce !== undefined && (typeof rule.debounce !== \"number\" || rule.debounce < 0)) {\n\t\t\terrors.push(`${prefix}: debounce must be a non-negative number`);\n\t\t}\n\n\t\tif (rule.excludeFrom !== undefined && !Array.isArray(rule.excludeFrom)) {\n\t\t\terrors.push(`${prefix}: excludeFrom must be an array of strings`);\n\t\t}\n\n\t\tif (rule.autoSnapshot !== undefined && typeof rule.autoSnapshot !== \"boolean\") {\n\t\t\terrors.push(`${prefix}: autoSnapshot must be a boolean`);\n\t\t}\n\n\t\treturn errors;\n\t}\n\n\t/**\n\t * Validate settings\n\t *\n\t * @param settings - The settings to validate\n\t * @returns Array of validation error messages\n\t */\n\tprivate validateSettings(settings: SnapBackSettings): string[] {\n\t\tconst errors: string[] = [];\n\n\t\tif (settings.maxSnapshots !== undefined) {\n\t\t\tif (typeof settings.maxSnapshots !== \"number\" || settings.maxSnapshots < 1) {\n\t\t\t\terrors.push(\"settings.maxSnapshots must be a positive number\");\n\t\t\t}\n\t\t}\n\n\t\tif (\n\t\t\tsettings.defaultProtectionLevel !== undefined &&\n\t\t\t!VALID_PROTECTION_LEVELS.includes(settings.defaultProtectionLevel)\n\t\t) {\n\t\t\terrors.push(`settings.defaultProtectionLevel must be one of ${VALID_PROTECTION_LEVELS.join(\", \")}`);\n\t\t}\n\n\t\tif (\n\t\t\tsettings.protectionDebounce !== undefined &&\n\t\t\t(typeof settings.protectionDebounce !== \"number\" || settings.protectionDebounce < 0)\n\t\t) {\n\t\t\terrors.push(\"settings.protectionDebounce must be a non-negative number\");\n\t\t}\n\n\t\tif (\n\t\t\tsettings.maxStorageSize !== undefined &&\n\t\t\t(typeof settings.maxStorageSize !== \"number\" || settings.maxStorageSize < 0)\n\t\t) {\n\t\t\terrors.push(\"settings.maxStorageSize must be a non-negative number\");\n\t\t}\n\n\t\tif (\n\t\t\tsettings.parallelOperations !== undefined &&\n\t\t\t(typeof settings.parallelOperations !== \"number\" || settings.parallelOperations < 1)\n\t\t) {\n\t\t\terrors.push(\"settings.parallelOperations must be a positive number\");\n\t\t}\n\n\t\treturn errors;\n\t}\n\n\t/**\n\t * Validate policies\n\t *\n\t * @param policies - The policies to validate\n\t * @returns Array of validation error messages\n\t */\n\tprivate validatePolicies(policies: SnapBackPolicies): string[] {\n\t\tconst errors: string[] = [];\n\n\t\tif (\n\t\t\tpolicies.minimumProtectionLevel !== undefined &&\n\t\t\t!VALID_PROTECTION_LEVELS.includes(policies.minimumProtectionLevel)\n\t\t) {\n\t\t\terrors.push(`policies.minimumProtectionLevel must be one of ${VALID_PROTECTION_LEVELS.join(\", \")}`);\n\t\t}\n\n\t\treturn errors;\n\t}\n\n\t/**\n\t * Merge two configurations\n\t *\n\t * Combines two configurations with the override taking precedence.\n\t * Arrays are concatenated, objects are deeply merged.\n\t *\n\t * @param base - The base configuration\n\t * @param override - The override configuration\n\t * @param options - Merge options including provenance tracking\n\t * @returns Merged configuration\n\t */\n\tmerge(base: SnapBackRC, override: SnapBackRC, options?: MergeOptions): SnapBackRC {\n\t\tconst result: SnapBackRC = {};\n\n\t\t// Merge protection rules (concatenate)\n\t\tif (base.protection || override.protection) {\n\t\t\tresult.protection = [];\n\n\t\t\tif (base.protection) {\n\t\t\t\tresult.protection.push(\n\t\t\t\t\t...base.protection.map((rule) => ({\n\t\t\t\t\t\t...rule,\n\t\t\t\t\t\t_provenance: options?.baseProvenance,\n\t\t\t\t\t})),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (override.protection) {\n\t\t\t\tresult.protection.push(\n\t\t\t\t\t...override.protection.map((rule) => ({\n\t\t\t\t\t\t...rule,\n\t\t\t\t\t\t_provenance: options?.overrideProvenance,\n\t\t\t\t\t})),\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Merge ignore patterns (concatenate and deduplicate)\n\t\tif (base.ignore || override.ignore) {\n\t\t\tconst ignoreSet = new Set<string>();\n\n\t\t\tif (base.ignore) {\n\t\t\t\tfor (const pattern of base.ignore) {\n\t\t\t\t\tignoreSet.add(pattern);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (override.ignore) {\n\t\t\t\tfor (const pattern of override.ignore) {\n\t\t\t\t\tignoreSet.add(pattern);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tresult.ignore = Array.from(ignoreSet);\n\t\t}\n\n\t\t// Merge settings (deep merge, override takes precedence)\n\t\tif (base.settings || override.settings) {\n\t\t\tresult.settings = {\n\t\t\t\t...base.settings,\n\t\t\t\t...override.settings,\n\t\t\t};\n\t\t}\n\n\t\t// Merge policies (deep merge, override takes precedence)\n\t\tif (base.policies || override.policies) {\n\t\t\tresult.policies = {\n\t\t\t\t...base.policies,\n\t\t\t\t...override.policies,\n\t\t\t};\n\t\t}\n\n\t\t// Merge hooks (override takes precedence)\n\t\tif (base.hooks || override.hooks) {\n\t\t\tresult.hooks = {\n\t\t\t\t...base.hooks,\n\t\t\t\t...override.hooks,\n\t\t\t};\n\t\t}\n\n\t\t// Merge templates (concatenate)\n\t\tif (base.templates || override.templates) {\n\t\t\tresult.templates = [...(base.templates || []), ...(override.templates || [])];\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Filter configuration by pattern\n\t *\n\t * Returns a new configuration containing only protection rules\n\t * that match the given pattern.\n\t *\n\t * @param config - The configuration to filter\n\t * @param pattern - The pattern to match\n\t * @returns Filtered configuration\n\t */\n\tfilterByPattern(config: SnapBackRC, pattern: string): SnapBackRC {\n\t\tconst result: SnapBackRC = {\n\t\t\t...config,\n\t\t};\n\n\t\tif (config.protection) {\n\t\t\tresult.protection = config.protection.filter((rule) => rule.pattern === pattern);\n\t\t}\n\n\t\treturn result;\n\t}\n}\n","/**\n * AI Presence Detector - Detects presence of AI coding assistants\n *\n * This module provides platform-agnostic utilities for detecting the presence\n * of AI coding assistants like GitHub Copilot, Claude, and other popular tools.\n *\n * The detector uses dependency injection to work across different platforms:\n * - VSCode: Uses vscode.extensions API\n * - CLI: Can check process list or config files\n * - Web: Can check browser extensions or API integrations\n *\n * @module AIPresenceDetector\n */\n\nimport type { AIPresenceInfo } from \"../session/SessionTagger\";\n\n/**\n * Known AI assistant extension/tool IDs\n *\n * Maps friendly names to their platform-specific identifiers.\n * For VSCode, these are extension IDs. For other platforms, these\n * could be process names, package names, or other identifiers.\n */\nexport const AI_EXTENSION_IDS = {\n\tGITHUB_COPILOT: \"github.copilot\",\n\tGITHUB_COPILOT_CHAT: \"github.copilot-chat\",\n\tCLAUDE: \"claude.claude\",\n\tTABNINE: \"tabnine.tabnine-vscode\",\n\tCODEIUM: \"codeium.codeium\",\n\tAMAZON_Q: \"amazonwebservices.aws-toolkit-vscode\",\n\tCONTINUE: \"continue.continue\",\n\tBLACKBOX: \"blackboxapp.blackbox\",\n\tWINDSURF: \"windsurf.windsurf\",\n} as const;\n\n/**\n * Type for AI assistant names\n */\nexport type AIAssistantName = keyof typeof AI_EXTENSION_IDS;\n\n/**\n * Interface for extension/tool providers\n *\n * Different platforms implement this interface to provide their\n * specific method of listing installed extensions/tools.\n */\nexport interface IExtensionProvider {\n\t/**\n\t * Returns a list of all installed extension/tool IDs\n\t *\n\t * @returns Array of extension/tool identifiers\n\t */\n\tgetAllExtensionIds(): string[];\n}\n\n/**\n * Human-readable names for AI assistants\n */\nconst ASSISTANT_DISPLAY_NAMES: Record<AIAssistantName, string> = {\n\tGITHUB_COPILOT: \"GitHub Copilot\",\n\tGITHUB_COPILOT_CHAT: \"GitHub Copilot Chat\",\n\tCLAUDE: \"Claude\",\n\tTABNINE: \"Tabnine\",\n\tCODEIUM: \"Codeium\",\n\tAMAZON_Q: \"Amazon Q\",\n\tCONTINUE: \"Continue\",\n\tBLACKBOX: \"Blackbox\",\n\tWINDSURF: \"Windsurf\",\n};\n\n/**\n * AIPresenceDetector - Platform-agnostic AI assistant detection\n *\n * Detects the presence of AI coding assistants across different platforms\n * using dependency injection for platform-specific extension/tool listing.\n *\n * @example\n * ```typescript\n * // VSCode example\n * const vscodeProvider: IExtensionProvider = {\n *   getAllExtensionIds: () => vscode.extensions.all.map(ext => ext.id)\n * };\n * const detector = new AIPresenceDetector(vscodeProvider);\n * const presence = detector.detectAIPresence();\n * // { hasAI: true, detectedAssistants: ['GITHUB_COPILOT'], ... }\n * ```\n */\nexport class AIPresenceDetector {\n\tprivate extensionProvider: IExtensionProvider;\n\n\t/**\n\t * Creates a new AIPresenceDetector\n\t *\n\t * @param extensionProvider - Platform-specific extension provider\n\t */\n\tconstructor(extensionProvider: IExtensionProvider) {\n\t\tthis.extensionProvider = extensionProvider;\n\t}\n\n\t/**\n\t * Detects the presence of AI coding assistants\n\t *\n\t * Queries the extension provider and matches against known AI assistant\n\t * identifiers to determine which assistants are currently installed.\n\t *\n\t * @returns Information about detected AI assistants\n\t */\n\tdetectAIPresence(): AIPresenceInfo {\n\t\tconst installedExtensionIds = this.extensionProvider.getAllExtensionIds();\n\t\tconst detectedAssistants: string[] = [];\n\n\t\t// Check each known AI assistant\n\t\tfor (const [name, id] of Object.entries(AI_EXTENSION_IDS)) {\n\t\t\tif (installedExtensionIds.includes(id)) {\n\t\t\t\t// Only add if not already in the list (handles duplicates)\n\t\t\t\tif (!detectedAssistants.includes(name)) {\n\t\t\t\t\tdetectedAssistants.push(name);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\thasAI: detectedAssistants.length > 0,\n\t\t\tdetectedAssistants,\n\t\t\tassistantDetails: ASSISTANT_DISPLAY_NAMES,\n\t\t};\n\t}\n\n\t/**\n\t * Checks if a specific AI assistant is installed\n\t *\n\t * @param assistantName - Name of the AI assistant to check\n\t * @returns True if the assistant is installed\n\t */\n\tisAIAssistantInstalled(assistantName: AIAssistantName): boolean {\n\t\tconst extensionId = AI_EXTENSION_IDS[assistantName];\n\t\tconst installedExtensionIds = this.extensionProvider.getAllExtensionIds();\n\t\treturn installedExtensionIds.includes(extensionId);\n\t}\n\n\t/**\n\t * Gets a list of all installed AI assistants\n\t *\n\t * @returns Array of installed AI assistant names\n\t */\n\tgetInstalledAIAssistants(): AIAssistantName[] {\n\t\tconst installedExtensionIds = this.extensionProvider.getAllExtensionIds();\n\t\tconst installed: AIAssistantName[] = [];\n\n\t\tfor (const [name, id] of Object.entries(AI_EXTENSION_IDS)) {\n\t\t\tif (installedExtensionIds.includes(id)) {\n\t\t\t\tinstalled.push(name as AIAssistantName);\n\t\t\t}\n\t\t}\n\n\t\treturn installed;\n\t}\n}\n","/**\n * @fileoverview Burst Heuristics Detector - Detects AI-like editing bursts\n *\n * This module provides utilities for detecting rapid, large insertions that\n * might indicate AI-assisted coding sessions. It analyzes editing patterns\n * to identify characteristic AI behaviors.\n *\n * Migrated from apps/vscode to SDK for platform-wide reuse.\n */\n\nimport { THRESHOLDS } from \"../../config/Thresholds\";\n\n/**\n * Configuration for burst detection\n * Uses centralized THRESHOLDS from SDK config (Phase 15)\n */\nconst DEFAULT_BURST_CONFIG = {\n\t/** Time window in milliseconds to consider for burst detection */\n\ttimeWindow: THRESHOLDS.burst.timeWindow,\n\n\t/** Minimum number of characters inserted to qualify as burst */\n\tminCharsInserted: THRESHOLDS.burst.minCharsInserted,\n\n\t/** Maximum time between keystrokes to qualify as burst */\n\tmaxKeystrokeInterval: THRESHOLDS.burst.maxKeystrokeInterval,\n\n\t/** Minimum number of lines affected to qualify as burst */\n\tminLinesAffected: THRESHOLDS.burst.minLinesAffected,\n\n\t/** Minimum ratio of inserted to deleted chars to qualify as burst */\n\tminInsertDeleteRatio: THRESHOLDS.burst.minInsertDeleteRatio,\n};\n\n/**\n * Configuration interface for burst detection\n */\nexport interface BurstDetectorConfig {\n\t/** Time window in milliseconds to consider for burst detection */\n\ttimeWindow?: number;\n\n\t/** Minimum number of characters inserted to qualify as burst */\n\tminCharsInserted?: number;\n\n\t/** Maximum time between keystrokes to qualify as burst */\n\tmaxKeystrokeInterval?: number;\n\n\t/** Minimum number of lines affected to qualify as burst */\n\tminLinesAffected?: number;\n\n\t/** Minimum ratio of inserted to deleted chars to qualify as burst */\n\tminInsertDeleteRatio?: number;\n}\n\n/**\n * Information about a text change event\n */\ninterface TextChangeInfo {\n\t/** Timestamp of the change */\n\ttimestamp: number;\n\n\t/** Number of characters inserted */\n\tcharsInserted: number;\n\n\t/** Number of characters deleted */\n\tcharsDeleted: number;\n\n\t/** Number of lines affected */\n\tlinesAffected: number;\n\n\t/** Time since last change */\n\tinterval: number;\n}\n\n/**\n * Results of burst detection analysis\n */\nexport interface BurstDetectionResult {\n\t/** Whether a burst pattern was detected */\n\tisBurst: boolean;\n\n\t/** Confidence level (0-1) */\n\tconfidence: number;\n\n\t/** Details about the detected burst */\n\tdetails?: {\n\t\t/** Total characters inserted */\n\t\ttotalInserted: number;\n\n\t\t/** Total characters deleted */\n\t\ttotalDeleted: number;\n\n\t\t/** Insert/delete ratio */\n\t\tratio: number;\n\n\t\t/** Number of changes in burst */\n\t\tchangeCount: number;\n\n\t\t/** Duration of burst */\n\t\tduration: number;\n\t};\n}\n\n/**\n * Tracks and detects AI-like burst patterns in editing\n */\nexport class BurstHeuristicsDetector {\n\t/** Recent text changes for analysis */\n\tprivate recentChanges: TextChangeInfo[] = [];\n\n\t/** Timestamp of last change */\n\tprivate lastChangeTime = 0;\n\n\t/** Configuration for burst detection */\n\tprivate config: Required<BurstDetectorConfig>;\n\n\t/**\n\t * Creates a new BurstHeuristicsDetector\n\t *\n\t * @param config Optional configuration to override defaults\n\t */\n\tconstructor(config?: BurstDetectorConfig) {\n\t\tthis.config = {\n\t\t\ttimeWindow: config?.timeWindow ?? DEFAULT_BURST_CONFIG.timeWindow,\n\t\t\tminCharsInserted: config?.minCharsInserted ?? DEFAULT_BURST_CONFIG.minCharsInserted,\n\t\t\tmaxKeystrokeInterval: config?.maxKeystrokeInterval ?? DEFAULT_BURST_CONFIG.maxKeystrokeInterval,\n\t\t\tminLinesAffected: config?.minLinesAffected ?? DEFAULT_BURST_CONFIG.minLinesAffected,\n\t\t\tminInsertDeleteRatio: config?.minInsertDeleteRatio ?? DEFAULT_BURST_CONFIG.minInsertDeleteRatio,\n\t\t};\n\t}\n\n\t/**\n\t * Records a text change event for burst analysis\n\t *\n\t * @param charsInserted Number of characters inserted\n\t * @param charsDeleted Number of characters deleted\n\t * @param linesAffected Number of lines affected\n\t */\n\trecordChange(charsInserted: number, charsDeleted: number, linesAffected: number): void {\n\t\tconst now = Date.now();\n\t\tconst interval = this.lastChangeTime > 0 ? now - this.lastChangeTime : 0;\n\n\t\tconst changeInfo: TextChangeInfo = {\n\t\t\ttimestamp: now,\n\t\t\tcharsInserted,\n\t\t\tcharsDeleted,\n\t\t\tlinesAffected,\n\t\t\tinterval,\n\t\t};\n\n\t\tthis.recentChanges.push(changeInfo);\n\t\tthis.lastChangeTime = now;\n\n\t\t// Trim old changes outside the time window\n\t\tthis.trimOldChanges();\n\t}\n\n\t/**\n\t * Analyzes recent changes to detect burst patterns\n\t *\n\t * @returns Burst detection result\n\t */\n\tanalyzeBurst(): BurstDetectionResult {\n\t\t// Need at least 2 changes to analyze pattern\n\t\tif (this.recentChanges.length < 2) {\n\t\t\treturn { isBurst: false, confidence: 0 };\n\t\t}\n\n\t\t// Filter changes within the time window\n\t\tconst now = Date.now();\n\t\tconst windowChanges = this.recentChanges.filter((change) => now - change.timestamp <= this.config.timeWindow);\n\n\t\t// Need at least 2 changes in window\n\t\tif (windowChanges.length < 2) {\n\t\t\treturn { isBurst: false, confidence: 0 };\n\t\t}\n\n\t\t// Calculate aggregate metrics\n\t\tconst totalInserted = windowChanges.reduce((sum, change) => sum + change.charsInserted, 0);\n\n\t\tconst totalDeleted = windowChanges.reduce((sum, change) => sum + change.charsDeleted, 0);\n\n\t\tconst totalLines = windowChanges.reduce((sum, change) => sum + change.linesAffected, 0);\n\n\t\tconst duration =\n\t\t\twindowChanges.length > 1\n\t\t\t\t? windowChanges[windowChanges.length - 1].timestamp - windowChanges[0].timestamp\n\t\t\t\t: 0;\n\n\t\t// Check burst criteria\n\t\tconst meetsCharThreshold = totalInserted >= this.config.minCharsInserted;\n\t\tconst meetsLineThreshold = totalLines >= this.config.minLinesAffected;\n\n\t\tconst ratio = totalDeleted > 0 ? totalInserted / totalDeleted : totalInserted;\n\t\tconst meetsRatioThreshold = ratio >= this.config.minInsertDeleteRatio;\n\n\t\t// Calculate average interval between changes\n\t\tconst intervals = windowChanges.slice(1).map((change, i) => change.timestamp - windowChanges[i].timestamp);\n\n\t\tconst avgInterval =\n\t\t\tintervals.length > 0 ? intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length : 0;\n\n\t\tconst meetsTimingThreshold = avgInterval <= this.config.maxKeystrokeInterval;\n\n\t\t// Determine if this qualifies as a burst\n\t\tconst isBurst = meetsCharThreshold && meetsLineThreshold && meetsRatioThreshold && meetsTimingThreshold;\n\n\t\t// Calculate confidence based on how strongly criteria are met\n\t\tlet confidence = 0;\n\t\tif (isBurst) {\n\t\t\t// Base confidence on how much criteria are exceeded\n\t\t\tconst charConfidence = Math.min(1, totalInserted / (this.config.minCharsInserted * 2));\n\t\t\tconst lineConfidence = Math.min(1, totalLines / (this.config.minLinesAffected * 2));\n\t\t\tconst ratioConfidence = Math.min(1, ratio / (this.config.minInsertDeleteRatio * 2));\n\t\t\tconst timingConfidence =\n\t\t\t\tavgInterval > 0 ? Math.min(1, this.config.maxKeystrokeInterval / (avgInterval * 2)) : 1;\n\n\t\t\tconfidence = (charConfidence + lineConfidence + ratioConfidence + timingConfidence) / 4;\n\t\t}\n\n\t\treturn {\n\t\t\tisBurst,\n\t\t\tconfidence,\n\t\t\tdetails: isBurst\n\t\t\t\t? {\n\t\t\t\t\t\ttotalInserted,\n\t\t\t\t\t\ttotalDeleted,\n\t\t\t\t\t\tratio,\n\t\t\t\t\t\tchangeCount: windowChanges.length,\n\t\t\t\t\t\tduration,\n\t\t\t\t\t}\n\t\t\t\t: undefined,\n\t\t};\n\t}\n\n\t/**\n\t * Trims old changes outside the analysis time window\n\t */\n\tprivate trimOldChanges(): void {\n\t\tconst cutoffTime = Date.now() - this.config.timeWindow;\n\t\tthis.recentChanges = this.recentChanges.filter((change) => change.timestamp >= cutoffTime);\n\t}\n\n\t/**\n\t * Clears all recorded changes\n\t */\n\tclear(): void {\n\t\tthis.recentChanges = [];\n\t\tthis.lastChangeTime = 0;\n\t}\n}\n","/**\n * Cursor IDE Detection\n *\n * Detects if running in Cursor (closed-source VS Code fork with built-in AI).\n * Uses heuristic: vscode.env.appName\n *\n * Confidence: 7.0 (presence) / 8.5 (absence)\n *\n * Asymmetry rationale:\n * - appName heuristic can miss edge cases (VM, SSH, custom builds)\n * - But if vscode.env.appName does NOT include 'cursor', we're quite sure it's not Cursor\n * - \"Absence is stronger signal than presence\" for heuristic-based detection\n * - Worst case: false negative (user in Cursor, we say \"no AI\") is acceptable for v1\n *   Better than false positive (user in VS Code, we claim Cursor detected)\n */\n\nexport interface IEnvironmentProvider {\n\t/**\n\t * Returns the application name (e.g., \"Cursor\", \"Visual Studio Code\")\n\t */\n\tgetAppName(): string;\n\n\t/**\n\t * Gets an environment variable value\n\t */\n\tgetEnvVar(key: string): string | undefined;\n}\n\nexport class CursorDetector {\n\tconstructor(private readonly env: IEnvironmentProvider) {}\n\n\t/**\n\t * Detects Cursor IDE presence via appName heuristic\n\t */\n\tdetect(): { hasCursor: boolean; confidence: number } {\n\t\tconst appName = this.env.getAppName().toLowerCase();\n\n\t\tif (appName.includes(\"cursor\")) {\n\t\t\treturn { hasCursor: true, confidence: 7.0 };\n\t\t}\n\n\t\treturn { hasCursor: false, confidence: 8.5 };\n\t}\n}\n","/**\n * Platform-agnostic interfaces for SessionCoordinator dependencies\n *\n * These interfaces enable SessionCoordinator to work across multiple platforms\n * (VSCode, CLI, MCP, Web) by abstracting platform-specific implementations.\n */\n\n/**\n * Generic event emitter interface for session events\n */\nexport interface IEventEmitter<T> {\n\t/**\n\t * Fire an event with the given data\n\t * @param data - Event data to emit\n\t */\n\tfire(data: T): void;\n\n\t/**\n\t * Subscribe to events\n\t * @param listener - Function to call when event is fired\n\t * @returns Disposable to unsubscribe\n\t */\n\tsubscribe(listener: (data: T) => void): IDisposable;\n\n\t/**\n\t * Dispose the emitter and clean up resources\n\t */\n\tdispose(): void;\n}\n\n/**\n * Disposable interface for cleanup\n */\nexport interface IDisposable {\n\tdispose(): void;\n}\n\n/**\n * Timer service interface for platform-agnostic timeout/interval management\n */\nexport interface ITimerService {\n\t/**\n\t * Set a timeout\n\t * @param callback - Function to call after delay\n\t * @param ms - Delay in milliseconds\n\t * @returns Timer ID for cancellation\n\t */\n\tsetTimeout(callback: () => void, ms: number): string;\n\n\t/**\n\t * Clear a timeout\n\t * @param id - Timer ID from setTimeout\n\t */\n\tclearTimeout(id: string): void;\n\n\t/**\n\t * Set an interval\n\t * @param callback - Function to call repeatedly\n\t * @param ms - Interval in milliseconds\n\t * @returns Timer ID for cancellation\n\t */\n\tsetInterval(callback: () => void, ms: number): string;\n\n\t/**\n\t * Clear an interval\n\t * @param id - Timer ID from setInterval\n\t */\n\tclearInterval(id: string): void;\n}\n\n/**\n * Logger interface for platform-agnostic logging\n */\nexport interface ILogger {\n\tdebug(message: string, data?: unknown): void;\n\tinfo(message: string, data?: unknown): void;\n\terror(message: string, error?: Error, data?: unknown): void;\n}\n\n/**\n * Storage interface for session manifests\n */\nexport interface ISessionStorage {\n\t/**\n\t * Store a session manifest\n\t * @param manifest - Session manifest to store\n\t */\n\tstoreSessionManifest(manifest: SessionManifest): Promise<void>;\n\n\t/**\n\t * List all session manifests\n\t * @returns Array of session manifests\n\t */\n\tlistSessionManifests?(): Promise<SessionManifest[]>;\n\n\t/**\n\t * Get a session manifest by ID\n\t * @param sessionId - Session ID\n\t * @returns Session manifest or null if not found\n\t */\n\tgetSessionManifest?(sessionId: string): Promise<SessionManifest | null>;\n}\n\n/**\n * No-op logger implementation (default)\n */\nexport class NoOpLogger implements ILogger {\n\tdebug(): void {}\n\tinfo(): void {}\n\terror(): void {}\n}\n\n/**\n * Node.js-based timer service implementation\n */\nexport class NodeTimerService implements ITimerService {\n\tprivate timeouts = new Map<string, NodeJS.Timeout>();\n\tprivate intervals = new Map<string, NodeJS.Timeout>();\n\tprivate nextId = 0;\n\n\tsetTimeout(callback: () => void, ms: number): string {\n\t\tconst id = `timeout_${this.nextId++}`;\n\t\tconst timeout = globalThis.setTimeout(callback, ms);\n\t\tthis.timeouts.set(id, timeout);\n\t\treturn id;\n\t}\n\n\tclearTimeout(id: string): void {\n\t\tconst timeout = this.timeouts.get(id);\n\t\tif (timeout) {\n\t\t\tglobalThis.clearTimeout(timeout);\n\t\t\tthis.timeouts.delete(id);\n\t\t}\n\t}\n\n\tsetInterval(callback: () => void, ms: number): string {\n\t\tconst id = `interval_${this.nextId++}`;\n\t\tconst interval = globalThis.setInterval(callback, ms);\n\t\tthis.intervals.set(id, interval);\n\t\treturn id;\n\t}\n\n\tclearInterval(id: string): void {\n\t\tconst interval = this.intervals.get(id);\n\t\tif (interval) {\n\t\t\tglobalThis.clearInterval(interval);\n\t\t\tthis.intervals.delete(id);\n\t\t}\n\t}\n\n\t/**\n\t * Dispose all active timers\n\t */\n\tdispose(): void {\n\t\tfor (const timeout of this.timeouts.values()) {\n\t\t\tglobalThis.clearTimeout(timeout);\n\t\t}\n\t\tfor (const interval of this.intervals.values()) {\n\t\t\tglobalThis.clearInterval(interval);\n\t\t}\n\t\tthis.timeouts.clear();\n\t\tthis.intervals.clear();\n\t}\n}\n\n// Import SessionManifest type for storage interface\nimport type { SessionManifest } from \"./types\";\n","/**\n * Experience Classifier - Platform-agnostic user experience tier classification\n *\n * This module provides utilities for classifying users into experience tiers\n * (explorer, intermediate, power user) based on their interaction patterns.\n * This enables adaptive hints and features across all platforms.\n *\n * @module ExperienceClassifier\n */\n\nimport { THRESHOLDS } from \"../../config/Thresholds\";\nimport type { ExperienceMetrics } from \"../../types/experience\";\nimport type { ILogger } from \"./interfaces\";\nimport { NoOpLogger } from \"./interfaces\";\n\n/**\n * Experience tiers for users\n */\nexport type ExperienceTier =\n\t| \"explorer\" // New users just getting started\n\t| \"intermediate\" // Regular users with some experience\n\t| \"power\" // Advanced users who use many features\n\t| \"unknown\"; // Unable to classify\n\n/**\n * Metrics used for experience classification\n */\n\n/**\n * Key-value storage interface for persisting experience data\n */\nexport interface IKeyValueStorage {\n\t/**\n\t * Get a value from storage\n\t * @param key - Storage key\n\t * @param defaultValue - Default value if key doesn't exist\n\t * @returns Value from storage or default\n\t */\n\tget<T>(key: string, defaultValue?: T): Promise<T | undefined>;\n\n\t/**\n\t * Set a value in storage\n\t * @param key - Storage key\n\t * @param value - Value to store\n\t */\n\tset<T>(key: string, value: T): Promise<void>;\n}\n\n/**\n * Configuration for experience classification thresholds\n */\nexport interface ExperienceThresholdsConfig {\n\texplorer: ExperienceMetrics;\n\tintermediate: ExperienceMetrics;\n\tpower: ExperienceMetrics;\n}\n\n/**\n * Default thresholds for experience classification\n * Uses centralized THRESHOLDS from SDK config (Phase 15)\n */\nexport const DEFAULT_EXPERIENCE_THRESHOLDS: ExperienceThresholdsConfig = THRESHOLDS.experience;\n\n/**\n * Options for ExperienceClassifier\n */\nexport interface ExperienceClassifierOptions {\n\t/** Storage adapter for persisting experience data */\n\tstorage: IKeyValueStorage;\n\n\t/** Logger for debug/info messages (optional) */\n\tlogger?: ILogger;\n\n\t/** Custom thresholds (optional) */\n\tthresholds?: ExperienceThresholdsConfig;\n}\n\n/**\n * Experience Classifier - Classifies users into experience tiers\n *\n * Platform-agnostic implementation that works across VSCode, CLI, MCP, Web.\n */\nexport class ExperienceClassifier {\n\tprivate storage: IKeyValueStorage;\n\tprivate logger: ILogger;\n\tprivate thresholds: ExperienceThresholdsConfig;\n\n\t/**\n\t * Creates a new Experience Classifier\n\t *\n\t * @param options - Configuration options\n\t */\n\tconstructor(options: ExperienceClassifierOptions) {\n\t\tthis.storage = options.storage;\n\t\tthis.logger = options.logger || new NoOpLogger();\n\t\tthis.thresholds = options.thresholds || DEFAULT_EXPERIENCE_THRESHOLDS;\n\t}\n\n\t/**\n\t * Gets the current experience tier for the user\n\t *\n\t * @returns The user's experience tier\n\t */\n\tasync getExperienceTier(): Promise<ExperienceTier> {\n\t\t// Check if tier is manually set (for testing)\n\t\tconst manualTier = await this.storage.get<ExperienceTier>(\"experienceTier\");\n\t\tif (manualTier && manualTier !== \"unknown\") {\n\t\t\treturn manualTier;\n\t\t}\n\n\t\t// Get experience metrics\n\t\tconst metrics = await this.getExperienceMetrics();\n\n\t\t// Classify based on metrics (check highest tier first)\n\t\tif (this.meetsThreshold(metrics, \"power\")) {\n\t\t\treturn \"power\";\n\t\t}\n\t\tif (this.meetsThreshold(metrics, \"intermediate\")) {\n\t\t\treturn \"intermediate\";\n\t\t}\n\t\tif (this.meetsThreshold(metrics, \"explorer\")) {\n\t\t\treturn \"explorer\";\n\t\t}\n\n\t\treturn \"unknown\";\n\t}\n\n\t/**\n\t * Checks if metrics meet or exceed a threshold tier\n\t *\n\t * @param metrics - Experience metrics\n\t * @param tier - Tier to check against\n\t * @returns True if metrics meet or exceed the tier\n\t */\n\tprivate meetsThreshold(metrics: ExperienceMetrics, tier: keyof ExperienceThresholdsConfig): boolean {\n\t\tconst threshold = this.thresholds[tier];\n\n\t\treturn (\n\t\t\tmetrics.snapshotsCreated >= threshold.snapshotsCreated &&\n\t\t\tmetrics.sessionsRecorded >= threshold.sessionsRecorded &&\n\t\t\tmetrics.protectedFiles >= threshold.protectedFiles &&\n\t\t\tmetrics.manualRestores >= threshold.manualRestores &&\n\t\t\tmetrics.aiAssistedSessions >= threshold.aiAssistedSessions &&\n\t\t\tmetrics.daysSinceFirstUse >= threshold.daysSinceFirstUse &&\n\t\t\tmetrics.commandDiversity >= threshold.commandDiversity\n\t\t);\n\t}\n\n\t/**\n\t * Gets experience metrics for the current user\n\t *\n\t * @returns Experience metrics\n\t */\n\tasync getExperienceMetrics(): Promise<ExperienceMetrics> {\n\t\t// Get metrics from storage\n\t\tconst snapshotsCreated = await this.storage.get<number>(\"snapshotsCreated\", 0);\n\t\tconst sessionsRecorded = await this.storage.get<number>(\"sessionsRecorded\", 0);\n\t\tconst protectedFiles = await this.storage.get<number>(\"protectedFiles\", 0);\n\t\tconst manualRestores = await this.storage.get<number>(\"manualRestores\", 0);\n\t\tconst aiAssistedSessions = await this.storage.get<number>(\"aiAssistedSessions\", 0);\n\t\tconst firstUseTimestamp = await this.storage.get<number>(\"firstUseTimestamp\", Date.now());\n\t\tconst commandsUsed = await this.storage.get<Record<string, number>>(\"commandsUsed\", {});\n\n\t\t// Calculate days since first use\n\t\tconst daysSinceFirstUse = Math.floor((Date.now() - (firstUseTimestamp || Date.now())) / (1000 * 60 * 60 * 24));\n\n\t\t// Calculate command diversity (0-1)\n\t\tconst commandsUsedRecord = commandsUsed || {};\n\t\tconst totalCommands = Object.values(commandsUsedRecord).reduce((sum, count) => sum + count, 0);\n\t\tconst uniqueCommands = Object.keys(commandsUsedRecord).length;\n\t\tconst commandDiversity = totalCommands > 0 ? uniqueCommands / Math.min(totalCommands, 20) : 0;\n\n\t\treturn {\n\t\t\tsnapshotsCreated: snapshotsCreated || 0,\n\t\t\tsessionsRecorded: sessionsRecorded || 0,\n\t\t\tprotectedFiles: protectedFiles || 0,\n\t\t\tmanualRestores: manualRestores || 0,\n\t\t\taiAssistedSessions: aiAssistedSessions || 0,\n\t\t\tdaysSinceFirstUse,\n\t\t\tcommandDiversity,\n\t\t};\n\t}\n\n\t/**\n\t * Updates experience metrics based on user activity\n\t *\n\t * @param activity - Type of activity to record\n\t * @param count - Number of activities to record (default: 1)\n\t */\n\tasync updateExperienceMetrics(activity: keyof ExperienceMetrics, count = 1): Promise<void> {\n\t\tconst current = await this.storage.get<number>(activity, 0);\n\t\tawait this.storage.set(activity, (current || 0) + count);\n\n\t\t// Set first use timestamp if not already set\n\t\tconst firstUseTimestamp = await this.storage.get<number>(\"firstUseTimestamp\");\n\t\tif (!firstUseTimestamp) {\n\t\t\tawait this.storage.set(\"firstUseTimestamp\", Date.now());\n\t\t}\n\n\t\tthis.logger.debug(\"Experience metrics updated\", {\n\t\t\tactivity,\n\t\t\tcount,\n\t\t\tnewValue: (current || 0) + count,\n\t\t});\n\t}\n\n\t/**\n\t * Records command usage for diversity calculation\n\t *\n\t * @param command - Command that was used\n\t */\n\tasync recordCommandUsage(command: string): Promise<void> {\n\t\tconst commandsUsed = await this.storage.get<Record<string, number>>(\"commandsUsed\", {});\n\t\tconst commandsUsedRecord = commandsUsed || {};\n\t\tcommandsUsedRecord[command] = (commandsUsedRecord[command] || 0) + 1;\n\t\tawait this.storage.set(\"commandsUsed\", commandsUsedRecord);\n\n\t\tthis.logger.debug(\"Command usage recorded\", {\n\t\t\tcommand,\n\t\t\tcount: commandsUsedRecord[command],\n\t\t});\n\t}\n\n\t/**\n\t * Sets experience tier manually (for testing)\n\t *\n\t * @param tier - Experience tier to set\n\t */\n\tasync setExperienceTier(tier: ExperienceTier): Promise<void> {\n\t\tawait this.storage.set(\"experienceTier\", tier);\n\t\tthis.logger.info(\"Experience tier manually set\", { tier });\n\t}\n\n\t/**\n\t * Resets experience tier (for testing)\n\t */\n\tasync resetExperienceTier(): Promise<void> {\n\t\tawait this.storage.set(\"experienceTier\", undefined);\n\t\tthis.logger.info(\"Experience tier reset\");\n\t}\n\n\t/**\n\t * Gets a description of the user's experience tier\n\t *\n\t * @returns Description of the experience tier\n\t */\n\tasync getExperienceTierDescription(): Promise<string> {\n\t\tconst tier = await this.getExperienceTier();\n\n\t\tswitch (tier) {\n\t\t\tcase \"explorer\":\n\t\t\t\treturn \"Welcome to SnapBack! You're just getting started with file protection.\";\n\t\t\tcase \"intermediate\":\n\t\t\t\treturn \"You're becoming a SnapBack pro! You're using multiple protection levels effectively.\";\n\t\t\tcase \"power\":\n\t\t\t\treturn \"You're a SnapBack expert! You're using the full power of the extension.\";\n\t\t\tdefault:\n\t\t\t\treturn \"We're still learning about how you use SnapBack.\";\n\t\t}\n\t}\n}\n","/**\n * SessionCoordinator - Platform-agnostic session-aware snapshot management\n *\n * This module implements session tracking for SnapBack snapshots, enabling\n * point-in-time rollback of multiple files as a cohesive unit. It tracks\n * file changes over time and automatically groups them into sessions based\n * on activity patterns.\n *\n * Core Responsibilities:\n * - Track file changes as session candidates\n * - Detect session boundaries (idle gaps, window events, etc.)\n * - Finalize sessions and create session manifests\n * - Store session manifests in persistent storage\n *\n * Session Boundary Detection:\n * - Idle gaps (90-120s of inactivity)\n * - Window blur/focus events\n * - Task start/finish events\n * - Git commit events\n * - Maximum session duration exceeded\n *\n * @module SessionCoordinator\n */\n\nimport { randomUUID } from \"node:crypto\";\nimport { THRESHOLDS } from \"../../config/Thresholds\";\nimport type { IEventEmitter, ILogger, ISessionStorage, ITimerService } from \"./interfaces\";\nimport { NodeTimerService, NoOpLogger } from \"./interfaces\";\nimport type { SessionCandidate, SessionFinalizeReason, SessionId, SessionManifest } from \"./types\";\n\n/**\n * Configuration for session detection\n */\nexport interface SessionCoordinatorConfig {\n\t/** Idle timeout in milliseconds (default: 105 seconds) */\n\tidleTimeout?: number;\n\n\t/** Minimum session duration in milliseconds (default: 5 seconds) */\n\tminSessionDuration?: number;\n\n\t/** Maximum session duration in milliseconds (default: 1 hour) */\n\tmaxSessionDuration?: number;\n\n\t/** Interval to check for long sessions in milliseconds (default: 5 minutes) */\n\tlongSessionCheckInterval?: number;\n}\n\n/**\n * Constructor options for SessionCoordinator\n */\nexport interface SessionCoordinatorOptions {\n\t/** Storage adapter for persisting session manifests (required) */\n\tstorage: ISessionStorage;\n\n\t/** Timer service for scheduling timeouts/intervals (optional) */\n\ttimers?: ITimerService;\n\n\t/** Logger for debug/info/error messages (optional) */\n\tlogger?: ILogger;\n\n\t/** Event emitter for session finalized events (optional) */\n\teventEmitter?: IEventEmitter<SessionManifest>;\n\n\t/** Configuration overrides (optional) */\n\tconfig?: SessionCoordinatorConfig;\n}\n\n/**\n * Default configuration values\n * Uses centralized THRESHOLDS from SDK config (Phase 15)\n */\nconst DEFAULT_CONFIG: Required<SessionCoordinatorConfig> = {\n\tidleTimeout: THRESHOLDS.session.idleTimeout,\n\tminSessionDuration: THRESHOLDS.session.minSessionDuration,\n\tmaxSessionDuration: THRESHOLDS.session.maxSessionDuration,\n\tlongSessionCheckInterval: 300000, // 5 minutes (not in THRESHOLDS yet)\n};\n\n/**\n * SessionCoordinator - Coordinates session-aware snapshot creation\n *\n * This class manages the lifecycle of sessions, tracking file changes\n * and determining when to finalize sessions based on various triggers.\n */\nexport class SessionCoordinator {\n\t/** Map of active session candidates by file URI */\n\tprivate candidates = new Map<string, SessionCandidate>();\n\n\t/** Timeout ID for idle detection */\n\tprivate idleTimeoutId: string | null = null;\n\n\t/** Interval ID for long session checking */\n\tprivate longSessionIntervalId: string | null = null;\n\n\t/** Current session start time */\n\tprivate sessionStart: number = Date.now();\n\n\t/** Storage adapter */\n\tprivate storage: ISessionStorage;\n\n\t/** Timer service */\n\tprivate timers: ITimerService;\n\n\t/** Logger */\n\tprivate logger: ILogger;\n\n\t/** Event emitter (optional) */\n\tprivate eventEmitter?: IEventEmitter<SessionManifest>;\n\n\t/** Configuration */\n\tprivate config: Required<SessionCoordinatorConfig>;\n\n\t/**\n\t * Creates a new SessionCoordinator\n\t *\n\t * @param options - Configuration options\n\t */\n\tconstructor(options: SessionCoordinatorOptions) {\n\t\tthis.storage = options.storage;\n\t\tthis.timers = options.timers || new NodeTimerService();\n\t\tthis.logger = options.logger || new NoOpLogger();\n\t\tthis.eventEmitter = options.eventEmitter;\n\t\tthis.config = { ...DEFAULT_CONFIG, ...options.config };\n\n\t\tthis.sessionStart = Date.now();\n\n\t\t// Start idle detection\n\t\tthis.resetIdleTimer();\n\n\t\t// Start long session monitoring\n\t\tthis.startLongSessionMonitoring();\n\t}\n\n\t/**\n\t * Add or update a file candidate in the current session\n\t *\n\t * @param uri - URI of the file\n\t * @param snapshotId - ID of the snapshot for this file\n\t * @param stats - Optional change statistics\n\t */\n\taddCandidate(uri: string, snapshotId: string, stats?: { added: number; deleted: number }): void {\n\t\tconst candidate: SessionCandidate = {\n\t\t\turi,\n\t\t\tsnapshotId,\n\t\t\tstats,\n\t\t\tupdatedAt: Date.now(),\n\t\t};\n\n\t\tthis.candidates.set(uri, candidate);\n\t\tthis.resetIdleTimer();\n\n\t\tthis.logger.debug(\"Added session candidate\", { uri, snapshotId });\n\t}\n\n\t/**\n\t * Finalize the current session with a specific reason\n\t *\n\t * @param reason - Reason for finalizing the session\n\t * @returns Session ID if finalized, null if skipped\n\t */\n\tasync finalizeSession(reason: SessionFinalizeReason): Promise<SessionId | null> {\n\t\ttry {\n\t\t\tconst now = Date.now();\n\t\t\tconst sessionDuration = now - this.sessionStart;\n\n\t\t\t// Don't create sessions that are too short OR have no candidates\n\t\t\tif (sessionDuration < this.config.minSessionDuration || this.candidates.size === 0) {\n\t\t\t\tthis.logger.debug(\"Skipping session finalization - session too short or no candidates\", {\n\t\t\t\t\tduration: sessionDuration,\n\t\t\t\t\tcandidateCount: this.candidates.size,\n\t\t\t\t});\n\t\t\t\tthis.resetSession();\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// Create session manifest\n\t\t\tconst sessionId: SessionId = `session-${randomUUID()}`;\n\n\t\t\tconst manifest: SessionManifest = {\n\t\t\t\tid: sessionId,\n\t\t\t\tstartedAt: this.sessionStart,\n\t\t\t\tendedAt: now,\n\t\t\t\treason,\n\t\t\t\tfiles: Array.from(this.candidates.values()).map((candidate) => ({\n\t\t\t\t\turi: candidate.uri,\n\t\t\t\t\tsnapshotId: candidate.snapshotId,\n\t\t\t\t\tchangeStats: candidate.stats,\n\t\t\t\t})),\n\t\t\t\ttags: [],\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\t// Store the session manifest\n\t\t\t\tawait this.storeSessionManifest(manifest);\n\n\t\t\t\t// Emit event if emitter is available\n\t\t\t\tif (this.eventEmitter) {\n\t\t\t\t\tthis.eventEmitter.fire(manifest);\n\t\t\t\t}\n\n\t\t\t\tthis.logger.info(\"Session finalized\", {\n\t\t\t\t\tsessionId,\n\t\t\t\t\treason,\n\t\t\t\t\tfileCount: manifest.files.length,\n\t\t\t\t\tduration: sessionDuration,\n\t\t\t\t});\n\n\t\t\t\t// Reset for next session\n\t\t\t\tthis.resetSession();\n\n\t\t\t\treturn sessionId;\n\t\t\t} catch (error) {\n\t\t\t\tthis.logger.error(\n\t\t\t\t\t`Failed to finalize session: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t\t\terror instanceof Error ? error : undefined,\n\t\t\t\t\t{\n\t\t\t\t\t\tsessionId,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logger.error(\"Unexpected error in finalizeSession\", error instanceof Error ? error : undefined);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Handle window blur event - finalize session due to window focus change\n\t */\n\thandleWindowBlur(): void {\n\t\tthis.finalizeSession(\"blur\");\n\t}\n\n\t/**\n\t * Handle git commit event - finalize session due to git commit\n\t */\n\thandleGitCommit(): void {\n\t\tthis.finalizeSession(\"commit\");\n\t}\n\n\t/**\n\t * Handle task completion event - finalize session due to task completion\n\t */\n\thandleTaskCompletion(): void {\n\t\tthis.finalizeSession(\"task\");\n\t}\n\n\t/**\n\t * Handle manual session finalization\n\t */\n\thandleManualFinalization(): void {\n\t\tthis.finalizeSession(\"manual\");\n\t}\n\n\t/**\n\t * Handle idle timeout - finalize session due to inactivity\n\t */\n\tprivate handleIdleTimeout(): void {\n\t\tif (this.candidates.size > 0) {\n\t\t\tthis.finalizeSession(\"idle-break\");\n\t\t} else {\n\t\t\t// Just reset the session start time if no candidates\n\t\t\tthis.sessionStart = Date.now();\n\t\t}\n\t}\n\n\t/**\n\t * Check for long-running sessions and finalize them if needed\n\t */\n\tprivate checkLongSession(): void {\n\t\tconst now = Date.now();\n\t\tconst sessionDuration = now - this.sessionStart;\n\n\t\tif (sessionDuration > this.config.maxSessionDuration && this.candidates.size > 0) {\n\t\t\tthis.logger.info(\"Finalizing long-running session\", {\n\t\t\t\tduration: sessionDuration,\n\t\t\t\tmaxDuration: this.config.maxSessionDuration,\n\t\t\t\tcandidateCount: this.candidates.size,\n\t\t\t});\n\t\t\tthis.finalizeSession(\"max-duration\");\n\t\t}\n\t}\n\n\t/**\n\t * Reset the idle timer\n\t */\n\tprivate resetIdleTimer(): void {\n\t\tif (this.idleTimeoutId) {\n\t\t\tthis.timers.clearTimeout(this.idleTimeoutId);\n\t\t}\n\n\t\tthis.idleTimeoutId = this.timers.setTimeout(() => {\n\t\t\tthis.handleIdleTimeout();\n\t\t}, this.config.idleTimeout);\n\t}\n\n\t/**\n\t * Start monitoring for long sessions\n\t */\n\tprivate startLongSessionMonitoring(): void {\n\t\tthis.longSessionIntervalId = this.timers.setInterval(() => {\n\t\t\tthis.checkLongSession();\n\t\t}, this.config.longSessionCheckInterval);\n\t}\n\n\t/**\n\t * Reset session state for the next session\n\t */\n\tprivate resetSession(): void {\n\t\tthis.candidates.clear();\n\t\tthis.sessionStart = Date.now();\n\n\t\tif (this.idleTimeoutId) {\n\t\t\tthis.timers.clearTimeout(this.idleTimeoutId);\n\t\t}\n\t\tthis.resetIdleTimer();\n\t}\n\n\t/**\n\t * Store session manifest in persistent storage\n\t *\n\t * @param manifest - Session manifest to store\n\t */\n\tprivate async storeSessionManifest(manifest: SessionManifest): Promise<void> {\n\t\ttry {\n\t\t\tawait this.storage.storeSessionManifest(manifest);\n\t\t\tthis.logger.debug(\"Stored session manifest\", {\n\t\t\t\tsessionId: manifest.id,\n\t\t\t\tfileCount: manifest.files.length,\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tthis.logger.error(\n\t\t\t\t\"Failed to store session manifest\",\n\t\t\t\terror instanceof Error ? error : new Error(String(error)),\n\t\t\t\t{\n\t\t\t\t\tsessionId: manifest.id,\n\t\t\t\t},\n\t\t\t);\n\t\t\t// Re-throw to allow caller to handle\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Get the number of active candidates (for testing)\n\t */\n\tgetCandidateCount(): number {\n\t\treturn this.candidates.size;\n\t}\n\n\t/**\n\t * Get the session start time (for testing)\n\t */\n\tgetSessionStart(): number {\n\t\treturn this.sessionStart;\n\t}\n\n\t/**\n\t * Dispose of the session coordinator and clean up resources\n\t */\n\tdispose(): void {\n\t\tif (this.idleTimeoutId) {\n\t\t\tthis.timers.clearTimeout(this.idleTimeoutId);\n\t\t}\n\t\tif (this.longSessionIntervalId) {\n\t\t\tthis.timers.clearInterval(this.longSessionIntervalId);\n\t\t}\n\t\tif (this.eventEmitter) {\n\t\t\tthis.eventEmitter.dispose();\n\t\t}\n\t}\n}\n","/**\n * Session Summary Generator - Creates deterministic summaries for sessions\n *\n * This module provides platform-agnostic utilities for generating human-readable\n * summaries of sessions by analyzing the changes across all files in a session.\n *\n * @module SessionSummaryGenerator\n */\n\nimport * as path from \"node:path\";\nimport type { Snapshot } from \"@snapback-oss/contracts\";\nimport { createSilentLogger } from \"@snapback-oss/contracts\";\nimport type { ILogger } from \"./interfaces\";\nimport type { SessionManifest } from \"./types\";\n\n/**\n * Interface for snapshot providers\n *\n * This allows dependency injection so different platforms can provide\n * their own snapshot retrieval implementation.\n */\nexport interface ISnapshotProvider {\n\t/**\n\t * Retrieves a snapshot by ID\n\t *\n\t * @param id - Snapshot ID\n\t * @returns Promise that resolves to the snapshot or null if not found\n\t */\n\tget(id: string): Promise<Snapshot | null>;\n}\n\n/**\n * Configuration options for SessionSummaryGenerator\n */\nexport interface SessionSummaryGeneratorOptions {\n\t/** Optional snapshot provider for detailed analysis */\n\tsnapshotProvider?: ISnapshotProvider;\n\n\t/** Optional logger for debug/info messages */\n\tlogger?: ILogger;\n}\n\n/**\n * SessionSummaryGenerator - Platform-agnostic session summary generation\n *\n * Generates human-readable summaries of sessions by analyzing file changes\n * and extracting key identifiers. Supports both metadata-only and detailed\n * (content-aware) summary generation.\n *\n * @example\n * ```typescript\n * const generator = new SessionSummaryGenerator({\n *   snapshotProvider: mySnapshotProvider,\n *   logger: myLogger\n * });\n *\n * const summary = await generator.generateSummary(session);\n * // \"Modified 3 files over 120s - UserService, createUser, validateInput\"\n * ```\n */\nexport class SessionSummaryGenerator {\n\tprivate snapshotProvider?: ISnapshotProvider;\n\tprivate logger: ILogger;\n\n\t/**\n\t * Creates a new SessionSummaryGenerator\n\t *\n\t * @param options - Configuration options (optional)\n\t */\n\tconstructor(options?: SessionSummaryGeneratorOptions) {\n\t\tthis.snapshotProvider = options?.snapshotProvider;\n\t\tthis.logger = options?.logger || createSilentLogger();\n\t}\n\n\t/**\n\t * Generates a deterministic summary for a session\n\t *\n\t * Creates a human-readable summary that describes the changes in a session\n\t * without including any sensitive content or file paths.\n\t *\n\t * @param session - Session manifest to summarize\n\t * @returns Promise that resolves to a session summary\n\t */\n\tasync generateSummary(session: SessionManifest): Promise<string> {\n\t\ttry {\n\t\t\t// If we have a snapshot provider, we can do more detailed analysis\n\t\t\tif (this.snapshotProvider) {\n\t\t\t\treturn await this.generateDetailedSummary(session);\n\t\t\t}\n\n\t\t\t// Fallback to metadata-based summary\n\t\t\treturn this.generateMetadataSummary(session);\n\t\t} catch (error) {\n\t\t\tthis.logger.error(\"Failed to generate session summary\", error instanceof Error ? error : undefined, {\n\t\t\t\terror,\n\t\t\t});\n\t\t\treturn \"Session summary unavailable\";\n\t\t}\n\t}\n\n\t/**\n\t * Generates a detailed summary by analyzing actual file changes\n\t *\n\t * @param session - Session manifest to summarize\n\t * @returns Promise that resolves to a detailed session summary\n\t */\n\tprivate async generateDetailedSummary(session: SessionManifest): Promise<string> {\n\t\ttry {\n\t\t\t// Collect identifiers from all files in the session\n\t\t\tconst allIdentifiers = new Set<string>();\n\n\t\t\t// Process each file in the session\n\t\t\tfor (const fileEntry of session.files) {\n\t\t\t\ttry {\n\t\t\t\t\t// Retrieve the snapshot\n\t\t\t\t\tconst snapshot = await this.snapshotProvider?.get(fileEntry.snapshotId);\n\t\t\t\t\tif (snapshot?.fileContents) {\n\t\t\t\t\t\t// Extract identifiers from each file's content\n\t\t\t\t\t\tfor (const [filePath, content] of Object.entries(snapshot.fileContents)) {\n\t\t\t\t\t\t\tconst identifiers = await this.extractTopIdentifiers(content, filePath);\n\t\t\t\t\t\t\tfor (const identifier of identifiers) {\n\t\t\t\t\t\t\t\tallIdentifiers.add(identifier);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logger.error(`Failed to process file ${fileEntry.uri} for summary`, undefined, {\n\t\t\t\t\t\terror,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Generate summary based on collected data\n\t\t\tconst fileCount = session.files.length;\n\t\t\tconst duration = Math.round((session.endedAt - session.startedAt) / 1000);\n\n\t\t\t// Create a more descriptive summary\n\t\t\tlet summary = \"\";\n\n\t\t\tif (fileCount === 0) {\n\t\t\t\tsummary = \"Empty session\";\n\t\t\t} else if (fileCount === 1) {\n\t\t\t\tsummary = `Modified 1 file over ${duration}s`;\n\t\t\t} else {\n\t\t\t\tsummary = `Modified ${fileCount} files over ${duration}s`;\n\t\t\t}\n\n\t\t\t// Add AI assistance indicator if detected\n\t\t\tconst aiTags = session.tags?.filter(\n\t\t\t\t(tag) => tag.includes(\"ai\") || tag.includes(\"copilot\") || tag.includes(\"claude\"),\n\t\t\t);\n\t\t\tif (aiTags && aiTags.length > 0) {\n\t\t\t\tsummary = `[AI] ${summary}`;\n\t\t\t}\n\n\t\t\t// Add key identifiers if we found any\n\t\t\tif (allIdentifiers.size > 0) {\n\t\t\t\tconst topIdentifiers = Array.from(allIdentifiers).slice(0, 3);\n\t\t\t\tsummary += ` - ${topIdentifiers.join(\", \")}`;\n\t\t\t}\n\n\t\t\treturn summary;\n\t\t} catch (error) {\n\t\t\tthis.logger.error(\n\t\t\t\t\"Failed to generate detailed session summary\",\n\t\t\t\terror instanceof Error ? error : undefined,\n\t\t\t\t{ error },\n\t\t\t);\n\t\t\treturn this.generateMetadataSummary(session);\n\t\t}\n\t}\n\n\t/**\n\t * Generates a summary based on session metadata only\n\t *\n\t * @param session - Session manifest to summarize\n\t * @returns Session summary based on metadata\n\t */\n\tprivate generateMetadataSummary(session: SessionManifest): string {\n\t\tconst fileCount = session.files.length;\n\t\tconst duration = Math.round((session.endedAt - session.startedAt) / 1000);\n\n\t\t// Create a simple summary based on session metadata\n\t\tif (fileCount === 0) {\n\t\t\treturn \"Empty session\";\n\t\t}\n\n\t\t// Add AI assistance indicator if detected\n\t\tconst aiTags = session.tags?.filter(\n\t\t\t(tag) => tag.includes(\"ai\") || tag.includes(\"copilot\") || tag.includes(\"claude\"),\n\t\t);\n\t\tconst aiPrefix = aiTags && aiTags.length > 0 ? \"[AI] \" : \"\";\n\n\t\tif (fileCount === 1) {\n\t\t\treturn `${aiPrefix}Modified 1 file over ${duration}s`;\n\t\t}\n\n\t\treturn `${aiPrefix}Modified ${fileCount} files over ${duration}s`;\n\t}\n\n\t/**\n\t * Extracts top identifiers from file content for use in summaries\n\t *\n\t * Uses regex-based extraction to identify the most important identifiers\n\t * (functions, classes, variables) in the file content.\n\t *\n\t * @param content - File content to analyze\n\t * @param filePath - Path to the file (used to determine language)\n\t * @returns Promise that resolves to array of top identifiers\n\t */\n\tasync extractTopIdentifiers(content: string, filePath: string): Promise<string[]> {\n\t\ttry {\n\t\t\t// Determine file type\n\t\t\tconst extension = path.extname(filePath).toLowerCase();\n\n\t\t\tif (extension === \".ts\" || extension === \".js\" || extension === \".tsx\" || extension === \".jsx\") {\n\t\t\t\t// Use regex extraction for TypeScript/JavaScript files\n\t\t\t\treturn this.extractIdentifiersWithRegex(content);\n\t\t\t}\n\t\t\t// For non-TS/JS files, use regex fallback\n\t\t\treturn this.extractIdentifiersWithRegex(content);\n\t\t} catch (error) {\n\t\t\tthis.logger.error(`Failed to extract identifiers from ${filePath}`, undefined, {\n\t\t\t\terror,\n\t\t\t});\n\t\t\t// Fallback to simple regex extraction\n\t\t\treturn this.extractIdentifiersWithRegex(content);\n\t\t}\n\t}\n\n\t/**\n\t * Extracts identifiers using regex patterns\n\t *\n\t * @param content - File content\n\t * @returns Array of identifiers\n\t */\n\tprivate extractIdentifiersWithRegex(content: string): string[] {\n\t\t// Extract function names, class names, and variable names\n\t\tconst patterns = [\n\t\t\t/function\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g, // function declarations\n\t\t\t/const\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g, // const declarations\n\t\t\t/let\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g, // let declarations\n\t\t\t/var\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g, // var declarations\n\t\t\t/class\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g, // class declarations\n\t\t\t/interface\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g, // interface declarations\n\t\t\t/async\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\\s*\\(/g, // async method declarations\n\t\t\t/([a-zA-Z_$][a-zA-Z0-9_$]*)\\s*\\([^)]*\\)\\s*\\{/g, // method/function declarations\n\t\t];\n\n\t\tconst identifiers = new Set<string>();\n\n\t\tfor (const pattern of patterns) {\n\t\t\tlet match = pattern.exec(content);\n\t\t\twhile (match !== null) {\n\t\t\t\t// Only include identifiers that are reasonably long and not common keywords\n\t\t\t\tconst identifier = match[1];\n\t\t\t\tif (identifier.length > 2 && !this.isCommonKeyword(identifier)) {\n\t\t\t\t\tidentifiers.add(identifier);\n\t\t\t\t}\n\t\t\t\tmatch = pattern.exec(content);\n\t\t\t}\n\t\t}\n\n\t\t// Return top 5 identifiers\n\t\treturn Array.from(identifiers).slice(0, 5);\n\t}\n\n\t/**\n\t * Checks if an identifier is a common keyword that should be excluded\n\t *\n\t * @param identifier - Identifier to check\n\t * @returns True if it's a common keyword\n\t */\n\tisCommonKeyword(identifier: string): boolean {\n\t\tconst commonKeywords = new Set([\n\t\t\t\"if\",\n\t\t\t\"else\",\n\t\t\t\"for\",\n\t\t\t\"while\",\n\t\t\t\"do\",\n\t\t\t\"switch\",\n\t\t\t\"case\",\n\t\t\t\"break\",\n\t\t\t\"continue\",\n\t\t\t\"try\",\n\t\t\t\"catch\",\n\t\t\t\"finally\",\n\t\t\t\"throw\",\n\t\t\t\"return\",\n\t\t\t\"yield\",\n\t\t\t\"await\",\n\t\t\t\"async\",\n\t\t\t\"function\",\n\t\t\t\"const\",\n\t\t\t\"let\",\n\t\t\t\"var\",\n\t\t\t\"class\",\n\t\t\t\"interface\",\n\t\t\t\"type\",\n\t\t\t\"enum\",\n\t\t\t\"import\",\n\t\t\t\"export\",\n\t\t\t\"from\",\n\t\t\t\"as\",\n\t\t\t\"default\",\n\t\t\t\"extends\",\n\t\t\t\"implements\",\n\t\t\t\"static\",\n\t\t\t\"public\",\n\t\t\t\"private\",\n\t\t\t\"protected\",\n\t\t\t\"readonly\",\n\t\t\t\"abstract\",\n\t\t\t\"get\",\n\t\t\t\"set\",\n\t\t\t\"constructor\",\n\t\t\t\"super\",\n\t\t\t\"this\",\n\t\t\t\"new\",\n\t\t\t\"delete\",\n\t\t\t\"typeof\",\n\t\t\t\"instanceof\",\n\t\t\t\"in\",\n\t\t\t\"of\",\n\t\t\t\"void\",\n\t\t\t\"null\",\n\t\t\t\"undefined\",\n\t\t\t\"true\",\n\t\t\t\"false\",\n\t\t\t\"boolean\",\n\t\t\t\"number\",\n\t\t\t\"string\",\n\t\t\t\"object\",\n\t\t\t\"symbol\",\n\t\t\t\"bigint\",\n\t\t\t\"any\",\n\t\t\t\"unknown\",\n\t\t\t\"never\",\n\t\t\t\"void\",\n\t\t\t\"undefined\",\n\t\t\t\"null\",\n\t\t\t\"Promise\",\n\t\t\t\"Array\",\n\t\t\t\"String\",\n\t\t\t\"Number\",\n\t\t\t\"Boolean\",\n\t\t\t\"Object\",\n\t\t\t\"Function\",\n\t\t\t\"RegExp\",\n\t\t\t\"Date\",\n\t\t\t\"Error\",\n\t\t\t\"Map\",\n\t\t\t\"Set\",\n\t\t\t\"WeakMap\",\n\t\t\t\"WeakSet\",\n\t\t\t\"Proxy\",\n\t\t\t\"Reflect\",\n\t\t]);\n\n\t\treturn commonKeywords.has(identifier);\n\t}\n}\n","/**\n * @fileoverview Session Tagger - Tags sessions based on AI presence and burst patterns\n *\n * This module provides utilities for automatically tagging sessions based on\n * detected AI assistants and burst patterns. This enables features like\n * automatic checkpointing for AI-assisted coding sessions.\n *\n * Migrated from apps/vscode to SDK for platform-wide reuse.\n */\n\nimport { THRESHOLDS } from \"../../config/Thresholds\";\nimport type { BurstDetectionResult } from \"../detection/BurstHeuristicsDetector\";\nimport type { SessionManifest } from \"./types\";\n\n/**\n * Configuration for session tagging\n */\nexport interface SessionTaggerConfig {\n\t/** Minimum burst confidence to tag as AI-assisted */\n\tminBurstConfidence?: number;\n\n\t/** Minimum session duration to tag as long-session (ms) */\n\tminLongSessionDuration?: number;\n\n\t/** Maximum session duration to tag as short-session (ms) */\n\tmaxShortSessionDuration?: number;\n\n\t/** Minimum lines added to tag as large-edits */\n\tminLargeEditLines?: number;\n\n\t/** Normalization constants for confidence calculations */\n\tnormalization?: {\n\t\t/** File count threshold for multi-file tag */\n\t\tmultiFileThreshold?: number;\n\n\t\t/** File count for normalizing multi-file confidence */\n\t\tmultiFileNormalization?: number;\n\n\t\t/** Duration for normalizing long-session confidence (ms) */\n\t\tlongSessionNormalization?: number;\n\n\t\t/** Line count for normalizing large-edits confidence */\n\t\tlargeEditsNormalization?: number;\n\t};\n}\n\n/**\n * Default configuration for session tagging (uses centralized thresholds)\n */\nconst DEFAULT_CONFIG: Required<SessionTaggerConfig> = {\n\tminBurstConfidence: THRESHOLDS.tagging.minBurstConfidence,\n\tminLongSessionDuration: THRESHOLDS.tagging.minLongSessionDuration,\n\tmaxShortSessionDuration: THRESHOLDS.tagging.maxShortSessionDuration,\n\tminLargeEditLines: THRESHOLDS.tagging.minLargeEditLines,\n\tnormalization: {\n\t\tmultiFileThreshold: THRESHOLDS.tagging.normalization.multiFileThreshold,\n\t\tmultiFileNormalization: THRESHOLDS.tagging.normalization.multiFileNormalization,\n\t\tlongSessionNormalization: THRESHOLDS.tagging.normalization.longSessionNormalization,\n\t\tlargeEditsNormalization: THRESHOLDS.tagging.normalization.largeEditsNormalization,\n\t},\n};\n\n/**\n * Tags that can be applied to sessions\n */\nexport type SessionTag =\n\t| \"ai-assisted\" // Session involved AI assistance\n\t| \"copilot-like\" // Session shows patterns similar to GitHub Copilot\n\t| \"claude-like\" // Session shows patterns similar to Claude\n\t| \"tabnine-like\" // Session shows patterns similar to Tabnine\n\t| \"codeium-like\" // Session shows patterns similar to Codeium\n\t| \"burst\" // Session contained rapid, large insertions\n\t| \"large-edits\" // Session involved significant changes\n\t| \"multi-file\" // Session involved multiple files\n\t| \"long-session\" // Session lasted longer than typical\n\t| \"short-session\" // Session was unusually short\n\t| \"git-commit\" // Session ended with a git commit\n\t| \"manual\" // Session was manually finalized\n\t| \"idle-break\" // Session ended due to inactivity\n\t| string; // Allow custom tags\n\n/**\n * Results of session tagging analysis\n */\nexport interface SessionTaggingResult {\n\t/** Tags to apply to the session */\n\ttags: SessionTag[];\n\n\t/** Confidence level for each tag (0-1) */\n\tconfidence: Record<string, number>;\n\n\t/** Reasons for each tag */\n\treasons: Record<string, string>;\n}\n\n/**\n * Information about AI presence\n */\nexport interface AIPresenceInfo {\n\t/** Whether AI assistants are present */\n\thasAI: boolean;\n\n\t/** List of detected AI assistant identifiers */\n\tdetectedAssistants: string[];\n\n\t/** Human-readable names for detected assistants */\n\tassistantDetails: Record<string, string>;\n}\n\n/**\n * Session tagger initialization options\n */\nexport interface SessionTaggerOptions {\n\t/** Optional AI presence detector function */\n\taiPresenceDetector?: () => AIPresenceInfo;\n\n\t/** Optional configuration overrides */\n\tconfig?: SessionTaggerConfig;\n}\n\n/**\n * Tracks and tags sessions based on AI presence and burst patterns\n */\nexport class SessionTagger {\n\tprivate aiPresenceDetector?: () => AIPresenceInfo;\n\tprivate config: Required<SessionTaggerConfig>;\n\n\t/**\n\t * Creates a new SessionTagger\n\t *\n\t * @param options Optional configuration and dependencies\n\t */\n\tconstructor(options?: SessionTaggerOptions) {\n\t\tthis.aiPresenceDetector = options?.aiPresenceDetector;\n\t\tthis.config = {\n\t\t\t...DEFAULT_CONFIG,\n\t\t\t...options?.config,\n\t\t\tnormalization: {\n\t\t\t\t...DEFAULT_CONFIG.normalization,\n\t\t\t\t...options?.config?.normalization,\n\t\t\t},\n\t\t};\n\t}\n\n\t/**\n\t * Analyzes a session and generates appropriate tags\n\t *\n\t * @param manifest Session manifest to analyze\n\t * @param burstResult Optional burst detection result\n\t * @returns Session tagging result with tags and confidence levels\n\t */\n\ttagSession(manifest: SessionManifest, burstResult?: BurstDetectionResult): SessionTaggingResult {\n\t\tconst tags: SessionTag[] = [...(manifest.tags || [])];\n\t\tconst confidence: Record<string, number> = {};\n\t\tconst reasons: Record<string, string> = {};\n\n\t\t// Tag based on finalization reason\n\t\tthis.addReasonTags(manifest.reason, tags, confidence, reasons);\n\n\t\t// Tag based on file count\n\t\tconst multiFileThreshold = this.config.normalization?.multiFileThreshold;\n\t\tif (multiFileThreshold && manifest.files.length > multiFileThreshold) {\n\t\t\ttags.push(\"multi-file\");\n\t\t\tconfidence[\"multi-file\"] = Math.min(\n\t\t\t\t1.0,\n\t\t\t\tmanifest.files.length / (this.config.normalization?.multiFileNormalization || 1),\n\t\t\t);\n\t\t\treasons[\"multi-file\"] = `Session involved ${manifest.files.length} files`;\n\t\t}\n\n\t\t// Tag based on session duration\n\t\tconst duration = manifest.endedAt - manifest.startedAt;\n\t\tif (duration > this.config.minLongSessionDuration) {\n\t\t\ttags.push(\"long-session\");\n\t\t\tconfidence[\"long-session\"] = Math.min(\n\t\t\t\t1.0,\n\t\t\t\tduration / (this.config.normalization?.longSessionNormalization || 1),\n\t\t\t);\n\t\t\treasons[\"long-session\"] = `Session lasted ${Math.round(duration / 60000)} minutes`;\n\t\t} else if (duration < this.config.maxShortSessionDuration) {\n\t\t\ttags.push(\"short-session\");\n\t\t\tconfidence[\"short-session\"] = Math.min(1.0, this.config.maxShortSessionDuration / duration);\n\t\t\treasons[\"short-session\"] = `Session lasted ${Math.round(duration / 1000)} seconds`;\n\t\t}\n\n\t\t// Tag based on change statistics\n\t\tconst totalAdded = manifest.files.reduce((sum, file) => {\n\t\t\treturn sum + (file.changeStats?.added || 0);\n\t\t}, 0);\n\n\t\tif (totalAdded > this.config.minLargeEditLines) {\n\t\t\ttags.push(\"large-edits\");\n\t\t\tconfidence[\"large-edits\"] = Math.min(\n\t\t\t\t1.0,\n\t\t\t\ttotalAdded / (this.config.normalization?.largeEditsNormalization || 1),\n\t\t\t);\n\t\t\treasons[\"large-edits\"] = `Session involved ${totalAdded} lines added`;\n\t\t}\n\n\t\t// Tag based on AI presence (if detector provided)\n\t\tif (this.aiPresenceDetector) {\n\t\t\tconst aiPresence = this.aiPresenceDetector();\n\t\t\tif (aiPresence.hasAI) {\n\t\t\t\ttags.push(\"ai-assisted\");\n\t\t\t\tconfidence[\"ai-assisted\"] = 0.9;\n\t\t\t\treasons[\"ai-assisted\"] = `AI assistants detected: ${aiPresence.detectedAssistants.join(\", \")}`;\n\n\t\t\t\t// Add specific AI assistant tags\n\t\t\t\tfor (const assistant of aiPresence.detectedAssistants) {\n\t\t\t\t\t// Convert assistant name to tag format (e.g., GITHUB_COPILOT -> copilot-like)\n\t\t\t\t\tconst assistantName = assistant.toLowerCase().replace(/_/g, \"-\").replace(\"github-\", \"\");\n\t\t\t\t\tconst tag = `${assistantName}-like` as SessionTag;\n\t\t\t\t\ttags.push(tag);\n\t\t\t\t\tconfidence[tag] = 0.8;\n\t\t\t\t\treasons[tag] = `Detected ${aiPresence.assistantDetails[assistant]} presence`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Tag based on burst detection\n\t\tif (burstResult?.isBurst) {\n\t\t\ttags.push(\"burst\");\n\t\t\tconfidence.burst = burstResult.confidence;\n\t\t\treasons.burst = \"Session contained rapid, large insertions characteristic of AI assistance\";\n\t\t}\n\n\t\t// Remove duplicate tags\n\t\tconst uniqueTags = Array.from(new Set(tags));\n\n\t\treturn {\n\t\t\ttags: uniqueTags,\n\t\t\tconfidence,\n\t\t\treasons,\n\t\t};\n\t}\n\n\t/**\n\t * Updates a session manifest with appropriate tags\n\t *\n\t * @param manifest Session manifest to update\n\t * @param burstResult Optional burst detection result\n\t * @returns Updated session manifest with tags\n\t */\n\tupdateSessionWithTags(manifest: SessionManifest, burstResult?: BurstDetectionResult): SessionManifest {\n\t\tconst taggingResult = this.tagSession(manifest, burstResult);\n\n\t\treturn {\n\t\t\t...manifest,\n\t\t\ttags: taggingResult.tags,\n\t\t};\n\t}\n\n\t/**\n\t * Adds tags based on session finalization reason\n\t */\n\tprivate addReasonTags(\n\t\treason: string,\n\t\ttags: SessionTag[],\n\t\tconfidence: Record<string, number>,\n\t\treasons: Record<string, string>,\n\t): void {\n\t\tswitch (reason) {\n\t\t\tcase \"manual\":\n\t\t\t\ttags.push(\"manual\");\n\t\t\t\tconfidence.manual = 1.0;\n\t\t\t\treasons.manual = \"Session was manually finalized\";\n\t\t\t\tbreak;\n\t\t\tcase \"idle-break\":\n\t\t\t\ttags.push(\"manual\");\n\t\t\t\tconfidence.manual = 0.8;\n\t\t\t\treasons.manual = \"Session ended due to idle timeout\";\n\t\t\t\tbreak;\n\t\t\tcase \"blur\":\n\t\t\t\ttags.push(\"manual\");\n\t\t\t\tconfidence.manual = 0.8;\n\t\t\t\treasons.manual = \"Session ended when window lost focus\";\n\t\t\t\tbreak;\n\t\t\tcase \"task\":\n\t\t\t\ttags.push(\"manual\");\n\t\t\t\tconfidence.manual = 0.9;\n\t\t\t\treasons.manual = \"Session ended due to task boundary\";\n\t\t\t\tbreak;\n\t\t\tcase \"commit\":\n\t\t\t\ttags.push(\"manual\");\n\t\t\t\tconfidence.manual = 0.95;\n\t\t\t\treasons.manual = \"Session ended with git commit\";\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\n","import { createCipheriv, createDecipheriv, createHash, randomBytes } from \"node:crypto\";\n\nexport interface EncryptedData {\n\tciphertext: string;\n\tiv: string;\n\tauthTag: string;\n\talgorithm: \"aes-256-gcm\";\n}\n\nexport interface EncryptedBlob {\n\tversion: number;\n\tsalt: number[]; // Uint8Array as JSON-serializable array\n\tiv: number[];\n\tciphertext: number[];\n\ttimestamp: number;\n\tchecksum: string; // SHA-256 hash of plaintext for integrity verification\n}\n\n/**\n * Zero-knowledge encryption service for SnapBack snapshots.\n * Uses AES-256-GCM + PBKDF2 key derivation.\n * Server never sees plaintext - all encryption happens client-side.\n */\nexport class EncryptionService {\n\tprivate readonly PBKDF2_ITERATIONS = 100000;\n\tprivate readonly KEY_LENGTH = 256;\n\tprivate readonly ALGORITHM = \"aes-256-gcm\";\n\tprivate readonly IV_LENGTH = 12; // 96 bits for GCM\n\n\t/**\n\t * Derive encryption key from user secret using PBKDF2\n\t */\n\tprivate async deriveKey(userSecret: string, salt: Uint8Array): Promise<CryptoKey> {\n\t\t// Import user secret as key material\n\t\tconst keyMaterial = await crypto.subtle.importKey(\n\t\t\t\"raw\",\n\t\t\tnew TextEncoder().encode(userSecret),\n\t\t\t{ name: \"PBKDF2\" },\n\t\t\tfalse,\n\t\t\t[\"deriveKey\"],\n\t\t);\n\n\t\t// Derive AES-GCM key\n\t\treturn crypto.subtle.deriveKey(\n\t\t\t{\n\t\t\t\tname: \"PBKDF2\",\n\t\t\t\tsalt: salt as unknown as ArrayBuffer, // Type assertion chain for ArrayBuffer compatibility\n\t\t\t\titerations: this.PBKDF2_ITERATIONS,\n\t\t\t\thash: \"SHA-256\",\n\t\t\t},\n\t\t\tkeyMaterial,\n\t\t\t{ name: this.ALGORITHM, length: this.KEY_LENGTH },\n\t\t\tfalse,\n\t\t\t[\"encrypt\", \"decrypt\"],\n\t\t);\n\t}\n\n\t/**\n\t * Generate SHA-256 checksum of data for integrity verification\n\t */\n\tprivate async generateChecksum(data: string): Promise<string> {\n\t\tconst buffer = new TextEncoder().encode(data);\n\t\tconst hashBuffer = await crypto.subtle.digest(\"SHA-256\", buffer);\n\t\tconst hashArray = Array.from(new Uint8Array(hashBuffer));\n\t\treturn hashArray.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n\t}\n\n\t/**\n\t * Encrypt a snapshot with user secret\n\t * @param snapshot - Snapshot object to encrypt\n\t * @param userSecret - User's encryption secret (from auth session or user input)\n\t * @returns Encrypted blob ready for upload\n\t */\n\tasync encryptSnapshot<T = any>(snapshot: T, userSecret: string): Promise<EncryptedBlob> {\n\t\t// Generate random salt and IV\n\t\tconst salt = crypto.getRandomValues(new Uint8Array(16));\n\t\tconst iv = crypto.getRandomValues(new Uint8Array(12));\n\n\t\t// Derive encryption key\n\t\tconst key = await this.deriveKey(userSecret, salt);\n\n\t\t// Serialize snapshot\n\t\tconst plaintext = JSON.stringify(snapshot);\n\n\t\t// Generate checksum\n\t\tconst checksum = await this.generateChecksum(plaintext);\n\n\t\t// Encrypt\n\t\tconst plaintextBuffer = new TextEncoder().encode(plaintext);\n\t\tconst ciphertextBuffer = await crypto.subtle.encrypt({ name: this.ALGORITHM, iv }, key, plaintextBuffer);\n\n\t\t// Return as JSON-serializable blob\n\t\treturn {\n\t\t\tversion: 1,\n\t\t\tsalt: Array.from(salt),\n\t\t\tiv: Array.from(iv),\n\t\t\tciphertext: Array.from(new Uint8Array(ciphertextBuffer)),\n\t\t\ttimestamp: Date.now(),\n\t\t\tchecksum,\n\t\t};\n\t}\n\n\t/**\n\t * Decrypt an encrypted blob\n\t * @param blob - Encrypted blob from cloud\n\t * @param userSecret - User's encryption secret\n\t * @returns Original snapshot object\n\t * @throws Error if decryption fails or checksum mismatch\n\t */\n\tasync decryptSnapshot<T = any>(blob: EncryptedBlob, userSecret: string): Promise<T> {\n\t\t// Reconstruct typed arrays\n\t\tconst salt = new Uint8Array(blob.salt);\n\t\tconst iv = new Uint8Array(blob.iv);\n\t\tconst ciphertext = new Uint8Array(blob.ciphertext);\n\n\t\t// Derive decryption key\n\t\tconst key = await this.deriveKey(userSecret, salt);\n\n\t\t// Decrypt\n\t\tlet plaintextBuffer: ArrayBuffer;\n\t\ttry {\n\t\t\tplaintextBuffer = await crypto.subtle.decrypt({ name: this.ALGORITHM, iv }, key, ciphertext);\n\t\t} catch (_error) {\n\t\t\tthrow new Error(\"Decryption failed. Wrong password or corrupted data.\");\n\t\t}\n\n\t\t// Decode plaintext\n\t\tconst plaintext = new TextDecoder().decode(plaintextBuffer);\n\n\t\t// Verify checksum\n\t\tconst checksum = await this.generateChecksum(plaintext);\n\t\tif (checksum !== blob.checksum) {\n\t\t\tthrow new Error(\"Checksum mismatch. Data may be corrupted.\");\n\t\t}\n\n\t\t// Parse and return\n\t\treturn JSON.parse(plaintext) as T;\n\t}\n\n\t/**\n\t * Verify if a user secret can decrypt a blob without full decryption\n\t * (Faster than full decrypt for password verification)\n\t */\n\tasync verifySecret(blob: EncryptedBlob, userSecret: string): Promise<boolean> {\n\t\ttry {\n\t\t\tawait this.decryptSnapshot(blob, userSecret);\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Encrypt plaintext data using AES-256-GCM (legacy method for backward compatibility)\n\t *\n\t * @param plaintext Data to encrypt\n\t * @returns Encrypted data with IV and authentication tag\n\t */\n\tencrypt(plaintext: string): EncryptedData {\n\t\t// This is a simplified version that uses a fixed key for demonstration\n\t\t// In practice, you would derive a key from a user secret\n\t\tconst key = Buffer.from(\"0123456789abcdef0123456789abcdef\", \"hex\"); // 256-bit key\n\t\tconst iv = randomBytes(this.IV_LENGTH);\n\n\t\tconst cipher = createCipheriv(this.ALGORITHM, key, iv);\n\t\tconst encrypted = Buffer.concat([cipher.update(plaintext, \"utf8\"), cipher.final()]);\n\n\t\tconst authTag = cipher.getAuthTag();\n\n\t\treturn {\n\t\t\tciphertext: encrypted.toString(\"base64\"),\n\t\t\tiv: iv.toString(\"base64\"),\n\t\t\tauthTag: authTag.toString(\"base64\"),\n\t\t\talgorithm: this.ALGORITHM,\n\t\t};\n\t}\n\n\t/**\n\t * Decrypt encrypted data using AES-256-GCM (legacy method for backward compatibility)\n\t *\n\t * @param encrypted Encrypted data with IV and auth tag\n\t * @returns Decrypted plaintext\n\t */\n\tdecrypt(encrypted: EncryptedData): string {\n\t\tif (encrypted.algorithm !== this.ALGORITHM) {\n\t\t\tthrow new Error(`Unsupported algorithm: ${encrypted.algorithm}`);\n\t\t}\n\n\t\t// This is a simplified version that uses a fixed key for demonstration\n\t\t// In practice, you would derive a key from a user secret\n\t\tconst key = Buffer.from(\"0123456789abcdef0123456789abcdef\", \"hex\"); // 256-bit key\n\t\tconst decipher = createDecipheriv(this.ALGORITHM, key, Buffer.from(encrypted.iv, \"base64\"));\n\n\t\tdecipher.setAuthTag(Buffer.from(encrypted.authTag, \"base64\"));\n\n\t\tconst decrypted = Buffer.concat([\n\t\t\tdecipher.update(Buffer.from(encrypted.ciphertext, \"base64\")),\n\t\t\tdecipher.final(),\n\t\t]);\n\n\t\treturn decrypted.toString(\"utf8\");\n\t}\n\n\t/**\n\t * Compute content hash for deduplication (post-encryption)\n\t *\n\t * @param content Original plaintext content\n\t * @returns SHA-256 hash for deduplication\n\t */\n\tcomputeContentHash(content: string): string {\n\t\treturn createHash(\"sha256\").update(content).digest(\"hex\");\n\t}\n}\n","/**\n * SnapBack Error Hierarchy\n *\n * Provides structured, type-safe error classes for the entire SnapBack platform.\n * Each error includes a code, message, optional context, and optional cause for chaining.\n *\n * @module errors\n */\n\n// =============================================================================\n// BASE ERROR CLASS\n// =============================================================================\n\n/**\n * Base error class for all SnapBack errors\n *\n * @example\n * ```typescript\n * throw new SnapBackError('Operation failed', 'OPERATION_FAILED', { userId: '123' });\n * ```\n */\nexport class SnapBackError extends Error {\n\tpublic readonly timestamp: number;\n\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly code: string,\n\t\tpublic readonly context?: Record<string, unknown>,\n\t\tpublic readonly cause?: Error,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = this.constructor.name;\n\t\tthis.timestamp = Date.now();\n\n\t\t// Maintain stack trace in V8 engines (Node.js)\n\t\tif (Error.captureStackTrace) {\n\t\t\tError.captureStackTrace(this, this.constructor);\n\t\t}\n\t}\n\n\t/**\n\t * Serialize error to JSON for logging/API responses\n\t */\n\ttoJSON(): Record<string, unknown> {\n\t\treturn {\n\t\t\tname: this.name,\n\t\t\tmessage: this.message,\n\t\t\tcode: this.code,\n\t\t\tcontext: this.context,\n\t\t\ttimestamp: this.timestamp,\n\t\t\tstack: this.stack,\n\t\t\tcause: this.cause\n\t\t\t\t? {\n\t\t\t\t\t\tname: this.cause.name,\n\t\t\t\t\t\tmessage: this.cause.message,\n\t\t\t\t\t\tstack: this.cause.stack,\n\t\t\t\t\t}\n\t\t\t\t: undefined,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// SNAPSHOT ERRORS\n// =============================================================================\n\n/**\n * Base class for snapshot-related errors\n */\nexport class SnapshotError extends SnapBackError {}\n\n/**\n * Snapshot not found in storage\n */\nexport class SnapshotNotFoundError extends SnapshotError {\n\tconstructor(\n\t\tpublic readonly snapshotId: string,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(`Snapshot not found: ${snapshotId}`, \"SNAPSHOT_NOT_FOUND\", { snapshotId }, cause);\n\t}\n}\n\n/**\n * Snapshot creation failed\n */\nexport class SnapshotCreationError extends SnapshotError {\n\tconstructor(message: string, context?: Record<string, unknown>, cause?: Error) {\n\t\tsuper(message, \"SNAPSHOT_CREATION_ERROR\", context, cause);\n\t}\n}\n\n/**\n * Duplicate snapshot detected (deduplication)\n */\nexport class SnapshotDuplicateError extends SnapshotError {\n\tconstructor(\n\t\tpublic readonly existingId?: string,\n\t\tcontext?: Record<string, unknown>,\n\t) {\n\t\tsuper(\n\t\t\texistingId ? `Duplicate snapshot detected (existing: ${existingId})` : \"Duplicate snapshot detected\",\n\t\t\t\"SNAPSHOT_DUPLICATE\",\n\t\t\t{ existingId, ...context },\n\t\t);\n\t}\n}\n\n/**\n * Snapshot is protected and cannot be modified/deleted\n */\nexport class SnapshotProtectedError extends SnapshotError {\n\tconstructor(public readonly snapshotId: string) {\n\t\tsuper(`Cannot modify protected snapshot: ${snapshotId}`, \"SNAPSHOT_PROTECTED\", { snapshotId });\n\t}\n}\n\n/**\n * Snapshot restore failed\n */\nexport class SnapshotRestoreError extends SnapshotError {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly snapshotId: string,\n\t\tcontext?: Record<string, unknown>,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(message, \"SNAPSHOT_RESTORE_ERROR\", { snapshotId, ...context }, cause);\n\t}\n}\n\n/**\n * Snapshot version incompatible\n */\nexport class SnapshotVersionError extends SnapshotError {\n\tconstructor(\n\t\tpublic readonly version: string,\n\t\tpublic readonly supportedVersions: string[],\n\t) {\n\t\tsuper(\n\t\t\t`Incompatible snapshot version: ${version}. Supported: ${supportedVersions.join(\", \")}`,\n\t\t\t\"SNAPSHOT_VERSION_INCOMPATIBLE\",\n\t\t\t{ version, supportedVersions },\n\t\t);\n\t}\n}\n\n/**\n * Snapshot verification failed (checksum mismatch)\n */\nexport class SnapshotVerificationError extends SnapshotError {\n\tconstructor(\n\t\tpublic readonly filePath: string,\n\t\tpublic readonly expected: string,\n\t\tpublic readonly actual: string,\n\t) {\n\t\tsuper(`Verification failed for ${filePath}: checksum mismatch`, \"SNAPSHOT_VERIFICATION_FAILED\", {\n\t\t\tfilePath,\n\t\t\texpected,\n\t\t\tactual,\n\t\t});\n\t}\n}\n\n// =============================================================================\n// STORAGE ERRORS\n// =============================================================================\n\n/**\n * Base class for storage-related errors\n */\nexport class StorageError extends SnapBackError {}\n\n/**\n * Storage is full\n */\nexport class StorageFullError extends StorageError {\n\tconstructor(\n\t\tpublic readonly required: number,\n\t\tpublic readonly available: number,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(\n\t\t\t`Storage full: ${required}MB required, ${available}MB available`,\n\t\t\t\"STORAGE_FULL\",\n\t\t\t{ required, available, retryable: false },\n\t\t\tcause,\n\t\t);\n\t}\n}\n\n/**\n * Storage resource is locked\n */\nexport class StorageLockError extends StorageError {\n\tconstructor(\n\t\tpublic readonly resource: string,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(`Resource locked: ${resource}`, \"STORAGE_LOCK\", { resource, retryable: true }, cause);\n\t}\n}\n\n/**\n * Storage IO error\n */\nexport class StorageIOError extends StorageError {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly path?: string,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(message, \"STORAGE_IO_ERROR\", { path }, cause);\n\t}\n}\n\n// =============================================================================\n// VALIDATION ERRORS\n// =============================================================================\n\n/**\n * Base class for validation errors\n */\nexport class ValidationError extends SnapBackError {\n\tconstructor(message: string, code = \"VALIDATION_ERROR\", context?: Record<string, unknown>, cause?: Error) {\n\t\tsuper(message, code, context, cause);\n\t}\n}\n\n/**\n * Input validation failed\n */\nexport class InputValidationError extends ValidationError {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly field: string,\n\t\tpublic readonly value?: unknown,\n\t) {\n\t\tsuper(message, \"INPUT_VALIDATION_ERROR\", { field, value });\n\t}\n}\n\n/**\n * Path security validation failed\n */\nexport class PathValidationError extends ValidationError {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic readonly path: string,\n\t) {\n\t\tsuper(message, \"PATH_VALIDATION_ERROR\", { path });\n\t}\n}\n\n/**\n * Missing required content\n */\nexport class MissingContentError extends ValidationError {\n\tconstructor(public readonly filePath: string) {\n\t\tsuper(`Missing content for file: ${filePath}`, \"MISSING_CONTENT\", { filePath });\n\t}\n}\n\n// =============================================================================\n// API ERRORS\n// =============================================================================\n\n/**\n * Base class for API errors\n */\nexport class ApiError extends SnapBackError {\n\tconstructor(\n\t\tmessage: string,\n\t\tcode: string,\n\t\tpublic readonly status?: number,\n\t\tcontext?: Record<string, unknown>,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(message, code, { status, ...context }, cause);\n\t}\n}\n\n/**\n * API rate limit exceeded\n */\nexport class RateLimitError extends ApiError {\n\tconstructor(\n\t\tpublic readonly retryAfter: number,\n\t\tcause?: Error,\n\t) {\n\t\tsuper(\n\t\t\t`Rate limit exceeded. Retry after ${retryAfter}ms`,\n\t\t\t\"RATE_LIMIT_EXCEEDED\",\n\t\t\t429,\n\t\t\t{ retryAfter, retryable: true },\n\t\t\tcause,\n\t\t);\n\t}\n}\n\n/**\n * API authentication failed\n */\nexport class AuthenticationError extends ApiError {\n\tconstructor(message = \"Authentication required\", cause?: Error) {\n\t\tsuper(message, \"AUTHENTICATION_REQUIRED\", 401, undefined, cause);\n\t}\n}\n\n/**\n * API authorization failed\n */\nexport class AuthorizationError extends ApiError {\n\tconstructor(message = \"Access denied\", cause?: Error) {\n\t\tsuper(message, \"ACCESS_DENIED\", 403, undefined, cause);\n\t}\n}\n\n// =============================================================================\n// TYPE GUARDS\n// =============================================================================\n\n/**\n * Check if error is a SnapBackError\n */\nexport function isSnapBackError(error: unknown): error is SnapBackError {\n\treturn error instanceof SnapBackError;\n}\n\n/**\n * Check if error is a SnapshotError\n */\nexport function isSnapshotError(error: unknown): error is SnapshotError {\n\treturn error instanceof SnapshotError;\n}\n\n/**\n * Check if error is a StorageError\n */\nexport function isStorageError(error: unknown): error is StorageError {\n\treturn error instanceof StorageError;\n}\n\n/**\n * Check if error is a ValidationError\n */\nexport function isValidationError(error: unknown): error is ValidationError {\n\treturn error instanceof ValidationError;\n}\n\n/**\n * Check if error is an ApiError\n */\nexport function isApiError(error: unknown): error is ApiError {\n\treturn error instanceof ApiError;\n}\n\n/**\n * Check if error is retryable\n */\nexport function isRetryableError(error: unknown): boolean {\n\tif (isSnapBackError(error)) {\n\t\treturn error.context?.retryable === true;\n\t}\n\treturn false;\n}\n\n// =============================================================================\n// ERROR CONVERSION\n// =============================================================================\n\n/**\n * Convert unknown error to Error instance\n */\nexport function toError(error: unknown): Error {\n\tif (error instanceof Error) {\n\t\treturn error;\n\t}\n\tif (typeof error === \"string\") {\n\t\treturn new Error(error);\n\t}\n\tif (typeof error === \"object\" && error !== null) {\n\t\tif (\"message\" in error && typeof error.message === \"string\") {\n\t\t\treturn new Error(error.message);\n\t\t}\n\t\ttry {\n\t\t\treturn new Error(JSON.stringify(error));\n\t\t} catch {\n\t\t\treturn new Error(String(error));\n\t\t}\n\t}\n\treturn new Error(String(error));\n}\n\n/**\n * Wrap any error in a SnapBackError\n */\nexport function ensureSnapBackError(\n\terror: unknown,\n\tcode = \"UNKNOWN_ERROR\",\n\tcontext?: Record<string, unknown>,\n): SnapBackError {\n\tif (error instanceof SnapBackError) {\n\t\treturn error;\n\t}\n\tconst baseError = toError(error);\n\treturn new SnapBackError(baseError.message, code, context, baseError);\n}\n","/**\n * Platform-agnostic error handling utilities\n *\n * Provides utilities for converting any value to an Error object,\n * ensuring consistent error handling across all SnapBack applications.\n *\n * @module errorHelpers\n */\n\n/**\n * Convert any value to an Error object\n *\n * This function ensures that any value can be safely converted to an Error instance,\n * which is useful for error handling in catch blocks where the caught value might not be an Error.\n *\n * @param error - The value to convert\n * @returns An Error object\n *\n * @example\n * ```typescript\n * try {\n *   // Some code that might throw\n * } catch (error) {\n *   const err = toError(error);\n *   console.log(err.message);\n * }\n * ```\n */\nexport function toError(error: unknown): Error {\n\t// If it's already an Error (or subclass), return as-is\n\tif (error instanceof Error) {\n\t\treturn error;\n\t}\n\n\t// Convert string to Error\n\tif (typeof error === \"string\") {\n\t\treturn new Error(error);\n\t}\n\n\t// Handle objects\n\tif (typeof error === \"object\" && error !== null) {\n\t\t// If object has a message property that's a string, use it\n\t\tif (\"message\" in error && typeof error.message === \"string\") {\n\t\t\treturn new Error(error.message);\n\t\t}\n\n\t\t// Otherwise, try to stringify the object\n\t\ttry {\n\t\t\treturn new Error(JSON.stringify(error));\n\t\t} catch (_stringifyError) {\n\t\t\t// If JSON.stringify fails (circular reference), fall back to String()\n\t\t\treturn new Error(String(error));\n\t\t}\n\t}\n\n\t// For all other types (number, boolean, null, undefined, symbol, etc.)\n\treturn new Error(String(error));\n}\n","/**\n * Result Type for Type-Safe Error Handling\n *\n * Implements the Result pattern inspired by Rust and functional programming.\n * Provides type-safe error handling without exceptions.\n *\n * @module result\n */\n\nimport { toError } from \"./errorHelpers.js\";\n\n// =============================================================================\n// RESULT TYPE DEFINITION\n// =============================================================================\n\n/**\n * Discriminated union type for success/failure outcomes\n *\n * @example\n * ```typescript\n * type MyResult = Result<User, UserNotFoundError>;\n *\n * // Success case\n * const success: MyResult = { success: true, value: user };\n *\n * // Error case\n * const failure: MyResult = { success: false, error: new UserNotFoundError() };\n * ```\n */\nexport type Result<T, E = Error> = { success: true; value: T } | { success: false; error: E };\n\n// =============================================================================\n// CONSTRUCTORS\n// =============================================================================\n\n/**\n * Create a success Result\n *\n * @param value - The success value\n * @returns Result with success=true\n *\n * @example\n * ```typescript\n * const result = ok({ id: '123', name: 'Test' });\n * // { success: true, value: { id: '123', name: 'Test' } }\n * ```\n */\nexport function ok<T>(value: T): Result<T, never> {\n\treturn { success: true, value };\n}\n\n/**\n * Create a failure Result\n *\n * @param error - The error value\n * @returns Result with success=false\n *\n * @example\n * ```typescript\n * const result = err(new NotFoundError('User not found'));\n * // { success: false, error: NotFoundError }\n * ```\n */\nexport function err<E>(error: E): Result<never, E> {\n\treturn { success: false, error };\n}\n\n// =============================================================================\n// TYPE GUARDS\n// =============================================================================\n\n/**\n * Check if Result is success\n *\n * @param result - Result to check\n * @returns True if success, narrows type to { success: true; value: T }\n *\n * @example\n * ```typescript\n * if (isOk(result)) {\n *   console.log(result.value); // TypeScript knows value exists\n * }\n * ```\n */\nexport function isOk<T, E>(result: Result<T, E>): result is { success: true; value: T } {\n\treturn result.success === true;\n}\n\n/**\n * Check if Result is failure\n *\n * @param result - Result to check\n * @returns True if failure, narrows type to { success: false; error: E }\n *\n * @example\n * ```typescript\n * if (isErr(result)) {\n *   console.error(result.error.message); // TypeScript knows error exists\n * }\n * ```\n */\nexport function isErr<T, E>(result: Result<T, E>): result is { success: false; error: E } {\n\treturn result.success === false;\n}\n\n// =============================================================================\n// TRANSFORMATIONS\n// =============================================================================\n\n/**\n * Map the success value of a Result\n *\n * @param result - Result to transform\n * @param fn - Function to apply to success value\n * @returns New Result with transformed value\n *\n * @example\n * ```typescript\n * const userResult = ok({ id: '123', name: 'Alice' });\n * const nameResult = map(userResult, u => u.name);\n * // { success: true, value: 'Alice' }\n * ```\n */\nexport function map<T, U, E>(result: Result<T, E>, fn: (value: T) => U): Result<U, E> {\n\tif (isOk(result)) {\n\t\treturn ok(fn(result.value));\n\t}\n\treturn result;\n}\n\n/**\n * Map the error value of a Result\n *\n * @param result - Result to transform\n * @param fn - Function to apply to error value\n * @returns New Result with transformed error\n *\n * @example\n * ```typescript\n * const result = err(new Error('original'));\n * const mapped = mapErr(result, e => new WrappedError(e));\n * ```\n */\nexport function mapErr<T, E, F>(result: Result<T, E>, fn: (error: E) => F): Result<T, F> {\n\tif (isErr(result)) {\n\t\treturn err(fn(result.error));\n\t}\n\treturn result;\n}\n\n/**\n * Chain Result-returning operations (flatMap/bind)\n *\n * @param result - Initial Result\n * @param fn - Function that returns a Result\n * @returns New Result from the chain\n *\n * @example\n * ```typescript\n * const result = andThen(\n *   getUser(id),\n *   user => getProfile(user.id)\n * );\n * ```\n */\nexport function andThen<T, U, E>(result: Result<T, E>, fn: (value: T) => Result<U, E>): Result<U, E> {\n\tif (isOk(result)) {\n\t\treturn fn(result.value);\n\t}\n\treturn result;\n}\n\n// =============================================================================\n// UNWRAPPING\n// =============================================================================\n\n/**\n * Get the success value or throw if error\n *\n * @param result - Result to unwrap\n * @returns The success value\n * @throws The error if Result is failure\n *\n * @example\n * ```typescript\n * const value = unwrap(result); // Throws if error\n * ```\n */\nexport function unwrap<T, E>(result: Result<T, E>): T {\n\tif (isOk(result)) {\n\t\treturn result.value;\n\t}\n\tif (result.error instanceof Error) {\n\t\tthrow result.error;\n\t}\n\tthrow new Error(String(result.error));\n}\n\n/**\n * Get the success value or return a default\n *\n * @param result - Result to unwrap\n * @param defaultValue - Value to return if error\n * @returns The success value or default\n *\n * @example\n * ```typescript\n * const name = unwrapOr(getUser(id), { name: 'Unknown' }).name;\n * ```\n */\nexport function unwrapOr<T, E>(result: Result<T, E>, defaultValue: T): T {\n\tif (isOk(result)) {\n\t\treturn result.value;\n\t}\n\treturn defaultValue;\n}\n\n/**\n * Get the success value or compute a default from the error\n *\n * @param result - Result to unwrap\n * @param fn - Function to compute default from error\n * @returns The success value or computed default\n */\nexport function unwrapOrElse<T, E>(result: Result<T, E>, fn: (error: E) => T): T {\n\tif (isOk(result)) {\n\t\treturn result.value;\n\t}\n\treturn fn(result.error);\n}\n\n// =============================================================================\n// PROMISE INTEGRATION\n// =============================================================================\n\n/**\n * Convert a Promise to a Result\n *\n * @param promise - Promise to convert\n * @returns Promise of Result\n *\n * @example\n * ```typescript\n * const result = await fromPromise(fetch('/api/users'));\n * if (isErr(result)) {\n *   console.error('Network error:', result.error.message);\n * }\n * ```\n */\nexport async function fromPromise<T>(promise: Promise<T>): Promise<Result<T, Error>> {\n\ttry {\n\t\tconst value = await promise;\n\t\treturn ok(value);\n\t} catch (error) {\n\t\treturn err(toError(error));\n\t}\n}\n\n/**\n * Convert a Promise to a Result with custom error mapper\n *\n * @param promise - Promise to convert\n * @param errorMapper - Function to map caught error\n * @returns Promise of Result\n */\nexport async function fromPromiseWith<T, E>(\n\tpromise: Promise<T>,\n\terrorMapper: (error: unknown) => E,\n): Promise<Result<T, E>> {\n\ttry {\n\t\tconst value = await promise;\n\t\treturn ok(value);\n\t} catch (error) {\n\t\treturn err(errorMapper(error));\n\t}\n}\n\n// =============================================================================\n// COMBINATORS\n// =============================================================================\n\n/**\n * Combine multiple Results into a single Result of array\n *\n * @param results - Array of Results\n * @returns Result containing array of values, or first error\n *\n * @example\n * ```typescript\n * const results = [ok(1), ok(2), ok(3)];\n * const combined = sequence(results);\n * // { success: true, value: [1, 2, 3] }\n *\n * const withError = [ok(1), err('fail'), ok(3)];\n * const failed = sequence(withError);\n * // { success: false, error: 'fail' }\n * ```\n */\nexport function sequence<T, E>(results: Result<T, E>[]): Result<T[], E> {\n\tconst values: T[] = [];\n\tfor (const result of results) {\n\t\tif (isErr(result)) {\n\t\t\treturn result;\n\t\t}\n\t\tvalues.push(result.value);\n\t}\n\treturn ok(values);\n}\n\n/**\n * Try multiple fallback operations until one succeeds\n *\n * @param operations - Array of Result-returning operations\n * @returns First success or last error\n */\nexport function tryAll<T, E>(operations: Array<() => Result<T, E>>): Result<T, E[]> {\n\tconst errors: E[] = [];\n\tfor (const op of operations) {\n\t\tconst result = op();\n\t\tif (isOk(result)) {\n\t\t\treturn result;\n\t\t}\n\t\terrors.push(result.error);\n\t}\n\treturn err(errors);\n}\n\n// =============================================================================\n// SIDE EFFECTS\n// =============================================================================\n\n/**\n * Execute side effect on success without changing the Result\n *\n * @param result - Result to tap\n * @param fn - Side effect function\n * @returns Original Result unchanged\n *\n * @example\n * ```typescript\n * const result = tap(getUserResult, user => {\n *   analytics.track('user_fetched', { id: user.id });\n * });\n * ```\n */\nexport function tap<T, E>(result: Result<T, E>, fn: (value: T) => void): Result<T, E> {\n\tif (isOk(result)) {\n\t\tfn(result.value);\n\t}\n\treturn result;\n}\n\n/**\n * Execute side effect on error without changing the Result\n *\n * @param result - Result to tap\n * @param fn - Side effect function\n * @returns Original Result unchanged\n */\nexport function tapErr<T, E>(result: Result<T, E>, fn: (error: E) => void): Result<T, E> {\n\tif (isErr(result)) {\n\t\tfn(result.error);\n\t}\n\treturn result;\n}\n\n// =============================================================================\n// PATTERN MATCHING\n// =============================================================================\n\n/**\n * Pattern match on Result for exhaustive handling\n *\n * @param result - Result to match\n * @param handlers - Object with ok and err handlers\n * @returns Result of the matched handler\n *\n * @example\n * ```typescript\n * const message = match(result, {\n *   ok: user => `Welcome, ${user.name}!`,\n *   err: error => `Error: ${error.message}`,\n * });\n * ```\n */\nexport function match<T, E, R>(\n\tresult: Result<T, E>,\n\thandlers: {\n\t\tok: (value: T) => R;\n\t\terr: (error: E) => R;\n\t},\n): R {\n\tif (isOk(result)) {\n\t\treturn handlers.ok(result.value);\n\t}\n\treturn handlers.err(result.error);\n}\n\n// =============================================================================\n// PROMISE CONVERSION\n// =============================================================================\n\n/**\n * Convert a Result to a Promise\n *\n * @param result - Result to convert\n * @returns Promise that resolves with value or rejects with error\n *\n * @example\n * ```typescript\n * const result = ok(42);\n * const value = await toPromise(result); // 42\n *\n * const failed = err(new Error('fail'));\n * await toPromise(failed); // Rejects with Error('fail')\n * ```\n */\nexport function toPromise<T, E>(result: Result<T, E>): Promise<T> {\n\tif (isOk(result)) {\n\t\treturn Promise.resolve(result.value);\n\t}\n\tif (result.error instanceof Error) {\n\t\treturn Promise.reject(result.error);\n\t}\n\treturn Promise.reject(new Error(String(result.error)));\n}\n\n// =============================================================================\n// ADDITIONAL COMBINATORS\n// =============================================================================\n\n/**\n * Combine multiple Results into a single Result of array (fail-fast)\n * Alias for sequence() with a more common name\n *\n * @param results - Array of Results\n * @returns Result containing array of values, or first error\n *\n * @example\n * ```typescript\n * const results = [ok(1), ok(2), ok(3)];\n * const combined = all(results);\n * // { success: true, value: [1, 2, 3] }\n *\n * const withError = [ok(1), err('fail'), ok(3)];\n * const failed = all(withError);\n * // { success: false, error: 'fail' }\n * ```\n */\nexport function all<T, E>(results: Result<T, E>[]): Result<T[], E> {\n\treturn sequence(results);\n}\n\n/**\n * Combine multiple Results, collecting all errors instead of fail-fast\n *\n * @param results - Array of Results to combine\n * @returns Result with all values or array of all errors\n *\n * @example\n * ```typescript\n * const results = [ok(1), err('error1'), ok(3), err('error2')];\n * const combined = allOrErrors(results);\n * // { success: false, error: ['error1', 'error2'] }\n *\n * const allOk = [ok(1), ok(2), ok(3)];\n * const success = allOrErrors(allOk);\n * // { success: true, value: [1, 2, 3] }\n * ```\n */\nexport function allOrErrors<T, E>(results: Result<T, E>[]): Result<T[], E[]> {\n\tconst values: T[] = [];\n\tconst errors: E[] = [];\n\n\tfor (const result of results) {\n\t\tif (isOk(result)) {\n\t\t\tvalues.push(result.value);\n\t\t} else {\n\t\t\terrors.push(result.error);\n\t\t}\n\t}\n\n\tif (errors.length > 0) {\n\t\treturn err(errors);\n\t}\n\treturn ok(values);\n}\n\n// =============================================================================\n// TRY-CATCH WRAPPERS\n// =============================================================================\n\n/**\n * Wrap a synchronous function to return a Result instead of throwing\n *\n * @param fn - Function to wrap\n * @returns New function that returns Result\n *\n * @example\n * ```typescript\n * const safeParseInt = tryCatch((str: string) => {\n *   const num = parseInt(str, 10);\n *   if (isNaN(num)) throw new Error('Not a number');\n *   return num;\n * });\n *\n * const result = safeParseInt('42'); // { success: true, value: 42 }\n * const failed = safeParseInt('abc'); // { success: false, error: Error }\n * ```\n */\nexport function tryCatch<T, Args extends unknown[]>(fn: (...args: Args) => T): (...args: Args) => Result<T, Error> {\n\treturn (...args: Args): Result<T, Error> => {\n\t\ttry {\n\t\t\treturn ok(fn(...args));\n\t\t} catch (error) {\n\t\t\treturn err(toError(error));\n\t\t}\n\t};\n}\n\n/**\n * Wrap an asynchronous function to return a Result instead of throwing\n *\n * @param fn - Async function to wrap\n * @returns New async function that returns Result\n *\n * @example\n * ```typescript\n * const safeFetch = tryCatchAsync(async (url: string) => {\n *   const response = await fetch(url);\n *   return await response.json();\n * });\n *\n * const result = await safeFetch('https://api.example.com/data');\n * if (isOk(result)) {\n *   console.log(result.value);\n * }\n * ```\n */\nexport function tryCatchAsync<T, Args extends unknown[]>(\n\tfn: (...args: Args) => Promise<T>,\n): (...args: Args) => Promise<Result<T, Error>> {\n\treturn async (...args: Args): Promise<Result<T, Error>> => {\n\t\ttry {\n\t\t\tconst value = await fn(...args);\n\t\t\treturn ok(value);\n\t\t} catch (error) {\n\t\t\treturn err(toError(error));\n\t\t}\n\t};\n}\n","/**\n * Atomic File Write Utilities\n *\n * Provides atomic file write operations using write-then-rename pattern\n * to prevent corrupted files if the process crashes mid-write.\n *\n * CONSOLIDATES:\n * - apps/vscode/src/storage/utils/atomicWrite.ts (async, VS Code API)\n * - packages/mcp/src/validation.ts (sync, Node.js fs)\n *\n * @module fs/atomic\n */\n\nimport { randomBytes } from \"node:crypto\";\nimport { renameSync, unlinkSync, writeFileSync } from \"node:fs\";\nimport { rename, unlink, writeFile } from \"node:fs/promises\";\nimport type { Result } from \"../utils/result\";\nimport { err, ok } from \"../utils/result\";\n\n/**\n * Options for atomic file write operations\n */\nexport interface AtomicWriteOptions {\n\t/** Text encoding (default: 'utf8') */\n\tencoding?: BufferEncoding;\n\t/** Maximum file size in bytes (default: 10MB) */\n\tmaxSize?: number;\n\t/** File permissions mode (Unix-style) */\n\tmode?: number;\n}\n\n/**\n * Default maximum file size: 10MB\n */\nexport const DEFAULT_MAX_SIZE = 10 * 1024 * 1024;\n\n/**\n * Atomically write content to a file (async).\n *\n * Uses write-then-rename pattern:\n * 1. Write content to temporary file in same directory\n * 2. Atomically rename temp file to target (OS guarantees atomicity on same filesystem)\n * 3. Clean up temp file on failure\n *\n * **Use for:**\n * - VS Code extension (non-blocking required for UI responsiveness)\n * - Large file writes (>1MB)\n * - Server-side operations\n * - Async workflows\n *\n * @param path - Target file path\n * @param content - Content to write (string or Buffer)\n * @param options - Write options\n * @returns Result with success or error\n *\n * @example\n * ```typescript\n * const result = await atomicWriteFile(\n *   \"/path/to/file.json\",\n *   JSON.stringify(data, null, 2)\n * );\n *\n * if (isErr(result)) {\n *   console.error(\"Write failed:\", result.error);\n * }\n * ```\n */\nexport async function atomicWriteFile(\n\tpath: string,\n\tcontent: string | Buffer,\n\toptions: AtomicWriteOptions = {},\n): Promise<Result<void, Error>> {\n\tconst { encoding = \"utf8\", maxSize = DEFAULT_MAX_SIZE, mode } = options;\n\n\ttry {\n\t\t// Convert string to Buffer if needed\n\t\tconst buffer = typeof content === \"string\" ? Buffer.from(content, encoding) : content;\n\n\t\t// Size limit check\n\t\tif (buffer.length > maxSize) {\n\t\t\treturn err(new Error(`Content size (${buffer.length} bytes) exceeds maximum allowed (${maxSize} bytes)`));\n\t\t}\n\n\t\t// Generate temp file path in same directory (ensures same filesystem for atomic rename)\n\t\tconst tempSuffix = randomBytes(8).toString(\"hex\");\n\t\tconst tempPath = `${path}.${tempSuffix}.tmp`;\n\n\t\ttry {\n\t\t\t// Step 1: Write to temp file\n\t\t\tawait writeFile(tempPath, buffer, { mode });\n\n\t\t\t// Step 2: Atomic rename (OS guarantees atomicity on same filesystem)\n\t\t\tawait rename(tempPath, path);\n\n\t\t\treturn ok(undefined);\n\t\t} catch (error) {\n\t\t\t// Clean up temp file on failure\n\t\t\ttry {\n\t\t\t\tawait unlink(tempPath);\n\t\t\t} catch {\n\t\t\t\t// Ignore cleanup errors\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t} catch (error) {\n\t\treturn err(error instanceof Error ? error : new Error(String(error)));\n\t}\n}\n\n/**\n * Atomically write content to a file (sync).\n *\n * Uses write-then-rename pattern for atomic operations.\n *\n * **Use for:**\n * - CLI tools where blocking is acceptable\n * - Configuration file writes during initialization\n * - Small files (<1MB)\n * - Synchronous workflows\n *\n * @param path - Target file path\n * @param content - Content to write\n * @param options - Write options\n * @returns Result with success or error\n *\n * @example\n * ```typescript\n * const result = atomicWriteFileSync(\n *   \"/path/to/config.json\",\n *   JSON.stringify(config, null, 2)\n * );\n *\n * if (!result.success) {\n *   console.error(\"Write failed:\", result.error);\n * }\n * ```\n */\nexport function atomicWriteFileSync(\n\tpath: string,\n\tcontent: string,\n\toptions: AtomicWriteOptions = {},\n): { success: true } | { success: false; error: string } {\n\tconst { encoding = \"utf8\", maxSize = DEFAULT_MAX_SIZE, mode } = options;\n\n\ttry {\n\t\t// Size limit check\n\t\tconst contentSize = Buffer.byteLength(content, encoding);\n\t\tif (contentSize > maxSize) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Content size (${contentSize} bytes) exceeds maximum allowed (${maxSize} bytes)`,\n\t\t\t};\n\t\t}\n\n\t\t// Generate temp file path in same directory (ensures same filesystem for atomic rename)\n\t\tconst tempSuffix = randomBytes(8).toString(\"hex\");\n\t\tconst tempPath = `${path}.${tempSuffix}.tmp`;\n\n\t\ttry {\n\t\t\t// Step 1: Write to temp file\n\t\t\twriteFileSync(tempPath, content, { encoding, mode });\n\n\t\t\t// Step 2: Atomic rename (same filesystem = atomic on POSIX)\n\t\t\trenameSync(tempPath, path);\n\n\t\t\treturn { success: true };\n\t\t} catch (error) {\n\t\t\t// Clean up temp file on failure\n\t\t\ttry {\n\t\t\t\tunlinkSync(tempPath);\n\t\t\t} catch {\n\t\t\t\t// Ignore cleanup errors\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn { success: false, error: `Atomic write failed: ${message}` };\n\t}\n}\n","import crypto from \"node:crypto\";\nimport { logger } from \"@snapback-oss/infrastructure\";\nimport type { Envelope, SnapbackClient } from \"./client\";\n\n/**\n * Helper functions for the Snapback SDK\n * Provides high-level interfaces for analyze, evaluatePolicy, and ingestTelemetry\n */\n\nexport interface AnalyzeRequest {\n\tcontent: string;\n\tfilePath: string;\n\tlanguage?: string;\n}\n\nexport interface AnalyzeResponse {\n\tdecision: \"allow\" | \"review\" | \"block\";\n\tconfidence: number;\n\trules_hit: string[];\n\tmetadata?: Record<string, any>;\n}\n\nexport interface PolicyEvaluationRequest {\n\tpolicyId?: string;\n\tcontext: Record<string, any>;\n}\n\nexport interface PolicyEvaluationResponse {\n\tdecision: \"allow\" | \"review\" | \"block\";\n\tconfidence: number;\n\trules_hit: string[];\n\tpolicyVersion: string;\n}\n\nexport interface TelemetryData {\n\teventType: string;\n\tpayload: Record<string, any>;\n\ttimestamp: number;\n}\n\nexport interface TelemetryResponse {\n\tid: string;\n\treceived: boolean;\n}\n\n/**\n * Analyze code using the Snapback API\n * @param client The Snapback client instance\n * @param envelope The request envelope\n * @param request The analysis request\n * @returns The analysis response\n */\nexport async function analyze(\n\tclient: SnapbackClient,\n\tenvelope: Envelope,\n\trequest: AnalyzeRequest,\n): Promise<AnalyzeResponse> {\n\t// Ensure request has a valid request_id\n\tconst idempotentEnvelope = ensureIdempotentRequestId(envelope);\n\n\ttry {\n\t\tconst response = await client\n\t\t\t.getHttpClient()\n\t\t\t.post(\"v1/analyze\", {\n\t\t\t\tjson: {\n\t\t\t\t\t...request,\n\t\t\t\t\tenvelope: idempotentEnvelope,\n\t\t\t\t},\n\t\t\t\ttimeout: 30000,\n\t\t\t})\n\t\t\t.json<AnalyzeResponse>();\n\n\t\treturn response;\n\t} catch (error) {\n\t\tlogger.error(\"Analysis failed\", { error: error as Error });\n\t\tthrow new Error(`Analysis failed: ${(error as Error).message}`);\n\t}\n}\n\n/**\n * Evaluate policy using the Snapback API\n * @param client The Snapback client instance\n * @param envelope The request envelope\n * @param request The policy evaluation request\n * @returns The policy evaluation response\n */\nexport async function evaluatePolicy(\n\tclient: SnapbackClient,\n\tenvelope: Envelope,\n\trequest: PolicyEvaluationRequest,\n): Promise<PolicyEvaluationResponse> {\n\t// Ensure request has a valid request_id\n\tconst idempotentEnvelope = ensureIdempotentRequestId(envelope);\n\n\ttry {\n\t\tconst response = await client\n\t\t\t.getHttpClient()\n\t\t\t.post(\"v1/policy/evaluate\", {\n\t\t\t\tjson: {\n\t\t\t\t\t...request,\n\t\t\t\t\tenvelope: idempotentEnvelope,\n\t\t\t\t},\n\t\t\t\ttimeout: 30000,\n\t\t\t})\n\t\t\t.json<PolicyEvaluationResponse>();\n\n\t\treturn response;\n\t} catch (error) {\n\t\tlogger.error(\"Policy evaluation failed\", { error: error as Error });\n\t\tthrow new Error(`Policy evaluation failed: ${(error as Error).message}`);\n\t}\n}\n\n/**\n * Ingest telemetry data using the Snapback API\n * @param client The Snapback client instance\n * @param envelope The request envelope\n * @param data The telemetry data\n * @returns The telemetry response\n */\nexport async function ingestTelemetry(\n\tclient: SnapbackClient,\n\tenvelope: Envelope,\n\tdata: TelemetryData,\n): Promise<TelemetryResponse> {\n\t// Ensure request has a valid request_id\n\tconst idempotentEnvelope = ensureIdempotentRequestId(envelope);\n\n\ttry {\n\t\tconst response = await client\n\t\t\t.getHttpClient()\n\t\t\t.post(\"v1/telemetry\", {\n\t\t\t\tjson: {\n\t\t\t\t\t...data,\n\t\t\t\t\tenvelope: idempotentEnvelope,\n\t\t\t\t},\n\t\t\t\ttimeout: 30000,\n\t\t\t})\n\t\t\t.json<TelemetryResponse>();\n\n\t\treturn response;\n\t} catch (error) {\n\t\tlogger.error(\"Telemetry ingestion failed\", { error: error as Error });\n\t\tthrow new Error(`Telemetry ingestion failed: ${(error as Error).message}`);\n\t}\n}\n\n/**\n * Ensure request_id is idempotent\n * @param envelope The request envelope\n * @returns Envelope with guaranteed unique request_id\n */\nexport function ensureIdempotentRequestId(envelope: Envelope): Envelope {\n\t// If request_id is not provided, generate one\n\tif (!envelope.request_id) {\n\t\treturn {\n\t\t\t...envelope,\n\t\t\trequest_id: generateRequestId(),\n\t\t};\n\t}\n\n\t// Otherwise return as-is\n\treturn envelope;\n}\n\n/**\n * Generate a unique request ID\n * @returns Unique request ID\n */\nfunction generateRequestId(): string {\n\treturn `${Date.now()}-${crypto.randomUUID().substring(0, 10)}`;\n}\n","/**\n * Unified Hash Utilities\n *\n * Consolidated from:\n * - apps/vscode/src/storage/utils/hash.ts\n * - packages-oss/sdk/src/privacy/hasher.ts\n * - packages/engine/src/runtime/storage.ts (inline usage)\n *\n * Provides SHA-256 hashing for:\n * - Content-addressable blob storage\n * - Privacy-preserving telemetry (file paths, workspace IDs)\n * - Content deduplication\n *\n * @module hash\n */\n\nimport crypto from \"node:crypto\";\n\n/**\n * Core SHA-256 hashing function\n *\n * @param input - String to hash\n * @returns Lowercase hexadecimal SHA-256 hash\n *\n * @example\n * ```typescript\n * const hash = sha256(\"hello world\");\n * // Returns: \"b94d27b9934d3e08a52e52d7da7dabfac484efe37a5380ee9088f7ace2efcde9\"\n * ```\n */\nexport function sha256(input: string): string {\n\treturn crypto.createHash(\"sha256\").update(input, \"utf-8\").digest(\"hex\");\n}\n\n/**\n * Generate SHA-256 hash of content\n *\n * Alias for sha256() with explicit use case naming.\n * Used for content-addressable blob storage.\n *\n * @param content - Content to hash\n * @returns Lowercase hexadecimal SHA-256 hash\n *\n * @example\n * ```typescript\n * const hash = hashContent(\"const x = 1;\");\n * // Use with getBlobPath() for storage\n * const blobPath = getBlobPath(hash);\n * ```\n */\nexport function hashContent(content: string): string {\n\treturn sha256(content);\n}\n\n/**\n * Hash file path for anonymization\n *\n * Used in privacy-preserving telemetry to anonymize file paths\n * while maintaining ability to track unique files.\n *\n * @param filePath - File path to hash\n * @returns Lowercase hexadecimal SHA-256 hash\n *\n * @example\n * ```typescript\n * const hash = hashFilePath(\"/workspace/src/auth.ts\");\n * // Returns anonymized hash for telemetry\n * ```\n */\nexport function hashFilePath(filePath: string): string {\n\treturn sha256(filePath);\n}\n\n/**\n * Hash workspace ID for anonymization\n *\n * Used in privacy-preserving telemetry to anonymize workspace identifiers\n * while maintaining ability to track per-workspace usage.\n *\n * @param workspaceId - Workspace identifier to hash\n * @returns Lowercase hexadecimal SHA-256 hash\n *\n * @example\n * ```typescript\n * const hash = hashWorkspaceId(\"/Users/user/projects/myapp\");\n * // Returns anonymized hash for telemetry\n * ```\n */\nexport function hashWorkspaceId(workspaceId: string): string {\n\treturn sha256(workspaceId);\n}\n\n/**\n * Get sharded blob path from hash\n *\n * Creates multi-level directory structure to avoid too many files in one directory.\n * Default 2-level sharding: ab/cd/abcd1234...\n *\n * @param hash - SHA-256 hash (lowercase hex string)\n * @param levels - Number of directory levels (default: 2)\n * @returns Sharded path string\n *\n * @example\n * ```typescript\n * // Default 2-level sharding\n * getBlobPath(\"abcd1234567890\");\n * // Returns: \"ab/cd/abcd1234567890\"\n *\n * // Custom 3-level sharding\n * getBlobPath(\"abcd1234567890\", 3);\n * // Returns: \"ab/cd/12/abcd1234567890\"\n * ```\n */\nexport function getBlobPath(hash: string, levels = 2): string {\n\tconst segments: string[] = [];\n\n\tfor (let i = 0; i < levels; i++) {\n\t\tsegments.push(hash.slice(i * 2, (i + 1) * 2));\n\t}\n\n\tsegments.push(hash);\n\n\treturn segments.join(\"/\");\n}\n","export class PrivacyValidator {\n\t/**\n\t * Check that payload contains only metadata\n\t */\n\tisMetadataOnly(data: any): boolean {\n\t\t// Forbidden properties\n\t\tconst forbidden = [\n\t\t\t\"content\",\n\t\t\t\"sourceCode\",\n\t\t\t\"fileContent\",\n\t\t\t\"code\",\n\t\t\t\"text\",\n\t\t\t\"body\",\n\t\t\t\"filePath\", // Only hashed paths allowed\n\t\t\t\"fullPath\",\n\t\t\t\"absolutePath\",\n\t\t];\n\n\t\t// Check for forbidden properties\n\t\tconst props = this.getAllProps(data);\n\t\tfor (const prop of forbidden) {\n\t\t\tif (props.includes(prop)) {\n\t\t\t\tconsole.warn(`Privacy violation: forbidden property '${prop}' in request`);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// Check for suspiciously large strings\n\t\tconst strings = this.getAllStrings(data);\n\t\tfor (const str of strings) {\n\t\t\tif (str.length > 1000) {\n\t\t\t\tconsole.warn(`Privacy violation: string too large (${str.length} chars)`);\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check for code-like patterns\n\t\t\tif (this.looksLikeCode(str)) {\n\t\t\t\tconsole.warn(\"Privacy violation: string contains code-like patterns\");\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Get all property names recursively\n\t */\n\tprivate getAllProps(obj: any, prefix = \"\"): string[] {\n\t\tlet props: string[] = [];\n\n\t\tfor (const [key, value] of Object.entries(obj)) {\n\t\t\tconst fullKey = prefix ? `${prefix}.${key}` : key;\n\t\t\tprops.push(fullKey);\n\n\t\t\tif (typeof value === \"object\" && value !== null && !Array.isArray(value)) {\n\t\t\t\tprops = props.concat(this.getAllProps(value, fullKey));\n\t\t\t}\n\t\t}\n\n\t\treturn props;\n\t}\n\n\t/**\n\t * Get all string values recursively\n\t */\n\tprivate getAllStrings(obj: any): string[] {\n\t\tlet strings: string[] = [];\n\n\t\tfor (const value of Object.values(obj)) {\n\t\t\tif (typeof value === \"string\") {\n\t\t\t\tstrings.push(value);\n\t\t\t} else if (typeof value === \"object\" && value !== null) {\n\t\t\t\tstrings = strings.concat(this.getAllStrings(value));\n\t\t\t}\n\t\t}\n\n\t\treturn strings;\n\t}\n\n\t/**\n\t * Heuristic to detect code-like strings\n\t */\n\tprivate looksLikeCode(str: string): boolean {\n\t\tconst codePatterns = [\n\t\t\t/function\\s+\\w+/,\n\t\t\t/const\\s+\\w+\\s*=/,\n\t\t\t/let\\s+\\w+\\s*=/,\n\t\t\t/var\\s+\\w+\\s*=/,\n\t\t\t/class\\s+\\w+/,\n\t\t\t/import\\s+.*from/,\n\t\t\t/export\\s+(default\\s+)?/,\n\t\t\t/if\\s*\\(/,\n\t\t\t/for\\s*\\(/,\n\t\t\t/while\\s*\\(/,\n\t\t];\n\n\t\treturn codePatterns.some((pattern) => pattern.test(str));\n\t}\n}\n","import type { ProtectedFile, ProtectionConfig, ProtectionLevel } from \"@snapback-oss/contracts\";\nimport { minimatch } from \"minimatch\";\n\nexport class ProtectionManager {\n\tprivate registry = new Map<string, ProtectedFile>();\n\tprivate config: ProtectionConfig;\n\n\tconstructor(config: ProtectionConfig) {\n\t\tthis.config = config;\n\t}\n\n\tprotect(filePath: string, level: ProtectionLevel, reason?: string): void {\n\t\tconst protectedFile: ProtectedFile = {\n\t\t\tpath: filePath,\n\t\t\tlevel,\n\t\t\treason,\n\t\t\taddedAt: new Date(),\n\t\t};\n\n\t\tthis.registry.set(filePath, protectedFile);\n\t}\n\n\tunprotect(filePath: string): void {\n\t\tthis.registry.delete(filePath);\n\t}\n\n\tgetProtection(filePath: string): ProtectedFile | null {\n\t\t// Check for direct protection first\n\t\tconst directProtection = this.registry.get(filePath);\n\t\tif (directProtection) {\n\t\t\treturn directProtection;\n\t\t}\n\n\t\t// Check pattern-based protection if enabled\n\t\tif (!this.config.enabled) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check each pattern rule\n\t\tfor (const rule of this.config.patterns) {\n\t\t\tif (!rule.enabled) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (minimatch(filePath, rule.pattern)) {\n\t\t\t\treturn {\n\t\t\t\t\tpath: filePath,\n\t\t\t\t\tlevel: rule.level,\n\t\t\t\t\treason: rule.reason || `Matches pattern: ${rule.pattern}`,\n\t\t\t\t\taddedAt: new Date(),\n\t\t\t\t\tpattern: rule.pattern,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tisProtected(filePath: string): boolean {\n\t\treturn this.getProtection(filePath) !== null;\n\t}\n\n\tgetLevel(filePath: string): ProtectionLevel | null {\n\t\tconst protection = this.getProtection(filePath);\n\t\treturn protection ? protection.level : null;\n\t}\n\n\tlistProtected(): ProtectedFile[] {\n\t\treturn Array.from(this.registry.values());\n\t}\n\n\tupdateLevel(filePath: string, level: ProtectionLevel): void {\n\t\tconst existing = this.registry.get(filePath);\n\t\tif (!existing) {\n\t\t\tthrow new Error(`File ${filePath} is not protected`);\n\t\t}\n\n\t\tthis.registry.set(filePath, {\n\t\t\t...existing,\n\t\t\tlevel,\n\t\t});\n\t}\n\n\tgetConfig(): ProtectionConfig {\n\t\treturn { ...this.config };\n\t}\n\n\tupdateConfig(config: ProtectionConfig): void {\n\t\tthis.config = { ...this.config, ...config };\n\t}\n}\n","import path from \"node:path\";\n\n/**\n * Custom error class for security violations\n */\nexport class SecurityError extends Error {\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = \"SecurityError\";\n\t}\n}\n\n/**\n * Validate file paths to prevent path traversal attacks\n * @param filePath - The file path to validate\n * @throws SecurityError if the path is invalid\n */\nexport function validatePath(filePath: string): void {\n\t// Check for null bytes (classic security issue)\n\tif (filePath.includes(\"\\0\")) {\n\t\tthrow new SecurityError(\"Null bytes in path not allowed\");\n\t}\n\n\t// Normalize the path\n\tconst normalized = path.normalize(filePath);\n\n\t// Reject absolute paths\n\tif (path.isAbsolute(normalized)) {\n\t\tthrow new SecurityError(\"Absolute paths not allowed\");\n\t}\n\n\t// Reject paths that traverse upward by checking segments\n\t// This correctly handles legitimate filenames like \"config..json\"\n\tconst segments = normalized.split(path.sep);\n\tif (segments.some((seg) => seg === \"..\")) {\n\t\tthrow new SecurityError(\"Path traversal not allowed\");\n\t}\n}\n\n/**\n * Sanitize input for JSON to prevent injection attacks\n * @param obj - The object to sanitize\n * @throws SecurityError if dangerous patterns are found\n */\nexport function sanitizeForJSON(obj: any): any {\n\tconst str = JSON.stringify(obj);\n\n\treturn JSON.parse(str);\n}\n","import { createHash } from \"node:crypto\";\nimport type { FileInput, Snapshot } from \"@snapback-oss/contracts\";\nimport QuickLRU from \"quick-lru\";\nimport { THRESHOLDS } from \"../config/Thresholds\";\nimport type { StorageAdapter } from \"../storage/StorageAdapter\";\n\nexport class SnapshotDeduplication {\n\tprivate hashCache: QuickLRU<string, string>;\n\n\tconstructor(private cacheSize = THRESHOLDS.resources.dedupCacheSize) {\n\t\tthis.hashCache = new QuickLRU({ maxSize: this.cacheSize });\n\t}\n\n\t/**\n\t * Hash file content using SHA-256\n\t */\n\thashContent(content: string): string {\n\t\treturn createHash(\"sha256\").update(content).digest(\"hex\");\n\t}\n\n\t/**\n\t * Hash multiple files content\n\t */\n\thashFiles(files: FileInput[]): string {\n\t\t// Sort files for consistent hashing\n\t\tconst sorted = [...files].sort((a, b) => a.path.localeCompare(b.path));\n\n\t\tconst content = sorted.map((f) => `${f.path}:${f.action}:${f.content}`).join(\"|\");\n\n\t\treturn this.hashContent(content);\n\t}\n\n\t/**\n\t * Check if content is already stored (deduplication)\n\t */\n\tasync isDuplicate(\n\t\tfiles: FileInput[],\n\t\tstorage: StorageAdapter,\n\t): Promise<{ isDuplicate: boolean; existingId?: string }> {\n\t\tconst hash = this.hashFiles(files);\n\n\t\t// Check cache first\n\t\tconst cachedId = this.hashCache.get(hash);\n\t\tif (cachedId) {\n\t\t\treturn { isDuplicate: true, existingId: cachedId };\n\t\t}\n\n\t\t// If storage supports hash-based lookup, use it for O(1) performance\n\t\t// This is a more efficient approach than loading all snapshots\n\t\tif (this.supportsHashLookup(storage)) {\n\t\t\tconst existing = await this.getByContentHash(storage, hash);\n\t\t\tif (existing) {\n\t\t\t\tthis.hashCache.set(hash, existing.id);\n\t\t\t\treturn { isDuplicate: true, existingId: existing.id };\n\t\t\t}\n\t\t} else {\n\t\t\t// Fallback to original approach for storages that don't support hash lookup\n\t\t\t// Check storage (query by content hash if supported)\n\t\t\t// For now, we'll do a simple check by comparing content\n\t\t\tconst allSnapshots = await storage.list();\n\n\t\t\tfor (const snapshot of allSnapshots) {\n\t\t\t\t// Check if this snapshot has the same files and content\n\t\t\t\tif (snapshot.files?.length === files.length) {\n\t\t\t\t\tconst isMatch = files.every((file) => snapshot.fileContents?.[file.path] === file.content);\n\n\t\t\t\t\tif (isMatch) {\n\t\t\t\t\t\tthis.hashCache.set(hash, snapshot.id);\n\t\t\t\t\t\treturn { isDuplicate: true, existingId: snapshot.id };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn { isDuplicate: false };\n\t}\n\n\t/**\n\t * Check if storage adapter supports hash-based lookup\n\t */\n\tprivate supportsHashLookup(storage: StorageAdapter): boolean {\n\t\t// This would be implemented by storage adapters that support hash indexing\n\t\treturn \"getByContentHash\" in storage;\n\t}\n\n\t/**\n\t * Get snapshot by content hash (if supported by storage)\n\t */\n\tprivate async getByContentHash(storage: StorageAdapter, hash: string): Promise<Snapshot | null> {\n\t\tif (storage.getByContentHash) {\n\t\t\treturn await storage.getByContentHash(hash);\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Record hash for future deduplication checks\n\t */\n\trecordHash(snapshotId: string, files: FileInput[]): void {\n\t\tconst hash = this.hashFiles(files);\n\t\tthis.hashCache.set(hash, snapshotId);\n\t}\n\n\t/**\n\t * Clear hash from cache for a deleted snapshot\n\t * This prevents the dedup cache from referencing non-existent snapshots\n\t */\n\tclearHash(snapshotId: string): void {\n\t\t// Find and remove all cache entries that reference this snapshot ID\n\t\tfor (const [hash, cachedId] of this.hashCache.entries()) {\n\t\t\tif (cachedId === snapshotId) {\n\t\t\t\tthis.hashCache.delete(hash);\n\t\t\t}\n\t\t}\n\t}\n}\n","import type { FileInput } from \"@snapback-oss/contracts\";\n\nexport class SnapshotNaming {\n\t/**\n\t * Generate snapshot name based on naming strategy\n\t */\n\tgenerateName(files: FileInput[], strategy: \"git\" | \"semantic\" | \"timestamp\" | \"custom\" = \"semantic\"): string {\n\t\tswitch (strategy) {\n\t\t\tcase \"git\":\n\t\t\t\treturn this.gitStrategy(files);\n\t\t\tcase \"semantic\":\n\t\t\t\treturn this.semanticStrategy(files);\n\t\t\tcase \"timestamp\":\n\t\t\t\treturn this.timestampStrategy();\n\t\t\tdefault:\n\t\t\t\treturn this.semanticStrategy(files);\n\t\t}\n\t}\n\n\t/**\n\t * Git strategy - would parse git commit message (simplified implementation)\n\t */\n\tprivate gitStrategy(files: FileInput[]): string {\n\t\t// In a real implementation, this would integrate with git\n\t\t// For now, fall back to semantic strategy\n\t\treturn this.semanticStrategy(files);\n\t}\n\n\t/**\n\t * Semantic strategy - analyze file operations\n\t */\n\tprivate semanticStrategy(files: FileInput[]): string {\n\t\tif (files.length === 1) {\n\t\t\tconst file = files[0];\n\t\t\tconst fileName = file.path.split(\"/\").pop() || \"file\";\n\t\t\treturn `${this.capitalize(file.action)} ${fileName}`;\n\t\t}\n\n\t\t// Analyze file operations\n\t\tconst actionCounts = files.reduce(\n\t\t\t(acc, f) => {\n\t\t\t\tacc[f.action] = (acc[f.action] || 0) + 1;\n\t\t\t\treturn acc;\n\t\t\t},\n\t\t\t{} as Record<string, number>,\n\t\t);\n\n\t\tconst primaryAction = Object.entries(actionCounts).sort((a, b) => (b[1] as number) - (a[1] as number))[0];\n\n\t\tif (primaryAction) {\n\t\t\treturn `${this.capitalize(String(primaryAction[0]))} ${files.length} files`;\n\t\t}\n\n\t\treturn `Snapshot of ${files.length} files`;\n\t}\n\n\t/**\n\t * Timestamp strategy - use current timestamp\n\t */\n\tprivate timestampStrategy(): string {\n\t\treturn `Snapshot ${new Date().toISOString()}`;\n\t}\n\n\t/**\n\t * Capitalize first letter of string\n\t */\n\tprivate capitalize(str: string): string {\n\t\treturn str.charAt(0).toUpperCase() + str.slice(1);\n\t}\n}\n","import { randomUUID } from \"node:crypto\";\nimport { existsSync } from \"node:fs\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport type {\n\tCreateSnapshotOptions,\n\tFileInput,\n\tSnapshot,\n\tSnapshotFilters,\n\tSnapshotRestoreResult,\n} from \"@snapback-oss/contracts\";\nimport type { StorageAdapter } from \"../storage/StorageAdapter\";\nimport { validatePath } from \"../utils/security\";\nimport { SnapshotDeduplication } from \"./SnapshotDeduplication\";\nimport { SnapshotNaming } from \"./SnapshotNaming\";\n\nexport interface SnapshotManagerOptions {\n\tenableDeduplication?: boolean;\n\tnamingStrategy?: \"git\" | \"semantic\" | \"timestamp\";\n\tautoProtect?: boolean;\n}\n\nexport class SnapshotManager {\n\tprivate deduplication: SnapshotDeduplication;\n\tprivate naming: SnapshotNaming;\n\n\tconstructor(\n\t\tprivate storage: StorageAdapter,\n\t\tprivate options: SnapshotManagerOptions = {},\n\t) {\n\t\tthis.deduplication = new SnapshotDeduplication();\n\t\tthis.naming = new SnapshotNaming();\n\t}\n\n\tasync create(files: FileInput[], options?: CreateSnapshotOptions): Promise<Snapshot> {\n\t\treturn this.createSnapshot(files, options);\n\t}\n\n\t/**\n\t * Convenience method for creating a snapshot with a single file\n\t * @param params - Object containing filePath and content\n\t * @param options - Snapshot options\n\t * @returns Created snapshot\n\t */\n\tasync createTest(\n\t\tparams: { filePath: string; content: string },\n\t\toptions?: CreateSnapshotOptions,\n\t): Promise<Snapshot> {\n\t\tconst fileInput: FileInput = {\n\t\t\tpath: params.filePath,\n\t\t\tcontent: params.content,\n\t\t\taction: \"modify\",\n\t\t};\n\t\treturn this.createSnapshot([fileInput], options);\n\t}\n\n\tprivate async createSnapshot(files: FileInput[], options?: CreateSnapshotOptions): Promise<Snapshot> {\n\t\t// Validate all file paths to prevent path traversal attacks\n\t\tawait Promise.all(files.map((file) => Promise.resolve(validatePath(file.path))));\n\t\t// Check for duplicates if deduplication is enabled\n\t\tif (this.options.enableDeduplication) {\n\t\t\tconst { isDuplicate, existingId } = await this.deduplication.isDuplicate(files, this.storage);\n\n\t\t\tif (isDuplicate && existingId) {\n\t\t\t\tthrow new Error(\"Duplicate snapshot detected\");\n\t\t\t}\n\t\t}\n\n\t\t// Generate name\n\t\tconst name = options?.description || this.naming.generateName(files, this.options.namingStrategy);\n\n\t\t// Create snapshot with explicit version for type safety\n\t\tconst snapshot: Snapshot = {\n\t\t\tid: randomUUID(),\n\t\t\ttimestamp: Date.now(),\n\t\t\tversion: \"1.0\",\n\t\t\tmeta: {\n\t\t\t\tname,\n\t\t\t\tprotected: options?.protected || this.options.autoProtect || false,\n\t\t\t},\n\t\t\tfiles: files.map((f) => f.path),\n\t\t\tfileContents: files.reduce(\n\t\t\t\t(acc, f) => {\n\t\t\t\t\tacc[f.path] = f.content;\n\t\t\t\t\treturn acc;\n\t\t\t\t},\n\t\t\t\t{} as Record<string, string>,\n\t\t\t),\n\t\t};\n\n\t\t// Compute content hash for deduplication\n\t\tconst contentHash = this.options.enableDeduplication ? this.deduplication.hashFiles(files) : undefined;\n\n\t\t// Save with content hash for indexed lookups\n\t\tawait this.storage.save(snapshot, contentHash);\n\n\t\t// Record hash for deduplication cache\n\t\tif (this.options.enableDeduplication && contentHash) {\n\t\t\tthis.deduplication.recordHash(snapshot.id, files);\n\t\t}\n\n\t\treturn snapshot;\n\t}\n\n\tasync list(filters?: SnapshotFilters): Promise<Snapshot[]> {\n\t\treturn this.storage.list(filters);\n\t}\n\n\tasync get(id: string): Promise<Snapshot | null> {\n\t\treturn this.storage.get(id);\n\t}\n\n\tasync delete(id: string): Promise<void> {\n\t\tconst snapshot = await this.storage.get(id);\n\t\tif (!snapshot) {\n\t\t\tthrow new Error(`Snapshot ${id} not found`);\n\t\t}\n\n\t\tif (snapshot.meta?.protected) {\n\t\t\tthrow new Error(`Cannot delete protected snapshot ${id}`);\n\t\t}\n\n\t\tawait this.storage.delete(id);\n\n\t\t// Clear dedup cache to prevent referencing deleted snapshot\n\t\tif (this.options.enableDeduplication) {\n\t\t\tthis.deduplication.clearHash(id);\n\t\t}\n\t}\n\n\t/**\n\t * Restore snapshot to target directory with atomic guarantees\n\t * @param id Snapshot ID to restore\n\t * @param targetPath Target directory path (optional, for actual file system restore)\n\t * @param options Restore options\n\t * @returns Restore result with list of restored files and any errors\n\t */\n\tasync restore(\n\t\tid: string,\n\t\ttargetPath?: string,\n\t\toptions?: { dryRun?: boolean; onProgress?: (progress: number) => void },\n\t): Promise<SnapshotRestoreResult> {\n\t\tconst snapshot = await this.storage.get(id);\n\t\tif (!snapshot) {\n\t\t\tthrow new Error(`Snapshot ${id} not found`);\n\t\t}\n\n\t\t// If no target path provided, return snapshot metadata only (metadata restore)\n\t\tif (!targetPath) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\trestoredFiles: snapshot.files || [],\n\t\t\t\terrors: [],\n\t\t\t};\n\t\t}\n\n\t\t// Dry run mode - just validate without writing files\n\t\tif (options?.dryRun) {\n\t\t\tconst errors: string[] = [];\n\t\t\tconst fileContents = snapshot.fileContents || {};\n\n\t\t\tfor (const filePath of snapshot.files || []) {\n\t\t\t\tif (!fileContents[filePath]) {\n\t\t\t\t\terrors.push(`Missing content for file: ${filePath}`);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: errors.length === 0,\n\t\t\t\trestoredFiles: snapshot.files || [],\n\t\t\t\terrors,\n\t\t\t};\n\t\t}\n\n\t\t// Perform actual atomic file system restore\n\t\treturn await this.restoreAtomic(snapshot, targetPath, options);\n\t}\n\n\t/**\n\t * Atomic restore implementation with staging and rollback\n\t */\n\tprivate async restoreAtomic(\n\t\tsnapshot: Snapshot,\n\t\ttargetPath: string,\n\t\toptions?: { onProgress?: (progress: number) => void },\n\t): Promise<SnapshotRestoreResult> {\n\t\tconst errors: string[] = [];\n\t\tconst restoredFiles: string[] = [];\n\t\tconst stagingDir = `${targetPath}.staging`;\n\t\tconst backupDir = `${targetPath}.backup`;\n\t\tlet targetBackedUp = false;\n\n\t\ttry {\n\t\t\tconst fileContents = snapshot.fileContents || {};\n\t\t\tconst files = snapshot.files || [];\n\t\t\tconst totalFiles = files.length;\n\n\t\t\t// Step 1: Create staging directory\n\t\t\tif (existsSync(stagingDir)) {\n\t\t\t\tawait fs.rm(stagingDir, { recursive: true, force: true });\n\t\t\t}\n\t\t\tawait fs.mkdir(stagingDir, { recursive: true });\n\n\t\t\t// Step 2: Extract all files to staging and validate\n\t\t\tfor (let i = 0; i < totalFiles; i++) {\n\t\t\t\tconst filePath = files[i];\n\t\t\t\tconst content = fileContents[filePath];\n\n\t\t\t\tif (!content) {\n\t\t\t\t\tthrow new Error(`Missing content for file: ${filePath}`);\n\t\t\t\t}\n\n\t\t\t\t// Write to staging\n\t\t\t\tconst targetFilePath = path.join(stagingDir, filePath);\n\t\t\t\tawait fs.mkdir(path.dirname(targetFilePath), { recursive: true });\n\t\t\t\tawait fs.writeFile(targetFilePath, content, \"utf-8\");\n\n\t\t\t\trestoredFiles.push(filePath);\n\n\t\t\t\t// Report progress\n\t\t\t\tif (options?.onProgress) {\n\t\t\t\t\tconst progress = Math.round(((i + 1) / totalFiles) * 90);\n\t\t\t\t\toptions.onProgress(progress);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Step 3: Backup existing target directory\n\t\t\tif (existsSync(targetPath)) {\n\t\t\t\tif (existsSync(backupDir)) {\n\t\t\t\t\tawait fs.rm(backupDir, { recursive: true, force: true });\n\t\t\t\t}\n\t\t\t\tawait fs.rename(targetPath, backupDir);\n\t\t\t\ttargetBackedUp = true;\n\t\t\t}\n\n\t\t\tif (options?.onProgress) {\n\t\t\t\toptions.onProgress(95);\n\t\t\t}\n\n\t\t\t// Step 4: Atomic swap - rename staging to target\n\t\t\tawait fs.rename(stagingDir, targetPath);\n\n\t\t\tif (options?.onProgress) {\n\t\t\t\toptions.onProgress(100);\n\t\t\t}\n\n\t\t\t// Step 5: Clean up backup on success\n\t\t\tif (existsSync(backupDir)) {\n\t\t\t\tawait fs.rm(backupDir, { recursive: true, force: true });\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\trestoredFiles,\n\t\t\t\terrors: [],\n\t\t\t};\n\t\t} catch (error) {\n\t\t\t// Rollback: restore from backup if it exists\n\t\t\tif (targetBackedUp && existsSync(backupDir)) {\n\t\t\t\ttry {\n\t\t\t\t\tif (existsSync(targetPath)) {\n\t\t\t\t\t\tawait fs.rm(targetPath, { recursive: true, force: true });\n\t\t\t\t\t}\n\t\t\t\t\tawait fs.rename(backupDir, targetPath);\n\t\t\t\t} catch (rollbackError) {\n\t\t\t\t\terrors.push(\n\t\t\t\t\t\t`Rollback failed: ${rollbackError instanceof Error ? rollbackError.message : String(rollbackError)}`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Clean up staging directory\n\t\t\tif (existsSync(stagingDir)) {\n\t\t\t\ttry {\n\t\t\t\t\tawait fs.rm(stagingDir, { recursive: true, force: true });\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore cleanup errors\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\t\t\terrors.push(errorMessage);\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\trestoredFiles,\n\t\t\t\terrors,\n\t\t\t};\n\t\t}\n\t}\n\n\tasync protect(id: string): Promise<void> {\n\t\tconst snapshot = await this.storage.get(id);\n\t\tif (!snapshot) {\n\t\t\tthrow new Error(`Snapshot ${id} not found`);\n\t\t}\n\n\t\t// Create defensive copy to prevent mutating original object\n\t\tconst updated: Snapshot = {\n\t\t\t...snapshot,\n\t\t\tmeta: {\n\t\t\t\t...snapshot.meta,\n\t\t\t\tprotected: true,\n\t\t\t},\n\t\t};\n\n\t\t// Reuse the exact stored content hash to preserve deduplication\n\t\tconst contentHash =\n\t\t\tthis.options.enableDeduplication && \"getStoredContentHash\" in this.storage\n\t\t\t\t? await (this.storage as any).getStoredContentHash(id)\n\t\t\t\t: undefined;\n\n\t\tawait this.storage.save(updated, contentHash);\n\t}\n\n\tasync unprotect(id: string): Promise<void> {\n\t\tconst snapshot = await this.storage.get(id);\n\t\tif (!snapshot) {\n\t\t\tthrow new Error(`Snapshot ${id} not found`);\n\t\t}\n\n\t\t// Create defensive copy to prevent mutating original object\n\t\tconst updated: Snapshot = {\n\t\t\t...snapshot,\n\t\t\tmeta: {\n\t\t\t\t...snapshot.meta,\n\t\t\t\tprotected: false,\n\t\t\t},\n\t\t};\n\n\t\t// Reuse the exact stored content hash to preserve deduplication\n\t\tconst contentHash =\n\t\t\tthis.options.enableDeduplication && \"getStoredContentHash\" in this.storage\n\t\t\t\t? await (this.storage as any).getStoredContentHash(id)\n\t\t\t\t: undefined;\n\n\t\tawait this.storage.save(updated, contentHash);\n\t}\n\n\tasync search(criteria: { content?: string; message?: string }): Promise<Snapshot[]> {\n\t\t// If storage supports optimized search, use it\n\t\tif (this.supportsOptimizedSearch(this.storage)) {\n\t\t\treturn await this.optimizedSearch(this.storage, criteria);\n\t\t}\n\n\t\t// Fallback to loading all snapshots (inefficient but works)\n\t\tconst all = await this.storage.list();\n\n\t\treturn all.filter((snapshot) => {\n\t\t\tif (criteria.content) {\n\t\t\t\tconst hasContent = Object.values(snapshot.fileContents || {}).some(\n\t\t\t\t\t(content) => content != null && criteria.content && String(content).includes(criteria.content),\n\t\t\t\t);\n\t\t\t\tif (!hasContent) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (criteria.message) {\n\t\t\t\tconst _name = snapshot.meta?.name || \"\";\n\t\t\t\tif (criteria.message) {\n\t\t\t\t\tconst name = snapshot.meta?.name || \"\";\n\t\t\t\t\tif (criteria.message && typeof name === \"string\" && !name.includes(criteria.message)) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t});\n\t}\n\n\t/**\n\t * Check if storage adapter supports optimized search\n\t */\n\tprivate supportsOptimizedSearch(storage: StorageAdapter): boolean {\n\t\treturn \"search\" in storage && typeof (storage as any).search === \"function\";\n\t}\n\n\t/**\n\t * Perform optimized search using storage adapter capabilities\n\t */\n\tprivate async optimizedSearch(\n\t\tstorage: StorageAdapter,\n\t\tcriteria: { content?: string; message?: string },\n\t): Promise<Snapshot[]> {\n\t\t// This would delegate to storage adapter's optimized search implementation\n\t\t// For now, fallback to the original approach\n\t\tconst all = await storage.list();\n\n\t\treturn all.filter((snapshot) => {\n\t\t\tif (criteria.content) {\n\t\t\t\tconst hasContent = Object.values(snapshot.fileContents || {}).some(\n\t\t\t\t\t(content) => content != null && String(content).includes(criteria.content ?? \"\"),\n\t\t\t\t);\n\t\t\t\tif (!hasContent) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (criteria.message) {\n\t\t\t\tconst name = snapshot.meta?.name || \"\";\n\t\t\t\tif (criteria.message && typeof name === \"string\" && !name.includes(criteria.message)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t});\n\t}\n}\n","export class StorageError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\tpublic code?: string,\n\t\tpublic details?: unknown,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"StorageError\";\n\t}\n}\n\nexport class StorageConnectionError extends StorageError {\n\tconstructor(message: string, details?: unknown) {\n\t\tsuper(message, \"STORAGE_CONNECTION_ERROR\", details);\n\t\tthis.name = \"StorageConnectionError\";\n\t}\n}\n\nexport class StorageTransactionError extends StorageError {\n\tconstructor(message: string, details?: unknown) {\n\t\tsuper(message, \"STORAGE_TRANSACTION_ERROR\", details);\n\t\tthis.name = \"StorageTransactionError\";\n\t}\n}\n\nexport class StorageFullError extends StorageError {\n\tconstructor(message: string, details?: unknown) {\n\t\tsuper(message, \"STORAGE_FULL_ERROR\", details);\n\t\tthis.name = \"StorageFullError\";\n\t}\n}\n\nexport class StorageLockError extends StorageError {\n\tconstructor(message: string, details?: unknown) {\n\t\tsuper(message, \"STORAGE_LOCK_ERROR\", details);\n\t\tthis.name = \"StorageLockError\";\n\t}\n}\n\nexport class CorruptedDataError extends StorageError {\n\tconstructor(message: string, details?: unknown) {\n\t\tsuper(message, \"CORRUPTED_DATA_ERROR\", details);\n\t\tthis.name = \"CorruptedDataError\";\n\t}\n}\n","import type { Snapshot, SnapshotFilters } from \"@snapback-oss/contracts\";\nimport { logger } from \"@snapback-oss/infrastructure\";\nimport type Database from \"better-sqlite3\";\nimport { sanitizeForJSON } from \"../utils/security\";\nimport type { StorageAdapter } from \"./StorageAdapter\";\nimport {\n\tCorruptedDataError,\n\tStorageConnectionError,\n\tStorageError,\n\tStorageFullError,\n\tStorageLockError,\n} from \"./StorageErrors\";\n\n// Lazy-loaded better-sqlite3 instance\nlet DatabaseConstructor: typeof Database | null = null;\nlet loadError: Error | null = null;\n\nasync function loadBetterSqlite3(): Promise<typeof Database> {\n\tif (DatabaseConstructor) {\n\t\treturn DatabaseConstructor;\n\t}\n\n\tif (loadError) {\n\t\tthrow loadError;\n\t}\n\n\ttry {\n\t\tconst module = await import(\"better-sqlite3\");\n\t\tDatabaseConstructor = module.default;\n\t\treturn DatabaseConstructor;\n\t} catch (error) {\n\t\tloadError = error instanceof Error ? error : new Error(String(error));\n\t\tthrow new StorageConnectionError(\"Failed to load better-sqlite3\", {\n\t\t\tcause: loadError,\n\t\t});\n\t}\n}\n\nexport class LocalStorage implements StorageAdapter {\n\tprivate db: Database.Database | null = null;\n\tprivate dbPath: string;\n\n\tconstructor(dbPath: string) {\n\t\tthis.dbPath = dbPath;\n\t}\n\n\tprivate async ensureInitialized(): Promise<void> {\n\t\tif (this.db) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst DB = await loadBetterSqlite3();\n\t\tthis.db = new DB(this.dbPath);\n\t\tthis.initSchema();\n\t}\n\n\tprivate initSchema(): void {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"DB_NOT_INITIALIZED\");\n\t\t}\n\t\tthis.db.exec(`\n      CREATE TABLE IF NOT EXISTS snapshots (\n        id TEXT PRIMARY KEY,\n        timestamp INTEGER NOT NULL,\n        name TEXT,\n        protected INTEGER DEFAULT 0,\n        files TEXT,\n        file_contents TEXT,\n        metadata TEXT,\n        content_hash TEXT,\n        created_at INTEGER DEFAULT (strftime('%s', 'now'))\n      );\n\n      CREATE INDEX IF NOT EXISTS idx_timestamp ON snapshots(timestamp DESC);\n      CREATE INDEX IF NOT EXISTS idx_protected ON snapshots(protected);\n      CREATE INDEX IF NOT EXISTS idx_created_at ON snapshots(created_at DESC);\n      CREATE INDEX IF NOT EXISTS idx_name ON snapshots(name);\n      CREATE INDEX IF NOT EXISTS idx_content_hash ON snapshots(content_hash);\n    `);\n\t}\n\n\tasync save(snapshot: Snapshot, contentHash?: string): Promise<void> {\n\t\tawait this.ensureInitialized();\n\t\ttry {\n\t\t\t// Sanitize inputs to prevent injection attacks\n\t\t\tconst sanitizedFiles = sanitizeForJSON(snapshot.files || []);\n\t\t\tconst sanitizedFileContents = sanitizeForJSON(snapshot.fileContents || {});\n\t\t\tconst sanitizedMeta = sanitizeForJSON(snapshot.meta || {});\n\n\t\t\tconst stmt = this.db?.prepare(`\n        INSERT OR REPLACE INTO snapshots (\n          id, timestamp, name, protected, files, file_contents, metadata, content_hash\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\n      `);\n\t\t\tif (!stmt) {\n\t\t\t\tthrow new StorageError(\"Failed to prepare save statement\", \"DB_PREPARE_ERROR\");\n\t\t\t}\n\n\t\t\tstmt.run(\n\t\t\t\tsnapshot.id,\n\t\t\t\tsnapshot.timestamp,\n\t\t\t\tsnapshot.meta?.name || null,\n\t\t\t\tsnapshot.meta?.protected ? 1 : 0,\n\t\t\t\tJSON.stringify(sanitizedFiles),\n\t\t\t\tJSON.stringify(sanitizedFileContents),\n\t\t\t\tJSON.stringify(sanitizedMeta),\n\t\t\t\tcontentHash || null,\n\t\t\t);\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_FULL\") {\n\t\t\t\tthrow new StorageFullError(\"Disk full\", {\n\t\t\t\t\tretryable: false,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_CANTOPEN\") {\n\t\t\t\tthrow new StorageConnectionError(\"Cannot open database\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"Save failed\", error.code, { cause: error });\n\t\t}\n\t}\n\n\tasync get(id: string): Promise<Snapshot | null> {\n\t\tawait this.ensureInitialized();\n\t\ttry {\n\t\t\tconst stmt = this.db?.prepare(\"SELECT * FROM snapshots WHERE id = ?\");\n\t\t\tif (!stmt) {\n\t\t\t\tthrow new StorageError(\"Failed to prepare get statement\", \"DB_PREPARE_ERROR\");\n\t\t\t}\n\t\t\tconst row = stmt.get(id) as any;\n\n\t\t\tif (!row) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn this.deserializeSnapshot(row);\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_CANTOPEN\") {\n\t\t\t\tthrow new StorageConnectionError(\"Cannot open database\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"Get failed\", error.code, { cause: error });\n\t\t}\n\t}\n\n\tasync getByContentHash(hash: string): Promise<Snapshot | null> {\n\t\tawait this.ensureInitialized();\n\t\ttry {\n\t\t\tconst stmt = this.db?.prepare(\"SELECT * FROM snapshots WHERE content_hash = ? LIMIT 1\");\n\t\t\tif (!stmt) {\n\t\t\t\tthrow new StorageError(\"Failed to prepare getByContentHash statement\", \"DB_PREPARE_ERROR\");\n\t\t\t}\n\t\t\tconst row = stmt.get(hash) as any;\n\n\t\t\tif (!row) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn this.deserializeSnapshot(row);\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_CANTOPEN\") {\n\t\t\t\tthrow new StorageConnectionError(\"Cannot open database\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"GetByContentHash failed\", error.code, {\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Get the stored content hash for a snapshot (for preserving hash on updates)\n\t */\n\tasync getStoredContentHash(id: string): Promise<string | null> {\n\t\tawait this.ensureInitialized();\n\t\ttry {\n\t\t\tconst stmt = this.db?.prepare(\"SELECT content_hash FROM snapshots WHERE id = ?\");\n\t\t\tif (!stmt) {\n\t\t\t\tthrow new StorageError(\"Failed to prepare getStoredContentHash statement\", \"DB_PREPARE_ERROR\");\n\t\t\t}\n\t\t\tconst row = stmt.get(id) as any;\n\n\t\t\treturn row?.content_hash || null;\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_CANTOPEN\") {\n\t\t\t\tthrow new StorageConnectionError(\"Cannot open database\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"GetStoredContentHash failed\", error.code, {\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t}\n\n\tasync list(filters?: SnapshotFilters): Promise<Snapshot[]> {\n\t\tawait this.ensureInitialized();\n\t\ttry {\n\t\t\tlet query = \"SELECT * FROM snapshots WHERE 1=1\";\n\t\t\tconst params: any[] = [];\n\n\t\t\tif (filters?.protected !== undefined) {\n\t\t\t\tquery += \" AND protected = ?\";\n\t\t\t\tparams.push(filters.protected ? 1 : 0);\n\t\t\t}\n\n\t\t\tif (filters?.after) {\n\t\t\t\tquery += \" AND timestamp >= ?\";\n\t\t\t\tparams.push(filters.after.getTime());\n\t\t\t}\n\n\t\t\tif (filters?.before) {\n\t\t\t\tquery += \" AND timestamp < ?\";\n\t\t\t\tparams.push(filters.before.getTime());\n\t\t\t}\n\n\t\t\tquery += \" ORDER BY timestamp DESC\";\n\n\t\t\t// Validate that offset is only used with limit for efficient querying\n\t\t\tif (filters?.offset && !filters?.limit) {\n\t\t\t\t// Log a warning about inefficient query pattern\n\t\t\t\tlogger.warn(\n\t\t\t\t\t\"Using OFFSET without LIMIT can lead to inefficient queries. Consider setting a limit for better performance.\",\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (filters?.limit) {\n\t\t\t\tquery += \" LIMIT ?\";\n\t\t\t\tparams.push(filters.limit);\n\t\t\t}\n\n\t\t\tif (filters?.offset) {\n\t\t\t\tquery += \" OFFSET ?\";\n\t\t\t\tparams.push(filters.offset);\n\t\t\t}\n\n\t\t\tconst stmt = this.db?.prepare(query);\n\t\t\tif (!stmt) {\n\t\t\t\tthrow new StorageError(\"Failed to prepare list statement\", \"DB_PREPARE_ERROR\");\n\t\t\t}\n\t\t\tconst rows = stmt.all(...params) as any[];\n\n\t\t\tlet snapshots = rows.map((row) => this.deserializeSnapshot(row));\n\n\t\t\t// Filter by filePath in memory (since files is stored as JSON array)\n\t\t\tif (filters?.filePath) {\n\t\t\t\tsnapshots = snapshots.filter((snapshot) => snapshot.files?.includes(filters.filePath ?? \"\"));\n\t\t\t}\n\n\t\t\treturn snapshots;\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_CANTOPEN\") {\n\t\t\t\tthrow new StorageConnectionError(\"Cannot open database\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"List failed\", error.code, { cause: error });\n\t\t}\n\t}\n\n\tasync delete(id: string): Promise<void> {\n\t\tawait this.ensureInitialized();\n\t\ttry {\n\t\t\tconst stmt = this.db?.prepare(\"DELETE FROM snapshots WHERE id = ?\");\n\t\t\tif (!stmt) {\n\t\t\t\tthrow new StorageError(\"Failed to prepare delete statement\", \"DB_PREPARE_ERROR\");\n\t\t\t}\n\t\t\tstmt.run(id);\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (error.code === \"SQLITE_CANTOPEN\") {\n\t\t\t\tthrow new StorageConnectionError(\"Cannot open database\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"Delete failed\", error.code, {\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t}\n\n\tasync close(): Promise<void> {\n\t\tif (!this.db) {\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tthis.db.close();\n\t\t\tthis.db = null;\n\t\t} catch (error: any) {\n\t\t\tif (error.code === \"SQLITE_BUSY\") {\n\t\t\t\tthrow new StorageLockError(\"Database locked\", {\n\t\t\t\t\tretryable: true,\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"Close failed\", error.code, {\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate deserializeSnapshot(row: any): Snapshot {\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tid: row.id,\n\t\t\t\ttimestamp: row.timestamp,\n\t\t\t\tversion: row.version || \"1.0\",\n\t\t\t\tmeta: JSON.parse(row.metadata || \"{}\"),\n\t\t\t\tfiles: JSON.parse(row.files || \"[]\"),\n\t\t\t\tfileContents: JSON.parse(row.file_contents || \"{}\"),\n\t\t\t};\n\t\t} catch (error: any) {\n\t\t\tthrow new CorruptedDataError(`Failed to deserialize snapshot ${row.id}`, {\n\t\t\t\tcause: error,\n\t\t\t\tsnapshotId: row.id,\n\t\t\t});\n\t\t}\n\t}\n}\n","import type { Snapshot, SnapshotFilters } from \"@snapback-oss/contracts\";\nimport type { StorageAdapter } from \"./StorageAdapter\";\n\n/**\n * In-memory storage implementation\n * Useful for testing and temporary snapshots\n * Data is lost when instance is destroyed\n */\nexport class MemoryStorage implements StorageAdapter {\n\tprivate snapshots: Map<string, Snapshot> = new Map();\n\n\tasync save(snapshot: Snapshot, _contentHash?: string): Promise<void> {\n\t\t// Deep clone to prevent external mutations while preserving types\n\t\t// Note: MemoryStorage doesn't persist contentHash since it's transient\n\t\tthis.snapshots.set(snapshot.id, this.cloneSnapshot(snapshot));\n\t}\n\n\tasync get(id: string): Promise<Snapshot | null> {\n\t\tconst snapshot = this.snapshots.get(id);\n\t\treturn snapshot ? this.cloneSnapshot(snapshot) : null;\n\t}\n\n\tasync list(filters?: SnapshotFilters): Promise<Snapshot[]> {\n\t\tlet snapshots = Array.from(this.snapshots.values());\n\n\t\t// Apply filters\n\t\tif (filters?.filePath) {\n\t\t\tsnapshots = snapshots.filter((s) =>\n\t\t\t\ts.files?.some(\n\t\t\t\t\t(f: string) => f === filters.filePath || (filters.filePath && f.includes(filters.filePath)),\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\n\t\tif (filters?.before) {\n\t\t\tconst beforeMs = filters.before.getTime();\n\t\t\tsnapshots = snapshots.filter((s) => s.timestamp < beforeMs);\n\t\t}\n\n\t\tif (filters?.after) {\n\t\t\tconst afterMs = filters.after.getTime();\n\t\t\tsnapshots = snapshots.filter((s) => s.timestamp >= afterMs);\n\t\t}\n\n\t\tif (filters?.protected !== undefined) {\n\t\t\tsnapshots = snapshots.filter((s) => (s.meta?.protected ?? false) === filters.protected);\n\t\t}\n\n\t\t// Sort by timestamp descending (newest first)\n\t\tsnapshots.sort((a, b) => b.timestamp - a.timestamp);\n\n\t\t// Apply limit\n\t\tif (filters?.limit) {\n\t\t\tsnapshots = snapshots.slice(0, filters.limit);\n\t\t}\n\n\t\t// Deep clone to prevent external mutations while preserving types\n\t\treturn snapshots.map((s) => this.cloneSnapshot(s));\n\t}\n\n\tasync delete(id: string): Promise<void> {\n\t\tthis.snapshots.delete(id);\n\t}\n\n\tasync close(): Promise<void> {\n\t\tthis.snapshots.clear();\n\t}\n\n\t/**\n\t * Deep clone snapshot while preserving type information\n\t */\n\tprivate cloneSnapshot(snapshot: Snapshot): Snapshot {\n\t\t// Use structuredClone if available (Node 17+), otherwise fallback to JSON approach\n\t\tif (typeof structuredClone !== \"undefined\") {\n\t\t\treturn structuredClone(snapshot);\n\t\t}\n\n\t\t// Fallback for older Node versions - should not be reached in modern environments\n\t\treturn structuredClone(snapshot);\n\t}\n\n\t/**\n\t * Get total count of snapshots (for testing)\n\t */\n\tget size(): number {\n\t\treturn this.snapshots.size;\n\t}\n}\n","import type { FileInput, ProtectionConfig } from \"@snapback-oss/contracts\";\nimport { SnapbackAnalyticsClient, SnapbackClient } from \"./client\";\nimport { ProtectionManager } from \"./protection/ProtectionManager\";\nimport { SnapshotManager } from \"./snapshot/SnapshotManager\";\nimport { LocalStorage } from \"./storage/LocalStorage\";\nimport { MemoryStorage } from \"./storage/MemoryStorage\";\nimport type { StorageAdapter } from \"./storage/StorageAdapter\";\n\n// Define the SnapshotFilters interface\nexport interface SnapshotFilters {\n\tlimit?: number;\n\toffset?: number;\n\tprotected?: boolean;\n\tbefore?: Date;\n\tafter?: Date;\n}\n\nexport interface SnapbackOptions {\n\t/**\n\t * Storage configuration\n\t * Can be a path to SQLite database, StorageAdapter instance, or 'memory' for testing\n\t */\n\tstorage?: string | StorageAdapter;\n\n\t/**\n\t * Protection configuration\n\t */\n\tprotection?: ProtectionConfig;\n\n\t/**\n\t * Cloud API configuration (optional)\n\t * If provided, enables cloud sync functionality\n\t */\n\tcloud?: {\n\t\tbaseUrl: string;\n\t\tapiKey: string;\n\t\ttimeout?: number;\n\t\tretries?: number;\n\t};\n\n\t/**\n\t * Enable deduplication for local snapshots\n\t */\n\tenableDeduplication?: boolean;\n\n\t/**\n\t * Auto-protect configuration files\n\t */\n\tautoProtectConfigs?: boolean;\n}\n\n/**\n * Unified Snapback SDK entry point\n * Combines local snapshot management with optional cloud sync\n *\n * @example\n * ```typescript\n * // Local-only mode\n * const snapback = new Snapback({\n *   storage: './snapshots.db',\n *   protection: {\n *     patterns: [{ pattern: '**\\/*.env', level: 'block' }],\n *     defaultLevel: 'watch',\n *     enabled: true\n *   }\n * });\n *\n * // Cloud-enabled mode\n * const snapback = new Snapback({\n *   storage: './snapshots.db',\n *   cloud: {\n *     baseUrl: 'https://api.snapback.dev',\n *     apiKey: 'your-api-key'\n *   }\n * });\n * ```\n */\nexport class Snapback {\n\tprivate storage: StorageAdapter;\n\tprivate snapshotManager: SnapshotManager;\n\tprivate protectionManager: ProtectionManager;\n\tprivate cloudClient?: SnapbackClient;\n\tprivate analyticsClient?: SnapbackAnalyticsClient;\n\n\tconstructor(options: SnapbackOptions) {\n\t\t// Initialize storage\n\t\tif (typeof options.storage === \"string\") {\n\t\t\tif (options.storage === \":memory:\") {\n\t\t\t\tthis.storage = new MemoryStorage();\n\t\t\t} else {\n\t\t\t\tthis.storage = new LocalStorage(options.storage);\n\t\t\t}\n\t\t} else if (options.storage) {\n\t\t\tthis.storage = options.storage;\n\t\t} else {\n\t\t\t// Default to in-memory storage for testing\n\t\t\tthis.storage = new MemoryStorage();\n\t\t}\n\n\t\t// Initialize protection manager\n\t\tconst protectionConfig: ProtectionConfig = {\n\t\t\tpatterns: options.protection?.patterns || [],\n\t\t\tdefaultLevel: options.protection?.defaultLevel || \"watch\",\n\t\t\tenabled: options.protection?.enabled !== false,\n\t\t\tautoProtectConfigs: options.autoProtectConfigs !== false,\n\t\t};\n\n\t\tthis.protectionManager = new ProtectionManager(protectionConfig);\n\n\t\t// Initialize snapshot manager\n\t\tthis.snapshotManager = new SnapshotManager(this.storage, {\n\t\t\tenableDeduplication: options.enableDeduplication,\n\t\t\tautoProtect: options.autoProtectConfigs,\n\t\t});\n\n\t\t// Initialize cloud client if configured\n\t\tif (options.cloud) {\n\t\t\tconst sdkConfig = {\n\t\t\t\tendpoint: options.cloud.baseUrl,\n\t\t\t\tapiKey: options.cloud.apiKey,\n\t\t\t\tprivacy: {\n\t\t\t\t\thashFilePaths: true,\n\t\t\t\t\tanonymizeWorkspace: false,\n\t\t\t\t},\n\t\t\t\tcache: {\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tttl: {\n\t\t\t\t\t\tanalytics: 3600,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tretry: {\n\t\t\t\t\tmaxRetries: options.cloud.retries || 3,\n\t\t\t\t\tbackoffMs: options.cloud.timeout || 1000,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tthis.cloudClient = new SnapbackClient(sdkConfig);\n\t\t\tthis.analyticsClient = new SnapbackAnalyticsClient(sdkConfig);\n\t\t}\n\t}\n\n\t/**\n\t * Create a snapshot of files\n\t * @param files - Files to snapshot\n\t * @param options - Snapshot options\n\t * @returns Created snapshot\n\t */\n\tasync createSnapshot(\n\t\tfiles: Array<{\n\t\t\tpath: string;\n\t\t\tcontent: string;\n\t\t\taction?: \"add\" | \"modify\" | \"delete\";\n\t\t}>,\n\t\toptions?: { description?: string; protected?: boolean },\n\t) {\n\t\tconst fileInputs: FileInput[] = files.map((file) => ({\n\t\t\tpath: file.path,\n\t\t\tcontent: file.content,\n\t\t\taction: file.action || \"modify\",\n\t\t}));\n\t\treturn this.snapshotManager.create(fileInputs, options);\n\t}\n\n\t/**\n\t * Save a single file snapshot\n\t * @param path - File path\n\t * @param content - File content\n\t * @param description - Optional description\n\t * @returns Created snapshot\n\t */\n\tasync save(path: string, content: string, description?: string) {\n\t\treturn this.snapshotManager.create([{ path, content, action: \"modify\" }], { description });\n\t}\n\n\t/**\n\t * List snapshots with optional filters\n\t * @param filters - Filter options\n\t * @returns Array of snapshots\n\t */\n\tasync listSnapshots(filters?: SnapshotFilters) {\n\t\treturn this.snapshotManager.list(filters);\n\t}\n\n\t/**\n\t * Get a specific snapshot by ID\n\t * @param id - Snapshot ID\n\t * @returns Snapshot or null if not found\n\t */\n\tasync getSnapshot(id: string) {\n\t\treturn this.snapshotManager.get(id);\n\t}\n\n\t/**\n\t * Delete a snapshot by ID\n\t * @param id - Snapshot ID\n\t */\n\tasync deleteSnapshot(id: string) {\n\t\treturn this.snapshotManager.delete(id);\n\t}\n\n\t/**\n\t * Restore a snapshot\n\t * @param id - Snapshot ID\n\t * @returns Restore result\n\t */\n\tasync restoreSnapshot(id: string) {\n\t\treturn this.snapshotManager.restore(id);\n\t}\n\n\t/**\n\t * Protect a snapshot\n\t * @param id - Snapshot ID\n\t */\n\tasync protectSnapshot(id: string) {\n\t\treturn this.snapshotManager.protect(id);\n\t}\n\n\t/**\n\t * Unprotect a snapshot\n\t * @param id - Snapshot ID\n\t */\n\tasync unprotectSnapshot(id: string) {\n\t\treturn this.snapshotManager.unprotect(id);\n\t}\n\n\t/**\n\t * Protect a file path\n\t * @param filePath - File path to protect\n\t * @param level - Protection level\n\t * @param reason - Optional reason\n\t */\n\tprotectFile(filePath: string, level: \"watch\" | \"warn\" | \"block\", reason?: string) {\n\t\tthis.protectionManager.protect(filePath, level, reason);\n\t}\n\n\t/**\n\t * Check if a file is protected\n\t * @param filePath - File path to check\n\t * @returns Protection level or null if not protected\n\t */\n\tgetProtectionLevel(filePath: string) {\n\t\treturn this.protectionManager.getLevel(filePath);\n\t}\n\n\t/**\n\t * Close the storage connection\n\t */\n\tasync close() {\n\t\tif (\"close\" in this.storage && typeof this.storage.close === \"function\") {\n\t\t\tawait this.storage.close();\n\t\t}\n\t}\n\n\t/**\n\t * Get the underlying snapshot manager for advanced operations\n\t */\n\tget snapshots() {\n\t\treturn this.snapshotManager;\n\t}\n\n\t/**\n\t * Get the underlying protection manager for advanced operations\n\t */\n\tget protection() {\n\t\treturn this.protectionManager;\n\t}\n\n\t/**\n\t * Get the cloud client if configured\n\t */\n\tget cloud() {\n\t\treturn this.cloudClient;\n\t}\n\n\t/**\n\t * Get the analytics client if configured\n\t */\n\tget analytics() {\n\t\treturn this.analyticsClient;\n\t}\n}\n","/**\n * SessionDeduplication - Prevents duplicate session creation\n *\n * Strategy:\n * - Compute session fingerprint from sorted file change hashes\n * - Check against recent sessions (last 100)\n * - If fingerprint matches AND time delta < threshold, skip creation\n *\n * Performance:\n * - Uses LRU cache for session fingerprints\n * - O(n log n) for sorting, O(1) cache lookup\n */\n\nimport * as crypto from \"node:crypto\";\nimport type { SessionChange } from \"@snapback-oss/contracts/session\";\nimport QuickLRU from \"quick-lru\";\n\n/**\n * Deduplication configuration\n */\nexport interface SessionDeduplicationOptions {\n\t/** Maximum time between sessions to consider duplicates (default: 5 minutes) */\n\ttimeDeltaMs?: number;\n\n\t/** Cache size for session fingerprints (default: 100) */\n\tcacheSize?: number;\n\n\t/** Minimum number of files to trigger deduplication (default: 5) */\n\tminFilesForDedup?: number;\n}\n\n/**\n * Session fingerprint for deduplication\n */\ninterface SessionFingerprint {\n\tfingerprint: string;\n\ttimestamp: number;\n\tsessionId: string;\n\tchangeCount: number;\n}\n\n/**\n * Deduplication result\n */\nexport interface DeduplicationResult {\n\tisDuplicate: boolean;\n\treason?: string;\n\texistingSessionId?: string;\n\tfingerprint: string;\n}\n\n/**\n * SessionDeduplication - Detects and prevents duplicate sessions\n */\nexport class SessionDeduplication {\n\tprivate readonly timeDeltaMs: number;\n\tprivate readonly minFilesForDedup: number;\n\tprivate readonly fingerprintCache: QuickLRU<string, SessionFingerprint>;\n\n\tconstructor(options: SessionDeduplicationOptions = {}) {\n\t\tthis.timeDeltaMs = options.timeDeltaMs ?? 5 * 60 * 1000; // 5 minutes\n\t\tthis.minFilesForDedup = options.minFilesForDedup ?? 5;\n\n\t\tthis.fingerprintCache = new QuickLRU({\n\t\t\tmaxSize: options.cacheSize ?? 100,\n\t\t});\n\t}\n\n\t/**\n\t * Compute session fingerprint from file changes\n\t */\n\tcomputeFingerprint(changes: SessionChange[]): string {\n\t\tif (changes.length === 0) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\t// Extract file paths and operations\n\t\tconst items = changes.map((change) => {\n\t\t\tconst path = change.p;\n\t\t\tconst op = change.op;\n\t\t\tconst hNew = change.hNew || \"\";\n\t\t\tconst hOld = change.hOld || \"\";\n\n\t\t\t// Combine path, operation, and hashes\n\t\t\treturn `${path}:${op}:${hOld}:${hNew}`;\n\t\t});\n\n\t\t// Sort for deterministic fingerprint\n\t\titems.sort();\n\n\t\t// Hash the sorted items\n\t\tconst hash = crypto.createHash(\"sha256\");\n\t\tfor (const item of items) {\n\t\t\thash.update(item);\n\t\t}\n\n\t\treturn hash.digest(\"hex\");\n\t}\n\n\t/**\n\t * Check if session is a duplicate\n\t */\n\tcheckDuplicate(changes: SessionChange[], timestamp: number): DeduplicationResult {\n\t\t// Skip deduplication for small sessions\n\t\tif (changes.length < this.minFilesForDedup) {\n\t\t\tconst fingerprint = this.computeFingerprint(changes);\n\t\t\treturn {\n\t\t\t\tisDuplicate: false,\n\t\t\t\treason: \"Session too small for deduplication\",\n\t\t\t\tfingerprint,\n\t\t\t};\n\t\t}\n\n\t\t// Compute fingerprint\n\t\tconst fingerprint = this.computeFingerprint(changes);\n\n\t\t// Check cache for existing fingerprint\n\t\tconst existing = this.fingerprintCache.get(fingerprint);\n\n\t\tif (!existing) {\n\t\t\t// No duplicate found\n\t\t\treturn {\n\t\t\t\tisDuplicate: false,\n\t\t\t\tfingerprint,\n\t\t\t};\n\t\t}\n\n\t\t// Check time delta\n\t\tconst timeDelta = timestamp - existing.timestamp;\n\n\t\tif (timeDelta > this.timeDeltaMs) {\n\t\t\t// Too much time elapsed, not a duplicate\n\t\t\treturn {\n\t\t\t\tisDuplicate: false,\n\t\t\t\treason: `Time delta ${timeDelta}ms exceeds threshold ${this.timeDeltaMs}ms`,\n\t\t\t\tfingerprint,\n\t\t\t};\n\t\t}\n\n\t\t// Duplicate detected\n\t\treturn {\n\t\t\tisDuplicate: true,\n\t\t\treason: `Duplicate of session ${existing.sessionId} (time delta: ${timeDelta}ms)`,\n\t\t\texistingSessionId: existing.sessionId,\n\t\t\tfingerprint,\n\t\t};\n\t}\n\n\t/**\n\t * Register a session fingerprint\n\t */\n\tregister(sessionId: string, changes: SessionChange[], timestamp: number): void {\n\t\tconst fingerprint = this.computeFingerprint(changes);\n\n\t\tthis.fingerprintCache.set(fingerprint, {\n\t\t\tfingerprint,\n\t\t\ttimestamp,\n\t\t\tsessionId,\n\t\t\tchangeCount: changes.length,\n\t\t});\n\t}\n\n\t/**\n\t * Remove a session fingerprint\n\t */\n\tunregister(sessionId: string): void {\n\t\t// Find and remove all entries for this sessionId\n\t\tfor (const [fingerprint, data] of this.fingerprintCache.entries()) {\n\t\t\tif (data.sessionId === sessionId) {\n\t\t\t\tthis.fingerprintCache.delete(fingerprint);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Clear all fingerprints\n\t */\n\tclear(): void {\n\t\tthis.fingerprintCache.clear();\n\t}\n\n\t/**\n\t * Get cache statistics\n\t */\n\tgetStats(): {\n\t\tsize: number;\n\t\tmaxSize: number;\n\t} {\n\t\treturn {\n\t\t\tsize: this.fingerprintCache.size,\n\t\t\tmaxSize: this.fingerprintCache.maxSize,\n\t\t};\n\t}\n}\n","/**\n * @fileoverview SimpleChangeTracker - Metrics-only change tracking\n *\n * Tracks aggregate metrics for code changes without storing individual events.\n * Determines \"large inserts\" based on multi-line + size thresholds.\n */\n\nexport interface ChangeEvent {\n\tchars: number;\n\tlines: number;\n\tisInsert: boolean;\n\tisMultiLine: boolean;\n}\n\nexport interface ChangeMetrics {\n\ttotalChars: number;\n\ttotalLines: number;\n\tlargeInsertCount: number;\n\tmultiLineInsertCount: number;\n}\n\n/**\n * Threshold for considering an insert \"large\"\n * - Must be multi-line (isMultiLine = true)\n * - AND must be an insert (isInsert = true)\n * - AND must meet minimum size: 100 chars OR 5 lines\n */\nconst LARGE_INSERT_THRESHOLD = {\n\tminChars: 100,\n\tminLines: 5,\n} as const;\n\nexport class SimpleChangeTracker {\n\tprivate totalChars = 0;\n\tprivate totalLines = 0;\n\tprivate largeInsertCount = 0;\n\tprivate multiLineInsertCount = 0;\n\n\t/**\n\t * Records a change event and updates aggregate metrics\n\t */\n\trecordChange(event: ChangeEvent): void {\n\t\tthis.totalChars += event.chars;\n\t\tthis.totalLines += event.lines;\n\n\t\t// Count multi-line inserts\n\t\tif (event.isInsert && event.isMultiLine) {\n\t\t\tthis.multiLineInsertCount++;\n\t\t}\n\n\t\t// Count large inserts: must be insert + multi-line + meet size threshold\n\t\tif (this.isLargeInsert(event)) {\n\t\t\tthis.largeInsertCount++;\n\t\t}\n\t}\n\n\t/**\n\t * Determines if a change qualifies as a \"large insert\"\n\t */\n\tprivate isLargeInsert(event: ChangeEvent): boolean {\n\t\tif (!event.isInsert || !event.isMultiLine) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn event.chars >= LARGE_INSERT_THRESHOLD.minChars || event.lines >= LARGE_INSERT_THRESHOLD.minLines;\n\t}\n\n\t/**\n\t * Returns current aggregate metrics snapshot\n\t */\n\tsnapshot(): ChangeMetrics {\n\t\treturn {\n\t\t\ttotalChars: this.totalChars,\n\t\t\ttotalLines: this.totalLines,\n\t\t\tlargeInsertCount: this.largeInsertCount,\n\t\t\tmultiLineInsertCount: this.multiLineInsertCount,\n\t\t};\n\t}\n\n\t/**\n\t * Clears all accumulated metrics\n\t */\n\treset(): void {\n\t\tthis.totalChars = 0;\n\t\tthis.totalLines = 0;\n\t\tthis.largeInsertCount = 0;\n\t\tthis.multiLineInsertCount = 0;\n\t}\n}\n","/**\n * @fileoverview AiSessionTracker - Session-level AI usage classification\n *\n * Classifies AI assistance level based on:\n * - Environment detection (provider presence)\n * - Change patterns (large inserts, total volume)\n *\n * Key principles:\n * - Truth-first: never claims \"AI wrote this code\"\n * - Confidence capping: inference-only scenarios capped at 7.5\n * - Anti-paste guard: single huge insert  heavy AI usage\n */\n\nimport type { SimpleChangeTracker } from \"./SimpleChangeTracker\";\n\nexport type { ChangeEvent, ChangeMetrics } from \"./SimpleChangeTracker\";\nexport { SimpleChangeTracker } from \"./SimpleChangeTracker\";\n\nexport type AiAssistLevel = \"none\" | \"light\" | \"medium\" | \"heavy\" | \"unknown\";\n\nexport interface AiEnvDetection {\n\tprovider: \"cursor\" | \"claude\" | \"none\" | \"unknown\";\n\thasAI: boolean;\n\tconfidence: number;\n}\n\nexport interface AiSessionResult {\n\tlevel: AiAssistLevel;\n\tconfidence: number;\n\tprovider: AiEnvDetection[\"provider\"];\n\treasoning: string;\n\tmetrics: ReturnType<SimpleChangeTracker[\"snapshot\"]>;\n}\n\n/**\n * Classification thresholds\n */\nconst THRESHOLDS = {\n\t// Light: 1 large insert with modest total chars\n\tlight: {\n\t\tminLargeInserts: 1,\n\t\tmaxTotalChars: 800,\n\t},\n\t// Medium: 2+ large inserts OR higher volume\n\tmedium: {\n\t\tminLargeInserts: 2,\n\t\tminTotalChars: 400,\n\t},\n\t// Heavy: 3+ large inserts AND high total volume\n\theavy: {\n\t\tminLargeInserts: 3,\n\t\tminTotalChars: 2000,\n\t},\n\t// Anti-paste guard: if only 1 large insert, cap at medium regardless of size\n\tmaxLargeInsertsForSinglePaste: 1,\n} as const;\n\n/**\n * Confidence caps\n */\nconst CONFIDENCE = {\n\tunknown: 0,\n\tnoneWithNoProvider: 8.5,\n\tnoneWithProvider: 7.5,\n\tinferenceOnlyCap: 7.5, // When classification is based only on patterns, not provider\n\twithProvider: 9,\n} as const;\n\nexport class AiSessionTracker {\n\tprivate sessionId: string | null = null;\n\n\tconstructor(\n\t\tprivate readonly detectEnv: () => AiEnvDetection,\n\t\tprivate readonly changeTracker: SimpleChangeTracker,\n\t\tprivate isEnabled = true,\n\t) {}\n\n\t/**\n\t * Starts a new session\n\t */\n\tstartSession(sessionId: string): void {\n\t\tthis.sessionId = sessionId;\n\t}\n\n\t/**\n\t * Records a change event\n\t */\n\trecordChange(event: import(\"./SimpleChangeTracker\").ChangeEvent): void {\n\t\tif (!this.isEnabled) {\n\t\t\treturn; // Silent no-op when disabled\n\t\t}\n\t\tthis.changeTracker.recordChange(event);\n\t}\n\n\t/**\n\t * Finalizes the session and returns classification result\n\t */\n\tfinalizeSession(): AiSessionResult {\n\t\t// Early guard: disabled takes priority\n\t\tif (!this.isEnabled) {\n\t\t\treturn {\n\t\t\t\tlevel: \"unknown\",\n\t\t\t\tconfidence: 0,\n\t\t\t\tprovider: \"none\",\n\t\t\t\treasoning: \"AI detection disabled\",\n\t\t\t\tmetrics: this.changeTracker.snapshot(),\n\t\t\t};\n\t\t}\n\n\t\tif (!this.sessionId) {\n\t\t\treturn {\n\t\t\t\tlevel: \"unknown\",\n\t\t\t\tconfidence: CONFIDENCE.unknown,\n\t\t\t\tprovider: \"none\",\n\t\t\t\treasoning: \"No session started\",\n\t\t\t\tmetrics: this.changeTracker.snapshot(),\n\t\t\t};\n\t\t}\n\n\t\t// Capture environment detection at finalization time\n\t\tconst provider = this.detectEnv();\n\n\t\tconst metrics = this.changeTracker.snapshot();\n\t\tconst level = this.classifyLevel(metrics, provider);\n\t\tconst confidence = this.calculateConfidence(level, provider, metrics);\n\t\tconst reasoning = this.generateReasoning(level, provider, metrics);\n\n\t\treturn {\n\t\t\tlevel,\n\t\t\tconfidence,\n\t\t\tprovider: provider.provider,\n\t\t\treasoning,\n\t\t\tmetrics,\n\t\t};\n\t}\n\n\t/**\n\t * Resets session state\n\t */\n\treset(): void {\n\t\tthis.sessionId = null;\n\t\tthis.changeTracker.reset();\n\t}\n\n\tprivate classifyLevel(\n\t\tmetrics: ReturnType<SimpleChangeTracker[\"snapshot\"]>,\n\t\t_provider: AiEnvDetection,\n\t): AiAssistLevel {\n\t\tconst { largeInsertCount, totalChars } = metrics;\n\n\t\t// No large inserts  none (regardless of provider)\n\t\tif (largeInsertCount === 0) {\n\t\t\treturn \"none\";\n\t\t}\n\n\t\t// Anti-paste guard: single large insert (even if huge)  max medium\n\t\tif (largeInsertCount === THRESHOLDS.maxLargeInsertsForSinglePaste) {\n\t\t\t// If it's a modest insert, classify as light\n\t\t\tif (totalChars <= THRESHOLDS.light.maxTotalChars) {\n\t\t\t\treturn \"light\";\n\t\t\t}\n\t\t\t// Otherwise medium (never heavy for single insert)\n\t\t\treturn \"medium\";\n\t\t}\n\n\t\t// Heavy: multiple large inserts + high volume\n\t\tif (largeInsertCount >= THRESHOLDS.heavy.minLargeInserts && totalChars >= THRESHOLDS.heavy.minTotalChars) {\n\t\t\treturn \"heavy\";\n\t\t}\n\n\t\t// Medium: 2+ large inserts OR significant volume\n\t\tif (largeInsertCount >= THRESHOLDS.medium.minLargeInserts || totalChars >= THRESHOLDS.medium.minTotalChars) {\n\t\t\treturn \"medium\";\n\t\t}\n\n\t\t// Light: has large inserts but below medium threshold\n\t\treturn \"light\";\n\t}\n\n\t/**\n\t * Calculates confidence score based on signals available\n\t */\n\tprivate calculateConfidence(\n\t\tlevel: AiAssistLevel,\n\t\tprovider: AiEnvDetection,\n\t\t_metrics: ReturnType<SimpleChangeTracker[\"snapshot\"]>,\n\t): number {\n\t\tif (level === \"unknown\") {\n\t\t\treturn CONFIDENCE.unknown;\n\t\t}\n\n\t\tif (level === \"none\") {\n\t\t\treturn provider.hasAI ? CONFIDENCE.noneWithProvider : CONFIDENCE.noneWithNoProvider;\n\t\t}\n\n\t\t// For non-none classifications based on patterns:\n\t\t// If we have a known provider, use higher confidence\n\t\tif (provider.hasAI && provider.provider !== \"unknown\" && provider.provider !== \"none\") {\n\t\t\t// Still cap below absolute certainty since we're inferring usage from patterns\n\t\t\treturn Math.min(provider.confidence, CONFIDENCE.inferenceOnlyCap);\n\t\t}\n\n\t\t// No provider or unknown provider  cap at inference-only level\n\t\treturn CONFIDENCE.inferenceOnlyCap;\n\t}\n\n\t/**\n\t * Generates human-readable reasoning\n\t */\n\tprivate generateReasoning(\n\t\tlevel: AiAssistLevel,\n\t\tprovider: AiEnvDetection,\n\t\tmetrics: ReturnType<SimpleChangeTracker[\"snapshot\"]>,\n\t): string {\n\t\tif (level === \"unknown\") {\n\t\t\treturn \"No session started\";\n\t\t}\n\n\t\tconst providerName =\n\t\t\tprovider.provider === \"cursor\" ? \"Cursor\" : provider.provider === \"claude\" ? \"Claude\" : null;\n\n\t\tif (level === \"none\") {\n\t\t\tif (providerName) {\n\t\t\t\treturn `${providerName} detected but no large inserts observed`;\n\t\t\t}\n\t\t\treturn \"No AI provider detected, no large inserts\";\n\t\t}\n\n\t\t// For non-none levels, build reasoning\n\t\tconst parts: string[] = [];\n\n\t\t// Provider context\n\t\tif (providerName) {\n\t\t\tparts.push(`${providerName} detected`);\n\t\t} else if (provider.provider === \"unknown\") {\n\t\t\tparts.push(\"No AI provider detected\");\n\t\t}\n\n\t\t// Pattern description\n\t\tconst { largeInsertCount, totalChars } = metrics;\n\n\t\tif (largeInsertCount === 1) {\n\t\t\tparts.push(\"single large insert\");\n\t\t} else {\n\t\t\tparts.push(`${largeInsertCount} large inserts`);\n\t\t}\n\n\t\tparts.push(`(${totalChars} chars total)`);\n\n\t\t// Level-specific suffix\n\t\tif (level === \"heavy\") {\n\t\t\tparts.push(\"- heavy AI-like usage inferred from change patterns\");\n\t\t} else if (level === \"medium\") {\n\t\t\tparts.push(\"- multiple large inserts inferred from change patterns\");\n\t\t} else {\n\t\t\tparts.push(\"- inferred from change patterns\");\n\t\t}\n\n\t\treturn parts.join(\", \");\n\t}\n}\n","/**\n * Privacy-safe analytics factory for session events\n *\n * PRIVACY GUARANTEES:\n * - NO workspace IDs (hashed or not)\n * - NO file paths or filenames\n * - NO token_counts (prevents client name leakage)\n * - K-anonymity: ext_counts only if 3 changes\n * - Solo tier opt-in: ext_counts requires explicit consent\n *\n * These factories are the ONLY safe way to emit session analytics.\n * DO NOT construct analytics events manually elsewhere.\n */\n\nimport type { SessionChange } from \"@snapback-oss/contracts/session\";\n\n/**\n * Session analytics metadata for SESSION_STARTED\n */\nexport interface SessionStartedMeta {\n\tchangeCount: 0;\n\tdurationMs?: number;\n\ttier: \"free\" | \"solo\";\n}\n\n/**\n * Session analytics metadata for SESSION_FINALIZED\n */\nexport interface SessionFinalizedMeta {\n\tchangeCount: number;\n\tdurationMs: number;\n\ttier: \"free\" | \"solo\";\n\text_counts?: Record<string, number>;\n}\n\n/**\n * Create privacy-safe SESSION_STARTED event\n *\n * @param tier - User tier (free or solo)\n * @returns Safe analytics event metadata\n */\nexport function makeSafeSessionStartedEvent(tier: \"free\" | \"solo\"): SessionStartedMeta {\n\treturn {\n\t\tchangeCount: 0,\n\t\ttier,\n\t};\n}\n\n/**\n * Create privacy-safe SESSION_FINALIZED event\n *\n * @param changeCount - Number of file changes tracked\n * @param durationMs - Session duration in milliseconds\n * @param tier - User tier (free or solo)\n * @param consent - User has explicitly consented to analytics (Solo tier only)\n * @param changes - File changes (used only for extension histogram if consent granted)\n * @returns Safe analytics event metadata\n */\nexport function makeSafeSessionFinalizedEvent(\n\tchangeCount: number,\n\tdurationMs: number,\n\ttier: \"free\" | \"solo\",\n\tconsent: boolean,\n\tchanges?: SessionChange[],\n): SessionFinalizedMeta {\n\tconst base: SessionFinalizedMeta = {\n\t\tchangeCount,\n\t\tdurationMs,\n\t\ttier,\n\t};\n\n\t// Only emit ext_counts for Solo tier with consent and 3 changes (k-anonymity)\n\tif (tier === \"solo\" && consent && changeCount >= 3 && changes) {\n\t\tconst extCounts = computeExtensionHistogram(changes);\n\t\tif (Object.keys(extCounts).length > 0) {\n\t\t\tbase.ext_counts = extCounts;\n\t\t}\n\t}\n\n\treturn base;\n}\n\n/**\n * Compute extension histogram from file changes\n * Only extracts file extensions, never paths or names\n *\n * @param changes - Session changes\n * @returns Extension histogram (e.g., {'.ts': 12, '.json': 3})\n */\nfunction computeExtensionHistogram(changes: SessionChange[]): Record<string, number> {\n\tconst counts: Record<string, number> = {};\n\n\tfor (const change of changes) {\n\t\t// Extract extension from relative path\n\t\tconst ext = getFileExtension(change.p);\n\t\tif (ext) {\n\t\t\tcounts[ext] = (counts[ext] || 0) + 1;\n\t\t}\n\t}\n\n\treturn counts;\n}\n\n/**\n * Extract file extension from path\n * Returns null for files without extensions or directories\n *\n * @param path - File path (relative)\n * @returns Extension with dot (e.g., '.ts') or null\n */\nfunction getFileExtension(path: string): string | null {\n\tconst lastDot = path.lastIndexOf(\".\");\n\tconst lastSlash = path.lastIndexOf(\"/\");\n\n\t// No extension or dot is part of directory name\n\tif (lastDot === -1 || lastDot < lastSlash) {\n\t\treturn null;\n\t}\n\n\tconst ext = path.slice(lastDot);\n\n\t// Filter out noise (e.g., '.bak-sessionId', '.tmp')\n\tif (ext.includes(\"-\") || ext.length > 8) {\n\t\treturn null;\n\t}\n\n\treturn ext.toLowerCase();\n}\n","/**\n * SessionManager - Tracks file changes during logical work sessions\n *\n * Design Principles:\n * - Lazy hash computation: Defer SHA-256 hashing until session finalize (<50ms tracking)\n * - POSIX path normalization: Store paths with / separator (cross-platform)\n * - Privacy-safe analytics: No workspace IDs, file paths, or file names transmitted\n * - Idle boundary detection: Auto-finalize after 15 minutes of inactivity\n * - Batch flushing: Persist changes every 50 changes or 5 seconds\n *\n * Performance Budgets:\n * - track(): <50ms (lazy hashing, in-memory buffering)\n * - finalize(): <500ms (batch hash computation, database flush)\n */\n\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport type {\n\tChangeOp,\n\tEOLType,\n\tSessionChange,\n\tSessionManifestV1,\n\tSessionSummary,\n\tSessionTrigger,\n} from \"@snapback-oss/contracts/session\";\nimport { minimatch } from \"minimatch\";\nimport { nanoid } from \"nanoid\";\nimport { AiSessionTracker } from \"../ai/AiSessionTracker\";\nimport { SimpleChangeTracker } from \"../ai/SimpleChangeTracker\";\nimport { CursorDetector } from \"../core/detection/CursorDetector\";\nimport type { BlobStore } from \"../storage/BlobStore\";\nimport { makeSafeSessionFinalizedEvent, makeSafeSessionStartedEvent } from \"./sessionAnalytics\";\n\n/**\n * SessionManager configuration options\n */\nexport interface SessionManagerOptions {\n\t/** VS Code workspace folder URI (multi-root safe) */\n\tworkspaceUri: string;\n\n\t/** Workspace root path (absolute file system path) */\n\tworkspaceRoot: string;\n\n\t/** BlobStore for content-addressable storage */\n\tblobStore: BlobStore;\n\n\t/** Idle timeout in milliseconds (default: 15 minutes) */\n\tidleMs?: number;\n\n\t/** Batch size for flushing changes (default: 50) */\n\tflushBatchSize?: number;\n\n\t/** Flush interval in milliseconds (default: 5 seconds) */\n\tflushIntervalMs?: number;\n\n\t/** Ignore patterns (.snapbackignore) */\n\tignorePatterns?: string[];\n\n\t/** User tier for analytics */\n\ttier?: \"free\" | \"solo\";\n\n\t/** Analytics consent (Solo tier only) */\n\tconsent?: boolean;\n\n\t/** Database connection (SQLite) */\n\tdb?: any; // TODO: Type this properly with better-sqlite3\n\n\t/** AI detection enabled flag (wired from settings) */\n\taiDetectionEnabled?: boolean;\n}\n\n/**\n * Factory function to create AI tracker with Cursor detector\n * Initializes tracker with AI detection enabled setting\n */\nfunction createAiTracker(options: SessionManagerOptions): AiSessionTracker {\n\t// Create Cursor detector with system environment\n\tconst cursorDetector = new CursorDetector({\n\t\tgetAppName: () => {\n\t\t\t// In VS Code context, app name comes from vscode.env.appName\n\t\t\t// For testing, fall back to environment variable\n\t\t\treturn process.env.VSCODE_APP_NAME || process.env.APP_NAME || \"unknown\";\n\t\t},\n\t\tgetEnvVar: (key: string) => process.env[key],\n\t});\n\n\t// Environment detection function (Cursor detection)\n\tconst detectEnv = () => {\n\t\tconst cursorResult = cursorDetector.detect();\n\n\t\t// Return in AiEnvDetection format\n\t\treturn {\n\t\t\tprovider: cursorResult.hasCursor ? (\"cursor\" as const) : (\"none\" as const),\n\t\t\thasAI: cursorResult.hasCursor,\n\t\t\tconfidence: cursorResult.confidence,\n\t\t};\n\t};\n\n\t// Create SimpleChangeTracker internally\n\tconst changeTracker = new SimpleChangeTracker();\n\n\t// Create tracker with AI detection enabled setting\n\tconst tracker = new AiSessionTracker(\n\t\tdetectEnv,\n\t\tchangeTracker,\n\t\toptions.aiDetectionEnabled ?? true, // Default: enabled\n\t);\n\n\treturn tracker;\n}\n\n/**\n * SessionManager configuration options\n */\nexport interface SessionManagerOptions {\n\t/** VS Code workspace folder URI (multi-root safe) */\n\tworkspaceUri: string;\n\n\t/** Workspace root path (absolute file system path) */\n\tworkspaceRoot: string;\n\n\t/** BlobStore for content-addressable storage */\n\tblobStore: BlobStore;\n\n\t/** Idle timeout in milliseconds (default: 15 minutes) */\n\tidleMs?: number;\n\n\t/** Batch size for flushing changes (default: 50) */\n\tflushBatchSize?: number;\n\n\t/** Flush interval in milliseconds (default: 5 seconds) */\n\tflushIntervalMs?: number;\n\n\t/** Ignore patterns (.snapbackignore) */\n\tignorePatterns?: string[];\n\n\t/** User tier for analytics */\n\ttier?: \"free\" | \"solo\";\n\n\t/** Analytics consent (Solo tier only) */\n\tconsent?: boolean;\n\n\t/** Database connection (SQLite) */\n\tdb?: any; // TODO: Type this properly with better-sqlite3\n}\n\n/**\n * Session state for active session\n */\ninterface ActiveSessionState {\n\tsessionId: string;\n\tstartedAt: number;\n\ttriggers: Set<SessionTrigger>;\n\tchangeBuffer: SessionChange[];\n}\n\n/**\n * SessionManager - Core session tracking implementation\n */\nexport class SessionManager {\n\tprivate activeSession: ActiveSessionState | null = null;\n\tprivate idleTimer: NodeJS.Timeout | null = null;\n\tprivate flushTimer: NodeJS.Timeout | null = null;\n\tprivate aiTracker: AiSessionTracker;\n\n\tprivate readonly idleMs: number;\n\tprivate readonly flushBatchSize: number;\n\tprivate readonly flushIntervalMs: number;\n\tprivate readonly ignorePatterns: string[];\n\tprivate readonly tier: \"free\" | \"solo\";\n\tprivate readonly consent: boolean;\n\n\tconstructor(private readonly options: SessionManagerOptions) {\n\t\tthis.idleMs = options.idleMs ?? 15 * 60_000; // 15 minutes\n\t\tthis.flushBatchSize = options.flushBatchSize ?? 50;\n\t\tthis.flushIntervalMs = options.flushIntervalMs ?? 5000; // 5 seconds\n\t\tthis.tier = options.tier ?? \"free\";\n\t\tthis.consent = options.consent ?? false;\n\n\t\t// Initialize AI tracker\n\t\tthis.aiTracker = createAiTracker(options);\n\n\t\t// Default ignore patterns\n\t\tthis.ignorePatterns = options.ignorePatterns ?? [\n\t\t\t\"node_modules/**\",\n\t\t\t\".next/**\",\n\t\t\t\"dist/**\",\n\t\t\t\"build/**\",\n\t\t\t\"coverage/**\",\n\t\t\t\".git/**\",\n\t\t\t\"*.log\",\n\t\t\t\"*.tmp\",\n\t\t\t\"*.swp\",\n\t\t\t\".DS_Store\",\n\t\t];\n\n\t\t// Run crash recovery on initialization (async, non-blocking)\n\t\tthis.runCrashRecovery().catch((err) => {\n\t\t\tconsole.error(\"[SessionManager] Crash recovery failed:\", err);\n\t\t});\n\t}\n\n\t/**\n\t * Run crash recovery on startup\n\t * Recovers any pending rollback transactions that were interrupted\n\t */\n\tprivate async runCrashRecovery(): Promise<void> {\n\t\tconst startTime = performance.now();\n\n\t\tconst { SessionRecovery } = await import(\"./SessionRecovery.js\");\n\t\tconst recovery = new SessionRecovery(this.options.workspaceRoot);\n\n\t\tconst results = await recovery.recoverAll();\n\n\t\tconst duration = performance.now() - startTime;\n\n\t\tif (results.length > 0) {\n\t\t\tconst recovered = results.filter((r) => r.status === \"recovered\").length;\n\t\t\tconst failed = results.filter((r) => r.status === \"failed\").length;\n\t\t\tconst totalFilesRestored = results.reduce((sum, r) => sum + r.filesRestored, 0);\n\n\t\t\tconsole.log(\n\t\t\t\t`[SessionManager] Recovery complete: ${recovered} recovered, ${failed} failed, ${totalFilesRestored} files restored (${duration.toFixed(0)}ms)`,\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Start a new session\n\t */\n\tasync start(): Promise<{ sessionId: string }> {\n\t\t// If there's already an active session, finalize it first\n\t\tif (this.activeSession) {\n\t\t\tawait this.finalize();\n\t\t}\n\n\t\t// Generate session ID\n\t\tconst sessionId = nanoid();\n\t\tconst startedAt = Date.now();\n\n\t\t// Initialize active session state\n\t\tthis.activeSession = {\n\t\t\tsessionId,\n\t\t\tstartedAt,\n\t\t\ttriggers: new Set([\"filewatch\"]),\n\t\t\tchangeBuffer: [],\n\t\t};\n\n\t\t// Insert into database (if available)\n\t\tif (this.options.db) {\n\t\t\tconst triggerBitmask = this.encodeTriggers(this.activeSession.triggers);\n\t\t\tawait this.options.db.run(\n\t\t\t\t`INSERT INTO sessions (session_id, workspace_uri, started_at, triggers, change_count)\n         VALUES (?, ?, ?, ?, 0)`,\n\t\t\t\t[sessionId, this.options.workspaceUri, startedAt, triggerBitmask],\n\t\t\t);\n\t\t}\n\n\t\t// Start idle timer\n\t\tthis.startIdleTimer();\n\n\t\t// Start flush timer\n\t\tthis.startFlushTimer();\n\n\t\t// Start AI detection session\n\t\tthis.aiTracker.startSession(sessionId);\n\n\t\t// Emit analytics: SESSION_STARTED\n\t\tthis.emitSessionStarted();\n\n\t\treturn { sessionId };\n\t}\n\n\t/**\n\t * Track a file change\n\t */\n\ttrack(\n\t\tabsolutePath: string,\n\t\top: ChangeOp,\n\t\tmeta?: {\n\t\t\tfromPath?: string;\n\t\t\toldUri?: string;\n\t\t\tnewUri?: string;\n\t\t\tsize?: number;\n\t\t\tmtime?: number;\n\t\t\tmode?: number;\n\t\t},\n\t): void {\n\t\tconst startTime = performance.now();\n\n\t\tif (!this.activeSession) {\n\t\t\t// No active session - silently ignore\n\t\t\treturn;\n\t\t}\n\n\t\t// Convert to relative POSIX path\n\t\tconst relPath = this.normalizePath(absolutePath);\n\n\t\t// Check ignore patterns\n\t\tif (this.shouldIgnore(relPath)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Extract fromPath for rename operations\n\t\tlet fromPath: string | undefined;\n\t\tif (op === \"renamed\" && meta) {\n\t\t\tif (meta.fromPath) {\n\t\t\t\tfromPath = this.normalizePath(meta.fromPath);\n\t\t\t} else if (meta.oldUri) {\n\t\t\t\t// TODO: Parse VS Code URI properly\n\t\t\t\t// For now, assume it's a file:// URI\n\t\t\t\tconst oldAbsPath = meta.oldUri.replace(\"file://\", \"\");\n\t\t\t\tfromPath = this.normalizePath(oldAbsPath);\n\t\t\t}\n\t\t}\n\n\t\t// Create SessionChange (defer hash computation)\n\t\tconst change: SessionChange = {\n\t\t\tp: relPath,\n\t\t\top,\n\t\t\tfrom: fromPath,\n\t\t\t// Metadata captured immediately\n\t\t\tsizeAfter: meta?.size,\n\t\t\tmtimeAfter: meta?.mtime,\n\t\t\tmodeAfter: meta?.mode,\n\t\t\t// Hashes computed during finalize\n\t\t\t// hOld: undefined,\n\t\t\t// hNew: undefined,\n\t\t};\n\n\t\t// Add to buffer\n\t\tthis.activeSession.changeBuffer.push(change);\n\n\t\t// Record change in AI tracker\n\t\tthis.aiTracker.recordChange({\n\t\t\tchars: change.sizeAfter ?? 0,\n\t\t\tlines: 1, // TODO: Parse actual line count from change\n\t\t\tisInsert: change.op === \"created\",\n\t\t\tisMultiLine: false, // TODO: Determine from content\n\t\t});\n\n\t\t// Reset idle timer (activity detected)\n\t\tthis.resetIdleTimer();\n\n\t\t// Check if we should flush\n\t\tif (this.activeSession.changeBuffer.length >= this.flushBatchSize) {\n\t\t\tthis.scheduleFlush();\n\t\t}\n\n\t\tconst duration = performance.now() - startTime;\n\t\tif (duration > 10) {\n\t\t\tconsole.log(`[SessionManager] track() took ${duration.toFixed(1)}ms (op=${op})`);\n\t\t}\n\t}\n\n\t/**\n\t * Finalize the active session\n\t */\n\tasync finalize(): Promise<{ sessionId: string; changeCount: number }> {\n\t\tconst startTime = performance.now();\n\n\t\tif (!this.activeSession) {\n\t\t\tthrow new Error(\"No active session to finalize\");\n\t\t}\n\n\t\tconst { sessionId, startedAt, triggers, changeBuffer } = this.activeSession;\n\t\tconst changeCount = changeBuffer.length;\n\t\tconst endedAt = Date.now();\n\t\tconst durationMs = endedAt - startedAt;\n\n\t\t// Cancel timers\n\t\tthis.cancelTimers();\n\n\t\t// Add manual trigger if explicitly finalized\n\t\ttriggers.add(\"manual\");\n\n\t\t// Compute deferred hashes (lazy computation)\n\t\tawait this.computeDeferredHashes(changeBuffer);\n\n\t\t// Flush changes to database\n\t\tif (this.options.db && changeBuffer.length > 0) {\n\t\t\tconst stmt = this.options.db.prepare(\n\t\t\t\t`INSERT INTO session_changes\n         (session_id, rel_path, op, from_path, size_after, mtime_after, mode_after, h_old, h_new, eol_after)\n         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n\t\t\t);\n\n\t\t\tfor (const change of changeBuffer) {\n\t\t\t\tstmt.run(\n\t\t\t\t\tsessionId,\n\t\t\t\t\tchange.p,\n\t\t\t\t\tchange.op,\n\t\t\t\t\tchange.from ?? null,\n\t\t\t\t\tchange.sizeAfter ?? null,\n\t\t\t\t\tchange.mtimeAfter ?? null,\n\t\t\t\t\tchange.modeAfter ?? null,\n\t\t\t\t\tchange.hOld ?? null,\n\t\t\t\t\tchange.hNew ?? null,\n\t\t\t\t\tchange.eolAfter ?? null,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Update session in database\n\t\tif (this.options.db) {\n\t\t\tconst triggerBitmask = this.encodeTriggers(triggers);\n\n\t\t\t// Finalize AI detection session and get results\n\t\t\tconst aiResult = this.aiTracker.finalizeSession();\n\n\t\t\t// Update session with AI detection results\n\t\t\tawait this.options.db.run(\n\t\t\t\t`UPDATE sessions\n         SET ended_at = ?, change_count = ?, triggers = ?,\n         ai_assist_level = ?, ai_confidence_score = ?, ai_provider = ?, ai_metadata = ?\n         WHERE session_id = ?`,\n\t\t\t\t[\n\t\t\t\t\tendedAt,\n\t\t\t\t\tchangeCount,\n\t\t\t\t\ttriggerBitmask,\n\t\t\t\t\taiResult.level,\n\t\t\t\t\taiResult.confidence,\n\t\t\t\t\taiResult.provider,\n\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\treasoning: aiResult.reasoning,\n\t\t\t\t\t\tmetrics: aiResult.metrics,\n\t\t\t\t\t}),\n\t\t\t\t\tsessionId,\n\t\t\t\t],\n\t\t\t);\n\n\t\t\t// Generate offline name\n\t\t\tconst name = this.generateOfflineName(changeBuffer);\n\t\t\tawait this.options.db.run(\"UPDATE sessions SET name = ? WHERE session_id = ?\", [name, sessionId]);\n\t\t}\n\n\t\t// Emit analytics: SESSION_FINALIZED\n\t\tthis.emitSessionFinalized(changeCount, durationMs, changeBuffer);\n\n\t\t// Clear active session\n\t\tthis.activeSession = null;\n\n\t\tconst totalDuration = performance.now() - startTime;\n\t\tconsole.log(\n\t\t\t`[SessionManager] finalize() took ${totalDuration.toFixed(0)}ms (sessionId=${sessionId}, changes=${changeCount})`,\n\t\t);\n\n\t\treturn { sessionId, changeCount };\n\t}\n\n\t/**\n\t * Get current session status\n\t */\n\tcurrent(): { sessionId: string | null; changeCount: number } {\n\t\tif (!this.activeSession) {\n\t\t\treturn { sessionId: null, changeCount: 0 };\n\t\t}\n\t\treturn {\n\t\t\tsessionId: this.activeSession.sessionId,\n\t\t\tchangeCount: this.activeSession.changeBuffer.length,\n\t\t};\n\t}\n\n\t/**\n\t * List recent sessions\n\t */\n\tasync list(limit = 20): Promise<SessionSummary[]> {\n\t\tif (!this.options.db) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst rows = await this.options.db.all(\n\t\t\t`SELECT session_id, workspace_uri, started_at, ended_at, name, triggers, change_count\n       FROM sessions\n       WHERE workspace_uri = ?\n       ORDER BY started_at DESC\n       LIMIT ?`,\n\t\t\t[this.options.workspaceUri, limit],\n\t\t);\n\n\t\treturn rows.map((row: any) => ({\n\t\t\tsessionId: row.session_id,\n\t\t\tstartedAt: new Date(row.started_at).toISOString(),\n\t\t\tendedAt: row.ended_at ? new Date(row.ended_at).toISOString() : undefined,\n\t\t\tname: row.name,\n\t\t\tchangeCount: row.change_count,\n\t\t\ttriggers: this.decodeTriggers(row.triggers),\n\t\t}));\n\t}\n\n\t/**\n\t * Get session manifest\n\t */\n\tasync getManifest(sessionId: string): Promise<SessionManifestV1> {\n\t\tif (!this.options.db) {\n\t\t\tthrow new Error(\"Database not available\");\n\t\t}\n\n\t\t// Get session metadata\n\t\tconst session = await this.options.db.get(\"SELECT * FROM sessions WHERE session_id = ?\", [sessionId]);\n\n\t\tif (!session) {\n\t\t\tthrow new Error(`Session not found: ${sessionId}`);\n\t\t}\n\n\t\t// Get file changes\n\t\tconst changes = await this.options.db.all(\"SELECT * FROM session_changes WHERE session_id = ? ORDER BY id\", [\n\t\t\tsessionId,\n\t\t]);\n\n\t\t// Get linked snapshots\n\t\tconst snapshots = await this.options.db.all(\"SELECT snapshot_id FROM session_snapshots WHERE session_id = ?\", [\n\t\t\tsessionId,\n\t\t]);\n\n\t\treturn {\n\t\t\tschema: \"sb.session.v1\",\n\t\t\tsessionId: session.session_id,\n\t\t\tstartedAt: new Date(session.started_at).toISOString(),\n\t\t\tendedAt: session.ended_at ? new Date(session.ended_at).toISOString() : undefined,\n\t\t\tworkspaceUri: session.workspace_uri,\n\t\t\tname: session.name,\n\t\t\ttriggers: this.decodeTriggers(session.triggers),\n\t\t\tchangeCount: session.change_count,\n\t\t\tfilesChanged: changes.map((c: any) => this.dbRowToSessionChange(c)),\n\t\t\tsnapshots: snapshots.map((s: any) => s.snapshot_id),\n\t\t};\n\t}\n\n\t/**\n\t * Rollback a session to its starting state\n\t *\n\t * This is a wrapper that delegates to SessionRollback for the actual rollback logic.\n\t * Returns a Result type for safe error handling.\n\t */\n\tasync rollback(\n\t\tsessionId: string,\n\t\toptions?: import(\"./SessionRollback.js\").RollbackOptions,\n\t): Promise<import(\"./SessionRollback.js\").RollbackResult> {\n\t\t// Get session manifest\n\t\tconst manifest = await this.getManifest(sessionId);\n\n\t\t// Import SessionRollback dynamically to avoid circular dependencies\n\t\tconst { SessionRollback } = await import(\"./SessionRollback.js\");\n\n\t\t// Create rollback instance\n\t\tconst rollback = new SessionRollback(this.options.workspaceRoot, this.options.blobStore);\n\n\t\t// Execute rollback\n\t\treturn rollback.rollback(manifest, options);\n\t}\n\n\t// =========================================================================\n\t// Private Helper Methods\n\t// =========================================================================\n\n\t/**\n\t * Normalize path to POSIX-style relative path\n\t */\n\tprivate normalizePath(absolutePath: string): string {\n\t\tconst relPath = path.relative(this.options.workspaceRoot, absolutePath);\n\t\t// Convert Windows backslashes to forward slashes\n\t\treturn relPath.split(path.sep).join(\"/\");\n\t}\n\n\t/**\n\t * Check if path should be ignored\n\t */\n\tprivate shouldIgnore(relPath: string): boolean {\n\t\treturn this.ignorePatterns.some((pattern) => minimatch(relPath, pattern, { dot: true }));\n\t}\n\n\t/**\n\t * Compute deferred SHA-256 hashes\n\t */\n\tprivate async computeDeferredHashes(changes: SessionChange[]): Promise<void> {\n\t\tfor (const change of changes) {\n\t\t\tconst absPath = path.join(this.options.workspaceRoot, change.p);\n\n\t\t\ttry {\n\t\t\t\t// Compute hNew for created/modified files\n\t\t\t\tif (change.op !== \"deleted\") {\n\t\t\t\t\tconst content = await fs.readFile(absPath);\n\t\t\t\t\tconst result = await this.options.blobStore.put(content);\n\t\t\t\t\tif (result.ok) {\n\t\t\t\t\t\tchange.hNew = result.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// TODO: Compute hOld for modified/deleted files\n\t\t\t\t// This requires reading the old content from BlobStore or file backup\n\t\t\t} catch (error) {\n\t\t\t\t// File may have been deleted/moved - skip hash computation\n\t\t\t\tconsole.warn(`Failed to hash ${change.p}:`, error);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Generate offline session name from file changes\n\t */\n\tprivate generateOfflineName(changes: SessionChange[]): string {\n\t\tif (changes.length === 0) {\n\t\t\treturn \"Empty session\";\n\t\t}\n\n\t\t// Extract unique file stems (without extension)\n\t\tconst stems = new Set<string>();\n\t\tfor (const change of changes.slice(0, 10)) {\n\t\t\tconst basename = path.basename(change.p, path.extname(change.p));\n\t\t\tstems.add(basename);\n\t\t}\n\n\t\tconst stemList = Array.from(stems).slice(0, 3);\n\t\tif (stemList.length === 0) {\n\t\t\treturn `Updated ${changes.length} files`;\n\t\t}\n\n\t\treturn `Updated ${stemList.join(\", \")}`;\n\t}\n\n\t/**\n\t * Encode trigger set to bitmask\n\t */\n\tprivate encodeTriggers(triggers: Set<SessionTrigger>): number {\n\t\tlet mask = 0;\n\t\tfor (const trigger of triggers) {\n\t\t\tif (trigger === \"filewatch\") {\n\t\t\t\tmask |= 1;\n\t\t\t}\n\t\t\tif (trigger === \"pre-commit\") {\n\t\t\t\tmask |= 2;\n\t\t\t}\n\t\t\tif (trigger === \"manual\") {\n\t\t\t\tmask |= 4;\n\t\t\t}\n\t\t\tif (trigger === \"idle-finalize\") {\n\t\t\t\tmask |= 8;\n\t\t\t}\n\t\t}\n\t\treturn mask;\n\t}\n\n\t/**\n\t * Decode bitmask to trigger array\n\t */\n\tprivate decodeTriggers(mask: number): SessionTrigger[] {\n\t\tconst triggers: SessionTrigger[] = [];\n\t\tif (mask & 1) {\n\t\t\ttriggers.push(\"filewatch\");\n\t\t}\n\t\tif (mask & 2) {\n\t\t\ttriggers.push(\"pre-commit\");\n\t\t}\n\t\tif (mask & 4) {\n\t\t\ttriggers.push(\"manual\");\n\t\t}\n\t\tif (mask & 8) {\n\t\t\ttriggers.push(\"idle-finalize\");\n\t\t}\n\t\treturn triggers;\n\t}\n\n\t/**\n\t * Convert database row to SessionChange\n\t */\n\tprivate dbRowToSessionChange(row: any): SessionChange {\n\t\treturn {\n\t\t\tp: row.rel_path,\n\t\t\top: row.op as ChangeOp,\n\t\t\tfrom: row.from_path ?? undefined,\n\t\t\thOld: row.h_old ?? undefined,\n\t\t\thNew: row.h_new ?? undefined,\n\t\t\tsizeBefore: row.size_before ?? undefined,\n\t\t\tsizeAfter: row.size_after ?? undefined,\n\t\t\tmtimeBefore: row.mtime_before ?? undefined,\n\t\t\tmtimeAfter: row.mtime_after ?? undefined,\n\t\t\tmodeBefore: row.mode_before ?? undefined,\n\t\t\tmodeAfter: row.mode_after ?? undefined,\n\t\t\teolBefore: row.eol_before as EOLType | undefined,\n\t\t\teolAfter: row.eol_after as EOLType | undefined,\n\t\t};\n\t}\n\n\t/**\n\t * Start idle timer\n\t */\n\tprivate startIdleTimer(): void {\n\t\tthis.idleTimer = setTimeout(() => {\n\t\t\tthis.autoFinalize();\n\t\t}, this.idleMs);\n\t}\n\n\t/**\n\t * Reset idle timer (activity detected)\n\t */\n\tprivate resetIdleTimer(): void {\n\t\tif (this.idleTimer) {\n\t\t\tclearTimeout(this.idleTimer);\n\t\t}\n\t\tthis.startIdleTimer();\n\t}\n\n\t/**\n\t * Start flush timer\n\t */\n\tprivate startFlushTimer(): void {\n\t\tthis.flushTimer = setTimeout(() => {\n\t\t\tthis.scheduleFlush();\n\t\t}, this.flushIntervalMs);\n\t}\n\n\t/**\n\t * Schedule a flush operation\n\t */\n\tprivate scheduleFlush(): void {\n\t\t// TODO: Implement periodic flushing to database\n\t\t// For now, we flush everything during finalize\n\t}\n\n\t/**\n\t * Cancel all timers\n\t */\n\tprivate cancelTimers(): void {\n\t\tif (this.idleTimer) {\n\t\t\tclearTimeout(this.idleTimer);\n\t\t\tthis.idleTimer = null;\n\t\t}\n\t\tif (this.flushTimer) {\n\t\t\tclearTimeout(this.flushTimer);\n\t\t\tthis.flushTimer = null;\n\t\t}\n\t}\n\n\t/**\n\t * Auto-finalize on idle timeout\n\t */\n\tprivate async autoFinalize(): Promise<void> {\n\t\tif (!this.activeSession) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Add idle-finalize trigger\n\t\tthis.activeSession.triggers.add(\"idle-finalize\");\n\n\t\t// Finalize session\n\t\tawait this.finalize();\n\t}\n\n\t/**\n\t * Emit SESSION_STARTED analytics event\n\t */\n\tprivate emitSessionStarted(): void {\n\t\tconst event = makeSafeSessionStartedEvent(this.tier);\n\t\t// TODO: Wire to actual analytics client when available\n\t\tconsole.log(\"[SessionManager] SESSION_STARTED:\", event);\n\t}\n\n\t/**\n\t * Emit SESSION_FINALIZED analytics event\n\t */\n\tprivate emitSessionFinalized(changeCount: number, durationMs: number, changes: SessionChange[]): void {\n\t\tconst event = makeSafeSessionFinalizedEvent(changeCount, durationMs, this.tier, this.consent, changes);\n\t\t// TODO: Wire to actual analytics client when available\n\t\tconsole.log(\"[SessionManager] SESSION_FINALIZED:\", event);\n\t}\n}\n","/**\n * Session Module - Session-based change tracking exports\n */\n\nexport * from \"./SessionDeduplication\";\nexport * from \"./SessionManager\";\nexport * from \"./SessionRecovery\";\nexport * from \"./SessionRollback\";\nexport * from \"./sessionAnalytics\";\n","/**\n * FileConflictResolver.ts\n *\n * Platform-agnostic file conflict resolution for snapshot restore operations.\n * Handles file path conflicts, atomic writes, and permission issues.\n *\n * Features:\n * - Atomic write pattern (temp file + rename)\n * - Permission validation before write\n * - File rename/move detection via content hashing\n * - Filename similarity matching (Levenshtein distance)\n *\n * @module snapshot/FileConflictResolver\n * @performance Atomic write < 100ms for typical files\n *\n * @example\n * ```typescript\n * import { FileConflictResolver } from '@snapback-oss/sdk';\n *\n * const resolver = new FileConflictResolver({\n *   fileSearchProvider: mySearchProvider, // Optional, for findRenamedFile\n *   logger: myLogger // Optional\n * });\n *\n * // Restore a file with conflict handling\n * const result = await resolver.resolveAndWrite(\n *   '/path/to/file.ts',\n *   'file contents',\n *   { created: Date.now() }\n * );\n * ```\n */\n\nimport * as crypto from \"node:crypto\";\nimport * as fsSync from \"node:fs\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport type { ILogger } from \"../core/session/interfaces\";\nimport { NoOpLogger } from \"../core/session/interfaces\";\n\n/**\n * Result of a conflict resolution operation\n */\nexport interface ConflictResult {\n\t/** Whether the conflict was successfully resolved */\n\tresolved: boolean;\n\t/** Action taken to resolve the conflict */\n\taction: \"restored\" | \"skipped\" | \"merged\";\n\t/** Target file path */\n\tpath: string;\n\t/** Error if resolution failed */\n\terror?: Error;\n}\n\n/**\n * Metadata about the original file being restored\n */\nexport interface RestoreMetadata {\n\t/** Original creation timestamp (milliseconds since epoch) */\n\tcreated: number;\n\t/** Original file permissions (optional) */\n\tpermissions?: number;\n}\n\n/**\n * File search result for rename detection\n */\nexport interface FileSearchResult {\n\t/** File path */\n\tpath: string;\n\t/** File content (for hash comparison) */\n\tcontent?: string;\n}\n\n/**\n * Provider interface for file search operations (platform-specific)\n *\n * This allows the conflict resolver to search for renamed/moved files\n * without depending on a specific platform (e.g., VS Code workspace API).\n */\nexport interface IFileSearchProvider {\n\t/**\n\t * Find files matching a pattern in the workspace\n\t *\n\t * @param workspaceRoot - Root directory to search\n\t * @param extension - File extension to filter by (e.g., \".ts\")\n\t * @param excludePattern - Glob pattern to exclude (e.g., \"node_modules\")\n\t * @param maxResults - Maximum number of results to return\n\t * @returns Array of file paths matching the pattern\n\t */\n\tfindFiles(\n\t\tworkspaceRoot: string,\n\t\textension: string,\n\t\texcludePattern?: string,\n\t\tmaxResults?: number,\n\t): Promise<string[]>;\n\n\t/**\n\t * Read file content for hash comparison\n\t *\n\t * @param filePath - Path to the file\n\t * @returns File content as string\n\t */\n\treadFile(filePath: string): Promise<string>;\n}\n\n/**\n * Options for FileConflictResolver\n */\nexport interface FileConflictResolverOptions {\n\t/** Logger instance for debug output */\n\tlogger?: ILogger;\n\t/** File search provider for rename detection (optional) */\n\tfileSearchProvider?: IFileSearchProvider;\n\t/** Workspace root for relative path operations (optional) */\n\tworkspaceRoot?: string;\n}\n\n/**\n * FileConflictResolver - Handles file conflicts during snapshot restore\n *\n * Provides platform-agnostic conflict resolution with:\n * - Atomic write operations (temp file + rename pattern)\n * - Permission validation\n * - File rename/move detection\n * - Filename similarity matching\n */\nexport class FileConflictResolver {\n\tprivate readonly logger: ILogger;\n\tprivate readonly fileSearchProvider?: IFileSearchProvider;\n\tprivate readonly workspaceRoot?: string;\n\n\tconstructor(options: FileConflictResolverOptions = {}) {\n\t\tthis.logger = options.logger ?? new NoOpLogger();\n\t\tthis.fileSearchProvider = options.fileSearchProvider;\n\t\tthis.workspaceRoot = options.workspaceRoot;\n\t}\n\n\t/**\n\t * Attempt to restore a file, handling conflicts.\n\t * Uses atomic write pattern: write to temp file, then rename.\n\t *\n\t * @param targetPath - Path where the file should be restored\n\t * @param content - File content to write\n\t * @param _originalMetadata - Original file metadata (for future use)\n\t * @returns Conflict resolution result\n\t *\n\t * @performance < 100ms for typical files\n\t */\n\tasync resolveAndWrite(\n\t\ttargetPath: string,\n\t\tcontent: string,\n\t\t_originalMetadata: RestoreMetadata,\n\t): Promise<ConflictResult> {\n\t\ttry {\n\t\t\t// 1. Check write permissions\n\t\t\tconst hasPermission = await this.checkPermissions(targetPath);\n\t\t\tif (!hasPermission) {\n\t\t\t\tthis.logger.debug(\"No write permission for target path\", { targetPath });\n\t\t\t\treturn {\n\t\t\t\t\tresolved: false,\n\t\t\t\t\taction: \"skipped\",\n\t\t\t\t\tpath: targetPath,\n\t\t\t\t\terror: new Error(`No write permission for ${targetPath}`),\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// 2. Ensure parent directory exists\n\t\t\tconst parentDir = path.dirname(targetPath);\n\t\t\tawait fs.mkdir(parentDir, { recursive: true });\n\n\t\t\t// 3. Atomic write: temp file + rename pattern\n\t\t\tconst tempPath = `${targetPath}.snapback-tmp-${Date.now()}`;\n\t\t\ttry {\n\t\t\t\tawait fs.writeFile(tempPath, content, \"utf8\");\n\t\t\t\tawait fs.rename(tempPath, targetPath);\n\t\t\t} catch (writeError) {\n\t\t\t\t// Clean up temp file on failure\n\t\t\t\ttry {\n\t\t\t\t\tawait fs.unlink(tempPath);\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore cleanup errors\n\t\t\t\t}\n\t\t\t\tthrow writeError;\n\t\t\t}\n\n\t\t\tthis.logger.debug(\"File restored successfully\", { targetPath });\n\t\t\treturn {\n\t\t\t\tresolved: true,\n\t\t\t\taction: \"restored\",\n\t\t\t\tpath: targetPath,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tthis.logger.error(\"Failed to restore file\", error instanceof Error ? error : undefined, { targetPath });\n\t\t\treturn {\n\t\t\t\tresolved: false,\n\t\t\t\taction: \"skipped\",\n\t\t\t\tpath: targetPath,\n\t\t\t\terror: error instanceof Error ? error : new Error(String(error)),\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Detect if a file was renamed/moved since snapshot.\n\t * Uses content hash matching to find moved files.\n\t *\n\t * Requires a fileSearchProvider to be configured.\n\t *\n\t * @param originalPath - Original file path from snapshot\n\t * @param contentHash - SHA-256 hash of the original content\n\t * @returns New file path if found, null otherwise\n\t */\n\tasync findRenamedFile(originalPath: string, contentHash: string): Promise<string | null> {\n\t\tif (!this.fileSearchProvider || !this.workspaceRoot) {\n\t\t\tthis.logger.debug(\"File search not available - no provider or workspace root configured\");\n\t\t\treturn null;\n\t\t}\n\n\t\tconst originalFileName = path.basename(originalPath);\n\t\tconst originalExt = path.extname(originalPath);\n\n\t\ttry {\n\t\t\t// Search for files with same extension\n\t\t\tconst files = await this.fileSearchProvider.findFiles(\n\t\t\t\tthis.workspaceRoot,\n\t\t\t\toriginalExt,\n\t\t\t\t\"**/node_modules/**\",\n\t\t\t\t100,\n\t\t\t);\n\n\t\t\tfor (const filePath of files) {\n\t\t\t\ttry {\n\t\t\t\t\tconst content = await this.fileSearchProvider.readFile(filePath);\n\t\t\t\t\tconst hash = this.hashContent(content);\n\n\t\t\t\t\tif (hash === contentHash) {\n\t\t\t\t\t\t// Found matching content - this is likely the renamed file\n\t\t\t\t\t\tthis.logger.debug(\"Found renamed file by content hash\", { originalPath, newPath: filePath });\n\t\t\t\t\t\treturn filePath;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Also check for similar filename (fuzzy match)\n\t\t\t\t\tconst fileName = path.basename(filePath);\n\t\t\t\t\tif (this.isSimilarFileName(originalFileName, fileName)) {\n\t\t\t\t\t\t// Check if content is at least 80% similar\n\t\t\t\t\t\tconst similarity = this.calculateSimilarity(contentHash, hash);\n\t\t\t\t\t\tif (similarity > 0.8) {\n\t\t\t\t\t\t\tthis.logger.debug(\"Found renamed file by similarity\", {\n\t\t\t\t\t\t\t\toriginalPath,\n\t\t\t\t\t\t\t\tnewPath: filePath,\n\t\t\t\t\t\t\t\tsimilarity,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\treturn filePath;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Skip files that can't be read\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logger.debug(\"Error searching for renamed file\", {\n\t\t\t\toriginalPath,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Verify write permissions before attempting restore.\n\t *\n\t * @param targetPath - Path to check permissions for\n\t * @returns True if write permission is available\n\t */\n\tasync checkPermissions(targetPath: string): Promise<boolean> {\n\t\ttry {\n\t\t\t// Check if file exists\n\t\t\ttry {\n\t\t\t\tawait fs.access(targetPath, fs.constants.W_OK);\n\t\t\t\treturn true;\n\t\t\t} catch {\n\t\t\t\t// File doesn't exist, check parent directory\n\t\t\t\tconst parentDir = path.dirname(targetPath);\n\t\t\t\ttry {\n\t\t\t\t\tawait fs.access(parentDir, fs.constants.W_OK);\n\t\t\t\t\treturn true;\n\t\t\t\t} catch {\n\t\t\t\t\t// Parent doesn't exist, check if we can create it\n\t\t\t\t\tconst rootDir = this.findExistingAncestor(parentDir);\n\t\t\t\t\tif (rootDir) {\n\t\t\t\t\t\tawait fs.access(rootDir, fs.constants.W_OK);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Hash file content using SHA-256\n\t *\n\t * @param content - Content to hash\n\t * @returns SHA-256 hash as hex string\n\t */\n\thashContent(content: string): string {\n\t\treturn crypto.createHash(\"sha256\").update(content).digest(\"hex\");\n\t}\n\n\t/**\n\t * Find the nearest existing ancestor directory.\n\t *\n\t * @param dirPath - Starting directory path\n\t * @returns Nearest existing ancestor path, or null\n\t */\n\tfindExistingAncestor(dirPath: string): string | null {\n\t\tlet current = dirPath;\n\t\tconst root = path.parse(current).root;\n\n\t\twhile (current !== root) {\n\t\t\ttry {\n\t\t\t\tfsSync.accessSync(current);\n\t\t\t\treturn current;\n\t\t\t} catch {\n\t\t\t\tcurrent = path.dirname(current);\n\t\t\t}\n\t\t}\n\n\t\treturn root;\n\t}\n\n\t/**\n\t * Check if two filenames are similar (for rename detection).\n\t *\n\t * Uses multiple heuristics:\n\t * - Exact base name match\n\t * - One name contains the other\n\t * - Levenshtein distance < 30% of max length\n\t *\n\t * @param name1 - First filename\n\t * @param name2 - Second filename\n\t * @returns True if filenames are considered similar\n\t */\n\tisSimilarFileName(name1: string, name2: string): boolean {\n\t\tconst base1 = path.basename(name1, path.extname(name1)).toLowerCase();\n\t\tconst base2 = path.basename(name2, path.extname(name2)).toLowerCase();\n\n\t\t// Same base name\n\t\tif (base1 === base2) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// One contains the other\n\t\tif (base1.includes(base2) || base2.includes(base1)) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Edit distance check (Levenshtein)\n\t\tconst distance = this.levenshteinDistance(base1, base2);\n\t\tconst maxLen = Math.max(base1.length, base2.length);\n\t\treturn distance / maxLen < 0.3; // Less than 30% difference\n\t}\n\n\t/**\n\t * Calculate Levenshtein distance between two strings.\n\t *\n\t * @param str1 - First string\n\t * @param str2 - Second string\n\t * @returns Edit distance as integer\n\t */\n\tlevenshteinDistance(str1: string, str2: string): number {\n\t\tconst m = str1.length;\n\t\tconst n = str2.length;\n\t\tconst dp: number[][] = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));\n\n\t\tfor (let i = 0; i <= m; i++) {\n\t\t\tdp[i][0] = i;\n\t\t}\n\t\tfor (let j = 0; j <= n; j++) {\n\t\t\tdp[0][j] = j;\n\t\t}\n\n\t\tfor (let i = 1; i <= m; i++) {\n\t\t\tfor (let j = 1; j <= n; j++) {\n\t\t\t\tif (str1[i - 1] === str2[j - 1]) {\n\t\t\t\t\tdp[i][j] = dp[i - 1][j - 1];\n\t\t\t\t} else {\n\t\t\t\t\tdp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn dp[m][n];\n\t}\n\n\t/**\n\t * Calculate similarity between two hashes.\n\t *\n\t * Note: SHA-256 hashes are cryptographic - different content produces\n\t * completely different hashes. This returns 1.0 for exact match, 0.0 otherwise.\n\t * For actual content similarity, compare the content directly.\n\t *\n\t * @param hash1 - First hash\n\t * @param hash2 - Second hash\n\t * @returns Similarity score (1.0 = exact match, 0.0 = different)\n\t */\n\tcalculateSimilarity(hash1: string, hash2: string): number {\n\t\treturn hash1 === hash2 ? 1.0 : 0.0;\n\t}\n}\n","/**\n * Retry utility with exponential backoff\n *\n * Provides a unified implementation for retry logic across the codebase.\n * Consolidates 6+ separate retry implementations into a single, well-tested utility.\n *\n * @module retry\n */\n\nexport interface RetryOptions {\n\t/** Maximum number of retry attempts */\n\tmaxAttempts: number;\n\t/** Base delay in milliseconds between retries */\n\tbaseDelayMs: number;\n\t/** Maximum delay cap in milliseconds (default: 30000) */\n\tmaxDelayMs?: number;\n\t/** Add random jitter to prevent thundering herd (default: false) */\n\tjitter?: boolean;\n\t/** Callback invoked before each retry attempt */\n\tonRetry?: (attempt: number, error: Error) => void;\n}\n\n/**\n * Execute an async operation with retry logic and exponential backoff\n *\n * @param operation - Async function to execute\n * @param options - Retry configuration options\n * @returns Result of the operation\n * @throws Last error if all retry attempts fail\n *\n * @example\n * ```typescript\n * // Basic usage with 3 retries\n * const result = await withRetry(\n *   async () => fetch('https://api.example.com/data'),\n *   { maxAttempts: 3, baseDelayMs: 1000 }\n * );\n *\n * // With jitter and retry callback\n * const result = await withRetry(\n *   async () => processData(),\n *   {\n *     maxAttempts: 5,\n *     baseDelayMs: 100,\n *     jitter: true,\n *     onRetry: (attempt, error) => {\n *       logger.warn(`Retry attempt ${attempt} after error`, { error });\n *     }\n *   }\n * );\n * ```\n */\nexport async function withRetry<T>(operation: () => Promise<T>, options: RetryOptions): Promise<T> {\n\tconst { maxAttempts, baseDelayMs, maxDelayMs = 30000, jitter = false, onRetry } = options;\n\n\tfor (let attempt = 1; attempt <= maxAttempts; attempt++) {\n\t\ttry {\n\t\t\treturn await operation();\n\t\t} catch (error) {\n\t\t\t// Re-throw on last attempt\n\t\t\tif (attempt === maxAttempts) {\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\t// Calculate backoff delay\n\t\t\tconst delay = calculateBackoff(attempt, baseDelayMs, maxDelayMs, jitter);\n\n\t\t\t// Invoke callback if provided\n\t\t\tif (onRetry) {\n\t\t\t\tonRetry(attempt, error instanceof Error ? error : new Error(String(error)));\n\t\t\t}\n\n\t\t\t// Wait before next retry\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, delay));\n\t\t}\n\t}\n\n\t// TypeScript exhaustiveness check\n\tthrow new Error(\"Retry failed - should never reach\");\n}\n\n/**\n * Calculate exponential backoff delay with optional jitter\n *\n * Formula: min(baseMs * 2^(attempt - 1), maxMs) [+ jitter]\n *\n * @param attempt - Current attempt number (1-based)\n * @param baseMs - Base delay in milliseconds\n * @param maxMs - Maximum delay cap\n * @param jitter - Whether to add random jitter (0-100% of calculated delay)\n * @returns Delay in milliseconds\n *\n * @example\n * ```typescript\n * // Attempt 1: 1000ms\n * // Attempt 2: 2000ms\n * // Attempt 3: 4000ms\n * const delay = calculateBackoff(3, 1000, 30000, false); // 4000\n * ```\n */\nexport function calculateBackoff(attempt: number, baseMs: number, maxMs: number, jitter: boolean): number {\n\t// Exponential backoff: baseMs * 2^(attempt - 1)\n\tconst exponential = baseMs * 2 ** (attempt - 1);\n\n\t// Cap at maximum delay\n\tconst capped = Math.min(exponential, maxMs);\n\n\t// Add jitter if enabled (random 0-100% of delay)\n\tif (jitter) {\n\t\tconst jitterAmount = Math.random() * capped;\n\t\treturn capped + jitterAmount;\n\t}\n\n\treturn capped;\n}\n\n/**\n * Get recommended retry options for common scenarios\n */\nexport const RetryPresets = {\n\t/** Fast retries for network requests (max 5s delay) */\n\tnetwork: {\n\t\tmaxAttempts: 3,\n\t\tbaseDelayMs: 1000,\n\t\tmaxDelayMs: 5000,\n\t\tjitter: true,\n\t} as RetryOptions,\n\n\t/** Medium retries for API calls (max 30s delay) */\n\tapi: {\n\t\tmaxAttempts: 5,\n\t\tbaseDelayMs: 2000,\n\t\tmaxDelayMs: 30000,\n\t\tjitter: true,\n\t} as RetryOptions,\n\n\t/** Aggressive retries for critical operations (max 1min delay) */\n\tcritical: {\n\t\tmaxAttempts: 10,\n\t\tbaseDelayMs: 1000,\n\t\tmaxDelayMs: 60000,\n\t\tjitter: true,\n\t} as RetryOptions,\n\n\t/** Quick retries for fast operations (max 2s delay) */\n\tfast: {\n\t\tmaxAttempts: 3,\n\t\tbaseDelayMs: 100,\n\t\tmaxDelayMs: 2000,\n\t\tjitter: false,\n\t} as RetryOptions,\n} as const;\n","/**\n * Snapshot Retry Hook with Automatic Error Resolution\n *\n * Provides intelligent retry logic for snapshot creation failures with:\n * - Automatic error diagnosis\n * - Path resolution fixes\n * - Working directory correction\n * - Clear user feedback\n *\n * @module snapshot/retry-hook\n */\n\nimport * as fs from \"node:fs\";\nimport * as path from \"node:path\";\nimport type { Result } from \"../utils/result.js\";\nimport { err, ok } from \"../utils/result.js\";\nimport { calculateBackoff } from \"../utils/retry.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Error types that can be diagnosed and potentially auto-fixed\n */\nexport type DiagnosisType =\n\t| \"FILE_NOT_FOUND\"\n\t| \"ABSOLUTE_PATH_REJECTED\"\n\t| \"PERMISSION_DENIED\"\n\t| \"WORKSPACE_MISMATCH\"\n\t| \"WORKING_DIRECTORY_MISMATCH\"\n\t| \"STORAGE_FULL\"\n\t| \"UNKNOWN\";\n\n/**\n * Diagnostic information about snapshot failure\n */\nexport interface SnapshotDiagnosis {\n\t/** Type of error identified */\n\ttype: DiagnosisType;\n\t/** Human-readable message describing the issue */\n\tmessage: string;\n\t/** Root cause analysis */\n\tcause: string;\n\t/** Suggested fix to resolve the issue */\n\tsuggestedFix: string;\n\t/** Action required from user (or \"Automatic\" if auto-fixable) */\n\tuserAction: string;\n\t/** Whether this error can be automatically fixed */\n\tcanAutoFix: boolean;\n\t/** Confidence level of diagnosis (0-1) */\n\tconfidence: number;\n\t/** Files affected by this error */\n\taffectedFiles?: string[];\n}\n\n/**\n * Snapshot creation parameters\n */\nexport interface SnapshotParams {\n\t/** Files to include in snapshot */\n\tfiles: string[];\n\t/** Reason for creating snapshot */\n\treason: string;\n\t/** What triggered the snapshot */\n\ttrigger: \"manual\" | \"mcp\" | \"ai_assist\" | \"session_end\" | \"pre_commit\";\n\t/** Workspace root directory */\n\tworkspaceRoot?: string;\n\t/** How to handle missing files */\n\tonMissingFile?: \"error\" | \"warn\" | \"skip\";\n\t/** Whether to suggest alternatives for missing files */\n\tsuggestAlternatives?: boolean;\n}\n\n/**\n * Result of snapshot creation with retry\n */\nexport interface SnapshotRetryResult<T> {\n\t/** Whether snapshot was created successfully */\n\tsuccess: boolean;\n\t/** The created snapshot (if successful) */\n\tsnapshot?: T;\n\t/** Error message (if failed) */\n\terror?: string;\n\t/** Suggestion for user action */\n\tsuggestion?: string;\n\t/** Detailed diagnostics (if failed) */\n\tdiagnostics?: SnapshotDiagnosis;\n\t/** Which attempt succeeded (1-based) */\n\tattempt?: number;\n\t/** Total attempts made */\n\ttotalAttempts?: number;\n}\n\n/**\n * Configuration for retry behavior\n */\nexport interface RetryConfig {\n\t/** Maximum number of retry attempts */\n\tmaxRetries: number;\n\t/** Base delay in milliseconds */\n\tdelayMs: number;\n\t/** Use exponential backoff */\n\texponentialBackoff: boolean;\n\t/** Enable automatic fixes */\n\tautoFix: boolean;\n\t/** Enable verbose logging */\n\tverbose: boolean;\n}\n\n// =============================================================================\n// DIAGNOSIS FUNCTIONS\n// =============================================================================\n\n/**\n * Diagnose why a snapshot creation failed\n *\n * @param error - The error that occurred\n * @param files - Files that were being snapshotted\n * @param workspaceRoot - The workspace root directory\n * @returns Diagnosis with suggested fixes\n */\nexport function diagnoseSnapshotFailure(error: unknown, files: string[], workspaceRoot: string): SnapshotDiagnosis {\n\tconst errorMessage = error instanceof Error ? error.message : String(error);\n\n\t// FILE_NOT_FOUND - File doesn't exist\n\tif (\n\t\terrorMessage.includes(\"ENOENT\") ||\n\t\terrorMessage.includes(\"no such file\") ||\n\t\terrorMessage.toLowerCase().includes(\"file not found\")\n\t) {\n\t\tconst missingFiles = files.filter((f) => {\n\t\t\tconst fullPath = path.isAbsolute(f) ? f : path.join(workspaceRoot, f);\n\t\t\treturn !fs.existsSync(fullPath);\n\t\t});\n\n\t\treturn {\n\t\t\ttype: \"FILE_NOT_FOUND\",\n\t\t\tmessage: \"One or more files do not exist\",\n\t\t\tcause: \"The specified file paths could not be found on disk\",\n\t\t\tsuggestedFix: \"Check file paths and ensure files exist\",\n\t\t\tuserAction:\n\t\t\t\tmissingFiles.length > 0\n\t\t\t\t\t? `Create missing files: ${missingFiles.join(\", \")}`\n\t\t\t\t\t: \"Verify file paths are correct\",\n\t\t\tcanAutoFix: false,\n\t\t\tconfidence: 0.95,\n\t\t\taffectedFiles: missingFiles.length > 0 ? missingFiles : undefined,\n\t\t};\n\t}\n\n\t// ABSOLUTE_PATH_REJECTED - Absolute paths when relative expected\n\tif (errorMessage.includes(\"absolute\") || errorMessage.includes(\"Absolute paths not allowed\")) {\n\t\tconst absolutePaths = files.filter((f) => path.isAbsolute(f));\n\n\t\treturn {\n\t\t\ttype: \"ABSOLUTE_PATH_REJECTED\",\n\t\t\tmessage: \"Snapshot tool requires relative paths\",\n\t\t\tcause: \"Absolute paths were provided instead of relative paths\",\n\t\t\tsuggestedFix: \"Convert absolute paths to relative paths from workspace root\",\n\t\t\tuserAction: \"Automatic: Converting to relative paths\",\n\t\t\tcanAutoFix: true,\n\t\t\tconfidence: 1.0,\n\t\t\taffectedFiles: absolutePaths,\n\t\t};\n\t}\n\n\t// PERMISSION_DENIED - No read access\n\tif (errorMessage.includes(\"EACCES\") || errorMessage.includes(\"permission denied\")) {\n\t\treturn {\n\t\t\ttype: \"PERMISSION_DENIED\",\n\t\t\tmessage: \"Permission denied when accessing files\",\n\t\t\tcause: \"The current user does not have read permission for one or more files\",\n\t\t\tsuggestedFix: \"Check file permissions or run with appropriate privileges\",\n\t\t\tuserAction: \"Run: chmod +r <file> or check file ownership\",\n\t\t\tcanAutoFix: false,\n\t\t\tconfidence: 0.9,\n\t\t};\n\t}\n\n\t// WORKSPACE_MISMATCH - Wrong workspace root\n\tif (errorMessage.includes(\"workspace\") || errorMessage.includes(\"outside workspace\")) {\n\t\treturn {\n\t\t\ttype: \"WORKSPACE_MISMATCH\",\n\t\t\tmessage: \"Files are outside the workspace root\",\n\t\t\tcause: \"The workspace root does not contain all specified files\",\n\t\t\tsuggestedFix: \"Ensure all files are within the workspace directory\",\n\t\t\tuserAction: \"Automatic: Resolving paths from correct workspace root\",\n\t\t\tcanAutoFix: true,\n\t\t\tconfidence: 0.85,\n\t\t};\n\t}\n\n\t// WORKING_DIRECTORY_MISMATCH - Wrong CWD\n\tif (errorMessage.includes(\"cwd\") || errorMessage.includes(\"working directory\")) {\n\t\treturn {\n\t\t\ttype: \"WORKING_DIRECTORY_MISMATCH\",\n\t\t\tmessage: \"Current working directory mismatch\",\n\t\t\tcause: \"The process is not running from the expected workspace root\",\n\t\t\tsuggestedFix: \"Change to the correct working directory\",\n\t\t\tuserAction: \"Automatic: Adjusting paths for current directory\",\n\t\t\tcanAutoFix: true,\n\t\t\tconfidence: 0.8,\n\t\t};\n\t}\n\n\t// STORAGE_FULL - No disk space\n\tif (errorMessage.includes(\"ENOSPC\") || errorMessage.includes(\"no space\")) {\n\t\treturn {\n\t\t\ttype: \"STORAGE_FULL\",\n\t\t\tmessage: \"Insufficient disk space\",\n\t\t\tcause: \"The disk does not have enough free space for the snapshot\",\n\t\t\tsuggestedFix: \"Free up disk space and try again\",\n\t\t\tuserAction: \"Clear temporary files or expand disk storage\",\n\t\t\tcanAutoFix: false,\n\t\t\tconfidence: 0.95,\n\t\t};\n\t}\n\n\t// UNKNOWN - Catch-all\n\treturn {\n\t\ttype: \"UNKNOWN\",\n\t\tmessage: \"Unknown error during snapshot creation\",\n\t\tcause: errorMessage,\n\t\tsuggestedFix: \"Check the error message and logs for details\",\n\t\tuserAction: \"Review error details and try again\",\n\t\tcanAutoFix: false,\n\t\tconfidence: 0.3,\n\t};\n}\n\n/**\n * Apply automatic fix for diagnosed error\n *\n * @param diagnosis - The diagnosis to fix\n * @param context - Mutable context with files and workspace info\n * @returns True if fix was applied\n */\nexport async function applyAutomaticFix(\n\tdiagnosis: SnapshotDiagnosis,\n\tcontext: { files: string[]; workspaceRoot: string },\n): Promise<boolean> {\n\tswitch (diagnosis.type) {\n\t\tcase \"ABSOLUTE_PATH_REJECTED\": {\n\t\t\t// Convert absolute paths to relative\n\t\t\tcontext.files = context.files.map((f) => {\n\t\t\t\tif (path.isAbsolute(f)) {\n\t\t\t\t\treturn path.relative(context.workspaceRoot, f);\n\t\t\t\t}\n\t\t\t\treturn f;\n\t\t\t});\n\t\t\treturn true;\n\t\t}\n\n\t\tcase \"WORKSPACE_MISMATCH\":\n\t\tcase \"WORKING_DIRECTORY_MISMATCH\": {\n\t\t\t// Normalize paths relative to workspace\n\t\t\tcontext.files = context.files.map((f) => {\n\t\t\t\tif (path.isAbsolute(f)) {\n\t\t\t\t\treturn path.relative(context.workspaceRoot, f);\n\t\t\t\t}\n\t\t\t\t// Check if file exists relative to cwd but not workspace\n\t\t\t\tconst fromCwd = path.resolve(process.cwd(), f);\n\t\t\t\tif (fs.existsSync(fromCwd)) {\n\t\t\t\t\treturn path.relative(context.workspaceRoot, fromCwd);\n\t\t\t\t}\n\t\t\t\treturn f;\n\t\t\t});\n\t\t\treturn true;\n\t\t}\n\n\t\tdefault:\n\t\t\treturn false;\n\t}\n}\n\n// =============================================================================\n// RETRY HOOK\n// =============================================================================\n\nconst DEFAULT_RETRY_CONFIG: RetryConfig = {\n\tmaxRetries: 3,\n\tdelayMs: 100,\n\texponentialBackoff: true,\n\tautoFix: true,\n\tverbose: false,\n};\n\n/**\n * Create snapshot with automatic retry and error resolution\n *\n * @param params - Snapshot creation parameters\n * @param snapshotFn - Function to create snapshot (injected for testability)\n * @param config - Retry configuration\n * @returns Result with snapshot or error diagnostics\n *\n * @example\n * ```typescript\n * const result = await createSnapshotWithRetry(\n *   {\n *     files: ['src/index.ts', 'src/utils.ts'],\n *     reason: 'Pre-deployment snapshot',\n *     trigger: 'manual',\n *     workspaceRoot: '/path/to/workspace'\n *   },\n *   async (params) => snapshotManager.create(params.files, { description: params.reason })\n * );\n *\n * if (!result.success) {\n *   console.error(result.error);\n *   console.log('Suggestion:', result.suggestion);\n * }\n * ```\n */\nexport async function createSnapshotWithRetry<T>(\n\tparams: SnapshotParams,\n\tsnapshotFn: (params: SnapshotParams) => Promise<T>,\n\tconfig: Partial<RetryConfig> = {},\n): Promise<SnapshotRetryResult<T>> {\n\tconst cfg = { ...DEFAULT_RETRY_CONFIG, ...config };\n\tconst { workspaceRoot = process.cwd() } = params;\n\n\tlet lastError: Error | null = null;\n\tlet lastDiagnosis: SnapshotDiagnosis | null = null;\n\n\t// Mutable context for auto-fixes\n\tconst context = {\n\t\tfiles: [...params.files],\n\t\tworkspaceRoot,\n\t};\n\n\tfor (let attempt = 1; attempt <= cfg.maxRetries; attempt++) {\n\t\ttry {\n\t\t\tif (cfg.verbose && attempt > 1) {\n\t\t\t\tconsole.error(`[SnapBack Retry] Attempt ${attempt}/${cfg.maxRetries}`);\n\t\t\t}\n\n\t\t\t// Apply delay with exponential backoff\n\t\t\tif (attempt > 1) {\n\t\t\t\tconst delay = cfg.exponentialBackoff\n\t\t\t\t\t? calculateBackoff(attempt - 1, cfg.delayMs, 30000, false)\n\t\t\t\t\t: cfg.delayMs;\n\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, delay));\n\t\t\t}\n\n\t\t\t// Attempt snapshot creation with current context\n\t\t\tconst snapshot = await snapshotFn({\n\t\t\t\t...params,\n\t\t\t\tfiles: context.files,\n\t\t\t});\n\n\t\t\t// Success!\n\t\t\tif (cfg.verbose && attempt > 1) {\n\t\t\t\tconsole.error(`[SnapBack Retry]  Succeeded on attempt ${attempt}`);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tsnapshot,\n\t\t\t\tattempt,\n\t\t\t\ttotalAttempts: attempt,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tlastError = error instanceof Error ? error : new Error(String(error));\n\n\t\t\t// Diagnose the failure\n\t\t\tconst diagnosis = diagnoseSnapshotFailure(error, context.files, context.workspaceRoot);\n\t\t\tlastDiagnosis = diagnosis;\n\n\t\t\tif (cfg.verbose) {\n\t\t\t\tconsole.error(`[SnapBack Retry]  Attempt ${attempt}/${cfg.maxRetries} failed`);\n\t\t\t\tconsole.error(`[SnapBack Retry]  Diagnosis: ${diagnosis.type}`);\n\t\t\t\tconsole.error(`[SnapBack Retry]  ${diagnosis.message}`);\n\t\t\t\tconsole.error(`[SnapBack Retry]  ${diagnosis.suggestedFix}`);\n\t\t\t}\n\n\t\t\t// Try automatic fix if enabled\n\t\t\tif (cfg.autoFix && diagnosis.canAutoFix && attempt < cfg.maxRetries) {\n\t\t\t\tconst fixApplied = await applyAutomaticFix(diagnosis, context);\n\n\t\t\t\tif (fixApplied) {\n\t\t\t\t\tif (cfg.verbose) {\n\t\t\t\t\t\tconsole.error(`[SnapBack Retry]  Applied automatic fix: ${diagnosis.userAction}`);\n\t\t\t\t\t}\n\t\t\t\t\tcontinue; // Retry with fix\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// No fix possible or last attempt - bail out\n\t\t\tif (attempt === cfg.maxRetries) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Log that we're retrying without fix\n\t\t\tif (cfg.verbose && !diagnosis.canAutoFix) {\n\t\t\t\tconsole.error(\"[SnapBack Retry]   No automatic fix available, retrying anyway...\");\n\t\t\t}\n\t\t}\n\t}\n\n\t// All retries exhausted\n\treturn {\n\t\tsuccess: false,\n\t\terror: lastError?.message || \"Unknown error\",\n\t\tsuggestion: lastDiagnosis?.userAction || \"Check logs for details\",\n\t\tdiagnostics: lastDiagnosis || undefined,\n\t\tattempt: cfg.maxRetries,\n\t\ttotalAttempts: cfg.maxRetries,\n\t};\n}\n\n/**\n * Result-based version of createSnapshotWithRetry\n *\n * @param params - Snapshot creation parameters\n * @param snapshotFn - Function to create snapshot\n * @param config - Retry configuration\n * @returns Result<T, SnapshotDiagnosis>\n */\nexport async function createSnapshotWithRetrySafe<T>(\n\tparams: SnapshotParams,\n\tsnapshotFn: (params: SnapshotParams) => Promise<T>,\n\tconfig: Partial<RetryConfig> = {},\n): Promise<Result<T, SnapshotDiagnosis>> {\n\tconst result = await createSnapshotWithRetry(params, snapshotFn, config);\n\n\tif (result.success && result.snapshot) {\n\t\treturn ok(result.snapshot);\n\t}\n\n\treturn err(\n\t\tresult.diagnostics || {\n\t\t\ttype: \"UNKNOWN\",\n\t\t\tmessage: result.error || \"Unknown error\",\n\t\t\tcause: \"Snapshot creation failed after all retries\",\n\t\t\tsuggestedFix: result.suggestion || \"Check logs for details\",\n\t\t\tuserAction: \"Review error and try again\",\n\t\t\tcanAutoFix: false,\n\t\t\tconfidence: 0.1,\n\t\t},\n\t);\n}\n\n/**\n * Format diagnosis for user-friendly output\n */\nexport function formatDiagnosis(diagnosis: SnapshotDiagnosis): string {\n\tconst confidencePercent = Math.round(diagnosis.confidence * 100);\n\tconst autoFixBadge = diagnosis.canAutoFix ? \" Auto-fixable\" : \" Manual fix required\";\n\n\treturn `\n Snapshot Failure Diagnosis\n\n\nType: ${diagnosis.type}\nConfidence: ${confidencePercent}%\n${autoFixBadge}\n\n Issue:\n  ${diagnosis.message}\n\n Root Cause:\n  ${diagnosis.cause}\n\n Suggested Fix:\n  ${diagnosis.suggestedFix}\n\n Action Required:\n  ${diagnosis.userAction}\n${diagnosis.affectedFiles ? `\\n Affected Files:\\n${diagnosis.affectedFiles.map((f) => `  - ${f}`).join(\"\\n\")}` : \"\"}\n`.trim();\n}\n","import type { ILogger } from \"../core/session/interfaces\";\nimport { NoOpLogger } from \"../core/session/interfaces\";\nimport { toError } from \"../utils/errorHelpers\";\n\n/**\n * SnapshotDeletionService - Safe snapshot deletion with confirmation and auto-cleanup\n *\n * Provides intelligent snapshot deletion with multiple safety features:\n * - Protected snapshot guards\n * - User confirmation dialogs\n * - Bulk deletion with age filtering\n * - Automatic cleanup scheduling\n * - Minimum snapshot preservation\n *\n * @module snapshot/SnapshotDeletionService\n * @performance Single deletion < 50ms, bulk deletion < 500ms for 100 snapshots\n * @security All deletions require explicit confirmation or skipConfirmation flag\n *\n * @example\n * ```typescript\n * import { SnapshotDeletionService } from '@snapback-oss/sdk';\n *\n * const service = new SnapshotDeletionService(snapshotManager, confirmationService, {\n *   logger: myLogger // optional\n * });\n *\n * // Delete single snapshot with confirmation\n * const result = await service.deleteSnapshot('snapshot-id');\n *\n * // Delete without confirmation\n * await service.deleteSnapshot('snapshot-id', { skipConfirmation: true });\n *\n * // Delete protected snapshot\n * await service.deleteSnapshot('snapshot-id', { unprotectFirst: true });\n *\n * // Bulk delete old snapshots\n * await service.deleteOlderThan(Date.now() - 30 * 24 * 60 * 60 * 1000, true);\n *\n * // Auto-cleanup\n * await service.autoCleanup({\n *   enabled: true,\n *   olderThanDays: 30,\n *   keepProtected: true,\n *   minimumSnapshots: 10\n * });\n * ```\n */\n\n/**\n * Options for snapshot deletion operations\n */\nexport interface DeletionOptions {\n\t/** Skip user confirmation dialog */\n\tskipConfirmation?: boolean;\n\t/** Unprotect snapshot before deletion (otherwise throws error) */\n\tunprotectFirst?: boolean;\n}\n\n/**\n * Result of a deletion operation\n */\nexport interface DeletionResult {\n\t/** Whether the operation completed successfully */\n\tsuccess: boolean;\n\t/** Number of snapshots deleted */\n\tdeletedCount: number;\n\t/** Error message if operation failed */\n\terror?: string;\n}\n\n/**\n * Configuration for automatic cleanup\n */\nexport interface AutoCleanupConfig {\n\t/** Whether auto-cleanup is enabled */\n\tenabled: boolean;\n\t/** Delete snapshots older than this many days */\n\tolderThanDays: number;\n\t/** Keep protected snapshots even if old */\n\tkeepProtected: boolean;\n\t/** Never delete below this minimum count */\n\tminimumSnapshots: number;\n}\n\n/**\n * Minimal snapshot interface for deletion service\n */\nexport interface DeletableSnapshot {\n\tid: string;\n\tname: string;\n\ttimestamp: number;\n\tisProtected: boolean;\n\t[key: string]: unknown;\n}\n\n/**\n * Minimal SnapshotManager interface for deletion operations\n */\nexport interface ISnapshotManagerForDeletion {\n\tget(id: string): Promise<DeletableSnapshot | undefined>;\n\tgetAll(): Promise<DeletableSnapshot[]>;\n\tdelete(id: string): Promise<void>;\n\tunprotect(id: string): Promise<void>;\n}\n\n/**\n * Confirmation service interface for user prompts\n */\nexport interface IConfirmationService {\n\tconfirm(message: string, detail?: string): Promise<boolean>;\n}\n\n/**\n * Options for SnapshotDeletionService\n */\nexport interface SnapshotDeletionServiceOptions {\n\t/** Logger instance for debug output */\n\tlogger?: ILogger;\n}\n\n/**\n * SnapshotDeletionService - Manages safe snapshot deletion operations\n */\nexport class SnapshotDeletionService {\n\tprivate readonly logger: ILogger;\n\n\tconstructor(\n\t\tprivate readonly snapshotManager: ISnapshotManagerForDeletion,\n\t\tprivate readonly confirmationService: IConfirmationService,\n\t\toptions: SnapshotDeletionServiceOptions = {},\n\t) {\n\t\tthis.logger = options.logger ?? new NoOpLogger();\n\t}\n\n\t/**\n\t * Delete a single snapshot with safety checks\n\t *\n\t * @param snapshotId - ID of snapshot to delete\n\t * @param options - Deletion options\n\t * @returns Deletion result with success status and count\n\t * @throws Error if snapshot is protected and unprotectFirst is false\n\t * @throws Error if snapshot does not exist\n\t *\n\t * @performance < 50ms including confirmation dialog\n\t */\n\tasync deleteSnapshot(snapshotId: string, options: DeletionOptions = {}): Promise<DeletionResult> {\n\t\t// 1. Validate snapshot exists\n\t\tconst snapshot = await this.snapshotManager.get(snapshotId);\n\t\tif (!snapshot) {\n\t\t\tthrow new Error(`Snapshot not found: ${snapshotId}`);\n\t\t}\n\n\t\t// 2. Safety check: Protected snapshot\n\t\tif (snapshot.isProtected && !options.unprotectFirst) {\n\t\t\tthrow new Error(\"Cannot delete protected snapshot. Set unprotectFirst=true to override.\");\n\t\t}\n\n\t\t// 3. Unprotect if requested\n\t\tif (options.unprotectFirst && snapshot.isProtected) {\n\t\t\tawait this.snapshotManager.unprotect(snapshotId);\n\t\t}\n\n\t\t// 4. Confirmation (if not skipped)\n\t\tif (!options.skipConfirmation) {\n\t\t\tconst confirmed = await this.confirmationService.confirm(\n\t\t\t\t`Delete snapshot \"${snapshot.name}\"?`,\n\t\t\t\t\"This action cannot be undone.\",\n\t\t\t);\n\n\t\t\tif (!confirmed) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tdeletedCount: 0,\n\t\t\t\t\terror: \"User cancelled deletion\",\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\tawait this.snapshotManager.delete(snapshotId);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdeletedCount: 1,\n\t\t};\n\t}\n\n\t/**\n\t * Delete all snapshots older than the specified timestamp\n\t *\n\t * @param timestamp - Cutoff timestamp (milliseconds since epoch)\n\t * @param keepProtected - If true, skip protected snapshots\n\t * @returns Deletion result with count of deleted snapshots\n\t *\n\t * @performance < 500ms for 100 snapshots\n\t */\n\tasync deleteOlderThan(timestamp: number, keepProtected = true): Promise<DeletionResult> {\n\t\tconst allSnapshots = await this.snapshotManager.getAll();\n\n\t\t// Filter snapshots to delete\n\t\tconst toDelete = allSnapshots.filter((snapshot: DeletableSnapshot) => {\n\t\t\t// Skip if newer than cutoff\n\t\t\tif (snapshot.timestamp >= timestamp) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Skip protected if requested\n\t\t\tif (keepProtected && snapshot.isProtected) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t});\n\n\t\t// Delete snapshots\n\t\tlet deletedCount = 0;\n\t\tfor (const snapshot of toDelete) {\n\t\t\ttry {\n\t\t\t\t// Unprotect if needed\n\t\t\t\tif (snapshot.isProtected) {\n\t\t\t\t\tawait this.snapshotManager.unprotect(snapshot.id);\n\t\t\t\t}\n\n\t\t\t\tawait this.snapshotManager.delete(snapshot.id);\n\t\t\t\tdeletedCount++;\n\t\t\t} catch (error) {\n\t\t\t\t// Log error but continue with other deletions\n\t\t\t\tthis.logger.error(`Failed to delete snapshot ${snapshot.id}:`, toError(error));\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdeletedCount,\n\t\t};\n\t}\n\n\t/**\n\t * Perform automatic cleanup based on configuration\n\t *\n\t * @param config - Auto-cleanup configuration\n\t * @returns Deletion result with count of deleted snapshots\n\t */\n\tasync autoCleanup(config: AutoCleanupConfig): Promise<DeletionResult> {\n\t\t// Check if enabled\n\t\tif (!config.enabled) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdeletedCount: 0,\n\t\t\t};\n\t\t}\n\n\t\tconst allSnapshots = await this.snapshotManager.getAll();\n\n\t\t// Check minimum snapshot count\n\t\tif (allSnapshots.length <= config.minimumSnapshots) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tdeletedCount: 0,\n\t\t\t};\n\t\t}\n\n\t\t// Calculate cutoff timestamp\n\t\tconst cutoffTime = Date.now() - config.olderThanDays * 24 * 60 * 60 * 1000;\n\n\t\t// Filter eligible snapshots for deletion\n\t\tconst eligibleForDeletion = allSnapshots.filter((snapshot: DeletableSnapshot) => {\n\t\t\t// Skip if newer than cutoff\n\t\t\tif (snapshot.timestamp >= cutoffTime) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Skip protected if configured\n\t\t\tif (config.keepProtected && snapshot.isProtected) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t});\n\n\t\t// Sort by timestamp (oldest first)\n\t\teligibleForDeletion.sort((a: DeletableSnapshot, b: DeletableSnapshot) => a.timestamp - b.timestamp);\n\n\t\t// Calculate how many we can delete while respecting minimum\n\t\tconst maxToDelete = allSnapshots.length - config.minimumSnapshots;\n\t\tconst toDelete = eligibleForDeletion.slice(0, Math.max(0, maxToDelete));\n\n\t\t// Delete snapshots\n\t\tlet deletedCount = 0;\n\t\tfor (const snapshot of toDelete) {\n\t\t\ttry {\n\t\t\t\t// Unprotect if needed\n\t\t\t\tif (snapshot.isProtected) {\n\t\t\t\t\tawait this.snapshotManager.unprotect(snapshot.id);\n\t\t\t\t}\n\n\t\t\t\tawait this.snapshotManager.delete(snapshot.id);\n\t\t\t\tdeletedCount++;\n\t\t\t} catch (error) {\n\t\t\t\tthis.logger.error(`Auto-cleanup failed for ${snapshot.id}:`, toError(error));\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tdeletedCount,\n\t\t};\n\t}\n\n\t/**\n\t * Check if a snapshot can be safely deleted\n\t *\n\t * @param snapshot - Snapshot to check\n\t * @returns True if snapshot can be deleted without unprotectFirst\n\t *\n\t * @performance < 1ms\n\t */\n\tcanDelete(snapshot: DeletableSnapshot): boolean {\n\t\treturn !snapshot.isProtected;\n\t}\n}\n","/**\n * SnapshotIconStrategy.ts\n *\n * Platform-agnostic snapshot icon classification based on operation type.\n * Classifies snapshots into visual icons using priority-based detection.\n *\n * Features:\n * - Priority-based detection (protected > name keywords > file extensions)\n * - Pre-compiled regex patterns for performance\n * - Conventional commit prefix matching\n * - File type detection (test, config, docs, style, API, database)\n *\n * @module snapshot/SnapshotIconStrategy\n * @performance Icon classification < 1ms, 10000 classifications < 100ms\n *\n * @example\n * ```typescript\n * import { SnapshotIconStrategy } from '@snapback-oss/sdk';\n *\n * const strategy = new SnapshotIconStrategy();\n *\n * // Protected snapshot\n * strategy.classifyIcon({\n *   name: 'Critical feature',\n *   files: ['src/app.ts'],\n *   isProtected: true\n * }); // { icon: 'lock', color: 'charts.red' }\n *\n * // Test file snapshot\n * strategy.classifyIcon({\n *   name: 'Test changes',\n *   files: ['src/app.test.ts'],\n *   isProtected: false\n * }); // { icon: 'beaker', color: 'charts.purple' }\n * ```\n */\n\nimport * as path from \"node:path\";\n\n/**\n * Result of icon classification containing the icon name and theme color\n *\n * The icon names are VS Code codicon names (e.g., 'lock', 'beaker', 'file-code')\n * The color values are VS Code theme color IDs (e.g., 'charts.red', 'foreground')\n */\nexport interface IconResult {\n\t/** Codicon name (e.g., 'lock', 'beaker', 'file-code') */\n\ticon: string;\n\t/** Theme color ID (e.g., 'charts.red', 'charts.purple', 'foreground') */\n\tcolor: string;\n}\n\n/**\n * Metadata describing a snapshot for icon classification\n */\nexport interface SnapshotMetadata {\n\t/** Snapshot name/description */\n\tname: string;\n\t/** List of file paths included in the snapshot */\n\tfiles: string[];\n\t/** Whether the snapshot is protected from deletion */\n\tisProtected: boolean;\n}\n\n/**\n * Icon mapping configuration (internal)\n */\ninterface IconMapping {\n\ticon: string;\n\tcolor: string;\n}\n\n/**\n * SnapshotIconStrategy classifies snapshots into visual icons based on operation type.\n *\n * Classification priority:\n * 1. Protected status (highest priority)\n * 2. Name keyword matching (conventional commits, operation keywords)\n * 3. File extension detection\n * 4. Fallback default icon\n *\n * Performance: Icon classification < 1ms, 10000 classifications < 100ms\n */\nexport class SnapshotIconStrategy {\n\t/**\n\t * Icon mapping configuration with codicon names and theme colors\n\t */\n\tprivate static readonly ICON_MAP: Record<string, IconMapping> = {\n\t\t\"file-add\": { icon: \"file-add\", color: \"charts.green\" },\n\t\t\"file-delete\": { icon: \"trash\", color: \"charts.red\" },\n\t\t\"test-changes\": { icon: \"beaker\", color: \"charts.purple\" },\n\t\t\"update-deps\": { icon: \"package\", color: \"charts.yellow\" },\n\t\t\"config-change\": {\n\t\t\ticon: \"settings-gear\",\n\t\t\tcolor: \"debugConsole.warningForeground\",\n\t\t},\n\t\trefactor: { icon: \"symbol-class\", color: \"charts.blue\" },\n\t\t\"fix-bug\": { icon: \"bug\", color: \"charts.red\" },\n\t\t\"docs-update\": { icon: \"book\", color: \"charts.blue\" },\n\t\t\"style-changes\": { icon: \"paintcan\", color: \"charts.pink\" },\n\t\t\"api-changes\": { icon: \"server\", color: \"charts.yellow\" },\n\t\tdatabase: { icon: \"database\", color: \"charts.orange\" },\n\t\tprotected: { icon: \"lock\", color: \"charts.red\" },\n\t\tdefault: { icon: \"file-code\", color: \"foreground\" },\n\t};\n\n\t/**\n\t * Pre-compiled regex patterns for performance optimization\n\t */\n\tprivate static readonly TEST_FILE_REGEX = /\\.(test|spec)\\.(ts|js|tsx|jsx)$/i;\n\tprivate static readonly CONFIG_FILE_REGEX = /\\.(config\\.(ts|js)|eslintrc|prettierrc|env)/i;\n\tprivate static readonly STYLE_FILE_REGEX = /\\.(css|scss|less|sass)$/i;\n\tprivate static readonly DOC_FILE_REGEX = /\\.(md|mdx)$/i;\n\tprivate static readonly SQL_FILE_REGEX = /\\.sql$/i;\n\tprivate static readonly SCHEMA_FILE_REGEX = /schema\\.(sql|prisma|ts|js)/i;\n\tprivate static readonly API_FILE_REGEX = /\\.api\\./i;\n\n\t/**\n\t * Package lock file patterns\n\t */\n\tprivate static readonly PACKAGE_FILES = new Set([\n\t\t\"package.json\",\n\t\t\"package-lock.json\",\n\t\t\"yarn.lock\",\n\t\t\"pnpm-lock.yaml\",\n\t]);\n\n\t/**\n\t * Config file patterns\n\t */\n\tprivate static readonly CONFIG_FILES = new Set([\"tsconfig.json\", \".eslintrc.json\", \".prettierrc\"]);\n\n\t/**\n\t * Keyword sets for name-based classification\n\t */\n\tprivate static readonly BUG_FIX_KEYWORDS = [\"fix\", \"bugfix\"];\n\tprivate static readonly REFACTOR_KEYWORDS = [\"refactor\", \"refactored\"];\n\tprivate static readonly ADDITION_KEYWORDS = [\"added\", \"created\", \"file-add\"];\n\tprivate static readonly DELETION_KEYWORDS = [\"deleted\", \"removed\", \"file-delete\"];\n\tprivate static readonly DOC_KEYWORDS = [\"docs\", \"documentation\", \"docs-update\"];\n\tprivate static readonly STYLE_KEYWORDS = [\"style\", \"styling\", \"style-changes\"];\n\tprivate static readonly API_KEYWORDS = [\"api-changes\", \"endpoint\"];\n\tprivate static readonly DATABASE_KEYWORDS = [\"database\", \"db\", \"migration\", \"schema\"];\n\tprivate static readonly PACKAGE_KEYWORDS = [\"update-deps\", \"dependencies\"];\n\tprivate static readonly CONFIG_KEYWORDS = [\"config-change\"];\n\n\t/**\n\t * Classifies a snapshot into an appropriate icon based on its metadata.\n\t *\n\t * Detection logic priority order:\n\t * 1. Protected status (highest priority)\n\t * 2. Name keywords (bug fix, deletion, refactor, etc.)\n\t * 3. File extensions (test files, package files, config files, etc.)\n\t * 4. Fallback to default icon\n\t *\n\t * @param metadata - The snapshot metadata to classify\n\t * @returns IconResult containing the codicon name and theme color\n\t */\n\tclassifyIcon(metadata: SnapshotMetadata): IconResult {\n\t\t// Priority 1: Protected status (highest priority)\n\t\tif (metadata.isProtected) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP.protected;\n\t\t}\n\n\t\t// Priority 2: Name-based keyword matching\n\t\tconst nameResult = this.classifyByName(metadata.name);\n\t\tif (nameResult) {\n\t\t\treturn nameResult;\n\t\t}\n\n\t\t// Priority 3: File extension-based classification\n\t\tconst fileResult = this.classifyByFiles(metadata.files);\n\t\tif (fileResult) {\n\t\t\treturn fileResult;\n\t\t}\n\n\t\t// Priority 4: Fallback to default icon\n\t\treturn SnapshotIconStrategy.ICON_MAP.default;\n\t}\n\n\t/**\n\t * Get the icon mapping for a specific category\n\t *\n\t * @param category - The category key (e.g., 'protected', 'test-changes')\n\t * @returns IconMapping or undefined if not found\n\t */\n\tgetIconMapping(category: string): IconMapping | undefined {\n\t\treturn SnapshotIconStrategy.ICON_MAP[category];\n\t}\n\n\t/**\n\t * Get all available icon mappings\n\t *\n\t * @returns Record of all icon mappings\n\t */\n\tgetAllIconMappings(): Record<string, IconMapping> {\n\t\treturn { ...SnapshotIconStrategy.ICON_MAP };\n\t}\n\n\t/**\n\t * Classifies based on name keywords with priority ordering.\n\t *\n\t * @param name - The snapshot name\n\t * @returns IconResult if keyword matched, null otherwise\n\t */\n\tprivate classifyByName(name: string): IconResult | null {\n\t\tconst lowerName = name.toLowerCase();\n\n\t\t// Priority 0: Check for prefix patterns (conventional commit style)\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.ADDITION_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"file-add\"];\n\t\t}\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.BUG_FIX_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"fix-bug\"];\n\t\t}\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.DELETION_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"file-delete\"];\n\t\t}\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.REFACTOR_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP.refactor;\n\t\t}\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.DOC_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"docs-update\"];\n\t\t}\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.STYLE_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"style-changes\"];\n\t\t}\n\t\tif (this.matchesPrefixKeyword(lowerName, SnapshotIconStrategy.CONFIG_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"config-change\"];\n\t\t}\n\n\t\t// Priority 1: Bug fixes\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.BUG_FIX_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"fix-bug\"];\n\t\t}\n\n\t\t// Priority 2: Deletions\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.DELETION_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"file-delete\"];\n\t\t}\n\n\t\t// Priority 3: Refactors\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.REFACTOR_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP.refactor;\n\t\t}\n\n\t\t// Priority 4: API changes\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.API_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"api-changes\"];\n\t\t}\n\n\t\t// Priority 5: Database operations\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.DATABASE_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP.database;\n\t\t}\n\n\t\t// Priority 6: Docs\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.DOC_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"docs-update\"];\n\t\t}\n\n\t\t// Priority 7: Style\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.STYLE_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"style-changes\"];\n\t\t}\n\n\t\t// Priority 8: Additions\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.ADDITION_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"file-add\"];\n\t\t}\n\n\t\t// Priority 9: Package\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.PACKAGE_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"update-deps\"];\n\t\t}\n\n\t\t// Priority 10: Config\n\t\tif (this.matchesKeyword(lowerName, SnapshotIconStrategy.CONFIG_KEYWORDS)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"config-change\"];\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Classifies based on file extensions and paths.\n\t *\n\t * @param files - The list of file paths\n\t * @returns IconResult if file pattern matched, null otherwise\n\t */\n\tprivate classifyByFiles(files: string[]): IconResult | null {\n\t\tif (!files || files.length === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Priority 1: Test files\n\t\tif (this.containsTestFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"test-changes\"];\n\t\t}\n\n\t\t// Priority 2: Package files\n\t\tif (this.containsPackageFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"update-deps\"];\n\t\t}\n\n\t\t// Priority 3: Config files\n\t\tif (this.containsConfigFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"config-change\"];\n\t\t}\n\n\t\t// Priority 4: Documentation files\n\t\tif (this.containsDocFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"docs-update\"];\n\t\t}\n\n\t\t// Priority 5: Style files\n\t\tif (this.containsStyleFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"style-changes\"];\n\t\t}\n\n\t\t// Priority 6: Database files\n\t\tif (this.containsDatabaseFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP.database;\n\t\t}\n\n\t\t// Priority 7: API files\n\t\tif (this.containsApiFiles(files)) {\n\t\t\treturn SnapshotIconStrategy.ICON_MAP[\"api-changes\"];\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Checks if name matches any keyword (case-insensitive).\n\t */\n\tprivate matchesKeyword(name: string, keywords: readonly string[]): boolean {\n\t\treturn keywords.some((k) => name.includes(k));\n\t}\n\n\t/**\n\t * Checks if name starts with keyword followed by colon (conventional commit format).\n\t */\n\tprivate matchesPrefixKeyword(name: string, keywords: readonly string[]): boolean {\n\t\treturn keywords.some((k) => name.startsWith(`${k}:`));\n\t}\n\n\t/**\n\t * Checks if files contain test files.\n\t */\n\tprivate containsTestFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\tconst lowerFile = file.toLowerCase();\n\t\t\treturn SnapshotIconStrategy.TEST_FILE_REGEX.test(fileName) || lowerFile.includes(\"__tests__\");\n\t\t});\n\t}\n\n\t/**\n\t * Checks if files contain package lock files.\n\t */\n\tprivate containsPackageFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\treturn SnapshotIconStrategy.PACKAGE_FILES.has(fileName);\n\t\t});\n\t}\n\n\t/**\n\t * Checks if files contain configuration files.\n\t */\n\tprivate containsConfigFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\tconst lowerFile = file.toLowerCase();\n\t\t\treturn (\n\t\t\t\tSnapshotIconStrategy.CONFIG_FILE_REGEX.test(fileName) ||\n\t\t\t\tSnapshotIconStrategy.CONFIG_FILES.has(fileName) ||\n\t\t\t\tlowerFile.includes(\".env\")\n\t\t\t);\n\t\t});\n\t}\n\n\t/**\n\t * Checks if files contain documentation files.\n\t */\n\tprivate containsDocFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\tconst lowerFile = file.toLowerCase();\n\t\t\treturn (\n\t\t\t\tSnapshotIconStrategy.DOC_FILE_REGEX.test(fileName) ||\n\t\t\t\tlowerFile.includes(\"/docs/\") ||\n\t\t\t\tlowerFile.startsWith(\"docs/\")\n\t\t\t);\n\t\t});\n\t}\n\n\t/**\n\t * Checks if files contain style files.\n\t */\n\tprivate containsStyleFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\treturn SnapshotIconStrategy.STYLE_FILE_REGEX.test(fileName);\n\t\t});\n\t}\n\n\t/**\n\t * Checks if files contain database files.\n\t */\n\tprivate containsDatabaseFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\tconst lowerFile = file.toLowerCase();\n\t\t\treturn (\n\t\t\t\tSnapshotIconStrategy.SQL_FILE_REGEX.test(fileName) ||\n\t\t\t\tSnapshotIconStrategy.SCHEMA_FILE_REGEX.test(fileName) ||\n\t\t\t\tlowerFile.includes(\"/migrations/\") ||\n\t\t\t\tlowerFile.startsWith(\"migrations/\") ||\n\t\t\t\tlowerFile.includes(\"/schema/\") ||\n\t\t\t\tlowerFile.startsWith(\"schema/\")\n\t\t\t);\n\t\t});\n\t}\n\n\t/**\n\t * Checks if files contain API files.\n\t */\n\tprivate containsApiFiles(files: string[]): boolean {\n\t\treturn files.some((file) => {\n\t\t\tconst fileName = path.basename(file);\n\t\t\tconst lowerFile = file.toLowerCase();\n\t\t\treturn (\n\t\t\t\tSnapshotIconStrategy.API_FILE_REGEX.test(fileName) ||\n\t\t\t\tlowerFile.includes(\"/api/\") ||\n\t\t\t\tlowerFile.startsWith(\"api/\")\n\t\t\t);\n\t\t});\n\t}\n}\n","import { exec } from \"node:child_process\";\nimport { promises as fs } from \"node:fs\";\nimport * as path from \"node:path\";\nimport { promisify } from \"node:util\";\nimport type { ILogger } from \"../core/session/interfaces\";\nimport { NoOpLogger } from \"../core/session/interfaces\";\n\nconst execAsync = promisify(exec);\n\n/**\n * File change status types matching git diff output\n */\nexport interface FileChange {\n\tpath: string;\n\tstatus: \"added\" | \"modified\" | \"deleted\";\n\tlinesAdded: number;\n\tlinesDeleted: number;\n}\n\n/**\n * Snapshot information for name generation\n */\nexport interface SnapshotInfo {\n\tfiles: FileChange[];\n\tworkspaceRoot: string;\n\t/** Optional user-provided context (e.g., 'bug-fix', 'credentials', or custom text) */\n\tuserContext?: string;\n}\n\n/**\n * Options for SnapshotNamingStrategy\n */\nexport interface SnapshotNamingStrategyOptions {\n\t/** Logger instance for debug output */\n\tlogger?: ILogger;\n\t/** Git command timeout in milliseconds (default: 5000) */\n\tgitTimeoutMs?: number;\n\t/** Maximum name length (default: 60) */\n\tmaxNameLength?: number;\n}\n\n/**\n * Multi-tier intelligent snapshot naming strategy\n *\n * Naming Tiers (fallback chain):\n * 1. Git Analysis: Parse git diff --name-status output\n * 2. File Operations: Detect patterns from extensions/paths\n * 3. Content Analysis: Count import/function/class changes\n * 4. Fallback: Line count summary\n *\n * Performance: < 50ms for name generation\n *\n * @example\n * ```typescript\n * import { SnapshotNamingStrategy } from '@snapback-oss/sdk';\n *\n * const strategy = new SnapshotNamingStrategy('/path/to/workspace', {\n *   logger: myLogger // optional\n * });\n *\n * const name = await strategy.generateName({\n *   files: [{ path: 'src/auth.ts', status: 'modified', linesAdded: 10, linesDeleted: 5 }],\n *   workspaceRoot: '/path/to/workspace'\n * });\n * // Returns: \"Modified auth.ts\" or \"Updated 3 imports\" etc.\n * ```\n */\nexport class SnapshotNamingStrategy {\n\tprivate readonly workspaceRoot: string;\n\tprivate readonly gitTimeoutMs: number;\n\tprivate readonly maxNameLength: number;\n\tprivate readonly logger: ILogger;\n\n\tconstructor(workspaceRoot: string, options: SnapshotNamingStrategyOptions = {}) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.logger = options.logger ?? new NoOpLogger();\n\t\tthis.gitTimeoutMs = options.gitTimeoutMs ?? 5000;\n\t\tthis.maxNameLength = options.maxNameLength ?? 60;\n\t}\n\n\t/**\n\t * Generates a snapshot name using multi-tier fallback strategy\n\t *\n\t * @param info - Snapshot information containing file changes\n\t * @returns Promise resolving to a descriptive snapshot name\n\t */\n\tasync generateName(info: SnapshotInfo): Promise<string> {\n\t\t// Early exit for empty file list\n\t\tif (info.files.length === 0) {\n\t\t\treturn \"No changes\";\n\t\t}\n\n\t\t// Generate base name using existing intelligent strategy\n\t\tlet baseName: string;\n\n\t\t// Tier 1: Git-based naming\n\t\tconst gitName = await this.tryGitNaming(info);\n\t\tif (gitName) {\n\t\t\tbaseName = gitName;\n\t\t} else {\n\t\t\t// Tier 2: File operation pattern detection\n\t\t\tconst fileOpName = this.tryFileOperationNaming(info);\n\t\t\tif (fileOpName) {\n\t\t\t\tbaseName = fileOpName;\n\t\t\t} else {\n\t\t\t\t// Tier 3: Content analysis\n\t\t\t\tconst contentName = await this.tryContentAnalysisNaming(info);\n\t\t\t\tif (contentName) {\n\t\t\t\t\tbaseName = contentName;\n\t\t\t\t} else {\n\t\t\t\t\t// Tier 4: Fallback to line counts\n\t\t\t\t\tbaseName = this.fallbackNaming(info);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// If user provided context, prepend it (Conventional Commits style)\n\t\tif (info.userContext) {\n\t\t\tconst prefix = this.formatUserContext(info.userContext);\n\t\t\treturn `${prefix}: ${baseName}`;\n\t\t}\n\n\t\treturn baseName;\n\t}\n\n\t/**\n\t * Tier 1: Git-based naming\n\t * Attempts to use actual git commands to generate names.\n\t * Returns null if git is unavailable or no git repo exists.\n\t */\n\tprivate async tryGitNaming(info: SnapshotInfo): Promise<string | null> {\n\t\ttry {\n\t\t\t// Check if we're in a git repository\n\t\t\tconst isGitRepo = await this.execGit([\"rev-parse\", \"--git-dir\"]);\n\t\t\tif (!isGitRepo) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// Try to get actual git status\n\t\t\tconst gitStatus = await this.execGit([\"status\", \"--porcelain\"]);\n\t\t\tif (!gitStatus) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// If we have git info, generate git-style names\n\t\t\tif (info.files.length === 1) {\n\t\t\t\tconst file = info.files[0];\n\t\t\t\treturn this.generateSingleFileGitName(file.status, file.path);\n\t\t\t}\n\n\t\t\treturn this.generateMultiFileGitName(info.files);\n\t\t} catch (_error) {\n\t\t\t// Git operation failed, fall through to next tier\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Tier 2: File operation pattern detection\n\t * Detects test files, configs, dependencies with priority ordering\n\t */\n\tprivate tryFileOperationNaming(info: SnapshotInfo): string | null {\n\t\tconst files = info.files;\n\n\t\t// Priority 1: Check for test files (highest priority)\n\t\tconst testFiles = files.filter((f) => this.isTestFile(f.path));\n\t\tif (testFiles.length > 0 && testFiles.length === files.length) {\n\t\t\treturn `Updated ${testFiles.length} test${testFiles.length > 1 ? \"s\" : \"\"}`;\n\t\t}\n\n\t\t// Priority 2: Check for dependency files\n\t\tconst dependencyFiles = files.filter((f) => this.isDependencyFile(f.path));\n\t\tif (dependencyFiles.length > 0) {\n\t\t\treturn \"Updated dependencies\";\n\t\t}\n\n\t\t// Priority 3: Check for config files (all files must be configs)\n\t\tconst configFiles = files.filter((f) => this.isConfigFile(f.path));\n\t\tif (configFiles.length > 0 && configFiles.length === files.length) {\n\t\t\treturn `Modified ${configFiles.length} config${configFiles.length > 1 ? \"s\" : \"\"}`;\n\t\t}\n\n\t\t// Priority 4: Mixed types with test files - prioritize test detection\n\t\tif (testFiles.length > 0 && testFiles.length < files.length) {\n\t\t\treturn `Updated ${testFiles.length} test${testFiles.length > 1 ? \"s\" : \"\"}`;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Tier 3: Content analysis\n\t * Detects refactoring patterns, structure changes, and import modifications\n\t */\n\tprivate async tryContentAnalysisNaming(info: SnapshotInfo): Promise<string | null> {\n\t\ttry {\n\t\t\t// Count both imports and structure changes\n\t\t\tconst importCount = await this.countImportChanges(info.files);\n\t\t\tconst structureCount = await this.countStructureChanges(info.files);\n\n\t\t\t// Priority 1: Import changes (simpler, more specific)\n\t\t\tif (importCount > 0 && structureCount === 0) {\n\t\t\t\treturn `Updated ${importCount} import${importCount > 1 ? \"s\" : \"\"}`;\n\t\t\t}\n\n\t\t\t// Priority 2: Refactoring detection - multiple files with significant structure changes\n\t\t\tif (structureCount > 3 && info.files.length > 1) {\n\t\t\t\tconst commonDir = this.findCommonDirectory(info.files);\n\t\t\t\tconst moduleName = this.extractModuleName(commonDir, info.files);\n\t\t\t\treturn `Refactored ${moduleName} module (${info.files.length} files)`;\n\t\t\t}\n\n\t\t\t// Priority 3: Single file refactoring with many structure changes\n\t\t\tif (structureCount >= 3 && info.files.length === 1) {\n\t\t\t\tconst dir = path.dirname(info.files[0].path);\n\t\t\t\tconst moduleName = this.extractModuleName(dir, info.files);\n\t\t\t\treturn `Refactored ${moduleName} (${structureCount} changes)`;\n\t\t\t}\n\n\t\t\t// Priority 4: Import changes even with some structure changes\n\t\t\tif (importCount > 0) {\n\t\t\t\treturn `Updated ${importCount} import${importCount > 1 ? \"s\" : \"\"}`;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t} catch (_error) {\n\t\t\t// Content analysis failed, fall through\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Tier 4: Fallback naming\n\t * Uses git-style format for code files, line count for unknown/non-code files\n\t */\n\tprivate fallbackNaming(info: SnapshotInfo): string {\n\t\tconst totalLines = info.files.reduce((sum, file) => sum + file.linesAdded + file.linesDeleted, 0);\n\t\tconst fileCount = info.files.length;\n\n\t\t// Check if files are code files (should use git-style format)\n\t\tconst allCodeFiles = info.files.every((f) => this.isCodeFile(f.path));\n\n\t\t// Single file with unknown extension: use line count format\n\t\tif (info.files.length === 1) {\n\t\t\tconst file = info.files[0];\n\n\t\t\t// Use line count format for non-code files\n\t\t\tif (!this.isCodeFile(file.path)) {\n\t\t\t\treturn `Modified 1 file (${totalLines} lines)`;\n\t\t\t}\n\n\t\t\t// Use git-style format for code files\n\t\t\treturn this.generateSingleFileGitName(file.status, file.path);\n\t\t}\n\n\t\t// Multiple files: if all non-code files, use line count\n\t\tif (!allCodeFiles) {\n\t\t\treturn `Modified ${fileCount} files (${totalLines} lines)`;\n\t\t}\n\n\t\t// Multiple code files: use git-style format\n\t\tconst hasAdditions = info.files.some((f) => f.status === \"added\");\n\t\tconst hasModifications = info.files.some((f) => f.status === \"modified\");\n\t\tconst hasDeletions = info.files.some((f) => f.status === \"deleted\");\n\n\t\tif (hasAdditions || hasModifications || hasDeletions) {\n\t\t\treturn this.generateMultiFileGitName(info.files);\n\t\t}\n\n\t\t// Final fallback: line count summary\n\t\treturn `Modified ${fileCount} files (${totalLines} lines)`;\n\t}\n\n\t/**\n\t * Execute git command with error handling\n\t */\n\tprivate async execGit(args: string[]): Promise<string | null> {\n\t\ttry {\n\t\t\tconst { stdout } = await execAsync(`git ${args.join(\" \")}`, {\n\t\t\t\tcwd: this.workspaceRoot,\n\t\t\t\ttimeout: this.gitTimeoutMs,\n\t\t\t});\n\t\t\treturn stdout.trim();\n\t\t} catch (_error) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Generate single-file git-style name\n\t */\n\tprivate generateSingleFileGitName(status: \"added\" | \"modified\" | \"deleted\", filePath: string): string {\n\t\tconst basename = path.basename(filePath);\n\t\tconst sanitizedName = this.sanitizeFilename(basename);\n\t\tconst truncatedName = this.truncatePath(sanitizedName, this.maxNameLength - 20);\n\n\t\tswitch (status) {\n\t\t\tcase \"added\":\n\t\t\t\treturn `Added ${truncatedName}`;\n\t\t\tcase \"modified\":\n\t\t\t\treturn `Modified ${truncatedName}`;\n\t\t\tcase \"deleted\":\n\t\t\t\treturn `Deleted ${truncatedName}`;\n\t\t}\n\t}\n\n\t/**\n\t * Generate multi-file git-style name (e.g., \"3A 2M 1D in src/auth\")\n\t */\n\tprivate generateMultiFileGitName(files: FileChange[]): string {\n\t\tconst added = files.filter((f) => f.status === \"added\").length;\n\t\tconst modified = files.filter((f) => f.status === \"modified\").length;\n\t\tconst deleted = files.filter((f) => f.status === \"deleted\").length;\n\n\t\tconst parts: string[] = [];\n\t\tif (added > 0) {\n\t\t\tparts.push(`${added}A`);\n\t\t}\n\t\tif (modified > 0) {\n\t\t\tparts.push(`${modified}M`);\n\t\t}\n\t\tif (deleted > 0) {\n\t\t\tparts.push(`${deleted}D`);\n\t\t}\n\n\t\tconst statusSummary = parts.join(\" \");\n\t\tconst commonDir = this.findCommonDirectory(files);\n\t\tconst dirName = commonDir ? this.getRelativeDirectory(commonDir) : \"workspace\";\n\n\t\treturn `${statusSummary} in ${dirName}`;\n\t}\n\n\t/**\n\t * Find common directory path for multiple files\n\t */\n\tprivate findCommonDirectory(files: FileChange[]): string {\n\t\tif (files.length === 0) {\n\t\t\treturn \"\";\n\t\t}\n\t\tif (files.length === 1) {\n\t\t\treturn path.dirname(files[0].path);\n\t\t}\n\n\t\tconst dirPaths = files.map((f) => path.dirname(f.path));\n\t\tconst segmentArrays = dirPaths.map((dir) => dir.split(path.sep));\n\t\tconst firstSegments = segmentArrays[0];\n\t\tconst commonSegments: string[] = [];\n\n\t\tfor (let i = 0; i < firstSegments.length; i++) {\n\t\t\tconst segment = firstSegments[i];\n\t\t\tconst allMatch = segmentArrays.every((segments) => segments[i] === segment);\n\t\t\tif (allMatch) {\n\t\t\t\tcommonSegments.push(segment);\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn commonSegments.length === 0 ? \"\" : commonSegments.join(path.sep);\n\t}\n\n\t/**\n\t * Get relative directory name from absolute path\n\t */\n\tprivate getRelativeDirectory(absolutePath: string): string {\n\t\tlet relative = path.relative(this.workspaceRoot, absolutePath);\n\n\t\tif (relative) {\n\t\t\trelative = relative.split(path.sep).join(\"/\");\n\t\t\tif (relative.startsWith(\"./\")) {\n\t\t\t\trelative = relative.substring(2);\n\t\t\t}\n\t\t\tif (relative && relative !== \".\" && !relative.startsWith(\"..\")) {\n\t\t\t\treturn relative;\n\t\t\t}\n\t\t}\n\n\t\treturn \".\";\n\t}\n\n\t/**\n\t * Extract meaningful module name from directory path\n\t */\n\tprivate extractModuleName(dirPath: string, files: FileChange[]): string {\n\t\tif (!dirPath) {\n\t\t\treturn \"module\";\n\t\t}\n\n\t\tconst basename = path.basename(dirPath);\n\n\t\tif (basename.includes(\"tmp\") || basename.includes(\"test-\") || basename.startsWith(\".\")) {\n\t\t\tif (files.length > 0) {\n\t\t\t\tconst firstFile = files[0].path;\n\t\t\t\tconst parts = firstFile.split(path.sep).filter((p) => p && p !== \".\");\n\n\t\t\t\tfor (let i = parts.length - 2; i >= 0; i--) {\n\t\t\t\t\tconst part = parts[i];\n\t\t\t\t\tif (!part.includes(\"tmp\") && !part.includes(\"test-\") && !part.startsWith(\".\") && part.length > 2) {\n\t\t\t\t\t\treturn part;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn \"module\";\n\t\t}\n\n\t\treturn basename;\n\t}\n\n\t/**\n\t * Detect if file is a code file (has known code extension)\n\t */\n\tprivate isCodeFile(filePath: string): boolean {\n\t\tconst basename = path.basename(filePath);\n\t\tconst ext = path.extname(filePath).toLowerCase();\n\n\t\tconst knownCodeFiles = [\"Dockerfile\", \"Makefile\", \"README.md\", \".gitignore\"];\n\t\tif (knownCodeFiles.some((known) => basename === known || basename.endsWith(known))) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (ext && !this.isKnownCodeExtension(ext)) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Check if extension is a known code file extension\n\t */\n\tprivate isKnownCodeExtension(ext: string): boolean {\n\t\tconst codeExtensions = [\n\t\t\t\".ts\",\n\t\t\t\".js\",\n\t\t\t\".tsx\",\n\t\t\t\".jsx\",\n\t\t\t\".py\",\n\t\t\t\".java\",\n\t\t\t\".c\",\n\t\t\t\".cpp\",\n\t\t\t\".h\",\n\t\t\t\".hpp\",\n\t\t\t\".go\",\n\t\t\t\".rs\",\n\t\t\t\".rb\",\n\t\t\t\".php\",\n\t\t\t\".cs\",\n\t\t\t\".swift\",\n\t\t\t\".kt\",\n\t\t\t\".scala\",\n\t\t\t\".html\",\n\t\t\t\".css\",\n\t\t\t\".scss\",\n\t\t\t\".sass\",\n\t\t\t\".less\",\n\t\t\t\".json\",\n\t\t\t\".xml\",\n\t\t\t\".yaml\",\n\t\t\t\".yml\",\n\t\t\t\".md\",\n\t\t\t\".config\",\n\t\t];\n\t\treturn codeExtensions.includes(ext);\n\t}\n\n\t/**\n\t * Detect if file is a test file\n\t */\n\tprivate isTestFile(filePath: string): boolean {\n\t\tconst basename = path.basename(filePath);\n\t\tconst dirname = path.dirname(filePath);\n\n\t\tif (basename.endsWith(\".test.ts\") || basename.endsWith(\".test.js\")) {\n\t\t\treturn true;\n\t\t}\n\t\tif (basename.endsWith(\".spec.ts\") || basename.endsWith(\".spec.js\")) {\n\t\t\treturn true;\n\t\t}\n\t\tif (dirname.includes(\"__tests__\")) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Detect if file is package.json or dependency-related\n\t */\n\tprivate isDependencyFile(filePath: string): boolean {\n\t\tconst basename = path.basename(filePath);\n\t\treturn (\n\t\t\tbasename === \"package.json\" ||\n\t\t\tbasename === \"package-lock.json\" ||\n\t\t\tbasename === \"pnpm-lock.yaml\" ||\n\t\t\tbasename === \"yarn.lock\"\n\t\t);\n\t}\n\n\t/**\n\t * Detect if file is configuration\n\t */\n\tprivate isConfigFile(filePath: string): boolean {\n\t\tconst basename = path.basename(filePath);\n\n\t\tif (basename.includes(\".config.\")) {\n\t\t\treturn true;\n\t\t}\n\t\tif (basename.includes(\"rc\")) {\n\t\t\treturn true;\n\t\t}\n\t\tif (basename.startsWith(\".env\")) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst configFiles = [\"tsconfig.json\", \"jsconfig.json\"];\n\t\treturn configFiles.includes(basename);\n\t}\n\n\t/**\n\t * Count import changes via regex\n\t */\n\tprivate async countImportChanges(files: FileChange[]): Promise<number> {\n\t\tlet importCount = 0;\n\t\tconst importRegex = /import\\s+.*from|require\\(/g;\n\n\t\tfor (const file of files) {\n\t\t\ttry {\n\t\t\t\tconst content = await fs.readFile(file.path, \"utf-8\");\n\t\t\t\tconst matches = content.match(importRegex);\n\t\t\t\tif (matches) {\n\t\t\t\t\timportCount += matches.length;\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthis.logger.debug(\"Failed to read file for import analysis\", {\n\t\t\t\t\tpath: file.path,\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn importCount;\n\t}\n\n\t/**\n\t * Count function/class changes via regex\n\t */\n\tprivate async countStructureChanges(files: FileChange[]): Promise<number> {\n\t\tlet structureCount = 0;\n\t\tconst structureRegex = /function\\s+\\w+|class\\s+\\w+|const\\s+\\w+\\s*=\\s*\\(/g;\n\n\t\tfor (const file of files) {\n\t\t\ttry {\n\t\t\t\tconst content = await fs.readFile(file.path, \"utf-8\");\n\t\t\t\tconst matches = content.match(structureRegex);\n\t\t\t\tif (matches) {\n\t\t\t\t\tstructureCount += matches.length;\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthis.logger.debug(\"Failed to read file for structure analysis\", {\n\t\t\t\t\tpath: file.path,\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn structureCount;\n\t}\n\n\t/**\n\t * Truncate long file paths for display\n\t */\n\tprivate truncatePath(filePath: string, maxLength: number): string {\n\t\tif (filePath.length <= maxLength) {\n\t\t\treturn filePath;\n\t\t}\n\t\tconst ellipsis = \"...\";\n\t\treturn filePath.substring(0, maxLength - ellipsis.length) + ellipsis;\n\t}\n\n\t/**\n\t * Sanitize filenames with special characters\n\t */\n\tprivate sanitizeFilename(filename: string): string {\n\t\treturn filename\n\t\t\t.replace(/[@#$]+/g, \" \")\n\t\t\t.replace(/\\s+/g, \" \")\n\t\t\t.trim();\n\t}\n\n\t/**\n\t * Format user-provided context into a snapshot name prefix\n\t */\n\tprivate formatUserContext(context: string): string {\n\t\tconst presetMap: Record<string, string> = {\n\t\t\t\"bug-fix\": \"fix\",\n\t\t\tcredentials: \"chore\",\n\t\t\trefactor: \"refactor\",\n\t\t\ttesting: \"test\",\n\t\t};\n\n\t\tif (presetMap[context]) {\n\t\t\treturn presetMap[context];\n\t\t}\n\n\t\tconst cleaned = context\n\t\t\t.toLowerCase()\n\t\t\t.replace(/[^a-z0-9\\s-]/g, \"\")\n\t\t\t.replace(/\\s+/g, \"-\")\n\t\t\t.trim();\n\n\t\tconst maxLength = 20;\n\t\tif (cleaned.length > maxLength) {\n\t\t\treturn cleaned.substring(0, maxLength);\n\t\t}\n\n\t\treturn cleaned || \"update\";\n\t}\n}\n","import { gunzipSync, gzipSync } from \"node:zlib\";\nimport type { Database } from \"better-sqlite3\";\nimport { StorageConnectionError, StorageError, StorageTransactionError } from \"./StorageErrors\";\n\n// Type definitions for better-sqlite3\ntype DatabaseInstance = Database;\ntype DatabaseConstructor = new (...args: any[]) => DatabaseInstance;\ntype DatabaseOptions = ConstructorParameters<DatabaseConstructor>[1];\n\n// Helper functions for compression\nfunction compress(content: string): Buffer {\n\treturn gzipSync(Buffer.from(content, \"utf-8\"), { level: 9 });\n}\n\n// UUID generation function\nfunction generateId(): string {\n\t// Generate ID with only lowercase letters and numbers\n\tconst timestampPart = Date.now().toString(36);\n\tconst randomPart = Math.random().toString(36).slice(2, 7).toLowerCase();\n\treturn `snapshot_${timestampPart}_${randomPart}`;\n}\n\n// Type for queued operations\ninterface QueuedOperation<T> {\n\tid: string;\n\toperationName: string;\n\tpriority: number;\n\toperation: () => Promise<T>;\n\tresolve: (value: T | PromiseLike<T>) => void;\n\treject: (reason?: any) => void;\n\ttimestamp: number;\n}\n\n// Simple connection pool for read operations\nclass ConnectionPool {\n\tprivate connections: DatabaseInstance[] = [];\n\tprivate availableConnections: DatabaseInstance[] = [];\n\tprivate maxConnections: number;\n\n\tconstructor(\n\t\tprivate dbPath: string,\n\t\tprivate dbOptions: DatabaseOptions | undefined,\n\t\tsize = 4,\n\t) {\n\t\tthis.maxConnections = size;\n\t}\n\n\t// Get a connection from the pool\n\tasync getConnection(): Promise<DatabaseInstance> {\n\t\t// Try to get an available connection\n\t\tif (this.availableConnections.length > 0) {\n\t\t\tconst connection = this.availableConnections.pop();\n\t\t\tif (connection) {\n\t\t\t\treturn connection;\n\t\t\t}\n\t\t}\n\n\t\t// Create a new connection if we haven't reached the limit\n\t\tif (this.connections.length < this.maxConnections) {\n\t\t\tconst db = await createDatabaseInstance(this.dbPath, this.dbOptions);\n\t\t\t// Enable WAL mode for the read connection\n\t\t\tdb.pragma(\"journal_mode = WAL\");\n\t\t\tthis.connections.push(db);\n\t\t\treturn db;\n\t\t}\n\n\t\t// If we've reached the limit, reuse an existing connection\n\t\t// This is a simple round-robin approach\n\t\tconst db = this.connections.shift();\n\t\tif (db) {\n\t\t\tthis.connections.push(db);\n\t\t\treturn db;\n\t\t}\n\n\t\t// Fallback - create a new connection\n\t\treturn await createDatabaseInstance(this.dbPath, this.dbOptions);\n\t}\n\n\t// Return a connection to the pool\n\treleaseConnection(_db: DatabaseInstance): void {\n\t\t// In this simple implementation, we don't actually release connections\n\t\t// but keep them in the pool for reuse\n\t}\n\n\t// Close all connections in the pool\n\tclose(): void {\n\t\tfor (const db of this.connections) {\n\t\t\ttry {\n\t\t\t\tdb.close();\n\t\t\t} catch (_error) {\n\t\t\t\t// Ignore errors when closing\n\t\t\t}\n\t\t}\n\t\tthis.connections = [];\n\t\tthis.availableConnections = [];\n\t}\n}\n\nlet cachedDatabaseConstructor: DatabaseConstructor | null = null;\nlet cachedDatabaseError: Error | null = null;\n\nconst tryLoadBetterSqlite3 = async (): Promise<DatabaseConstructor | null> => {\n\tif (cachedDatabaseConstructor) {\n\t\treturn cachedDatabaseConstructor;\n\t}\n\n\tif (cachedDatabaseError) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tconst requiredModule = await import(\"better-sqlite3\");\n\t\t// ESM imports return the default export\n\t\tconst ctor = requiredModule.default as DatabaseConstructor;\n\n\t\t// Verify the native binding can actually be instantiated (ABI compatibility)\n\t\ttry {\n\t\t\tconst probe = new ctor(\":memory:\");\n\t\t\tprobe.close();\n\t\t} catch (instantiationError: unknown) {\n\t\t\tcachedDatabaseError =\n\t\t\t\tinstantiationError instanceof Error ? instantiationError : new Error(String(instantiationError));\n\t\t\treturn null;\n\t\t}\n\n\t\tcachedDatabaseConstructor = ctor;\n\t\treturn cachedDatabaseConstructor;\n\t} catch (error) {\n\t\tcachedDatabaseError =\n\t\t\terror instanceof Error\n\t\t\t\t? error\n\t\t\t\t: new Error(typeof error === \"string\" ? error : \"Unknown error loading better-sqlite3\");\n\t\treturn null;\n\t}\n};\n\nconst isBetterSqlite3Available = async (): Promise<boolean> => (await tryLoadBetterSqlite3()) !== null;\n\nconst getBetterSqlite3LoadError = (): Error | null => cachedDatabaseError;\n\nconst requireDatabaseConstructor = async (): Promise<DatabaseConstructor> => {\n\tconst betterSqlite3 = await tryLoadBetterSqlite3();\n\tif (betterSqlite3) {\n\t\treturn betterSqlite3;\n\t}\n\n\t// better-sqlite3 is not available - build detailed error message\n\tconst errorMessage = cachedDatabaseError\n\t\t? `better-sqlite3: ${cachedDatabaseError.message}`\n\t\t: \"better-sqlite3: not installed or not compatible\";\n\n\tconst detailedMessage = `No SQLite implementation available. ${errorMessage}`;\n\tconst error = new StorageConnectionError(detailedMessage);\n\n\t// Attach detailed error info for better debugging\n\t(error as any).details = {\n\t\tbetterSqlite3Error: cachedDatabaseError?.message,\n\t};\n\n\tthrow error;\n};\n\nconst createDatabaseInstance = async (pathToDatabase: string, options?: DatabaseOptions): Promise<DatabaseInstance> => {\n\tconst DatabaseCtor = await requireDatabaseConstructor();\n\treturn new DatabaseCtor(pathToDatabase, options);\n};\n\n/**\n * StorageBroker - Single-writer coordinator for SQLite storage across processes\n *\n * This broker ensures only one process writes to the SQLite database at a time,\n * preventing corruption and ensuring data consistency across the VS Code extension,\n * MCP server, and CLI components.\n *\n * Key responsibilities:\n * - Queue write operations from multiple processes\n * - Execute writes sequentially with proper locking\n * - Handle contention with retry/backoff mechanisms\n * - Provide WAL mode for concurrent reads\n *\n * @example\n * ```typescript\n * const broker = new StorageBroker('/path/to/database.db');\n * await broker.initialize();\n *\n * // Queue a write operation\n * const result = await broker.createSnapshot({\n *   name: 'test',\n *   files: new Map([['file.ts', 'content']]),\n *   metadata: {}\n * });\n * ```\n */\nexport class StorageBroker {\n\tprivate db: DatabaseInstance | null = null;\n\tprivate readConnectionPool: ConnectionPool | null = null;\n\tprivate initialized = false;\n\tprivate operationQueue: QueuedOperation<any>[] = [];\n\tprivate isProcessingQueue = false;\n\tprivate writerId: string;\n\n\tconstructor(private dbPath: string) {\n\t\t// Generate a unique writer ID for this process\n\t\tthis.writerId = `writer_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\t}\n\n\t/**\n\t * Initialize the storage broker and database connection\n\t */\n\tasync initialize(): Promise<void> {\n\t\tif (this.initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\t// Create database connection\n\t\t\tthis.db = await createDatabaseInstance(this.dbPath);\n\n\t\t\t// Enable WAL mode for better performance and concurrency\n\t\t\tif (this.db && typeof (this.db as any).pragma === \"function\") {\n\t\t\t\t(this.db as any).pragma(\"journal_mode = WAL\");\n\t\t\t}\n\n\t\t\t// Create read connection pool for concurrent reads\n\t\t\tthis.readConnectionPool = new ConnectionPool(this.dbPath, undefined, 4);\n\n\t\t\t// Run migrations to ensure schema is up to date\n\t\t\tthis.runMigrations();\n\n\t\t\tthis.initialized = true;\n\t\t} catch (error) {\n\t\t\tif (error instanceof StorageConnectionError) {\n\t\t\t\t// Re-throw database connectivity errors with full details\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\tif (error instanceof Error) {\n\t\t\t\t// Determine which part of initialization failed for better DX\n\t\t\t\tconst message = error.message;\n\t\t\t\tlet specificError = \"Failed to initialize storage broker\";\n\n\t\t\t\tif (message.includes(\"sqlite\")) {\n\t\t\t\t\tspecificError = `Database initialization failed: ${message}`;\n\t\t\t\t}\n\n\t\t\t\tthrow new StorageError(specificError, \"STORAGE_BROKER_INIT_ERROR\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow new StorageError(\"Failed to initialize storage broker\", \"STORAGE_BROKER_INIT_ERROR\", {\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n\t * Get the database instance\n\t * @returns The database instance, or null if not initialized\n\t * @public This is intentionally public to allow direct database access for advanced operations\n\t */\n\tgetDatabase(): DatabaseInstance | null {\n\t\treturn this.db;\n\t}\n\n\t/**\n\t * Run database migrations to ensure schema is up to date\n\t */\n\tprivate runMigrations(): void {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\n\t\tthis.db.exec(`\n      CREATE TABLE IF NOT EXISTS snapshots (\n        id TEXT PRIMARY KEY,\n        name TEXT NOT NULL,\n        timestamp INTEGER NOT NULL,\n        parent_id TEXT,\n        metadata TEXT,\n        FOREIGN KEY (parent_id) REFERENCES snapshots(id)\n      );\n\n      CREATE TABLE IF NOT EXISTS file_changes (\n        snapshot_id TEXT NOT NULL,\n        file_path TEXT NOT NULL,\n        action TEXT CHECK(action IN ('add','modify','delete')),\n        diff BLOB,\n        storage_type TEXT DEFAULT 'diff',\n        content_size INTEGER,\n        PRIMARY KEY (snapshot_id, file_path),\n        FOREIGN KEY (snapshot_id) REFERENCES snapshots(id) ON DELETE CASCADE\n      );\n\n      -- Add sessions table for session-aware snapshots\n      CREATE TABLE IF NOT EXISTS sessions (\n        id TEXT PRIMARY KEY,\n        started_at INTEGER NOT NULL,\n        ended_at INTEGER NOT NULL,\n        reason TEXT NOT NULL,\n        summary TEXT,\n        tags TEXT,\n        metadata TEXT\n      );\n\n      CREATE TABLE IF NOT EXISTS session_files (\n        session_id TEXT NOT NULL,\n        snapshot_id TEXT NOT NULL,\n        file_path TEXT NOT NULL,\n        added_count INTEGER DEFAULT 0,\n        deleted_count INTEGER DEFAULT 0,\n        PRIMARY KEY (session_id, file_path),\n        FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE,\n        FOREIGN KEY (snapshot_id) REFERENCES snapshots(id) ON DELETE CASCADE\n      );\n\n      -- Add queue persistence table for operation queuing\n      CREATE TABLE IF NOT EXISTS queued_operations (\n        id TEXT PRIMARY KEY,\n        operation_name TEXT NOT NULL,\n        priority INTEGER NOT NULL,\n        created_at INTEGER NOT NULL,\n        data BLOB,\n        status TEXT CHECK(status IN ('pending','processing','completed','failed')) DEFAULT 'pending'\n      );\n\n      -- Single-column indexes\n      CREATE INDEX IF NOT EXISTS idx_snapshot_timestamp ON snapshots(timestamp);\n      CREATE INDEX IF NOT EXISTS idx_snapshot_parent ON snapshots(parent_id);\n      CREATE INDEX IF NOT EXISTS idx_file_path ON file_changes(file_path);\n      CREATE INDEX IF NOT EXISTS idx_session_started_at ON sessions(started_at);\n      CREATE INDEX IF NOT EXISTS idx_session_ended_at ON sessions(ended_at);\n      CREATE INDEX IF NOT EXISTS idx_session_reason ON sessions(reason);\n      CREATE INDEX IF NOT EXISTS idx_queued_operations_priority ON queued_operations(priority);\n      CREATE INDEX IF NOT EXISTS idx_queued_operations_status ON queued_operations(status);\n      CREATE INDEX IF NOT EXISTS idx_queued_operations_created_at ON queued_operations(created_at);\n\n      -- Covering indexes for common queries\n      CREATE INDEX IF NOT EXISTS idx_snapshots_list\n        ON snapshots(timestamp DESC, id, name);\n\n      CREATE INDEX IF NOT EXISTS idx_file_changes_snapshot\n        ON file_changes(snapshot_id, file_path, action);\n\n      CREATE INDEX IF NOT EXISTS idx_file_changes_file_covering\n        ON file_changes(file_path, snapshot_id)\n        WHERE action != 'delete';\n\n      -- Covering indexes for session queries\n      CREATE INDEX IF NOT EXISTS idx_sessions_list\n        ON sessions(ended_at DESC, id, reason);\n\n      CREATE INDEX IF NOT EXISTS idx_session_files_session\n        ON session_files(session_id, file_path);\n\n      -- Covering index for queued operations\n      CREATE INDEX IF NOT EXISTS idx_queued_operations_list\n        ON queued_operations(priority ASC, created_at ASC, id, status)\n        WHERE status = 'pending';\n\n      -- Add writers_lock table for single-writer discipline across processes\n      CREATE TABLE IF NOT EXISTS writers_lock (\n        id INTEGER PRIMARY KEY CHECK (id = 1),\n        writer_id TEXT,\n        acquired_at INTEGER,\n        expires_at INTEGER\n      );\n\n      -- Initialize the lock row if it doesn't exist\n      INSERT OR IGNORE INTO writers_lock (id, writer_id, acquired_at, expires_at)\n      VALUES (1, NULL, 0, 0);\n    `);\n\t}\n\n\t/**\n\t * Close the storage broker and database connection\n\t */\n\tasync close(): Promise<void> {\n\t\ttry {\n\t\t\t// Process any remaining operations in the queue before closing\n\t\t\tawait this.processQueue();\n\n\t\t\tif (this.db) {\n\t\t\t\tthis.db.close();\n\t\t\t\tthis.db = null;\n\t\t\t}\n\n\t\t\tif (this.readConnectionPool) {\n\t\t\t\tthis.readConnectionPool.close();\n\t\t\t\tthis.readConnectionPool = null;\n\t\t\t}\n\n\t\t\tthis.initialized = false;\n\t\t} catch (error) {\n\t\t\tthrow new StorageError(\"Failed to close storage broker\", \"STORAGE_BROKER_CLOSE_ERROR\", { cause: error });\n\t\t}\n\t}\n\n\t/**\n\t * Get a read connection from the pool for concurrent read operations\n\t */\n\tprivate async getReadConnection(): Promise<DatabaseInstance> {\n\t\tif (!this.readConnectionPool) {\n\t\t\tthrow new StorageError(\"Read connection pool not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\t\treturn await this.readConnectionPool.getConnection();\n\t}\n\n\t/**\n\t * Check if better-sqlite3 is available\n\t */\n\tstatic async isAvailable(): Promise<boolean> {\n\t\treturn await isBetterSqlite3Available();\n\t}\n\n\t/**\n\t * Get the error that occurred when loading better-sqlite3, if any\n\t */\n\tstatic getLoadError(): Error | null {\n\t\treturn getBetterSqlite3LoadError();\n\t}\n\n\t/**\n\t * Attempt to acquire a distributed lock for writing\n\t * @param writerId Unique identifier for this writer process\n\t * @param timeoutMs Maximum time to wait for the lock in milliseconds\n\t * @returns True if lock was acquired, false otherwise\n\t */\n\tprivate async acquireLock(writerId: string, timeoutMs = 5000): Promise<boolean> {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\n\t\tconst startTime = Date.now();\n\t\tconst maxWaitTime = timeoutMs;\n\t\tlet waitTime = 10; // Start with 10ms\n\n\t\twhile (Date.now() - startTime < maxWaitTime) {\n\t\t\ttry {\n\t\t\t\t// Try to acquire the lock using an atomic update\n\t\t\t\tconst result = this.db\n\t\t\t\t\t.prepare(`\n\t\t\t\t\tUPDATE writers_lock\n\t\t\t\t\tSET writer_id = ?, acquired_at = ?, expires_at = ?\n\t\t\t\t\tWHERE (writer_id IS NULL OR expires_at < ?) AND id = 1\n\t\t\t\t`)\n\t\t\t\t\t.run(writerId, Date.now(), Date.now() + 30000, Date.now());\n\n\t\t\t\t// If we updated exactly one row, we got the lock\n\t\t\t\tif (result.changes === 1) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\t// If we didn't get the lock, wait and try again with exponential backoff\n\t\t\t\tawait new Promise((resolve) =>\n\t\t\t\t\tsetTimeout(resolve, Math.min(waitTime, maxWaitTime - (Date.now() - startTime))),\n\t\t\t\t);\n\t\t\t\twaitTime = Math.min(waitTime * 2, 1000); // Max 1 second wait\n\t\t\t} catch (error) {\n\t\t\t\t// Log error but continue trying\n\t\t\t\tconsole.warn(\"Failed to acquire lock:\", error);\n\t\t\t\tawait new Promise((resolve) =>\n\t\t\t\t\tsetTimeout(resolve, Math.min(waitTime, maxWaitTime - (Date.now() - startTime))),\n\t\t\t\t);\n\t\t\t\twaitTime = Math.min(waitTime * 2, 1000);\n\t\t\t}\n\t\t}\n\n\t\t// Timeout reached\n\t\treturn false;\n\t}\n\n\t/**\n\t * Release the distributed lock\n\t * @param writerId Unique identifier for this writer process\n\t */\n\tprivate async releaseLock(writerId: string): Promise<void> {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\n\t\ttry {\n\t\t\t// Only release if we're the current holder\n\t\t\tthis.db\n\t\t\t\t.prepare(`\n\t\t\t\tUPDATE writers_lock\n\t\t\t\tSET writer_id = NULL, acquired_at = 0, expires_at = 0\n\t\t\t\tWHERE writer_id = ? AND id = 1\n\t\t\t`)\n\t\t\t\t.run(writerId);\n\t\t} catch (error) {\n\t\t\t// Log error but don't throw - we don't want to fail the operation if we can't release the lock\n\t\t\tconsole.warn(\"Failed to release lock:\", error);\n\t\t}\n\t}\n\n\t/**\n\t * Create a snapshot through the queued operation system to ensure single-writer discipline\n\t * @param name The snapshot name\n\t * @param files Map of file paths to content\n\t * @param metadata Optional metadata\n\t * @param parentId Optional parent snapshot ID\n\t * @param id Optional snapshot ID (if not provided, one will be generated)\n\t * @returns Snapshot information\n\t */\n\tasync createSnapshot(\n\t\tname: string,\n\t\tfiles: Map<string, string>,\n\t\tmetadata?: Record<string, unknown>,\n\t\tparentId?: string,\n\t\tid?: string,\n\t): Promise<{\n\t\tid: string;\n\t\tname: string;\n\t\tfileCount: number;\n\t\ttimestamp: number;\n\t}> {\n\t\t// Use the queue system to ensure single-writer discipline\n\t\treturn this.queueOperation(\"createSnapshot\", async () => {\n\t\t\tif (!this.db) {\n\t\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t\t}\n\n\t\t\t// Use provided ID or generate a new one\n\t\t\tconst snapshotId = id || generateId();\n\t\t\tconst timestamp = Date.now();\n\n\t\t\t// Pre-compress all file content outside the transaction\n\t\t\tconst preCompressedFiles = new Map<\n\t\t\t\tstring,\n\t\t\t\t{ compressed: Buffer; storageType: string; contentSize: number }\n\t\t\t>();\n\n\t\t\t// Process each file for pre-compression\n\t\t\tArray.from(files.entries()).forEach(([filePath, content]) => {\n\t\t\t\tconst contentSize = Buffer.byteLength(content, \"utf-8\");\n\t\t\t\t// For simplicity, we'll store full content for all files\n\t\t\t\tconst compressed = compress(content);\n\t\t\t\tpreCompressedFiles.set(filePath, {\n\t\t\t\t\tcompressed,\n\t\t\t\t\tstorageType: \"full\",\n\t\t\t\t\tcontentSize,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\ttry {\n\t\t\t\t// Begin transaction for atomic operation\n\t\t\t\tconst insert = this.db.transaction(() => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Insert snapshot record with timestamp and full metadata\n\t\t\t\t\t\tif (this.db) {\n\t\t\t\t\t\t\tthis.db\n\t\t\t\t\t\t\t\t.prepare(\n\t\t\t\t\t\t\t\t\t`\n\t\t\t\t\tINSERT INTO snapshots (id, name, timestamp, parent_id, metadata)\n\t\t\t\t\tVALUES (?, ?, ?, ?, ?)\n\t\t\t\t`,\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.run(\n\t\t\t\t\t\t\t\t\tsnapshotId,\n\t\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\t\ttimestamp,\n\t\t\t\t\t\t\t\t\tparentId || null,\n\t\t\t\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\t\t\t\tfileCount: files.size,\n\t\t\t\t\t\t\t\t\t\tcreatedBy: \"snapback\",\n\t\t\t\t\t\t\t\t\t\t...metadata,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t// Insert file changes\n\t\t\t\t\t\t\tif (this.db) {\n\t\t\t\t\t\t\t\tconst stmt = this.db.prepare(`\n\t\t\t\t\tINSERT INTO file_changes (snapshot_id, file_path, action, diff, storage_type, content_size)\n\t\t\t\t\tVALUES (?, ?, ?, ?, ?, ?)\n\t\t\t\t`);\n\n\t\t\t\t\t\t\t\t// Process each pre-compressed file\n\t\t\t\t\t\t\t\tpreCompressedFiles.forEach((preCompressed, filePath) => {\n\t\t\t\t\t\t\t\t\tconst { compressed, storageType, contentSize } = preCompressed;\n\t\t\t\t\t\t\t\t\tconst action = \"add\"; // For simplicity, all files are \"add\" in this implementation\n\t\t\t\t\t\t\t\t\tstmt.run(snapshotId, filePath, action, compressed, storageType, contentSize);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (queryError: unknown) {\n\t\t\t\t\t\tconst message = queryError instanceof Error ? queryError.message : String(queryError);\n\t\t\t\t\t\tthrow new StorageError(`Failed to create snapshot: ${message}`, \"STORAGE_QUERY_ERROR\", {\n\t\t\t\t\t\t\tcause: queryError,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tinsert();\n\n\t\t\t\treturn { id: snapshotId, name, fileCount: files.size, timestamp };\n\t\t\t} catch (error) {\n\t\t\t\tif (error instanceof StorageError || error instanceof StorageTransactionError) {\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tthrow new StorageError(`Failed to create snapshot: ${message}`, \"STORAGE_CREATE_SNAPSHOT_ERROR\", {\n\t\t\t\t\tcause: error,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Queue an operation for execution\n\t * @param operationName Name of the operation for logging\n\t * @param operation Function to execute\n\t * @param priority Priority of the operation (lower number = higher priority)\n\t * @returns Promise that resolves when the operation completes\n\t */\n\tasync queueOperation<T>(operationName: string, operation: () => Promise<T>, priority = 0): Promise<T> {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tconst id = generateId();\n\t\t\tconst timestamp = Date.now();\n\n\t\t\tconst queuedOp: QueuedOperation<T> = {\n\t\t\t\tid,\n\t\t\t\toperationName,\n\t\t\t\tpriority,\n\t\t\t\toperation, // Simplified - no lock management here\n\t\t\t\tresolve,\n\t\t\t\treject,\n\t\t\t\ttimestamp,\n\t\t\t};\n\n\t\t\t// Persist the operation to the database\n\t\t\ttry {\n\t\t\t\tif (this.db) {\n\t\t\t\t\tconst stmt = this.db.prepare(`\n            INSERT INTO queued_operations (id, operation_name, priority, created_at, status)\n            VALUES (?, ?, ?, ?, ?)\n          `);\n\n\t\t\t\t\tstmt.run(id, operationName, priority, timestamp, \"pending\");\n\t\t\t\t}\n\n\t\t\t\t// Add to in-memory queue and sort by priority\n\t\t\t\tthis.operationQueue.push(queuedOp);\n\t\t\t\tthis.operationQueue.sort((a, b) => {\n\t\t\t\t\t// First sort by priority (lower number = higher priority)\n\t\t\t\t\tif (a.priority !== b.priority) {\n\t\t\t\t\t\treturn a.priority - b.priority;\n\t\t\t\t\t}\n\t\t\t\t\t// Then sort by timestamp (FIFO for same priority)\n\t\t\t\t\treturn a.timestamp - b.timestamp;\n\t\t\t\t});\n\n\t\t\t\t// Start processing if not already processing\n\t\t\t\tif (!this.isProcessingQueue) {\n\t\t\t\t\tthis.processQueue();\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\treject(error);\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Process the operation queue with single-writer discipline\n\t */\n\tprivate async processQueue(): Promise<void> {\n\t\tif (this.isProcessingQueue) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.isProcessingQueue = true;\n\n\t\ttry {\n\t\t\t// Check if there are operations in the queue\n\t\t\tif (this.operationQueue.length > 0) {\n\t\t\t\t// Acquire lock before processing the next operation\n\t\t\t\tconst lockAcquired = await this.acquireLock(this.writerId, 10000); // 10 second timeout\n\t\t\t\tif (!lockAcquired) {\n\t\t\t\t\t// If we can't acquire the lock, reschedule processing\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tthis.isProcessingQueue = false;\n\t\t\t\t\t\tif (this.operationQueue.length > 0) {\n\t\t\t\t\t\t\tthis.processQueue();\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 100); // Try again in 100ms\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\t// Sort queue before processing to ensure priority order\n\t\t\t\t\tthis.operationQueue.sort((a, b) => {\n\t\t\t\t\t\t// First sort by priority (lower number = higher priority)\n\t\t\t\t\t\tif (a.priority !== b.priority) {\n\t\t\t\t\t\t\treturn a.priority - b.priority;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Then sort by timestamp (FIFO for same priority)\n\t\t\t\t\t\treturn a.timestamp - b.timestamp;\n\t\t\t\t\t});\n\n\t\t\t\t\t// Process only ONE operation per lock acquisition to ensure fair sharing\n\t\t\t\t\tif (this.operationQueue.length > 0) {\n\t\t\t\t\t\tconst queuedOp = this.operationQueue.shift();\n\t\t\t\t\t\tif (queuedOp) {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst result = await queuedOp.operation();\n\t\t\t\t\t\t\t\tqueuedOp.resolve(result);\n\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\tqueuedOp.reject(error);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} finally {\n\t\t\t\t\t// Always release the lock after processing one operation\n\t\t\t\t\tawait this.releaseLock(this.writerId);\n\t\t\t\t}\n\n\t\t\t\t// Small delay to allow other brokers to acquire the lock\n\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 1));\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Error processing queue:\", error);\n\t\t} finally {\n\t\t\tthis.isProcessingQueue = false;\n\t\t\t// If there are more operations, schedule processing of the next one\n\t\t\tif (this.operationQueue.length > 0) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.processQueue();\n\t\t\t\t}, 1); // Schedule next processing on next tick\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Get a snapshot by ID\n\t * @param id The snapshot ID\n\t * @returns Snapshot information or null if not found\n\t */\n\tasync getSnapshot(id: string): Promise<{\n\t\tid: string;\n\t\tname: string;\n\t\tfiles: Map<string, string>;\n\t\ttimestamp: number;\n\t\tmetadata: string;\n\t} | null> {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\n\t\t// Use read connection for better performance\n\t\tconst db = await this.getReadConnection();\n\n\t\ttry {\n\t\t\tconst row = db\n\t\t\t\t.prepare(`\n\t\t\t\tSELECT id, name, timestamp, metadata\n\t\t\t\tFROM snapshots\n\t\t\t\tWHERE id = ?\n\t\t\t`)\n\t\t\t\t.get(id);\n\n\t\t\tif (!row) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// Get file changes\n\t\t\tconst fileRows = db\n\t\t\t\t.prepare(`\n\t\t\t\tSELECT file_path, diff, storage_type\n\t\t\t\tFROM file_changes\n\t\t\t\tWHERE snapshot_id = ?\n\t\t\t`)\n\t\t\t\t.all(id);\n\n\t\t\tconst files = new Map<string, string>();\n\t\t\tfor (const fileRow of fileRows) {\n\t\t\t\ttry {\n\t\t\t\t\tconst typedFileRow = fileRow as { file_path: string; diff: Buffer };\n\t\t\t\t\tconst decompressed = gunzipSync(typedFileRow.diff);\n\t\t\t\t\tconst content = decompressed.toString(\"utf-8\");\n\t\t\t\t\tfiles.set(typedFileRow.file_path, content);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconst typedFileRow = fileRow as { file_path: string };\n\t\t\t\t\tconsole.warn(`Failed to decompress file ${typedFileRow.file_path}:`, error);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid: (row as { id: string }).id,\n\t\t\t\tname: (row as { name: string }).name,\n\t\t\t\tfiles,\n\t\t\t\ttimestamp: (row as { timestamp: number }).timestamp,\n\t\t\t\tmetadata: (row as { metadata: string }).metadata,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tthrow new StorageError(\n\t\t\t\t`Failed to get snapshot: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t\t\"STORAGE_GET_SNAPSHOT_ERROR\",\n\t\t\t\t{ cause: error },\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * List snapshots with optional filters\n\t * @param limit Maximum number of snapshots to return\n\t * @param offset Offset for pagination\n\t * @param sortBy Field to sort by\n\t * @param sortOrder Sort order (ASC or DESC)\n\t * @returns List of snapshots\n\t */\n\tasync listSnapshots(\n\t\tlimit = 50,\n\t\toffset = 0,\n\t\tsortBy = \"timestamp\",\n\t\tsortOrder: \"ASC\" | \"DESC\" = \"DESC\",\n\t): Promise<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tname: string;\n\t\t\ttimestamp: number;\n\t\t\tmetadata: string;\n\t\t}>\n\t> {\n\t\tif (!this.db) {\n\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t}\n\n\t\t// Use read connection for better performance\n\t\tconst db = await this.getReadConnection();\n\n\t\t// Create local variables to avoid mutating parameters\n\t\tlet validatedSortBy = sortBy;\n\t\tlet validatedSortOrder = sortOrder;\n\n\t\ttry {\n\t\t\t// Validate sortBy parameter\n\t\t\tconst validSortColumns = [\"timestamp\", \"name\", \"id\"];\n\t\t\tif (!validSortColumns.includes(validatedSortBy)) {\n\t\t\t\tvalidatedSortBy = \"timestamp\";\n\t\t\t}\n\n\t\t\t// Validate sortOrder parameter\n\t\t\tif (validatedSortOrder !== \"ASC\" && validatedSortOrder !== \"DESC\") {\n\t\t\t\tvalidatedSortOrder = \"DESC\";\n\t\t\t}\n\n\t\t\tconst rows = db\n\t\t\t\t.prepare(`\n\t\t\t\tSELECT id, name, timestamp, metadata\n\t\t\t\tFROM snapshots\n\t\t\t\tORDER BY ${validatedSortBy} ${validatedSortOrder}\n\t\t\t\tLIMIT ? OFFSET ?\n\t\t\t`)\n\t\t\t\t.all(limit, offset);\n\n\t\t\treturn rows.map((row) => ({\n\t\t\t\tid: (row as { id: string }).id,\n\t\t\t\tname: (row as { name: string }).name,\n\t\t\t\ttimestamp: (row as { timestamp: number }).timestamp,\n\t\t\t\tmetadata: (row as { metadata: string }).metadata,\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tthrow new StorageError(\n\t\t\t\t`Failed to list snapshots: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t\t\"STORAGE_LIST_SNAPSHOTS_ERROR\",\n\t\t\t\t{ cause: error },\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Delete a snapshot by ID\n\t * @param id The snapshot ID\n\t */\n\tasync deleteSnapshot(id: string): Promise<void> {\n\t\treturn this.queueOperation(`deleteSnapshot-${id}`, async () => {\n\t\t\tif (!this.db) {\n\t\t\t\tthrow new StorageError(\"Database not initialized\", \"STORAGE_NOT_INITIALIZED\");\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\t// This will cascade delete file_changes due to foreign key constraint\n\t\t\t\tthis.db\n\t\t\t\t\t.prepare(`\n\t\t\t\t\tDELETE FROM snapshots\n\t\t\t\t\tWHERE id = ?\n\t\t\t\t`)\n\t\t\t\t\t.run(id);\n\t\t\t} catch (error) {\n\t\t\t\tthrow new StorageError(\n\t\t\t\t\t`Failed to delete snapshot: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t\t\t\"STORAGE_DELETE_SNAPSHOT_ERROR\",\n\t\t\t\t\t{ cause: error },\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\t}\n}\n","import type { Snapshot, SnapshotFilters } from \"@snapback-oss/contracts\";\nimport type { StorageAdapter } from \"./StorageAdapter\";\nimport { StorageBroker } from \"./StorageBroker\";\n\n/**\n * StorageBrokerAdapter - Adapter that makes StorageBroker compatible with StorageAdapter interface\n *\n * This adapter bridges the StorageBroker (with single-writer discipline) to the StorageAdapter interface\n * used by the rest of the codebase, ensuring all storage operations go through the single-writer broker.\n *\n * Key responsibilities:\n * - Convert StorageAdapter method calls to StorageBroker operations\n * - Maintain compatibility with existing code\n * - Ensure all operations are queued through the broker's single-writer discipline\n */\nexport class StorageBrokerAdapter implements StorageAdapter {\n\tprivate broker: StorageBroker;\n\n\tconstructor(dbPath: string) {\n\t\tthis.broker = new StorageBroker(dbPath);\n\t}\n\n\tasync initialize(): Promise<void> {\n\t\tawait this.broker.initialize();\n\t}\n\n\tasync save(snapshot: Snapshot, contentHash?: string): Promise<void> {\n\t\t// Convert the save operation to a createSnapshot operation\n\t\t// We need to convert the Snapshot format to what createSnapshot expects\n\t\tconst filesMap = new Map<string, string>();\n\t\tif (snapshot.fileContents) {\n\t\t\tfor (const [filePath, content] of Object.entries(snapshot.fileContents)) {\n\t\t\t\tfilesMap.set(filePath, content);\n\t\t\t}\n\t\t}\n\n\t\t// Extract name from metadata or use a default\n\t\tconst name = snapshot.meta?.name || snapshot.meta?.trigger || \"snapshot\";\n\n\t\t// Include contentHash in metadata\n\t\tconst metadata = {\n\t\t\t...snapshot.meta,\n\t\t\tcontentHash,\n\t\t};\n\n\t\t// Call createSnapshot directly since it already handles queuing internally\n\t\t// Pass the snapshot ID to ensure it's used\n\t\tawait this.broker.createSnapshot(name, filesMap, metadata, undefined, snapshot.id);\n\t}\n\n\tasync get(id: string): Promise<Snapshot | null> {\n\t\ttry {\n\t\t\t// For get operations, we can use the broker's getSnapshot method\n\t\t\tconst result = await this.broker.getSnapshot(id);\n\n\t\t\tif (!result) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\t// Convert the result to the Snapshot format\n\t\t\tlet metadata = {};\n\t\t\ttry {\n\t\t\t\tmetadata = JSON.parse(result.metadata);\n\t\t\t} catch (_error) {\n\t\t\t\t// Ignore parsing errors and use empty metadata\n\t\t\t}\n\n\t\t\t// Convert Map back to Record format for compatibility\n\t\t\tconst fileContents: Record<string, string> = {};\n\t\t\tfor (const [filePath, content] of result.files) {\n\t\t\t\tfileContents[filePath] = content;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid: result.id,\n\t\t\t\ttimestamp: result.timestamp,\n\t\t\t\tversion: \"1.0\",\n\t\t\t\tmeta: metadata,\n\t\t\t\tfiles: Array.from(result.files.keys()),\n\t\t\t\tfileContents,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\t// Log the error but don't throw - return null to indicate not found\n\t\t\tconsole.error(`Error retrieving snapshot ${id}:`, error);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tasync list(filters?: SnapshotFilters): Promise<Snapshot[]> {\n\t\ttry {\n\t\t\t// Convert filters to parameters for listSnapshots\n\t\t\tconst limit = filters?.limit || 50;\n\t\t\tconst offset = filters?.offset || 0;\n\n\t\t\t// For now, we'll sort by timestamp DESC as that's the most common use case\n\t\t\tconst snapshots = await this.broker.listSnapshots(limit, offset, \"timestamp\", \"DESC\");\n\n\t\t\t// Convert the results to the Snapshot format\n\t\t\tconst result: Snapshot[] = [];\n\t\t\tfor (const snapshot of snapshots) {\n\t\t\t\tlet metadata = {};\n\t\t\t\ttry {\n\t\t\t\t\tmetadata = JSON.parse(snapshot.metadata);\n\t\t\t\t} catch (_error) {\n\t\t\t\t\t// Ignore parsing errors and use empty metadata\n\t\t\t\t}\n\n\t\t\t\tresult.push({\n\t\t\t\t\tid: snapshot.id,\n\t\t\t\t\ttimestamp: snapshot.timestamp,\n\t\t\t\t\tversion: \"1.0\",\n\t\t\t\t\tmeta: metadata,\n\t\t\t\t\tfiles: [], // We don't load files in list view for performance\n\t\t\t\t\tfileContents: {},\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\t// Log the error but don't throw - return empty array\n\t\t\tconsole.error(\"Error listing snapshots:\", error);\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tasync delete(id: string): Promise<void> {\n\t\ttry {\n\t\t\tawait this.broker.deleteSnapshot(id);\n\t\t} catch (error) {\n\t\t\t// Log the error but don't throw - delete should be idempotent\n\t\t\tconsole.error(`Error deleting snapshot ${id}:`, error);\n\t\t}\n\t}\n\n\tasync close(): Promise<void> {\n\t\ttry {\n\t\t\tawait this.broker.close();\n\t\t} catch (error) {\n\t\t\t// Log the error but don't throw - we're closing anyway\n\t\t\tconsole.error(\"Error closing storage:\", error);\n\t\t}\n\t}\n}\n","/**\n * Centralized ID Generation\n *\n * RE-EXPORTS FROM @snapback-oss/contracts - Single Source of Truth\n * SDK provides typed wrappers for convenience.\n *\n * @module id-generation\n */\n\nimport { randomBytes } from \"node:crypto\";\nimport {\n\tgenerateId as contractsGenerateId,\n\tgenerateSnapshotId as contractsGenerateSnapshotId,\n} from \"@snapback-oss/contracts\";\n\n// Types (defined locally to avoid circular deps with contracts)\nexport type SessionId = `sess-${string}`;\nexport type SnapshotId = `snap-${string}`;\n\n/**\n * ID prefixes for different entity types\n */\nexport const ID_PREFIX = {\n\tSESSION: \"sess\",\n\tSNAPSHOT: \"snap\", // Short form, aligned with contracts\n\tAUDIT: \"audit\",\n\tCHECKPOINT: \"cp\",\n} as const;\n\nexport type IdPrefix = (typeof ID_PREFIX)[keyof typeof ID_PREFIX];\n\n/**\n * Generate a cryptographically random alphanumeric suffix\n * @internal Used by session/audit/checkpoint IDs\n */\nfunction randomSuffix(length = 6): string {\n\tconst chars = \"abcdefghijklmnopqrstuvwxyz0123456789\";\n\tconst bytes = randomBytes(length);\n\tlet result = \"\";\n\tfor (let i = 0; i < length; i++) {\n\t\tresult += chars[bytes[i] % chars.length];\n\t}\n\treturn result;\n}\n\n/**\n * Generate a session ID\n * Format: sess-<timestamp>-<random>\n */\nexport function generateSessionId(): SessionId {\n\treturn `${ID_PREFIX.SESSION}-${Date.now()}-${randomSuffix()}` as SessionId;\n}\n\n/**\n * Generate a snapshot ID - delegates to @snapback-oss/contracts\n * Format: snapshot-<slug>-<timestamp>-<random> (with description)\n *         snapshot-<timestamp>-<random> (without)\n *\n * @param description - Optional human-readable description\n */\nexport function generateSnapshotId(description?: string): SnapshotId {\n\treturn contractsGenerateSnapshotId(description) as SnapshotId;\n}\n\n/**\n * General purpose ID generation - delegates to @snapback-oss/contracts\n */\nexport function generateId(prefix?: string): string {\n\treturn contractsGenerateId(prefix);\n}\n\n/**\n * Generate an audit entry ID with unified format\n *\n * Format: audit-<timestamp>-<random>\n * Example: audit-1733657123456-d4e5f6\n *\n * @returns Audit ID string\n */\nexport function generateAuditId(): string {\n\treturn `${ID_PREFIX.AUDIT}-${Date.now()}-${randomSuffix()}`;\n}\n\n/**\n * Generate a checkpoint ID with unified format\n *\n * Format: cp-<timestamp>-<random>\n * Example: cp-1733657123456-g7h8i9\n *\n * @returns Checkpoint ID string\n */\nexport function generateCheckpointId(): string {\n\treturn `${ID_PREFIX.CHECKPOINT}-${Date.now()}-${randomSuffix()}`;\n}\n\n/**\n * Generate a random alphanumeric ID string\n *\n * @param length - Length of the ID (default: 6)\n * @returns Lowercase alphanumeric string\n */\nexport function randomId(length = 6): string {\n\treturn randomSuffix(length);\n}\n\n/**\n * Parse timestamp from a generated ID\n *\n * Handles all ID formats:\n * - sess-<timestamp>-<random>\n * - audit-<timestamp>-<random>\n * - cp-<timestamp>-<random>\n * - snap-<timestamp>-<random>\n * - snap-<slug>-<timestamp>-<random>\n * - snapshot-<timestamp>-<random> (legacy)\n * - snapshot-<slug>-<timestamp>-<random> (legacy)\n *\n * @param id - ID string to parse\n * @returns Timestamp in milliseconds, or null if invalid format\n */\nexport function parseIdTimestamp(id: string): number | null {\n\t// Validate known prefix (includes legacy \"snapshot\" for backward compatibility)\n\tif (!id.match(/^(?:sess|snap|snapshot|audit|cp)-/)) {\n\t\treturn null;\n\t}\n\n\t// Match 13-digit timestamp before the final random suffix\n\t// Works for both `prefix-<timestamp>-<random>` and `prefix-<slug>-<timestamp>-<random>`\n\tconst match = id.match(/-(\\d{13})-[a-zA-Z0-9_-]+$/);\n\tif (!match) {\n\t\treturn null;\n\t}\n\tconst timestamp = Number.parseInt(match[1], 10);\n\treturn Number.isNaN(timestamp) ? null : timestamp;\n}\n\n/**\n * Extract the prefix from a generated ID\n *\n * @param id - ID string to parse\n * @returns ID prefix or null if invalid format\n */\nexport function parseIdPrefix(id: string): IdPrefix | null {\n\t// Handle legacy \"snapshot\" prefix as \"snap\"\n\tif (id.startsWith(\"snapshot-\")) {\n\t\treturn \"snap\" as IdPrefix;\n\t}\n\tconst match = id.match(/^(sess|snap|audit|cp)-/);\n\treturn match ? (match[1] as IdPrefix) : null;\n}\n\n/**\n * Validate that an ID matches the expected format\n *\n * Handles formats:\n * - sess/audit/cp-<timestamp>-<6 random chars>\n * - snap-<timestamp>-<9 random chars>\n * - snap-<slug>-<timestamp>-<9 random chars>\n * - snapshot-* (legacy format, also valid)\n *\n * @param id - ID string to validate\n * @param expectedPrefix - Expected prefix (optional, validates any if not specified)\n * @returns True if valid, false otherwise\n */\nexport function isValidId(id: string, expectedPrefix?: IdPrefix): boolean {\n\t// Snapshot IDs can have optional slug and use 9-char suffix\n\t// Also handle legacy \"snapshot-\" prefix\n\tconst isSnapshotId = id.startsWith(\"snap-\") || id.startsWith(\"snapshot-\");\n\tif (expectedPrefix === \"snap\" || (!expectedPrefix && isSnapshotId)) {\n\t\treturn /^(?:snap|snapshot)-(?:[a-z0-9]+-)?(\\d{13})-[a-zA-Z0-9_-]{9}$/.test(id);\n\t}\n\n\t// Non-snapshot IDs use 6-char suffix\n\tif (expectedPrefix) {\n\t\tconst regex = new RegExp(`^${expectedPrefix}-\\\\d{13}-[a-z0-9]{6}$`);\n\t\treturn regex.test(id);\n\t}\n\treturn /^(?:sess|audit|cp)-\\d{13}-[a-z0-9]{6}$/.test(id);\n}\n","/**\n * Platform-agnostic path normalization utilities\n *\n * Handles differences between Windows and Unix-style paths,\n * ensuring consistent path comparison across platforms.\n *\n * @module PathNormalizer\n */\n\n/**\n * Normalize path separators to forward slashes\n * Remove trailing slashes (except for Unix root \"/\")\n *\n * @param path - Path to normalize\n * @returns Normalized path with forward slashes and no trailing slash\n *\n * @example\n * ```typescript\n * normalize('C:\\\\Users\\\\test\\\\') // => 'C:/Users/test'\n * normalize('/home/user/project/') // => '/home/user/project'\n * normalize('/') // => '/'\n * ```\n */\nexport function normalize(path: string): string {\n\t// Convert backslashes to forward slashes\n\tlet normalized = path.replace(/\\\\/g, \"/\");\n\t// Collapse multiple consecutive slashes to single slash\n\tnormalized = normalized.replace(/\\/+/g, \"/\");\n\t// Remove trailing slash (but preserve root \"/\")\n\tnormalized = normalized.replace(/\\/+$/, \"\");\n\t// Special case: Don't strip single \"/\" (Unix root)\n\treturn normalized === \"\" && path.startsWith(\"/\") ? \"/\" : normalized;\n}\n\n/**\n * Check if childPath is within parentPath\n *\n * @param childPath - Path to check\n * @param parentPath - Parent directory path\n * @returns true if childPath is within parentPath\n *\n * @example\n * ```typescript\n * isWithin('/home/user/project/src/index.ts', '/home/user/project') // => true\n * isWithin('/external/file.ts', '/home/user/project') // => false\n * isWithin('C:\\\\Users\\\\test\\\\file.ts', 'C:\\\\Users\\\\test') // => true\n * ```\n */\nexport function isWithin(childPath: string, parentPath: string): boolean {\n\tconst normalizedChild = normalize(childPath);\n\tconst normalizedParent = normalize(parentPath);\n\n\treturn normalizedChild.startsWith(`${normalizedParent}/`) || normalizedChild === normalizedParent;\n}\n\n/**\n * Get the depth of a path (number of directory levels)\n *\n * @param path - Path to measure\n * @returns Number of directory levels\n *\n * @example\n * ```typescript\n * getDepth('/') // => 1 (Unix root)\n * getDepth('/home') // => 2\n * getDepth('/home/user/project') // => 4\n * getDepth('C:\\\\Users\\\\test\\\\project\\\\src') // => 5\n * ```\n */\nexport function getDepth(path: string): number {\n\tconst normalized = normalize(path);\n\n\t// Special case: Unix root \"/\" has depth 1\n\tif (normalized === \"/\") {\n\t\treturn 1;\n\t}\n\n\t// Filter out empty strings from split\n\tconst segments = normalized.split(\"/\").filter((segment) => segment.length > 0);\n\n\t// Unix paths start with \"/\" so add 1 for the root\n\t// Windows paths start with drive letter (e.g., \"C:\") which counts as a segment\n\tconst isUnixPath = path.startsWith(\"/\");\n\treturn isUnixPath ? segments.length + 1 : segments.length;\n}\n\n/**\n * Compare paths for equality\n * Case-insensitive on Windows, case-sensitive on Unix\n *\n * @param path1 - First path\n * @param path2 - Second path\n * @returns true if paths are equal\n *\n * @example\n * ```typescript\n * // Unix (case-sensitive)\n * areEqual('/home/User/project', '/home/user/project') // => false\n *\n * // Windows (case-insensitive)\n * areEqual('C:\\\\Users\\\\Test', 'C:\\\\Users\\\\test') // => true\n * ```\n */\nexport function areEqual(path1: string, path2: string): boolean {\n\tconst norm1 = normalize(path1);\n\tconst norm2 = normalize(path2);\n\n\t// Detect platform - Windows paths start with drive letter (e.g., \"C:\")\n\tconst isWindows = /^[a-zA-Z]:/.test(norm1) || /^[a-zA-Z]:/.test(norm2);\n\n\tif (isWindows) {\n\t\treturn norm1.toLowerCase() === norm2.toLowerCase();\n\t}\n\t// Case-sensitive on Unix\n\treturn norm1 === norm2;\n}\n","/**\n * Risk Factor Descriptions and Transformations\n *\n * Centralized mappings for converting risk factor identifiers to human-readable\n * descriptions across all SnapBack platforms (VSCode, CLI, Web, API).\n *\n * This ensures consistent risk communication and simplifies integration for clients.\n */\n\n/**\n * Mapping of risk factor identifiers to detailed descriptions\n * Used to transform raw factor strings into user-friendly explanations\n */\nexport const RISK_FACTOR_DESCRIPTIONS: Record<string, string> = {\n\t\"eval execution\": \"Dynamic code execution detected - eval() allows runtime code execution\",\n\t\"sql injection\": \"SQL injection vulnerability pattern - concatenated user input in queries\",\n\t\"command execution\": \"Dangerous shell command usage - potential OS command injection\",\n\t\"hardcoded secret\": \"Potential secret/credential found in code - API keys, tokens exposed\",\n\t\"auth bypass\": \"Authentication bypass pattern - insufficient access control checks\",\n\t\"path traversal\": \"Directory traversal vulnerability - unrestricted path access\",\n\t\"xss pattern\": \"Cross-site scripting vulnerability - unsanitized user input in DOM\",\n\tdeserialization: \"Unsafe deserialization detected - potential object injection\",\n\tcryptography: \"Weak cryptography usage - deprecated algorithms or insufficient key length\",\n\t\"dependency change\": \"Dependency version change - verify no breaking changes or vulnerabilities\",\n};\n\n/**\n * Transform raw risk factor identifiers into human-readable descriptions\n *\n * This is the canonical method for converting risk factor strings to descriptions\n * across all SnapBack platforms. Use this instead of custom implementations.\n *\n * @param factors - Array of raw risk factor identifiers\n * @returns Array of human-readable risk factor descriptions\n *\n * @example\n * ```typescript\n * import { describeRiskFactors } from '@snapback/sdk';\n *\n * const rawFactors = [\"eval execution\", \"sql injection\"];\n * const descriptions = describeRiskFactors(rawFactors);\n * // Returns: [\n * //   \"Dynamic code execution detected...\",\n * //   \"SQL injection vulnerability pattern...\"\n * // ]\n * ```\n */\nexport function describeRiskFactors(factors: string[]): string[] {\n\treturn factors.map((factor) => RISK_FACTOR_DESCRIPTIONS[factor.toLowerCase()] || factor);\n}\n\n/**\n * Get description for a single risk factor\n *\n * @param factor - Risk factor identifier\n * @returns Human-readable description, or original factor if not found in mapping\n *\n * @example\n * ```typescript\n * import { describeRiskFactor } from '@snapback/sdk';\n *\n * const description = describeRiskFactor(\"eval execution\");\n * // Returns: \"Dynamic code execution detected - eval() allows runtime code execution\"\n * ```\n */\nexport function describeRiskFactor(factor: string): string {\n\treturn RISK_FACTOR_DESCRIPTIONS[factor.toLowerCase()] || factor;\n}\n\n/**\n * Check if a risk factor is recognized in the standard mapping\n *\n * @param factor - Risk factor identifier\n * @returns True if factor has a description in the standard mapping\n *\n * @example\n * ```typescript\n * import { isKnownRiskFactor } from '@snapback/sdk';\n *\n * isKnownRiskFactor(\"eval execution\"); // true\n * isKnownRiskFactor(\"unknown factor\"); // false\n * ```\n */\nexport function isKnownRiskFactor(factor: string): boolean {\n\treturn factor.toLowerCase() in RISK_FACTOR_DESCRIPTIONS;\n}\n\n/**\n * Get all available risk factor identifiers\n *\n * @returns Array of all standard risk factor identifiers\n *\n * @example\n * ```typescript\n * import { getStandardRiskFactors } from '@snapback/sdk';\n *\n * const factors = getStandardRiskFactors();\n * // Returns: [\"eval execution\", \"sql injection\", \"command execution\", ...]\n * ```\n */\nexport function getStandardRiskFactors(): string[] {\n\treturn Object.keys(RISK_FACTOR_DESCRIPTIONS);\n}\n","/**\n * Dashboard Metrics SDK Client (GREEN Phase Implementation)\n *\n * Provides a type-safe client for consuming dashboard metrics from the API.\n * Acts as a thin wrapper around the ORPC API client, enforcing package boundaries\n * and providing convenient methods for web app consumption.\n *\n * Usage:\n * ```typescript\n * import { createDashboardMetricsClient } from \"@snapback/sdk\";\n * import { orpcClient } from \"@shared/lib/orpc-client\";\n *\n * const client = createDashboardMetricsClient(orpcClient);\n * const result = await client.getDashboardMetrics();\n *\n * if (isDashboardMetrics(result)) {\n *   console.log(\"Total checkpoints:\", result.total_checkpoints);\n * } else {\n *   console.error(\"Error:\", result.code, result.message);\n * }\n * ```\n */\n\nimport type { DashboardMetricsResponse } from \"@snapback/contracts\";\n\n/**\n * ORPC Client Interface\n * Minimal interface needed by SDK client to work with ORPC API\n */\nexport interface ORPCClient {\n\tdashboard: {\n\t\tgetMetrics: () => Promise<DashboardMetricsResponse>;\n\t};\n}\n\n/**\n * Dashboard Metrics SDK Client Interface\n * Public API for consuming dashboard metrics\n */\nexport interface DashboardMetricsClient {\n\t/**\n\t * Get aggregated dashboard metrics for the authenticated user\n\t *\n\t * Returns discriminated union:\n\t * - Success: { protection_status, total_checkpoints, total_recoveries, ... }\n\t * - Error: { error: true, code: \"UNAUTHORIZED\" | \"NOT_FOUND\" | \"INTERNAL_ERROR\", message }\n\t *\n\t * @returns Promise<DashboardMetricsResponse>\n\t * @throws Error if network request fails\n\t *\n\t * @example\n\t * const result = await client.getDashboardMetrics();\n\t * if (isDashboardMetrics(result)) {\n\t *   // Success path - access metrics\n\t *   console.log(result.protection_status);\n\t * } else if (isDashboardMetricsError(result)) {\n\t *   // Error path - access error details\n\t *   console.error(result.code, result.message);\n\t * }\n\t */\n\tgetDashboardMetrics(): Promise<DashboardMetricsResponse>;\n}\n\n/**\n * Create a dashboard metrics SDK client\n *\n * Factory function that creates a client instance from an ORPC client.\n * Enforces package boundaries: SDK clients delegate to ORPC, web apps use SDK clients,\n * preventing direct API imports from web app code.\n *\n * @param orpcClient - ORPC client with dashboard.getMetrics() method\n * @returns DashboardMetricsClient instance\n *\n * @example\n * import { createDashboardMetricsClient } from \"@snapback/sdk\";\n * import { orpcClient } from \"@shared/lib/orpc-client\";\n *\n * const dashboardClient = createDashboardMetricsClient(orpcClient);\n */\nexport function createDashboardMetricsClient(orpcClient: ORPCClient): DashboardMetricsClient {\n\treturn {\n\t\tasync getDashboardMetrics(): Promise<DashboardMetricsResponse> {\n\t\t\t// Delegate to ORPC API client\n\t\t\t// ORPC client handles:\n\t\t\t// - Network communication to /api/rpc endpoint\n\t\t\t// - Response deserialization\n\t\t\t// - Authentication via cookies\n\t\t\t// - Error handling (throws on network/ORPC errors, returns error discriminant for business errors)\n\t\t\treturn orpcClient.dashboard.getMetrics();\n\t\t},\n\t};\n}\n","/**\n * Protection Decision Engine\n *\n * Per arch_remediation.md Task 1.3: This is THE decision point for all protection logic.\n * VSCode/CLI/MCP should call this engine, not implement their own decision logic.\n *\n * The SDK owns:\n * - Whether to snapshot (shouldSnapshot)\n * - Whether save should proceed (shouldProceed)\n * - Risk evaluation and thresholds\n *\n * Consumers (VSCode, CLI, MCP) own:\n * - HOW to execute snapshots\n * - HOW to display UI/notifications\n * - HOW to handle user interactions\n */\n\nimport type { ProtectionLevel } from \"@snapback/contracts\";\nimport { type ProtectionManager, THRESHOLDS } from \"@snapback-oss/sdk\";\n\n/**\n * Context for evaluating protection decisions\n */\nexport interface EvaluationContext {\n\t/** Absolute file path */\n\tfilePath: string;\n\t/** What triggered this evaluation */\n\ttrigger: \"save\" | \"manual\" | \"ai-detected\";\n\t/** Optional: File change metrics */\n\tchangeMetrics?: ChangeMetrics;\n\t/** Optional: AI detection context */\n\taiContext?: AIDetectionContext;\n\t/** Optional: Whether file is in cooldown */\n\tinCooldown?: boolean;\n\t/** Optional: Whether file has temporary allowance */\n\thasTemporaryAllowance?: boolean;\n}\n\n/**\n * Metrics about the file change\n */\nexport interface ChangeMetrics {\n\tlinesAdded: number;\n\tlinesDeleted: number;\n\tcharsAdded: number;\n\tcharsDeleted: number;\n\taffectedFunctions?: number;\n}\n\n/**\n * AI detection context\n */\nexport interface AIDetectionContext {\n\tdetected: boolean;\n\tconfidence: number;\n\tassistantName?: string;\n\tburstPattern?: boolean;\n}\n\n/**\n * Result of protection decision evaluation\n */\nexport interface ProtectionDecision {\n\t/** Whether a snapshot should be created */\n\tshouldSnapshot: boolean;\n\t/** Whether the save operation should proceed */\n\tshouldProceed: boolean;\n\t/** Human-readable reason for the decision */\n\treason: string;\n\t/** Computed risk score (0-10 scale) */\n\triskScore: number;\n\t/** Recommendations for the user */\n\trecommendations: string[];\n\t/** The protection level that was evaluated */\n\tprotectionLevel: ProtectionLevel | null;\n}\n\n/**\n * Interface for risk analyzer (injected dependency)\n */\nexport interface IRiskAnalyzer {\n\tanalyze(context: EvaluationContext): number;\n}\n\n/**\n * Simple default risk analyzer implementation\n */\nexport class DefaultRiskAnalyzer implements IRiskAnalyzer {\n\tanalyze(context: EvaluationContext): number {\n\t\tlet riskScore = 0;\n\n\t\t// AI detection increases risk\n\t\tif (context.aiContext?.detected) {\n\t\t\triskScore += 3.0;\n\t\t\tif (context.aiContext.burstPattern) {\n\t\t\t\triskScore += 2.0;\n\t\t\t}\n\t\t}\n\n\t\t// Large changes increase risk\n\t\tif (context.changeMetrics) {\n\t\t\tconst totalLines = context.changeMetrics.linesAdded + context.changeMetrics.linesDeleted;\n\t\t\tif (totalLines > 100) {\n\t\t\t\triskScore += 2.0;\n\t\t\t} else if (totalLines > 50) {\n\t\t\t\triskScore += 1.0;\n\t\t\t}\n\n\t\t\t// Function changes are higher risk\n\t\t\tif (context.changeMetrics.affectedFunctions && context.changeMetrics.affectedFunctions > 3) {\n\t\t\t\triskScore += 1.5;\n\t\t\t}\n\t\t}\n\n\t\t// Cap at 10\n\t\treturn Math.min(riskScore, 10);\n\t}\n}\n\n/**\n * Protection Decision Engine\n *\n * THE centralized decision point for all protection logic.\n * All consumers (VSCode, CLI, MCP) should delegate to this engine\n * for shouldSnapshot and shouldProceed decisions.\n */\nexport class ProtectionDecisionEngine {\n\tconstructor(\n\t\tprivate protectionManager: ProtectionManager,\n\t\tprivate riskAnalyzer: IRiskAnalyzer = new DefaultRiskAnalyzer(),\n\t) {}\n\n\t/**\n\t * Evaluate protection decision for a file operation.\n\t *\n\t * This is THE decision point. Consumers should:\n\t * 1. Call this method to get the decision\n\t * 2. Execute the decision (create snapshot if shouldSnapshot)\n\t * 3. Proceed or block based on shouldProceed\n\t *\n\t * @param context - The evaluation context\n\t * @returns Protection decision with shouldSnapshot, shouldProceed, and reason\n\t */\n\tevaluate(context: EvaluationContext): ProtectionDecision {\n\t\tconst protectionLevel = this.protectionManager.getLevel(context.filePath);\n\t\tconst riskScore = this.riskAnalyzer.analyze(context);\n\n\t\t// Handle cooldown bypass\n\t\tif (context.inCooldown) {\n\t\t\treturn {\n\t\t\t\tshouldSnapshot: false,\n\t\t\t\tshouldProceed: true,\n\t\t\t\treason: \"cooldown_bypass\",\n\t\t\t\triskScore,\n\t\t\t\trecommendations: [],\n\t\t\t\tprotectionLevel,\n\t\t\t};\n\t\t}\n\n\t\t// Handle temporary allowance\n\t\tif (context.hasTemporaryAllowance) {\n\t\t\t// Still snapshot even with allowance (protection purposes)\n\t\t\treturn {\n\t\t\t\tshouldSnapshot: true,\n\t\t\t\tshouldProceed: true,\n\t\t\t\treason: \"temporary_allowance\",\n\t\t\t\triskScore,\n\t\t\t\trecommendations: [],\n\t\t\t\tprotectionLevel,\n\t\t\t};\n\t\t}\n\n\t\t// CENTRALIZED decision logic\n\t\tconst shouldSnapshot = this.determineShouldSnapshot(protectionLevel, riskScore, context);\n\t\tconst shouldProceed = this.determineShouldProceed(protectionLevel, riskScore);\n\n\t\treturn {\n\t\t\tshouldSnapshot,\n\t\t\tshouldProceed,\n\t\t\treason: this.buildReason(protectionLevel, riskScore, context),\n\t\t\triskScore,\n\t\t\trecommendations: this.buildRecommendations(protectionLevel, riskScore),\n\t\t\tprotectionLevel,\n\t\t};\n\t}\n\n\t/**\n\t * Determine if a snapshot should be created.\n\t * ALL snapshot decision logic lives HERE.\n\t */\n\tprivate determineShouldSnapshot(\n\t\tlevel: ProtectionLevel | null,\n\t\triskScore: number,\n\t\tcontext: EvaluationContext,\n\t): boolean {\n\t\t// Unprotected files don't get snapshotted via this path\n\t\tif (!level) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// AI-detected changes ALWAYS trigger snapshot\n\t\tif (context.trigger === \"ai-detected\") {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Block level always snapshots\n\t\tif (level === \"block\") {\n\t\t\treturn true;\n\t\t}\n\n\t\t// High risk always snapshots\n\t\tif (riskScore >= THRESHOLDS.risk.highThreshold) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Warn level: snapshot if medium+ risk\n\t\tif (level === \"warn\") {\n\t\t\treturn riskScore >= THRESHOLDS.risk.highThreshold * 0.6; // ~3.0 for medium risk\n\t\t}\n\n\t\t// Watch level: always snapshot (that's what watch means)\n\t\tif (level === \"watch\") {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Determine if the save operation should proceed.\n\t */\n\tprivate determineShouldProceed(level: ProtectionLevel | null, riskScore: number): boolean {\n\t\t// Unprotected files always proceed\n\t\tif (!level) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Block level with critical risk should block\n\t\tif (level === \"block\" && riskScore >= THRESHOLDS.risk.criticalThreshold) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// All other cases proceed\n\t\treturn true;\n\t}\n\n\t/**\n\t * Build a human-readable reason for the decision.\n\t */\n\tprivate buildReason(level: ProtectionLevel | null, riskScore: number, context: EvaluationContext): string {\n\t\tif (!level) {\n\t\t\treturn \"unprotected_file\";\n\t\t}\n\n\t\tif (context.trigger === \"ai-detected\") {\n\t\t\treturn \"ai_detected_changes\";\n\t\t}\n\n\t\tif (riskScore >= THRESHOLDS.risk.criticalThreshold) {\n\t\t\treturn \"critical_risk_level\";\n\t\t}\n\n\t\tif (riskScore >= THRESHOLDS.risk.highThreshold) {\n\t\t\treturn \"high_risk_level\";\n\t\t}\n\n\t\tswitch (level) {\n\t\t\tcase \"block\":\n\t\t\t\treturn \"block_mode_protection\";\n\t\t\tcase \"warn\":\n\t\t\t\treturn \"warn_mode_protection\";\n\t\t\tcase \"watch\":\n\t\t\t\treturn \"watch_mode_protection\";\n\t\t\tdefault:\n\t\t\t\treturn \"standard_protection\";\n\t\t}\n\t}\n\n\t/**\n\t * Build recommendations based on protection level and risk.\n\t */\n\tprivate buildRecommendations(level: ProtectionLevel | null, riskScore: number): string[] {\n\t\tconst recommendations: string[] = [];\n\n\t\tif (riskScore >= THRESHOLDS.risk.highThreshold) {\n\t\t\trecommendations.push(\"Review changes carefully before proceeding\");\n\t\t}\n\n\t\tif (level === \"block\") {\n\t\t\trecommendations.push(\"This file requires explicit confirmation to save\");\n\t\t}\n\n\t\tif (riskScore >= THRESHOLDS.risk.criticalThreshold) {\n\t\t\trecommendations.push(\"Consider breaking this change into smaller commits\");\n\t\t}\n\n\t\treturn recommendations;\n\t}\n}\n","/**\n * Diff calculation utilities for snapshot restoration previews\n */\n\nexport interface FileDiff {\n\tpath: string;\n\toperation: \"create\" | \"modify\" | \"delete\";\n\tlinesAdded: number;\n\tlinesRemoved: number;\n\tpreview: string;\n\tcurrentChecksum?: string;\n\tsnapshotChecksum?: string;\n}\n\nexport interface DiffPreview {\n\ttotalFiles: number;\n\tfilesCreated: number;\n\tfilesModified: number;\n\tfilesDeleted: number;\n\ttotalLinesAdded: number;\n\ttotalLinesRemoved: number;\n\tdiffs: FileDiff[];\n}\n\nexport class DiffCalculator {\n\t/**\n\t * Calculate diff between current file and snapshot content\n\t */\n\tcalculateFileDiff(filePath: string, currentContent: string | null, snapshotContent: string | null): FileDiff {\n\t\t// Determine operation\n\t\tlet operation: \"create\" | \"modify\" | \"delete\";\n\t\tif (currentContent === null && snapshotContent !== null) {\n\t\t\toperation = \"create\";\n\t\t} else if (currentContent !== null && snapshotContent === null) {\n\t\t\toperation = \"delete\";\n\t\t} else {\n\t\t\toperation = \"modify\";\n\t\t}\n\n\t\t// Calculate line counts\n\t\tconst currentLines = currentContent ? currentContent.split(\"\\n\") : [];\n\t\tconst snapshotLines = snapshotContent ? snapshotContent.split(\"\\n\") : [];\n\n\t\tconst { added, removed, preview } = this.computeLineDiff(currentLines, snapshotLines);\n\n\t\t// Calculate checksums\n\t\tconst currentChecksum = currentContent ? this.calculateChecksum(currentContent) : undefined;\n\t\tconst snapshotChecksum = snapshotContent ? this.calculateChecksum(snapshotContent) : undefined;\n\n\t\treturn {\n\t\t\tpath: filePath,\n\t\t\toperation,\n\t\t\tlinesAdded: added,\n\t\t\tlinesRemoved: removed,\n\t\t\tpreview,\n\t\t\tcurrentChecksum,\n\t\t\tsnapshotChecksum,\n\t\t};\n\t}\n\n\t/**\n\t * Compute line-by-line diff with preview\n\t * Uses simple LCS algorithm for readable diffs\n\t */\n\tprivate computeLineDiff(\n\t\tcurrentLines: string[],\n\t\tsnapshotLines: string[],\n\t): { added: number; removed: number; preview: string } {\n\t\tconst lcs = this.longestCommonSubsequence(currentLines, snapshotLines);\n\t\tconst previewLines: string[] = [];\n\t\tlet added = 0;\n\t\tlet removed = 0;\n\n\t\tlet i = 0;\n\t\tlet j = 0;\n\t\tlet previewLineCount = 0;\n\t\tconst maxPreviewLines = 20; // Limit preview to first 20 lines\n\n\t\tfor (let k = 0; k < lcs.length && previewLineCount < maxPreviewLines; k++) {\n\t\t\t// Lines removed from current\n\t\t\twhile (i < currentLines.length && currentLines[i] !== lcs[k]) {\n\t\t\t\tpreviewLines.push(`- ${currentLines[i]}`);\n\t\t\t\tremoved++;\n\t\t\t\ti++;\n\t\t\t\tpreviewLineCount++;\n\t\t\t\tif (previewLineCount >= maxPreviewLines) break;\n\t\t\t}\n\n\t\t\t// Lines added from snapshot\n\t\t\twhile (j < snapshotLines.length && snapshotLines[j] !== lcs[k] && previewLineCount < maxPreviewLines) {\n\t\t\t\tpreviewLines.push(`+ ${snapshotLines[j]}`);\n\t\t\t\tadded++;\n\t\t\t\tj++;\n\t\t\t\tpreviewLineCount++;\n\t\t\t\tif (previewLineCount >= maxPreviewLines) break;\n\t\t\t}\n\n\t\t\t// Common line\n\t\t\tif (previewLineCount < maxPreviewLines) {\n\t\t\t\tpreviewLines.push(`  ${lcs[k]}`);\n\t\t\t\tpreviewLineCount++;\n\t\t\t}\n\n\t\t\ti++;\n\t\t\tj++;\n\t\t}\n\n\t\t// Handle remaining lines\n\t\twhile (i < currentLines.length && previewLineCount < maxPreviewLines) {\n\t\t\tpreviewLines.push(`- ${currentLines[i]}`);\n\t\t\tremoved++;\n\t\t\ti++;\n\t\t\tpreviewLineCount++;\n\t\t}\n\n\t\twhile (j < snapshotLines.length && previewLineCount < maxPreviewLines) {\n\t\t\tpreviewLines.push(`+ ${snapshotLines[j]}`);\n\t\t\tadded++;\n\t\t\tj++;\n\t\t\tpreviewLineCount++;\n\t\t}\n\n\t\t// Count any remaining lines not included in preview\n\t\tadded += snapshotLines.length - j;\n\t\tremoved += currentLines.length - i;\n\n\t\tif (previewLineCount >= maxPreviewLines && (i < currentLines.length || j < snapshotLines.length)) {\n\t\t\tpreviewLines.push(\"... (preview truncated)\");\n\t\t}\n\n\t\treturn {\n\t\t\tadded,\n\t\t\tremoved,\n\t\t\tpreview: previewLines.join(\"\\n\"),\n\t\t};\n\t}\n\n\t/**\n\t * Longest Common Subsequence for diff calculation\n\t */\n\tprivate longestCommonSubsequence(arr1: string[], arr2: string[]): string[] {\n\t\tconst m = arr1.length;\n\t\tconst n = arr2.length;\n\t\tconst dp: number[][] = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));\n\n\t\t// Fill DP table\n\t\tfor (let i = 1; i <= m; i++) {\n\t\t\tfor (let j = 1; j <= n; j++) {\n\t\t\t\tif (arr1[i - 1] === arr2[j - 1]) {\n\t\t\t\t\tdp[i][j] = dp[i - 1][j - 1] + 1;\n\t\t\t\t} else {\n\t\t\t\t\tdp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Backtrack to find LCS\n\t\tconst lcs: string[] = [];\n\t\tlet i = m;\n\t\tlet j = n;\n\n\t\twhile (i > 0 && j > 0) {\n\t\t\tif (arr1[i - 1] === arr2[j - 1]) {\n\t\t\t\tlcs.unshift(arr1[i - 1]);\n\t\t\t\ti--;\n\t\t\t\tj--;\n\t\t\t} else if (dp[i - 1][j] > dp[i][j - 1]) {\n\t\t\t\ti--;\n\t\t\t} else {\n\t\t\t\tj--;\n\t\t\t}\n\t\t}\n\n\t\treturn lcs;\n\t}\n\n\t/**\n\t * Calculate SHA-256 checksum for content\n\t */\n\tcalculateChecksum(content: string): string {\n\t\t// Use Node.js crypto for checksum\n\t\tconst crypto = require(\"node:crypto\");\n\t\treturn crypto.createHash(\"sha256\").update(content).digest(\"hex\");\n\t}\n\n\t/**\n\t * Generate full diff preview for multiple files\n\t */\n\tgenerateDiffPreview(diffs: FileDiff[]): DiffPreview {\n\t\tlet filesCreated = 0;\n\t\tlet filesModified = 0;\n\t\tlet filesDeleted = 0;\n\t\tlet totalLinesAdded = 0;\n\t\tlet totalLinesRemoved = 0;\n\n\t\tfor (const diff of diffs) {\n\t\t\tswitch (diff.operation) {\n\t\t\t\tcase \"create\":\n\t\t\t\t\tfilesCreated++;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"modify\":\n\t\t\t\t\tfilesModified++;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"delete\":\n\t\t\t\t\tfilesDeleted++;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\ttotalLinesAdded += diff.linesAdded;\n\t\t\ttotalLinesRemoved += diff.linesRemoved;\n\t\t}\n\n\t\treturn {\n\t\t\ttotalFiles: diffs.length,\n\t\t\tfilesCreated,\n\t\t\tfilesModified,\n\t\t\tfilesDeleted,\n\t\t\ttotalLinesAdded,\n\t\t\ttotalLinesRemoved,\n\t\t\tdiffs,\n\t\t};\n\t}\n}\n","/**\n * Token Bucket Implementation\n *\n * Implements the token bucket algorithm for rate limiting:\n * - Fixed capacity: max tokens the bucket can hold\n * - Refill rate: tokens added per second\n * - Consumption: tokens removed when requests are made\n *\n * Follows SnapBack patterns:\n * - Discriminated unions for consumption results\n * - Type guards for safe state access\n * - Validation on construction\n *\n * @module token/TokenBucket\n */\n\nexport interface TokenBucketState {\n\t/** Current number of tokens available */\n\ttokens: number;\n\n\t/** Maximum tokens the bucket can hold */\n\tcapacity: number;\n\n\t/** Tokens added per second */\n\trefillRate: number;\n\n\t/** Timestamp of last refill (milliseconds) */\n\tlastRefill: number;\n}\n\n/**\n * Discriminated union for token consumption results\n * Allows exhaustive pattern matching on consumption outcomes\n */\nexport type ConsumptionResult =\n\t| { allowed: true; tokensRemaining: number; resetAt: Date }\n\t| { allowed: false; tokensRemaining: number; resetAt: Date };\n\nexport interface ConsumptionInfo {\n\t/** Number of tokens consumed */\n\tconsumed: number;\n\n\t/** Number of tokens remaining */\n\tremaining: number;\n\n\t/** Percentage of capacity used (0-100) */\n\tpercentageUsed: number;\n}\n\nexport interface TokenBucketConfig {\n\t/** Maximum tokens the bucket can hold */\n\tcapacity: number;\n\n\t/** Tokens added per second */\n\trefillRate: number;\n}\n\n/**\n * Type guard for checking if consumption was allowed\n */\nexport function isConsumptionAllowed(\n\tresult: ConsumptionResult,\n): result is { allowed: true; tokensRemaining: number; resetAt: Date } {\n\treturn result.allowed === true;\n}\n\n/**\n * Type guard for checking if consumption was denied\n */\nexport function isConsumptionDenied(\n\tresult: ConsumptionResult,\n): result is { allowed: false; tokensRemaining: number; resetAt: Date } {\n\treturn result.allowed === false;\n}\n\n/**\n * TokenBucket class implements the token bucket algorithm\n *\n * @example\n * ```typescript\n * const bucket = createTokenBucket({ capacity: 100, refillRate: 1 });\n *\n * // Try to consume 10 tokens\n * const result = bucket.tryConsume(10);\n * if (result.allowed) {\n *   console.log(`Request allowed. ${result.tokensRemaining} tokens left.`);\n * } else {\n *   console.log(`Rate limited. Retry at ${result.resetAt}`);\n * }\n * ```\n */\nexport class TokenBucket {\n\tprivate state: TokenBucketState;\n\n\tconstructor(config: TokenBucketConfig) {\n\t\tif (config.capacity <= 0) {\n\t\t\tthrow new Error(\"Capacity must be greater than 0\");\n\t\t}\n\n\t\tif (config.refillRate <= 0) {\n\t\t\tthrow new Error(\"Refill rate must be greater than 0\");\n\t\t}\n\n\t\tthis.state = {\n\t\t\ttokens: config.capacity,\n\t\t\tcapacity: config.capacity,\n\t\t\trefillRate: config.refillRate,\n\t\t\tlastRefill: Date.now(),\n\t\t};\n\t}\n\n\t/**\n\t * Attempt to consume tokens from the bucket\n\t *\n\t * @param amount - Number of tokens to consume\n\t * @returns Result indicating if consumption was allowed\n\t *\n\t * @throws If amount is not positive\n\t */\n\ttryConsume(amount: number): ConsumptionResult {\n\t\tif (amount <= 0) {\n\t\t\tthrow new Error(\"Token amount must be greater than 0\");\n\t\t}\n\n\t\tthis.refill();\n\n\t\tif (this.state.tokens >= amount) {\n\t\t\tthis.state.tokens -= amount;\n\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\ttokensRemaining: this.state.tokens,\n\t\t\t\tresetAt: this.calculateResetTime(),\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\ttokensRemaining: this.state.tokens,\n\t\t\tresetAt: this.calculateResetTime(),\n\t\t};\n\t}\n\n\t/**\n\t * Refill tokens based on time elapsed since last refill\n\t */\n\trefill(): void {\n\t\tconst now = Date.now();\n\t\tconst timePassed = (now - this.state.lastRefill) / 1000; // Convert to seconds\n\t\tconst tokensToAdd = timePassed * this.state.refillRate;\n\n\t\tthis.state.tokens = Math.min(this.state.capacity, this.state.tokens + tokensToAdd);\n\t\tthis.state.lastRefill = now;\n\t}\n\n\t/**\n\t * Get the current state of the bucket\n\t */\n\tgetState(): Readonly<TokenBucketState> {\n\t\tthis.refill();\n\t\treturn { ...this.state };\n\t}\n\n\t/**\n\t * Reset bucket to full capacity\n\t */\n\treset(): void {\n\t\tthis.state.tokens = this.state.capacity;\n\t\tthis.state.lastRefill = Date.now();\n\t}\n\n\t/**\n\t * Get consumption information\n\t */\n\tgetConsumptionInfo(): ConsumptionInfo {\n\t\tthis.refill();\n\n\t\tconst consumed = this.state.capacity - this.state.tokens;\n\t\tconst percentageUsed = (consumed / this.state.capacity) * 100;\n\n\t\treturn {\n\t\t\tconsumed,\n\t\t\tremaining: this.state.tokens,\n\t\t\tpercentageUsed,\n\t\t};\n\t}\n\n\t/**\n\t * Calculate when the bucket will be full again\n\t */\n\tprivate calculateResetTime(): Date {\n\t\tconst tokensNeeded = this.state.capacity - this.state.tokens;\n\t\tconst secondsToReset = tokensNeeded / this.state.refillRate;\n\t\treturn new Date(Date.now() + secondsToReset * 1000);\n\t}\n}\n\n/**\n * Factory function to create a new TokenBucket\n *\n * @param config - Bucket configuration\n * @returns New TokenBucket instance\n *\n * @example\n * ```typescript\n * // Free tier: 100 tokens, refill at 1 token/second\n * const freeBucket = createTokenBucket({ capacity: 100, refillRate: 1 });\n *\n * // Pro tier: 1000 tokens, refill at 10 tokens/second\n * const proBucket = createTokenBucket({ capacity: 1000, refillRate: 10 });\n * ```\n */\nexport function createTokenBucket(config: TokenBucketConfig): TokenBucket {\n\treturn new TokenBucket(config);\n}\n","/**\n * Multi-User Rate Limiter with Plan-Based Tiers\n *\n * Manages separate token buckets per user per plan tier:\n * - Free: 20 tokens (~10/min)\n * - Pro: 200 tokens (~100/min)\n * - Team: 1000 tokens (~500/min)\n * - Enterprise: 5000 tokens (~2000/min)\n *\n * Follows SnapBack patterns:\n * - Result<T, E> error handling pattern\n * - Plan-based configuration from THRESHOLDS\n * - Validation on construction\n *\n * @module token/RateLimiter\n */\n\nimport { isConsumptionAllowed, TokenBucket } from \"./TokenBucket\";\n\nexport interface PlanConfig {\n\t/** Maximum tokens capacity for this plan */\n\tcapacity: number;\n\n\t/** Tokens added per second for this plan */\n\trefillRate: number;\n}\n\n/**\n * Discriminated union for rate limit check results\n * Enforces exhaustive pattern matching on outcomes\n */\nexport type RateLimitResult =\n\t| {\n\t\t\tallowed: true;\n\t\t\tremaining: number;\n\t\t\tlimit: number;\n\t\t\tresetAt: Date;\n\t  }\n\t| {\n\t\t\tallowed: false;\n\t\t\tremaining: number;\n\t\t\tlimit: number;\n\t\t\tresetAt: Date;\n\t\t\tretryAfter: number;\n\t  };\n\n/**\n * Type guard for allowed rate limit results\n */\nexport function isRateLimitAllowed(\n\tresult: RateLimitResult,\n): result is { allowed: true; remaining: number; limit: number; resetAt: Date } {\n\treturn result.allowed === true;\n}\n\n/**\n * Type guard for denied rate limit results\n */\nexport function isRateLimitDenied(result: RateLimitResult): result is {\n\tallowed: false;\n\tremaining: number;\n\tlimit: number;\n\tresetAt: Date;\n\tretryAfter: number;\n} {\n\treturn result.allowed === false;\n}\n\n/**\n * RateLimiter manages multiple token buckets (one per user per plan)\n *\n * @example\n * ```typescript\n * const plans = {\n *   free: { capacity: 20, refillRate: 0.167 },\n *   pro: { capacity: 200, refillRate: 1.667 },\n * };\n *\n * const limiter = new RateLimiter(plans);\n *\n * // Check rate limit for user1 on free plan\n * const result = await limiter.checkLimit(\"user1\", \"free\");\n *\n * if (!result.allowed) {\n *   console.log(`Too many requests. Retry in ${result.retryAfter} seconds`);\n * }\n * ```\n */\nexport class RateLimiter {\n\tprivate plans: Record<string, PlanConfig>;\n\tprivate buckets: Map<string, TokenBucket> = new Map();\n\n\tconstructor(plans: Record<string, PlanConfig>) {\n\t\t// Validate plans\n\t\tif (!plans || Object.keys(plans).length === 0) {\n\t\t\tthrow new Error(\"At least one plan must be configured\");\n\t\t}\n\n\t\tfor (const [planName, config] of Object.entries(plans)) {\n\t\t\tif (config.capacity <= 0) {\n\t\t\t\tthrow new Error(`Plan \"${planName}\" has invalid capacity: ${config.capacity}`);\n\t\t\t}\n\n\t\t\tif (config.refillRate <= 0) {\n\t\t\t\tthrow new Error(`Plan \"${planName}\" has invalid refill rate: ${config.refillRate}`);\n\t\t\t}\n\t\t}\n\n\t\tthis.plans = plans;\n\t}\n\n\t/**\n\t * Check rate limit for a user and plan tier\n\t *\n\t * @param userId - Unique user identifier\n\t * @param planName - Plan tier name (e.g., \"free\", \"pro\")\n\t * @returns Rate limit result (discriminated union)\n\t *\n\t * @throws If plan doesn't exist\n\t *\n\t * @example\n\t * ```typescript\n\t * const result = await limiter.checkLimit('user1', 'free');\n\t *\n\t * if (isRateLimitAllowed(result)) {\n\t *   // TypeScript knows result.remaining exists\n\t *   console.log(`${result.remaining} requests remaining`);\n\t * } else {\n\t *   // TypeScript knows result.retryAfter exists\n\t *   console.log(`Retry in ${result.retryAfter} seconds`);\n\t * }\n\t * ```\n\t */\n\tasync checkLimit(userId: string, planName: string): Promise<RateLimitResult> {\n\t\tconst plan = this.plans[planName];\n\n\t\tif (!plan) {\n\t\t\tthrow new Error(`Unknown plan: ${planName}`);\n\t\t}\n\n\t\t// Get or create bucket for this user+plan combination\n\t\tconst bucketKey = `${userId}:${planName}`;\n\t\tlet bucket = this.buckets.get(bucketKey);\n\n\t\tif (!bucket) {\n\t\t\tbucket = new TokenBucket(plan);\n\t\t\tthis.buckets.set(bucketKey, bucket);\n\t\t}\n\n\t\t// Try to consume one token\n\t\tconst consumeResult = bucket.tryConsume(1);\n\n\t\tif (isConsumptionAllowed(consumeResult)) {\n\t\t\treturn {\n\t\t\t\tallowed: true as const,\n\t\t\t\tremaining: Math.floor(consumeResult.tokensRemaining),\n\t\t\t\tlimit: plan.capacity,\n\t\t\t\tresetAt: consumeResult.resetAt,\n\t\t\t};\n\t\t}\n\n\t\t// Calculate retry time\n\t\tconst now = Date.now();\n\t\tconst resetTime = consumeResult.resetAt.getTime();\n\t\tconst retryAfter = Math.ceil((resetTime - now) / 1000);\n\n\t\treturn {\n\t\t\tallowed: false as const,\n\t\t\tremaining: Math.floor(consumeResult.tokensRemaining),\n\t\t\tlimit: plan.capacity,\n\t\t\tresetAt: consumeResult.resetAt,\n\t\t\tretryAfter: Math.max(1, retryAfter),\n\t\t};\n\t}\n\n\t/**\n\t * Get current state of a user's bucket for a plan\n\t *\n\t * @param userId - User identifier\n\t * @param planName - Plan name\n\t * @returns Current bucket state or undefined if not created yet\n\t */\n\tgetBucketState(userId: string, planName: string): Readonly<any> | undefined {\n\t\tconst bucketKey = `${userId}:${planName}`;\n\t\tconst bucket = this.buckets.get(bucketKey);\n\t\treturn bucket?.getState();\n\t}\n\n\t/**\n\t * Reset a user's bucket for a plan\n\t *\n\t * @param userId - User identifier\n\t * @param planName - Plan name\n\t */\n\tresetBucket(userId: string, planName: string): void {\n\t\tconst bucketKey = `${userId}:${planName}`;\n\t\tconst bucket = this.buckets.get(bucketKey);\n\n\t\tif (bucket) {\n\t\t\tbucket.reset();\n\t\t}\n\t}\n\n\t/**\n\t * Clear all buckets (use cautiously)\n\t */\n\tclearAll(): void {\n\t\tthis.buckets.clear();\n\t}\n\n\t/**\n\t * Get total number of active buckets\n\t */\n\tgetActiveBucketCount(): number {\n\t\treturn this.buckets.size;\n\t}\n}\n","/**\n * Distributed Token Manager with Redis Backend and In-Memory Fallback\n *\n * Manages rate limiting across distributed systems using Redis for state\n * persistence, with automatic fallback to in-memory storage when Redis\n * is unavailable.\n *\n * @module token/DistributedTokenManager\n */\n\nimport { type PlanConfig, RateLimiter } from \"./RateLimiter\";\nimport { TokenBucket } from \"./TokenBucket\";\n\nexport interface RedisClient {\n\tget(key: string): Promise<string | null>;\n\tset(key: string, value: string): Promise<void>;\n\tincr(key: string): Promise<number>;\n\tdecr(key: string): Promise<number>;\n\texpire(key: string, seconds: number): Promise<void>;\n\tttl(key: string): Promise<number>;\n\tdel(key: string): Promise<void>;\n}\n\nexport interface DistributedCheckLimitResult {\n\t/** Whether the request was allowed */\n\tallowed: boolean;\n\n\t/** Number of tokens remaining */\n\tremaining: number;\n\n\t/** Maximum tokens for this plan */\n\tlimit: number;\n\n\t/** When the bucket will be full again */\n\tresetAt: Date;\n\n\t/** \"redis\" | \"fallback\" - which backend was used */\n\treason: \"redis\" | \"fallback\";\n\n\t/** Seconds to wait before retrying (if not allowed) */\n\tretryAfter?: number;\n\n\t/** Any error that occurred */\n\terror?: Error;\n}\n\nexport interface DistributedTokenManagerOptions {\n\t/** Redis client for distributed state */\n\tredisClient: RedisClient;\n\n\t/** Plan tier configurations */\n\tplans: Record<string, PlanConfig>;\n\n\t/** Prefix for Redis keys (default: \"ratelimit:\") */\n\tkeyPrefix?: string;\n\n\t/** TTL for Redis keys in seconds (default: 3600) */\n\tttlSeconds?: number;\n\n\t/** Fall back to in-memory if Redis unavailable (default: true) */\n\tfallbackToInMemory?: boolean;\n}\n\n/**\n * DistributedTokenManager handles rate limiting with Redis backend\n *\n * @example\n * ```typescript\n * const manager = new DistributedTokenManager({\n *   redisClient: redis,\n *   plans: {\n *     free: { capacity: 20, refillRate: 0.167 },\n *     pro: { capacity: 200, refillRate: 1.667 },\n *   },\n *   keyPrefix: \"ratelimit:\",\n *   ttlSeconds: 3600,\n *   fallbackToInMemory: true,\n * });\n *\n * const result = await manager.checkLimit(\"user1\", \"free\");\n * if (!result.allowed) {\n *   console.log(`Rate limited. Retry in ${result.retryAfter} seconds`);\n * }\n * ```\n */\nexport class DistributedTokenManager {\n\tprivate redis: RedisClient;\n\tprivate plans: Record<string, PlanConfig>;\n\tprivate keyPrefix: string;\n\tprivate ttlSeconds: number;\n\tprivate fallbackToInMemory: boolean;\n\tprivate fallbackLimiter: RateLimiter | null = null;\n\n\tconstructor(options: DistributedTokenManagerOptions) {\n\t\tif (!options.redisClient) {\n\t\t\tthrow new Error(\"Redis client is required\");\n\t\t}\n\n\t\tif (!options.plans || Object.keys(options.plans).length === 0) {\n\t\t\tthrow new Error(\"At least one plan must be configured\");\n\t\t}\n\n\t\tthis.redis = options.redisClient;\n\t\tthis.plans = options.plans;\n\t\tthis.keyPrefix = options.keyPrefix || \"ratelimit:\";\n\t\tthis.ttlSeconds = options.ttlSeconds || 3600;\n\t\tthis.fallbackToInMemory = options.fallbackToInMemory !== false;\n\n\t\t// Initialize fallback limiter if enabled\n\t\tif (this.fallbackToInMemory) {\n\t\t\tthis.fallbackLimiter = new RateLimiter(this.plans);\n\t\t}\n\t}\n\n\t/**\n\t * Check rate limit using Redis with fallback to in-memory\n\t *\n\t * @param userId - User identifier\n\t * @param planName - Plan name\n\t * @returns Rate limit result with backend info\n\t */\n\tasync checkLimit(userId: string, planName: string): Promise<DistributedCheckLimitResult> {\n\t\tconst plan = this.plans[planName];\n\n\t\tif (!plan) {\n\t\t\tthrow new Error(`Unknown plan: ${planName}`);\n\t\t}\n\n\t\ttry {\n\t\t\treturn await this.checkLimitViaRedis(userId, planName, plan);\n\t\t} catch (error) {\n\t\t\tif (this.fallbackToInMemory) {\n\t\t\t\treturn await this.checkLimitViaFallback(userId, planName);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Check limit using Redis backend\n\t */\n\tprivate async checkLimitViaRedis(\n\t\tuserId: string,\n\t\tplanName: string,\n\t\tplan: PlanConfig,\n\t): Promise<DistributedCheckLimitResult> {\n\t\tconst key = this.getRedisKey(userId, planName);\n\n\t\t// Get current bucket state from Redis\n\t\tconst bucket = await this.getOrCreateBucket(key, plan);\n\n\t\t// Try to consume token\n\t\tconst consumeResult = bucket.tryConsume(1);\n\n\t\t// Save updated state back to Redis\n\t\ttry {\n\t\t\tawait this.redis.set(key, JSON.stringify(bucket.getState()));\n\t\t\tawait this.redis.expire(key, this.ttlSeconds);\n\t\t} catch (error) {\n\t\t\t// If we can't save, we might need to fall back\n\t\t\tif (this.fallbackToInMemory) {\n\t\t\t\treturn await this.checkLimitViaFallback(userId, planName);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\n\t\tif (consumeResult.allowed) {\n\t\t\treturn {\n\t\t\t\tallowed: true,\n\t\t\t\tremaining: Math.floor(consumeResult.tokensRemaining),\n\t\t\t\tlimit: plan.capacity,\n\t\t\t\tresetAt: consumeResult.resetAt,\n\t\t\t\treason: \"redis\",\n\t\t\t};\n\t\t}\n\n\t\t// Calculate retry time\n\t\tconst now = Date.now();\n\t\tconst resetTime = consumeResult.resetAt.getTime();\n\t\tconst retryAfter = Math.ceil((resetTime - now) / 1000);\n\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\tremaining: Math.floor(consumeResult.tokensRemaining),\n\t\t\tlimit: plan.capacity,\n\t\t\tresetAt: consumeResult.resetAt,\n\t\t\treason: \"redis\",\n\t\t\tretryAfter: Math.max(1, retryAfter),\n\t\t};\n\t}\n\n\t/**\n\t * Check limit using in-memory fallback\n\t */\n\tprivate async checkLimitViaFallback(userId: string, planName: string): Promise<DistributedCheckLimitResult> {\n\t\tif (!this.fallbackLimiter) {\n\t\t\tthrow new Error(\"Fallback limiter not initialized\");\n\t\t}\n\n\t\tconst result = await this.fallbackLimiter.checkLimit(userId, planName);\n\n\t\treturn {\n\t\t\t...result,\n\t\t\treason: \"fallback\",\n\t\t};\n\t}\n\n\t/**\n\t * Get or create bucket from Redis\n\t */\n\tprivate async getOrCreateBucket(key: string, plan: PlanConfig): Promise<TokenBucket> {\n\t\tconst bucketData = await this.redis.get(key);\n\n\t\tif (bucketData) {\n\t\t\ttry {\n\t\t\t\tconst state = JSON.parse(bucketData);\n\n\t\t\t\t// Create a new bucket and restore state\n\t\t\t\tconst bucket = new TokenBucket(plan);\n\t\t\t\t// We need to restore the state - create a new bucket with the data\n\t\t\t\tObject.assign((bucket as any).state || {}, state);\n\n\t\t\t\treturn bucket;\n\t\t\t} catch (_error) {\n\t\t\t\t// If parsing fails, create a new bucket\n\t\t\t\treturn new TokenBucket(plan);\n\t\t\t}\n\t\t}\n\n\t\t// Create new bucket\n\t\treturn new TokenBucket(plan);\n\t}\n\n\t/**\n\t * Get Redis key for user + plan\n\t */\n\tprivate getRedisKey(userId: string, planName: string): string {\n\t\treturn `${this.keyPrefix}${userId}:${planName}`;\n\t}\n\n\t/**\n\t * Cleanup expired buckets (optional maintenance operation)\n\t */\n\tasync cleanup(): Promise<void> {\n\t\t// This would require scanning Redis keys, which is not efficient\n\t\t// In production, Redis TTL handles cleanup automatically\n\t}\n}\n"]}