{"version":3,"sources":["../../../packages/engine/src/runtime/events.ts","../../../packages/engine/src/runtime/orchestrator.ts","../../../packages/engine/src/transports/shared.ts","../../../packages/engine/src/transports/cli.ts","../src/commands/auth.ts","../src/utils/display.ts","../src/commands/fix.ts","../../../packages/engine/src/runtime/storage.ts","../../../packages/mcp/src/services/dependency-graph-service.ts","../../../packages/mcp/src/services/error-cache-service.ts","../../../packages/mcp/src/services/git-context-service.ts","../../../packages/mcp/src/services/learning-seeder.ts","../../../packages/mcp/src/services/session-file-tracker.ts","../../../packages/mcp/src/errors/index.ts","../../../packages/mcp/src/daemon/client-facade.ts","../../../packages/mcp/src/validation.ts","../../../packages/mcp/src/services/snapshot-service.ts","../../../packages/mcp/src/services/test-coverage-service.ts","../../../packages/mcp/src/services/tiered-learning-service.ts","../src/commands/init.ts","../src/commands/status.ts","../src/services/intelligence-service.ts","../src/utils/tables.ts","../src/commands/context.ts","../src/commands/stats.ts","../src/services/git-client.ts","../src/utils/progress.ts","../src/commands/validate.ts","../src/ui/prompts.ts","../src/utils/safe-ops.ts","../src/commands/learn.ts","../src/commands/patterns.ts","../src/commands/protect.ts","../src/commands/session.ts","../src/services/watcher.ts","../src/commands/watch.ts","../../../packages/intelligence/src/vitals/CommitRiskSystem.ts","../../../packages/intelligence/src/vitals/constants.ts","../../../packages/intelligence/src/vitals/DORAMetrics.ts","../../../packages/intelligence/src/vitals/DocFreshnessSensor.ts","../../../packages/intelligence/src/storage/JsonlStore.ts","../../../packages/intelligence/src/learning/PatternLookup.ts","../../../packages/intelligence/src/types/vitals-learning.ts","../../../packages/intelligence/src/vitals/learning/PhaseDetector.ts","../../../packages/intelligence/src/vitals/learning/SnapshotSuggester.ts","../../../packages/intelligence/src/vitals/learning/TeamAggregator.ts","../../../packages/intelligence/src/vitals/learning/ThresholdCalibrator.ts","../../../packages/intelligence/src/vitals/learning/TrajectoryPredictor.ts","../../../packages/intelligence/src/vitals/learning/UserBehaviorLearner.ts","../../../packages/intelligence/src/vitals/OxygenSensor.ts","../../../packages/intelligence/src/vitals/PressureGauge.ts","../../../packages/intelligence/src/vitals/PulseTracker.ts","../../../packages/intelligence/src/vitals/TemperatureMonitor.ts","../../../packages/intelligence/src/vitals/TrustMetricsAPI.ts","../../../packages/intelligence/src/vitals/TrustMetricsServiceImpl.ts","../../../packages/intelligence/src/vitals/BehaviorTracker.ts","../../../packages/intelligence/src/vitals/WorkspaceVitals.ts","../../../packages/mcp/src/branding/index.ts","../../../packages/mcp/src/errors.ts","../../../packages/mcp/src/session/state.ts","../../../packages/mcp/src/services/knowledge-ingestion-service.ts","../../../packages/mcp/src/services/hybrid-retrieval-service.ts","../../../packages/mcp/src/facades/intelligence.ts","../../../packages/mcp/src/facades/begin-task.ts","../../../packages/mcp/src/facades/complete-task.ts","../../../packages/mcp/src/facades/pairing-protocol.ts","../../../packages/mcp/src/services/error-pattern-registry.ts","../../../packages/mcp/src/facades/quick-check.ts","../../../packages/mcp/src/facades/response-utils.ts","../../../packages/mcp/src/facades/review-work.ts","../../../packages/mcp/src/facades/what-changed.ts","../../../packages/mcp/src/facades/handlers.ts","../../../packages/mcp/src/tools/consolidated/check.ts","../../../packages/mcp/src/tools/consolidated/snap.ts","../../../packages/mcp/src/tools/consolidated/snap-end.ts","../../../packages/mcp/src/tools/consolidated/snap-fix.ts","../../../packages/mcp/src/tools/consolidated/snap-help.ts","../../../packages/mcp/src/tools/consolidated/snap-learn.ts","../../../packages/mcp/src/tools/consolidated/snap-violation.ts","../../../packages/mcp/src/tools/consolidated/registry.ts","../../../packages/mcp/src/registry/types.ts","../../../packages/mcp/src/registry/CapabilityManager.ts","../../../packages/mcp/src/analyze_before_apply.ts","../../../packages/mcp/src/index.ts","../../../packages/mcp/src/bridge/receiver.ts","../../../packages/mcp/src/client/routes.ts","../../../packages/mcp/src/client/api-client.ts","../../../packages/mcp/src/facades/session-health.ts","../../../packages/mcp/src/registry.ts","../../../packages/mcp/src/server.ts","../../../packages/mcp/src/telemetry/mcp-event-tracker.ts","../../../packages/mcp/src/registry/adapter.ts","../../../packages/mcp/src/registry/ToolRegistry.ts","../../../packages/mcp/src/transport/http.ts","../../../packages/mcp/src/transport/stdio.ts","../../../packages/mcp/src/middleware/workspace.ts","../src/commands/mcp.ts","../src/commands/tools.ts","../src/daemon/protocol.ts","../src/daemon/errors.ts","../src/daemon/client.ts","../../../packages/core-runtime/src/adapters/local-engine-adapter.ts","../../../packages/core-runtime/src/context.ts","../../../packages/core-runtime/src/router.ts","../../../packages/core-runtime/src/services/workspace-api-client.ts","../../../packages/core-runtime/src/services/workspace-resolver.ts","../src/daemon/constants.ts","../src/daemon/path-validator.ts","../src/daemon/server.ts","../src/commands/alias.ts","../src/commands/config.ts","../src/commands/doctor.ts","../src/commands/undo.ts","../src/commands/upgrade.ts","../src/ui/links.ts","../src/ui/logo.ts","../src/commands/wizard.ts","../src/services/state.ts","../src/ui/errors.ts","../src/index.ts"],"names":["SnapBackEventBus","EventEmitter","emit","event","payload","enrichedPayload","_timestamp","Date","now","_event","on","listener","once","eventBus","DEFAULT_TIMEOUT","_scriptsDir","getScriptsDir","url","fileURLToPath","require","__filename","__dirname","dirname","join","pkgPath","resolve","process","cwd","SIGNAL_SCRIPTS","VALIDATOR_SCRIPTS","runScript","scriptPath","input","timeout","fullPath","startTime","Promise","reject","proc","spawn","stdio","env","SNAPBACK_WORKSPACE","stdout","stderr","data","toString","code","duration","Error","result","JSON","parse","parseError","error","message","stdin","write","stringify","end","SIGNAL_WEIGHTS","cycles","complexity","threats","velocity","consumers","hashString","str","hash","i","length","char","charCodeAt","Math","abs","slice","Orchestrator","sessionHealth","sessionId","previousScore","workspaceRoot","random","score","warnings","suggestions","filesModified","cyclesIntroduced","complexityDelta","analyze","fileChanges","files","workspace","timestamp","signals","validators","all","runSignals","runValidators","riskScore","calculateRiskScore","outcome","determineOutcome","updateSessionHealth","factorCount","threatCount","filter","s","signal","health","results","allSettled","map","script","status","push","value","console","warn","reason","component","recoverable","validator","errorCount","errors","riskSignal","find","baseScore","weightedSum","totalWeight","weight","weightedContribution","round","min","max","hasFailure","some","v","change","includes","path","cyclesSignal","complexitySignal","suggestion","coaching","generateCoaching","scoreDelta","currentScore","trigger","getHealth","resetSession","workspaceHash","getSessionId","orchestrator","RISK_THRESHOLDS","safe","low","medium","high","HIGH_RISK_EXIT_THRESHOLD","scoreToRiskLevel","isHighRisk","getExitCode","CLIEngineAdapter","errorResult","Array","isArray","emptyResult","format","toFileChanges","threatScore","effectiveScore","riskLevel","exitCode","output","formatOutput","getSessionHealth","f","content","lineCount","split","changeType","level","quiet","session","toSARIF","toText","lines","toUpperCase","toFixed","activeSignals","_score","_level","version","$schema","runs","tool","driver","name","ruleId","text","DEFAULT_API_URL","SNAPBACK_API_URL","BETTER_AUTH_URL","SNAPBACK_WEB_URL","AUTH_CALLBACK_PORT","AUTH_TIMEOUT_MS","createLoginCommand","Command","description","option","action","options","apiKey","loginWithApiKey","browser","loginWithBrowser","loginWithDeviceCode","String","chalk","red","exit","createLogoutCommand","spinner","ora","start","wasLoggedIn","isLoggedIn","clearCredentials","succeed","info","fail","createWhoamiCommand","credentials","getCredentials","log","yellow","gray","expiresAt","cyan","email","formatTier","tier","hoursRemaining","getTime","createGlobalDirectory","waitForCallback","startCallbackServer","authUrl","encodeURIComponent","underline","openBrowser","green","response","fetch","method","headers","body","client_id","scope","ok","errorText","json","verification_uri","bold","user_code","verification_uri_complete","pollForToken","device_code","interval","expires_in","Authorization","accessToken","saveCredentials","resolved","callbackResolver","callbackRejecter","server","createServer","req","res","startsWith","writeHead","URL","token","searchParams","get","errorPage","close","toISOString","then","successPage","catch","err","listen","rej","setTimeout","deviceCode","expiresIn","endTime","pollInterval","sleep","grant_type","access_token","refreshToken","refresh_token","user","error_description","exec","command","platform","_error","magenta","ms","BOX_STYLES","success","borderColor","borderStyle","warning","padding","margin","displayBox","contentOrOptions","title","type","styleType","boxen","titleAlignment","displaySaveStory","affectedFiles","snapshotId","substring","dim","displaySnapshotSuccess","fileCount","displayHighRiskWarning","file","FIXES","fix","fixMissingGitignore","fixNoProtection","fixStaleSession","fixHighViolations","fixNotLoggedIn","createFixCommand","argument","issue","list","displayAvailableFixes","isSnapbackInitialized","fixAll","dryRun","fixer","details","detail","gitignorePath","access","constants","F_OK","readFile","addition","appendFile","writeFile","currentProtected","getProtectedFiles","vitals","getWorkspaceVitals","criticalPatterns","detectCriticalPatterns","framework","p","pattern","saveProtectedFiles","getCurrentSession","sessionStart","startedAt","hoursSinceStart","floor","id","task","snapshotCount","appendSnapbackJsonl","endedAt","endMessage","endCurrentSession","_dryRun","violations","getViolations","oneWeekAgo","recentViolations","date","byType","sorted","Object","entries","sort","a","b","count","emoji","promoted","_workspaceRoot","fixedCount","skippedCount","patterns","envPatterns","addedAt","configPatterns","frameworkPatterns","getFrameworkPatterns","criticalDirs","dir","toLowerCase","Storage","config","snapshotsDir","blobsDir","rootDir","ensureDir","createSnapshot","generateSnapshotId","manifestFiles","totalSize","blobId","storeBlob","size","Buffer","byteLength","manifest","createdAt","manifestPath","writeFileSync","triggerType","totalBytes","restore","getSnapshot","getBlob","filesRestored","existsSync","readFileSync","listSnapshots","readdirSync","endsWith","m","deleteSnapshot","unlinkSync","garbageCollectBlobs","snapshots","referencedBlobs","Set","snap","add","allBlobs","shards","shard","shardPath","blobs","blobHash","blobPath","stats","statSync","isFile","orphaned","has","orphanedPaths","bytesReclaimed","reduce","sum","deletedBlobs","blob","totalBlobs","orphanedBlobs","pruneSnapshots","maxAgeDays","keepCount","cutoff","candidates","stale","deletedIds","totalSnapshots","staleSnapshots","deletedSnapshots","sha256","blobDir","compress","gzipSync","from","decompressed","gunzipSync","mkdirSync","recursive","errno","storageCache","Map","createStorage","cacheKey","cached","storage","set","DependencyGraphService","cacheDir","graph","getContextForFiles","getGraph","planned","relPath","toRelative","node","nodes","imports","importedBy","line","depth","calculateDepth","isOrphan","isEntryPoint","forEach","relPlanned","filteredSuggestions","circular","cycle","severity","getAffectedBy","getDependencies","getCircularDependencies","refresh","isCacheValid","cachePath","currentKey","computeCacheKey","buildGraph","generatedAt","ensureCacheDir","madgeModule","madge","default","fileExtensions","excludeRegExp","detectiveOptions","ts","skipTypeImports","deps","obj","imp","glob","ignore","createHash","stat","update","mtimeMs","digest","visited","depths","relative","createDependencyGraphService","services","getDependencyGraphService","MAX_AGE_MS","MAX_ENTRIES_PER_SOURCE","SOURCE_TYPES","formatAge","seconds","minutes","hours","days","errorKey","ensureDirSync","ErrorCacheService","cacheErrors","grouped","source","sourceErrors","filePath","e","appendFileSync","getErrorsForFiles","seen","Boolean","matchesFile","key","age","prune","removed","kept","clearForFile","createErrorCacheService","MAX_RECENT_COMMITS","GIT_TIMEOUT_MS","GitContextService","getContext","plannedFiles","branch","getBranchInfo","uncommittedChanges","getUncommittedChanges","stagedChanges","getStagedChanges","recentCommits","getRecentCommits","fileHistory","getFileHistory","emptyContext","isGitRepo","git","current","trim","upstream","gitSafe","ahead","behind","counts","parts","Number","parseInt","changes","statusCode","charAt","commits","entry","infoLine","replace","fullHash","author","affectsPlannedFiles","pf","filesChanged","history","lastCommit","lastModified","isModifiedByUser","c","modifiedByUser","cmd","execSync","encoding","createGitContextService","SEED_TIMESTAMP","seed","solution","priority","domain","HOT_TIER_LEARNINGS","DOMAIN_VSCODE_LEARNINGS","DOMAIN_WEB_LEARNINGS","DOMAIN_MCP_CLI_LEARNINGS","DOMAIN_TESTING_LEARNINGS","ANTI_PATTERNS_LEARNINGS","ARCHITECTURE_PATTERNS_LEARNINGS","seedLearnings","learningsDir","filesCreated","learningsSeeded","filesToSeed","skipHot","filename","learnings","allDomains","domains","force","l","indexPath","generateIndexMd","isLearningsSeeded","hotPath","getLearningsSeedStatus","expectedFiles","filesPresent","filesMissing","seeded","STATE_FILE","SessionFileTracker","state","loadState","startTask","taskId","taskStartedAt","trackFile","saveState","endTask","getTrackedFiles","linesChanged","normalizedPath","existing","lastTouched","undefined","sourcePriority","edited","validated","mentioned","firstTracked","trackFiles","values","getChangedFiles","determineChangeType","aiAttributed","hasActiveTask","getCurrentTaskId","getTaskDuration","getStats","filesTracked","totalLinesChanged","durationMs","getStatePath","statePath","fromEntries","createSessionFileTracker","trackers","getSessionFileTracker","ErrorCode","ERROR_METADATA","retryable","createMcpError","context","metadata","NODE_ENV","stack","createMcpErrorFromCause","cause","causeMessage","formatForLog","connections","connectionStatus","MIN_RETRY_INTERVAL_MS","MAX_CONSECUTIVE_FAILURES","REQUEST_TIMEOUT_MS","IS_WINDOWS","getSocketPath","homedir","DaemonConnection","socket","requestId","pendingRequests","buffer","socketPath","connect","writable","createConnection","handleData","pending","clearTimeout","delete","destroy","disconnect","request","params","jsonrpc","pop","getDaemonConnection","timeSinceLastAttempt","lastAttempt","consecutiveFailures","conn","connected","prevStatus","notifySnapshotCreatedViaDaemon","mcpError","McpErrorCode","DAEMON_REQUEST_FAILED","validateFilePath","valid","normalize","absolutePath","isAbsolute","relativePath","sanitizedPath","validateFilePaths","filePaths","sanitizedPaths","invalidPath","z","object","mode","enum","optional","describe","string","t","array","keywords","k","intent","thorough","boolean","compact","goal","metric","target","number","unit","refine","union","literal","notes","efficiency","saved","prevented","helped","survey","patterns_used","pitfalls_avoided","helpfulness","unhelpful_count","prevention","what","why","prevent","tests","diffWith","diff","dry","topic","q","unknown","packageName","targetVersion","workspaceId","limit","int","positive","since","datetime","op","taskDescription","acceptLearnings","random_string","whatHappened","whyItHappened","hashContent","getFileHashes","exists","findMatchingSnapshot","currentHashes","windowSize","recentSnapshots","snapshot","snapshotFileHashes","allMatch","every","snapshotHash","matched","SnapshotService","createFromFiles","pathValidation","skipDedup","existingSnapshots","match","dedupWindow","createdAtDate","reused","reusedSnapshotId","reusedReason","toLocaleString","fileContents","idx","serviceCache","createSnapshotService","TestCoverageService","coverageData","loadCoverageData","testMap","buildTestMap","filesContext","filesWithTests","totalCoverage","filesWithCoverage","testFiles","inferTestFiles","coverage","hasTests","pct","functions","branches","summary","totalFiles","averageCoverage","getLowCoverageFiles","threshold","lowCoverage","aCov","bCov","getProjectCoverage","total","getTestFiles","updateFromTestRun","testResults","getLastTestRun","updateTestMap","mappings","locations","loc","ext","base","basename","createTestCoverageService","getTestCoverageService","INTENT_LEARNING_FILES","implement","debug","refactor","review","explore","KEYWORD_DOMAIN_MAP","vscode","extension","activation","webview","nextjs","next","react","client","turbopack","biome","api","procedure","orpc","service","backend","drizzle","mcp","cli","commander","vitest","test","testing","spec","mock","validation","learning","intelligence","advisory","FILE_PATH_DOMAIN_MAP","__tests__","detectDomainFilesFromKeywords","detected","keyword","lowerKeyword","detectDomainFilesFromPaths","DEFAULT_DOMAIN_FILES","HOT_TIER_FILE","COLD_TIER_FILE","DEFAULT_MAX_LEARNINGS","USAGE_STATS_FILE","HOT_TIER_PROMOTION_THRESHOLD","minAccessCount","minAppliedCount","maxHotTierSize","recencyDays","HOT_TIER_BOOST","CRITICAL_PRIORITY_BOOST","HIGH_PRIORITY_BOOST","loadJsonlSafe","filepath","items","scoreLearning","triggerText","searchText","matches","getPriorityBoost","TieredLearningService","loadTieredLearnings","maxLearnings","loadedIds","allLearnings","hotLearnings","loadHotTier","generateId","loadedFrom","intentFiles","keywordDomainFiles","pathDomainFiles","allWarmFiles","domainLearnings","queryColdTier","maxResults","coldPath","scored","clearCache","loadUsageStats","statsPath","saveUsageStats","trackAccess","learningIds","accessCount","appliedCount","lastAccessed","trackApplied","learningId","calculatePromotionScore","usageData","daysSinceAccess","regenerateHotTier","currentHot","criticalHot","warmFiles","flat","seenIds","warmLearnings","allCandidates","candidateMap","item","newHot","criticalIds","promotedAt","newHotIds","demoted","hotContent","preserved","totalHot","getUsageStats","createTieredLearningService","createInitCommand","initialized","getWorkspaceConfig","initSource","detectInitializationSource","scanWorkspaceVitals","typescript","enabled","packageManager","createSnapbackDirectory","saveWorkspaceVitals","seedResult","updatedAt","sync","registerWorkspace","syncEnabled","saveWorkspaceConfig","strict","criticalFiles","detectedAt","packageJson","readPackageJson","detectPackageManager","detectFramework","frameworkConfidence","confidence","detectTypeScript","detectCriticalFiles","lockfiles","manager","dependencies","devDependencies","frameworks","indicators","fw","hasIndicator","indicator","tsconfigPath","stripped","tsconfig","compilerOptions","rootCritical","typescriptStrict","configPath","vitalsPath","vitalsContent","extensionVersion","createStatusCommand","gatherStatus","displayStatus","loggedIn","protection","recent","issues","creds","protectedFiles","snapshotInfo","getSnapshotInfo","detectIssues","getWorkspaceDir","readdir","withFileTypes","snapDirs","isDirectory","getDirectorySize","formatBytes","dirPath","repeat","icon","bytes","units","exp","DEFAULT_CONTEXT_FILES","instances","createWorkspaceIntelligenceConfig","snapbackDir","patternsDir","constraintsFile","violationsFile","embeddingsDb","contextFiles","enableSemanticSearch","enableLearningLoop","enableAutoPromotion","getIntelligence","Intelligence","getIntelligenceWithSemantic","initialize","renderSeverity","maxValue","normalized","filled","empty","dot","emptyDot","color","truncatePath","maxLength","firstDir","formatRelativeTime","diffMs","diffMins","diffHours","diffDays","toLocaleDateString","formatDate","isoDate","month","day","year","formatConfidence","percentage","formatRecommendation","recommendation","createRiskSignalTable","table","Table","head","style","border","colWidths","createFileSummaryTable","wordWrap","levelColor","topSignal","createSnapshotTable","createContextTable","typeColor","getTypeColor","truncateText","createValidationTable","passed","blue","createContextCommand","handleContextCommand","semantic","contextInput","extractKeywords","displayContextResults","usedSemantic","summaryContent","formatContextSummary","relevantLearnings","violation","hardRules","ruleCount","patternCount","semanticContext","sections","compression","stopWords","word","createStatsCommand","handleStatsCommand","learningStats","violationsSummary","getViolationsSummary","displayStatsResults","formatLearningStats","formatViolationStatus","feedbackRate","totalInteractions","feedbackReceived","accuracyRate","correctRate","goldenExamples","GitNotInstalledError","GitNotRepositoryError","GitBinaryFileError","GitClient","isGitInstalled","execa","isGitRepository","getRepositoryRoot","getStagedFiles","parseStatusLine","isNotRepositoryError","getStagedContent","isBinaryFileError","getStagedDiff","args","getStagedStats","additions","deletions","del","getCurrentBranch","getHeadCommit","pathParts","oldPath","parseStatus","isCodeFile","codeExtensions","ProgressTracker","label","showElapsed","isTTY","formatProgress","currentItem","progressText","complete","getElapsed","elapsed","getCurrent","getTotal","counter","truncateItem","createValidateCommand","validate","handleValidateCommand","filesToValidate","getFilesToValidate","progress","hasErrors","progressCompleted","pipelineResult","validateCode","overall","totalIssues","passedCount","r","displayValidationResults","stagedFiles","failedFiles","formatValidationSummary","failures","confirm","defaultValue","hint","prompt","rl","createInterface","timeoutId","question","answer","trimmed","confirmDangerous","confirmText","select","choices","choice","isDefault","marker","disabled","index","isNaN","opts","spinnerType","withSpinner","fn","successText","failText","progressBar","width","percent","bar","stepProgress","steps","currentStep","step","white","mask","defaultHint","done","dryRunPreview","prompts","HISTORY_FILE","MAX_HISTORY_SIZE","getHistoryPath","homeDir","HOME","USERPROFILE","loadHistory","historyPath","operations","saveHistory","fs","getLastOperation","canUndo","getRecentOperations","reverse","removeOperation","undoLastOperation","lastOp","shouldUndo","before","createLearnCommand","learn","validTypes","recordLearning","formatType","getLearnings","formats","pitfall","discovery","workflow","promisify","createPatternsCommand","patternsList","readSnapbackJson","occurrences","lastSeenAt","recordViolation","promoteToPattern","vList","promotionStatus","typeCounts","totalViolations","promotedPatterns","pendingPromotion","_","padEnd","targetDir","debtItems","scanTechnicalDebt","TODO","d","FIXME","XXX","HACK","verbose","highPriority","typeViolations","existingIndex","findIndex","writeSnapbackJson","_directory","createProtectCommand","protect","newProtection","splice","added","createSessionCommand","existingSession","formatTimeAgo","archiveSession","newSession","saveCurrentSession","currentSession","active","formatDuration","loadSnapbackJsonl","formatDurationFromDates","archived","startIso","formatSeconds","endIso","hour","minute","DEFAULT_CONFIG","debounceMs","ignored","CRITICAL_FILE_PATTERNS","RISKY_CHANGE_PATTERNS","SnapbackWatcher","watcher","signalBuffer","flushTimer","changeCountByFile","filesWatched","signalsRecorded","patternsDetected","lastActivityAt","chokidar","watch","ignoreInitial","awaitWriteFinish","stabilityThreshold","ignorePermissionErrors","persistent","getWatchedCount","handleChange","watchSnapbackDir","startFlushTimer","stop","clearInterval","flushSignals","isRunning","isCritical","isCriticalFile","isRisky","isRiskyChange","critical","risky","changeCount","detectPatterns","violationsWatcher","checkViolationPromotion","violationType","checkProtectionSuggestion","isProtected","RegExp","setInterval","watched","getWatched","acc","isError","prefix","createWatcher","getBehavioralSignals","analyzeBehavioralSignals","fileCounts","createWatchCommand","meta","shutdown","totalSignals","mostChanged","criticalChanges","keys","mapToCommitPhase","phase","DEFAULT_WEIGHTS","wT","wL","wF","wA","wC","PHASE_BASELINES","feature","exploratory","PHASE_HARD_CAPS","PHASE_MULTIPLIERS","DEFAULT_THRESHOLDS","autoSnapshot","suggestCommit","strongCommit","DEFAULT_COOLDOWNS","minSnapshotInterval","minPromptInterval","HYSTERESIS","snapshotEnter","snapshotExit","promptEnter","promptExit","strongEnter","strongExit","DEFAULT_USER_TUNING","thresholdScale","promptCooldownScale","snapshotCooldownScale","WEIGHT_BOUNDS","stepSize","PR_METRICS_THRESHOLDS","reviewTimeDanger","commentsDanger","minPRsForAdjustment","computeTimeRisk","minutesSinceCommit","cap","over","range","x","shaped","computeLinesRisk","computeFilesRisk","computeAiRisk","aiFraction","computeChurnRisk","churnPercent","CommitRiskSystem","weights","thresholds","userTuning","lastSnapshotAt","lastPromptAt","isInSnapshotState","isInPromptState","isInStrongState","outcomes","maxOutcomes","evaluate","breakdown","computeBreakdown","scaledThresholds","applyUserScaling","escalation","determineAction","finalScore","educational","generateReason","shouldAct","evaluation","cooldowns","getScaledCooldowns","recordSnapshot","recordPrompt","recordOutcome","shift","getOutcomeStats","totalSessions","badOutcomeRate","avgRiskAtBadOutcome","bucketStats","badOutcomes","o","hadRevertWithin2Weeks","hadBugFixWithin2Weeks","maxRiskScore","buckets","bucket","bad","badRate","recalibrate","targetBadOutcomeRate","adjusted","belowThreshold","badBelowThreshold","badRateBelowThreshold","optimizeWeights","optimized","factorCorrelations","correlations","calculateFactorCorrelations","totalCorrelation","factorKeys","correlationMap","time","ai","churn","targetWeights","targetSum","w","newWeight","factorName","getFactorName","normalizeWeights","recalibrateWithPRMetrics","outcomesWithPR","prReviewTimeMin","prCommentsCount","prAnalysis","totalPRs","avgReviewTime","avgComments","problematicPRRate","outcomesWithReviewTime","outcomesWithComments","problematicPRs","problematicRate","lowRiskProblematic","lowRiskProblematicRate","largePRs","prSizeLines","largePRProblematicRate","setThresholds","getWeights","setWeights","setUserTuning","tuning","getConfig","getOutcomes","setOutcomes","reset","timeRisk","linesRisk","filesRisk","aiRisk","churnRisk","rawScore","phaseMultiplier","scale","_thresholds","_now","enteredState","risks","primary","goodOutcomes","calcCorrelation","__name","extract","badMean","goodMean","linesAtCommit","filesAtCommit","createCommitRiskSystem","serializeCommitRiskSystem","system","deserializeCommitRiskSystem","PRESSURE_THRESHOLDS","moderate","OXYGEN_THRESHOLDS","good","TRAJECTORY_THRESHOLDS","escalatingPressure","escalatingOxygen","criticalPressure","criticalOxygen","recoveringOxygen","URGENCY_THRESHOLDS","getPressureLevel","getOxygenLevel","calculateUrgencyScore","pressure","oxygen","tempScores","cold","warm","hot","burning","temperatureLevel","getUrgencyLevel","shouldRecommendSnapshot","trajectory","should","urgency","DORA_THRESHOLDS","elite","meanTimeToRecovery","leadTimeForProtection","snapshotFrequency","recoverySuccessRate","DORAMetrics","snapshotEvents","recoveryEvents","measurementWindowMs","pruneOldEvents","recordRecovery","getMetrics","recentRecoveries","requestTime","successfulRecoveries","completionTime","timeSinceLastChange","hoursInWindow","recoveryTriggered","isRecoveryTriggered","reworkRate","performanceTier","calculatePerformanceTier","totalRecoveries","getRecoveryTime","recovery","getTrends","currentWindow","halfWindow","midpoint","firstHalfRecoveries","secondHalfRecoveries","firstHalfSnapshots","secondHalfSnapshots","firstRecoveryAvg","calculateAvgRecoveryTime","secondRecoveryAvg","recoveryTrend","frequencyTrend","recoveries","successful","metrics","createDORAMetrics","DEFAULT_DOC_FRESHNESS_CONFIG","staleHours","docPatterns","sourcePatterns","DocFreshnessSensor","docFiles","absolute","sourceFiles","docMtimes","getMtimes","sourceMtimes","staleThreshold","staleDocs","docPath","docMtime","hoursStale","docDir","newerSourceFiles","srcPath","srcMtime","isStale","mtime","freshDocs","freshnessValue","staleCount","totalDocs","checkSpecificDocs","docPaths","hoursOld","mtimes","formatStaleDocs","doc","newerFiles","loadJsonl","PatternLookup","learningsCache","violationsCache","lookup","query","extra","extractFileKeywords","scoreAndFilter","extname","dirs","scenario","fileContext","loadLearnings","scoreMatch","relevance","loadViolations","relatedFiles","extractSearchText","scenarioMatch","countOverlap","keywordMatch","kw","fileMatch","text1","text2","tokens1","tokens2","overlap","triggers","learningsPath","violationsPath","DEFAULT_THRESHOLD_ADJUSTMENTS","pulseMultiplier","temperatureMultiplier","pressureMultiplier","oxygenMultiplier","CALIBRATION_THRESHOLDS","MIN_OBSERVATIONS_TO_START","OBSERVATIONS_FOR_CALIBRATION","OBSERVATIONS_TO_LOCK","PHASE_PATTERNS","hotfix","release","PHASE_THRESHOLDS","intervalMultiplier","maxLinesBeforeSnapshot","riskMultiplier","recommendedIntervalMinutes","aiAdjustedIntervalMinutes","PhaseDetector","cachedPhase","lastBranch","overrides","detectPhase","branchName","override","getOverride","matchedPattern","inferredPhase","inferPhaseFromStructure","getThresholdMultiplier","detection","getRiskMultiplier","requiresFrequentSnapshots","getRecommendedInterval","aiActive","exceedsLineThreshold","setOverride","expiryMinutes","clearOverride","hasOverride","getAllOverrides","serializeOverrides","deserializeOverrides","clear","getPhaseThresholds","getPhasePatterns","SnapshotSuggester","snapshotHistory","maxHistorySize","suggestSnapshot","forecast","buildMetrics","scoreUrgency","buildRecommendation","lastSnapshot","timeDiffMinutes","pressureRate","aiActivityBurst","temperature","aiPercentage","criticalFilesTouched","trajectoryConfidence","calculateConsistency","reasons","soon","TeamAggregator","userMetrics","teamId","recordUserMetrics","userId","username","getTeamAggregation","users","getEmptyAggregation","aggregateMetrics","distribution","getDistribution","aggregationTime","memberCount","topContributors","getTopContributors","concerns","detectConcerns","getUserComparison","teamAgg","comparison","aiAcceptanceRate","vsTeam","avgAIAcceptanceRate","churnRate","avgChurnRate","testPassRate","avgTestPassRate","sessionDuration","avgSessionDuration","determineStatus","u","totalFileSaves","totalAISuggestions","mean","median","stdDev","variance","sqrt","LOW_TEST","HIGH_CHURN","affectedUsers","team","clamp","ThresholdCalibrator","learner","profile","createInitialProfile","observationCount","thresholdAdjustments","riskTolerance","typicalPulseLevel","lastCalibratedAt","updateFromBehavior","observations","getObservations","totalObservations","calculateStatus","calculateRiskTolerance","calculateConfidence","calculateTypicalPulseLevel","calculateAdjustments","earlyRatio","earlySnapshots","aggressiveRatio","lateSnapshots","missedRecommendations","countConfidence","behaviors","alignedSnapshots","maxBehavior","consistency","entropyPenalty","obs","pulse","changesPerMinute","baseMultiplier","riskProfile","clampedMultiplier","getProfile","getAdjustedThresholds","TrajectoryPredictor","maxHistory","recordSnapshots","predict","createDefaultForecast","calculateContext","getCurrentTrajectory","trend","calculateTrend","in5Minutes","predictTrajectoryAt","in10Minutes","timeToStateChange","calculateTimeToStateChange","recentHistory","oxygenRate","temperatureTrend","pulseTrend","calculateRate","calculateTemperatureTrend","calculatePulseTrend","getValue","first","last","valueDelta","timeDeltaMinutes","delta","recentRate","minutesAhead","currentPressure","projectedPressure","targetPressure","pressureDelta","timeMinutes","UserBehaviorLearner","recordObservation","timing","classifyTiming","calculateUrgency","observation","userCreatedSnapshot","vitalsRecommended","urgencyAtTime","avgPressureAtSnapshot","avgOxygenAtSnapshot","aligned","early","late","missed","snapshotObs","avgPressure","avgOxygen","inferRiskProfile","_aligned","missedRatio","lateRatio","DEFAULT_OXYGEN_CONFIG","staleMinutes","criticalWeight","OxygenSensor","modifiedFiles","recordModification","recordBulkSnapshot","getLevel","covered","snapshotTime","coveragePercentage","getUncoveredFiles","getCounts","modified","DEFAULT_PRESSURE_CONFIG","baseRate","criticalMultiplier","decayOnSnapshot","maxPressure","PressureGauge","changeBasedPressure","unsnapshotedChanges","lastSnapshotTime","initialTime","recordChange","multiplier","increment","getState","minutesSinceSnapshot","timePressure","totalPressure","timeSinceLastSnapshot","getRecommendation","shouldSnapshot","getRecommendations","recommendations","DEFAULT_PULSE_CONFIG","elevated","racing","windowSeconds","PulseTracker","pruneOld","classifyLevel","getChangeCount","DEFAULT_TEMPERATURE_CONFIG","decaySeconds","TemperatureMonitor","aiEvents","humanEvents","recordAIActivity","recordHumanActivity","detectedTool","human","formatRecoveryConfidence","formatMTTR","formatChainIntegrity","chain","isIntact","hasRollbackPoints","chainLength","formatDORATier","formatSaveCount","today","thisWeek","allTime","TRACKING_LIMITS","maxSnapshotChain","maxAIToolEvents","minAIEventsForCalibration","aiCalibrationSmoothingDivisor","defaultAICalibration","TIME_CONSTANTS","chainGapThresholdMs","oneDayMs","protectionThresholdMinutes","maxUnsnapshotedChangesForProtection","ESTIMATION_CONSTANTS","linesPerFileEstimate","baseRecoveryTimeMs","recoveryTimePerFileMs","defaultRecentSnapshotFiles","toPulseLevel","validLevels","toTemperatureLevel","toTrajectory","validTrajectories","TrustMetricsServiceImpl","disposed","auditTrail","saveCount","lastResetDate","toDateString","updateListeners","sessionHistory","doraTrends","lastDORATrendRecordedAt","thresholdHistory","cumulativeStats","totalLinesProtected","totalHoursProtected","firstSnapshotAt","sessionStartTime","snapshotChain","lastRecoveryAt","aiToolEvents","maxAuditEntries","measurementWindow","maxSessionHistory","maxDORATrendPoints","maxThresholdHistory","getExtensionMetrics","core","getCoreTrustMetrics","getLiveVitals","commitRisk","getCurrentCommitRisk","getCurrentPhase","getDefaultPhase","getPressureRecommendation","getDefaultRecommendation","recentActivity","getRecentActivity","getSaveCount","getWebConsoleMetrics","dora","doraMetrics","maybeRecordDORATrend","getDORATrends","recoveryFailures","getRecoveryFailures","teamBenchmarks","getTeamBenchmarks","getSessionHistory","riskCalibration","getRiskCalibration","getCumulativeStats","recoveryConfidence","calculateRecoveryConfidence","chainIntegrity","getChainIntegrity","sessionProtection","getSessionProtection","addAuditEntry","filesProtected","linesProtected","wasProtective","parentId","parentSnapshotId","incrementSaveCount","emitUpdate","failureReason","predicted","actual","recordRiskEvaluation","onUpdate","callback","indexOf","syncToConsole","_request","consoleMetrics","syncedAt","applyThresholdAdjustments","adjustments","commitRiskSystem","currentConfig","oldThreshold","newThreshold","dispose","isDisposed","startSession","peakRiskScore","snapshotsCreated","recoveriesPerformed","linesCommitted","hadBadOutcome","endSession","completedSession","sessionHours","updateSessionRisk","incrementSessionSnapshots","incrementSessionRecoveries","getVitals","getDefaultVitals","coveragePercent","trends","failedRecoveries","aiToolCalibration","calculateAIToolCalibration","correct","accuracy","smoothingFactor","gaps","prev","curr","timeDiff","hoursGap","oldestRecoverable","filesSinceSnapshot","linesSinceSnapshot","estimatedRecoveryTime","recentSnapshotFiles","filesAffected","eventuallyRecovered","sessions","hoursProtected","lastDate","currentDate","daysDiff","BehaviorTracker","edits","aiSuggestions","fileSaves","recordEdit","linesAdded","linesDeleted","recordFileSave","recordTest","recordAISuggestion","accepted","getMetadata","totalSuggestions","acceptedSuggestions","rejectedSuggestions","sessionMinutes","totalTests","passedTests","avgTimeBetweenEdits","intervals","fileSaveCount","aiSuggestionsShown","aiSuggestionsAccepted","aiSuggestionsRejected","getRawCounts","saves","DEFAULT_VITALS_CONFIG","WorkspaceVitals","calibrator","predictor","phaseDetector","currentBranch","behaviorTracker","for","instance","create","clearInstances","tryGet","onFileChange","isAI","checkAndEmit","onSnapshot","onAIDetected","pulseData","tempData","pressureData","oxygenData","calculateTrajectory","behavior","recordHistorySnapshot","getHistory","getAgentGuidance","snapshotDecision","blockedOps","safeOps","snapshotReason","riskyFiles","safeOperations","blockedOperations","getSuggestion","tempMultiplier","recordBehavior","decision","getCalibratedThresholds","getForecast","getBehaviorStats","getCalibrationProfile","resetLearning","getBehavioralMetadata","setCurrentBranch","getPhaseRiskMultiplier","getPhaseThresholdMultiplier","getDetectedPhase","getCombinedThresholdMultiplier","temp","latestPressure","earliestPressure","pressureTrend","formatWireLabeled","fields","WIRE_PREFIX","formatWire","formatMessage","BRAND_PREFIX","clean","getRelativeTime","getRelativeTimeHuman","buildStartResponse","learningsStr","hotspotsStr","hotspots","wire","risk","prot","dirty","snapshotStatus","messages","created","buildCheckResponse","tsStatus","checked","lintStatus","lint","testsStatus","issuesStr","buildRestoreResponse","timeAgo","isDry","preview","single","multiple","buildListResponse","notFound","buildEndResponse","learningsCount","linesRemoved","wireWithSurvey","statsParts","tokensSaved","savingsPercent","mistakesPrevented","buildLearnResponse","fullType","LEARNING_TYPE_MAP","captured","buildViolationResponse","promote","shouldPromote","auto","shouldAutomate","automate","recorded","buildErrorResponse","generic","capitalize","formatToolResult","humanize","INTERNAL_SEPARATOR","createdWithStats","proactive","skipped","withReassurance","cantRestoreUnsaved","nudge","beforeRisky","allClear","minutesAgo","protected","started","checkpoints","taskStarted","taskDesc","quickComplete","applied","tokens","sessionSavings","restores","dollarsSaved","pat","pit","eff","disc","wf","createRequestContext","randomUUID","ctx","logError","logSuccess","ErrorCodes","CommonErrors","MISSING_REQUIRED_PARAM","INVALID_PARAM_TYPE","INVALID_PARAM_VALUE","VALIDATION_FAILED","PATH_TRAVERSAL_BLOCKED","FILE_NOT_FOUND","SNAPSHOT_NOT_FOUND","SESSION_NOT_FOUND","CONTEXT_NOT_INITIALIZED","TIER_GATE_BLOCKED","OPERATION_NOT_ALLOWED","PERMISSION_DENIED","SNAPSHOT_CREATE_FAILED","SNAPSHOT_RESTORE_FAILED","STORAGE_ERROR","CONTEXT_OPERATION_FAILED","SESSION_OPERATION_FAILED","UNKNOWN_TOOL","HANDLER_ERROR","INTERNAL_ERROR","missingParam","param","invalidParam","expected","received","fileNotFound","snapshotNotFound","pathTraversalBlocked","tierGateBlocked","requiredTier","currentTier","upgradeUrl","handlerError","permissionDenied","operation","time_estimate","help_url","_llm","suggest","auto_offer","createDefaultState","currentTask","changesSinceTaskStart","pendingObservations","surfacedLearnings","riskAreasTouched","validatedFiles","tasksCompleted","restoresPerformed","learningsCaptured","pendingSuggestedLearnings","getSessionState","sessionStates","loaded","loadStateFromDisk","updateSessionState","updates","updated","saveStateToDisk","generateTaskId","gitBaseline","captureGitBaseline","getCurrentTask","recordFileChange","riskAreas","detectRiskAreas","area","areas","lowerPath","pushObservation","drainPendingObservations","getStateFilePath","moduleCtx","baseline","getBaselineFileSet","words","remainingMinutes","formatMcpError","isMcpError","originalName","originalType","formatForUser","isRetryable","isErrorCode","init_errors","getStore","store","stores","dbPath","KnowledgeStore","getIndexedIds","ids","indexedIds","ensureEmbeddingsReady","embeddingsReady","embeddingsLoading","attempts","preloadEmbeddings","isEmbeddingsAvailable","indexLearning","generateEmbedding","indexed","sourceType","mapLearningTypeToSourceType","chunk","source_type","source_id","chunk_text","context_text","authority","getAuthorityScore","insertChunk","textForEmbedding","embedding","getEmbedding","storeEmbedding","indexAllLearnings","embeddingsGenerated","defaultFiles","filesToIndex","generateEmbeddings","skipEmbeddings","indexResult","readError","invalidateCache","getHybridRetriever","retrievers","CACHE_TTL_MS","retriever","HybridRetriever","semanticWeight","keywordWeight","minConfidence","candidateMultiplier","indexedWorkspaces","retrieveAdaptive","performance","indexingPerformed","classification","classifyQuery","fallbackUsed","embeddingsAvailable","keywordOnlySearch","MIN_CLASSIFICATION_CONFIDENCE","keywordResults","searchKeyword","sources","rank","semanticCandidates","keywordCandidates","fusedCount","latencyMs","classifyQueryType","initializeHybridRetrieval","indexingResult","invalidateRetrieverCache","atomicWriteFileSync","maxSize","MAX_CONTEXT_FILE_SIZE","atomicWriteSyncOSS","validateInput","schema","safeParse","errorMessages","getToolSchema","toolName","TOOL_SCHEMAS","snapSchema","snapEndSchema","snapLearnSchema","snapViolationSchema","checkSchema","snapFixSchema","snapHelpSchema","snap_end","snap_fix","snap_help","snap_learn","snap_violation","check","beginTaskViaDaemon","getSessionChangesViaDaemon","endTaskViaDaemon","intel","enhancedValidation","sessionPersistence","autosave","initializeIntelligence","disposeIntelligence","disposeAllIntelligence","disposals","root","getActiveInstanceCount","inferIntent","lower","getIntentContextHints","INTENT_CONTEXT_CONFIG","checkContextStaleness","ctxPath","daysSinceScanned","DEFAULT_STALE_AFTER_DAYS","lastScanned","staleAfterDays","scanTime","rebuildContext","handleStaleContext","staleness","rebuild","assessRisk","criticalAreas","hasCritical","overallRisk","shouldAutoSnapshot","getConstraints","constraints","domainConstraints","constraint","generateNextActions","_learnings","staticAnalysis","actions","skippedTests","runStaticAnalysis","fileMap","analyzeSkippedTests","analysisResults","analysisResult","parsed","generateProactiveGuidance","guidance","AdvisoryEngine","SkippedTestRule","engine","registerRule","testFile","triggerContext","toolCallCount","loopsDetected","consecutiveFileModifications","fragility","advisoryContext","enrich","category","skippedTestSuggestions","formatCompactResult","gitContext","constraintMap","learningStrings","contextWarnings","proactive_guidance","topSuggestion","riskAssessment","dirtyFiles","formatCompactText","snapshotIcon","constraintStr","handleBeginTask","prioritize","include","exclude","providedKeywords","skipSnapshot","intentHints","daemonResult","lastKnownErrors","errorCacheService","cachedErrors","lintErrors","gitContextService","dependencyContext","depGraphService","testCoverage","coverageService","nextActions","compactOutput","_hint","_source","snapshotService","snapshotResult","tieredLearningService","tieredLearnings","shownLearnings","pitfalls","other","relevanceScore","hybridRetrievalStats","searchQuery","hybridResult","existingTriggers","chunkText","learningType","queryType","resultsFound","contextResult","patternLines","tags","knownErrorCount","uncommittedCount","rebuiltWarning","appendLearning","inferBehaviorType","how","lowered","mapEffortDelta","inferFeature","buildAccountabilityEffect","reflection","validValues","perceived_help","session_id","session_duration_ms","actual_changes","files_modified","lines_added","lines_removed","snapshots_used","prevented_issues","rollbacks_avoided","pattern_violations_caught","skipped_tests_flagged","accountability","behaved_differently","accountability_behavior","would_have_behaved_differently","behavior_change_type","what_triggered_accountability","triggered_by","effort_delta","effort_change","snapback_feature_responsible","outcome_improved","getIntentHint","INTENT_COMPLETION_HINTS","handleCompleteTask","completed","abandoned","blocked","customLearning","unvalidatedFiles","failedLearnings","accountability_effect","learningsAccepted","finalSnapshot","sessionStats","totalLearnings","_warnings","intentHint","baseHint","_intentHint","fallbackWarnings","modifiedFilePaths","validatedFilePaths","unvalidatedFilePaths","failedLearningWrites","writeResult","getObservationEmoji","generateRecommendations","aiChanges","generateQuickReference","generateProtocolText","generatePairingProtocol","taskContext","recentObservations","quickReference","protocolText","getContextSummary","getErrorPatternRegistry","ErrorPatternRegistry","BUILT_IN_PATTERNS","solutions","autoFixable","autoFix","register","errorMessage","regex","extracted","groups","assign","val","best","matchMultiple","getByCategory","getAutoFixable","formatHint","runCommand","timeoutMs","killed","shell","kill","checkTypeScript","isRelevant","checkTests","runTests","discovered","failed","jsonMatch","testResult","numPassedTests","numFailedTests","tr","passMatch","failMatch","run","failedCount","checkLint","fileArgs","diagnostics","diag","handleQuickCheck","providedFiles","skipTypeScript","skipTests","skipLint","checks","allPassed","hasWarnings","errorsToCache","errorMsg","column","registry","allErrors","getResponseConfig","TIER_LIMITS","local","compressResponse","full","maxBytes","compressed","arrayFields","maxArrayItems","field","arr","truncated","verboseFields","removeVerboseNested","truncateStrings","maxLen","maxStringLen","_compressed","_originalSize","_tier","buildSmartActions","baseActions","hasUnsavedChanges","condition","skipIf","lastSnapshotMinutes","hasCodeChanges","isNewTask","violationCount","generateCoachingHint","lastAction","taskPhase","snapshotAge","randomChoice","COACHING_TEMPLATES","afterSnapshot","afterViolation","highRisk","hashes","computeBlobId","filesMatchSnapshot","snapshotFiles","snapshotBlobMap","snapshotBlobId","maxSnapshotsToCheck","isLearningStalel","deprecated","validUntil","ageDays","filterStaleLearnings","getArchitectureVersion","archVersion","updated_at","cleanupStaleLearnings","found","deleted","archStale","allStale","remaining","newContent","cleanupArchivedSessions","sessionArchiveDir","pro","free","starting","working","finishing","getGitDiffStats","baselineFiles","numstat","generateCommitMessage","lowerDesc","scopes","subject","scopePart","suggestLearnings","layer","getFileDiff","maxBuffer","getGitChanges","countLinesChanged","assessChangeRisk","factors","lowerFile","aiFiles","aiRatio","totalLines","jsonResult","finalData","errorJsonResult","listSnapshotsReadonly","snapshotDir","isLocalWorkspace","workspacePath","calculatePackageScore","learningPackages","queryPackages","queryPkg","queryLower","learningPkg","learningLower","matchRatio","parseImportPath","subpath","findPackageDir","nodeModulesPath","localPackagesPath","localName","localPath","extractExportsFromFile","packageDir","exportTarget","exports","targetPath","extensions","resolvedPath","tryPath","srcTarget","exportPatterns","names","n","getExportDescription","exportPath","pathDescriptions","handleValidate","handleLearn","handleCheckPatterns","handleReportViolation","checkPatterns","layers","issueCount","focusPoints","next_actions","lineNum","rule","criticalCount","warningCount","isRemoteMode","remoteMode","instruction","indexError","invalidateKnowledgeCache","storagePath","reportViolation","violationId","promotedTo","automation","normalizeCheckParams","MODE_MAP","rawFiles","handleBuildCheck","handleImpactAnalysis","analyzer","createChangeImpactAnalyzer","contents","analyzedFiles","sizeKB","absolutePaths","impact","getFullImpact","totalKB","impactScore","breakingChanges","affectedTests","performanceImpacts","analysis","filesAnalyzed","dependentFiles","handleCircularCheck","targetDirs","dirsToCheck","allCycles","affectedPackages","package","totalCycles","handleDocFreshnessCheck","getMtime","srcMtimes","freshness","handleLearningsMaintenance","totalTracked","topLearnings","regeneration","accessed","handleArchitectureCheck","runArchCheck","SNAPBACK_LAYER_RULES","globalExclude","errorViolations","warningViolations","sourceFile","importPath","ruleDescription","rulesChecked","rulesPassed","layerRules","handleTraceAnalysis","depService","absoluteFiles","depContext","dataFlow","totalImports","totalImportedBy","filesWithContext","formatTraceResult","humanMessage","formatCheckResult","issueDetails","msg","handleCheck","checkTool","tracker","inputSchema","properties","oneOf","annotations","readOnlyHint","idempotentHint","detectIntent","taskLower","normalizeParams","modeMap","rawMode","explicitIntent","formatWireResponse","formatWireCompact","handleStart","beginArgs","pioneer","idempotencyKey","recordAction","protectionScore","h","handleCheckMode","checkArgs","handleContext","bundleInfo","measureBundleSize","bundleMsg","distPaths","distPath","distDir","handleSnap","snapTool","getEfficiencyMetrics","newLearnings","identifyImprovements","improvements","validationRuns","formatUserStats","formatImprovements","checkTaskGoal","sessionPath","sessionData","met","compressStr","handleSnapEnd","snapEndTool","goalCheck","customLearnings","learningService","promotionResult","surveyAttributionCount","sessionState","patternsUsed","pitfallsAvoided","hasReachedThreshold","completeArgs","wireFields","learningsGenerated","surveyJson","userStats","improvementNotes","promotionInfo","feedbackInfo","fullResponse","handleSnapFix","snapFixTool","snapshotSummaries","brandGetRelativeTime","snap1","snap2","notFoundId","files1","files2","changed","to","filesToRestore","fileNames","restoredFiles","restored","destructiveHint","getToolsHelp","getStatusHelp","getWireHelp","getModesHelp","getThresholdsHelp","handleSnapHelp","snapHelpTool","_context","allHelp","handleSnapLearn","snapLearnTool","learnArgs","required","handleSnapViolation","snapViolationTool","violationArgs","isConsolidatedTool","CONSOLIDATED_HANDLERS","getConsolidatedHandler","getMigrationGuidance","legacyTool","mapping","LEGACY_TO_CONSOLIDATED","CONSOLIDATED_TOOLS","begin_task","get_context","prepare_workspace","get_learnings","quick_check","check_patterns","complete_task","review_work","what_changed","snapshot_list","snapshot_restore","compare_snapshots","report_violation","get_pairing_protocol","ToolCapability","ALL_CAPABILITIES","CapabilityGroups","TIER_HIERARCHY","ToolNotFoundError","TierNotAuthorizedError","CapabilityNotGrantedError","InputValidationError","SNAPSHOT_READ","SNAPSHOT_WRITE","SNAPSHOT_DELETE","SESSION_READ","SESSION_WRITE","LEARNING_READ","LEARNING_WRITE","VALIDATE_READ","TELEMETRY_WRITE","TEAM_READ","TEAM_WRITE","COMPLIANCE_READ","COMPLIANCE_EXPORT","AUDIT_READ","SNAPSHOT_ALL","SESSION_ALL","LEARNING_ALL","ENTERPRISE","missingCapabilities","validationErrors","DEFAULT_RULES","CapabilityManager","capabilities","rules","featureFlags","customRules","setFeatureFlag","flag","getActiveCapabilities","tierHierarchy","userTierIndex","ruleTierIndex","featureFlag","hasCapabilities","missing","granted","hasCapability","capability","addRule","getAllCapabilities","getCapabilitiesForTier","mockWorkspace","THREAT_PATTERNS","AnalyzeBeforeApplyInputSchema","analyzeBeforeApply","threat","lastIndex","formatAnalysisResult","decisionText","BridgeReceiver","port","host","defaultWorkspaceRoot","observationsReceived","changesReceived","lastActivity","handleRequest","getStatus","running","setHeader","handlePush","handleStatus","handleHealth","sendJson","processPush","observationsCount","changesCount","healthy","bridgeReceiver","getBridgeReceiver","startBridgeReceiver","receiver","stopBridgeReceiver","createRiskObservation","createPatternObservation","patternName","createWarningObservation","createSuggestionObservation","createProgressObservation","MCP_ROUTES","SnapBackAPIClient","circuitBreaker","ky","prefixUrl","baseUrl","retry","hooks","beforeRequest","CircuitBreaker","endpoint","doFetch","errorThresholdPercentage","resetTimeout","volumeThreshold","call","route","fetchWithRetry","maxAttempts","lastError","attempt","fire","delay","HTTPError","statusText","getCircuitState","opened","halfOpen","currentVitals","healthScore","activeWarnings","readyForPromotion","wrapWithSessionHealth","sessionAwareResult","enhanced","isRiskyState","getRecommendedActions","priorityOrder","getRecommendedAction","handlerRegistry","registerHandler","handler","getHandler","listFacadeTools","MCP_EVENTS","TOOL_CALLED","CONTEXT_PROVIDED","AGENT_SELF_CHECK","SENSITIVE_KEYS","sanitizeParams","sanitized","McpEventTracker","telemetry","trackToolCalled","props","parameters","trackContextProvided","trackAgentSelfCheck","enhanceWithSessionHealth","getVitalsSnapshot","snapshotRecommended","originalText","_sessionHealth","createMcpServer","Server","tools","resources","experimental","serverInfo","storageMode","writeCapable","cliAvailable","cliSetupCommand","auth","eventTracker","setRequestHandler","ListToolsRequestSchema","availableTools","CallToolRequestSchema","arguments","reqCtx","migration","toolDef","tool_name","client_type","execution_time_ms","was_successful","error_code","pathMatch","operationMatch","createMcpServerWithRegistry","createRegistryBasedServer","baseContext","getToolNames","capManager","activeCapabilities","execute","toolResult","TOOL_CAPABILITY_MAP","inferCapabilities","createLegacyContextFromNew","newContext","adaptLegacyHandler","legacyHandler","legacyContext","adaptLegacyTool","mapTier","legacyTier","adaptLegacyTools","getAdaptedConsolidatedTools","toolPairs","validateJsonSchema","inputObj","ToolRegistry","capabilityManager","validateToolDefinition","allTools","maxTierIndex","toolTierIndex","isTierAuthorized","getMissingCapabilities","validationResult","beforeExecute","afterExecute","onError","isAvailable","getCapabilityManager","unregister","requiredTierIndex","createToolRegistry","HttpTransportManager","cleanupInterval","registryInitialized","sessionTimeoutMs","maxSessions","enableJsonResponse","cleanupStaleSessions","ensureRegistryInitialized","adaptedTools","handlePost","handleGet","handleDelete","transport","lastAccessedAt","isInitializeRequest","StreamableHTTPServerTransport","sessionIdGenerator","onsessioninitialized","onclose","getSessionCount","createHttpTransport","runStdioMcpServer","StdioServerTransport","validateWorkspacePath","hasGit","hasPackageJson","hasSnapback","lstatSync","isSymbolicLink","findWorkspaceRoot","startPath","currentPath","maxIterations","iterations","hasWorkspaceMarker","parent","resolveWorkspaceRoot","explicitPath","resolveTier","cliTier","envTier","SNAPBACK_TIER","SNAPBACK_API_KEY","createMcpCommand","createCommand","workspaceValidation","serverOptions","mcpCommand","createToolsCommand","listTools","toolsToConfig","cursor","claude","windsurf","continue","zed","cline","gemini","aider","rooCode","qoder","autoConfigureTools","yes","dev","configureTool","checkToolsStatus","validateTools","repairTools","detectAIClients","clients","displayName","skipPrompts","providedApiKey","devMode","workspaceOverride","needsSetup","showNextSteps","clientNames","proceed","resolveApiKey","configureClient","localCliPath","findCliDistPath","validateClientConfig","mcpConfig","getSnapbackMCPConfig","useLocalDev","writeClientConfig","postValidation","backup","startDir","possiblePaths","envKey","wantApiKey","password","hasIssues","issueIcon","configured","totalErrors","totalWarnings","infos","clientsWithIssues","repaired","repairClientConfig","DaemonError","captureStackTrace","toJsonRpcError","ValidationError","PathTraversalError","defaultFileSystem","mkdir","LocalEngineAdapter","fileSystem","getWorkspacePath","isInitialized","assertInitialized","gatherFiles","toLocaleTimeString","deduplicated","stored","parseMetadata","after","restoreSnapshot","backupCurrent","currentFiles","targetRestoreId","getFileContent","getFileStates","states","computeHash","getStorageStats","oldestSnapshot","newestSnapshot","timestamps","cleanup","cleaned","sortedSnapshots","toDelete","maxAge","keepProtected","maxCount","sortedByNewest","toKeep","metadataJson","InMemoryStorage","createLocalEngine","adapter","getDefaultWorkspacePath","DEFAULT_CONTEXT","connectivity","authState","privacyMode","createRuntimeContext","ContextDetection","detectConnectivity","navigator","onLine","shouldUseTeamFeatures","teamSync","shouldUsePlatformSync","shouldUseLocalOnly","RuntimeContextManager","listeners","initialContext","updateContext","previous","changedFields","subscribe","setConnectivity","setPrivacyMode","SyncQueue","queue","maxRetries","enqueue","retryCount","getPending","remove","RuntimeRouter","syncQueue","syncTimer","localEngine","platformRuntime","autoSync","syncInterval","startAutoSync","wasOffline","enableSyncQueue","processSyncQueue","shouldUsePlatform","syncSnapshot","localSnapshot","platformSnapshot","localSnapshots","platformSnapshots","snapshotMap","localDeleted","processed","shouldRetry","getSyncQueueStatus","intervalMs","stopAutoSync","createRuntimeRouter","HttpWorkspaceApiClient","suggestWorkspace","repoPath","mapToWorkspaceBinding","getWorkspaceById","listWorkspaces","workspaces","ws","createWorkspace","updateWorkspace","deleteWorkspace","init","workspace_id","workspaceName","display_name","repo_path","organizationId","organization_id","user_id","permissions","read","manage","invite","resolvedFrom","createWorkspaceApiClient","WorkspaceResolverImpl","cache","CONFIG_FILENAME","LOCAL_FILENAME","serverApiClient","generateCacheKey","binding","repoConfig","readRepoConfig","createBindingFromConfig","cacheBinding","localConfig","readLocalConfig","defaultBinding","createDefaultWorkspace","resolveById","_key","bind","storedConfig","writeRepoConfig","writeLocalConfig","unbind","_userId","unlink","serverWorkspaces","keysToDelete","_value","readConfigFile","writeConfigFile","serverBinding","MAX_PATH_LENGTH","TRAVERSAL_PATTERNS","WINDOWS_DANGEROUS_PATTERNS","DANGEROUS_CHARS","PathValidator","allowAbsolute","checkSymlinks","baseDir","validatePath","validateBasic","resolvedWorkspace","resolvedFile","normalizedRelative","validatePathWithSymlinkCheck","lstat","realpath","realPath","realRelative","validatePaths","sanitizePath","sep","getAliasPath","loadAliases","aliasPath","aliases","saveAliases","setAlias","reserved","isUpdate","deleteAlias","listAliases","def","SUGGESTED_ALIASES","showSuggestions","createAliasCommand","CONFIG_SCHEMA","createConfigCommand","listConfig","getConfigValue","setConfigValue","unsetConfigValue","showConfigPaths","showConfigKeys","globalConfig","getGlobalConfig","global","getGlobalDir","formatValue","hasWorkspace","workspaceConfig","determineScope","parsedValue","parseValue","saveGlobalConfig","createDoctorCommand","report","runDiagnostics","displayReport","runAutoFixes","fixMcp","runMcpAutoFix","_options","cliVersion","pkg","checkNodeVersion","checkCliInstallation","checkGlobalDirectory","checkAuthentication","checkWorkspace","checkMcpTools","checkGitIntegration","checkNetworkConnectivity","nodeVersion","arch","major","npmPrefix","npm_config_prefix","pathDirs","PATH","snapInPath","globalDir","validationIssues","hookPath","hookContent","apiUrl","getStatusIcon","getStatusColor","fixable","createUndoCommand","execAsync","PACKAGE_NAME","NPM_REGISTRY","createUpgradeCommand","versionInfo","getVersionInfo","canary","latest","updateAvailable","performUpgrade","altPkgPath","tag","compareVersions","partsA","partsB","partA","partB","supportsHyperlinks","forceHyperlinks","FORCE_HYPERLINK","TERM_PROGRAM","VTE_VERSION","COLORTERM","CI","WT_SESSION","KITTY_WINDOW_ID","WEZTERM_PANE","link","fallback","fileLink","displayPath","docsLink","issueLink","issueNumber","commandLink","labeledLink","learnMore","reportIssue","hyperlink","docs","labeled","LOGO_LARGE","LOGO_COMPACT","LOGO_MINIMAL","getLogo","terminalWidth","columns","displayBrandedHeader","showTagline","logo","coloredLogo","detectProjectType","tokenPath","isWorkspaceInitialized","welcomeStep","authenticationStep","authenticated","authMethod","confirmed","workspaceStep","projectName","isConfigCorrupted","repair","projectType","protectionLevel","protectionStep","mcpStep","enableMcp","mcpEnabled","statusIcon","fileProtectionStep","gitHookStep","gitHookInstalled","gitDir","installHook","hooksDir","existingContent","snapbackHook","chmodSync","snapshotStep","snapshotCreated","analyticsStep","enableAnalytics","analyticsEnabled","summaryStep","hasVSCode","stepNum","sessionStep","runWizard","runAgain","snapbackHome","createWizardCommand","DEFAULT_STATS","risksDetected","highRiskAverted","currentStreak","longestStreak","totalDaysActive","sharesGenerated","shareClicks","DEFAULT_PREFERENCES","verbosity","colorScheme","showAchievements","showProgress","defaultSnapshot","includeNodeModules","includeGitIgnored","createDefaultPioneerState","pioneerNumber","generatePioneerNumber","totalPoints","unlockedAchievements","lastActiveDate","rand","SCHEMA","StateManager","conf","Conf","projectVersion","defaults","preferences","migrations","getPioneerState","savePioneerState","getPreferences","setPreferences","prefs","getPath","isFirstRun","export","import","userState","KNOWN_COMMANDS","levenshteinDistance","matrix","j","findSimilarCommands","maxSuggestions","inputLower","distance","displayUnknownCommandError","engineAdapter","getAllFiles","createCLI","program","alias","addCommand","hook","_thisCommand","unknownCommand","riskData","createSnapshotStorage","snaps","search","term","interactiveAnalyze","interactiveSnapshot","interactiveList","filesToCheck","allFiles","fileResults","hasRiskyChanges","mediumRisk","snapshotSpinner","filtered","answers","createSnapshotPrompt","includeFiles","checkbox","smartRouter","argv","statusCommand","parseAsync","href"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * SnapBack Simplified Architecture - Event System\n *\n * This replaces the 127+ events across 3 systems with ~15 focused events.\n *\n * Design principles:\n * 1. Each event has a clear purpose\n * 2. No duplicate/overlapping events\n * 3. Minimal properties (only what's needed)\n * 4. Privacy-safe (no file paths, content, or PII)\n *\n * Target: ~50 LOC\n *\n * SOURCE REFERENCE:\n * - packages/contracts/src/events/core.ts (7 events we're simplifying)\n * - packages/contracts/src/events/infrastructure.ts (DELETE - over-engineered)\n * - packages/contracts/src/events/legacy.ts (DELETE - deprecated)\n */\n\nimport { EventEmitter } from \"node:events\";\n\n// =============================================================================\n// EVENT DEFINITIONS (~15 events total)\n// =============================================================================\n\n/**\n * All SnapBack events with their payload types\n *\n * Naming convention: domain.action (e.g., \"session.started\")\n */\nexport interface SnapBackEvents {\n\t// -------------------------------------------------------------------------\n\t// Session Events (4)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when a coding session starts */\n\t\"session.started\": {\n\t\tsessionId: string;\n\t\tworkspaceHash: string; // Hashed workspace path for privacy\n\t};\n\n\t/** Emitted when a session ends */\n\t\"session.ended\": {\n\t\tsessionId: string;\n\t\tduration: number; // milliseconds\n\t\tfilesModified: number; // count only, not paths\n\t\tsnapshotsCreated: number;\n\t};\n\n\t/** Emitted when session health changes significantly */\n\t\"session.health_changed\": {\n\t\tsessionId: string;\n\t\tpreviousScore: number;\n\t\tcurrentScore: number;\n\t\ttrigger: string; // what caused the change\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// File Events (2)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when a file is modified (privacy-safe, no content) */\n\t\"file.changed\": {\n\t\tchangeType: \"add\" | \"modify\" | \"delete\";\n\t\textension: string; // \".ts\", \".js\", etc.\n\t\tlineCount: number;\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// Snapshot Events (2)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when a snapshot is created */\n\t\"snapshot.created\": {\n\t\tsnapshotId: string;\n\t\tfileCount: number;\n\t\ttotalBytes: number;\n\t\ttrigger: \"manual\" | \"auto\" | \"risk\";\n\t\triskScore: number;\n\t};\n\n\t/** Emitted when a snapshot is restored */\n\t\"snapshot.restored\": {\n\t\tsnapshotId: string;\n\t\tfilesRestored: number;\n\t\tduration: number;\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// Risk & Validation Events (5)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when a burst of rapid changes is detected (AI paste detection) */\n\t\"burst.detected\": {\n\t\tvelocity: number; // chars per millisecond\n\t\tcharCount: number;\n\t\tfileExtension: string; // e.g., \".ts\", \".js\"\n\t};\n\n\t/** Emitted when AI tool usage is detected */\n\t\"ai.detected\": {\n\t\ttool: string; // e.g., \"copilot\", \"cursor\"\n\t\tconfidence: number; // 0-1\n\t\tmethod: \"extension\" | \"velocity\" | \"pattern\" | \"combined\";\n\t};\n\n\t/** Emitted when risk is analyzed */\n\t\"risk.analyzed\": {\n\t\tscore: number; // 0-10\n\t\tfactorCount: number;\n\t\tthreatCount: number;\n\t};\n\n\t/** Emitted when validation passes */\n\t\"validation.passed\": {\n\t\tvalidator: string; // \"types\", \"cycles\", etc.\n\t\tduration: number;\n\t};\n\n\t/** Emitted when validation fails */\n\t\"validation.failed\": {\n\t\tvalidator: string;\n\t\terrorCount: number;\n\t\tduration: number;\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// Protection Events (1)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when protection level changes */\n\t\"protection.changed\": {\n\t\tfrom: string;\n\t\tto: string;\n\t\tsource: \"user\" | \"auto\" | \"policy\";\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// Error Events (1)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when an error occurs */\n\t\"error.occurred\": {\n\t\tcomponent: string; // \"orchestrator\", \"storage\", etc.\n\t\tmessage: string;\n\t\trecoverable: boolean;\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// Auth Events (1)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when authentication completes */\n\t\"auth.completed\": {\n\t\tprovider: \"github\" | \"google\" | \"email\";\n\t\tsuccess: boolean;\n\t};\n\n\t// -------------------------------------------------------------------------\n\t// Feedback Events (1)\n\t// -------------------------------------------------------------------------\n\n\t/** Emitted when user feedback is collected on AI detection */\n\t\"feedback.collected\": {\n\t\tdetectionId: string;\n\t\tverdict: \"false_positive\" | \"implicit_true_positive\";\n\t\tconfidence: number; // 0-1, model's original confidence\n\t\treason?: string; // \"manual\", \"docs\", \"refactor\", \"clipboard\"\n\t\tdurationMs: number; // time from detection to feedback\n\t};\n}\n\n// =============================================================================\n// EVENT BUS IMPLEMENTATION\n// =============================================================================\n\n/**\n * Type-safe event emitter for SnapBack events\n *\n * Usage:\n *   eventBus.emit('session.started', { sessionId: '123', workspaceHash: 'abc' });\n *   eventBus.on('session.started', (payload) => console.log(payload.sessionId));\n */\nclass SnapBackEventBus extends EventEmitter {\n\t/**\n\t * Emit a typed event\n\t */\n\temit<K extends keyof SnapBackEvents>(event: K, payload: SnapBackEvents[K]): boolean {\n\t\t// Add timestamp to all events\n\t\tconst enrichedPayload = {\n\t\t\t...payload,\n\t\t\t_timestamp: Date.now(),\n\t\t\t_event: event,\n\t\t};\n\n\t\treturn super.emit(event, enrichedPayload);\n\t}\n\n\t/**\n\t * Listen for a typed event\n\t */\n\ton<K extends keyof SnapBackEvents>(event: K, listener: (payload: SnapBackEvents[K]) => void): this {\n\t\treturn super.on(event, listener);\n\t}\n\n\t/**\n\t * Listen for a typed event once\n\t */\n\tonce<K extends keyof SnapBackEvents>(event: K, listener: (payload: SnapBackEvents[K]) => void): this {\n\t\treturn super.once(event, listener);\n\t}\n}\n\n// =============================================================================\n// SINGLETON EXPORT\n// =============================================================================\n\n/**\n * Global event bus instance\n *\n * Import this in any file that needs to emit or listen for events.\n */\nexport const eventBus = new SnapBackEventBus();\n\n// =============================================================================\n// TELEMETRY INTEGRATION (Optional)\n// =============================================================================\n\n/**\n * Forward events to PostHog (if configured)\n *\n * This is the ONLY place where telemetry is sent.\n * All events are already privacy-safe by design.\n *\n * TODO: Implement PostHog integration\n *\n * Reference: packages/analytics/src/posthog.ts\n */\nexport function initTelemetry(_posthogKey?: string): void {\n\t// TODO: Initialize PostHog client\n\t// TODO: Subscribe to all events and forward to PostHog\n\t//\n\t// Implementation hint:\n\t// eventBus.on('session.started', (payload) => {\n\t//   posthog.capture('session_started', payload);\n\t// });\n}\n","/**\n * SnapBack Simplified Architecture - Orchestrator\n *\n * The orchestrator is the brain of the simplified architecture. It:\n * 1. Runs signal scripts in parallel to gather metrics\n * 2. Runs validator scripts to check code quality\n * 3. Aggregates results into a single decision (pass/warn/fail)\n * 4. Tracks session health for continuous coaching\n *\n * Target: ~150 LOC\n *\n * SOURCE REFERENCES:\n * - packages/core/src/risk-analyzer.ts (RiskAnalyzer class)\n * - apps/mcp-server/src/index.ts (tool handlers)\n * - scripts/validate-project.ts (script execution patterns)\n */\n\nimport { type ChildProcess, spawn } from \"node:child_process\";\nimport { dirname, join, resolve } from \"node:path\";\nimport type { FileChange, OrchestratorResult, SessionHealth, SignalOutput, ValidatorOutput } from \"../types\";\nimport { eventBus } from \"./events\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n/** Default timeout for script execution (30 seconds) */\nconst DEFAULT_TIMEOUT = 30_000;\n\n/**\n * Cached scripts directory - lazily evaluated to avoid import.meta.url at module load.\n * This prevents issues when bundled for CJS environments (VS Code extension).\n */\nlet _scriptsDir: string | null = null;\n\n/**\n * Get the scripts directory path (lazy evaluation).\n *\n * Uses multiple fallback strategies to find the engine package:\n * 1. ESM: import.meta.url (only evaluated when actually called)\n * 2. CJS: require.resolve for package location\n * 3. Fallback: process.cwd() with standard monorepo structure\n *\n * This avoids the bundler warning \"'import.meta is not available with cjs output format'\"\n * by only evaluating import.meta when this function is actually called at runtime.\n */\nfunction getScriptsDir(): string {\n\tif (_scriptsDir) return _scriptsDir;\n\n\t// Strategy 1: Try ESM import.meta (wrapped in try-catch for CJS environments)\n\ttry {\n\t\tif (typeof import.meta?.url === \"string\") {\n\t\t\t// Dynamic require to avoid bundler issues - fileURLToPath is sync\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-require-imports\n\t\t\tconst { fileURLToPath } = require(\"node:url\") as typeof import(\"node:url\");\n\t\t\tconst __filename = fileURLToPath(import.meta.url);\n\t\t\tconst __dirname = dirname(__filename);\n\t\t\t_scriptsDir = join(__dirname, \"..\");\n\t\t\treturn _scriptsDir;\n\t\t}\n\t} catch {\n\t\t// import.meta not available (CJS or bundled environment)\n\t}\n\n\t// Strategy 2: Try require.resolve (works in Node.js CJS)\n\ttry {\n\t\t// eslint-disable-next-line @typescript-eslint/no-require-imports\n\t\tconst pkgPath = require.resolve(\"@snapback/engine/package.json\");\n\t\t_scriptsDir = join(dirname(pkgPath), \"dist\");\n\t\treturn _scriptsDir;\n\t} catch {\n\t\t// Package not found via require.resolve\n\t}\n\n\t// Strategy 3: Fallback to process.cwd() with standard monorepo structure\n\t_scriptsDir = resolve(process.cwd(), \"packages/engine/dist\");\n\treturn _scriptsDir;\n}\n\n/** Signal scripts to run (in parallel) */\nconst SIGNAL_SCRIPTS = [\n\t\"signals/risk-score.ts\",\n\t\"signals/complexity.ts\",\n\t\"signals/cycles.ts\",\n\t\"signals/velocity.ts\",\n\t\"signals/consumers.ts\",\n\t\"signals/threats.ts\",\n\t\"signals/phantom-deps.ts\",\n];\n\n/** Validator scripts to run (in parallel) */\nconst VALIDATOR_SCRIPTS = [\n\t\"validators/types.ts\",\n\t\"validators/cycles.ts\",\n\t// TODO: Add more validators as implemented\n\t// 'validators/security.ts',\n\t// 'validators/patterns.ts',\n];\n\n// =============================================================================\n// SCRIPT RUNNER\n// =============================================================================\n\n/**\n * Run a single script and parse its JSON output\n *\n * @param scriptPath - Path to script relative to SCRIPTS_DIR\n * @param input - Input data to pass via stdin (as JSON)\n * @param timeout - Timeout in milliseconds\n * @returns Parsed JSON output from the script\n *\n * Implementation notes:\n * - Scripts are run with `npx tsx` for TypeScript support\n * - Input is passed via stdin as JSON\n * - Output is expected as JSON on stdout\n * - Non-zero exit code = failure\n */\nasync function runScript<T>(scriptPath: string, input: unknown, timeout: number = DEFAULT_TIMEOUT): Promise<T> {\n\tconst fullPath = join(getScriptsDir(), scriptPath);\n\tconst startTime = Date.now();\n\n\treturn new Promise((resolve, reject) => {\n\t\t// Spawn the script process\n\t\t// Using npx tsx for TypeScript execution\n\t\tconst proc: ChildProcess = spawn(\"npx\", [\"tsx\", fullPath], {\n\t\t\tstdio: [\"pipe\", \"pipe\", \"pipe\"],\n\t\t\ttimeout,\n\t\t\t// Pass workspace path via environment\n\t\t\tenv: {\n\t\t\t\t...process.env,\n\t\t\t\tSNAPBACK_WORKSPACE: process.cwd(),\n\t\t\t},\n\t\t});\n\n\t\tlet stdout = \"\";\n\t\tlet stderr = \"\";\n\n\t\t// Collect stdout\n\t\tproc.stdout?.on(\"data\", (data: Buffer) => {\n\t\t\tstdout += data.toString();\n\t\t});\n\n\t\t// Collect stderr (for debugging)\n\t\tproc.stderr?.on(\"data\", (data: Buffer) => {\n\t\t\tstderr += data.toString();\n\t\t});\n\n\t\t// Handle process completion\n\t\tproc.on(\"close\", (code: number | null) => {\n\t\t\tconst duration = Date.now() - startTime;\n\n\t\t\tif (code !== 0) {\n\t\t\t\t// Script failed\n\t\t\t\treject(\n\t\t\t\t\tnew Error(\n\t\t\t\t\t\t`Script ${scriptPath} failed with code ${code}\\n` + `stderr: ${stderr}\\n` + `stdout: ${stdout}`,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Parse JSON output\n\t\t\ttry {\n\t\t\t\tconst result = JSON.parse(stdout) as T;\n\t\t\t\t// Inject duration if the type supports it\n\t\t\t\tif (typeof result === \"object\" && result !== null) {\n\t\t\t\t\t(result as any).duration = duration;\n\t\t\t\t}\n\t\t\t\tresolve(result);\n\t\t\t} catch (parseError) {\n\t\t\t\treject(\n\t\t\t\t\tnew Error(\n\t\t\t\t\t\t`Script ${scriptPath} output is not valid JSON\\n` +\n\t\t\t\t\t\t\t`stdout: ${stdout}\\n` +\n\t\t\t\t\t\t\t`Parse error: ${parseError}`,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\t// Handle process errors\n\t\tproc.on(\"error\", (error: Error) => {\n\t\t\treject(new Error(`Failed to start script ${scriptPath}: ${error.message}`));\n\t\t});\n\n\t\t// Write input to stdin and close it\n\t\tif (proc.stdin) {\n\t\t\tproc.stdin.write(JSON.stringify(input));\n\t\t\tproc.stdin.end();\n\t\t}\n\t});\n}\n\n// =============================================================================\n// ORCHESTRATOR CLASS\n// =============================================================================\n\n/**\n * Main orchestrator class\n *\n * Usage:\n *   const orchestrator = new Orchestrator();\n *   const result = await orchestrator.analyze(fileChanges);\n *   if (result.outcome === 'fail') {\n *     // Block the change, return errors to agent\n *   }\n */\n/**\n * Signal weights for weighted risk aggregation\n * Higher weight = more impact on final risk score\n */\nconst SIGNAL_WEIGHTS: Record<string, number> = {\n\t\"risk-score\": 1.0, // Primary risk indicator - use directly\n\tcycles: 2.5, // Circular dependencies are severe\n\tcomplexity: 1.5, // Complexity impacts maintainability\n\tthreats: 2.0, // Security threats are critical\n\t\"phantom-deps\": 1.8, // Missing deps cause runtime errors\n\tvelocity: 0.5, // Velocity is informational\n\tconsumers: 0.3, // Consumer count is informational\n};\n\n/**\n * Hash a string to a consistent short identifier\n */\nfunction hashString(str: string): string {\n\tlet hash = 0;\n\tfor (let i = 0; i < str.length; i++) {\n\t\tconst char = str.charCodeAt(i);\n\t\thash = (hash << 5) - hash + char;\n\t\thash = hash & hash; // Convert to 32bit integer\n\t}\n\treturn Math.abs(hash).toString(36).slice(0, 8);\n}\n\nexport class Orchestrator {\n\tprivate sessionHealth: SessionHealth;\n\tprivate sessionId: string;\n\tprivate previousScore: number;\n\tprivate workspaceRoot: string;\n\n\tconstructor(workspaceRoot?: string) {\n\t\tthis.workspaceRoot = workspaceRoot || process.cwd();\n\t\tthis.sessionId = `session_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;\n\t\tthis.previousScore = 100;\n\n\t\t// Initialize with healthy baseline\n\t\tthis.sessionHealth = {\n\t\t\tscore: 100,\n\t\t\twarnings: [],\n\t\t\tsuggestions: [],\n\t\t\tfilesModified: [],\n\t\t\tcyclesIntroduced: 0,\n\t\t\tcomplexityDelta: 0,\n\t\t};\n\t}\n\n\t/**\n\t * Analyze file changes and determine outcome\n\t *\n\t * This is the main entry point. It:\n\t * 1. Runs all signal scripts in parallel\n\t * 2. Runs all validator scripts in parallel\n\t * 3. Aggregates results\n\t * 4. Updates session health\n\t * 5. Returns combined outcome\n\t *\n\t * @param fileChanges - Array of file changes to analyze\n\t * @returns Orchestrator result with outcome and details\n\t */\n\tasync analyze(fileChanges: FileChange[]): Promise<OrchestratorResult> {\n\t\tconst startTime = Date.now();\n\n\t\t// Prepare input for scripts\n\t\tconst input = {\n\t\t\tfiles: fileChanges,\n\t\t\tworkspace: process.cwd(),\n\t\t\ttimestamp: Date.now(),\n\t\t};\n\n\t\t// Run signals and validators in parallel\n\t\tconst [signals, validators] = await Promise.all([this.runSignals(input), this.runValidators(input)]);\n\n\t\t// Calculate aggregated risk score\n\t\tconst riskScore = this.calculateRiskScore(signals);\n\n\t\t// Determine outcome based on validators\n\t\tconst outcome = this.determineOutcome(validators, riskScore);\n\n\t\t// Update session health\n\t\tthis.updateSessionHealth(signals, validators, fileChanges);\n\n\t\t// Emit events\n\t\teventBus.emit(\"risk.analyzed\", {\n\t\t\tscore: riskScore,\n\t\t\tfactorCount: signals.length,\n\t\t\tthreatCount: signals.filter((s) => s.signal === \"threats\").length,\n\t\t});\n\n\t\tconst duration = Date.now() - startTime;\n\n\t\treturn {\n\t\t\toutcome,\n\t\t\tsignals,\n\t\t\tvalidators,\n\t\t\triskScore,\n\t\t\thealth: this.sessionHealth,\n\t\t\tduration,\n\t\t};\n\t}\n\n\t/**\n\t * Run all signal scripts in parallel\n\t */\n\tprivate async runSignals(input: unknown): Promise<SignalOutput[]> {\n\t\tconst results = await Promise.allSettled(\n\t\t\tSIGNAL_SCRIPTS.map((script) => runScript<SignalOutput>(script, input)),\n\t\t);\n\n\t\t// Collect successful results, log failures\n\t\tconst signals: SignalOutput[] = [];\n\t\tfor (let i = 0; i < results.length; i++) {\n\t\t\tconst result = results[i];\n\t\t\tif (result.status === \"fulfilled\") {\n\t\t\t\tsignals.push(result.value);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`Signal script ${SIGNAL_SCRIPTS[i]} failed:`, result.reason);\n\t\t\t\t// Emit error event\n\t\t\t\teventBus.emit(\"error.occurred\", {\n\t\t\t\t\tcomponent: \"orchestrator\",\n\t\t\t\t\tmessage: `Signal ${SIGNAL_SCRIPTS[i]} failed: ${result.reason}`,\n\t\t\t\t\trecoverable: true,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn signals;\n\t}\n\n\t/**\n\t * Run all validator scripts in parallel\n\t */\n\tprivate async runValidators(input: unknown): Promise<ValidatorOutput[]> {\n\t\tconst results = await Promise.allSettled(\n\t\t\tVALIDATOR_SCRIPTS.map((script) => runScript<ValidatorOutput>(script, input)),\n\t\t);\n\n\t\t// Collect results\n\t\tconst validators: ValidatorOutput[] = [];\n\t\tfor (let i = 0; i < results.length; i++) {\n\t\t\tconst result = results[i];\n\t\t\tif (result.status === \"fulfilled\") {\n\t\t\t\tvalidators.push(result.value);\n\n\t\t\t\t// Emit validation events\n\t\t\t\tif (result.value.status === \"pass\") {\n\t\t\t\t\teventBus.emit(\"validation.passed\", {\n\t\t\t\t\t\tvalidator: result.value.validator,\n\t\t\t\t\t\tduration: result.value.duration || 0,\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\teventBus.emit(\"validation.failed\", {\n\t\t\t\t\t\tvalidator: result.value.validator,\n\t\t\t\t\t\terrorCount: result.value.errors?.length || 0,\n\t\t\t\t\t\tduration: result.value.duration || 0,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.warn(`Validator script ${VALIDATOR_SCRIPTS[i]} failed:`, result.reason);\n\t\t\t\t// Treat script failure as validation failure\n\t\t\t\tvalidators.push({\n\t\t\t\t\tvalidator: VALIDATOR_SCRIPTS[i],\n\t\t\t\t\tstatus: \"fail\",\n\t\t\t\t\terrors: [{ message: `Script execution failed: ${result.reason}` }],\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn validators;\n\t}\n\n\t/**\n\t * Calculate aggregated risk score from signals using weighted aggregation\n\t *\n\t * Algorithm (from risk-analyzer.ts):\n\t * 1. If direct risk-score signal exists, use it as base\n\t * 2. Apply weighted contributions from other signals\n\t * 3. Normalize to 0-10 scale\n\t */\n\tprivate calculateRiskScore(signals: SignalOutput[]): number {\n\t\t// Find the risk-score signal as base\n\t\tconst riskSignal = signals.find((s) => s.signal === \"risk-score\");\n\t\tlet baseScore = riskSignal?.value ?? 0;\n\n\t\t// Apply weighted aggregation from other signals\n\t\tlet weightedSum = 0;\n\t\tlet totalWeight = 0;\n\n\t\tfor (const signal of signals) {\n\t\t\t// Skip risk-score as it's our base\n\t\t\tif (signal.signal === \"risk-score\") continue;\n\n\t\t\tconst weight = SIGNAL_WEIGHTS[signal.signal] ?? 1.0;\n\t\t\tweightedSum += signal.value * weight;\n\t\t\ttotalWeight += weight;\n\t\t}\n\n\t\t// Combine base score with weighted contributions\n\t\tif (totalWeight > 0) {\n\t\t\tconst weightedContribution = weightedSum / totalWeight;\n\t\t\t// Base score contributes 60%, weighted signals contribute 40%\n\t\t\tbaseScore = baseScore * 0.6 + weightedContribution * 0.4;\n\t\t}\n\n\t\t// Normalize to 0-10 scale, rounding to 1 decimal\n\t\treturn Math.round(Math.min(10, Math.max(0, baseScore)) * 10) / 10;\n\t}\n\n\t/**\n\t * Determine final outcome based on validators and risk score\n\t */\n\tprivate determineOutcome(validators: ValidatorOutput[], riskScore: number): \"pass\" | \"warn\" | \"fail\" {\n\t\t// Any validator failure = fail\n\t\tconst hasFailure = validators.some((v) => v.status === \"fail\");\n\t\tif (hasFailure) {\n\t\t\treturn \"fail\";\n\t\t}\n\n\t\t// High risk score = warn (but allow)\n\t\tif (riskScore > 7) {\n\t\t\treturn \"warn\";\n\t\t}\n\n\t\treturn \"pass\";\n\t}\n\n\t/**\n\t * Update session health based on analysis results\n\t *\n\t * This is what enables \"coaching\" - the agent sees health trends over time.\n\t */\n\tprivate updateSessionHealth(\n\t\tsignals: SignalOutput[],\n\t\tvalidators: ValidatorOutput[],\n\t\tfileChanges: FileChange[],\n\t): void {\n\t\t// Track files modified\n\t\tfor (const change of fileChanges) {\n\t\t\tif (!this.sessionHealth.filesModified.includes(change.path)) {\n\t\t\t\tthis.sessionHealth.filesModified.push(change.path);\n\t\t\t}\n\t\t}\n\n\t\t// Check for cycles signal\n\t\tconst cyclesSignal = signals.find((s) => s.signal === \"cycles\");\n\t\tif (cyclesSignal && cyclesSignal.value > 0) {\n\t\t\tthis.sessionHealth.cyclesIntroduced = cyclesSignal.value;\n\t\t\tthis.sessionHealth.warnings.push(` ${cyclesSignal.value} circular dependencies detected`);\n\t\t}\n\n\t\t// Check for complexity signal\n\t\tconst complexitySignal = signals.find((s) => s.signal === \"complexity\");\n\t\tif (complexitySignal) {\n\t\t\tthis.sessionHealth.complexityDelta = complexitySignal.value;\n\t\t\tif (complexitySignal.value > 0.3) {\n\t\t\t\tthis.sessionHealth.warnings.push(\n\t\t\t\t\t` Complexity increased by ${Math.round(complexitySignal.value * 100)}%`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// Add suggestions from failed validators\n\t\tfor (const v of validators) {\n\t\t\tif (v.status === \"fail\" && v.suggestion) {\n\t\t\t\tthis.sessionHealth.suggestions.push(v.suggestion);\n\t\t\t}\n\t\t}\n\n\t\t// Keep only recent warnings/suggestions\n\t\tthis.sessionHealth.warnings = this.sessionHealth.warnings.slice(-3);\n\t\tthis.sessionHealth.suggestions = this.sessionHealth.suggestions.slice(-2);\n\n\t\t// Calculate health score\n\t\tlet score = 100;\n\t\tscore -= this.sessionHealth.cyclesIntroduced * 15;\n\t\tscore -= this.sessionHealth.warnings.length * 5;\n\t\tscore -= Math.max(0, this.sessionHealth.complexityDelta) * 20;\n\t\tscore -= validators.filter((v) => v.status === \"fail\").length * 10;\n\t\tthis.sessionHealth.score = Math.max(0, score);\n\n\t\t// Generate coaching message based on score\n\t\tthis.sessionHealth.coaching = this.generateCoaching();\n\n\t\t// Emit health change event if score changed significantly (>5 points)\n\t\tconst scoreDelta = Math.abs(this.sessionHealth.score - this.previousScore);\n\t\tif (scoreDelta >= 5) {\n\t\t\teventBus.emit(\"session.health_changed\", {\n\t\t\t\tsessionId: this.sessionId,\n\t\t\t\tpreviousScore: this.previousScore,\n\t\t\t\tcurrentScore: this.sessionHealth.score,\n\t\t\t\ttrigger: \"analysis\",\n\t\t\t});\n\t\t}\n\n\t\t// Update previous score for next comparison\n\t\tthis.previousScore = this.sessionHealth.score;\n\t}\n\n\t/**\n\t * Generate coaching message based on health score\n\t */\n\tprivate generateCoaching(): string {\n\t\tconst { score, warnings, suggestions } = this.sessionHealth;\n\n\t\tif (score >= 90) {\n\t\t\treturn \"\"; // No coaching needed\n\t\t}\n\n\t\tif (score >= 70) {\n\t\t\treturn `Note: ${warnings[0] || \"Minor issues detected\"}`;\n\t\t}\n\n\t\tif (score >= 50) {\n\t\t\treturn ` Session health declining (${score}/100). ` + `Please address: ${warnings.join(\", \")}`;\n\t\t}\n\n\t\treturn (\n\t\t\t` STOP: Session health critical (${score}/100). ` +\n\t\t\t`You have introduced ${this.sessionHealth.cyclesIntroduced} cycles. ` +\n\t\t\t`Recommended: ${suggestions[0] || \"Review recent changes\"}`\n\t\t);\n\t}\n\n\t/**\n\t * Get current session health (for injection into MCP responses)\n\t */\n\tgetHealth(): SessionHealth {\n\t\treturn { ...this.sessionHealth };\n\t}\n\n\t/**\n\t * Reset session health (for new session)\n\t */\n\tresetSession(): void {\n\t\t// Generate new session ID\n\t\tthis.sessionId = `session_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;\n\t\tthis.previousScore = 100;\n\n\t\tthis.sessionHealth = {\n\t\t\tscore: 100,\n\t\t\twarnings: [],\n\t\t\tsuggestions: [],\n\t\t\tfilesModified: [],\n\t\t\tcyclesIntroduced: 0,\n\t\t\tcomplexityDelta: 0,\n\t\t};\n\n\t\teventBus.emit(\"session.started\", {\n\t\t\tsessionId: this.sessionId,\n\t\t\tworkspaceHash: hashString(this.workspaceRoot),\n\t\t});\n\t}\n\n\t/**\n\t * Get current session ID\n\t */\n\tgetSessionId(): string {\n\t\treturn this.sessionId;\n\t}\n}\n\n// =============================================================================\n// SINGLETON EXPORT\n// =============================================================================\n\n/**\n * Global orchestrator instance\n *\n * Import this in transports (MCP, CLI, HTTP) to analyze changes.\n */\nexport const orchestrator = new Orchestrator();\n","/**\n * Shared Transport Constants and Utilities\n *\n * Single source of truth for risk thresholds and classification\n * used across all transport adapters (CLI, MCP, HTTP).\n */\n\n// ============================================================================\n// Risk Level Thresholds\n// ============================================================================\n\n/**\n * Score thresholds for risk classification.\n * Used by all transport adapters to convert numeric scores to risk levels.\n *\n * | Score Range | Level    |\n * |-------------|----------|\n * | 0-1         | safe     |\n * | 2-3         | low      |\n * | 4-5         | medium   |\n * | 6-7         | high     |\n * | 8+          | critical |\n */\nexport const RISK_THRESHOLDS = {\n\tsafe: 1,\n\tlow: 3,\n\tmedium: 5,\n\thigh: 7,\n} as const;\n\n/**\n * Exit code threshold for CLI - scores above this return exit code 1\n */\nexport const HIGH_RISK_EXIT_THRESHOLD = 5;\n\n// ============================================================================\n// Risk Level Types\n// ============================================================================\n\n/** Possible risk levels returned by analysis */\nexport type RiskLevel = \"safe\" | \"low\" | \"medium\" | \"high\" | \"critical\";\n\n// ============================================================================\n// Risk Level Utilities\n// ============================================================================\n\n/**\n * Convert a numeric risk score to a risk level string.\n *\n * @param score - Numeric risk score (0-10+)\n * @returns Risk level classification\n *\n * @example\n * scoreToRiskLevel(0)  // => \"safe\"\n * scoreToRiskLevel(2)  // => \"low\"\n * scoreToRiskLevel(4)  // => \"medium\"\n * scoreToRiskLevel(6)  // => \"high\"\n * scoreToRiskLevel(8)  // => \"critical\"\n */\nexport function scoreToRiskLevel(score: number): RiskLevel {\n\tif (score <= RISK_THRESHOLDS.safe) {\n\t\treturn \"safe\";\n\t}\n\tif (score <= RISK_THRESHOLDS.low) {\n\t\treturn \"low\";\n\t}\n\tif (score <= RISK_THRESHOLDS.medium) {\n\t\treturn \"medium\";\n\t}\n\tif (score <= RISK_THRESHOLDS.high) {\n\t\treturn \"high\";\n\t}\n\treturn \"critical\";\n}\n\n/**\n * Check if a risk score exceeds the high-risk threshold.\n * Used by CLI to determine exit code.\n *\n * @param score - Numeric risk score\n * @returns true if score exceeds high-risk threshold\n */\nexport function isHighRisk(score: number): boolean {\n\treturn score > HIGH_RISK_EXIT_THRESHOLD;\n}\n\n/**\n * Get the appropriate exit code for a risk score.\n * Returns 1 for high-risk scores, 0 otherwise.\n *\n * @param score - Numeric risk score\n * @returns Exit code (0 or 1)\n */\nexport function getExitCode(score: number): 0 | 1 {\n\treturn isHighRisk(score) ? 1 : 0;\n}\n","/**\n * CLI Transport Adapter\n *\n * Bridges the SnapBack engine with CLI tools (apps/cli).\n * Converts file inputs  engine format  CLI-friendly output.\n *\n * Target: ~150 LOC | Source: apps/cli/src/index.ts\n */\n\nimport { orchestrator } from \"../runtime/orchestrator.js\";\nimport type { FileChange, SessionHealth } from \"../types.js\";\nimport { getExitCode, isHighRisk, type RiskLevel, scoreToRiskLevel } from \"./shared.js\";\n\n//  CLI Input Types \n\n/** File input for CLI analysis */\nexport interface CLIFileInput {\n\tpath: string;\n\tcontent?: string;\n}\n\n/** CLI analysis request */\nexport interface CLIInput {\n\tfiles: CLIFileInput[];\n\tformat: \"text\" | \"json\" | \"sarif\";\n\tquiet?: boolean;\n}\n\n//  CLI Output Types \n\n/** CLI analysis result */\nexport interface CLIOutput {\n\texitCode: number;\n\toutput: string;\n\triskScore: number;\n\triskLevel: RiskLevel;\n\terror?: string;\n}\n\n//  CLI Engine Adapter \n\n/**\n * Adapter bridging CLI tool calls to the SnapBack engine.\n *\n * @example\n * import { CLIEngineAdapter } from '@snapback/engine/transports/cli';\n * const adapter = new CLIEngineAdapter();\n * const result = await adapter.analyze({ files, format: 'text' });\n * process.exit(result.exitCode);\n */\nexport class CLIEngineAdapter {\n\t/** Analyze files and return CLI-formatted output */\n\tasync analyze(input: CLIInput): Promise<CLIOutput> {\n\t\t// Input validation\n\t\tif (!input || typeof input !== \"object\") {\n\t\t\treturn this.errorResult(\"Invalid input: expected object with files array\");\n\t\t}\n\t\tif (!Array.isArray(input.files)) {\n\t\t\treturn this.errorResult(\"Invalid input: files must be an array\");\n\t\t}\n\t\tif (input.files.length === 0) {\n\t\t\treturn this.emptyResult(input.format);\n\t\t}\n\n\t\ttry {\n\t\t\tconst fileChanges = this.toFileChanges(input.files);\n\t\t\tconst result = await orchestrator.analyze(fileChanges);\n\n\t\t\t// Calculate effective score (max of aggregated and threat signal)\n\t\t\tconst threatScore = result.signals.find((s) => s.signal === \"threats\")?.value || 0;\n\t\t\tconst effectiveScore = Math.max(result.riskScore, threatScore);\n\t\t\tconst riskLevel = scoreToRiskLevel(effectiveScore);\n\t\t\tconst exitCode = getExitCode(effectiveScore);\n\n\t\t\treturn {\n\t\t\t\texitCode,\n\t\t\t\toutput: this.formatOutput(effectiveScore, riskLevel, result, input),\n\t\t\t\triskScore: effectiveScore,\n\t\t\t\triskLevel,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn this.errorResult(error instanceof Error ? error.message : \"Unknown error\");\n\t\t}\n\t}\n\n\tresetSession(): void {\n\t\torchestrator.resetSession();\n\t}\n\n\tgetSessionHealth(): SessionHealth {\n\t\treturn orchestrator.getHealth();\n\t}\n\n\t//  Private Helpers \n\n\tprivate toFileChanges(files: CLIFileInput[]): FileChange[] {\n\t\treturn files\n\t\t\t.filter((f) => f.path)\n\t\t\t.map((f) => ({\n\t\t\t\tpath: f.path,\n\t\t\t\tcontent: f.content || \"\",\n\t\t\t\tlineCount: f.content?.split(\"\\n\").length ?? 0,\n\t\t\t\tchangeType: \"modify\" as const,\n\t\t\t}));\n\t}\n\n\tprivate formatOutput(\n\t\tscore: number,\n\t\tlevel: string,\n\t\tresult: { signals: Array<{ signal: string; value: number }>; health: SessionHealth },\n\t\tinput: CLIInput,\n\t): string {\n\t\tif (input.quiet && !isHighRisk(score)) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\tswitch (input.format) {\n\t\t\tcase \"json\":\n\t\t\t\treturn JSON.stringify({\n\t\t\t\t\triskScore: score,\n\t\t\t\t\triskLevel: level,\n\t\t\t\t\tsignals: result.signals.filter((s) => s.value > 0),\n\t\t\t\t\tsession: result.health,\n\t\t\t\t});\n\t\t\tcase \"sarif\":\n\t\t\t\treturn this.toSARIF(score, level, result.signals);\n\t\t\tdefault:\n\t\t\t\treturn this.toText(score, level, result.signals);\n\t\t}\n\t}\n\n\tprivate toText(score: number, level: string, signals: Array<{ signal: string; value: number }>): string {\n\t\tconst lines = [`Risk Level: ${level.toUpperCase()} (${score.toFixed(1)}/10)`];\n\t\tconst activeSignals = signals.filter((s) => s.value > 0);\n\t\tif (activeSignals.length > 0) {\n\t\t\tlines.push(\"Signals:\");\n\t\t\tfor (const s of activeSignals) {\n\t\t\t\tlines.push(`  - ${s.signal}: ${s.value.toFixed(1)}`);\n\t\t\t}\n\t\t}\n\t\treturn lines.join(\"\\n\");\n\t}\n\n\tprivate toSARIF(_score: number, _level: string, signals: Array<{ signal: string; value: number }>): string {\n\t\treturn JSON.stringify({\n\t\t\tversion: \"2.1.0\",\n\t\t\t$schema: \"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json\",\n\t\t\truns: [\n\t\t\t\t{\n\t\t\t\t\ttool: { driver: { name: \"snapback-engine\", version: \"0.1.0\" } },\n\t\t\t\t\tresults: signals\n\t\t\t\t\t\t.filter((s) => s.value > 0)\n\t\t\t\t\t\t.map((s) => ({\n\t\t\t\t\t\t\truleId: s.signal,\n\t\t\t\t\t\t\tlevel: s.value > 5 ? \"error\" : \"warning\",\n\t\t\t\t\t\t\tmessage: { text: `${s.signal}: score ${s.value.toFixed(1)}` },\n\t\t\t\t\t\t})),\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\t}\n\n\tprivate emptyResult(format: string): CLIOutput {\n\t\tconst output = format === \"json\" ? '{\"riskScore\":0,\"riskLevel\":\"safe\"}' : \"No files to analyze\";\n\t\treturn { exitCode: 0, output, riskScore: 0, riskLevel: \"safe\" };\n\t}\n\n\tprivate errorResult(error: string): CLIOutput {\n\t\treturn { exitCode: 1, output: `Error: ${error}`, riskScore: 0, riskLevel: \"safe\", error };\n\t}\n}\n","/**\n * Authentication Commands\n *\n * Implements snap login/logout/whoami with multiple auth strategies\n * for minimal friction user experience.\n *\n * Auth Methods (in priority order):\n * 1. --api-key: Direct API key auth (CI/CD, onboarding quick-start)\n * 2. --browser: Browser OAuth with local callback server\n * 3. Default: Device code flow (works everywhere, including SSH/headless)\n *\n * Device Code Flow (RFC 8628) - Default:\n * 1. snap login  Displays user code and verification URL\n * 2. User visits URL on any device and enters code\n * 3. CLI polls for authorization completion\n * 4. Credentials stored in ~/.snapback/credentials.json\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport { createServer, type IncomingMessage, type ServerResponse } from \"node:http\";\nimport { hostname, platform, userInfo } from \"node:os\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport ora from \"ora\";\n\nimport {\n\tclearCredentials,\n\tcreateGlobalDirectory,\n\ttype GlobalCredentials,\n\tgetCredentials,\n\tisLoggedIn,\n\tsaveCredentials,\n} from \"../services/snapback-dir\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\nconst DEFAULT_API_URL = process.env.SNAPBACK_API_URL || \"https://api.snapback.dev\";\n// Better Auth endpoints are on the web console, not the API\nconst BETTER_AUTH_URL = process.env.SNAPBACK_WEB_URL || \"https://console.snapback.dev\";\nconst AUTH_CALLBACK_PORT = 51234;\nconst AUTH_TIMEOUT_MS = 120000; // 2 minutes\nconst TOKEN_REFRESH_THRESHOLD_MS = 5 * 60 * 1000; // Refresh 5 minutes before expiry\n\n// =============================================================================\n// COMMAND DEFINITIONS\n// =============================================================================\n\n/**\n * Create the login command\n *\n * Default: Device code flow (works everywhere, including remote/headless)\n * --browser: Open browser for OAuth (convenient on local machines)\n * --api-key: Use API key directly (CI/CD, onboarding quick-start)\n */\nexport function createLoginCommand(): Command {\n\treturn new Command(\"login\")\n\t\t.description(\"Login to SnapBack\")\n\t\t.option(\"--api-key <key>\", \"Use API key directly (CI/CD, onboarding)\")\n\t\t.option(\"--browser\", \"Open browser for OAuth instead of device code\")\n\t\t.action(async (options) => {\n\t\t\ttry {\n\t\t\t\tif (options.apiKey) {\n\t\t\t\t\tawait loginWithApiKey(options.apiKey);\n\t\t\t\t} else if (options.browser) {\n\t\t\t\t\tawait loginWithBrowser();\n\t\t\t\t} else {\n\t\t\t\t\t// Default: Device code flow (works everywhere)\n\t\t\t\t\tawait loginWithDeviceCode();\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Login failed:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n}\n\n/**\n * Create the logout command\n */\nexport function createLogoutCommand(): Command {\n\treturn new Command(\"logout\").description(\"Logout from SnapBack\").action(async () => {\n\t\tconst spinner = ora(\"Logging out...\").start();\n\n\t\ttry {\n\t\t\tconst wasLoggedIn = await isLoggedIn();\n\t\t\tawait clearCredentials();\n\n\t\t\tif (wasLoggedIn) {\n\t\t\t\tspinner.succeed(\"Logged out successfully\");\n\t\t\t} else {\n\t\t\t\tspinner.info(\"You were not logged in\");\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\tspinner.fail(\"Logout failed\");\n\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\tprocess.exit(1);\n\t\t}\n\t});\n}\n\n/**\n * Create the whoami command\n */\nexport function createWhoamiCommand(): Command {\n\treturn new Command(\"whoami\").description(\"Show current user\").action(async () => {\n\t\ttry {\n\t\t\tconst credentials = await getCredentials();\n\n\t\t\tif (!credentials) {\n\t\t\t\tconsole.log(chalk.yellow(\"Not logged in\"));\n\t\t\t\tconsole.log(chalk.gray(\"Run: snap login\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check if token is expired\n\t\t\tif (credentials.expiresAt) {\n\t\t\t\tconst expiresAt = new Date(credentials.expiresAt);\n\t\t\t\tif (expiresAt < new Date()) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"Session expired\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap login\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconsole.log(chalk.cyan(\"Logged in as:\"), credentials.email);\n\t\t\tconsole.log(chalk.cyan(\"Tier:\"), formatTier(credentials.tier));\n\n\t\t\tif (credentials.expiresAt) {\n\t\t\t\tconst expiresAt = new Date(credentials.expiresAt);\n\t\t\t\tconst now = new Date();\n\t\t\t\tconst hoursRemaining = Math.round((expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60));\n\n\t\t\t\tif (hoursRemaining < 24) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"Session expires:\"), `in ${hoursRemaining} hours`);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\tprocess.exit(1);\n\t\t}\n\t});\n}\n\n// =============================================================================\n// LOGIN METHODS\n// =============================================================================\n\n/**\n * Login with browser (recommended for local development)\n */\nasync function loginWithBrowser(): Promise<void> {\n\tconst spinner = ora(\"Preparing login...\").start();\n\n\ttry {\n\t\t// Create global directory if it doesn't exist\n\t\tawait createGlobalDirectory();\n\n\t\t// Start local callback server\n\t\tconst { url, waitForCallback } = await startCallbackServer();\n\n\t\t// Generate auth URL\n\t\tconst authUrl = `${DEFAULT_API_URL}/auth/cli?callback=${encodeURIComponent(url)}`;\n\n\t\tspinner.succeed(\"Ready to authenticate\");\n\t\tconsole.log();\n\t\tconsole.log(chalk.cyan(\"Opening browser for authentication...\"));\n\t\tconsole.log(chalk.gray(\"If browser doesn't open, visit:\"));\n\t\tconsole.log(chalk.underline(authUrl));\n\t\tconsole.log();\n\n\t\t// Try to open browser\n\t\tawait openBrowser(authUrl);\n\n\t\tspinner.start(\"Waiting for authentication...\");\n\n\t\t// Wait for callback with credentials\n\t\tconst credentials = await waitForCallback();\n\n\t\tspinner.succeed(\"Logged in successfully\");\n\t\tconsole.log();\n\t\tconsole.log(chalk.green(\"\"), \"Welcome,\", chalk.cyan(credentials.email));\n\t\tconsole.log(chalk.green(\"\"), \"Tier:\", formatTier(credentials.tier));\n\t} catch (error) {\n\t\tspinner.fail(\"Login failed\");\n\t\tthrow error;\n\t}\n}\n\n/**\n * Login with device code (for remote/headless environments)\n *\n * Uses RFC 8628 Device Authorization Grant via Better Auth.\n * User visits verification URL in any browser, enters code, and approves.\n */\nasync function loginWithDeviceCode(): Promise<void> {\n\tconst spinner = ora(\"Requesting device code...\").start();\n\n\ttry {\n\t\tawait createGlobalDirectory();\n\n\t\t// Request device code from Better Auth endpoint on web app\n\t\t// Better Auth's deviceAuthorization plugin handles RFC 8628 compliance\n\t\tconst response = await fetch(`${BETTER_AUTH_URL}/api/auth/device/code`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify({\n\t\t\t\tclient_id: \"snapback-cli\",\n\t\t\t\tscope: \"cli:snapshots api:read api:write\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst errorText = await response.text();\n\t\t\tthrow new Error(`Server returned ${response.status}: ${errorText}`);\n\t\t}\n\n\t\t// Better Auth returns RFC 8628 compliant response\n\t\tconst data = (await response.json()) as {\n\t\t\tdevice_code: string;\n\t\t\tuser_code: string;\n\t\t\tverification_uri: string;\n\t\t\tverification_uri_complete?: string;\n\t\t\texpires_in: number;\n\t\t\tinterval: number;\n\t\t};\n\n\t\tspinner.succeed(\"Device code received\");\n\t\tconsole.log();\n\t\tconsole.log(chalk.cyan(\"To complete login:\"));\n\t\tconsole.log();\n\t\tconsole.log(\"  1. Visit:\", chalk.underline(data.verification_uri));\n\t\tconsole.log(\"  2. Enter code:\", chalk.bold.yellow(data.user_code));\n\t\tconsole.log();\n\n\t\t// Try to open browser automatically if verification_uri_complete is provided\n\t\tif (data.verification_uri_complete) {\n\t\t\tawait openBrowser(data.verification_uri_complete);\n\t\t}\n\n\t\tspinner.start(\"Waiting for authorization...\");\n\n\t\t// Poll for token using Better Auth endpoint\n\t\tconst credentials = await pollForToken(data.device_code, data.interval, data.expires_in);\n\n\t\tspinner.succeed(\"Logged in successfully\");\n\t\tconsole.log();\n\t\tconsole.log(chalk.green(\"\"), \"Welcome,\", chalk.cyan(credentials.email));\n\t\tconsole.log(chalk.green(\"\"), \"Tier:\", formatTier(credentials.tier));\n\t} catch (error) {\n\t\tspinner.fail(\"Login failed\");\n\t\tthrow error;\n\t}\n}\n\n/**\n * Login with API key (for CI/CD)\n */\nasync function loginWithApiKey(apiKey: string): Promise<void> {\n\tconst spinner = ora(\"Validating API key...\").start();\n\n\ttry {\n\t\tawait createGlobalDirectory();\n\n\t\t// Validate API key with server\n\t\tconst response = await fetch(`${DEFAULT_API_URL}/auth/verify`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t\tAuthorization: `Bearer ${apiKey}`,\n\t\t\t},\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tif (response.status === 401) {\n\t\t\t\tthrow new Error(\"Invalid API key\");\n\t\t\t}\n\t\t\tthrow new Error(`Server returned ${response.status}`);\n\t\t}\n\n\t\tconst data = (await response.json()) as {\n\t\t\temail: string;\n\t\t\ttier: \"free\" | \"pro\";\n\t\t};\n\n\t\t// Save credentials\n\t\tconst credentials: GlobalCredentials = {\n\t\t\taccessToken: apiKey,\n\t\t\temail: data.email,\n\t\t\ttier: data.tier,\n\t\t};\n\n\t\tawait saveCredentials(credentials);\n\n\t\tspinner.succeed(\"Logged in with API key\");\n\t\tconsole.log();\n\t\tconsole.log(chalk.green(\"\"), \"Account:\", chalk.cyan(data.email));\n\t\tconsole.log(chalk.green(\"\"), \"Tier:\", formatTier(data.tier));\n\t} catch (error) {\n\t\tspinner.fail(\"Login failed\");\n\t\tthrow error;\n\t}\n}\n\n// =============================================================================\n// CALLBACK SERVER\n// =============================================================================\n\ninterface CallbackResult {\n\turl: string;\n\twaitForCallback: () => Promise<GlobalCredentials>;\n}\n\n/**\n * Start a local HTTP server to receive OAuth callback\n */\nasync function startCallbackServer(): Promise<CallbackResult> {\n\treturn new Promise((resolve, reject) => {\n\t\tlet resolved = false;\n\t\tlet callbackResolver: ((credentials: GlobalCredentials) => void) | null = null;\n\t\tlet callbackRejecter: ((error: Error) => void) | null = null;\n\n\t\tconst server = createServer((req: IncomingMessage, res: ServerResponse) => {\n\t\t\t// Only handle /callback endpoint\n\t\t\tif (!req.url?.startsWith(\"/callback\")) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end(\"Not found\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\t// Parse query parameters\n\t\t\t\tconst url = new URL(req.url, `http://localhost:${AUTH_CALLBACK_PORT}`);\n\t\t\t\tconst token = url.searchParams.get(\"token\");\n\t\t\t\tconst email = url.searchParams.get(\"email\");\n\t\t\t\tconst tier = url.searchParams.get(\"tier\") as \"free\" | \"pro\";\n\t\t\t\tconst error = url.searchParams.get(\"error\");\n\n\t\t\t\tif (error) {\n\t\t\t\t\tres.writeHead(400, { \"Content-Type\": \"text/html\" });\n\t\t\t\t\tres.end(errorPage(error));\n\t\t\t\t\tcallbackRejecter?.(new Error(error));\n\t\t\t\t\tserver.close();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!token || !email) {\n\t\t\t\t\tres.writeHead(400, { \"Content-Type\": \"text/html\" });\n\t\t\t\t\tres.end(errorPage(\"Missing credentials\"));\n\t\t\t\t\tcallbackRejecter?.(new Error(\"Missing credentials\"));\n\t\t\t\t\tserver.close();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Save credentials\n\t\t\t\tconst credentials: GlobalCredentials = {\n\t\t\t\t\taccessToken: token,\n\t\t\t\t\temail,\n\t\t\t\t\ttier: tier || \"free\",\n\t\t\t\t\texpiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days\n\t\t\t\t};\n\n\t\t\t\tsaveCredentials(credentials)\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tres.writeHead(200, { \"Content-Type\": \"text/html\" });\n\t\t\t\t\t\tres.end(successPage(email));\n\t\t\t\t\t\tcallbackResolver?.(credentials);\n\t\t\t\t\t\tserver.close();\n\t\t\t\t\t})\n\t\t\t\t\t.catch((err) => {\n\t\t\t\t\t\tres.writeHead(500, { \"Content-Type\": \"text/html\" });\n\t\t\t\t\t\tres.end(errorPage(\"Failed to save credentials\"));\n\t\t\t\t\t\tcallbackRejecter?.(err);\n\t\t\t\t\t\tserver.close();\n\t\t\t\t\t});\n\t\t\t} catch (err) {\n\t\t\t\tres.writeHead(500, { \"Content-Type\": \"text/html\" });\n\t\t\t\tres.end(errorPage(\"Server error\"));\n\t\t\t\tcallbackRejecter?.(err instanceof Error ? err : new Error(String(err)));\n\t\t\t\tserver.close();\n\t\t\t}\n\t\t});\n\n\t\tserver.on(\"error\", (error) => {\n\t\t\tif (!resolved) {\n\t\t\t\treject(error);\n\t\t\t}\n\t\t});\n\n\t\tserver.listen(AUTH_CALLBACK_PORT, \"127.0.0.1\", () => {\n\t\t\tresolved = true;\n\t\t\tresolve({\n\t\t\t\turl: `http://127.0.0.1:${AUTH_CALLBACK_PORT}/callback`,\n\t\t\t\twaitForCallback: () => {\n\t\t\t\t\treturn new Promise<GlobalCredentials>((res, rej) => {\n\t\t\t\t\t\tcallbackResolver = res;\n\t\t\t\t\t\tcallbackRejecter = rej;\n\n\t\t\t\t\t\t// Set timeout\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\trej(new Error(\"Authentication timed out\"));\n\t\t\t\t\t\t\tserver.close();\n\t\t\t\t\t\t}, AUTH_TIMEOUT_MS);\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t});\n}\n\n// =============================================================================\n// DEVICE CODE POLLING\n// =============================================================================\n\n/**\n * Poll the server for token after device code auth (RFC 8628 compliant)\n *\n * Uses Better Auth's device token endpoint which returns:\n * - access_token on success\n * - \"authorization_pending\" error while waiting\n * - \"slow_down\" error if polling too fast\n */\nasync function pollForToken(deviceCode: string, interval: number, expiresIn: number): Promise<GlobalCredentials> {\n\tconst endTime = Date.now() + expiresIn * 1000;\n\tlet pollInterval = Math.max(interval, 5) * 1000; // Minimum 5 seconds per RFC 8628\n\n\twhile (Date.now() < endTime) {\n\t\tawait sleep(pollInterval);\n\n\t\t// Poll Better Auth's device token endpoint\n\t\tconst response = await fetch(`${BETTER_AUTH_URL}/api/auth/device/token`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify({\n\t\t\t\tdevice_code: deviceCode,\n\t\t\t\tgrant_type: \"urn:ietf:params:oauth:grant-type:device_code\",\n\t\t\t\tclient_id: \"snapback-cli\",\n\t\t\t}),\n\t\t});\n\n\t\tif (response.ok) {\n\t\t\t// Success! Parse the token response\n\t\t\tconst data = (await response.json()) as {\n\t\t\t\taccess_token: string;\n\t\t\t\trefresh_token?: string;\n\t\t\t\ttoken_type: string;\n\t\t\t\texpires_in: number;\n\t\t\t\t// Custom fields from Better Auth\n\t\t\t\tuser?: {\n\t\t\t\t\temail: string;\n\t\t\t\t\tname?: string;\n\t\t\t\t};\n\t\t\t\ttier?: \"free\" | \"pro\";\n\t\t\t};\n\n\t\t\tconst credentials: GlobalCredentials = {\n\t\t\t\taccessToken: data.access_token,\n\t\t\t\trefreshToken: data.refresh_token,\n\t\t\t\temail: data.user?.email || \"user@snapback.dev\",\n\t\t\t\ttier: data.tier || \"free\",\n\t\t\t\texpiresAt: new Date(Date.now() + data.expires_in * 1000).toISOString(),\n\t\t\t};\n\n\t\t\tawait saveCredentials(credentials);\n\t\t\treturn credentials;\n\t\t}\n\n\t\t// Handle RFC 8628 error responses\n\t\tif (response.status === 400) {\n\t\t\tconst error = (await response.json()) as { error: string; error_description?: string };\n\n\t\t\tswitch (error.error) {\n\t\t\t\tcase \"authorization_pending\":\n\t\t\t\t\t// User hasn't approved yet - continue polling\n\t\t\t\t\tcontinue;\n\n\t\t\t\tcase \"slow_down\":\n\t\t\t\t\t// Server requested slower polling - increase interval by 5s (RFC 8628 3.5)\n\t\t\t\t\tpollInterval += 5000;\n\t\t\t\t\tcontinue;\n\n\t\t\t\tcase \"access_denied\":\n\t\t\t\t\tthrow new Error(\"Authorization denied by user\");\n\n\t\t\t\tcase \"expired_token\":\n\t\t\t\t\tthrow new Error(\"Device code expired. Please try again.\");\n\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error(error.error_description || error.error);\n\t\t\t}\n\t\t}\n\n\t\tthrow new Error(`Server returned ${response.status}`);\n\t}\n\n\tthrow new Error(\"Authorization timed out\");\n}\n\n// =============================================================================\n// TOKEN REFRESH\n// =============================================================================\n\n/**\n * Refresh the access token using the refresh token.\n * FIX 6: Proactive token refresh before expiry.\n *\n * @returns Updated credentials if refresh was successful, null otherwise\n */\nasync function refreshAccessToken(credentials: GlobalCredentials): Promise<GlobalCredentials | null> {\n\tif (!credentials.refreshToken) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tconst response = await fetch(`${DEFAULT_API_URL}/auth/refresh`, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify({ refreshToken: credentials.refreshToken }),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\t// Refresh token is invalid or expired\n\t\t\treturn null;\n\t\t}\n\n\t\tconst data = (await response.json()) as {\n\t\t\taccessToken: string;\n\t\t\trefreshToken?: string;\n\t\t\texpiresIn: number;\n\t\t};\n\n\t\tconst newCredentials: GlobalCredentials = {\n\t\t\t...credentials,\n\t\t\taccessToken: data.accessToken,\n\t\t\trefreshToken: data.refreshToken ?? credentials.refreshToken,\n\t\t\texpiresAt: new Date(Date.now() + data.expiresIn * 1000).toISOString(),\n\t\t};\n\n\t\tawait saveCredentials(newCredentials);\n\t\treturn newCredentials;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Check if the token needs refresh (expires within threshold).\n */\nfunction needsTokenRefresh(credentials: GlobalCredentials): boolean {\n\tif (!credentials.expiresAt) {\n\t\treturn false; // No expiry set (e.g., API key auth)\n\t}\n\n\tconst expiresAt = new Date(credentials.expiresAt).getTime();\n\tconst now = Date.now();\n\tconst timeUntilExpiry = expiresAt - now;\n\n\treturn timeUntilExpiry > 0 && timeUntilExpiry < TOKEN_REFRESH_THRESHOLD_MS;\n}\n\n/**\n * Check if the token is expired.\n */\nfunction isTokenExpired(credentials: GlobalCredentials): boolean {\n\tif (!credentials.expiresAt) {\n\t\treturn false; // No expiry set (e.g., API key auth)\n\t}\n\n\tconst expiresAt = new Date(credentials.expiresAt);\n\treturn expiresAt < new Date();\n}\n\n/**\n * Ensure valid credentials are available.\n * Automatically refreshes token if it's about to expire.\n *\n * @returns Valid credentials or null if not logged in\n */\nexport async function ensureValidCredentials(): Promise<GlobalCredentials | null> {\n\tconst credentials = await getCredentials();\n\n\tif (!credentials) {\n\t\treturn null;\n\t}\n\n\t// Check if expired\n\tif (isTokenExpired(credentials)) {\n\t\t// Try to refresh\n\t\tconst refreshed = await refreshAccessToken(credentials);\n\t\tif (refreshed) {\n\t\t\treturn refreshed;\n\t\t}\n\t\t// Refresh failed, need to re-login\n\t\treturn null;\n\t}\n\n\t// Check if needs refresh (about to expire)\n\tif (needsTokenRefresh(credentials)) {\n\t\tconst refreshed = await refreshAccessToken(credentials);\n\t\tif (refreshed) {\n\t\t\treturn refreshed;\n\t\t}\n\t\t// Refresh failed but token is still valid, return original\n\t\treturn credentials;\n\t}\n\n\treturn credentials;\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Open URL in browser\n */\nasync function openBrowser(url: string): Promise<void> {\n\tconst { exec } = await import(\"node:child_process\");\n\n\tconst command =\n\t\tplatform() === \"darwin\" ? `open \"${url}\"` : platform() === \"win32\" ? `start \"\" \"${url}\"` : `xdg-open \"${url}\"`;\n\n\treturn new Promise((resolve) => {\n\t\texec(command, (_error) => {\n\t\t\t// Don't fail if browser doesn't open\n\t\t\tresolve();\n\t\t});\n\t});\n}\n\n/**\n * Get device info for device code auth\n *\n * @remarks Kept for potential future use in device metadata\n */\nfunction _getDeviceInfo(): {\n\thostname: string;\n\tplatform: string;\n\tuser: string;\n} {\n\treturn {\n\t\thostname: hostname(),\n\t\tplatform: platform(),\n\t\tuser: userInfo().username,\n\t};\n}\n\n/**\n * Format tier for display\n */\nfunction formatTier(tier: \"free\" | \"pro\"): string {\n\treturn tier === \"pro\" ? chalk.magenta.bold(\"Pro \") : chalk.gray(\"Free\");\n}\n\n/**\n * Sleep for a number of milliseconds\n */\nfunction sleep(ms: number): Promise<void> {\n\treturn new Promise((resolve) => setTimeout(resolve, ms));\n}\n\n/**\n * Success HTML page for browser callback\n */\nfunction successPage(email: string): string {\n\treturn `\n<!DOCTYPE html>\n<html>\n<head>\n  <title>SnapBack - Login Successful</title>\n  <style>\n    body { font-family: system-ui, sans-serif; text-align: center; padding: 50px; background: #0a0a0a; color: #fafafa; }\n    .success { color: #22c55e; font-size: 48px; margin-bottom: 20px; }\n    h1 { margin-bottom: 10px; }\n    p { color: #a1a1aa; }\n    .close { margin-top: 30px; color: #71717a; font-size: 14px; }\n  </style>\n</head>\n<body>\n  <div class=\"success\"></div>\n  <h1>Welcome to SnapBack!</h1>\n  <p>Logged in as ${email}</p>\n  <p class=\"close\">You can close this window and return to your terminal.</p>\n  <script>setTimeout(() => window.close(), 3000);</script>\n</body>\n</html>\n`;\n}\n\n/**\n * Error HTML page for browser callback\n */\nfunction errorPage(error: string): string {\n\treturn `\n<!DOCTYPE html>\n<html>\n<head>\n  <title>SnapBack - Login Failed</title>\n  <style>\n    body { font-family: system-ui, sans-serif; text-align: center; padding: 50px; background: #0a0a0a; color: #fafafa; }\n    .error { color: #ef4444; font-size: 48px; margin-bottom: 20px; }\n    h1 { margin-bottom: 10px; }\n    p { color: #a1a1aa; }\n  </style>\n</head>\n<body>\n  <div class=\"error\"></div>\n  <h1>Login Failed</h1>\n  <p>${error}</p>\n  <p>Please try again in your terminal.</p>\n</body>\n</html>\n`;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n// Note: ensureValidCredentials is already exported above with 'export async function'\nexport {\n\tisTokenExpired,\n\tloginWithApiKey,\n\tloginWithBrowser,\n\tloginWithDeviceCode,\n\tneedsTokenRefresh,\n\trefreshAccessToken,\n};\n","/**\n * CLI-UX-001: Boxen Integration\n *\n * @fileoverview Box rendering utilities for screenshot-worthy CLI output.\n * Critical moments like snapshot creation, risk detection, and recovery\n * operations are displayed in visually distinct boxes.\n *\n * ## Purpose\n *\n * These utilities provide a consistent visual language for:\n * - Success messages (green, round border)\n * - Warnings (yellow, round border)\n * - Errors (red, round border)\n * - Info (cyan, round border)\n * - Save stories (green, double border - for Pioneer Program)\n *\n * ## Usage\n *\n * ```typescript\n * import { displayBox, displaySaveStory, displaySnapshotSuccess } from \"../utils/display\";\n *\n * // Simple box with content and options\n * console.log(displayBox(\"Hello World\", { type: \"success\", title: \"Welcome\" }));\n *\n * // Object-style API (preferred for new code)\n * console.log(displayBox({\n *   title: \" Statistics\",\n *   content: \"Total: 42\\nActive: 12\",\n *   type: \"info\",\n * }));\n *\n * // Specialized functions\n * console.log(displaySaveStory(8.5, [\"src/auth.ts\"], \"abc123\"));\n * console.log(displaySnapshotSuccess(\"abc123\", \"Before refactor\", 5));\n * ```\n *\n * @see {@link file://ai_dev_utils/resources/new_cli/01-boxen-integration.spec.md}\n * @module utils/display\n */\n\nimport boxen, { type Options as BoxenOptions } from \"boxen\";\nimport chalk from \"chalk\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Box visual type - determines colors and styling\n */\nexport type BoxType = \"success\" | \"warning\" | \"error\" | \"info\" | \"save-story\";\n\n/**\n * Options for displayBox when using string content\n */\ninterface DisplayBoxStringOptions {\n\t/** Title displayed at top of box */\n\ttitle?: string;\n\t/** Visual type (determines colors) */\n\ttype?: BoxType;\n\t/** Inner padding (default: 1) */\n\tpadding?: number;\n\t/** Outer margin (default: 0) */\n\tmargin?: number;\n}\n\n/**\n * Object-style options for displayBox\n *\n * @remarks\n * This is the preferred API for new code - more explicit and readable.\n */\ninterface DisplayBoxObjectOptions {\n\t/** Title displayed at top of box */\n\ttitle?: string;\n\t/** Content to display inside the box */\n\tcontent: string;\n\t/** Visual type (determines colors) */\n\ttype?: BoxType;\n\t/** Inner padding (default: 1) */\n\tpadding?: number;\n\t/** Outer margin (default: 0) */\n\tmargin?: number;\n}\n\n// =============================================================================\n// BOX STYLES\n// =============================================================================\n\n/**\n * Box styles for each type\n *\n * @remarks\n * These map to boxen options. The styles are designed to be:\n * - Consistent with chalk color conventions\n * - Visually distinct from each other\n * - Screenshot-friendly (good contrast, readable)\n *\n * @internal\n */\nconst BOX_STYLES: Record<BoxType, Partial<BoxenOptions>> = {\n\tsuccess: {\n\t\tborderColor: \"green\",\n\t\tborderStyle: \"round\",\n\t},\n\twarning: {\n\t\tborderColor: \"yellow\",\n\t\tborderStyle: \"round\",\n\t},\n\terror: {\n\t\tborderColor: \"red\",\n\t\tborderStyle: \"round\",\n\t},\n\tinfo: {\n\t\tborderColor: \"cyan\",\n\t\tborderStyle: \"round\",\n\t},\n\t\"save-story\": {\n\t\tborderColor: \"green\",\n\t\tborderStyle: \"double\",\n\t\tpadding: 1,\n\t\tmargin: 1,\n\t},\n};\n\n// =============================================================================\n// CORE DISPLAY FUNCTION\n// =============================================================================\n\n/**\n * Display content in a styled box\n *\n * @param contentOrOptions - Either string content or object with content and options\n * @param options - Options when using string content (ignored for object style)\n * @returns Formatted box string ready for console.log()\n *\n * @remarks\n * ## Two calling styles\n *\n * ### String style (legacy, still supported)\n * ```typescript\n * displayBox(\"Hello\", { type: \"success\", title: \"Welcome\" })\n * ```\n *\n * ### Object style (preferred for new code)\n * ```typescript\n * displayBox({\n *   title: \"Welcome\",\n *   content: \"Hello\",\n *   type: \"success\",\n * })\n * ```\n *\n * ## Implementation Notes for LLM Agents\n *\n * 1. The function detects which style is being used by checking if first arg is string\n * 2. Object style is preferred because it's more explicit\n * 3. Unknown types default to \"info\" (cyan border)\n * 4. Empty content is allowed but will result in small box\n *\n * @example\n * ```typescript\n * // Success box\n * console.log(displayBox({\n *   title: \" Done\",\n *   content: \"Operation completed successfully\",\n *   type: \"success\",\n * }));\n *\n * // Error box\n * console.log(displayBox({\n *   title: \" Error\",\n *   content: \"Something went wrong\",\n *   type: \"error\",\n * }));\n * ```\n */\nexport function displayBox(\n\tcontentOrOptions: string | DisplayBoxObjectOptions,\n\toptions: DisplayBoxStringOptions = {},\n): string {\n\t// Detect which calling style is being used\n\tlet content: string;\n\tlet title: string | undefined;\n\tlet type: BoxType;\n\tlet padding: number;\n\tlet margin: number;\n\n\tif (typeof contentOrOptions === \"string\") {\n\t\t// String style: displayBox(\"content\", { options })\n\t\tcontent = contentOrOptions;\n\t\ttitle = options.title;\n\t\ttype = options.type ?? \"info\";\n\t\tpadding = options.padding ?? 1;\n\t\tmargin = options.margin ?? 0;\n\t} else {\n\t\t// Object style: displayBox({ content, title, type, ... })\n\t\tcontent = contentOrOptions.content;\n\t\ttitle = contentOrOptions.title;\n\t\ttype = contentOrOptions.type ?? \"info\";\n\t\tpadding = contentOrOptions.padding ?? 1;\n\t\tmargin = contentOrOptions.margin ?? 0;\n\t}\n\n\t// Handle unknown type gracefully by defaulting to 'info'\n\tconst styleType = type in BOX_STYLES ? type : \"info\";\n\n\treturn boxen(content, {\n\t\t...BOX_STYLES[styleType],\n\t\tpadding,\n\t\tmargin,\n\t\t...(title && { title, titleAlignment: \"center\" as const }),\n\t});\n}\n\n// =============================================================================\n// SPECIALIZED DISPLAY FUNCTIONS\n// =============================================================================\n\n/**\n * Display a \"save story\" box when SnapBack prevents a disaster\n *\n * @param riskScore - The risk score that was detected (0-10)\n * @param affectedFiles - Array of file paths that were protected\n * @param snapshotId - The snapshot ID that was created\n * @returns Formatted save story box string\n *\n * @remarks\n * Used for Pioneer Program gamification and screenshot-worthy moments.\n * The double border and extra padding make this stand out from regular output.\n *\n * @example\n * ```typescript\n * const story = displaySaveStory(8.5, [\"src/auth.ts\", \"src/api.ts\"], \"abc123def\");\n * console.log(story);\n * ```\n */\nexport function displaySaveStory(riskScore: number, affectedFiles: string[], snapshotId: string): string {\n\treturn displayBox(\n\t\t`${chalk.bold(\" SnapBack just protected you!\")}\\n\\n` +\n\t\t\t`${chalk.cyan(\"Risk Score:\")} ${chalk.red(riskScore.toFixed(1) + \"/10\")}\\n` +\n\t\t\t`${chalk.cyan(\"Files Protected:\")} ${chalk.green(affectedFiles.length.toString())}\\n` +\n\t\t\t`${chalk.cyan(\"Snapshot:\")} ${snapshotId.substring(0, 8)}\\n\\n` +\n\t\t\tchalk.dim(\"Share your save story: snapback.dev/stories\"),\n\t\t{\n\t\t\ttype: \"save-story\",\n\t\t},\n\t);\n}\n\n/**\n * Display snapshot creation success box\n *\n * @param snapshotId - The created snapshot ID\n * @param message - Optional snapshot message\n * @param fileCount - Number of files protected\n * @returns Formatted success box string\n *\n * @example\n * ```typescript\n * const success = displaySnapshotSuccess(\"abc123\", \"Before major refactor\", 12);\n * console.log(success);\n * ```\n */\nexport function displaySnapshotSuccess(snapshotId: string, message: string | undefined, fileCount: number): string {\n\treturn displayBox(\n\t\t`${chalk.green(\"\")} Snapshot created\\n` +\n\t\t\t`${chalk.cyan(\"ID:\")} ${snapshotId.substring(0, 8)}\\n` +\n\t\t\t`${chalk.cyan(\"Message:\")} ${message || \"(none)\"}\\n` +\n\t\t\t`${chalk.cyan(\"Files:\")} ${fileCount} protected`,\n\t\t{\n\t\t\ttitle: \" SnapBack Protection Active\",\n\t\t\ttype: \"success\",\n\t\t},\n\t);\n}\n\n/**\n * Display high-risk detection warning box\n *\n * @param file - The file that was analyzed\n * @param riskScore - The risk score (0-10)\n * @returns Formatted warning box string\n *\n * @example\n * ```typescript\n * const warning = displayHighRiskWarning(\"src/critical.ts\", 9.2);\n * console.log(warning);\n * ```\n */\nexport function displayHighRiskWarning(file: string, riskScore: number): string {\n\treturn displayBox(\n\t\t`${chalk.red(\" High Risk Detected\")}\\n\\n` +\n\t\t\t`${chalk.cyan(\"File:\")} ${file}\\n` +\n\t\t\t`${chalk.cyan(\"Risk Score:\")} ${chalk.red(riskScore.toFixed(1) + \"/10\")}\\n\\n` +\n\t\t\t`${chalk.yellow(\"Recommendation:\")} Create a snapshot before proceeding`,\n\t\t{\n\t\t\ttitle: \" Risk Analysis\",\n\t\t\ttype: \"warning\",\n\t\t},\n\t);\n}\n\n/**\n * Display error box\n *\n * @param title - Error title\n * @param message - Error message\n * @param suggestion - Optional suggestion for fixing the error\n * @returns Formatted error box string\n *\n * @example\n * ```typescript\n * const error = displayError(\n *   \"File Not Found\",\n *   \"Could not locate src/missing.ts\",\n *   \"Check the file path and try again\"\n * );\n * console.log(error);\n * ```\n */\nexport function displayError(title: string, message: string, suggestion?: string): string {\n\tlet content = `${chalk.red(\"\")} ${title}\\n\\n${message}`;\n\n\tif (suggestion) {\n\t\tcontent += `\\n\\n${chalk.dim(\"Suggestion:\")} ${suggestion}`;\n\t}\n\n\treturn displayBox(content, {\n\t\ttype: \"error\",\n\t});\n}\n\n/**\n * Display info box\n *\n * @param title - Box title\n * @param content - Content to display\n * @returns Formatted info box string\n *\n * @example\n * ```typescript\n * const info = displayInfo(\" Summary\", \"Total files: 42\\nModified: 12\");\n * console.log(info);\n * ```\n */\nexport function displayInfo(title: string, content: string): string {\n\treturn displayBox(content, {\n\t\ttitle,\n\t\ttype: \"info\",\n\t});\n}\n\n// =============================================================================\n// CONTEXT DISPLAY HELPERS (CLI-UX-005)\n// =============================================================================\n\n/**\n * Display context summary box\n *\n * @param summary - Summary data to display\n * @returns Formatted info box string\n *\n * @remarks\n * Used by `snap context` command to display loaded context.\n *\n * @example\n * ```typescript\n * const box = displayContextSummary({\n *   hardRules: 12,\n *   patterns: 8,\n *   learnings: 3,\n *   violations: 2,\n * });\n * console.log(box);\n * ```\n */\nexport function displayContextSummary(summary: {\n\thardRules?: number;\n\tpatterns?: number;\n\tlearnings?: number;\n\tviolations?: number;\n\tsemantic?: { sections: number; compression: string };\n}): string {\n\tconst parts: string[] = [];\n\n\tif (summary.hardRules !== undefined) {\n\t\tparts.push(`${chalk.bold(\"Hard Rules:\")} ${summary.hardRules} constraints`);\n\t}\n\n\tif (summary.patterns !== undefined) {\n\t\tparts.push(`${chalk.bold(\"Patterns:\")} ${summary.patterns} patterns`);\n\t}\n\n\tif (summary.learnings !== undefined) {\n\t\tparts.push(`${chalk.bold(\"Learnings:\")} ${summary.learnings} relevant`);\n\t}\n\n\tif (summary.violations !== undefined) {\n\t\tparts.push(`${chalk.bold(\"Violations:\")} ${summary.violations} to avoid`);\n\t}\n\n\tif (summary.semantic) {\n\t\tparts.push(\n\t\t\t`${chalk.bold(\"Semantic:\")} ${summary.semantic.sections} sections (${summary.semantic.compression} compression)`,\n\t\t);\n\t}\n\n\tif (parts.length === 0) {\n\t\tparts.push(\"No specific context found for this task.\");\n\t\tparts.push(\"Try adding --keywords to refine the search.\");\n\t}\n\n\treturn displayBox({\n\t\ttitle: \" Context Loaded\",\n\t\tcontent: parts.join(\"\\n\"),\n\t\ttype: \"info\",\n\t});\n}\n\n// =============================================================================\n// VALIDATION DISPLAY HELPERS (CLI-UX-005)\n// =============================================================================\n\n/**\n * Display validation failure summary box\n *\n * @param failures - Array of failed file results\n * @returns Formatted error box string\n *\n * @remarks\n * Used by `snap validate` command when files fail validation.\n *\n * @example\n * ```typescript\n * const box = displayValidationFailure([\n *   { file: \"src/auth.ts\", issues: 3 },\n *   { file: \"src/api.ts\", issues: 1 },\n * ]);\n * console.log(box);\n * ```\n */\nexport function displayValidationFailure(failures: Array<{ file: string; issues: number }>): string {\n\tconst content = failures\n\t\t.map((f) => `${chalk.bold(f.file)}: ${f.issues} issue${f.issues !== 1 ? \"s\" : \"\"}`)\n\t\t.join(\"\\n\");\n\n\treturn displayBox({\n\t\ttitle: \" Validation Failed\",\n\t\tcontent,\n\t\ttype: \"error\",\n\t});\n}\n\n/**\n * Display validation success box\n *\n * @param fileCount - Number of files that passed\n * @returns Formatted success box string\n *\n * @example\n * ```typescript\n * const box = displayValidationSuccess(5);\n * console.log(box);\n * ```\n */\nexport function displayValidationSuccess(fileCount: number): string {\n\treturn displayBox({\n\t\ttitle: \" Validation Passed\",\n\t\tcontent: `All ${fileCount} file${fileCount !== 1 ? \"s\" : \"\"} passed validation`,\n\t\ttype: \"success\",\n\t});\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport type { DisplayBoxStringOptions, DisplayBoxObjectOptions };\n","/**\n * Fix Command\n *\n * Implements snap fix <issue> - Auto-fix detected issues.\n * Issues are detected by snap status and can be resolved with this command.\n *\n * Available fixes:\n * - missing-gitignore: Add .snapback to .gitignore\n * - no-protection: Auto-detect and protect critical files\n * - stale-session: End stale session\n * - high-violations: Show violation patterns for learning\n * - not-logged-in: Prompt to login\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport { access, appendFile, constants, readFile } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\tendCurrentSession,\n\tgetCurrentSession,\n\tgetProtectedFiles,\n\tgetViolations,\n\tgetWorkspaceVitals,\n\tisSnapbackInitialized,\n\ttype ProtectedFile,\n\tsaveProtectedFiles,\n} from \"../services/snapback-dir\";\nimport { displayBox } from \"../utils/display\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface FixResult {\n\tsuccess: boolean;\n\tmessage: string;\n\tdetails?: string[];\n}\n\ntype FixFunction = (workspaceRoot: string, dryRun: boolean) => Promise<FixResult>;\n\n// =============================================================================\n// FIX REGISTRY\n// =============================================================================\n\nconst FIXES: Record<string, { description: string; fix: FixFunction }> = {\n\t\"missing-gitignore\": {\n\t\tdescription: \"Add .snapback to .gitignore\",\n\t\tfix: fixMissingGitignore,\n\t},\n\t\"no-protection\": {\n\t\tdescription: \"Auto-detect and protect critical files\",\n\t\tfix: fixNoProtection,\n\t},\n\t\"stale-session\": {\n\t\tdescription: \"End stale session (>24h old)\",\n\t\tfix: fixStaleSession,\n\t},\n\t\"high-violations\": {\n\t\tdescription: \"Review and learn from violation patterns\",\n\t\tfix: fixHighViolations,\n\t},\n\t\"not-logged-in\": {\n\t\tdescription: \"Login to SnapBack for full features\",\n\t\tfix: fixNotLoggedIn,\n\t},\n};\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the fix command\n */\nexport function createFixCommand(): Command {\n\tconst fix = new Command(\"fix\")\n\t\t.description(\"Auto-fix detected issues\")\n\t\t.argument(\"[issue]\", \"Issue ID to fix (from snap status)\")\n\t\t.option(\"--dry-run\", \"Show what would be fixed without making changes\")\n\t\t.option(\"--all\", \"Fix all detected issues\")\n\t\t.option(\"--list\", \"List all available fixes\")\n\t\t.action(async (issue: string | undefined, options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// List all fixes\n\t\t\t\tif (options.list) {\n\t\t\t\t\tdisplayAvailableFixes();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Fix all issues\n\t\t\t\tif (options.all) {\n\t\t\t\t\tawait fixAll(cwd, options.dryRun);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Single issue fix\n\t\t\t\tif (!issue) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No issue specified\"));\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(\"Usage:\");\n\t\t\t\t\tconsole.log(chalk.gray(\"  snap fix <issue-id>    Fix a specific issue\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"  snap fix --all         Fix all detected issues\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"  snap fix --list        List all available fixes\"));\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(\"Run\", chalk.cyan(\"snap status\"), \"to see detected issues.\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Validate issue\n\t\t\t\tconst fixer = FIXES[issue];\n\t\t\t\tif (!fixer) {\n\t\t\t\t\tconsole.log(chalk.red(`Unknown issue: ${issue}`));\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tdisplayAvailableFixes();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Apply fix\n\t\t\t\tif (options.dryRun) {\n\t\t\t\t\tconsole.log(chalk.cyan(\"Dry run:\"), `Would fix \"${issue}\"`);\n\t\t\t\t\tconsole.log(chalk.gray(`  ${fixer.description}`));\n\t\t\t\t}\n\n\t\t\t\tconst result = await fixer.fix(cwd, options.dryRun);\n\n\t\t\t\tif (result.success) {\n\t\t\t\t\tif (options.dryRun) {\n\t\t\t\t\t\tconsole.log(chalk.cyan(\"\"), result.message);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(chalk.green(\"\"), result.message);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(chalk.yellow(\"\"), result.message);\n\t\t\t\t}\n\n\t\t\t\tif (result.details && result.details.length > 0) {\n\t\t\t\t\tfor (const detail of result.details) {\n\t\t\t\t\t\tconsole.log(chalk.gray(`  ${detail}`));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn fix;\n}\n\n// =============================================================================\n// FIX IMPLEMENTATIONS\n// =============================================================================\n\n/**\n * Fix missing .gitignore entry for .snapback\n */\nasync function fixMissingGitignore(workspaceRoot: string, dryRun: boolean): Promise<FixResult> {\n\tconst gitignorePath = join(workspaceRoot, \".gitignore\");\n\n\ttry {\n\t\t// Check if .gitignore exists\n\t\tawait access(gitignorePath, constants.F_OK);\n\n\t\t// Read current content\n\t\tconst content = await readFile(gitignorePath, \"utf-8\");\n\n\t\t// Check if already has .snapback\n\t\tif (content.includes(\".snapback\")) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\tmessage: \".snapback already in .gitignore\",\n\t\t\t};\n\t\t}\n\n\t\t// Prepare addition\n\t\tconst addition = \"\\n# SnapBack snapshots (large binary data)\\n.snapback/snapshots/\\n.snapback/embeddings.db\\n\";\n\n\t\tif (dryRun) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: \"Would add .snapback entries to .gitignore\",\n\t\t\t\tdetails: [\".snapback/snapshots/\", \".snapback/embeddings.db\"],\n\t\t\t};\n\t\t}\n\n\t\t// Append to .gitignore\n\t\tawait appendFile(gitignorePath, addition);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: \"Added .snapback entries to .gitignore\",\n\t\t\tdetails: [\".snapback/snapshots/\", \".snapback/embeddings.db\"],\n\t\t};\n\t} catch {\n\t\t// No .gitignore exists, create one\n\t\tif (dryRun) {\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: \"Would create .gitignore with .snapback entries\",\n\t\t\t};\n\t\t}\n\n\t\tconst content = \"# SnapBack snapshots (large binary data)\\n.snapback/snapshots/\\n.snapback/embeddings.db\\n\";\n\t\tconst { writeFile } = await import(\"node:fs/promises\");\n\t\tawait writeFile(gitignorePath, content);\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: \"Created .gitignore with .snapback entries\",\n\t\t};\n\t}\n}\n\n/**\n * Fix no protection by auto-detecting critical files\n */\nasync function fixNoProtection(workspaceRoot: string, dryRun: boolean): Promise<FixResult> {\n\tconst currentProtected = await getProtectedFiles(workspaceRoot);\n\n\tif (currentProtected.length > 0) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessage: `Already have ${currentProtected.length} protected files`,\n\t\t};\n\t}\n\n\t// Get vitals to know what framework we're dealing with\n\tconst vitals = await getWorkspaceVitals(workspaceRoot);\n\n\t// Auto-detect critical files\n\tconst criticalPatterns = await detectCriticalPatterns(workspaceRoot, vitals?.framework);\n\n\tif (criticalPatterns.length === 0) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessage: \"No critical files detected to protect\",\n\t\t};\n\t}\n\n\tif (dryRun) {\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Would protect ${criticalPatterns.length} critical file patterns`,\n\t\t\tdetails: criticalPatterns.map((p) => p.pattern),\n\t\t};\n\t}\n\n\t// Save protected files\n\tawait saveProtectedFiles(criticalPatterns, workspaceRoot);\n\n\treturn {\n\t\tsuccess: true,\n\t\tmessage: `Protected ${criticalPatterns.length} critical file patterns`,\n\t\tdetails: criticalPatterns.map((p) => `${p.pattern} (${p.reason})`),\n\t};\n}\n\n/**\n * Fix stale session by ending it\n */\nasync function fixStaleSession(workspaceRoot: string, dryRun: boolean): Promise<FixResult> {\n\tconst session = await getCurrentSession(workspaceRoot);\n\n\tif (!session) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessage: \"No active session\",\n\t\t};\n\t}\n\n\tconst sessionStart = new Date(session.startedAt);\n\tconst hoursSinceStart = (Date.now() - sessionStart.getTime()) / (1000 * 60 * 60);\n\n\tif (hoursSinceStart <= 24) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessage: `Session is only ${Math.floor(hoursSinceStart)}h old (not stale)`,\n\t\t};\n\t}\n\n\tif (dryRun) {\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmessage: `Would end stale session (${Math.floor(hoursSinceStart)}h old)`,\n\t\t\tdetails: [\n\t\t\t\t`ID: ${session.id.substring(0, 8)}`,\n\t\t\t\tsession.task ? `Task: ${session.task}` : \"(no task)\",\n\t\t\t\t`Snapshots: ${session.snapshotCount}`,\n\t\t\t],\n\t\t};\n\t}\n\n\t// Archive and end session\n\tconst { appendSnapbackJsonl } = await import(\"../services/snapback-dir\");\n\tawait appendSnapbackJsonl(\n\t\t\"session/history.jsonl\",\n\t\t{\n\t\t\t...session,\n\t\t\tendedAt: new Date().toISOString(),\n\t\t\tendMessage: \"Auto-ended by snap fix (stale session)\",\n\t\t},\n\t\tworkspaceRoot,\n\t);\n\tawait endCurrentSession(workspaceRoot);\n\n\treturn {\n\t\tsuccess: true,\n\t\tmessage: `Ended stale session (${Math.floor(hoursSinceStart)}h old)`,\n\t\tdetails: [`ID: ${session.id.substring(0, 8)}`, `Snapshots: ${session.snapshotCount}`],\n\t};\n}\n\n/**\n * Fix high violations by showing patterns and suggesting learnings\n */\nasync function fixHighViolations(workspaceRoot: string, _dryRun: boolean): Promise<FixResult> {\n\tconst violations = await getViolations(workspaceRoot);\n\tconst oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\n\tconst recentViolations = violations.filter((v) => new Date(v.date) > oneWeekAgo);\n\n\tif (recentViolations.length <= 5) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\tmessage: `Only ${recentViolations.length} violations this week (threshold: >5)`,\n\t\t};\n\t}\n\n\t// Group violations by type\n\tconst byType: Record<string, number> = {};\n\tfor (const v of recentViolations) {\n\t\tbyType[v.type] = (byType[v.type] || 0) + 1;\n\t}\n\n\t// Sort by frequency\n\tconst sorted = Object.entries(byType).sort((a, b) => b[1] - a[1]);\n\n\tconst details = sorted.map(([type, count]) => {\n\t\tconst emoji = count >= 3 ? \"\" : count >= 2 ? \"\" : \"\";\n\t\tconst promoted = count >= 3 ? \" (pattern candidate)\" : \"\";\n\t\treturn `${emoji} ${type}: ${count} occurrences${promoted}`;\n\t});\n\n\t// Show the violations summary\n\tconsole.log();\n\tconsole.log(\n\t\tdisplayBox(\n\t\t\t`${chalk.yellow(\"High Violation Count\")}\\n\\n` +\n\t\t\t\t`${recentViolations.length} violations in the last week.\\n` +\n\t\t\t\t\"Review these patterns to prevent future issues.\\n\\n\" +\n\t\t\t\tdetails.join(\"\\n\"),\n\t\t\t{ type: \"warning\" },\n\t\t),\n\t);\n\n\treturn {\n\t\tsuccess: true,\n\t\tmessage: \"Violation patterns analyzed\",\n\t\tdetails: [\n\t\t\t\"Patterns with 3+ occurrences are candidates for automation.\",\n\t\t\t\"Run: snap patterns list  to see promoted patterns\",\n\t\t\t'Run: snap learn \"<trigger>\" \"<action>\"  to record learnings',\n\t\t],\n\t};\n}\n\n/**\n * Fix not logged in by prompting to login\n */\nasync function fixNotLoggedIn(_workspaceRoot: string, _dryRun: boolean): Promise<FixResult> {\n\tconsole.log();\n\tconsole.log(\n\t\tdisplayBox(\n\t\t\t`${chalk.cyan(\"Login for Full Features\")}\\n\\n` +\n\t\t\t\t\"Some features require a SnapBack account:\\n\" +\n\t\t\t\t\" Pro tier: Snapshots, recovery, advanced protection\\n\" +\n\t\t\t\t\" Free tier: Risk analysis, pattern tracking\\n\\n\" +\n\t\t\t\t`${chalk.bold(\"Run:\")} snap login`,\n\t\t\t{ type: \"info\" },\n\t\t),\n\t);\n\n\treturn {\n\t\tsuccess: true,\n\t\tmessage: \"Login instructions displayed\",\n\t\tdetails: [\"Run: snap login\"],\n\t};\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Display list of available fixes\n */\nfunction displayAvailableFixes(): void {\n\tconsole.log(chalk.cyan(\"Available Fixes:\"));\n\tconsole.log();\n\n\tfor (const [id, { description }] of Object.entries(FIXES)) {\n\t\tconsole.log(`  ${chalk.bold(id)}`);\n\t\tconsole.log(chalk.gray(`    ${description}`));\n\t}\n\n\tconsole.log();\n\tconsole.log(chalk.gray(\"Usage: snap fix <issue-id>\"));\n\tconsole.log(chalk.gray(\"       snap fix --all\"));\n}\n\n/**\n * Fix all detected issues\n */\nasync function fixAll(workspaceRoot: string, dryRun: boolean): Promise<void> {\n\tconsole.log(chalk.cyan(dryRun ? \"Dry run: Would fix all issues\" : \"Fixing all detected issues...\"));\n\tconsole.log();\n\n\tlet fixedCount = 0;\n\tlet skippedCount = 0;\n\n\tfor (const [id, { description, fix }] of Object.entries(FIXES)) {\n\t\tprocess.stdout.write(`  ${id}... `);\n\n\t\ttry {\n\t\t\tconst result = await fix(workspaceRoot, dryRun);\n\n\t\t\tif (result.success) {\n\t\t\t\tconsole.log(chalk.green(\"\"), chalk.gray(result.message));\n\t\t\t\tfixedCount++;\n\t\t\t} else {\n\t\t\t\tconsole.log(chalk.gray(\"\"), chalk.gray(result.message));\n\t\t\t\tskippedCount++;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(chalk.red(\"\"), chalk.gray(error instanceof Error ? error.message : \"Unknown error\"));\n\t\t}\n\t}\n\n\tconsole.log();\n\tconsole.log(chalk.gray(`Fixed: ${fixedCount}, Skipped: ${skippedCount}`));\n}\n\n/**\n * Detect critical file patterns based on what exists in the workspace\n */\nasync function detectCriticalPatterns(workspaceRoot: string, framework?: string): Promise<ProtectedFile[]> {\n\tconst patterns: ProtectedFile[] = [];\n\tconst now = new Date().toISOString();\n\n\t// Environment files (always check)\n\tconst envPatterns = [\".env\", \".env.local\", \".env.production\", \".env.development\"];\n\tfor (const pattern of envPatterns) {\n\t\ttry {\n\t\t\tawait access(join(workspaceRoot, pattern), constants.F_OK);\n\t\t\tpatterns.push({\n\t\t\t\tpattern,\n\t\t\t\taddedAt: now,\n\t\t\t\treason: \"Environment variables\",\n\t\t\t});\n\t\t} catch {\n\t\t\t// File doesn't exist\n\t\t}\n\t}\n\n\t// Add glob patterns for env files\n\tpatterns.push({\n\t\tpattern: \".env.*\",\n\t\taddedAt: now,\n\t\treason: \"Environment variables (all variants)\",\n\t});\n\n\t// Configuration files\n\tconst configPatterns = [\"tsconfig.json\", \"package.json\", \"pnpm-lock.yaml\", \"yarn.lock\", \"package-lock.json\"];\n\tfor (const pattern of configPatterns) {\n\t\ttry {\n\t\t\tawait access(join(workspaceRoot, pattern), constants.F_OK);\n\t\t\tpatterns.push({\n\t\t\t\tpattern,\n\t\t\t\taddedAt: now,\n\t\t\t\treason: \"Configuration file\",\n\t\t\t});\n\t\t} catch {\n\t\t\t// File doesn't exist\n\t\t}\n\t}\n\n\t// Config file globs\n\tpatterns.push({\n\t\tpattern: \"*.config.js\",\n\t\taddedAt: now,\n\t\treason: \"Configuration files\",\n\t});\n\tpatterns.push({\n\t\tpattern: \"*.config.ts\",\n\t\taddedAt: now,\n\t\treason: \"Configuration files\",\n\t});\n\n\t// Framework-specific patterns\n\tif (framework) {\n\t\tconst frameworkPatterns = getFrameworkPatterns(framework);\n\t\tpatterns.push(...frameworkPatterns.map((p) => ({ ...p, addedAt: now })));\n\t}\n\n\t// Database/Auth patterns\n\tconst criticalDirs = [\n\t\t{ dir: \"prisma\", pattern: \"prisma/**\", reason: \"Database schema\" },\n\t\t{ dir: \"drizzle\", pattern: \"drizzle/**\", reason: \"Database schema\" },\n\t\t{ dir: \"src/auth\", pattern: \"src/auth/**\", reason: \"Authentication\" },\n\t\t{ dir: \"src/lib/auth\", pattern: \"src/lib/auth/**\", reason: \"Authentication\" },\n\t\t{ dir: \"app/api/auth\", pattern: \"app/api/auth/**\", reason: \"Authentication API\" },\n\t];\n\n\tfor (const { dir, pattern, reason } of criticalDirs) {\n\t\ttry {\n\t\t\tawait access(join(workspaceRoot, dir), constants.F_OK);\n\t\t\tpatterns.push({\n\t\t\t\tpattern,\n\t\t\t\taddedAt: now,\n\t\t\t\treason,\n\t\t\t});\n\t\t} catch {\n\t\t\t// Directory doesn't exist\n\t\t}\n\t}\n\n\treturn patterns;\n}\n\n/**\n * Get framework-specific protection patterns\n */\nfunction getFrameworkPatterns(framework: string): Omit<ProtectedFile, \"addedAt\">[] {\n\tconst patterns: Omit<ProtectedFile, \"addedAt\">[] = [];\n\n\tswitch (framework.toLowerCase()) {\n\t\tcase \"next.js\":\n\t\tcase \"nextjs\":\n\t\t\tpatterns.push({\n\t\t\t\tpattern: \"next.config.*\",\n\t\t\t\treason: \"Next.js configuration\",\n\t\t\t});\n\t\t\tpatterns.push({\n\t\t\t\tpattern: \"middleware.ts\",\n\t\t\t\treason: \"Next.js middleware\",\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase \"nuxt\":\n\t\t\tpatterns.push({\n\t\t\t\tpattern: \"nuxt.config.*\",\n\t\t\t\treason: \"Nuxt configuration\",\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase \"sveltekit\":\n\t\t\tpatterns.push({\n\t\t\t\tpattern: \"svelte.config.js\",\n\t\t\t\treason: \"SvelteKit configuration\",\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase \"astro\":\n\t\t\tpatterns.push({\n\t\t\t\tpattern: \"astro.config.*\",\n\t\t\t\treason: \"Astro configuration\",\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase \"remix\":\n\t\t\tpatterns.push({\n\t\t\t\tpattern: \"remix.config.js\",\n\t\t\t\treason: \"Remix configuration\",\n\t\t\t});\n\t\t\tbreak;\n\t}\n\n\treturn patterns;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { detectCriticalPatterns, FIXES };\n","/**\n * SnapBack Storage Layer\n *\n * MIGRATION NOTES:\n * - Simplifies packages/sdk/src/storage/StorageBroker.ts (903 LOC)\n * - Removes: connection pooling, distributed locking, queue operations\n * - Keeps: snapshot CRUD, compression, content-addressable blobs\n *\n * REFERENCE FILES:\n * - packages/sdk/src/storage/StorageBroker.ts (main source)\n * - packages/sdk/src/storage/BlobStore.ts (blob operations)\n * - packages/sdk/src/storage/LocalStorage.ts (file adapter)\n * - apps/vscode/src/storage/StorageManager.ts (current extension implementation)\n *\n * DESIGN:\n * - Single-writer discipline (no locking needed)\n * - File-based storage with JSON manifests\n * - Content-addressable blobs for deduplication\n *\n * TARGET: ~100 LOC\n * CURRENT: Scaffolding with TODO markers\n */\n\nimport { existsSync, mkdirSync, readdirSync, readFileSync, statSync, unlinkSync, writeFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport { gunzipSync, gzipSync } from \"node:zlib\";\nimport { generateSnapshotId } from \"@snapback/contracts/id-generator\";\nimport { sha256 } from \"@snapback-oss/sdk\";\nimport { eventBus } from \"./events.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Snapshot manifest stored as JSON\n *\n * REFERENCE: packages/sdk/src/storage/types.ts\n */\nexport interface SnapshotManifest {\n\t/** Unique snapshot ID */\n\tid: string;\n\t/** Creation timestamp */\n\tcreatedAt: number;\n\t/** Files included in this snapshot */\n\tfiles: Array<{\n\t\t/** Original file path (relative to workspace) */\n\t\tpath: string;\n\t\t/** SHA-256 hash of content (blob ID) */\n\t\tblobId: string;\n\t\t/** Original file size in bytes */\n\t\tsize: number;\n\t}>;\n\t/** Total size of all files */\n\ttotalSize: number;\n\t/** Optional description */\n\tdescription?: string;\n\t/** Trigger that caused this snapshot */\n\ttrigger?: \"manual\" | \"auto\" | \"ai-detection\";\n}\n\n/**\n * Storage configuration\n */\nexport interface StorageConfig {\n\t/** Root directory for storage */\n\trootDir: string;\n\t/** Enable compression for blobs */\n\tcompress: boolean;\n}\n\n// =============================================================================\n// STORAGE IMPLEMENTATION\n// =============================================================================\n\n/**\n * Simplified storage layer for snapshots and blobs.\n *\n * Directory structure:\n * ```\n * .snapback/\n *  snapshots/\n *     snap_1234.json   # Manifest\n *     snap_5678.json\n *  blobs/\n *      ab/\n *         cdef1234...  # Content-addressable blob\n *      cd/\n *          ef5678...\n * ```\n *\n * Usage:\n * ```typescript\n * const storage = new Storage({ rootDir: \".snapback\", compress: true });\n *\n * const snapshot = await storage.createSnapshot([\n *   { path: \"src/auth.ts\", content: \"...\" },\n *   { path: \"src/user.ts\", content: \"...\" },\n * ]);\n *\n * await storage.restore(snapshot.id);\n * ```\n */\nexport class Storage {\n\tprivate config: StorageConfig;\n\tprivate snapshotsDir: string;\n\tprivate blobsDir: string;\n\n\tconstructor(config: StorageConfig) {\n\t\tthis.config = config;\n\t\tthis.snapshotsDir = join(config.rootDir, \"snapshots\");\n\t\tthis.blobsDir = join(config.rootDir, \"blobs\");\n\n\t\t// Ensure directories exist\n\t\tthis.ensureDir(this.snapshotsDir);\n\t\tthis.ensureDir(this.blobsDir);\n\t}\n\n\t/**\n\t * Create a snapshot of the given files\n\t *\n\t * REFERENCE: packages/sdk/src/storage/StorageBroker.ts createSnapshot()\n\t *\n\t * @param files - Files to snapshot\n\t * @param options - Snapshot options\n\t * @returns Created snapshot manifest\n\t */\n\tasync createSnapshot(\n\t\tfiles: Array<{ path: string; content: string }>,\n\t\toptions: {\n\t\t\tdescription?: string;\n\t\t\ttrigger?: \"manual\" | \"auto\" | \"ai-detection\";\n\t\t} = {},\n\t): Promise<SnapshotManifest> {\n\t\t// Use canonical ID generator from contracts - includes description in ID for readability\n\t\tconst id = generateSnapshotId(options.description);\n\t\tconst manifestFiles: SnapshotManifest[\"files\"] = [];\n\t\tlet totalSize = 0;\n\n\t\t// Store each file as a blob\n\t\tfor (const file of files) {\n\t\t\tconst blobId = await this.storeBlob(file.content);\n\t\t\tconst size = Buffer.byteLength(file.content, \"utf8\");\n\n\t\t\tmanifestFiles.push({\n\t\t\t\tpath: file.path,\n\t\t\t\tblobId,\n\t\t\t\tsize,\n\t\t\t});\n\n\t\t\ttotalSize += size;\n\t\t}\n\n\t\t// Create manifest\n\t\tconst manifest: SnapshotManifest = {\n\t\t\tid,\n\t\t\tcreatedAt: Date.now(),\n\t\t\tfiles: manifestFiles,\n\t\t\ttotalSize,\n\t\t\tdescription: options.description,\n\t\t\ttrigger: options.trigger,\n\t\t};\n\n\t\t// Write manifest\n\t\tconst manifestPath = join(this.snapshotsDir, `${id}.json`);\n\t\twriteFileSync(manifestPath, JSON.stringify(manifest, null, 2));\n\n\t\t// Emit event (map ai-detection to risk for event type)\n\t\tconst triggerType = options.trigger === \"ai-detection\" ? \"risk\" : options.trigger || \"auto\";\n\t\teventBus.emit(\"snapshot.created\", {\n\t\t\tsnapshotId: id,\n\t\t\tfileCount: files.length,\n\t\t\ttotalBytes: totalSize,\n\t\t\ttrigger: triggerType,\n\t\t\triskScore: 0, // TODO: Pass from caller\n\t\t});\n\n\t\treturn manifest;\n\t}\n\n\t/**\n\t * Restore files from a snapshot\n\t *\n\t * REFERENCE: packages/sdk/src/storage/StorageBroker.ts restore()\n\t *\n\t * @param snapshotId - Snapshot ID to restore\n\t * @returns Restored file contents\n\t */\n\tasync restore(snapshotId: string): Promise<Array<{ path: string; content: string }>> {\n\t\tconst manifest = this.getSnapshot(snapshotId);\n\t\tif (!manifest) {\n\t\t\tthrow new Error(`Snapshot not found: ${snapshotId}`);\n\t\t}\n\n\t\tconst files: Array<{ path: string; content: string }> = [];\n\n\t\tfor (const file of manifest.files) {\n\t\t\tconst content = await this.getBlob(file.blobId);\n\t\t\tif (content !== null) {\n\t\t\t\tfiles.push({ path: file.path, content });\n\t\t\t}\n\t\t}\n\n\t\t// Emit event\n\t\teventBus.emit(\"snapshot.restored\", {\n\t\t\tsnapshotId,\n\t\t\tfilesRestored: files.length,\n\t\t\tduration: 0, // TODO: Track duration\n\t\t});\n\n\t\treturn files;\n\t}\n\n\t/**\n\t * Get a snapshot manifest by ID\n\t */\n\tgetSnapshot(snapshotId: string): SnapshotManifest | null {\n\t\tconst manifestPath = join(this.snapshotsDir, `${snapshotId}.json`);\n\n\t\tif (!existsSync(manifestPath)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst content = readFileSync(manifestPath, \"utf8\");\n\t\treturn JSON.parse(content) as SnapshotManifest;\n\t}\n\n\t/**\n\t * List all snapshots\n\t */\n\tlistSnapshots(): SnapshotManifest[] {\n\t\tif (!existsSync(this.snapshotsDir)) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst files = readdirSync(this.snapshotsDir).filter((f) => f.endsWith(\".json\"));\n\n\t\treturn files\n\t\t\t.map((f) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst content = readFileSync(join(this.snapshotsDir, f), \"utf8\");\n\t\t\t\t\treturn JSON.parse(content) as SnapshotManifest;\n\t\t\t\t} catch {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t})\n\t\t\t.filter((m): m is SnapshotManifest => m !== null)\n\t\t\t.sort((a, b) => b.createdAt - a.createdAt);\n\t}\n\n\t/**\n\t * Delete a snapshot (manifest only, blobs are orphaned)\n\t *\n\t * Note: Use garbageCollectBlobs() after deleting snapshots to reclaim space.\n\t */\n\tdeleteSnapshot(snapshotId: string): boolean {\n\t\tconst manifestPath = join(this.snapshotsDir, `${snapshotId}.json`);\n\n\t\tif (!existsSync(manifestPath)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tunlinkSync(manifestPath);\n\t\treturn true;\n\t}\n\n\t/**\n\t * Garbage collect orphaned blobs.\n\t *\n\t * Scans all blobs and removes those not referenced by any snapshot.\n\t * Returns statistics about the cleanup operation.\n\t *\n\t * @param dryRun - If true, only report what would be deleted without actually deleting\n\t */\n\tgarbageCollectBlobs(dryRun = true): {\n\t\ttotalBlobs: number;\n\t\torphanedBlobs: number;\n\t\tdeletedBlobs: number;\n\t\tbytesReclaimed: number;\n\t\torphanedPaths: string[];\n\t} {\n\t\tconst snapshots = this.listSnapshots();\n\n\t\t// Collect all referenced blob IDs from active snapshots\n\t\tconst referencedBlobs = new Set<string>();\n\t\tfor (const snap of snapshots) {\n\t\t\tfor (const file of snap.files) {\n\t\t\t\treferencedBlobs.add(file.blobId);\n\t\t\t}\n\t\t}\n\n\t\t// Scan blobs directory for all blobs\n\t\tconst allBlobs: Array<{ hash: string; path: string; size: number }> = [];\n\t\tif (existsSync(this.blobsDir)) {\n\t\t\tconst shards = readdirSync(this.blobsDir).filter((f) => f.length === 2);\n\t\t\tfor (const shard of shards) {\n\t\t\t\tconst shardPath = join(this.blobsDir, shard);\n\t\t\t\ttry {\n\t\t\t\t\tconst blobs = readdirSync(shardPath);\n\t\t\t\t\tfor (const blobHash of blobs) {\n\t\t\t\t\t\tconst blobPath = join(shardPath, blobHash);\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst stats = statSync(blobPath);\n\t\t\t\t\t\t\tif (stats.isFile()) {\n\t\t\t\t\t\t\t\tallBlobs.push({ hash: blobHash, path: blobPath, size: stats.size });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Skip if stat fails\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Skip if readdir fails\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Find orphaned blobs (not referenced by any snapshot)\n\t\tconst orphaned = allBlobs.filter((b) => !referencedBlobs.has(b.hash));\n\t\tconst orphanedPaths = orphaned.map((b) => b.path);\n\t\tlet bytesReclaimed = orphaned.reduce((sum, b) => sum + b.size, 0);\n\t\tlet deletedBlobs = 0;\n\n\t\t// Delete orphaned blobs if not dry run\n\t\tif (!dryRun) {\n\t\t\tfor (const blob of orphaned) {\n\t\t\t\ttry {\n\t\t\t\t\tunlinkSync(blob.path);\n\t\t\t\t\tdeletedBlobs++;\n\t\t\t\t} catch {\n\t\t\t\t\t// Reduce reclaimed bytes if delete fails\n\t\t\t\t\tbytesReclaimed -= blob.size;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\ttotalBlobs: allBlobs.length,\n\t\t\torphanedBlobs: orphaned.length,\n\t\t\tdeletedBlobs: dryRun ? 0 : deletedBlobs,\n\t\t\tbytesReclaimed: dryRun ? bytesReclaimed : bytesReclaimed,\n\t\t\torphanedPaths: dryRun ? orphanedPaths : [],\n\t\t};\n\t}\n\n\t/**\n\t * Prune old snapshots based on retention policy.\n\t *\n\t * @param maxAgeDays - Delete snapshots older than this many days\n\t * @param keepCount - Always keep at least this many snapshots (regardless of age)\n\t * @param dryRun - If true, only report what would be deleted\n\t */\n\tpruneSnapshots(\n\t\tmaxAgeDays = 30,\n\t\tkeepCount = 10,\n\t\tdryRun = true,\n\t): {\n\t\ttotalSnapshots: number;\n\t\tstaleSnapshots: number;\n\t\tdeletedSnapshots: number;\n\t\tdeletedIds: string[];\n\t} {\n\t\tconst snapshots = this.listSnapshots(); // Already sorted by createdAt desc\n\t\tconst cutoff = Date.now() - maxAgeDays * 24 * 60 * 60 * 1000;\n\n\t\t// Keep at least keepCount snapshots, then apply age filter\n\t\tconst candidates = snapshots.slice(keepCount);\n\t\tconst stale = candidates.filter((s) => s.createdAt < cutoff);\n\t\tconst deletedIds: string[] = [];\n\n\t\tif (!dryRun) {\n\t\t\tfor (const snap of stale) {\n\t\t\t\tif (this.deleteSnapshot(snap.id)) {\n\t\t\t\t\tdeletedIds.push(snap.id);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\ttotalSnapshots: snapshots.length,\n\t\t\tstaleSnapshots: stale.length,\n\t\t\tdeletedSnapshots: dryRun ? 0 : deletedIds.length,\n\t\t\tdeletedIds: dryRun ? stale.map((s) => s.id) : deletedIds,\n\t\t};\n\t}\n\n\t// ===========================================================================\n\t// PRIVATE HELPERS\n\t// ===========================================================================\n\n\t/**\n\t * Store content as a blob, returns blob ID (SHA-256)\n\t *\n\t * REFERENCE: packages/sdk/src/storage/BlobStore.ts\n\t */\n\tprivate async storeBlob(content: string): Promise<string> {\n\t\t// Calculate content hash using consolidated hash utility\n\t\tconst hash = sha256(content);\n\n\t\t// Determine blob path (sharded by first 2 chars)\n\t\tconst blobDir = join(this.blobsDir, hash.slice(0, 2));\n\t\tconst blobPath = join(blobDir, hash);\n\n\t\t// Skip if already exists (content-addressable dedup)\n\t\tif (existsSync(blobPath)) {\n\t\t\treturn hash;\n\t\t}\n\n\t\t// Ensure directory exists\n\t\tthis.ensureDir(blobDir);\n\n\t\t// Optionally compress\n\t\tconst data = this.config.compress ? gzipSync(Buffer.from(content, \"utf8\")) : Buffer.from(content, \"utf8\");\n\n\t\t// Write blob\n\t\twriteFileSync(blobPath, data);\n\n\t\treturn hash;\n\t}\n\n\t/**\n\t * Retrieve blob content by ID\n\t */\n\tprivate async getBlob(blobId: string): Promise<string | null> {\n\t\tconst blobPath = join(this.blobsDir, blobId.slice(0, 2), blobId);\n\n\t\tif (!existsSync(blobPath)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst data = readFileSync(blobPath);\n\n\t\t// Decompress if needed\n\t\ttry {\n\t\t\tconst decompressed = gunzipSync(data);\n\t\t\treturn decompressed.toString(\"utf8\");\n\t\t} catch {\n\t\t\t// Not compressed, return as-is\n\t\t\treturn data.toString(\"utf8\");\n\t\t}\n\t}\n\n\t/**\n\t * Ensure directory exists (race-condition safe)\n\t *\n\t * Uses atomic mkdir without prior existence check to avoid TOCTOU race.\n\t * Multiple concurrent calls to mkdirSync on the same path can cause EACCES\n\t * when one process wins and the other finds the directory locked.\n\t *\n\t * @see SNAPBACK_PERMISSION_ERROR_DIAGNOSIS.md for race condition details\n\t */\n\tprivate ensureDir(dir: string): void {\n\t\ttry {\n\t\t\tmkdirSync(dir, { recursive: true });\n\t\t} catch (error) {\n\t\t\t// Handle race condition: another process created the directory\n\t\t\t// between our check and mkdir, or we have a real permission error\n\t\t\tconst errno = error as NodeJS.ErrnoException;\n\t\t\tif (errno.code !== \"EEXIST\") {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t\t// EEXIST is expected in race condition - directory now exists, success\n\t\t}\n\t}\n}\n\n// =============================================================================\n// FACTORY FUNCTION (Replaces module-level singleton)\n// =============================================================================\n\n/**\n * Storage instance cache per workspace root.\n * Prevents race conditions from multiple concurrent Storage constructions.\n *\n * Key: normalized workspace root path\n * Value: Storage instance\n *\n * @see SNAPBACK_PERMISSION_ERROR_DIAGNOSIS.md for race condition details\n */\nconst storageCache = new Map<string, Storage>();\n\n/**\n * Create or retrieve a cached storage instance for the given workspace root.\n *\n * Uses instance caching to:\n * 1. Prevent race conditions from concurrent Storage constructions\n * 2. Avoid redundant directory creation operations\n * 3. Improve performance by reusing instances\n *\n * NOTE: We don't export a default singleton because:\n * 1. It would execute mkdirSync at import time (side effect)\n * 2. The path must be absolute to avoid CWD issues in VS Code extension host\n *\n * @param workspaceRoot - Absolute path to workspace root\n * @param options - Optional configuration overrides\n */\nexport function createStorage(workspaceRoot: string, options: Partial<StorageConfig> = {}): Storage {\n\t// Normalize path for consistent cache key\n\tconst cacheKey = workspaceRoot;\n\n\t// Return cached instance if available\n\tconst cached = storageCache.get(cacheKey);\n\tif (cached) {\n\t\treturn cached;\n\t}\n\n\t// Create new instance and cache it\n\tconst config: StorageConfig = {\n\t\trootDir: `${workspaceRoot}/.snapback`,\n\t\tcompress: options.compress ?? true,\n\t};\n\tconst storage = new Storage(config);\n\tstorageCache.set(cacheKey, storage);\n\n\treturn storage;\n}\n\n/**\n * Clear the storage cache (useful for testing)\n */\nexport function clearStorageCache(): void {\n\tstorageCache.clear();\n}\n","/**\n * DependencyGraphService - Cached dependency analysis for token efficiency\n *\n * Uses madge (already installed) to build dependency graph.\n * Caches results to avoid repeated expensive analysis.\n *\n * Token savings: 2-3K tokens per exploration (vs multiple grep calls)\n *\n * @see CONTEXT_ENHANCEMENT_PLAN.md Feature 3\n * @module services/dependency-graph-service\n */\n\nimport { createHash } from \"node:crypto\";\nimport { existsSync, mkdirSync, readFileSync, statSync, writeFileSync } from \"node:fs\";\nimport { join, relative } from \"node:path\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Internal graph representation\n */\ninterface DependencyGraph {\n\tnodes: Record<\n\t\tstring,\n\t\t{\n\t\t\timports: string[];\n\t\t\timportedBy: string[];\n\t\t}\n\t>;\n\tcircular: string[][];\n\tcacheKey: string;\n\tgeneratedAt: number;\n}\n\n/**\n * Dependency context for files (exposed to begin_task)\n */\nexport interface DependencyContext {\n\tplanned: Record<\n\t\tstring,\n\t\t{\n\t\t\timports: string[];\n\t\t\timportedBy: Array<{\n\t\t\t\tfile: string;\n\t\t\t\tline: number;\n\t\t\t}>;\n\t\t\tdepth: number;\n\t\t\tisOrphan: boolean;\n\t\t}\n\t>;\n\tcircular: Array<{\n\t\tcycle: string[];\n\t\tseverity: \"warning\" | \"error\";\n\t}>;\n\tsuggestions: string[];\n}\n\n// =============================================================================\n// DependencyGraphService\n// =============================================================================\n\nexport class DependencyGraphService {\n\tprivate workspaceRoot: string;\n\tprivate cacheDir: string;\n\tprivate graph: DependencyGraph | null = null;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.cacheDir = join(workspaceRoot, \".snapback\", \"analysis\");\n\t}\n\n\t/**\n\t * Get dependency context for planned files\n\t * Main entry point for begin_task integration\n\t */\n\tasync getContextForFiles(files: string[]): Promise<DependencyContext> {\n\t\tconst graph = await this.getGraph();\n\n\t\tconst planned: DependencyContext[\"planned\"] = {};\n\t\tconst suggestions = new Set<string>();\n\n\t\tfor (const file of files) {\n\t\t\tconst relPath = this.toRelative(file);\n\t\t\tconst node = graph.nodes[relPath];\n\n\t\t\tif (node) {\n\t\t\t\tplanned[file] = {\n\t\t\t\t\timports: node.imports,\n\t\t\t\t\timportedBy: node.importedBy.map((f) => ({ file: f, line: 0 })),\n\t\t\t\t\tdepth: this.calculateDepth(relPath, graph),\n\t\t\t\t\tisOrphan: node.importedBy.length === 0 && !this.isEntryPoint(relPath),\n\t\t\t\t};\n\n\t\t\t\t// Suggest related files\n\t\t\t\tnode.importedBy.slice(0, 3).forEach((f) => suggestions.add(f));\n\t\t\t\tnode.imports.slice(0, 3).forEach((f) => suggestions.add(f));\n\t\t\t}\n\t\t}\n\n\t\t// Filter suggestions to exclude already planned files\n\t\tconst relPlanned = files.map((f) => this.toRelative(f));\n\t\tconst filteredSuggestions = [...suggestions].filter((s) => !relPlanned.includes(s)).slice(0, 5);\n\n\t\treturn {\n\t\t\tplanned,\n\t\t\tcircular: graph.circular\n\t\t\t\t.filter((cycle) => files.some((f) => cycle.includes(this.toRelative(f))))\n\t\t\t\t.map((cycle) => ({ cycle, severity: \"warning\" as const })),\n\t\t\tsuggestions: filteredSuggestions,\n\t\t};\n\t}\n\n\t/**\n\t * Get files affected by changes to a file\n\t * Useful for impact analysis\n\t */\n\tasync getAffectedBy(file: string): Promise<string[]> {\n\t\tconst graph = await this.getGraph();\n\t\tconst relPath = this.toRelative(file);\n\t\tconst node = graph.nodes[relPath];\n\t\treturn node?.importedBy || [];\n\t}\n\n\t/**\n\t * Get files that a file depends on\n\t */\n\tasync getDependencies(file: string): Promise<string[]> {\n\t\tconst graph = await this.getGraph();\n\t\tconst relPath = this.toRelative(file);\n\t\tconst node = graph.nodes[relPath];\n\t\treturn node?.imports || [];\n\t}\n\n\t/**\n\t * Get all circular dependencies\n\t */\n\tasync getCircularDependencies(): Promise<string[][]> {\n\t\tconst graph = await this.getGraph();\n\t\treturn graph.circular;\n\t}\n\n\t/**\n\t * Force refresh the graph cache\n\t */\n\tasync refresh(): Promise<void> {\n\t\tthis.graph = null;\n\t\tawait this.getGraph();\n\t}\n\n\t/**\n\t * Check if cache is valid\n\t */\n\tasync isCacheValid(): Promise<boolean> {\n\t\tconst cachePath = join(this.cacheDir, \"dependency-graph.json\");\n\t\tif (!existsSync(cachePath)) return false;\n\n\t\ttry {\n\t\t\tconst cached = JSON.parse(readFileSync(cachePath, \"utf8\")) as DependencyGraph;\n\t\t\tconst currentKey = await this.computeCacheKey();\n\t\t\treturn cached.cacheKey === currentKey;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// Private Methods\n\t// =========================================================================\n\n\t/**\n\t * Get or build the dependency graph\n\t */\n\tprivate async getGraph(): Promise<DependencyGraph> {\n\t\t// Return cached in-memory graph\n\t\tif (this.graph) {\n\t\t\treturn this.graph;\n\t\t}\n\n\t\tconst cachePath = join(this.cacheDir, \"dependency-graph.json\");\n\t\tconst cacheKey = await this.computeCacheKey();\n\n\t\t// Check disk cache\n\t\tif (existsSync(cachePath)) {\n\t\t\ttry {\n\t\t\t\tconst cached = JSON.parse(readFileSync(cachePath, \"utf8\")) as DependencyGraph;\n\t\t\t\tif (cached.cacheKey === cacheKey) {\n\t\t\t\t\tthis.graph = cached;\n\t\t\t\t\treturn cached;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Cache corrupted, rebuild\n\t\t\t}\n\t\t}\n\n\t\t// Rebuild graph\n\t\tconst graph = await this.buildGraph();\n\t\tgraph.cacheKey = cacheKey;\n\t\tgraph.generatedAt = Date.now();\n\n\t\t// Write cache\n\t\tthis.ensureCacheDir();\n\t\twriteFileSync(cachePath, JSON.stringify(graph, null, 2));\n\n\t\tthis.graph = graph;\n\t\treturn graph;\n\t}\n\n\t/**\n\t * Build dependency graph using madge\n\t */\n\tprivate async buildGraph(): Promise<DependencyGraph> {\n\t\ttry {\n\t\t\t// Dynamic import madge (optional dependency)\n\t\t\tconst madgeModule = await import(\"madge\");\n\t\t\tconst madge = madgeModule.default || madgeModule;\n\n\t\t\tconst result = await madge(this.workspaceRoot, {\n\t\t\t\tfileExtensions: [\"ts\", \"tsx\", \"js\", \"jsx\"],\n\t\t\t\texcludeRegExp: [/node_modules/, /dist/, /\\.next/, /coverage/, /__tests__/, /__mocks__/],\n\t\t\t\tdetectiveOptions: { ts: { skipTypeImports: true } },\n\t\t\t});\n\n\t\t\tconst deps = result.obj() as Record<string, string[]>;\n\t\t\tconst circular = result.circular() as string[][];\n\n\t\t\t// Build reverse index (importedBy)\n\t\t\tconst nodes: DependencyGraph[\"nodes\"] = {};\n\n\t\t\tfor (const [file, imports] of Object.entries(deps)) {\n\t\t\t\tif (!nodes[file]) nodes[file] = { imports: [], importedBy: [] };\n\t\t\t\tnodes[file].imports = imports;\n\n\t\t\t\tfor (const imp of imports) {\n\t\t\t\t\tif (!nodes[imp]) nodes[imp] = { imports: [], importedBy: [] };\n\t\t\t\t\tnodes[imp].importedBy.push(file);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { nodes, circular, cacheKey: \"\", generatedAt: 0 };\n\t\t} catch (error) {\n\t\t\t// Madge not available or failed, return empty graph\n\t\t\tconsole.error(\"Failed to build dependency graph:\", error);\n\t\t\treturn { nodes: {}, circular: [], cacheKey: \"\", generatedAt: 0 };\n\t\t}\n\t}\n\n\t/**\n\t * Compute cache key based on source file mtimes\n\t */\n\tprivate async computeCacheKey(): Promise<string> {\n\t\ttry {\n\t\t\tconst glob = await import(\"glob\");\n\t\t\tconst files = await glob.glob([\"**/*.{ts,tsx,js,jsx}\"], {\n\t\t\t\tcwd: this.workspaceRoot,\n\t\t\t\tignore: [\"node_modules/**\", \"dist/**\", \".next/**\", \"coverage/**\"],\n\t\t\t});\n\n\t\t\tconst hash = createHash(\"sha256\");\n\t\t\tfor (const file of files.sort()) {\n\t\t\t\ttry {\n\t\t\t\t\tconst stat = statSync(join(this.workspaceRoot, file));\n\t\t\t\t\thash.update(`${file}:${stat.mtimeMs}`);\n\t\t\t\t} catch {\n\t\t\t\t\t// File may have been deleted\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn hash.digest(\"hex\").substring(0, 16);\n\t\t} catch {\n\t\t\t// Fallback to timestamp-based key\n\t\t\treturn Date.now().toString(36);\n\t\t}\n\t}\n\n\t/**\n\t * Calculate max depth in import tree\n\t */\n\tprivate calculateDepth(file: string, graph: DependencyGraph, visited = new Set<string>()): number {\n\t\tif (visited.has(file)) return 0;\n\t\tvisited.add(file);\n\n\t\tconst node = graph.nodes[file];\n\t\tif (!node || node.imports.length === 0) return 0;\n\n\t\tconst depths = node.imports.map((i) => this.calculateDepth(i, graph, new Set(visited)));\n\t\treturn 1 + Math.max(0, ...depths);\n\t}\n\n\t/**\n\t * Check if file is an entry point (not expected to have importers)\n\t */\n\tprivate isEntryPoint(file: string): boolean {\n\t\treturn (\n\t\t\tfile.includes(\"index.\") ||\n\t\t\tfile.includes(\"main.\") ||\n\t\t\tfile.includes(\"entry.\") ||\n\t\t\tfile.includes(\"server.\") ||\n\t\t\tfile.includes(\"app.\") ||\n\t\t\tfile.endsWith(\"/page.tsx\") ||\n\t\t\tfile.endsWith(\"/layout.tsx\") ||\n\t\t\tfile.endsWith(\"/route.ts\")\n\t\t);\n\t}\n\n\t/**\n\t * Convert absolute path to relative\n\t */\n\tprivate toRelative(file: string): string {\n\t\tif (file.startsWith(this.workspaceRoot)) {\n\t\t\treturn relative(this.workspaceRoot, file);\n\t\t}\n\t\treturn file;\n\t}\n\n\t/**\n\t * Ensure cache directory exists\n\t */\n\tprivate ensureCacheDir(): void {\n\t\tif (!existsSync(this.cacheDir)) {\n\t\t\tmkdirSync(this.cacheDir, { recursive: true });\n\t\t}\n\t}\n}\n\n// =============================================================================\n// Factory\n// =============================================================================\n\n/**\n * Create DependencyGraphService instance\n */\nexport function createDependencyGraphService(workspaceRoot: string): DependencyGraphService {\n\treturn new DependencyGraphService(workspaceRoot);\n}\n\n// =============================================================================\n// Singleton per workspace\n// =============================================================================\n\nconst services = new Map<string, DependencyGraphService>();\n\n/**\n * Get or create service for workspace (singleton pattern)\n */\nexport function getDependencyGraphService(workspaceRoot: string): DependencyGraphService {\n\tif (!services.has(workspaceRoot)) {\n\t\tservices.set(workspaceRoot, new DependencyGraphService(workspaceRoot));\n\t}\n\treturn services.get(workspaceRoot)!;\n}\n","/**\n * ErrorCacheService - Persist and retrieve error state\n *\n * Caches TypeScript, test, and lint errors to reduce token waste\n * when agents re-discover known issues.\n *\n * Storage: .snapback/errors/{source}.jsonl\n * Retention: 7 days or 100 entries per type\n *\n * @module services/error-cache-service\n */\n\nimport { appendFileSync, existsSync, mkdirSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport type { CachedError } from \"../types/context.js\";\n\n// =============================================================================\n// Constants\n// =============================================================================\n\n/** Maximum age for cached errors (7 days in ms) */\nconst MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;\n\n/** Maximum entries per source type */\nconst MAX_ENTRIES_PER_SOURCE = 100;\n\n/** Valid source types */\nconst SOURCE_TYPES = [\"typescript\", \"test\", \"lint\", \"runtime\"] as const;\n\n// =============================================================================\n// Utility Functions\n// =============================================================================\n\n/**\n * Format milliseconds into human-readable age string\n */\nfunction formatAge(ms: number): string {\n\tconst seconds = Math.floor(ms / 1000);\n\tconst minutes = Math.floor(seconds / 60);\n\tconst hours = Math.floor(minutes / 60);\n\tconst days = Math.floor(hours / 24);\n\n\tif (days > 0) return `${days}d`;\n\tif (hours > 0) return `${hours}h`;\n\tif (minutes > 0) return `${minutes}m`;\n\treturn `${seconds}s`;\n}\n\n/**\n * Create unique key for deduplication\n */\nfunction errorKey(error: CachedError): string {\n\treturn `${error.file}:${error.line}:${error.message}`;\n}\n\n/**\n * Ensure directory exists\n */\nfunction ensureDirSync(dir: string): void {\n\tif (!existsSync(dir)) {\n\t\tmkdirSync(dir, { recursive: true });\n\t}\n}\n\n// =============================================================================\n// ErrorCacheService\n// =============================================================================\n\nexport class ErrorCacheService {\n\tprivate workspaceRoot: string;\n\tprivate cacheDir: string;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.cacheDir = join(workspaceRoot, \".snapback\", \"errors\");\n\t}\n\n\t/**\n\t * Cache errors after validation operations\n\t *\n\t * Called by quick_check after TypeScript/test/lint validation.\n\t * Errors are grouped by source and appended to JSONL files.\n\t */\n\tcacheErrors(errors: CachedError[]): void {\n\t\tif (errors.length === 0) return;\n\n\t\tensureDirSync(this.cacheDir);\n\n\t\t// Group errors by source\n\t\tconst grouped = new Map<string, CachedError[]>();\n\t\tfor (const error of errors) {\n\t\t\tconst source = error.source || \"general\";\n\t\t\tif (!grouped.has(source)) {\n\t\t\t\tgrouped.set(source, []);\n\t\t\t}\n\t\t\tgrouped.get(source)!.push(error);\n\t\t}\n\n\t\t// Write each group to its JSONL file\n\t\tconst timestamp = Date.now();\n\t\tfor (const [source, sourceErrors] of grouped) {\n\t\t\tconst filePath = join(this.cacheDir, `${source}.jsonl`);\n\t\t\tconst lines = sourceErrors.map((e) => JSON.stringify({ ...e, timestamp })).join(\"\\n\") + \"\\n\";\n\t\t\tappendFileSync(filePath, lines, \"utf8\");\n\t\t}\n\t}\n\n\t/**\n\t * Get cached errors for specific files\n\t *\n\t * Called by begin_task to surface known issues for planned files.\n\t * Returns errors within retention window, deduplicated.\n\t */\n\tgetErrorsForFiles(files: string[]): Array<CachedError & { age: string }> {\n\t\tconst errors: Array<CachedError & { age: string }> = [];\n\t\tconst now = Date.now();\n\t\tconst seen = new Set<string>();\n\n\t\tfor (const source of SOURCE_TYPES) {\n\t\t\tconst filePath = join(this.cacheDir, `${source}.jsonl`);\n\t\t\tif (!existsSync(filePath)) continue;\n\n\t\t\ttry {\n\t\t\t\tconst content = readFileSync(filePath, \"utf8\");\n\t\t\t\tconst lines = content.split(\"\\n\").filter(Boolean);\n\n\t\t\t\tfor (const line of lines) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst error = JSON.parse(line) as CachedError;\n\n\t\t\t\t\t\t// Skip errors older than max age\n\t\t\t\t\t\tif (now - error.timestamp > MAX_AGE_MS) continue;\n\n\t\t\t\t\t\t// Check if error matches any requested file\n\t\t\t\t\t\tconst matchesFile = files.some(\n\t\t\t\t\t\t\t(f) => error.file.includes(f) || f.includes(error.file) || error.file === f,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (!matchesFile) continue;\n\n\t\t\t\t\t\t// Deduplicate by key\n\t\t\t\t\t\tconst key = errorKey(error);\n\t\t\t\t\t\tif (seen.has(key)) continue;\n\t\t\t\t\t\tseen.add(key);\n\n\t\t\t\t\t\terrors.push({\n\t\t\t\t\t\t\t...error,\n\t\t\t\t\t\t\tage: formatAge(now - error.timestamp),\n\t\t\t\t\t\t});\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Skip invalid JSON lines\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Skip unreadable files\n\t\t\t}\n\t\t}\n\n\t\treturn errors;\n\t}\n\n\t/**\n\t * Remove stale entries from cache\n\t *\n\t * Called periodically or on session end.\n\t * Removes entries older than 7 days and limits to 100 per source.\n\t */\n\tprune(): { removed: number } {\n\t\tlet removed = 0;\n\t\tconst now = Date.now();\n\n\t\tfor (const source of SOURCE_TYPES) {\n\t\t\tconst filePath = join(this.cacheDir, `${source}.jsonl`);\n\t\t\tif (!existsSync(filePath)) continue;\n\n\t\t\ttry {\n\t\t\t\tconst content = readFileSync(filePath, \"utf8\");\n\t\t\t\tconst lines = content.split(\"\\n\").filter(Boolean);\n\n\t\t\t\t// Parse and filter valid entries\n\t\t\t\tconst entries: CachedError[] = [];\n\t\t\t\tfor (const line of lines) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst error = JSON.parse(line) as CachedError;\n\t\t\t\t\t\tif (now - error.timestamp <= MAX_AGE_MS) {\n\t\t\t\t\t\t\tentries.push(error);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tremoved++;\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tremoved++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Sort by timestamp (most recent first) and limit\n\t\t\t\tentries.sort((a, b) => b.timestamp - a.timestamp);\n\t\t\t\tconst kept = entries.slice(0, MAX_ENTRIES_PER_SOURCE);\n\t\t\t\tremoved += entries.length - kept.length;\n\n\t\t\t\t// Rewrite file with kept entries\n\t\t\t\tif (kept.length > 0) {\n\t\t\t\t\twriteFileSync(filePath, kept.map((e) => JSON.stringify(e)).join(\"\\n\") + \"\\n\", \"utf8\");\n\t\t\t\t} else {\n\t\t\t\t\twriteFileSync(filePath, \"\", \"utf8\");\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Skip files that can't be processed\n\t\t\t}\n\t\t}\n\n\t\treturn { removed };\n\t}\n\n\t/**\n\t * Clear all cached errors for a specific file\n\t *\n\t * Called when a file is successfully validated with no errors.\n\t */\n\tclearForFile(file: string): void {\n\t\tfor (const source of SOURCE_TYPES) {\n\t\t\tconst filePath = join(this.cacheDir, `${source}.jsonl`);\n\t\t\tif (!existsSync(filePath)) continue;\n\n\t\t\ttry {\n\t\t\t\tconst content = readFileSync(filePath, \"utf8\");\n\t\t\t\tconst lines = content.split(\"\\n\").filter(Boolean);\n\n\t\t\t\t// Filter out errors for the specified file\n\t\t\t\tconst kept: CachedError[] = [];\n\t\t\t\tfor (const line of lines) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst error = JSON.parse(line) as CachedError;\n\t\t\t\t\t\tif (error.file !== file && !error.file.includes(file) && !file.includes(error.file)) {\n\t\t\t\t\t\t\tkept.push(error);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Skip invalid lines\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Rewrite file\n\t\t\t\twriteFileSync(\n\t\t\t\t\tfilePath,\n\t\t\t\t\tkept.map((e) => JSON.stringify(e)).join(\"\\n\") + (kept.length > 0 ? \"\\n\" : \"\"),\n\t\t\t\t\t\"utf8\",\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\t// Skip files that can't be processed\n\t\t\t}\n\t\t}\n\t}\n}\n\n// =============================================================================\n// Factory\n// =============================================================================\n\n/**\n * Create an ErrorCacheService instance\n */\nexport function createErrorCacheService(workspaceRoot: string): ErrorCacheService {\n\treturn new ErrorCacheService(workspaceRoot);\n}\n","/**\n * GitContextService - Extract git change context\n *\n * Provides git status, branch info, recent commits, and file history\n * to help agents understand change context without re-discovery.\n *\n * @module services/git-context-service\n */\n\nimport { execSync } from \"node:child_process\";\nimport type {\n\tFileHistory,\n\tGitBranch,\n\tGitContext,\n\tRecentCommit,\n\tStagedChange,\n\tUncommittedChange,\n} from \"../types/context.js\";\n\n// =============================================================================\n// Constants\n// =============================================================================\n\n/** Maximum recent commits to include */\nconst MAX_RECENT_COMMITS = 5;\n\n/** Git command timeout in milliseconds */\nconst GIT_TIMEOUT_MS = 5000;\n\n// =============================================================================\n// GitContextService\n// =============================================================================\n\nexport class GitContextService {\n\tprivate workspaceRoot: string;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t}\n\n\t/**\n\t * Get complete git context for planned files\n\t *\n\t * Called by begin_task to surface git change context.\n\t */\n\tasync getContext(plannedFiles: string[]): Promise<GitContext> {\n\t\ttry {\n\t\t\tconst branch = this.getBranchInfo();\n\t\t\tconst uncommittedChanges = this.getUncommittedChanges();\n\t\t\tconst stagedChanges = this.getStagedChanges();\n\t\t\tconst recentCommits = this.getRecentCommits(plannedFiles);\n\t\t\tconst fileHistory = this.getFileHistory(plannedFiles, uncommittedChanges);\n\n\t\t\treturn {\n\t\t\t\tbranch,\n\t\t\t\tuncommittedChanges,\n\t\t\t\tstagedChanges,\n\t\t\t\trecentCommits,\n\t\t\t\tfileHistory,\n\t\t\t};\n\t\t} catch {\n\t\t\t// Return empty context if git fails\n\t\t\treturn this.emptyContext();\n\t\t}\n\t}\n\n\t/**\n\t * Check if workspace is a git repository\n\t */\n\tasync isGitRepo(): Promise<boolean> {\n\t\ttry {\n\t\t\tthis.git(\"rev-parse --git-dir\");\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t// ===========================================================================\n\t// Private Methods\n\t// ===========================================================================\n\n\t/**\n\t * Get branch information\n\t */\n\tprivate getBranchInfo(): GitBranch {\n\t\ttry {\n\t\t\tconst current = this.git(\"rev-parse --abbrev-ref HEAD\").trim();\n\t\t\tconst upstream = this.gitSafe(\"rev-parse --abbrev-ref @{u}\")?.trim();\n\t\t\tlet ahead = 0;\n\t\t\tlet behind = 0;\n\n\t\t\tif (upstream) {\n\t\t\t\ttry {\n\t\t\t\t\tconst counts = this.git(`rev-list --left-right --count ${current}...${upstream}`);\n\t\t\t\t\tconst parts = counts.trim().split(/\\s+/);\n\t\t\t\t\tif (parts.length >= 2) {\n\t\t\t\t\t\tahead = Number.parseInt(parts[0], 10) || 0;\n\t\t\t\t\t\tbehind = Number.parseInt(parts[1], 10) || 0;\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore errors getting ahead/behind counts\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { current, upstream, ahead, behind };\n\t\t} catch {\n\t\t\treturn { current: \"\", ahead: 0, behind: 0 };\n\t\t}\n\t}\n\n\t/**\n\t * Get uncommitted changes in working tree\n\t */\n\tprivate getUncommittedChanges(): UncommittedChange[] {\n\t\ttry {\n\t\t\tconst status = this.git(\"status --porcelain\");\n\t\t\tconst changes: UncommittedChange[] = [];\n\n\t\t\tfor (const line of status.split(\"\\n\")) {\n\t\t\t\tif (!line.trim()) continue;\n\n\t\t\t\t// Git status format: XY filename\n\t\t\t\t// X = staging area status, Y = working tree status\n\t\t\t\tconst statusCode = line.substring(0, 2);\n\t\t\t\tconst file = line.substring(3).trim();\n\n\t\t\t\t// Determine the primary status\n\t\t\t\tlet status: UncommittedChange[\"status\"];\n\t\t\t\tif (statusCode.includes(\"?\")) {\n\t\t\t\t\tstatus = \"?\";\n\t\t\t\t} else if (statusCode.includes(\"A\")) {\n\t\t\t\t\tstatus = \"A\";\n\t\t\t\t} else if (statusCode.includes(\"D\")) {\n\t\t\t\t\tstatus = \"D\";\n\t\t\t\t} else if (statusCode.includes(\"R\")) {\n\t\t\t\t\tstatus = \"R\";\n\t\t\t\t} else if (statusCode.includes(\"C\")) {\n\t\t\t\t\tstatus = \"C\";\n\t\t\t\t} else if (statusCode.includes(\"U\")) {\n\t\t\t\t\tstatus = \"U\";\n\t\t\t\t} else {\n\t\t\t\t\tstatus = \"M\";\n\t\t\t\t}\n\n\t\t\t\tchanges.push({ file, status });\n\t\t\t}\n\n\t\t\treturn changes;\n\t\t} catch {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Get staged changes (ready to commit)\n\t */\n\tprivate getStagedChanges(): StagedChange[] {\n\t\ttry {\n\t\t\tconst status = this.git(\"diff --cached --name-status\");\n\t\t\tconst changes: StagedChange[] = [];\n\n\t\t\tfor (const line of status.split(\"\\n\")) {\n\t\t\t\tif (!line.trim()) continue;\n\n\t\t\t\tconst parts = line.split(\"\\t\");\n\t\t\t\tif (parts.length < 2) continue;\n\n\t\t\t\tconst statusCode = parts[0].charAt(0) as StagedChange[\"status\"];\n\t\t\t\tconst file = parts[1].trim();\n\n\t\t\t\tif ([\"A\", \"M\", \"D\", \"R\"].includes(statusCode)) {\n\t\t\t\t\tchanges.push({ file, status: statusCode });\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn changes;\n\t\t} catch {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Get recent commits\n\t */\n\tprivate getRecentCommits(plannedFiles: string[]): RecentCommit[] {\n\t\ttry {\n\t\t\tconst format = '\"%H|%s|%an|%ar|%ct\"';\n\t\t\tconst log = this.git(`log -10 --pretty=format:${format} --name-only`);\n\t\t\tconst commits: RecentCommit[] = [];\n\n\t\t\t// Parse git log output (entries separated by blank lines)\n\t\t\tconst entries = log.split(\"\\n\\n\").filter(Boolean);\n\n\t\t\tfor (const entry of entries) {\n\t\t\t\tconst lines = entry.split(\"\\n\");\n\t\t\t\tif (lines.length === 0) continue;\n\n\t\t\t\t// Parse commit info line\n\t\t\t\tconst infoLine = lines[0].replace(/^\"|\"$/g, \"\");\n\t\t\t\tconst parts = infoLine.split(\"|\");\n\t\t\t\tif (parts.length < 5) continue;\n\n\t\t\t\tconst [fullHash, message, author, date] = parts;\n\t\t\t\tconst files = lines.slice(1).filter(Boolean);\n\n\t\t\t\t// Check if any commit files match planned files\n\t\t\t\tconst affectsPlannedFiles =\n\t\t\t\t\tplannedFiles.length > 0 &&\n\t\t\t\t\tfiles.some((f) => plannedFiles.some((pf) => f.includes(pf) || pf.includes(f)));\n\n\t\t\t\tcommits.push({\n\t\t\t\t\thash: fullHash.substring(0, 7),\n\t\t\t\t\tmessage,\n\t\t\t\t\tauthor,\n\t\t\t\t\tdate,\n\t\t\t\t\tfilesChanged: files.length,\n\t\t\t\t\taffectsPlannedFiles,\n\t\t\t\t});\n\n\t\t\t\tif (commits.length >= MAX_RECENT_COMMITS) break;\n\t\t\t}\n\n\t\t\treturn commits;\n\t\t} catch {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Get file history for planned files\n\t */\n\tprivate getFileHistory(files: string[], uncommittedChanges: UncommittedChange[]): Record<string, FileHistory> {\n\t\tconst history: Record<string, FileHistory> = {};\n\n\t\tfor (const file of files) {\n\t\t\ttry {\n\t\t\t\tconst lastCommit = this.gitSafe(`log -1 --pretty=format:\"%H\" -- \"${file}\"`);\n\t\t\t\tconst lastModified = this.gitSafe(`log -1 --pretty=format:\"%ar\" -- \"${file}\"`);\n\t\t\t\tconst isModifiedByUser = uncommittedChanges.some(\n\t\t\t\t\t(c) => c.file === file || c.file.includes(file) || file.includes(c.file),\n\t\t\t\t);\n\n\t\t\t\thistory[file] = {\n\t\t\t\t\tlastModified: lastModified?.trim().replace(/^\"|\"$/g, \"\") || \"unknown\",\n\t\t\t\t\tlastCommit: lastCommit?.trim().replace(/^\"|\"$/g, \"\").substring(0, 7) || \"none\",\n\t\t\t\t\tmodifiedByUser: isModifiedByUser,\n\t\t\t\t};\n\t\t\t} catch {\n\t\t\t\thistory[file] = {\n\t\t\t\t\tlastModified: \"unknown\",\n\t\t\t\t\tlastCommit: \"none\",\n\t\t\t\t\tmodifiedByUser: false,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn history;\n\t}\n\n\t/**\n\t * Execute git command and return output\n\t */\n\tprivate git(cmd: string): string {\n\t\treturn execSync(`git ${cmd}`, {\n\t\t\tcwd: this.workspaceRoot,\n\t\t\tencoding: \"utf8\",\n\t\t\ttimeout: GIT_TIMEOUT_MS,\n\t\t\tstdio: [\"pipe\", \"pipe\", \"pipe\"],\n\t\t});\n\t}\n\n\t/**\n\t * Execute git command, returning null on failure\n\t */\n\tprivate gitSafe(cmd: string): string | null {\n\t\ttry {\n\t\t\treturn this.git(cmd);\n\t\t} catch {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Return empty context structure\n\t */\n\tprivate emptyContext(): GitContext {\n\t\treturn {\n\t\t\tbranch: { current: \"\", ahead: 0, behind: 0 },\n\t\t\tuncommittedChanges: [],\n\t\t\tstagedChanges: [],\n\t\t\trecentCommits: [],\n\t\t\tfileHistory: {},\n\t\t};\n\t}\n}\n\n// =============================================================================\n// Factory\n// =============================================================================\n\n/**\n * Create a GitContextService instance\n */\nexport function createGitContextService(workspaceRoot: string): GitContextService {\n\treturn new GitContextService(workspaceRoot);\n}\n","/**\n * LearningSeeder - Initialize tiered learning files for a workspace\n *\n * Called by CLI `init` and VS Code extension activation to seed\n * the .snapback/learnings/ directory with initial patterns.\n *\n * Creates:\n * - hot.jsonl: Critical patterns always loaded (~10-15 entries)\n * - domain-*.jsonl: Domain-specific patterns for intent-aware loading\n * - anti-patterns.jsonl: Known pitfalls to avoid\n * - architecture-patterns.jsonl: Architectural guidelines\n *\n * @module services/learning-seeder\n */\n\nimport { existsSync, mkdirSync, writeFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport type { LearningTier, LearningType } from \"@snapback/intelligence/types\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/** Seed timestamp for all pre-seeded learnings */\nconst SEED_TIMESTAMP = \"2025-01-01T00:00:00.000Z\";\n\n/**\n * Helper to create a seeded learning with defaults\n */\nfunction seed(\n\tid: string,\n\ttype: LearningType,\n\ttier: LearningTier,\n\ttrigger: string[],\n\taction: string,\n\toptions: { priority?: \"critical\" | \"high\" | \"medium\" | \"low\"; domain?: string } = {},\n): SeededLearning {\n\treturn {\n\t\tid,\n\t\ttype,\n\t\ttier,\n\t\ttrigger,\n\t\taction,\n\t\tsolution: action, // For seed data, solution equals action\n\t\tsource: \"seed\",\n\t\ttimestamp: SEED_TIMESTAMP,\n\t\t...(options.priority && { priority: options.priority }),\n\t\t...(options.domain && { domain: options.domain }),\n\t};\n}\n\ninterface SeededLearning {\n\tid: string;\n\ttype: LearningType;\n\ttier: LearningTier;\n\ttrigger: string | string[];\n\taction: string;\n\tsolution: string;\n\tsource: string;\n\ttimestamp: string;\n\tpriority?: \"critical\" | \"high\" | \"medium\" | \"low\";\n\tdomain?: string;\n}\n\ninterface SeedResult {\n\tsuccess: boolean;\n\tfilesCreated: string[];\n\tlearningsSeeded: number;\n\terrors: string[];\n}\n\n// =============================================================================\n// SEED DATA - HOT TIER (Always Loaded)\n// =============================================================================\n\nconst HOT_TIER_LEARNINGS: SeededLearning[] = [\n\t// Critical patterns that apply everywhere\n\tseed(\n\t\t\"hot-001\",\n\t\t\"pattern\",\n\t\t\"hot\",\n\t\t[\"error handling\", \"catch block\", \"try catch\"],\n\t\t\"Always log errors in catch blocks with full context. Never silently swallow errors.\",\n\t\t{ priority: \"critical\" },\n\t),\n\tseed(\n\t\t\"hot-002\",\n\t\t\"pitfall\",\n\t\t\"hot\",\n\t\t[\"async\", \"await\", \"promise\"],\n\t\t\"Always await async functions. Missing await causes race conditions and silent failures.\",\n\t\t{ priority: \"critical\" },\n\t),\n\tseed(\n\t\t\"hot-003\",\n\t\t\"pattern\",\n\t\t\"hot\",\n\t\t[\"bundle size\", \"extension size\", \"vsix\"],\n\t\t\"Keep VS Code extension bundle under 2MB. Check before release with vsce ls.\",\n\t\t{ priority: \"critical\" },\n\t),\n\tseed(\n\t\t\"hot-004\",\n\t\t\"pattern\",\n\t\t\"hot\",\n\t\t[\"commit\", \"git commit\", \"before commit\"],\n\t\t\"Run type-check and lint before committing. Use check({m:'q'}) for quick validation.\",\n\t\t{ priority: \"high\" },\n\t),\n\tseed(\n\t\t\"hot-005\",\n\t\t\"pitfall\",\n\t\t\"hot\",\n\t\t[\"import\", \"circular\", \"dependency\"],\n\t\t\"Avoid circular imports. Use dependency injection or move shared types to contracts package.\",\n\t\t{ priority: \"high\" },\n\t),\n\tseed(\n\t\t\"hot-006\",\n\t\t\"pattern\",\n\t\t\"hot\",\n\t\t[\"test\", \"testing\", \"vitest\"],\n\t\t\"Write tests before implementation (TDD). Run vitest in watch mode during development.\",\n\t\t{ priority: \"high\" },\n\t),\n\tseed(\n\t\t\"hot-007\",\n\t\t\"pattern\",\n\t\t\"hot\",\n\t\t[\"snapshot\", \"safety\", \"risky change\"],\n\t\t\"Create snapshot before risky changes. Use snap({m:'s'}) to auto-snapshot based on risk.\",\n\t\t{ priority: \"high\" },\n\t),\n\tseed(\n\t\t\"hot-008\",\n\t\t\"pitfall\",\n\t\t\"hot\",\n\t\t[\"any\", \"as any\", \"typescript\"],\n\t\t\"Avoid 'as any' casts. Use proper types or unknown with type guards.\",\n\t\t{ priority: \"high\" },\n\t),\n];\n\n// =============================================================================\n// SEED DATA - DOMAIN: VS Code Extension\n// =============================================================================\n\nconst DOMAIN_VSCODE_LEARNINGS: SeededLearning[] = [\n\tseed(\n\t\t\"vscode-001\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"extension activation\", \"activate\", \"vscode extension\"],\n\t\t\"Use lazy initialization. Defer heavy operations until actually needed.\",\n\t\t{ domain: \"vscode\" },\n\t),\n\tseed(\n\t\t\"vscode-002\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"webview\", \"webview panel\", \"ui\"],\n\t\t\"Webviews are expensive. Reuse panels, use retainContextWhenHidden sparingly.\",\n\t\t{ domain: \"vscode\" },\n\t),\n\tseed(\n\t\t\"vscode-003\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"storage\", \"globalState\", \"workspaceState\"],\n\t\t\"VS Code storage is async. Always await storage operations. Use memento for large data.\",\n\t\t{ domain: \"vscode\" },\n\t),\n\tseed(\n\t\t\"vscode-004\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"command\", \"registerCommand\", \"command palette\"],\n\t\t\"Dispose commands on deactivation. Store disposables in context.subscriptions.\",\n\t\t{ domain: \"vscode\" },\n\t),\n\tseed(\n\t\t\"vscode-005\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"tree view\", \"tree provider\", \"explorer\"],\n\t\t\"Implement refresh() and fire onDidChangeTreeData for tree updates.\",\n\t\t{ domain: \"vscode\" },\n\t),\n];\n\n// =============================================================================\n// SEED DATA - DOMAIN: Web/Next.js\n// =============================================================================\n\nconst DOMAIN_WEB_LEARNINGS: SeededLearning[] = [\n\tseed(\n\t\t\"web-001\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"use client\", \"client component\", \"react\"],\n\t\t\"Prefer Server Components. Only use 'use client' when you need interactivity or browser APIs.\",\n\t\t{ domain: \"web\" },\n\t),\n\tseed(\n\t\t\"web-002\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"server action\", \"form action\", \"mutation\"],\n\t\t\"Use Server Actions for mutations. They handle loading states and revalidation automatically.\",\n\t\t{ domain: \"web\" },\n\t),\n\tseed(\n\t\t\"web-003\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"hydration\", \"hydration error\", \"ssr\"],\n\t\t\"Ensure server and client render identical markup. Use useEffect for client-only code.\",\n\t\t{ domain: \"web\" },\n\t),\n\tseed(\n\t\t\"web-004\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"image\", \"next image\", \"optimization\"],\n\t\t\"Use next/image for automatic optimization. Specify width/height or use fill with sizes.\",\n\t\t{ domain: \"web\" },\n\t),\n\tseed(\n\t\t\"web-005\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"biome\", \"lint\", \"format\"],\n\t\t\"Run biome check before commit. Use --write for auto-fix.\",\n\t\t{ domain: \"web\" },\n\t),\n];\n\n// =============================================================================\n// SEED DATA - DOMAIN: MCP/CLI\n// =============================================================================\n\nconst DOMAIN_MCP_CLI_LEARNINGS: SeededLearning[] = [\n\tseed(\n\t\t\"mcp-001\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"mcp tool\", \"tool handler\", \"tool result\"],\n\t\t\"Return structured JSON from tools. Use wire format for token efficiency.\",\n\t\t{ domain: \"mcp-cli\" },\n\t),\n\tseed(\n\t\t\"mcp-002\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"cli command\", \"commander\", \"command action\"],\n\t\t\"Use ora spinners for long operations. Handle errors with chalk.red messages.\",\n\t\t{ domain: \"mcp-cli\" },\n\t),\n\tseed(\n\t\t\"mcp-003\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"stdio\", \"transport\", \"mcp server\"],\n\t\t\"Never console.log in MCP server - it corrupts stdio. Use stderr or structured logging.\",\n\t\t{ domain: \"mcp-cli\" },\n\t),\n\tseed(\n\t\t\"mcp-004\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"daemon\", \"background process\", \"file watcher\"],\n\t\t\"Daemon should be stateless where possible. Persist state to disk for recovery.\",\n\t\t{ domain: \"mcp-cli\" },\n\t),\n];\n\n// =============================================================================\n// SEED DATA - DOMAIN: Testing\n// =============================================================================\n\nconst DOMAIN_TESTING_LEARNINGS: SeededLearning[] = [\n\tseed(\n\t\t\"test-001\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"vitest\", \"test setup\", \"beforeEach\"],\n\t\t\"Use beforeEach for setup, afterEach for cleanup. Avoid shared mutable state.\",\n\t\t{ domain: \"testing\" },\n\t),\n\tseed(\n\t\t\"test-002\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"mock\", \"vi.mock\", \"vitest mock\"],\n\t\t\"Mock at module level with vi.mock(). Use vi.fn() for function mocks.\",\n\t\t{ domain: \"testing\" },\n\t),\n\tseed(\n\t\t\"test-003\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"skip\", \"it.skip\", \"describe.skip\"],\n\t\t\"Skipped tests should be temporary. Track with TODO and enable within same PR.\",\n\t\t{ domain: \"testing\" },\n\t),\n\tseed(\n\t\t\"test-004\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"coverage\", \"test coverage\", \"c8\"],\n\t\t\"Aim for 80%+ coverage on new code. Focus on critical paths over line count.\",\n\t\t{ domain: \"testing\" },\n\t),\n];\n\n// =============================================================================\n// SEED DATA - Anti-Patterns\n// =============================================================================\n\nconst ANTI_PATTERNS_LEARNINGS: SeededLearning[] = [\n\tseed(\n\t\t\"anti-001\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"silent catch\", \"empty catch\", \"catch {}\"],\n\t\t\"Never use empty catch blocks. At minimum: console.error(error).\",\n\t),\n\tseed(\n\t\t\"anti-002\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"console.log\", \"debug log\", \"production\"],\n\t\t\"Remove console.log before commit. Use structured logging in production.\",\n\t),\n\tseed(\n\t\t\"anti-003\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"todo\", \"fixme\", \"hack\"],\n\t\t\"TODO comments must have owner and timeline. Don't commit unbounded TODOs.\",\n\t),\n\tseed(\n\t\t\"anti-004\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"magic number\", \"hardcoded\", \"literal\"],\n\t\t\"Extract magic numbers to named constants. Improves readability and maintainability.\",\n\t),\n\tseed(\n\t\t\"anti-005\",\n\t\t\"pitfall\",\n\t\t\"warm\",\n\t\t[\"copy paste\", \"duplicate code\", \"repetition\"],\n\t\t\"DRY: Extract duplicated code to shared functions. 3+ occurrences = extract.\",\n\t),\n];\n\n// =============================================================================\n// SEED DATA - Architecture Patterns\n// =============================================================================\n\nconst ARCHITECTURE_PATTERNS_LEARNINGS: SeededLearning[] = [\n\tseed(\n\t\t\"arch-001\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"monorepo\", \"package\", \"workspace\"],\n\t\t\"Use workspace:* for internal deps. Never pin versions for monorepo packages.\",\n\t),\n\tseed(\n\t\t\"arch-002\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"contracts\", \"shared types\", \"interface\"],\n\t\t\"Put shared types in @snapback/contracts. Single source of truth for cross-package types.\",\n\t),\n\tseed(\n\t\t\"arch-003\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"service\", \"dependency injection\", \"factory\"],\n\t\t\"Use factory functions for services (createFooService). Enables testing and configuration.\",\n\t),\n\tseed(\n\t\t\"arch-004\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"result type\", \"error handling\", \"return type\"],\n\t\t\"Use Result<T, E> pattern for operations that can fail. Avoid throwing for expected errors.\",\n\t),\n\tseed(\n\t\t\"arch-005\",\n\t\t\"pattern\",\n\t\t\"warm\",\n\t\t[\"event\", \"telemetry\", \"analytics\"],\n\t\t\"Use contracts/telemetry/events.v1.ts for event definitions. PostHog only for analytics.\",\n\t),\n];\n\n// =============================================================================\n// SEEDER IMPLEMENTATION\n// =============================================================================\n\n/**\n * Seed tiered learning files for a workspace\n *\n * Creates the full learnings directory structure with initial patterns.\n * Safe to call multiple times - only creates missing files.\n *\n * @param workspaceRoot - The workspace root directory\n * @param options - Seeding options\n * @returns SeedResult with created files and counts\n */\nexport function seedLearnings(\n\tworkspaceRoot: string,\n\toptions: {\n\t\t/** Force overwrite existing files */\n\t\tforce?: boolean;\n\t\t/** Only create specific domain files */\n\t\tdomains?: string[];\n\t\t/** Skip hot tier seeding */\n\t\tskipHot?: boolean;\n\t} = {},\n): SeedResult {\n\tconst learningsDir = join(workspaceRoot, \".snapback\", \"learnings\");\n\tconst result: SeedResult = {\n\t\tsuccess: true,\n\t\tfilesCreated: [],\n\t\tlearningsSeeded: 0,\n\t\terrors: [],\n\t};\n\n\t// Ensure directory exists\n\tif (!existsSync(learningsDir)) {\n\t\tmkdirSync(learningsDir, { recursive: true });\n\t}\n\n\t// Define files to seed\n\tconst filesToSeed: Array<{ filename: string; learnings: SeededLearning[] }> = [];\n\n\t// Hot tier (always included unless skipped)\n\tif (!options.skipHot) {\n\t\tfilesToSeed.push({ filename: \"hot.jsonl\", learnings: HOT_TIER_LEARNINGS });\n\t}\n\n\t// Domain files\n\tconst allDomains: Array<{ name: string; filename: string; learnings: SeededLearning[] }> = [\n\t\t{ name: \"vscode\", filename: \"domain-vscode.jsonl\", learnings: DOMAIN_VSCODE_LEARNINGS },\n\t\t{ name: \"web\", filename: \"domain-web.jsonl\", learnings: DOMAIN_WEB_LEARNINGS },\n\t\t{ name: \"mcp-cli\", filename: \"domain-mcp-cli.jsonl\", learnings: DOMAIN_MCP_CLI_LEARNINGS },\n\t\t{ name: \"testing\", filename: \"domain-testing.jsonl\", learnings: DOMAIN_TESTING_LEARNINGS },\n\t];\n\n\t// Add cross-domain files\n\tfilesToSeed.push({ filename: \"anti-patterns.jsonl\", learnings: ANTI_PATTERNS_LEARNINGS });\n\tfilesToSeed.push({ filename: \"architecture-patterns.jsonl\", learnings: ARCHITECTURE_PATTERNS_LEARNINGS });\n\n\t// Add domain files (filtered if domains option provided)\n\tfor (const domain of allDomains) {\n\t\tif (!options.domains || options.domains.includes(domain.name)) {\n\t\t\tfilesToSeed.push({ filename: domain.filename, learnings: domain.learnings });\n\t\t}\n\t}\n\n\t// Seed each file\n\tfor (const { filename, learnings } of filesToSeed) {\n\t\tconst filePath = join(learningsDir, filename);\n\n\t\t// Skip if exists and not forcing\n\t\tif (existsSync(filePath) && !options.force) {\n\t\t\tcontinue;\n\t\t}\n\n\t\ttry {\n\t\t\tconst content = `${learnings.map((l) => JSON.stringify(l)).join(\"\\n\")}\\n`;\n\t\t\twriteFileSync(filePath, content, \"utf8\");\n\t\t\tresult.filesCreated.push(filename);\n\t\t\tresult.learningsSeeded += learnings.length;\n\t\t} catch (error) {\n\t\t\tresult.errors.push(\n\t\t\t\t`Failed to create ${filename}: ${error instanceof Error ? error.message : String(error)}`,\n\t\t\t);\n\t\t\tresult.success = false;\n\t\t}\n\t}\n\n\t// Create INDEX.md for documentation\n\tconst indexPath = join(learningsDir, \"INDEX.md\");\n\tif (!existsSync(indexPath) || options.force) {\n\t\ttry {\n\t\t\twriteFileSync(indexPath, generateIndexMd(), \"utf8\");\n\t\t\tresult.filesCreated.push(\"INDEX.md\");\n\t\t} catch (error) {\n\t\t\tresult.errors.push(`Failed to create INDEX.md: ${error instanceof Error ? error.message : String(error)}`);\n\t\t}\n\t}\n\n\treturn result;\n}\n\n/**\n * Generate INDEX.md documentation for the learnings directory\n */\nfunction generateIndexMd(): string {\n\treturn `# SnapBack Learnings Directory\n\nThis directory contains tiered learning files for the SnapBack MCP server.\n\n## File Structure\n\n| File | Tier | Description | Auto-Loaded |\n|------|------|-------------|-------------|\n| \\`hot.jsonl\\` | Hot | Critical patterns, always loaded |  Always |\n| \\`domain-vscode.jsonl\\` | Warm | VS Code extension patterns | When working on extension |\n| \\`domain-web.jsonl\\` | Warm | Next.js/React patterns | When working on web app |\n| \\`domain-mcp-cli.jsonl\\` | Warm | MCP/CLI patterns | When working on CLI/MCP |\n| \\`domain-testing.jsonl\\` | Warm | Testing patterns | When running tests |\n| \\`anti-patterns.jsonl\\` | Warm | Known pitfalls to avoid | On debug/review intent |\n| \\`architecture-patterns.jsonl\\` | Warm | Architectural guidelines | On implement intent |\n| \\`user-learnings.jsonl\\` | Cold | User-recorded learnings | Query only |\n| \\`usage-stats.json\\` | Meta | Access tracking for auto-promotion | Internal |\n\n## How It Works\n\n1. **Task Start**: \\`snap({m:\"s\"})\\` loads hot tier + intent-matched warm tier files\n2. **During Work**: Relevant learnings guide implementation decisions\n3. **On Mistake**: \\`snap_violation()\\` records for future prevention\n4. **Discovery**: \\`snap_learn()\\` captures insights for reuse\n5. **Auto-Promotion**: 3x access  promotes to hot tier\n\n## Intent  Domain Mapping\n\n| Intent | Loaded Files |\n|--------|--------------|\n| implement | architecture-patterns, domain-* (by file path) |\n| debug | anti-patterns, domain-testing |\n| refactor | workflow-patterns, architecture-context |\n| review | anti-patterns, domain-testing, architecture-patterns |\n| explore | architecture-context, workflow-patterns |\n\n## Adding New Learnings\n\n### Via CLI\n\\`\\`\\`bash\nsnap learn \"trigger phrase\" \"action to take\" --type pattern\n\\`\\`\\`\n\n### Via MCP\n\\`\\`\\`typescript\nsnap_learn({\n  t: \"when modifying auth code\",\n  a: \"always add audit logging for security events\",\n  type: \"pat\"  // pat=pattern, pit=pitfall, eff=efficiency\n})\n\\`\\`\\`\n\n## Hot Tier Promotion\n\nLearnings are auto-promoted to hot tier when:\n- Accessed 3+ times across sessions\n- Applied 1+ times (marked as useful)\n- Within last 14 days (recency boost)\n\nRun \\`snap learn promote\\` to manually trigger hot tier regeneration.\n`;\n}\n\n/**\n * Check if learnings have been seeded\n */\nexport function isLearningsSeeded(workspaceRoot: string): boolean {\n\tconst hotPath = join(workspaceRoot, \".snapback\", \"learnings\", \"hot.jsonl\");\n\treturn existsSync(hotPath);\n}\n\n/**\n * Get seeding status for a workspace\n */\nexport function getLearningsSeedStatus(workspaceRoot: string): {\n\tseeded: boolean;\n\tfilesPresent: string[];\n\tfilesMissing: string[];\n} {\n\tconst learningsDir = join(workspaceRoot, \".snapback\", \"learnings\");\n\tconst expectedFiles = [\n\t\t\"hot.jsonl\",\n\t\t\"domain-vscode.jsonl\",\n\t\t\"domain-web.jsonl\",\n\t\t\"domain-mcp-cli.jsonl\",\n\t\t\"domain-testing.jsonl\",\n\t\t\"anti-patterns.jsonl\",\n\t\t\"architecture-patterns.jsonl\",\n\t];\n\n\tconst filesPresent: string[] = [];\n\tconst filesMissing: string[] = [];\n\n\tfor (const file of expectedFiles) {\n\t\tif (existsSync(join(learningsDir, file))) {\n\t\t\tfilesPresent.push(file);\n\t\t} else {\n\t\t\tfilesMissing.push(file);\n\t\t}\n\t}\n\n\treturn {\n\t\tseeded: filesMissing.length === 0,\n\t\tfilesPresent,\n\t\tfilesMissing,\n\t};\n}\n","/**\n * SessionFileTracker - Track files touched during MCP sessions\n *\n * Bridges the gap when neither daemon nor extension is available.\n * Tracks files mentioned in:\n * - snap m:s task start (planned files)\n * - check tool validations\n * - snap_learn file references\n *\n * Used by what_changed when local fallback is active.\n *\n * @module services/session-file-tracker\n */\n\nimport { existsSync, mkdirSync, readFileSync, statSync, writeFileSync } from \"node:fs\";\nimport { dirname, join, relative } from \"node:path\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * A file tracked during the session\n */\nexport interface TrackedFile {\n\t/** File path relative to workspace */\n\tpath: string;\n\t/** How the file was tracked */\n\tsource: \"planned\" | \"validated\" | \"mentioned\" | \"edited\";\n\t/** When the file was first tracked */\n\tfirstTracked: number;\n\t/** When the file was last touched */\n\tlastTouched: number;\n\t/** Estimated lines changed (if available) */\n\tlinesChanged?: number;\n\t/** File size at last check */\n\tsize?: number;\n}\n\n/**\n * Session file tracking state\n */\ninterface SessionFileState {\n\t/** Current task ID */\n\ttaskId: string | null;\n\t/** Task start time */\n\ttaskStartedAt: number | null;\n\t/** Tracked files */\n\tfiles: Map<string, TrackedFile>;\n}\n\n// =============================================================================\n// Constants\n// =============================================================================\n\nconst STATE_FILE = \".snapback/mcp/session-files.json\";\n\n// =============================================================================\n// SessionFileTracker\n// =============================================================================\n\nexport class SessionFileTracker {\n\tprivate workspaceRoot: string;\n\tprivate state: SessionFileState;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.state = this.loadState();\n\t}\n\n\t/**\n\t * Start tracking for a new task\n\t */\n\tstartTask(taskId: string, plannedFiles: string[] = []): void {\n\t\tthis.state = {\n\t\t\ttaskId,\n\t\t\ttaskStartedAt: Date.now(),\n\t\t\tfiles: new Map(),\n\t\t};\n\n\t\t// Track planned files\n\t\tfor (const file of plannedFiles) {\n\t\t\tthis.trackFile(file, \"planned\");\n\t\t}\n\n\t\tthis.saveState();\n\t}\n\n\t/**\n\t * End tracking for current task\n\t */\n\tendTask(): TrackedFile[] {\n\t\tconst files = this.getTrackedFiles();\n\t\tthis.state = {\n\t\t\ttaskId: null,\n\t\t\ttaskStartedAt: null,\n\t\t\tfiles: new Map(),\n\t\t};\n\t\tthis.saveState();\n\t\treturn files;\n\t}\n\n\t/**\n\t * Track a file\n\t */\n\ttrackFile(filePath: string, source: TrackedFile[\"source\"], linesChanged?: number): void {\n\t\tif (!this.state.taskId) {\n\t\t\treturn; // No active task\n\t\t}\n\n\t\t// Normalize path\n\t\tconst normalizedPath = filePath.startsWith(this.workspaceRoot)\n\t\t\t? relative(this.workspaceRoot, filePath)\n\t\t\t: filePath;\n\n\t\tconst now = Date.now();\n\t\tconst existing = this.state.files.get(normalizedPath);\n\n\t\tif (existing) {\n\t\t\t// Update existing entry\n\t\t\texisting.lastTouched = now;\n\t\t\tif (linesChanged !== undefined) {\n\t\t\t\texisting.linesChanged = (existing.linesChanged || 0) + linesChanged;\n\t\t\t}\n\t\t\t// Upgrade source priority: edited > validated > mentioned > planned\n\t\t\tconst sourcePriority = { edited: 4, validated: 3, mentioned: 2, planned: 1 };\n\t\t\tif (sourcePriority[source] > sourcePriority[existing.source]) {\n\t\t\t\texisting.source = source;\n\t\t\t}\n\t\t} else {\n\t\t\t// New entry\n\t\t\tconst fullPath = join(this.workspaceRoot, normalizedPath);\n\t\t\tlet size: number | undefined;\n\t\t\ttry {\n\t\t\t\tif (existsSync(fullPath)) {\n\t\t\t\t\tsize = statSync(fullPath).size;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore stat errors\n\t\t\t}\n\n\t\t\tthis.state.files.set(normalizedPath, {\n\t\t\t\tpath: normalizedPath,\n\t\t\t\tsource,\n\t\t\t\tfirstTracked: now,\n\t\t\t\tlastTouched: now,\n\t\t\t\tlinesChanged,\n\t\t\t\tsize,\n\t\t\t});\n\t\t}\n\n\t\tthis.saveState();\n\t}\n\n\t/**\n\t * Track multiple files at once\n\t */\n\ttrackFiles(files: string[], source: TrackedFile[\"source\"]): void {\n\t\tfor (const file of files) {\n\t\t\tthis.trackFile(file, source);\n\t\t}\n\t}\n\n\t/**\n\t * Get all tracked files for current task\n\t */\n\tgetTrackedFiles(): TrackedFile[] {\n\t\treturn Array.from(this.state.files.values());\n\t}\n\n\t/**\n\t * Get files changed since task start (for what_changed)\n\t */\n\tgetChangedFiles(): Array<{\n\t\tfile: string;\n\t\ttype: \"created\" | \"modified\" | \"deleted\";\n\t\tlinesChanged: number;\n\t\taiAttributed: boolean;\n\t\ttimestamp: number;\n\t}> {\n\t\tconst files = this.getTrackedFiles();\n\n\t\treturn files.map((f) => ({\n\t\t\tfile: f.path,\n\t\t\ttype: this.determineChangeType(f),\n\t\t\tlinesChanged: f.linesChanged || 0,\n\t\t\taiAttributed: f.source === \"edited\" || f.source === \"validated\",\n\t\t\ttimestamp: f.lastTouched,\n\t\t}));\n\t}\n\n\t/**\n\t * Determine change type based on file state\n\t */\n\tprivate determineChangeType(file: TrackedFile): \"created\" | \"modified\" | \"deleted\" {\n\t\tconst fullPath = join(this.workspaceRoot, file.path);\n\t\tif (!existsSync(fullPath)) {\n\t\t\treturn \"deleted\";\n\t\t}\n\t\t// If tracked from task start, likely created or modified\n\t\t// We can't know for sure without git, so default to modified\n\t\treturn \"modified\";\n\t}\n\n\t/**\n\t * Check if currently tracking a task\n\t */\n\thasActiveTask(): boolean {\n\t\treturn this.state.taskId !== null;\n\t}\n\n\t/**\n\t * Get current task ID\n\t */\n\tgetCurrentTaskId(): string | null {\n\t\treturn this.state.taskId;\n\t}\n\n\t/**\n\t * Get task duration in ms\n\t */\n\tgetTaskDuration(): number {\n\t\tif (!this.state.taskStartedAt) {\n\t\t\treturn 0;\n\t\t}\n\t\treturn Date.now() - this.state.taskStartedAt;\n\t}\n\n\t/**\n\t * Get stats for the current session\n\t */\n\tgetStats(): {\n\t\tfilesTracked: number;\n\t\ttotalLinesChanged: number;\n\t\tdurationMs: number;\n\t} {\n\t\tconst files = this.getTrackedFiles();\n\t\treturn {\n\t\t\tfilesTracked: files.length,\n\t\t\ttotalLinesChanged: files.reduce((sum, f) => sum + (f.linesChanged || 0), 0),\n\t\t\tdurationMs: this.getTaskDuration(),\n\t\t};\n\t}\n\n\t// =========================================================================\n\t// Persistence\n\t// =========================================================================\n\n\tprivate getStatePath(): string {\n\t\treturn join(this.workspaceRoot, STATE_FILE);\n\t}\n\n\tprivate loadState(): SessionFileState {\n\t\tconst statePath = this.getStatePath();\n\t\ttry {\n\t\t\tif (existsSync(statePath)) {\n\t\t\t\tconst data = JSON.parse(readFileSync(statePath, \"utf8\"));\n\t\t\t\treturn {\n\t\t\t\t\ttaskId: data.taskId || null,\n\t\t\t\t\ttaskStartedAt: data.taskStartedAt || null,\n\t\t\t\t\tfiles: new Map(Object.entries(data.files || {})),\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore load errors\n\t\t}\n\t\treturn {\n\t\t\ttaskId: null,\n\t\t\ttaskStartedAt: null,\n\t\t\tfiles: new Map(),\n\t\t};\n\t}\n\n\tprivate saveState(): void {\n\t\tconst statePath = this.getStatePath();\n\t\ttry {\n\t\t\tconst dir = dirname(statePath);\n\t\t\tif (!existsSync(dir)) {\n\t\t\t\tmkdirSync(dir, { recursive: true });\n\t\t\t}\n\n\t\t\tconst data = {\n\t\t\t\ttaskId: this.state.taskId,\n\t\t\t\ttaskStartedAt: this.state.taskStartedAt,\n\t\t\t\tfiles: Object.fromEntries(this.state.files),\n\t\t\t};\n\t\t\twriteFileSync(statePath, JSON.stringify(data, null, 2));\n\t\t} catch {\n\t\t\t// Ignore save errors\n\t\t}\n\t}\n}\n\n// =============================================================================\n// Factory\n// =============================================================================\n\n/**\n * Create SessionFileTracker instance\n */\nexport function createSessionFileTracker(workspaceRoot: string): SessionFileTracker {\n\treturn new SessionFileTracker(workspaceRoot);\n}\n\n// =============================================================================\n// Singleton per workspace\n// =============================================================================\n\nconst trackers = new Map<string, SessionFileTracker>();\n\n/**\n * Get or create tracker for workspace (singleton pattern)\n */\nexport function getSessionFileTracker(workspaceRoot: string): SessionFileTracker {\n\tif (!trackers.has(workspaceRoot)) {\n\t\ttrackers.set(workspaceRoot, new SessionFileTracker(workspaceRoot));\n\t}\n\treturn trackers.get(workspaceRoot)!;\n}\n","/**\n * Centralized Error Handler for MCP Package\n *\n * Provides structured error handling with:\n * - Typed error codes for all MCP domains\n * - Rich error context for debugging\n * - Discriminated union returns for caller-friendly error handling\n * - Consistent error formatting across the package\n *\n * @module errors\n */\n\n// =============================================================================\n// ERROR CODES\n// =============================================================================\n\n/**\n * Exhaustive error codes covering all MCP domains.\n * Grouped by domain for easy navigation.\n */\nexport enum ErrorCode {\n\t// \n\t// Daemon Errors (connection, communication)\n\t// \n\tDAEMON_UNAVAILABLE = \"DAEMON_UNAVAILABLE\",\n\tDAEMON_NOT_CONNECTED = \"DAEMON_NOT_CONNECTED\",\n\tDAEMON_TIMEOUT = \"DAEMON_TIMEOUT\",\n\tDAEMON_CONNECTION_FAILED = \"DAEMON_CONNECTION_FAILED\",\n\tDAEMON_REQUEST_FAILED = \"DAEMON_REQUEST_FAILED\",\n\n\t// \n\t// Snapshot Errors (creation, restoration, storage)\n\t// \n\tSNAPSHOT_FAILED = \"SNAPSHOT_FAILED\",\n\tSNAPSHOT_NOT_FOUND = \"SNAPSHOT_NOT_FOUND\",\n\tSNAPSHOT_RESTORE_FAILED = \"SNAPSHOT_RESTORE_FAILED\",\n\tSNAPSHOT_STORAGE_ERROR = \"SNAPSHOT_STORAGE_ERROR\",\n\tSNAPSHOT_HASH_MISMATCH = \"SNAPSHOT_HASH_MISMATCH\",\n\n\t// \n\t// Auth Errors (authentication, authorization)\n\t// \n\tAUTH_REQUIRED = \"AUTH_REQUIRED\",\n\tAUTH_EXPIRED = \"AUTH_EXPIRED\",\n\tAUTH_INVALID_TOKEN = \"AUTH_INVALID_TOKEN\",\n\tAUTH_INSUFFICIENT_PERMISSIONS = \"AUTH_INSUFFICIENT_PERMISSIONS\",\n\n\t// \n\t// Validation Errors (input, schema, parameters)\n\t// \n\tINVALID_INPUT = \"INVALID_INPUT\",\n\tINVALID_PARAMETER = \"INVALID_PARAMETER\",\n\tMISSING_REQUIRED_FIELD = \"MISSING_REQUIRED_FIELD\",\n\tSCHEMA_VALIDATION_FAILED = \"SCHEMA_VALIDATION_FAILED\",\n\n\t// \n\t// Workspace Errors (file system, paths)\n\t// \n\tWORKSPACE_NOT_FOUND = \"WORKSPACE_NOT_FOUND\",\n\tFILE_NOT_FOUND = \"FILE_NOT_FOUND\",\n\tFILE_READ_ERROR = \"FILE_READ_ERROR\",\n\tFILE_WRITE_ERROR = \"FILE_WRITE_ERROR\",\n\tPATH_ACCESS_DENIED = \"PATH_ACCESS_DENIED\",\n\n\t// \n\t// Session Errors (state management)\n\t// \n\tSESSION_NOT_FOUND = \"SESSION_NOT_FOUND\",\n\tSESSION_STATE_ERROR = \"SESSION_STATE_ERROR\",\n\tSESSION_ALREADY_ACTIVE = \"SESSION_ALREADY_ACTIVE\",\n\tNO_ACTIVE_SESSION = \"NO_ACTIVE_SESSION\",\n\n\t// \n\t// API Errors (HTTP, network)\n\t// \n\tAPI_REQUEST_FAILED = \"API_REQUEST_FAILED\",\n\tAPI_TIMEOUT = \"API_TIMEOUT\",\n\tAPI_RATE_LIMITED = \"API_RATE_LIMITED\",\n\tAPI_SERVER_ERROR = \"API_SERVER_ERROR\",\n\tCIRCUIT_BREAKER_OPEN = \"CIRCUIT_BREAKER_OPEN\",\n\n\t// \n\t// Tool Errors (MCP tool execution)\n\t// \n\tTOOL_NOT_FOUND = \"TOOL_NOT_FOUND\",\n\tTOOL_EXECUTION_FAILED = \"TOOL_EXECUTION_FAILED\",\n\tTOOL_DEPRECATED = \"TOOL_DEPRECATED\",\n\n\t// \n\t// General Errors\n\t// \n\tUNKNOWN = \"UNKNOWN\",\n\tINTERNAL_ERROR = \"INTERNAL_ERROR\",\n\tNOT_IMPLEMENTED = \"NOT_IMPLEMENTED\",\n}\n\n// =============================================================================\n// ERROR INTERFACE\n// =============================================================================\n\n/**\n * Structured MCP error with rich context for debugging.\n *\n * Designed for:\n * - Consistent error representation across the package\n * - Easy serialization for tool responses\n * - Rich debugging context without exposing internals\n */\nexport interface McpError {\n\t/** Error classification code */\n\tcode: ErrorCode;\n\n\t/** Human-readable error message */\n\tmessage: string;\n\n\t/** Additional context for debugging (safe to log) */\n\tcontext?: Record<string, unknown>;\n\n\t/** Stack trace (only in development) */\n\tstack?: string;\n\n\t/** Original error that caused this error */\n\tcause?: Error;\n\n\t/** Timestamp when error occurred */\n\ttimestamp: number;\n\n\t/** Whether this error is recoverable */\n\trecoverable: boolean;\n}\n\n// =============================================================================\n// RESULT TYPE (Discriminated Union)\n// =============================================================================\n\n/**\n * Result type for operations that can fail.\n * Enables exhaustive error handling without try/catch.\n *\n * @example\n * ```typescript\n * const result = await connectToDaemon();\n * if (!result.success) {\n *   // TypeScript knows result.error exists\n *   console.error(`Failed: ${result.error.code}`);\n *   return;\n * }\n * // TypeScript knows result.data exists\n * const connection = result.data;\n * ```\n */\nexport type Result<T, E = McpError> = { success: true; data: T } | { success: false; error: E };\n\n/**\n * Create a success result\n */\nexport function ok<T>(data: T): Result<T> {\n\treturn { success: true, data };\n}\n\n/**\n * Create a failure result\n */\nexport function err<T = never>(error: McpError): Result<T> {\n\treturn { success: false, error };\n}\n\n// =============================================================================\n// ERROR FACTORY\n// =============================================================================\n\n/**\n * Metadata for error recovery hints\n */\nconst ERROR_METADATA: Record<ErrorCode, { recoverable: boolean; retryable: boolean }> = {\n\t// Daemon - mostly recoverable with retry\n\t[ErrorCode.DAEMON_UNAVAILABLE]: { recoverable: true, retryable: true },\n\t[ErrorCode.DAEMON_NOT_CONNECTED]: { recoverable: true, retryable: true },\n\t[ErrorCode.DAEMON_TIMEOUT]: { recoverable: true, retryable: true },\n\t[ErrorCode.DAEMON_CONNECTION_FAILED]: { recoverable: true, retryable: true },\n\t[ErrorCode.DAEMON_REQUEST_FAILED]: { recoverable: true, retryable: true },\n\n\t// Snapshot - some recoverable\n\t[ErrorCode.SNAPSHOT_FAILED]: { recoverable: true, retryable: true },\n\t[ErrorCode.SNAPSHOT_NOT_FOUND]: { recoverable: false, retryable: false },\n\t[ErrorCode.SNAPSHOT_RESTORE_FAILED]: { recoverable: true, retryable: true },\n\t[ErrorCode.SNAPSHOT_STORAGE_ERROR]: { recoverable: true, retryable: true },\n\t[ErrorCode.SNAPSHOT_HASH_MISMATCH]: { recoverable: false, retryable: false },\n\n\t// Auth - requires user action\n\t[ErrorCode.AUTH_REQUIRED]: { recoverable: true, retryable: false },\n\t[ErrorCode.AUTH_EXPIRED]: { recoverable: true, retryable: false },\n\t[ErrorCode.AUTH_INVALID_TOKEN]: { recoverable: true, retryable: false },\n\t[ErrorCode.AUTH_INSUFFICIENT_PERMISSIONS]: {\n\t\trecoverable: false,\n\t\tretryable: false,\n\t},\n\n\t// Validation - fix input and retry\n\t[ErrorCode.INVALID_INPUT]: { recoverable: true, retryable: false },\n\t[ErrorCode.INVALID_PARAMETER]: { recoverable: true, retryable: false },\n\t[ErrorCode.MISSING_REQUIRED_FIELD]: { recoverable: true, retryable: false },\n\t[ErrorCode.SCHEMA_VALIDATION_FAILED]: { recoverable: true, retryable: false },\n\n\t// Workspace - depends on context\n\t[ErrorCode.WORKSPACE_NOT_FOUND]: { recoverable: false, retryable: false },\n\t[ErrorCode.FILE_NOT_FOUND]: { recoverable: false, retryable: false },\n\t[ErrorCode.FILE_READ_ERROR]: { recoverable: true, retryable: true },\n\t[ErrorCode.FILE_WRITE_ERROR]: { recoverable: true, retryable: true },\n\t[ErrorCode.PATH_ACCESS_DENIED]: { recoverable: false, retryable: false },\n\n\t// Session - mostly not recoverable\n\t[ErrorCode.SESSION_NOT_FOUND]: { recoverable: false, retryable: false },\n\t[ErrorCode.SESSION_STATE_ERROR]: { recoverable: true, retryable: false },\n\t[ErrorCode.SESSION_ALREADY_ACTIVE]: { recoverable: true, retryable: false },\n\t[ErrorCode.NO_ACTIVE_SESSION]: { recoverable: true, retryable: false },\n\n\t// API - retryable network errors\n\t[ErrorCode.API_REQUEST_FAILED]: { recoverable: true, retryable: true },\n\t[ErrorCode.API_TIMEOUT]: { recoverable: true, retryable: true },\n\t[ErrorCode.API_RATE_LIMITED]: { recoverable: true, retryable: true },\n\t[ErrorCode.API_SERVER_ERROR]: { recoverable: true, retryable: true },\n\t[ErrorCode.CIRCUIT_BREAKER_OPEN]: { recoverable: true, retryable: true },\n\n\t// Tool - mostly not recoverable\n\t[ErrorCode.TOOL_NOT_FOUND]: { recoverable: false, retryable: false },\n\t[ErrorCode.TOOL_EXECUTION_FAILED]: { recoverable: true, retryable: true },\n\t[ErrorCode.TOOL_DEPRECATED]: { recoverable: false, retryable: false },\n\n\t// General\n\t[ErrorCode.UNKNOWN]: { recoverable: false, retryable: false },\n\t[ErrorCode.INTERNAL_ERROR]: { recoverable: false, retryable: false },\n\t[ErrorCode.NOT_IMPLEMENTED]: { recoverable: false, retryable: false },\n};\n\n/**\n * Create a structured MCP error with automatic metadata.\n *\n * @param code - Error classification code\n * @param message - Human-readable error message\n * @param context - Optional additional context for debugging\n * @returns Structured McpError\n *\n * @example\n * ```typescript\n * throw createMcpError(\n *   ErrorCode.DAEMON_TIMEOUT,\n *   \"Daemon did not respond within 10s\",\n *   { method: \"snapshot.create\", elapsed: 10000 }\n * );\n * ```\n */\nexport function createMcpError(code: ErrorCode, message: string, context?: Record<string, unknown>): McpError {\n\tconst metadata = ERROR_METADATA[code];\n\tconst error: McpError = {\n\t\tcode,\n\t\tmessage,\n\t\tcontext,\n\t\ttimestamp: Date.now(),\n\t\trecoverable: metadata.recoverable,\n\t};\n\n\t// Capture stack in development\n\tif (process.env.NODE_ENV !== \"production\") {\n\t\terror.stack = new Error().stack;\n\t}\n\n\treturn error;\n}\n\n/**\n * Create an MCP error from an existing Error, preserving cause chain.\n *\n * @param code - Error classification code\n * @param message - Human-readable error message\n * @param cause - Original error\n * @param context - Optional additional context\n * @returns Structured McpError with cause\n */\nexport function createMcpErrorFromCause(\n\tcode: ErrorCode,\n\tmessage: string,\n\tcause: Error,\n\tcontext?: Record<string, unknown>,\n): McpError {\n\tconst error = createMcpError(code, message, {\n\t\t...context,\n\t\tcauseMessage: cause.message,\n\t});\n\terror.cause = cause;\n\treturn error;\n}\n\n// =============================================================================\n// ERROR FORMATTING\n// =============================================================================\n\n/**\n * Format any error into a structured McpError.\n * Useful for catch blocks to normalize errors.\n *\n * @param error - Any error (Error, McpError, string, or unknown)\n * @returns Normalized McpError\n *\n * @example\n * ```typescript\n * try {\n *   await riskyOperation();\n * } catch (error) {\n *   const mcpError = formatMcpError(error);\n *   logger.error(mcpError.code, mcpError.message, mcpError.context);\n * }\n * ```\n */\nexport function formatMcpError(error: unknown): McpError {\n\t// Already an McpError\n\tif (isMcpError(error)) {\n\t\treturn error;\n\t}\n\n\t// Standard Error\n\tif (error instanceof Error) {\n\t\treturn createMcpErrorFromCause(ErrorCode.UNKNOWN, error.message, error, { originalName: error.name });\n\t}\n\n\t// String error\n\tif (typeof error === \"string\") {\n\t\treturn createMcpError(ErrorCode.UNKNOWN, error);\n\t}\n\n\t// Unknown error type\n\treturn createMcpError(ErrorCode.UNKNOWN, String(error), {\n\t\toriginalType: typeof error,\n\t});\n}\n\n/**\n * Format an McpError for user-facing display.\n * Excludes sensitive context and stack traces.\n *\n * @param error - The MCP error to format\n * @returns User-friendly error message\n */\nexport function formatForUser(error: McpError): string {\n\tconst prefix = error.recoverable ? \"Error\" : \"Fatal error\";\n\treturn `${prefix}: ${error.message} (${error.code})`;\n}\n\n/**\n * Format an McpError for logging.\n * Includes all context for debugging.\n *\n * @param error - The MCP error to format\n * @returns Detailed log-friendly string\n */\nexport function formatForLog(error: McpError): string {\n\tconst parts = [\n\t\t`[${error.code}] ${error.message}`,\n\t\terror.context ? `Context: ${JSON.stringify(error.context)}` : null,\n\t\terror.cause ? `Caused by: ${error.cause.message}` : null,\n\t].filter(Boolean);\n\n\treturn parts.join(\"\\n  \");\n}\n\n// =============================================================================\n// TYPE GUARDS\n// =============================================================================\n\n/**\n * Type guard to check if an error is a structured McpError.\n */\nexport function isMcpError(error: unknown): error is McpError {\n\treturn (\n\t\ttypeof error === \"object\" &&\n\t\terror !== null &&\n\t\t\"code\" in error &&\n\t\t\"message\" in error &&\n\t\t\"timestamp\" in error &&\n\t\ttypeof (error as McpError).code === \"string\" &&\n\t\tObject.values(ErrorCode).includes((error as McpError).code)\n\t);\n}\n\n/**\n * Type guard to check if an error code indicates a retryable error.\n */\nexport function isRetryable(error: McpError): boolean {\n\treturn ERROR_METADATA[error.code]?.retryable ?? false;\n}\n\n/**\n * Type guard to check if an error is a specific code.\n */\nexport function isErrorCode(error: unknown, code: ErrorCode): boolean {\n\treturn isMcpError(error) && error.code === code;\n}\n\n// =============================================================================\n// CONVENIENCE FACTORIES\n// =============================================================================\n\n/**\n * Common error factories for frequently used error types.\n */\nexport const McpErrors = {\n\t// Daemon errors\n\tdaemonUnavailable: (context?: Record<string, unknown>) =>\n\t\tcreateMcpError(ErrorCode.DAEMON_UNAVAILABLE, \"Daemon is not available\", context),\n\n\tdaemonTimeout: (method: string, timeoutMs: number) =>\n\t\tcreateMcpError(ErrorCode.DAEMON_TIMEOUT, `Request timeout: ${method}`, {\n\t\t\tmethod,\n\t\t\ttimeoutMs,\n\t\t}),\n\n\tdaemonNotConnected: () => createMcpError(ErrorCode.DAEMON_NOT_CONNECTED, \"Not connected to daemon\"),\n\n\t// Validation errors\n\tinvalidInput: (field: string, reason: string) =>\n\t\tcreateMcpError(ErrorCode.INVALID_INPUT, `Invalid input for '${field}': ${reason}`, { field, reason }),\n\n\tmissingField: (field: string) =>\n\t\tcreateMcpError(ErrorCode.MISSING_REQUIRED_FIELD, `Missing required field: ${field}`, { field }),\n\n\t// File errors\n\tfileNotFound: (path: string) =>\n\t\tcreateMcpError(ErrorCode.FILE_NOT_FOUND, `File not found: ${path}`, {\n\t\t\tpath,\n\t\t}),\n\n\tworkspaceNotFound: (path: string) =>\n\t\tcreateMcpError(ErrorCode.WORKSPACE_NOT_FOUND, `Workspace not found: ${path}`, { path }),\n\n\t// Session errors\n\tnoActiveSession: () => createMcpError(ErrorCode.NO_ACTIVE_SESSION, \"No active task session\"),\n\n\tsessionNotFound: (sessionId: string) =>\n\t\tcreateMcpError(ErrorCode.SESSION_NOT_FOUND, `Session not found: ${sessionId}`, {\n\t\t\tsessionId,\n\t\t}),\n\n\t// API errors\n\tapiError: (status: number, statusText: string, endpoint?: string) =>\n\t\tcreateMcpError(ErrorCode.API_REQUEST_FAILED, `API error: ${status} ${statusText}`, {\n\t\t\tstatus,\n\t\t\tstatusText,\n\t\t\tendpoint,\n\t\t}),\n\n\t// Snapshot errors\n\tsnapshotNotFound: (id: string) =>\n\t\tcreateMcpError(ErrorCode.SNAPSHOT_NOT_FOUND, `Snapshot not found: ${id}`, {\n\t\t\tsnapshotId: id,\n\t\t}),\n\n\tsnapshotFailed: (reason: string, context?: Record<string, unknown>) =>\n\t\tcreateMcpError(ErrorCode.SNAPSHOT_FAILED, `Snapshot failed: ${reason}`, context),\n\n\t// Auth errors\n\tauthRequired: () => createMcpError(ErrorCode.AUTH_REQUIRED, \"Authentication required\"),\n\n\tauthExpired: () => createMcpError(ErrorCode.AUTH_EXPIRED, \"Authentication token has expired\"),\n\n\t// Tool errors\n\ttoolNotFound: (name: string) =>\n\t\tcreateMcpError(ErrorCode.TOOL_NOT_FOUND, `Tool not found: ${name}`, {\n\t\t\ttool: name,\n\t\t}),\n} as const;\n","/**\n * MCP Daemon Client Facade\n *\n * Provides lightweight daemon communication for MCP tools.\n * Implements minimal IPC protocol to avoid circular dependency with CLI.\n *\n * Features:\n * - Lazy connection (connects on first request)\n * - Graceful fallback to local Intelligence when daemon unavailable\n * - Singleton per workspace to share connections\n * - Auto-detection of daemon availability\n *\n * @module daemon/client-facade\n */\n\nimport { existsSync, readFileSync } from \"node:fs\";\nimport { createConnection, type Socket } from \"node:net\";\nimport { homedir, platform } from \"node:os\";\nimport { join } from \"node:path\";\n\nimport {\n\tcreateMcpError,\n\tcreateMcpErrorFromCause,\n\terr,\n\tformatForLog,\n\ttype McpError,\n\tErrorCode as McpErrorCode,\n\tok,\n\ttype Result,\n} from \"../errors/index.js\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Cache of daemon connections per workspace */\nconst connections = new Map<string, DaemonConnection>();\n\n/** Connection status per workspace */\nconst connectionStatus = new Map<\n\tstring,\n\t{\n\t\tconnected: boolean;\n\t\tlastAttempt: number;\n\t\tconsecutiveFailures: number;\n\t}\n>();\n\n/** Minimum time between connection attempts (ms) */\nconst MIN_RETRY_INTERVAL_MS = 5000;\n\n/** Max consecutive failures before giving up */\nconst MAX_CONSECUTIVE_FAILURES = 3;\n\n/** Request timeout (ms) */\nconst REQUEST_TIMEOUT_MS = 10000;\n\n// =============================================================================\n// PLATFORM PATHS\n// =============================================================================\n\nconst IS_WINDOWS = platform() === \"win32\";\n\n/**\n * Get the daemon socket path based on platform\n */\nfunction getSocketPath(): string {\n\tif (IS_WINDOWS) {\n\t\treturn \"\\\\\\\\.\\\\pipe\\\\snapback-daemon\";\n\t}\n\treturn join(homedir(), \".snapback\", \"daemon.sock\");\n}\n\n/**\n * Get the daemon PID file path\n */\nfunction getPidPath(): string {\n\treturn join(homedir(), \".snapback\", \"daemon.pid\");\n}\n\n// =============================================================================\n// LIGHTWEIGHT IPC CLIENT\n// =============================================================================\n\ninterface JsonRpcRequest {\n\tjsonrpc: \"2.0\";\n\tid: number;\n\tmethod: string;\n\tparams: Record<string, unknown>;\n}\n\ninterface JsonRpcResponse {\n\tjsonrpc: \"2.0\";\n\tid: number;\n\tresult?: unknown;\n\terror?: { code: number; message: string };\n}\n\n/**\n * Lightweight daemon connection\n * Implements minimal JSON-RPC over IPC\n */\nclass DaemonConnection {\n\tprivate socket: Socket | null = null;\n\tprivate requestId = 0;\n\tprivate pendingRequests = new Map<\n\t\tnumber,\n\t\t{\n\t\t\tresolve: (value: unknown) => void;\n\t\t\treject: (error: Error) => void;\n\t\t\ttimeout: NodeJS.Timeout;\n\t\t}\n\t>();\n\tprivate buffer = \"\";\n\n\tconstructor(private socketPath: string) {}\n\n\t/**\n\t * Connect to daemon\n\t */\n\tasync connect(): Promise<void> {\n\t\tif (this.socket?.writable) {\n\t\t\treturn; // Already connected\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst socket = createConnection(this.socketPath);\n\n\t\t\tsocket.on(\"connect\", () => {\n\t\t\t\tthis.socket = socket;\n\t\t\t\tresolve();\n\t\t\t});\n\n\t\t\tsocket.on(\"error\", (err) => {\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t\tsocket.on(\"data\", (data) => {\n\t\t\t\tthis.handleData(data.toString());\n\t\t\t});\n\n\t\t\tsocket.on(\"close\", () => {\n\t\t\t\tthis.socket = null;\n\t\t\t\t// Reject all pending requests\n\t\t\t\tfor (const [id, pending] of this.pendingRequests) {\n\t\t\t\t\tclearTimeout(pending.timeout);\n\t\t\t\t\tpending.reject(new Error(\"Connection closed\"));\n\t\t\t\t\tthis.pendingRequests.delete(id);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Connection timeout\n\t\t\tsetTimeout(() => {\n\t\t\t\tif (!this.socket) {\n\t\t\t\t\tsocket.destroy();\n\t\t\t\t\treject(new Error(\"Connection timeout\"));\n\t\t\t\t}\n\t\t\t}, 5000);\n\t\t});\n\t}\n\n\t/**\n\t * Disconnect from daemon\n\t */\n\tdisconnect(): void {\n\t\tif (this.socket) {\n\t\t\tthis.socket.destroy();\n\t\t\tthis.socket = null;\n\t\t}\n\t}\n\n\t/**\n\t * Send a request to the daemon\n\t */\n\tasync request<T>(method: string, params: Record<string, unknown>): Promise<T> {\n\t\tif (!this.socket?.writable) {\n\t\t\tthrow new Error(\"Not connected\");\n\t\t}\n\n\t\tconst id = ++this.requestId;\n\t\tconst request: JsonRpcRequest = {\n\t\t\tjsonrpc: \"2.0\",\n\t\t\tid,\n\t\t\tmethod,\n\t\t\tparams,\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst timeout = setTimeout(() => {\n\t\t\t\tthis.pendingRequests.delete(id);\n\t\t\t\treject(new Error(`Request timeout: ${method}`));\n\t\t\t}, REQUEST_TIMEOUT_MS);\n\n\t\t\tthis.pendingRequests.set(id, {\n\t\t\t\tresolve: resolve as (value: unknown) => void,\n\t\t\t\treject,\n\t\t\t\ttimeout,\n\t\t\t});\n\n\t\t\tthis.socket?.write(`${JSON.stringify(request)}\\n`);\n\t\t});\n\t}\n\n\t/**\n\t * Handle incoming data\n\t */\n\tprivate handleData(data: string): void {\n\t\tthis.buffer += data;\n\n\t\t// Process complete messages (newline-delimited JSON)\n\t\tconst lines = this.buffer.split(\"\\n\");\n\t\tthis.buffer = lines.pop() || \"\"; // Keep incomplete line in buffer\n\n\t\tfor (const line of lines) {\n\t\t\tif (!line.trim()) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst response: JsonRpcResponse = JSON.parse(line);\n\t\t\t\tconst pending = this.pendingRequests.get(response.id);\n\n\t\t\t\tif (pending) {\n\t\t\t\t\tclearTimeout(pending.timeout);\n\t\t\t\t\tthis.pendingRequests.delete(response.id);\n\n\t\t\t\t\tif (response.error) {\n\t\t\t\t\t\tpending.reject(new Error(response.error.message));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tpending.resolve(response.result);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore malformed responses\n\t\t\t}\n\t\t}\n\t}\n}\n\n// =============================================================================\n// CLIENT FACADE\n// =============================================================================\n\n/**\n * Get or create a daemon connection for a workspace\n *\n * Returns null if daemon is not available and retry limit exceeded.\n */\nasync function getDaemonConnection(workspaceRoot: string): Promise<DaemonConnection | null> {\n\t// Check if we should skip attempting connection\n\tconst status = connectionStatus.get(workspaceRoot);\n\tif (status) {\n\t\tconst timeSinceLastAttempt = Date.now() - status.lastAttempt;\n\n\t\t// If we've failed too many times recently, skip\n\t\tif (status.consecutiveFailures >= MAX_CONSECUTIVE_FAILURES && timeSinceLastAttempt < MIN_RETRY_INTERVAL_MS) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t// Get or create connection\n\tlet conn = connections.get(workspaceRoot);\n\n\tif (!conn) {\n\t\tconn = new DaemonConnection(getSocketPath());\n\t\tconnections.set(workspaceRoot, conn);\n\t}\n\n\t// Try to connect\n\ttry {\n\t\tawait conn.connect();\n\n\t\t// Update status on success\n\t\tconnectionStatus.set(workspaceRoot, {\n\t\t\tconnected: true,\n\t\t\tlastAttempt: Date.now(),\n\t\t\tconsecutiveFailures: 0,\n\t\t});\n\n\t\treturn conn;\n\t} catch {\n\t\t// Update status on failure\n\t\tconst prevStatus = connectionStatus.get(workspaceRoot);\n\t\tconnectionStatus.set(workspaceRoot, {\n\t\t\tconnected: false,\n\t\t\tlastAttempt: Date.now(),\n\t\t\tconsecutiveFailures: (prevStatus?.consecutiveFailures ?? 0) + 1,\n\t\t});\n\n\t\treturn null;\n\t}\n}\n\n/**\n * Check if daemon is available for a workspace without connecting\n */\nexport function isDaemonAvailable(_workspaceRoot: string): boolean {\n\t// Check if PID file exists (quick check)\n\ttry {\n\t\tconst pidPath = getPidPath();\n\t\tif (!existsSync(pidPath)) {\n\t\t\treturn false;\n\t\t}\n\t\t// Optionally verify PID is running\n\t\tconst pid = Number.parseInt(readFileSync(pidPath, \"utf8\").trim(), 10);\n\t\tif (Number.isNaN(pid)) {\n\t\t\treturn false;\n\t\t}\n\t\t// Check if process exists (doesn't kill it)\n\t\ttry {\n\t\t\tprocess.kill(pid, 0);\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Disconnect and remove connection for a workspace\n */\nexport async function disposeDaemonConnection(workspaceRoot: string): Promise<void> {\n\tconst conn = connections.get(workspaceRoot);\n\tif (conn) {\n\t\tconn.disconnect();\n\t\tconnections.delete(workspaceRoot);\n\t\tconnectionStatus.delete(workspaceRoot);\n\t}\n}\n\n/**\n * Disconnect all daemon connections\n * Call on MCP server shutdown\n */\nexport async function disposeAllDaemonConnections(): Promise<void> {\n\tfor (const [workspace] of connections) {\n\t\tawait disposeDaemonConnection(workspace);\n\t}\n}\n\n// =============================================================================\n// CONVENIENCE METHODS\n// =============================================================================\n\n/**\n * Begin a task via daemon\n */\nexport async function beginTaskViaDaemon(\n\tworkspaceRoot: string,\n\ttask: string,\n\tfiles?: string[],\n\tkeywords?: string[],\n): Promise<{\n\ttaskId: string;\n\tsnapshot: { created: boolean; id?: string; reason?: string };\n\tpatterns: unknown[];\n\tconstraints: unknown[];\n\tlearnings: unknown[];\n\triskAssessment: { overallRisk: string; riskAreas: unknown[]; recommendations: unknown[] };\n\tnextActions: unknown[];\n} | null> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\treturn await conn.request(\"session.begin\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\ttask,\n\t\t\tfiles: files || [],\n\t\t\tkeywords: keywords || [],\n\t\t});\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Get session changes via daemon\n */\nexport async function getSessionChangesViaDaemon(\n\tworkspaceRoot: string,\n\toptions?: {\n\t\tincludeDiff?: boolean;\n\t\tfilterFiles?: string[];\n\t\tincludeAIAttribution?: boolean;\n\t},\n): Promise<{\n\tfiles: Array<{\n\t\tpath: string;\n\t\tstatus: \"created\" | \"modified\" | \"deleted\";\n\t\tlinesChanged: number;\n\t\taiAttributed?: boolean;\n\t}>;\n\ttotalLinesChanged: number;\n\triskAssessment: { overallRisk: \"low\" | \"medium\" | \"high\" };\n} | null> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\treturn await conn.request(\"session.changes\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\t...options,\n\t\t});\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * End task via daemon\n */\nexport async function endTaskViaDaemon(\n\tworkspaceRoot: string,\n\toutcome?: \"completed\" | \"abandoned\" | \"blocked\",\n): Promise<{\n\tsummary: { filesModified: number; linesChanged: number; duration: number };\n\tsnapshot: { created: boolean };\n\tlearningsAccepted: number;\n} | null> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\treturn await conn.request(\"session.end\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\toutcome: outcome || \"completed\",\n\t\t});\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Get session status via daemon\n */\nexport async function getSessionStatusViaDaemon(workspaceRoot: string): Promise<{\n\tactive: boolean;\n\ttaskId?: string;\n\ttask?: string;\n\tstartedAt?: string;\n\tfilesModified: number;\n\tsnapshotCount: number;\n} | null> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\treturn await conn.request(\"session.status\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t});\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Run quick check via daemon\n */\nexport async function quickCheckViaDaemon(\n\tworkspaceRoot: string,\n\toptions?: { file?: string; files?: string[] },\n): Promise<{\n\tpassed: boolean;\n\ttypescript: { passed: boolean; errors: number };\n\ttests: { discovered: number };\n\tlint: { passed: boolean; errors: number; warnings: number };\n} | null> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\treturn await conn.request(\"validation.quick\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\t...options,\n\t\t});\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Record file modification via daemon (for AI attribution)\n */\nexport async function recordFileModificationViaDaemon(\n\tworkspaceRoot: string,\n\tfilePath: string,\n\tlinesChanged: number,\n\taiAttributed: boolean,\n): Promise<boolean> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn false;\n\t}\n\n\ttry {\n\t\tawait conn.request(\"file.modified\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\tpath: filePath,\n\t\t\tlinesChanged,\n\t\t\taiAttributed,\n\t\t});\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Notify daemon that a snapshot was created (for vitals pressure reset)\n *\n * This is critical for MCPExtension coordination:\n * When MCP tools create snapshots, the Extension's vitals system needs to know\n * so it can reset pressure and update the UI. Without this notification,\n * pressure keeps building even after MCP snapshots are created.\n *\n * The daemon forwards this to the EventBus as SNAPSHOT_CREATED event,\n * which AutoDecisionIntegration listens to for calling vitals.onSnapshot().\n */\nexport async function notifySnapshotCreatedViaDaemon(\n\tworkspaceRoot: string,\n\tsnapshotId: string,\n\tfilePath?: string,\n\ttrigger?: \"manual\" | \"auto\" | \"ai-detection\",\n): Promise<boolean> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\t// Daemon not available - this is OK, snapshot was still created\n\t\t// Just means vitals won't be notified (Extension-only flow still works)\n\t\treturn false;\n\t}\n\n\ttry {\n\t\tawait conn.request(\"snapshot.created\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\tid: snapshotId,\n\t\t\tfilePath: filePath || \"unknown\",\n\t\t\ttrigger: trigger || \"ai-detection\",\n\t\t\tsource: \"mcp\", // Identify source for debugging\n\t\t});\n\t\treturn true;\n\t} catch (error) {\n\t\t// Log but don't throw - daemon unavailability is recoverable\n\t\t// The snapshot was still created, just vitals won't be notified\n\t\tconst mcpError =\n\t\t\terror instanceof Error\n\t\t\t\t? createMcpErrorFromCause(\n\t\t\t\t\t\tMcpErrorCode.DAEMON_REQUEST_FAILED,\n\t\t\t\t\t\t\"Failed to notify daemon of snapshot creation\",\n\t\t\t\t\t\terror,\n\t\t\t\t\t\t{ snapshotId, filePath },\n\t\t\t\t\t)\n\t\t\t\t: createMcpError(McpErrorCode.DAEMON_REQUEST_FAILED, `Failed to notify daemon: ${String(error)}`, {\n\t\t\t\t\t\tsnapshotId,\n\t\t\t\t\t\tfilePath,\n\t\t\t\t\t});\n\t\t// Log with structured format instead of console.warn\n\t\tconsole.error(`[MCP] ${formatForLog(mcpError)}`);\n\t\treturn false;\n\t}\n}\n\n/**\n * Notify daemon that a snapshot was created (Result-based version)\n *\n * Returns a Result type for callers who want structured error handling.\n * Use this when you need to know WHY the notification failed.\n *\n * @example\n * ```typescript\n * const result = await notifySnapshotCreatedResult(workspace, snapshotId);\n * if (!result.success) {\n *   logger.warn(`Notification failed: ${result.error.code}`);\n *   // Continue anyway - snapshot was still created\n * }\n * ```\n */\nexport async function notifySnapshotCreatedResult(\n\tworkspaceRoot: string,\n\tsnapshotId: string,\n\tfilePath?: string,\n\ttrigger?: \"manual\" | \"auto\" | \"ai-detection\",\n): Promise<Result<void, McpError>> {\n\tconst conn = await getDaemonConnection(workspaceRoot);\n\tif (!conn) {\n\t\treturn err(\n\t\t\tcreateMcpError(McpErrorCode.DAEMON_UNAVAILABLE, \"Daemon is not available\", {\n\t\t\t\tworkspaceRoot,\n\t\t\t\tsnapshotId,\n\t\t\t}),\n\t\t);\n\t}\n\n\ttry {\n\t\tawait conn.request(\"snapshot.created\", {\n\t\t\tworkspace: workspaceRoot,\n\t\t\tid: snapshotId,\n\t\t\tfilePath: filePath || \"unknown\",\n\t\t\ttrigger: trigger || \"ai-detection\",\n\t\t\tsource: \"mcp\",\n\t\t});\n\t\treturn ok(undefined);\n\t} catch (error) {\n\t\tconst mcpError =\n\t\t\terror instanceof Error\n\t\t\t\t? createMcpErrorFromCause(\n\t\t\t\t\t\tMcpErrorCode.DAEMON_REQUEST_FAILED,\n\t\t\t\t\t\t\"Failed to notify daemon of snapshot creation\",\n\t\t\t\t\t\terror,\n\t\t\t\t\t\t{ snapshotId, filePath },\n\t\t\t\t\t)\n\t\t\t\t: createMcpError(McpErrorCode.DAEMON_REQUEST_FAILED, `Failed to notify daemon: ${String(error)}`, {\n\t\t\t\t\t\tsnapshotId,\n\t\t\t\t\t\tfilePath,\n\t\t\t\t\t});\n\t\treturn err(mcpError);\n\t}\n}\n","/**\n * Input Validation & Security Utilities\n *\n * P0-003: Zod-based input validation for all handlers\n * P0-004: Path traversal protection for file operations\n *\n * @module validation\n */\n\nimport { isAbsolute, normalize, relative, resolve } from \"node:path\";\nimport { atomicWriteFileSync as atomicWriteSyncOSS } from \"@snapback-oss/sdk\";\nimport { z } from \"zod\";\n\n// ============================================================================\n// P0-004: Path Traversal Protection\n// ============================================================================\n\n/**\n * Validates that a file path is safe and within workspace bounds\n *\n * @param filePath - The file path to validate\n * @param workspaceRoot - The workspace root directory\n * @returns Validation result with sanitized path or error\n */\nexport function validateFilePath(\n\tfilePath: string,\n\tworkspaceRoot: string,\n): { valid: true; sanitizedPath: string } | { valid: false; error: string } {\n\t// Reject empty paths\n\tif (!filePath || filePath.trim() === \"\") {\n\t\treturn { valid: false, error: \"File path cannot be empty\" };\n\t}\n\n\t// Reject paths with null bytes (common attack vector)\n\tif (filePath.includes(\"\\0\")) {\n\t\treturn { valid: false, error: \"Invalid characters in file path\" };\n\t}\n\n\t// Normalize and resolve the path\n\tconst normalizedPath = normalize(filePath);\n\n\t// Check for obvious traversal attempts\n\tif (normalizedPath.includes(\"..\")) {\n\t\treturn { valid: false, error: \"Path traversal not allowed\" };\n\t}\n\n\t// Resolve to absolute path within workspace\n\tconst absolutePath = isAbsolute(normalizedPath) ? normalizedPath : resolve(workspaceRoot, normalizedPath);\n\n\t// Ensure the resolved path is within workspace\n\tconst relativePath = relative(workspaceRoot, absolutePath);\n\tif (relativePath.startsWith(\"..\") || isAbsolute(relativePath)) {\n\t\treturn { valid: false, error: \"Path must be within workspace\" };\n\t}\n\n\treturn { valid: true, sanitizedPath: absolutePath };\n}\n\n/**\n * Validates an array of file paths\n */\nexport function validateFilePaths(\n\tfilePaths: string[],\n\tworkspaceRoot: string,\n): { valid: true; sanitizedPaths: string[] } | { valid: false; error: string; invalidPath: string } {\n\tconst sanitizedPaths: string[] = [];\n\n\tfor (const filePath of filePaths) {\n\t\tconst result = validateFilePath(filePath, workspaceRoot);\n\t\tif (!result.valid) {\n\t\t\treturn { valid: false, error: result.error, invalidPath: filePath };\n\t\t}\n\t\tsanitizedPaths.push(result.sanitizedPath);\n\t}\n\n\treturn { valid: true, sanitizedPaths };\n}\n\n// ============================================================================\n// P0-002: Atomic Writes (temp file + rename pattern)\n// ============================================================================\n\n/** Maximum file size for context.json (10MB - prevents DoS) */\nexport const MAX_CONTEXT_FILE_SIZE = 10 * 1024 * 1024;\n\n/**\n * Atomically writes a file using temp file + rename pattern.\n * Prevents partial writes on crash and ensures file integrity.\n *\n * @deprecated Use atomicWriteFileSync from \"@snapback-oss/sdk\" directly.\n * This wrapper will be removed after migration is complete.\n *\n * @param filePath - The target file path\n * @param content - Content to write\n * @param options - Write options\n * @returns Success status and any error\n */\nexport function atomicWriteFileSync(\n\tfilePath: string,\n\tcontent: string,\n\toptions: { encoding?: BufferEncoding; maxSize?: number } = {},\n): { success: true } | { success: false; error: string } {\n\tconst { encoding = \"utf8\", maxSize = MAX_CONTEXT_FILE_SIZE } = options;\n\n\t// Re-export from consolidated OSS SDK implementation\n\treturn atomicWriteSyncOSS(filePath, content, { encoding, maxSize });\n}\n\n/**\n * Validates a ref path is safe (used in context.json refs field)\n * More restrictive than file paths - only allows relative paths within workspace\n */\nexport function validateRefPath(\n\trefPath: string,\n\tworkspaceRoot: string,\n): { valid: true; sanitizedPath: string } | { valid: false; error: string } {\n\t// Reject empty paths\n\tif (!refPath || refPath.trim() === \"\") {\n\t\treturn { valid: false, error: \"Reference path cannot be empty\" };\n\t}\n\n\t// Reject paths with null bytes\n\tif (refPath.includes(\"\\0\")) {\n\t\treturn { valid: false, error: \"Invalid characters in reference path\" };\n\t}\n\n\t// Reject absolute paths in refs (refs should always be relative)\n\tif (isAbsolute(refPath)) {\n\t\treturn { valid: false, error: \"Reference paths must be relative\" };\n\t}\n\n\t// Normalize the path\n\tconst normalizedPath = normalize(refPath);\n\n\t// Check for traversal attempts\n\tif (normalizedPath.startsWith(\"..\") || normalizedPath.includes(\"/..\") || normalizedPath.includes(\"\\\\..\")) {\n\t\treturn { valid: false, error: \"Path traversal not allowed in references\" };\n\t}\n\n\t// Resolve and verify within workspace\n\tconst absolutePath = resolve(workspaceRoot, normalizedPath);\n\tconst relativePath = relative(workspaceRoot, absolutePath);\n\n\tif (relativePath.startsWith(\"..\") || isAbsolute(relativePath)) {\n\t\treturn { valid: false, error: \"Reference must be within workspace\" };\n\t}\n\n\treturn { valid: true, sanitizedPath: normalizedPath };\n}\n\n// ============================================================================\n// Consolidated Tool Schemas (7 tools replacing 24 legacy tools)\n// @see stress_test_remediation.md\n// ============================================================================\n\n/**\n * Schema for snap tool (unified entry point)\n * Replaces: begin_task, get_context, prepare_workspace, get_learnings\n *\n * Supports both full-word modes (mode) and legacy single-letter modes (m)\n * At least one mode parameter must be provided\n */\nexport const snapSchema = z\n\t.object({\n\t\t// Mode parameters - at least one required\n\t\tmode: z\n\t\t\t.enum([\"start\", \"check\", \"context\"])\n\t\t\t.optional()\n\t\t\t.describe(\"Mode (full-word, recommended): start=begin task, check=validate code, context=get status\"),\n\t\tm: z.enum([\"s\", \"c\", \"x\"]).optional().describe(\"Legacy mode: s=start, c=check, x=context (use 'mode' instead)\"),\n\t\t// Task parameters\n\t\ttask: z.string().optional().describe(\"Task description (mode: start)\"),\n\t\tt: z.string().optional().describe(\"Legacy: use 'task' instead\"),\n\t\t// File parameters\n\t\tfiles: z.array(z.string()).optional().describe(\"Files to work on (mode: start, check)\"),\n\t\tf: z.array(z.string()).optional().describe(\"Legacy: use 'files' instead\"),\n\t\t// Keyword parameters\n\t\tkeywords: z.array(z.string()).optional().describe(\"Keywords for learning retrieval (mode: start, context)\"),\n\t\tk: z.array(z.string()).optional().describe(\"Legacy: use 'keywords' instead\"),\n\t\t// Intent parameters\n\t\tintent: z\n\t\t\t.enum([\"implement\", \"debug\", \"refactor\", \"review\", \"explore\"])\n\t\t\t.optional()\n\t\t\t.describe(\"Task intent for context loading optimization\"),\n\t\ti: z\n\t\t\t.enum([\"implement\", \"debug\", \"refactor\", \"review\", \"explore\"])\n\t\t\t.optional()\n\t\t\t.describe(\"Legacy: use 'intent' instead\"),\n\t\t// Other parameters\n\t\tthorough: z.boolean().optional().describe(\"Enable thorough 7-layer validation (mode: check)\"),\n\t\tcompact: z\n\t\t\t.boolean()\n\t\t\t.optional()\n\t\t\t.describe(\"Use compact positional wire format instead of labeled (default: false)\"),\n\t\tgoal: z\n\t\t\t.object({\n\t\t\t\tmetric: z.enum([\"bundle\", \"performance\", \"coverage\"]),\n\t\t\t\ttarget: z.number(),\n\t\t\t\tunit: z.string(),\n\t\t\t})\n\t\t\t.optional()\n\t\t\t.describe(\"Goal for task completion validation (mode: start)\"),\n\t})\n\t.refine((data) => data.mode !== undefined || data.m !== undefined, {\n\t\tmessage: \"Either 'mode' (start|check|context) or 'm' (s|c|x) must be provided\",\n\t\tpath: [\"mode\"],\n\t});\n\n/**\n * Schema for snap_end tool (task completion)\n * Replaces: complete_task, review_work, what_changed\n *\n * Supports both full-word params (learnings) and legacy (l)\n */\nexport const snapEndSchema = z.object({\n\tok: z\n\t\t.union([z.literal(0), z.literal(1)])\n\t\t.optional()\n\t\t.describe(\"Success: 1=ok, 0=failed\"),\n\t// Learnings parameters\n\tlearnings: z.array(z.string()).optional().describe(\"Quick learnings as strings\"),\n\tl: z.array(z.string()).optional().describe(\"Legacy: use 'learnings' instead\"),\n\t// Other parameters\n\tnotes: z.string().optional().describe(\"Completion notes\"),\n\toutcome: z.enum([\"completed\", \"abandoned\", \"blocked\"]).optional().describe(\"Task outcome\"),\n\t// Efficiency tracking (agent-reported metrics)\n\tefficiency: z\n\t\t.object({\n\t\t\tsaved: z.string().optional().describe(\"Tokens saved (e.g., '~12K')\"),\n\t\t\tprevented: z.string().optional().describe(\"Mistakes prevented\"),\n\t\t\thelped: z.string().optional().describe(\"What context helped most\"),\n\t\t})\n\t\t.optional()\n\t\t.describe(\"Agent-reported efficiency metrics\"),\n\t// Internal survey (LLM self-assessment)\n\tsurvey: z\n\t\t.object({\n\t\t\tpatterns_used: z.number().optional().describe(\"Patterns applied from context\"),\n\t\t\tpitfalls_avoided: z.number().optional().describe(\"Pitfalls avoided due to warnings\"),\n\t\t\thelpfulness: z.number().min(1).max(5).optional().describe(\"Helpfulness rating 1-5\"),\n\t\t\tunhelpful_count: z.number().optional().describe(\"Count of unhelpful suggestions\"),\n\t\t})\n\t\t.optional()\n\t\t.describe(\"LLM self-assessment (internal)\"),\n\tcompact: z.boolean().optional().describe(\"Use compact wire format\"),\n});\n\n/**\n * Schema for snap_learn tool (mid-session learning capture)\n * Replaces: learn\n *\n * Supports both full-word params (trigger, action, source) and legacy (t, a, s)\n * At least one of each pair must be provided\n */\nexport const snapLearnSchema = z\n\t.object({\n\t\t// Full-word parameters (recommended)\n\t\ttrigger: z.string().optional().describe(\"What situation triggers this learning\"),\n\t\taction: z.string().optional().describe(\"What to do when triggered\"),\n\t\tsource: z.string().optional().describe(\"Where this learning originated (optional)\"),\n\t\t// Legacy parameters\n\t\tt: z.string().optional().describe(\"Legacy: use 'trigger' instead\"),\n\t\ta: z.string().optional().describe(\"Legacy: use 'action' instead\"),\n\t\ts: z.string().optional().describe(\"Legacy: use 'source' instead\"),\n\t\t// Type (supports both full-word and abbreviated)\n\t\ttype: z\n\t\t\t.enum([\"pattern\", \"pitfall\", \"efficiency\", \"discovery\", \"workflow\", \"pat\", \"pit\", \"eff\", \"disc\", \"wf\"])\n\t\t\t.optional()\n\t\t\t.describe(\"Learning type (default: pattern)\"),\n\t})\n\t.refine(\n\t\t(data) =>\n\t\t\t(data.trigger !== undefined || data.t !== undefined) && (data.action !== undefined || data.a !== undefined),\n\t\t{\n\t\t\tmessage: \"Either 'trigger' or 't' AND 'action' or 'a' must be provided\",\n\t\t\tpath: [\"trigger\"],\n\t\t},\n\t);\n\n/**\n * Schema for snap_violation tool (violation reporting)\n * Replaces: report_violation\n *\n * Supports both full-word params (description, reason, prevention) and legacy (what, why, prevent)\n */\nexport const snapViolationSchema = z\n\t.object({\n\t\ttype: z.string().min(1).describe(\"Violation type (e.g., 'silent_catch', 'missing_auth_check')\"),\n\t\tfile: z.string().min(1).describe(\"File where violation occurred\"),\n\t\t// Full-word parameters (recommended)\n\t\tdescription: z.string().optional().describe(\"What went wrong - description of the violation\"),\n\t\treason: z.string().optional().describe(\"Why it happened - root cause\"),\n\t\tprevention: z.string().optional().describe(\"How to prevent this in future\"),\n\t\t// Legacy parameters\n\t\twhat: z.string().optional().describe(\"Legacy: use 'description' instead\"),\n\t\twhy: z.string().optional().describe(\"Legacy: use 'reason' instead\"),\n\t\tprevent: z.string().optional().describe(\"Legacy: use 'prevention' instead\"),\n\t})\n\t.refine(\n\t\t(data) =>\n\t\t\t(data.description !== undefined || data.what !== undefined) &&\n\t\t\t(data.prevention !== undefined || data.prevent !== undefined),\n\t\t{\n\t\t\tmessage: \"Either 'description' or 'what' AND 'prevention' or 'prevent' must be provided\",\n\t\t\tpath: [\"description\"],\n\t\t},\n\t);\n\n/**\n * Schema for check tool (code validation)\n * Replaces: quick_check, check_patterns, validate\n *\n * Supports both full-word mode (mode) and legacy (m)\n */\nexport const checkSchema = z.object({\n\t// Mode parameters\n\tmode: z\n\t\t.enum([\n\t\t\t\"quick\",\n\t\t\t\"full\",\n\t\t\t\"patterns\",\n\t\t\t\"build\",\n\t\t\t\"impact\",\n\t\t\t\"circular\",\n\t\t\t\"docs\",\n\t\t\t\"learnings\",\n\t\t\t\"architecture\",\n\t\t\t\"trace\",\n\t\t])\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Mode (full-word, recommended): quick=fast validation, full=comprehensive, patterns=rule check, trace=dependency analysis\",\n\t\t),\n\tm: z\n\t\t.enum([\"q\", \"f\", \"p\", \"b\", \"i\", \"c\", \"d\", \"l\", \"a\", \"t\"])\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Legacy mode: q=quick, f=full, p=patterns, b=build, i=impact, c=circular, d=docs, l=learnings, a=architecture, t=trace\",\n\t\t),\n\t// File parameters\n\tfiles: z\n\t\t.union([z.string(), z.array(z.string())])\n\t\t.optional()\n\t\t.describe(\"File(s) to check\"),\n\tf: z\n\t\t.union([z.string(), z.array(z.string())])\n\t\t.optional()\n\t\t.describe(\"Legacy: use 'files' instead\"),\n\tcode: z.string().optional().describe(\"Code to validate (for patterns/validate mode)\"),\n\ttests: z.boolean().optional().describe(\"Run tests (quick mode only)\"),\n\tcompact: z.boolean().optional().describe(\"Use compact wire format\"),\n});\n\n/**\n * Schema for snap_fix tool (snapshot operations)\n * Replaces: snapshot_list, snapshot_restore, compare_snapshots\n *\n * Supports both full-word params and legacy alternatives\n */\nexport const snapFixSchema = z.object({\n\taction: z.enum([\"list\", \"restore\", \"diff\"]).optional().describe(\"Operation: list (default), restore, or diff\"),\n\tid: z.string().optional().describe(\"Snapshot ID (for restore/diff)\"),\n\t// Diff parameters\n\tdiffWith: z.string().optional().describe(\"Second snapshot ID (for diff operation)\"),\n\tdiff: z.string().optional().describe(\"Legacy: use 'diffWith' instead\"),\n\t// Dry run parameters\n\tdryRun: z.boolean().optional().describe(\"Preview restore without applying changes\"),\n\tdry: z.boolean().optional().describe(\"Legacy: use 'dryRun' instead\"),\n\t// Other parameters\n\tfiles: z.array(z.string()).optional().describe(\"Specific files to restore (optional filter)\"),\n\tcompact: z.boolean().optional().describe(\"Use compact wire format\"),\n});\n\n/**\n * Schema for snap_help tool (help and discovery)\n * Replaces: meta, get_pairing_protocol\n *\n * Supports both full-word topic and legacy q\n */\nexport const snapHelpSchema = z.object({\n\ttopic: z\n\t\t.enum([\"tools\", \"status\", \"wire\", \"modes\", \"thresholds\", \"all\"])\n\t\t.optional()\n\t\t.describe(\"Help topic: tools, status, wire, modes, thresholds, or all (default)\"),\n\tq: z.enum([\"tools\", \"status\", \"wire\"]).optional().describe(\"Legacy: use 'topic' instead\"),\n});\n\n// ============================================================================\n// Legacy Schemas (DEPRECATED - kept for backward compatibility only)\n// These should not be used in new code. Use consolidated schemas above.\n// ============================================================================\n\n/** @deprecated Use snapSchema instead */\nexport const analyzeSchema = z.object({\n\ttype: z.enum([\"risk\", \"package\"]).describe(\"Analysis type\"),\n\tchanges: z.array(z.unknown()).optional(),\n\tfilePath: z.string().optional(),\n\tpackageName: z.string().optional(),\n\ttargetVersion: z.string().optional(),\n});\n\n/** @deprecated Use snapSchema instead */\nexport const prepareWorkspaceSchema = z.object({\n\tworkspaceId: z.string().optional(),\n});\n\n/** @deprecated Use snapFixSchema instead */\nexport const snapshotCreateSchema = z.object({\n\tfiles: z.array(z.string().min(1)).min(1),\n\treason: z.string().optional(),\n\ttrigger: z.enum([\"manual\", \"mcp\", \"ai_assist\", \"session_end\"]).optional(),\n});\n\n/** @deprecated Use snapFixSchema instead */\nexport const snapshotListSchema = z.object({\n\tlimit: z.number().int().positive().max(100).default(20).optional(),\n\tsince: z.string().datetime().optional(),\n});\n\n/** @deprecated Use snapFixSchema instead */\nexport const snapshotRestoreSchema = z.object({\n\tsnapshotId: z.string().min(1),\n\tfiles: z.array(z.string()).optional(),\n\tdryRun: z.boolean().default(false).optional(),\n});\n\n/** @deprecated Use checkSchema instead */\nexport const validateSchema = z.object({\n\tmode: z.enum([\"quick\", \"comprehensive\"]).default(\"quick\").optional(),\n\tcode: z.string().min(1),\n\tfilePath: z.string().min(1),\n});\n\n/** @deprecated Use snapSchema instead */\nexport const contextSchema = z.object({\n\top: z.enum([\"init\", \"build\", \"validate\", \"status\", \"constraint\", \"check\", \"blockers\"]),\n\tdomain: z.string().optional(),\n\tname: z.string().optional(),\n\tvalue: z.number().optional(),\n});\n\n/** @deprecated Use snapEndSchema instead */\nexport const sessionSchema = z.object({\n\top: z.enum([\"start\", \"recommendations\", \"stats\", \"end\"]),\n\ttaskDescription: z.string().optional(),\n\tfiles: z.array(z.string()).optional(),\n\tacceptLearnings: z.array(z.number()).optional(),\n});\n\n/** @deprecated Use snapLearnSchema instead */\nexport const learnSchema = z.object({\n\ttype: z.enum([\"pattern\", \"pitfall\", \"efficiency\", \"discovery\", \"workflow\"]),\n\ttrigger: z.string().min(1),\n\taction: z.string().min(1),\n\tsource: z.string().optional(),\n});\n\n/** @deprecated Use snapSchema instead */\nexport const acknowledgeRiskSchema = z.object({\n\tfiles: z.array(z.string().min(1)).min(1),\n\treason: z.string().min(1),\n});\n\n/** @deprecated Use snapHelpSchema instead */\nexport const metaSchema = z.object({\n\trandom_string: z.string().optional(),\n});\n\n/** @deprecated Use snapSchema instead */\nexport const getContextSchema = z.object({\n\ttask: z.string().min(1),\n\tfiles: z.array(z.string()).optional(),\n\tkeywords: z.array(z.string()).optional(),\n});\n\n/** @deprecated Use checkSchema instead */\nexport const checkPatternsSchema = z.object({\n\tcode: z.string().min(1),\n\tfilePath: z.string().min(1),\n});\n\n/** @deprecated Use snapViolationSchema instead */\nexport const reportViolationSchema = z.object({\n\ttype: z.string().min(1),\n\tfile: z.string().min(1),\n\twhatHappened: z.string().min(1),\n\twhyItHappened: z.string().min(1),\n\tprevention: z.string().min(1),\n});\n\n/** @deprecated Use snapSchema instead */\nexport const getLearningsSchema = z.object({\n\tkeywords: z.array(z.string().min(1)).min(1),\n\tlimit: z.number().int().positive().max(50).default(10).optional(),\n});\n\n// ============================================================================\n// Validation Helper\n// ============================================================================\n\n/**\n * Validate input against a schema and return structured result\n */\nexport function validateInput<T extends z.ZodType>(\n\tschema: T,\n\tinput: unknown,\n): { valid: true; data: z.infer<T> } | { valid: false; error: string; issues: z.ZodIssue[] } {\n\tconst result = schema.safeParse(input);\n\n\tif (result.success) {\n\t\treturn { valid: true, data: result.data };\n\t}\n\n\tconst errorMessages = result.error.issues.map((issue) => `${issue.path.join(\".\")}: ${issue.message}`).join(\"; \");\n\n\treturn {\n\t\tvalid: false,\n\t\terror: errorMessages,\n\t\tissues: result.error.issues,\n\t};\n}\n\n/**\n * Schema registry for consolidated tools (7 tools)\n * @see stress_test_remediation.md\n */\nexport const TOOL_SCHEMAS: Record<string, z.ZodType> = {\n\tsnap: snapSchema,\n\tsnap_end: snapEndSchema,\n\tsnap_fix: snapFixSchema,\n\tsnap_help: snapHelpSchema,\n\tsnap_learn: snapLearnSchema,\n\tsnap_violation: snapViolationSchema,\n\tcheck: checkSchema,\n};\n\n/**\n * Legacy schema registry for backward compatibility\n * @deprecated Use TOOL_SCHEMAS (consolidated) instead\n */\nexport const LEGACY_TOOL_SCHEMAS: Record<string, z.ZodType> = {\n\tanalyze: analyzeSchema,\n\tprepare_workspace: prepareWorkspaceSchema,\n\tsnapshot_create: snapshotCreateSchema,\n\tsnapshot_list: snapshotListSchema,\n\tsnapshot_restore: snapshotRestoreSchema,\n\tvalidate: validateSchema,\n\tcontext: contextSchema,\n\tsession: sessionSchema,\n\tlearn: learnSchema,\n\tacknowledge_risk: acknowledgeRiskSchema,\n\tmeta: metaSchema,\n\tget_context: getContextSchema,\n\tcheck_patterns: checkPatternsSchema,\n\treport_violation: reportViolationSchema,\n\tget_learnings: getLearningsSchema,\n};\n\n/**\n * Get schema for a tool by name\n */\nexport function getToolSchema(toolName: string): z.ZodType | undefined {\n\treturn TOOL_SCHEMAS[toolName];\n}\n","/**\n * SnapshotService - Shared snapshot operations for MCP tools\n *\n * Eliminates duplication across:\n * - handlers.ts (snapshot_create)\n * - begin-task.ts (auto-snapshot)\n * - complete-task.ts (final snapshot)\n *\n * @module services/snapshot-service\n */\n\nimport { createHash } from \"node:crypto\";\nimport { existsSync, readFileSync } from \"node:fs\";\nimport { resolve } from \"node:path\";\nimport { createStorage, type SnapshotManifest } from \"@snapback/engine\";\nimport { notifySnapshotCreatedViaDaemon } from \"../daemon/client-facade.js\";\nimport { validateFilePaths } from \"../validation.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface SnapshotOptions {\n\t/** Description for the snapshot */\n\tdescription: string;\n\t/** Trigger type */\n\ttrigger: \"manual\" | \"auto\" | \"ai-detection\";\n\t/** Skip deduplication check */\n\tskipDedup?: boolean;\n\t/** Number of recent snapshots to check for duplicates */\n\tdedupWindow?: number;\n}\n\nexport interface SnapshotResult {\n\tsuccess: boolean;\n\tsnapshot?: {\n\t\tid: string;\n\t\tfileCount: number;\n\t\ttotalSize: number;\n\t\tcreatedAt: number;\n\t};\n\t/** True if existing snapshot was reused */\n\treused?: boolean;\n\treusedSnapshotId?: string;\n\treusedReason?: string;\n\terror?: string;\n}\n\nexport interface FileHashResult {\n\tpath: string;\n\thash: string;\n\texists: boolean;\n}\n\n// =============================================================================\n// HASH UTILITIES\n// =============================================================================\n\n/**\n * Compute SHA-256 hash for file content\n */\nfunction hashContent(content: string): string {\n\treturn createHash(\"sha256\").update(content).digest(\"hex\").substring(0, 16);\n}\n\n/**\n * Get hashes for multiple files\n */\nexport function getFileHashes(files: string[], workspaceRoot: string): FileHashResult[] {\n\treturn files.map((file) => {\n\t\tconst fullPath = resolve(workspaceRoot, file);\n\t\tif (!existsSync(fullPath)) {\n\t\t\treturn { path: file, hash: \"\", exists: false };\n\t\t}\n\t\ttry {\n\t\t\tconst content = readFileSync(fullPath, \"utf8\");\n\t\t\treturn { path: file, hash: hashContent(content), exists: true };\n\t\t} catch {\n\t\t\treturn { path: file, hash: \"\", exists: false };\n\t\t}\n\t});\n}\n\n/**\n * Check if current files match a recent snapshot\n */\nexport function findMatchingSnapshot(\n\tcurrentHashes: FileHashResult[],\n\tsnapshots: SnapshotManifest[],\n\twindowSize = 5,\n): { matched: boolean; snapshotId?: string; createdAt?: number } {\n\tconst recentSnapshots = snapshots.slice(0, windowSize);\n\n\tfor (const snapshot of recentSnapshots) {\n\t\t// Check if all current files match snapshot files by hash (blobId is the hash)\n\t\tconst snapshotFileHashes = new Map(\n\t\t\tsnapshot.files.map((f: { path: string; blobId: string }) => [f.path, f.blobId]),\n\t\t);\n\n\t\tconst allMatch = currentHashes.every((current) => {\n\t\t\tif (!current.exists) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst snapshotHash = snapshotFileHashes.get(current.path);\n\t\t\treturn snapshotHash === current.hash;\n\t\t});\n\n\t\tif (allMatch && currentHashes.length === snapshot.files.length) {\n\t\t\treturn {\n\t\t\t\tmatched: true,\n\t\t\t\tsnapshotId: snapshot.id,\n\t\t\t\tcreatedAt: snapshot.createdAt,\n\t\t\t};\n\t\t}\n\t}\n\n\treturn { matched: false };\n}\n\n// =============================================================================\n// SNAPSHOT SERVICE\n// =============================================================================\n\nexport class SnapshotService {\n\tprivate storage: ReturnType<typeof createStorage>;\n\tprivate workspaceRoot: string;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.storage = createStorage(workspaceRoot);\n\t}\n\n\t/**\n\t * Create a snapshot from file paths with optional deduplication\n\t *\n\t * @example\n\t * ```typescript\n\t * const service = new SnapshotService(workspaceRoot);\n\t * const result = await service.createFromFiles(\n\t *   [\"src/index.ts\", \"src/utils.ts\"],\n\t *   { description: \"Pre-refactor\", trigger: \"ai-detection\" }\n\t * );\n\t * if (result.success) {\n\t *   console.log(`Created snapshot: ${result.snapshot.id}`);\n\t * }\n\t * ```\n\t */\n\tasync createFromFiles(files: string[], options: SnapshotOptions): Promise<SnapshotResult> {\n\t\tif (!files || files.length === 0) {\n\t\t\treturn { success: false, error: \"No files provided\" };\n\t\t}\n\n\t\t// Validate paths\n\t\tconst pathValidation = validateFilePaths(files, this.workspaceRoot);\n\t\tif (!pathValidation.valid) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: `Invalid path: ${pathValidation.invalidPath} - ${pathValidation.error}`,\n\t\t\t};\n\t\t}\n\n\t\t// Check for deduplication\n\t\tif (!options.skipDedup) {\n\t\t\tconst currentHashes = getFileHashes(files, this.workspaceRoot);\n\t\t\tconst existingSnapshots = this.storage.listSnapshots();\n\t\t\tconst match = findMatchingSnapshot(currentHashes, existingSnapshots, options.dedupWindow ?? 5);\n\n\t\t\tif (match.matched && match.snapshotId) {\n\t\t\t\tconst createdAtDate = match.createdAt ? new Date(match.createdAt) : new Date();\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\treused: true,\n\t\t\t\t\treusedSnapshotId: match.snapshotId,\n\t\t\t\t\treusedReason: `Files unchanged since ${createdAtDate.toLocaleString()}`,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Read file contents\n\t\ttry {\n\t\t\tconst fileContents = pathValidation.sanitizedPaths\n\t\t\t\t.filter((fullPath) => existsSync(fullPath))\n\t\t\t\t.map((fullPath, idx) => ({\n\t\t\t\t\tpath: files[idx],\n\t\t\t\t\tcontent: readFileSync(fullPath, \"utf8\"),\n\t\t\t\t}));\n\n\t\t\tif (fileContents.length === 0) {\n\t\t\t\treturn { success: false, error: \"No readable files found\" };\n\t\t\t}\n\n\t\t\t// Create snapshot\n\t\t\tconst snapshot = await this.storage.createSnapshot(fileContents, {\n\t\t\t\tdescription: options.description,\n\t\t\t\ttrigger: options.trigger,\n\t\t\t});\n\n\t\t\t// CRITICAL: Notify daemon so Extension vitals can reset pressure\n\t\t\t// Without this, MCP-created snapshots don't reset the vitals pressure gauge,\n\t\t\t// causing the \"snapshot recommended\" popup to persist even after snapshots.\n\t\t\t// The daemon forwards this as SNAPSHOT_CREATED event to the EventBus.\n\t\t\tvoid notifySnapshotCreatedViaDaemon(\n\t\t\t\tthis.workspaceRoot,\n\t\t\t\tsnapshot.id,\n\t\t\t\tfiles[0], // Primary file path for vitals\n\t\t\t\toptions.trigger,\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tsnapshot: {\n\t\t\t\t\tid: snapshot.id,\n\t\t\t\t\tfileCount: snapshot.files.length,\n\t\t\t\t\ttotalSize: snapshot.totalSize,\n\t\t\t\t\tcreatedAt: snapshot.createdAt,\n\t\t\t\t},\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * List recent snapshots\n\t */\n\tlistSnapshots(limit = 20): SnapshotManifest[] {\n\t\treturn this.storage.listSnapshots().slice(0, limit);\n\t}\n\n\t/**\n\t * Get a specific snapshot\n\t */\n\tgetSnapshot(id: string): SnapshotManifest | null {\n\t\treturn this.storage.getSnapshot(id);\n\t}\n}\n\n// =============================================================================\n// FACTORY\n// =============================================================================\n\n/**\n * Service cache to prevent race conditions from concurrent storage initialization\n * Each workspace gets a single SnapshotService instance shared across all MCP tool calls\n */\nconst serviceCache = new Map<string, SnapshotService>();\n\n/**\n * Create a SnapshotService instance (cached per workspace)\n *\n * Caching prevents race conditions where multiple concurrent MCP tool calls\n * would each create a new Storage instance and try to mkdir the same directories.\n *\n * @param workspaceRoot - Absolute path to workspace\n * @returns Cached or new SnapshotService instance\n */\nexport function createSnapshotService(workspaceRoot: string): SnapshotService {\n\tif (!serviceCache.has(workspaceRoot)) {\n\t\tserviceCache.set(workspaceRoot, new SnapshotService(workspaceRoot));\n\t}\n\treturn serviceCache.get(workspaceRoot)!;\n}\n","/**\n * TestCoverageService - Cached test coverage analysis for token efficiency\n *\n * Parses vitest coverage output and builds testsource mapping.\n * Answers \"is there a test for X?\" without grepping.\n *\n * Token savings: 1-2K tokens per coverage question\n *\n * @see CONTEXT_ENHANCEMENT_PLAN.md Feature 4\n * @module services/test-coverage-service\n */\n\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { basename, dirname, join, relative } from \"node:path\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Coverage summary from vitest/istanbul output\n */\ninterface CoverageSummary {\n\ttotal: { lines: { pct: number }; functions: { pct: number }; branches: { pct: number } };\n\t[file: string]: { lines: { pct: number }; functions: { pct: number }; branches: { pct: number } };\n}\n\n/**\n * Test coverage context for files (exposed to begin_task)\n */\nexport interface TestCoverageContext {\n\tfiles: Record<\n\t\tstring,\n\t\t{\n\t\t\thasTests: boolean;\n\t\t\ttestFiles: string[]; // Test files covering this source\n\t\t\tcoverage?: {\n\t\t\t\tlines: number; // % of lines covered\n\t\t\t\tfunctions: number; // % of functions covered\n\t\t\t\tbranches: number; // % of branches covered\n\t\t\t};\n\t\t\tuntestedFunctions?: string[]; // Function names without coverage\n\t\t}\n\t>;\n\tsummary: {\n\t\ttotalFiles: number;\n\t\tfilesWithTests: number;\n\t\taverageCoverage: number;\n\t};\n}\n\n/**\n * Test run result for cache updates\n */\nexport interface TestRunResult {\n\tfile: string;\n\tpassed: boolean;\n\tduration: number;\n}\n\n/**\n * Cached test run info\n */\ninterface CachedTestRun {\n\ttimestamp: number;\n\tresults: TestRunResult[];\n}\n\n// =============================================================================\n// TestCoverageService\n// =============================================================================\n\nexport class TestCoverageService {\n\tprivate workspaceRoot: string;\n\tprivate cacheDir: string;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.workspaceRoot = workspaceRoot;\n\t\tthis.cacheDir = join(workspaceRoot, \".snapback\", \"coverage\");\n\t}\n\n\t/**\n\t * Get test coverage context for planned files\n\t * Main entry point for begin_task integration\n\t */\n\tgetContextForFiles(files: string[]): TestCoverageContext {\n\t\tconst coverageData = this.loadCoverageData();\n\t\tconst testMap = this.buildTestMap();\n\n\t\tconst filesContext: TestCoverageContext[\"files\"] = {};\n\t\tlet filesWithTests = 0;\n\t\tlet totalCoverage = 0;\n\t\tlet filesWithCoverage = 0;\n\n\t\tfor (const file of files) {\n\t\t\tconst relPath = this.toRelative(file);\n\t\t\tconst testFiles = testMap[relPath] || this.inferTestFiles(file);\n\t\t\tconst coverage = coverageData[relPath];\n\n\t\t\tconst hasTests = testFiles.length > 0;\n\t\t\tif (hasTests) filesWithTests++;\n\n\t\t\tfilesContext[file] = {\n\t\t\t\thasTests,\n\t\t\t\ttestFiles,\n\t\t\t\tcoverage: coverage\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tlines: coverage.lines.pct,\n\t\t\t\t\t\t\tfunctions: coverage.functions.pct,\n\t\t\t\t\t\t\tbranches: coverage.branches.pct,\n\t\t\t\t\t\t}\n\t\t\t\t\t: undefined,\n\t\t\t};\n\n\t\t\tif (coverage) {\n\t\t\t\ttotalCoverage += coverage.lines.pct;\n\t\t\t\tfilesWithCoverage++;\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tfiles: filesContext,\n\t\t\tsummary: {\n\t\t\t\ttotalFiles: files.length,\n\t\t\t\tfilesWithTests,\n\t\t\t\taverageCoverage: filesWithCoverage > 0 ? totalCoverage / filesWithCoverage : 0,\n\t\t\t},\n\t\t};\n\t}\n\n\t/**\n\t * Get files with low or no test coverage\n\t * Useful for review and refactor intents\n\t */\n\tgetLowCoverageFiles(threshold = 50): string[] {\n\t\tconst coverageData = this.loadCoverageData();\n\t\tconst lowCoverage: string[] = [];\n\n\t\tfor (const [file, coverage] of Object.entries(coverageData)) {\n\t\t\tif (file === \"total\") continue;\n\t\t\tif (coverage.lines.pct < threshold) {\n\t\t\t\tlowCoverage.push(file);\n\t\t\t}\n\t\t}\n\n\t\treturn lowCoverage.sort((a, b) => {\n\t\t\tconst aCov = coverageData[a]?.lines.pct ?? 0;\n\t\t\tconst bCov = coverageData[b]?.lines.pct ?? 0;\n\t\t\treturn aCov - bCov; // Sort by lowest coverage first\n\t\t});\n\t}\n\n\t/**\n\t * Get overall project coverage summary\n\t */\n\tgetProjectCoverage(): { lines: number; functions: number; branches: number } | null {\n\t\tconst coverageData = this.loadCoverageData();\n\t\tif (coverageData.total) {\n\t\t\treturn {\n\t\t\t\tlines: coverageData.total.lines.pct,\n\t\t\t\tfunctions: coverageData.total.functions.pct,\n\t\t\t\tbranches: coverageData.total.branches.pct,\n\t\t\t};\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Check if a file has tests\n\t */\n\thasTests(file: string): boolean {\n\t\tconst testMap = this.buildTestMap();\n\t\tconst relPath = this.toRelative(file);\n\t\treturn testMap[relPath]?.length > 0 || this.inferTestFiles(file).length > 0;\n\t}\n\n\t/**\n\t * Get test files for a source file\n\t */\n\tgetTestFiles(file: string): string[] {\n\t\tconst testMap = this.buildTestMap();\n\t\tconst relPath = this.toRelative(file);\n\t\treturn testMap[relPath] || this.inferTestFiles(file);\n\t}\n\n\t/**\n\t * Called after test runs to update cache\n\t */\n\tupdateFromTestRun(testResults: TestRunResult[]): void {\n\t\tthis.ensureCacheDir();\n\t\tconst cachePath = join(this.cacheDir, \"last-run.json\");\n\t\tconst data: CachedTestRun = {\n\t\t\ttimestamp: Date.now(),\n\t\t\tresults: testResults,\n\t\t};\n\t\twriteFileSync(cachePath, JSON.stringify(data, null, 2));\n\t}\n\n\t/**\n\t * Get last test run info\n\t */\n\tgetLastTestRun(): CachedTestRun | null {\n\t\tconst cachePath = join(this.cacheDir, \"last-run.json\");\n\t\tif (!existsSync(cachePath)) return null;\n\n\t\ttry {\n\t\t\treturn JSON.parse(readFileSync(cachePath, \"utf8\"));\n\t\t} catch {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Build or update testsource mapping from vitest config\n\t * Called periodically or after test file changes\n\t */\n\tupdateTestMap(mappings: Record<string, string[]>): void {\n\t\tthis.ensureCacheDir();\n\t\tconst cachePath = join(this.cacheDir, \"test-map.json\");\n\t\twriteFileSync(cachePath, JSON.stringify(mappings, null, 2));\n\t}\n\n\t// =========================================================================\n\t// Private Methods\n\t// =========================================================================\n\n\t/**\n\t * Load coverage data from vitest output\n\t */\n\tprivate loadCoverageData(): CoverageSummary {\n\t\t// Try multiple coverage output locations\n\t\tconst locations = [\n\t\t\tjoin(this.workspaceRoot, \"coverage\", \"coverage-summary.json\"),\n\t\t\tjoin(this.workspaceRoot, \".vitest\", \"coverage\", \"coverage-summary.json\"),\n\t\t\tjoin(this.workspaceRoot, \".nyc_output\", \"coverage-summary.json\"),\n\t\t];\n\n\t\tfor (const loc of locations) {\n\t\t\tif (existsSync(loc)) {\n\t\t\t\ttry {\n\t\t\t\t\treturn JSON.parse(readFileSync(loc, \"utf8\"));\n\t\t\t\t} catch {\n\t\t\t\t\t// Corrupted file, try next\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return empty summary if no coverage data found\n\t\treturn { total: { lines: { pct: 0 }, functions: { pct: 0 }, branches: { pct: 0 } } };\n\t}\n\n\t/**\n\t * Build test map from cache or config\n\t */\n\tprivate buildTestMap(): Record<string, string[]> {\n\t\tconst cachePath = join(this.cacheDir, \"test-map.json\");\n\n\t\tif (existsSync(cachePath)) {\n\t\t\ttry {\n\t\t\t\treturn JSON.parse(readFileSync(cachePath, \"utf8\"));\n\t\t\t} catch {\n\t\t\t\t// Cache corrupted, return empty\n\t\t\t}\n\t\t}\n\n\t\treturn {};\n\t}\n\n\t/**\n\t * Infer test files from naming conventions\n\t * Used when no explicit test map exists\n\t */\n\tprivate inferTestFiles(file: string): string[] {\n\t\tconst dir = dirname(file);\n\t\tconst ext = file.endsWith(\".tsx\") ? \".tsx\" : \".ts\";\n\t\tconst base = basename(file, ext);\n\n\t\t// Skip if file is already a test\n\t\tif (base.endsWith(\".test\") || base.endsWith(\".spec\")) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst candidates = [\n\t\t\t// Same directory conventions\n\t\t\tjoin(dir, `${base}.test${ext}`),\n\t\t\tjoin(dir, `${base}.spec${ext}`),\n\t\t\t// __tests__ directory\n\t\t\tjoin(dir, \"__tests__\", `${base}.test${ext}`),\n\t\t\tjoin(dir, \"__tests__\", `${base}.spec${ext}`),\n\t\t\t// test directory parallel to src\n\t\t\tdir.replace(\"/src/\", \"/test/\") + `/${base}.test${ext}`,\n\t\t\tdir.replace(\"/src/\", \"/tests/\") + `/${base}.test${ext}`,\n\t\t\t// apps/package test directories\n\t\t\tdir.replace(/\\/src\\//, \"/__tests__/\") + `/${base}.test${ext}`,\n\t\t];\n\n\t\treturn candidates.filter((c) => existsSync(c));\n\t}\n\n\t/**\n\t * Convert absolute path to relative\n\t */\n\tprivate toRelative(file: string): string {\n\t\tif (file.startsWith(this.workspaceRoot)) {\n\t\t\treturn relative(this.workspaceRoot, file);\n\t\t}\n\t\treturn file;\n\t}\n\n\t/**\n\t * Ensure cache directory exists\n\t */\n\tprivate ensureCacheDir(): void {\n\t\tif (!existsSync(this.cacheDir)) {\n\t\t\tmkdirSync(this.cacheDir, { recursive: true });\n\t\t}\n\t}\n}\n\n// =============================================================================\n// Factory\n// =============================================================================\n\n/**\n * Create TestCoverageService instance\n */\nexport function createTestCoverageService(workspaceRoot: string): TestCoverageService {\n\treturn new TestCoverageService(workspaceRoot);\n}\n\n// =============================================================================\n// Singleton per workspace\n// =============================================================================\n\nconst services = new Map<string, TestCoverageService>();\n\n/**\n * Get or create service for workspace (singleton pattern)\n */\nexport function getTestCoverageService(workspaceRoot: string): TestCoverageService {\n\tif (!services.has(workspaceRoot)) {\n\t\tservices.set(workspaceRoot, new TestCoverageService(workspaceRoot));\n\t}\n\treturn services.get(workspaceRoot)!;\n}\n","/**\n * TieredLearningService - Tiered learning storage for token efficiency\n *\n * Implements three-tier architecture:\n * - Hot: Always loaded (~10-15 entries, critical patterns)\n * - Warm: Loaded based on intent/domain match (~20-30 per domain)\n * - Cold: Query-only, never auto-loaded (archived learnings)\n *\n * Fixes 97% token waste in learning retrieval by loading only relevant\n * learnings based on task intent instead of loading all ~100+ entries.\n *\n * Storage:\n * - .snapback/learnings/hot.jsonl (always loaded)\n * - .snapback/learnings/architecture-patterns.jsonl (intent: implement)\n * - .snapback/learnings/domain-testing.jsonl (intent: debug, review)\n * - .snapback/learnings/anti-patterns.jsonl (intent: debug, review)\n * - .snapback/learnings/workflow-patterns.jsonl (intent: refactor)\n * - .snapback/learnings/learnings.jsonl (cold tier - query only)\n *\n * @module services/tiered-learning-service\n */\n\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport type { Learning, LearningTier } from \"@snapback/intelligence/types\";\n\n// =============================================================================\n// Usage Tracking Types\n// =============================================================================\n\n/**\n * Learning with usage tracking metadata\n */\nexport interface TrackedLearning extends Learning {\n\t/** Number of times this learning was loaded */\n\taccessCount?: number;\n\t/** Number of times this learning was applied/useful */\n\tappliedCount?: number;\n\t/** Last time this learning was accessed */\n\tlastAccessed?: string;\n\t/** When this learning was promoted to hot tier */\n\tpromotedAt?: string;\n}\n\n/**\n * Usage stats file format\n */\ninterface UsageStats {\n\t[learningId: string]: {\n\t\taccessCount: number;\n\t\tappliedCount: number;\n\t\tlastAccessed: string;\n\t};\n}\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Task intent for domain file mapping\n */\nexport type TaskIntent = \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\n/**\n * Options for loading tiered learnings\n */\nexport interface LoadTieredLearningsOptions {\n\t/** Task intent for domain file selection */\n\tintent: TaskIntent | string;\n\t/** Keywords for relevance scoring and domain detection */\n\tkeywords: string[];\n\t/** File paths for domain detection (e.g., apps/vscode/...  domain-vscode) */\n\tfilePaths?: string[];\n\t/** Maximum learnings to return (default: 10) */\n\tmaxLearnings?: number;\n}\n\n/**\n * Scored learning with relevance metadata\n */\nexport interface ScoredLearning extends Learning {\n\t/** Relevance score (0-1) */\n\tscore: number;\n\t/** How the learning was loaded */\n\tloadedFrom: \"hot\" | \"warm\" | \"cold\";\n}\n\n// =============================================================================\n// Constants\n// =============================================================================\n\n/**\n * Intent  Domain file mapping\n *\n * Based on INDEX.md domain signals and task intent.\n * Each intent loads specific domain files from warm tier.\n *\n * Updated: Now includes all domain files for comprehensive coverage.\n * Domain-specific files are also loaded via keyword detection below.\n */\nexport const INTENT_LEARNING_FILES: Record<TaskIntent, string[]> = {\n\timplement: [\n\t\t\"architecture-patterns.jsonl\",\n\t\t\"architecture-context.jsonl\",\n\t\t\"domain-intelligence.jsonl\",\n\t\t// Domain files loaded via keyword detection, but include common ones\n\t],\n\tdebug: [\n\t\t\"anti-patterns.jsonl\",\n\t\t\"domain-testing.jsonl\",\n\t\t\"architecture-patterns.jsonl\", // Errors often violate patterns\n\t],\n\trefactor: [\n\t\t\"workflow-patterns.jsonl\",\n\t\t\"architecture-context.jsonl\",\n\t\t\"anti-patterns.jsonl\", // Avoid known pitfalls during refactor\n\t],\n\treview: [\"anti-patterns.jsonl\", \"domain-testing.jsonl\", \"architecture-patterns.jsonl\"],\n\texplore: [\"architecture-context.jsonl\", \"workflow-patterns.jsonl\"],\n};\n\n// =============================================================================\n// Keyword  Domain File Detection\n// Based on INDEX.md domain signals for dynamic domain loading\n// =============================================================================\n\n/**\n * Keyword to domain file mapping\n * Implements the domain signals documented in .snapback/learnings/INDEX.md\n */\nexport const KEYWORD_DOMAIN_MAP: Record<string, string> = {\n\t// VSCode Extension domain\n\tvscode: \"domain-vscode.jsonl\",\n\textension: \"domain-vscode.jsonl\",\n\tactivation: \"domain-vscode.jsonl\",\n\twebview: \"domain-vscode.jsonl\",\n\t\"vs code\": \"domain-vscode.jsonl\",\n\n\t// Web/Next.js domain\n\tnextjs: \"domain-web.jsonl\",\n\t\"next.js\": \"domain-web.jsonl\",\n\tnext: \"domain-web.jsonl\",\n\treact: \"domain-web.jsonl\",\n\tclient: \"domain-web.jsonl\",\n\tturbopack: \"domain-web.jsonl\",\n\t\"use client\": \"domain-web.jsonl\",\n\tbiome: \"domain-web.jsonl\",\n\n\t// API/Backend domain\n\tapi: \"domain-api.jsonl\",\n\tprocedure: \"domain-api.jsonl\",\n\torpc: \"domain-api.jsonl\",\n\tservice: \"domain-api.jsonl\",\n\tbackend: \"domain-api.jsonl\",\n\tdrizzle: \"domain-api.jsonl\",\n\n\t// MCP/CLI domain\n\tmcp: \"domain-mcp-cli.jsonl\",\n\tcli: \"domain-mcp-cli.jsonl\",\n\tcommander: \"domain-mcp-cli.jsonl\",\n\t\"model context protocol\": \"domain-mcp-cli.jsonl\",\n\tstdio: \"domain-mcp-cli.jsonl\",\n\n\t// Testing domain\n\tvitest: \"domain-testing.jsonl\",\n\ttest: \"domain-testing.jsonl\",\n\ttesting: \"domain-testing.jsonl\",\n\tcoverage: \"domain-testing.jsonl\",\n\tspec: \"domain-testing.jsonl\",\n\tmock: \"domain-testing.jsonl\",\n\n\t// Intelligence domain\n\tvalidation: \"domain-intelligence.jsonl\",\n\tlearning: \"domain-intelligence.jsonl\",\n\tvitals: \"domain-intelligence.jsonl\",\n\tintelligence: \"domain-intelligence.jsonl\",\n\tadvisory: \"domain-intelligence.jsonl\",\n};\n\n/**\n * File path patterns to domain file mapping\n * Detects domain from file paths in task\n */\nconst FILE_PATH_DOMAIN_MAP: Record<string, string> = {\n\t\"apps/vscode\": \"domain-vscode.jsonl\",\n\t\"apps/web\": \"domain-web.jsonl\",\n\t\"apps/api\": \"domain-api.jsonl\",\n\t\"packages/mcp\": \"domain-mcp-cli.jsonl\",\n\t\"packages/cli\": \"domain-mcp-cli.jsonl\",\n\t\"packages/intelligence\": \"domain-intelligence.jsonl\",\n\t\".test.\": \"domain-testing.jsonl\",\n\t\".spec.\": \"domain-testing.jsonl\",\n\t__tests__: \"domain-testing.jsonl\",\n};\n\n/**\n * Detect domain files from keywords\n * @param keywords - Keywords extracted from task description\n * @returns Array of domain file names to load\n */\nexport function detectDomainFilesFromKeywords(keywords: string[]): string[] {\n\tconst detected = new Set<string>();\n\n\tfor (const keyword of keywords) {\n\t\tconst lowerKeyword = keyword.toLowerCase();\n\n\t\t// Direct match\n\t\tif (KEYWORD_DOMAIN_MAP[lowerKeyword]) {\n\t\t\tdetected.add(KEYWORD_DOMAIN_MAP[lowerKeyword]);\n\t\t\tcontinue;\n\t\t}\n\n\t\t// Partial match (e.g., \"vscode-extension\" contains \"vscode\")\n\t\tfor (const [key, domain] of Object.entries(KEYWORD_DOMAIN_MAP)) {\n\t\t\tif (lowerKeyword.includes(key) || key.includes(lowerKeyword)) {\n\t\t\t\tdetected.add(domain);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn [...detected];\n}\n\n/**\n * Detect domain files from file paths\n * @param filePaths - File paths from task\n * @returns Array of domain file names to load\n */\nexport function detectDomainFilesFromPaths(filePaths: string[]): string[] {\n\tconst detected = new Set<string>();\n\n\tfor (const filePath of filePaths) {\n\t\tfor (const [pattern, domain] of Object.entries(FILE_PATH_DOMAIN_MAP)) {\n\t\t\tif (filePath.includes(pattern)) {\n\t\t\t\tdetected.add(domain);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn [...detected];\n}\n\n/** Default domain files when intent is unknown */\nconst DEFAULT_DOMAIN_FILES = [\"architecture-patterns.jsonl\"];\n\n/** Hot tier file (always loaded) */\nconst HOT_TIER_FILE = \"hot.jsonl\";\n\n/** Cold tier file (never auto-loaded) */\nconst COLD_TIER_FILE = \"learnings.jsonl\";\n\n/** Maximum default learnings to return */\nconst DEFAULT_MAX_LEARNINGS = 10;\n\n/** Usage stats file */\nconst USAGE_STATS_FILE = \"usage-stats.json\";\n\n/** Threshold for auto-promotion to hot tier */\nexport const HOT_TIER_PROMOTION_THRESHOLD = {\n\t/** Minimum access count to be considered for promotion */\n\tminAccessCount: 3,\n\t/** Minimum applied count (higher weight) */\n\tminAppliedCount: 1,\n\t/** Maximum hot tier size */\n\tmaxHotTierSize: 20,\n\t/** Recency weight - more recent = higher score */\n\trecencyDays: 14,\n};\n\n/** Priority score boost for hot tier - exported for test visibility */\nexport const HOT_TIER_BOOST = 100;\n\n/** Priority score boost for critical priority */\nconst CRITICAL_PRIORITY_BOOST = 50;\n\n/** Priority score boost for high priority */\nconst HIGH_PRIORITY_BOOST = 25;\n\n// =============================================================================\n// Utility Functions\n// =============================================================================\n\n/**\n * Load JSONL file, skipping malformed lines\n */\nfunction loadJsonlSafe<T>(filepath: string): T[] {\n\tif (!existsSync(filepath)) {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\tconst content = readFileSync(filepath, \"utf8\");\n\t\tconst lines = content.split(\"\\n\").filter(Boolean);\n\t\tconst items: T[] = [];\n\n\t\tfor (const line of lines) {\n\t\t\ttry {\n\t\t\t\titems.push(JSON.parse(line));\n\t\t\t} catch {\n\t\t\t\t// Skip malformed lines silently\n\t\t\t}\n\t\t}\n\n\t\treturn items;\n\t} catch {\n\t\treturn [];\n\t}\n}\n\n/**\n * Score a learning based on keyword relevance\n */\nfunction scoreLearning(learning: Learning, keywords: string[]): number {\n\tif (keywords.length === 0) {\n\t\treturn 0;\n\t}\n\n\tconst triggerText = Array.isArray(learning.trigger) ? learning.trigger.join(\" \") : learning.trigger || \"\";\n\n\tconst searchText = `${triggerText} ${learning.action || \"\"} ${learning.context || \"\"}`.toLowerCase();\n\n\tlet matches = 0;\n\tfor (const keyword of keywords) {\n\t\tif (searchText.includes(keyword.toLowerCase())) {\n\t\t\tmatches++;\n\t\t}\n\t}\n\n\treturn matches / keywords.length;\n}\n\n/**\n * Get priority boost based on learning priority\n */\nfunction getPriorityBoost(learning: Learning): number {\n\tconst priority = (learning as any).priority;\n\tif (priority === \"critical\") {\n\t\treturn CRITICAL_PRIORITY_BOOST;\n\t}\n\tif (priority === \"high\") {\n\t\treturn HIGH_PRIORITY_BOOST;\n\t}\n\treturn 0;\n}\n\n// =============================================================================\n// TieredLearningService\n// =============================================================================\n\nexport class TieredLearningService {\n\tprivate learningsDir: string;\n\n\tconstructor(workspaceRoot: string) {\n\t\tthis.learningsDir = join(workspaceRoot, \".snapback\", \"learnings\");\n\t}\n\n\t/**\n\t * Load learnings from tiered storage based on intent\n\t *\n\t * @param options - Loading options (intent, keywords, maxLearnings)\n\t * @returns Scored and ranked learnings\n\t */\n\tasync loadTieredLearnings(options: LoadTieredLearningsOptions): Promise<ScoredLearning[]> {\n\t\tconst { intent, keywords, filePaths = [], maxLearnings = DEFAULT_MAX_LEARNINGS } = options;\n\n\t\t// Track loaded learnings by ID for deduplication\n\t\tconst loadedIds = new Set<string>();\n\t\tconst allLearnings: ScoredLearning[] = [];\n\n\t\t// 1. ALWAYS load hot tier\n\t\tconst hotLearnings = this.loadHotTier();\n\t\tfor (const learning of hotLearnings) {\n\t\t\tconst id = learning.id || this.generateId(learning);\n\t\t\tif (!loadedIds.has(id)) {\n\t\t\t\tloadedIds.add(id);\n\t\t\t\tallLearnings.push({\n\t\t\t\t\t...learning,\n\t\t\t\t\tscore: scoreLearning(learning, keywords) + HOT_TIER_BOOST + getPriorityBoost(learning),\n\t\t\t\t\tloadedFrom: \"hot\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// 2. Load warm tier based on intent\n\t\tconst intentFiles = INTENT_LEARNING_FILES[intent as TaskIntent] || DEFAULT_DOMAIN_FILES;\n\n\t\t// 3. Detect additional domain files from keywords (NEW)\n\t\tconst keywordDomainFiles = detectDomainFilesFromKeywords(keywords);\n\n\t\t// 4. Detect additional domain files from file paths (NEW)\n\t\tconst pathDomainFiles = detectDomainFilesFromPaths(filePaths);\n\n\t\t// 5. Combine all warm tier files (dedupe)\n\t\tconst allWarmFiles = [...new Set([...intentFiles, ...keywordDomainFiles, ...pathDomainFiles])];\n\n\t\t// 6. Load learnings from all warm tier files\n\t\tfor (const filename of allWarmFiles) {\n\t\t\tconst filepath = join(this.learningsDir, filename);\n\t\t\tconst domainLearnings = loadJsonlSafe<Learning>(filepath);\n\n\t\t\t// Extract domain from filename\n\t\t\tconst domain = filename.replace(/^domain-/, \"\").replace(/\\.jsonl$/, \"\");\n\n\t\t\tfor (const learning of domainLearnings) {\n\t\t\t\tconst id = learning.id || this.generateId(learning);\n\t\t\t\tif (!loadedIds.has(id)) {\n\t\t\t\t\tloadedIds.add(id);\n\t\t\t\t\tallLearnings.push({\n\t\t\t\t\t\t...learning,\n\t\t\t\t\t\tscore: scoreLearning(learning, keywords) + getPriorityBoost(learning),\n\t\t\t\t\t\tloadedFrom: \"warm\",\n\t\t\t\t\t\ttier: \"warm\" as LearningTier,\n\t\t\t\t\t\tdomain,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// 7. DO NOT auto-load cold tier (learnings.jsonl)\n\t\t// Cold tier is only accessible via explicit query\n\n\t\t// 8. Sort by score (descending) and return top N\n\t\treturn allLearnings.sort((a, b) => b.score - a.score).slice(0, maxLearnings);\n\t}\n\n\t/**\n\t * Load hot tier learnings (always loaded)\n\t */\n\tprivate loadHotTier(): Learning[] {\n\t\tconst hotPath = join(this.learningsDir, HOT_TIER_FILE);\n\t\tconst learnings = loadJsonlSafe<Learning>(hotPath);\n\n\t\t// Mark as hot tier\n\t\treturn learnings.map((l) => ({ ...l, tier: \"hot\" as LearningTier }));\n\t}\n\n\t/**\n\t * Query cold tier for specific keywords (on-demand only)\n\t *\n\t * This method is NOT called by loadTieredLearnings.\n\t * Use it explicitly when searching archived learnings.\n\t */\n\tasync queryColdTier(keywords: string[], maxResults = 10): Promise<ScoredLearning[]> {\n\t\tconst coldPath = join(this.learningsDir, COLD_TIER_FILE);\n\t\tconst learnings = loadJsonlSafe<Learning>(coldPath);\n\n\t\tconst scored: ScoredLearning[] = learnings\n\t\t\t.filter((l) => (l as any).tier === \"cold\" || !(l as any).tier)\n\t\t\t.map((l) => ({\n\t\t\t\t...l,\n\t\t\t\tscore: scoreLearning(l, keywords),\n\t\t\t\tloadedFrom: \"cold\" as const,\n\t\t\t\ttier: \"cold\" as LearningTier,\n\t\t\t}));\n\n\t\treturn scored\n\t\t\t.filter((l) => l.score > 0)\n\t\t\t.sort((a, b) => b.score - a.score)\n\t\t\t.slice(0, maxResults);\n\t}\n\n\t/**\n\t * Generate a deterministic ID for learnings without one\n\t */\n\tprivate generateId(learning: Learning): string {\n\t\tconst trigger = Array.isArray(learning.trigger) ? learning.trigger.join(\"-\") : learning.trigger || \"\";\n\t\treturn `${learning.type}-${trigger.slice(0, 20)}`.replace(/\\s+/g, \"-\").toLowerCase();\n\t}\n\n\t/**\n\t * Clear any cached data\n\t */\n\tclearCache(): void {\n\t\t// Currently no caching, but interface for future optimization\n\t}\n\n\t// =========================================================================\n\t// Usage Tracking Methods\n\t// =========================================================================\n\n\t/**\n\t * Load usage stats from disk\n\t */\n\tprivate loadUsageStats(): UsageStats {\n\t\tconst statsPath = join(this.learningsDir, USAGE_STATS_FILE);\n\t\tif (!existsSync(statsPath)) {\n\t\t\treturn {};\n\t\t}\n\t\ttry {\n\t\t\treturn JSON.parse(readFileSync(statsPath, \"utf8\"));\n\t\t} catch {\n\t\t\treturn {};\n\t\t}\n\t}\n\n\t/**\n\t * Save usage stats to disk\n\t */\n\tprivate saveUsageStats(stats: UsageStats): void {\n\t\tconst statsPath = join(this.learningsDir, USAGE_STATS_FILE);\n\t\ttry {\n\t\t\tmkdirSync(this.learningsDir, { recursive: true });\n\t\t\twriteFileSync(statsPath, JSON.stringify(stats, null, 2));\n\t\t} catch {\n\t\t\t// Best effort - don't fail if can't write\n\t\t}\n\t}\n\n\t/**\n\t * Track that a learning was accessed (loaded for context)\n\t */\n\ttrackAccess(learningIds: string[]): void {\n\t\tconst stats = this.loadUsageStats();\n\t\tconst now = new Date().toISOString();\n\n\t\tfor (const id of learningIds) {\n\t\t\tif (!stats[id]) {\n\t\t\t\tstats[id] = { accessCount: 0, appliedCount: 0, lastAccessed: now };\n\t\t\t}\n\t\t\tstats[id].accessCount++;\n\t\t\tstats[id].lastAccessed = now;\n\t\t}\n\n\t\tthis.saveUsageStats(stats);\n\t}\n\n\t/**\n\t * Track that a learning was applied (marked as useful by user/agent)\n\t */\n\ttrackApplied(learningId: string): void {\n\t\tconst stats = this.loadUsageStats();\n\t\tconst now = new Date().toISOString();\n\n\t\tif (!stats[learningId]) {\n\t\t\tstats[learningId] = { accessCount: 1, appliedCount: 0, lastAccessed: now };\n\t\t}\n\t\tstats[learningId].appliedCount++;\n\t\tstats[learningId].lastAccessed = now;\n\n\t\tthis.saveUsageStats(stats);\n\t}\n\n\t/**\n\t * Calculate promotion score for a learning\n\t * Higher score = more likely to be promoted to hot tier\n\t */\n\tprivate calculatePromotionScore(learning: TrackedLearning, stats: UsageStats): number {\n\t\tconst id = learning.id || this.generateId(learning);\n\t\tconst usageData = stats[id];\n\n\t\tif (!usageData) {\n\t\t\treturn 0;\n\t\t}\n\n\t\t// Base score from counts (applied counts weight 3x more than access)\n\t\tlet score = usageData.accessCount + usageData.appliedCount * 3;\n\n\t\t// Recency boost - more recent = higher score\n\t\tconst lastAccessed = new Date(usageData.lastAccessed);\n\t\tconst daysSinceAccess = (Date.now() - lastAccessed.getTime()) / (1000 * 60 * 60 * 24);\n\t\tif (daysSinceAccess < HOT_TIER_PROMOTION_THRESHOLD.recencyDays) {\n\t\t\tscore *= 1 + (1 - daysSinceAccess / HOT_TIER_PROMOTION_THRESHOLD.recencyDays);\n\t\t}\n\n\t\t// Priority boost\n\t\tif ((learning as any).priority === \"critical\") {\n\t\t\tscore *= 2;\n\t\t} else if ((learning as any).priority === \"high\") {\n\t\t\tscore *= 1.5;\n\t\t}\n\n\t\treturn score;\n\t}\n\n\t/**\n\t * Regenerate hot.jsonl based on usage patterns\n\t *\n\t * Algorithm:\n\t * 1. Load all learnings from cold + warm tiers\n\t * 2. Score each by usage patterns (access, applied, recency)\n\t * 3. Preserve existing hot tier entries with priority: critical\n\t * 4. Fill remaining slots with highest-scoring learnings\n\t * 5. Write new hot.jsonl\n\t *\n\t * @returns Statistics about the regeneration\n\t */\n\tasync regenerateHotTier(): Promise<{\n\t\tpreserved: number;\n\t\tpromoted: number;\n\t\tdemoted: number;\n\t\ttotalHot: number;\n\t}> {\n\t\tconst stats = this.loadUsageStats();\n\n\t\t// Load current hot tier\n\t\tconst currentHot = this.loadHotTier();\n\t\tconst criticalHot = currentHot.filter((l) => (l as any).priority === \"critical\");\n\n\t\t// Load all learnings from cold tier\n\t\tconst coldPath = join(this.learningsDir, COLD_TIER_FILE);\n\t\tconst allLearnings = loadJsonlSafe<TrackedLearning>(coldPath);\n\n\t\t// Also load from warm tier files\n\t\tconst warmFiles = Object.values(INTENT_LEARNING_FILES).flat();\n\t\tconst seenIds = new Set<string>();\n\t\tconst warmLearnings: TrackedLearning[] = [];\n\n\t\tfor (const filename of [...new Set(warmFiles)]) {\n\t\t\tconst filepath = join(this.learningsDir, filename);\n\t\t\tconst learnings = loadJsonlSafe<TrackedLearning>(filepath);\n\t\t\tfor (const l of learnings) {\n\t\t\t\tconst id = l.id || this.generateId(l as Learning);\n\t\t\t\tif (!seenIds.has(id)) {\n\t\t\t\t\tseenIds.add(id);\n\t\t\t\t\twarmLearnings.push(l);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Combine and dedupe\n\t\tconst allCandidates = [...allLearnings, ...warmLearnings];\n\t\tconst candidateMap = new Map<string, TrackedLearning>();\n\t\tfor (const l of allCandidates) {\n\t\t\tconst id = l.id || this.generateId(l as Learning);\n\t\t\tif (!candidateMap.has(id)) {\n\t\t\t\tcandidateMap.set(id, l);\n\t\t\t}\n\t\t}\n\n\t\t// Score all candidates\n\t\tconst scored = Array.from(candidateMap.entries())\n\t\t\t.map(([id, learning]) => ({\n\t\t\t\tid,\n\t\t\t\tlearning,\n\t\t\t\tscore: this.calculatePromotionScore(learning, stats),\n\t\t\t}))\n\t\t\t.filter((item) => {\n\t\t\t\t// Only consider learnings that meet minimum thresholds\n\t\t\t\tconst usageData = stats[item.id];\n\t\t\t\tif (!usageData) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\treturn (\n\t\t\t\t\tusageData.accessCount >= HOT_TIER_PROMOTION_THRESHOLD.minAccessCount ||\n\t\t\t\t\tusageData.appliedCount >= HOT_TIER_PROMOTION_THRESHOLD.minAppliedCount\n\t\t\t\t);\n\t\t\t})\n\t\t\t.sort((a, b) => b.score - a.score);\n\n\t\t// Build new hot tier\n\t\tconst newHot: TrackedLearning[] = [];\n\t\tconst criticalIds = new Set(criticalHot.map((l) => l.id || this.generateId(l)));\n\n\t\t// 1. Always preserve critical entries\n\t\tfor (const l of criticalHot) {\n\t\t\tnewHot.push({\n\t\t\t\t...l,\n\t\t\t\ttier: \"hot\" as LearningTier,\n\t\t\t});\n\t\t}\n\n\t\t// 2. Fill remaining slots with highest-scoring\n\t\tconst _remainingSlots = HOT_TIER_PROMOTION_THRESHOLD.maxHotTierSize - newHot.length;\n\t\tlet promoted = 0;\n\n\t\tfor (const item of scored) {\n\t\t\tif (newHot.length >= HOT_TIER_PROMOTION_THRESHOLD.maxHotTierSize) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (criticalIds.has(item.id)) {\n\t\t\t\tcontinue; // Already added\n\t\t\t}\n\n\t\t\tnewHot.push({\n\t\t\t\t...item.learning,\n\t\t\t\ttier: \"hot\" as LearningTier,\n\t\t\t\tpromotedAt: new Date().toISOString(),\n\t\t\t});\n\t\t\tpromoted++;\n\t\t}\n\n\t\t// Calculate demoted count\n\t\tconst newHotIds = new Set(newHot.map((l) => l.id || this.generateId(l as Learning)));\n\t\tconst demoted = currentHot.filter((l) => {\n\t\t\tconst id = l.id || this.generateId(l);\n\t\t\treturn !newHotIds.has(id);\n\t\t}).length;\n\n\t\t// Write new hot.jsonl\n\t\tconst hotPath = join(this.learningsDir, HOT_TIER_FILE);\n\t\tconst hotContent = `${newHot.map((l) => JSON.stringify(l)).join(\"\\n\")}\\n`;\n\t\twriteFileSync(hotPath, hotContent);\n\n\t\treturn {\n\t\t\tpreserved: criticalHot.length,\n\t\t\tpromoted,\n\t\t\tdemoted,\n\t\t\ttotalHot: newHot.length,\n\t\t};\n\t}\n\n\t/**\n\t * Get usage statistics for analysis\n\t */\n\tgetUsageStats(): UsageStats {\n\t\treturn this.loadUsageStats();\n\t}\n}\n\n// =============================================================================\n// Factory Function\n// =============================================================================\n\n/**\n * Create a TieredLearningService instance\n *\n * Factory function following codebase service patterns.\n * Use this for consistent service instantiation.\n *\n * @param workspaceRoot - The workspace root directory\n * @returns TieredLearningService instance\n *\n * @example\n * const service = createTieredLearningService('/path/to/workspace');\n * const learnings = await service.loadTieredLearnings({ intent: 'implement', keywords: ['auth'] });\n */\nexport function createTieredLearningService(workspaceRoot: string): TieredLearningService {\n\treturn new TieredLearningService(workspaceRoot);\n}\n","/**\n * Init Command\n *\n * Implements snap init - Initialize SnapBack for a workspace.\n * Creates .snapback/ directory and scans for workspace vitals.\n *\n * Flow:\n * 1. Check if already initialized (by extension OR CLI)\n * 2. Scan workspace for framework, package manager, etc.\n * 3. Create .snapback/ directory structure\n * 4. Detect critical files for protection suggestions\n * 5. If logged in, register workspace with server\n *\n * Philosophy: Extension is the PRIMARY onboarding path for 95% of users.\n * CLI is for automation/scripting (CI/CD, dotfiles).\n * CLI should DETECT and RESPECT extension state.\n *\n * @see implementation_plan.md Section 1.1\n */\n\nimport { access, constants, readFile } from \"node:fs/promises\";\nimport { basename, join } from \"node:path\";\nimport { seedLearnings } from \"@snapback/mcp/services\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport ora from \"ora\";\nimport {\n\tcreateSnapbackDirectory,\n\tgetCredentials,\n\tgetWorkspaceConfig,\n\tisLoggedIn,\n\tisSnapbackInitialized,\n\tsaveWorkspaceConfig,\n\tsaveWorkspaceVitals,\n\ttype WorkspaceConfig,\n\ttype WorkspaceVitals,\n} from \"../services/snapback-dir\";\n\n// =============================================================================\n// TYPE DEFINITIONS\n// =============================================================================\n\ninterface FrameworkDetection {\n\tname: string;\n\tversion?: string;\n\tconfidence: number;\n}\n\ninterface PackageJson {\n\tname?: string;\n\tversion?: string;\n\tdependencies?: Record<string, string>;\n\tdevDependencies?: Record<string, string>;\n\tpackageManager?: string;\n\tscripts?: Record<string, string>;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the init command\n */\nexport function createInitCommand(): Command {\n\treturn new Command(\"init\")\n\t\t.description(\"Initialize SnapBack for this workspace\")\n\t\t.option(\"-f, --force\", \"Reinitialize even if already initialized\")\n\t\t.option(\"--no-sync\", \"Don't sync with server\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if already initialized (by extension OR CLI)\n\t\t\t\tconst initialized = await isSnapbackInitialized(cwd);\n\t\t\t\tif (initialized && !options.force) {\n\t\t\t\t\tconst config = await getWorkspaceConfig(cwd);\n\n\t\t\t\t\t// Detect if initialized by VS Code extension\n\t\t\t\t\tconst initSource = await detectInitializationSource(cwd);\n\n\t\t\t\t\tif (initSource === \"extension\") {\n\t\t\t\t\t\t//  PHILOSOPHY: Extension is the PRIMARY onboarding path\n\t\t\t\t\t\t// CLI should respect and acknowledge extension state\n\t\t\t\t\t\tconsole.log(chalk.green(\" SnapBack already initialized by VS Code extension\"));\n\t\t\t\t\t\tconsole.log(chalk.gray(`Workspace ID: ${config?.workspaceId || \"local\"}`));\n\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t\tconsole.log(chalk.cyan(\"The extension has already set up SnapBack for this workspace.\"));\n\t\t\t\t\t\tconsole.log(chalk.cyan(\"You're good to go! \"));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack already initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(`Workspace ID: ${config?.workspaceId || \"local\"}`));\n\t\t\t\t\tconsole.log(chalk.gray(\"Use --force to reinitialize\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst spinner = ora(\"Scanning workspace...\").start();\n\n\t\t\t\t// Scan workspace for vitals\n\t\t\t\tconst vitals = await scanWorkspaceVitals(cwd);\n\n\t\t\t\tspinner.succeed(\n\t\t\t\t\t`Detected: ${vitals.framework || \"Unknown framework\"} + ${vitals.typescript?.enabled ? \"TypeScript\" : \"JavaScript\"} + ${vitals.packageManager || \"npm\"}`,\n\t\t\t\t);\n\n\t\t\t\t// Create .snapback/ directory\n\t\t\t\tspinner.start(\"Creating .snapback/ directory...\");\n\t\t\t\tawait createSnapbackDirectory(cwd);\n\t\t\t\tspinner.succeed(\"Created .snapback/ directory\");\n\n\t\t\t\t// Save vitals\n\t\t\t\tawait saveWorkspaceVitals(vitals, cwd);\n\n\t\t\t\t// Seed tiered learnings\n\t\t\t\tspinner.start(\"Seeding learning patterns...\");\n\t\t\t\tconst seedResult = seedLearnings(cwd);\n\t\t\t\tif (seedResult.success && seedResult.filesCreated.length > 0) {\n\t\t\t\t\tspinner.succeed(\n\t\t\t\t\t\t`Seeded ${seedResult.learningsSeeded} patterns across ${seedResult.filesCreated.length} files`,\n\t\t\t\t\t);\n\t\t\t\t} else if (seedResult.filesCreated.length === 0) {\n\t\t\t\t\tspinner.info(\"Learning patterns already seeded\");\n\t\t\t\t} else {\n\t\t\t\t\tspinner.warn(`Seeding completed with ${seedResult.errors.length} error(s)`);\n\t\t\t\t}\n\n\t\t\t\t// Create workspace config\n\t\t\t\tlet config: WorkspaceConfig = {\n\t\t\t\t\tcreatedAt: new Date().toISOString(),\n\t\t\t\t\tupdatedAt: new Date().toISOString(),\n\t\t\t\t};\n\n\t\t\t\t// If logged in and sync enabled, register with server\n\t\t\t\tif (options.sync && (await isLoggedIn())) {\n\t\t\t\t\tspinner.start(\"Registering workspace with server...\");\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst workspaceId = await registerWorkspace(vitals);\n\t\t\t\t\t\tconst credentials = await getCredentials();\n\n\t\t\t\t\t\tconfig = {\n\t\t\t\t\t\t\t...config,\n\t\t\t\t\t\t\tworkspaceId,\n\t\t\t\t\t\t\ttier: credentials?.tier || \"free\",\n\t\t\t\t\t\t\tsyncEnabled: true,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tspinner.succeed(\"Workspace registered\");\n\t\t\t\t\t} catch (_error) {\n\t\t\t\t\t\tspinner.warn(\"Could not register workspace (offline mode)\");\n\t\t\t\t\t\tconfig.syncEnabled = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tawait saveWorkspaceConfig(config, cwd);\n\n\t\t\t\t// Display summary\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(chalk.green(\" SnapBack initialized!\"));\n\t\t\t\tconsole.log();\n\n\t\t\t\t// Show what was learned\n\t\t\t\tconsole.log(chalk.cyan(\" Learned about your workspace:\"));\n\t\t\t\tif (vitals.framework) {\n\t\t\t\t\tconsole.log(`    Framework: ${vitals.framework}`);\n\t\t\t\t}\n\t\t\t\tif (vitals.packageManager) {\n\t\t\t\t\tconsole.log(`    Package Manager: ${vitals.packageManager}`);\n\t\t\t\t}\n\t\t\t\tif (vitals.typescript?.enabled) {\n\t\t\t\t\tconsole.log(`    TypeScript: ${vitals.typescript.strict ? \"strict mode\" : \"enabled\"}`);\n\t\t\t\t}\n\t\t\t\tif (vitals.criticalFiles && vitals.criticalFiles.length > 0) {\n\t\t\t\t\tconsole.log(`    Critical Files: ${vitals.criticalFiles.length} detected`);\n\t\t\t\t}\n\t\t\t\tconsole.log();\n\n\t\t\t\t// Suggest next steps\n\t\t\t\tconsole.log(chalk.cyan(\"Next steps:\"));\n\t\t\t\tif (!(await isLoggedIn())) {\n\t\t\t\t\tconsole.log(chalk.gray(\"  1. snap login       - Connect to SnapBack cloud\"));\n\t\t\t\t}\n\t\t\t\tconsole.log(chalk.gray(\"  2. snap tools configure  - Set up MCP for your AI tools\"));\n\t\t\t\tconsole.log(chalk.gray(\"  3. snap status      - View workspace health\"));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Initialization failed:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n}\n\n// =============================================================================\n// WORKSPACE SCANNING\n// =============================================================================\n\n/**\n * Scan workspace to detect framework, package manager, and other vitals\n */\nasync function scanWorkspaceVitals(workspaceRoot: string): Promise<WorkspaceVitals> {\n\tconst vitals: WorkspaceVitals = {\n\t\tdetectedAt: new Date().toISOString(),\n\t};\n\n\t// Read package.json if it exists\n\tconst packageJson = await readPackageJson(workspaceRoot);\n\n\tif (packageJson) {\n\t\t// Detect package manager\n\t\tvitals.packageManager = await detectPackageManager(workspaceRoot, packageJson);\n\n\t\t// Detect framework\n\t\tconst framework = detectFramework(packageJson);\n\t\tif (framework) {\n\t\t\tvitals.framework = framework.name;\n\t\t\tvitals.frameworkConfidence = framework.confidence;\n\t\t}\n\t}\n\n\t// Detect TypeScript\n\tvitals.typescript = await detectTypeScript(workspaceRoot);\n\n\t// Detect critical files\n\tvitals.criticalFiles = await detectCriticalFiles(workspaceRoot);\n\n\treturn vitals;\n}\n\n/**\n * Read package.json\n */\nasync function readPackageJson(workspaceRoot: string): Promise<PackageJson | null> {\n\ttry {\n\t\tconst content = await readFile(join(workspaceRoot, \"package.json\"), \"utf-8\");\n\t\treturn JSON.parse(content) as PackageJson;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n/**\n * Detect package manager from lockfiles and package.json\n */\nasync function detectPackageManager(\n\tworkspaceRoot: string,\n\tpackageJson: PackageJson,\n): Promise<\"npm\" | \"pnpm\" | \"yarn\" | \"bun\"> {\n\t// Check packageManager field in package.json\n\tif (packageJson.packageManager) {\n\t\tif (packageJson.packageManager.startsWith(\"pnpm\")) {\n\t\t\treturn \"pnpm\";\n\t\t}\n\t\tif (packageJson.packageManager.startsWith(\"yarn\")) {\n\t\t\treturn \"yarn\";\n\t\t}\n\t\tif (packageJson.packageManager.startsWith(\"bun\")) {\n\t\t\treturn \"bun\";\n\t\t}\n\t\tif (packageJson.packageManager.startsWith(\"npm\")) {\n\t\t\treturn \"npm\";\n\t\t}\n\t}\n\n\t// Check for lockfiles\n\tconst lockfiles: Array<{ file: string; manager: \"npm\" | \"pnpm\" | \"yarn\" | \"bun\" }> = [\n\t\t{ file: \"pnpm-lock.yaml\", manager: \"pnpm\" },\n\t\t{ file: \"yarn.lock\", manager: \"yarn\" },\n\t\t{ file: \"bun.lockb\", manager: \"bun\" },\n\t\t{ file: \"package-lock.json\", manager: \"npm\" },\n\t];\n\n\tfor (const { file, manager } of lockfiles) {\n\t\ttry {\n\t\t\tawait access(join(workspaceRoot, file), constants.F_OK);\n\t\t\treturn manager;\n\t\t} catch {\n\t\t\t// Continue to next lockfile\n\t\t}\n\t}\n\n\treturn \"npm\"; // Default\n}\n\n/**\n * Detect framework from dependencies\n */\nfunction detectFramework(packageJson: PackageJson): FrameworkDetection | null {\n\tconst deps = {\n\t\t...packageJson.dependencies,\n\t\t...packageJson.devDependencies,\n\t};\n\n\t// Framework detection priority (more specific first)\n\tconst frameworks: Array<{\n\t\tname: string;\n\t\tindicators: string[];\n\t\tconfidence: number;\n\t}> = [\n\t\t{ name: \"Next.js\", indicators: [\"next\"], confidence: 0.95 },\n\t\t{ name: \"Nuxt\", indicators: [\"nuxt\"], confidence: 0.95 },\n\t\t{ name: \"Remix\", indicators: [\"@remix-run/react\", \"@remix-run/node\"], confidence: 0.95 },\n\t\t{ name: \"Astro\", indicators: [\"astro\"], confidence: 0.95 },\n\t\t{ name: \"SvelteKit\", indicators: [\"@sveltejs/kit\"], confidence: 0.95 },\n\t\t{ name: \"Svelte\", indicators: [\"svelte\"], confidence: 0.85 },\n\t\t{ name: \"Vue\", indicators: [\"vue\"], confidence: 0.85 },\n\t\t{ name: \"React\", indicators: [\"react\"], confidence: 0.8 },\n\t\t{ name: \"Angular\", indicators: [\"@angular/core\"], confidence: 0.9 },\n\t\t{ name: \"Express\", indicators: [\"express\"], confidence: 0.7 },\n\t\t{ name: \"Fastify\", indicators: [\"fastify\"], confidence: 0.7 },\n\t\t{ name: \"Hono\", indicators: [\"hono\"], confidence: 0.7 },\n\t\t{ name: \"Nest.js\", indicators: [\"@nestjs/core\"], confidence: 0.9 },\n\t];\n\n\tfor (const fw of frameworks) {\n\t\tconst hasIndicator = fw.indicators.some((indicator) => indicator in deps);\n\t\tif (hasIndicator) {\n\t\t\treturn {\n\t\t\t\tname: fw.name,\n\t\t\t\tversion: deps[fw.indicators[0]],\n\t\t\t\tconfidence: fw.confidence,\n\t\t\t};\n\t\t}\n\t}\n\n\treturn null;\n}\n\n/**\n * Detect TypeScript configuration\n */\nasync function detectTypeScript(\n\tworkspaceRoot: string,\n): Promise<{ enabled: boolean; strict?: boolean; version?: string }> {\n\ttry {\n\t\t// Check for tsconfig.json\n\t\tconst tsconfigPath = join(workspaceRoot, \"tsconfig.json\");\n\t\tawait access(tsconfigPath, constants.F_OK);\n\n\t\tconst content = await readFile(tsconfigPath, \"utf-8\");\n\t\t// Parse JSON with comments support (strip comments first)\n\t\tconst stripped = content.replace(/\\/\\*[\\s\\S]*?\\*\\/|\\/\\/.*/g, \"\");\n\t\tconst tsconfig = JSON.parse(stripped) as {\n\t\t\tcompilerOptions?: { strict?: boolean };\n\t\t};\n\n\t\t// Check for strict mode\n\t\tconst strict = tsconfig.compilerOptions?.strict === true;\n\n\t\t// Check for typescript version in package.json\n\t\tconst packageJson = await readPackageJson(workspaceRoot);\n\t\tconst version = packageJson?.devDependencies?.typescript || packageJson?.dependencies?.typescript;\n\n\t\treturn { enabled: true, strict, version };\n\t} catch {\n\t\treturn { enabled: false };\n\t}\n}\n\n/**\n * Detect critical files that should be protected\n */\nasync function detectCriticalFiles(workspaceRoot: string): Promise<string[]> {\n\tconst _criticalPatterns = [\n\t\t// Configuration files\n\t\t\".env\",\n\t\t\".env.local\",\n\t\t\".env.production\",\n\t\t\"*.config.js\",\n\t\t\"*.config.ts\",\n\t\t\"tsconfig.json\",\n\t\t\"package.json\",\n\t\t// Auth-related\n\t\t\"**/auth/**\",\n\t\t\"**/middleware/**\",\n\t\t// Database\n\t\t\"**/schema.*\",\n\t\t\"**/migrations/**\",\n\t\t\"**/prisma/schema.prisma\",\n\t\t\"**/drizzle/**\",\n\t\t// Security\n\t\t\"**/secrets/**\",\n\t\t\"**/keys/**\",\n\t];\n\n\tconst criticalFiles: string[] = [];\n\n\t// Check root-level critical files\n\tconst rootCritical = [\".env\", \".env.local\", \".env.production\", \"tsconfig.json\", \"package.json\"];\n\n\tfor (const file of rootCritical) {\n\t\ttry {\n\t\t\tawait access(join(workspaceRoot, file), constants.F_OK);\n\t\t\tcriticalFiles.push(file);\n\t\t} catch {\n\t\t\t// File doesn't exist\n\t\t}\n\t}\n\n\t// Check for common directories\n\tconst criticalDirs = [\n\t\t{ dir: \"src/auth\", pattern: \"src/auth/**\" },\n\t\t{ dir: \"src/lib/auth\", pattern: \"src/lib/auth/**\" },\n\t\t{ dir: \"app/api\", pattern: \"app/api/**\" },\n\t\t{ dir: \"prisma\", pattern: \"prisma/**\" },\n\t\t{ dir: \"drizzle\", pattern: \"drizzle/**\" },\n\t];\n\n\tfor (const { dir, pattern } of criticalDirs) {\n\t\ttry {\n\t\t\tawait access(join(workspaceRoot, dir), constants.F_OK);\n\t\t\tcriticalFiles.push(pattern);\n\t\t} catch {\n\t\t\t// Directory doesn't exist\n\t\t}\n\t}\n\n\treturn criticalFiles;\n}\n\n// =============================================================================\n// SERVER INTEGRATION\n// =============================================================================\n\nconst DEFAULT_API_URL = process.env.SNAPBACK_API_URL || \"https://api.snapback.dev\";\n\n/**\n * Register workspace with server\n */\nasync function registerWorkspace(vitals: WorkspaceVitals): Promise<string> {\n\tconst credentials = await getCredentials();\n\tif (!credentials) {\n\t\tthrow new Error(\"Not logged in\");\n\t}\n\n\tconst response = await fetch(`${DEFAULT_API_URL}/api/workspaces`, {\n\t\tmethod: \"POST\",\n\t\theaders: {\n\t\t\t\"Content-Type\": \"application/json\",\n\t\t\tAuthorization: `Bearer ${credentials.accessToken}`,\n\t\t},\n\t\tbody: JSON.stringify({\n\t\t\tname: basename(process.cwd()),\n\t\t\tvitals: {\n\t\t\t\tframework: vitals.framework,\n\t\t\t\tpackageManager: vitals.packageManager,\n\t\t\t\ttypescript: vitals.typescript?.enabled,\n\t\t\t\ttypescriptStrict: vitals.typescript?.strict,\n\t\t\t},\n\t\t}),\n\t});\n\n\tif (!response.ok) {\n\t\tthrow new Error(`Server returned ${response.status}`);\n\t}\n\n\tconst data = (await response.json()) as { id: string };\n\treturn data.id;\n}\n\n// =============================================================================\n// INITIALIZATION SOURCE DETECTION\n// =============================================================================\n\n/**\n * Detect if .snapback/ was initialized by VS Code extension or CLI\n *\n * Philosophy: Extension is the PRIMARY onboarding path.\n * CLI should detect and respect extension state.\n *\n * Detection heuristics:\n * - Extension creates specific markers in config.json\n * - Extension-initialized workspaces have different file patterns\n */\nasync function detectInitializationSource(workspaceRoot: string): Promise<\"extension\" | \"cli\" | \"unknown\"> {\n\ttry {\n\t\tconst configPath = join(workspaceRoot, \".snapback\", \"config.json\");\n\t\tconst content = await readFile(configPath, \"utf-8\");\n\t\tconst config = JSON.parse(content) as Record<string, unknown>;\n\n\t\t// Extension sets specific markers\n\t\tif (config.initSource === \"vscode-extension\" || config.source === \"extension\") {\n\t\t\treturn \"extension\";\n\t\t}\n\n\t\t// CLI sets its own marker\n\t\tif (config.initSource === \"cli\" || config.source === \"cli\") {\n\t\t\treturn \"cli\";\n\t\t}\n\n\t\t// Check for extension-specific files\n\t\ttry {\n\t\t\t// Extension creates activation state in globalState, but we can check for patterns\n\t\t\tconst vitalsPath = join(workspaceRoot, \".snapback\", \"vitals.json\");\n\t\t\tconst vitalsContent = await readFile(vitalsPath, \"utf-8\");\n\t\t\tconst vitals = JSON.parse(vitalsContent) as Record<string, unknown>;\n\n\t\t\t// If vitals has detectedAt with specific extension-style timestamp format\n\t\t\tif (vitals.detectedAt && typeof vitals.detectedAt === \"string\") {\n\t\t\t\t// Both could have this, so check for extension-specific markers\n\t\t\t\tif (vitals.source === \"extension\" || vitals.extensionVersion) {\n\t\t\t\t\treturn \"extension\";\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// vitals.json doesn't exist or is invalid\n\t\t}\n\n\t\treturn \"unknown\";\n\t} catch {\n\t\treturn \"unknown\";\n\t}\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { scanWorkspaceVitals, detectFramework, detectPackageManager, detectTypeScript, detectCriticalFiles };\n","/**\n * Status Command\n *\n * Implements snap status - Workspace health check.\n * Shows workspace vitals, session status, and detected issues.\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport { access, constants, readdir, stat } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\tgetCredentials,\n\tgetCurrentSession,\n\tgetProtectedFiles,\n\tgetViolations,\n\tgetWorkspaceConfig,\n\tgetWorkspaceDir,\n\tgetWorkspaceVitals,\n\tisLoggedIn,\n\tisSnapbackInitialized,\n} from \"../services/snapback-dir\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface Issue {\n\tid: string;\n\tseverity: \"warning\" | \"error\";\n\tdescription: string;\n\tfix?: string;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the status command\n */\nexport function createStatusCommand(): Command {\n\treturn new Command(\"status\")\n\t\t.description(\"Show workspace health and status\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst status = await gatherStatus(cwd);\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(status, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdisplayStatus(status);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n}\n\n// =============================================================================\n// STATUS GATHERING\n// =============================================================================\n\ninterface WorkspaceStatus {\n\tinitialized: boolean;\n\tloggedIn: boolean;\n\tuser?: {\n\t\temail: string;\n\t\ttier: \"free\" | \"pro\";\n\t};\n\tworkspace?: {\n\t\tid?: string;\n\t\ttier?: string;\n\t\tsyncEnabled?: boolean;\n\t};\n\tvitals?: {\n\t\tframework?: string;\n\t\tpackageManager?: string;\n\t\ttypescript?: boolean;\n\t\ttypescriptStrict?: boolean;\n\t};\n\tsession?: {\n\t\tid: string;\n\t\ttask?: string;\n\t\tstartedAt: string;\n\t\tsnapshotCount: number;\n\t};\n\tprotection: {\n\t\tcount: number;\n\t\tpatterns: string[];\n\t};\n\tviolations: {\n\t\ttotal: number;\n\t\trecent: number;\n\t};\n\tsnapshots: {\n\t\tcount: number;\n\t\ttotalSize: string;\n\t};\n\tissues: Issue[];\n}\n\n/**\n * Gather all status information\n */\nasync function gatherStatus(workspaceRoot: string): Promise<WorkspaceStatus> {\n\tconst status: WorkspaceStatus = {\n\t\tinitialized: true,\n\t\tloggedIn: false,\n\t\tprotection: { count: 0, patterns: [] },\n\t\tviolations: { total: 0, recent: 0 },\n\t\tsnapshots: { count: 0, totalSize: \"0 KB\" },\n\t\tissues: [],\n\t};\n\n\t// Check login status\n\tstatus.loggedIn = await isLoggedIn();\n\tif (status.loggedIn) {\n\t\tconst creds = await getCredentials();\n\t\tif (creds) {\n\t\t\tstatus.user = {\n\t\t\t\temail: creds.email,\n\t\t\t\ttier: creds.tier,\n\t\t\t};\n\t\t}\n\t}\n\n\t// Get workspace config\n\tconst config = await getWorkspaceConfig(workspaceRoot);\n\tif (config) {\n\t\tstatus.workspace = {\n\t\t\tid: config.workspaceId,\n\t\t\ttier: config.tier,\n\t\t\tsyncEnabled: config.syncEnabled,\n\t\t};\n\t}\n\n\t// Get vitals\n\tconst vitals = await getWorkspaceVitals(workspaceRoot);\n\tif (vitals) {\n\t\tstatus.vitals = {\n\t\t\tframework: vitals.framework,\n\t\t\tpackageManager: vitals.packageManager,\n\t\t\ttypescript: vitals.typescript?.enabled,\n\t\t\ttypescriptStrict: vitals.typescript?.strict,\n\t\t};\n\t}\n\n\t// Get session\n\tconst session = await getCurrentSession(workspaceRoot);\n\tif (session) {\n\t\tstatus.session = {\n\t\t\tid: session.id,\n\t\t\ttask: session.task,\n\t\t\tstartedAt: session.startedAt,\n\t\t\tsnapshotCount: session.snapshotCount,\n\t\t};\n\t}\n\n\t// Get protection\n\tconst protectedFiles = await getProtectedFiles(workspaceRoot);\n\tstatus.protection = {\n\t\tcount: protectedFiles.length,\n\t\tpatterns: protectedFiles.slice(0, 5).map((f) => f.pattern),\n\t};\n\n\t// Get violations\n\tconst violations = await getViolations(workspaceRoot);\n\tconst oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\n\tstatus.violations = {\n\t\ttotal: violations.length,\n\t\trecent: violations.filter((v) => new Date(v.date) > oneWeekAgo).length,\n\t};\n\n\t// Get snapshots\n\tconst snapshotInfo = await getSnapshotInfo(workspaceRoot);\n\tstatus.snapshots = snapshotInfo;\n\n\t// Detect issues\n\tstatus.issues = await detectIssues(workspaceRoot, status);\n\n\treturn status;\n}\n\n/**\n * Get snapshot information\n */\nasync function getSnapshotInfo(workspaceRoot: string): Promise<{ count: number; totalSize: string }> {\n\tconst snapshotsDir = join(getWorkspaceDir(workspaceRoot), \"snapshots\");\n\n\ttry {\n\t\tawait access(snapshotsDir, constants.F_OK);\n\t\tconst entries = await readdir(snapshotsDir, { withFileTypes: true });\n\t\tconst snapDirs = entries.filter((e) => e.isDirectory());\n\n\t\t// Calculate total size\n\t\tlet totalBytes = 0;\n\t\tfor (const dir of snapDirs) {\n\t\t\tconst stats = await getDirectorySize(join(snapshotsDir, dir.name));\n\t\t\ttotalBytes += stats;\n\t\t}\n\n\t\treturn {\n\t\t\tcount: snapDirs.length,\n\t\t\ttotalSize: formatBytes(totalBytes),\n\t\t};\n\t} catch {\n\t\treturn { count: 0, totalSize: \"0 KB\" };\n\t}\n}\n\n/**\n * Get directory size recursively\n */\nasync function getDirectorySize(dirPath: string): Promise<number> {\n\tlet size = 0;\n\n\ttry {\n\t\tconst entries = await readdir(dirPath, { withFileTypes: true });\n\n\t\tfor (const entry of entries) {\n\t\t\tconst fullPath = join(dirPath, entry.name);\n\t\t\tif (entry.isDirectory()) {\n\t\t\t\tsize += await getDirectorySize(fullPath);\n\t\t\t} else {\n\t\t\t\tconst stats = await stat(fullPath);\n\t\t\t\tsize += stats.size;\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// Ignore errors\n\t}\n\n\treturn size;\n}\n\n/**\n * Detect workspace issues\n */\nasync function detectIssues(workspaceRoot: string, status: WorkspaceStatus): Promise<Issue[]> {\n\tconst issues: Issue[] = [];\n\n\t// Check if logged in\n\tif (!status.loggedIn) {\n\t\tissues.push({\n\t\t\tid: \"not-logged-in\",\n\t\t\tseverity: \"warning\",\n\t\t\tdescription: \"Not logged in - some features are unavailable\",\n\t\t\tfix: \"snap login\",\n\t\t});\n\t}\n\n\t// Check if protected files are set up\n\tif (status.protection.count === 0) {\n\t\tissues.push({\n\t\t\tid: \"no-protection\",\n\t\t\tseverity: \"warning\",\n\t\t\tdescription: \"No files are protected\",\n\t\t\tfix: \"snap protect env && snap protect config\",\n\t\t});\n\t}\n\n\t// Check for .gitignore entry\n\tconst gitignorePath = join(workspaceRoot, \".gitignore\");\n\ttry {\n\t\tconst { readFile } = await import(\"node:fs/promises\");\n\t\tconst content = await readFile(gitignorePath, \"utf-8\");\n\t\tif (!content.includes(\".snapback\")) {\n\t\t\tissues.push({\n\t\t\t\tid: \"missing-gitignore\",\n\t\t\t\tseverity: \"warning\",\n\t\t\t\tdescription: \".snapback not in .gitignore\",\n\t\t\t\tfix: \"Add .snapback/snapshots/ to .gitignore\",\n\t\t\t});\n\t\t}\n\t} catch {\n\t\t// No .gitignore, not a critical issue\n\t}\n\n\t// Check for stale session\n\tif (status.session) {\n\t\tconst sessionStart = new Date(status.session.startedAt);\n\t\tconst hoursSinceStart = (Date.now() - sessionStart.getTime()) / (1000 * 60 * 60);\n\t\tif (hoursSinceStart > 24) {\n\t\t\tissues.push({\n\t\t\t\tid: \"stale-session\",\n\t\t\t\tseverity: \"warning\",\n\t\t\t\tdescription: `Session started ${Math.floor(hoursSinceStart)}h ago`,\n\t\t\t\tfix: \"snap session end\",\n\t\t\t});\n\t\t}\n\t}\n\n\t// Check for high violation count\n\tif (status.violations.recent > 5) {\n\t\tissues.push({\n\t\t\tid: \"high-violations\",\n\t\t\tseverity: \"warning\",\n\t\t\tdescription: `${status.violations.recent} violations in the last week`,\n\t\t\tfix: \"snap patterns list\",\n\t\t});\n\t}\n\n\treturn issues;\n}\n\n// =============================================================================\n// DISPLAY\n// =============================================================================\n\n/**\n * Display status in a nice format\n */\nfunction displayStatus(status: WorkspaceStatus): void {\n\tconsole.log(chalk.cyan.bold(\"Workspace Status\"));\n\tconsole.log(chalk.gray(\"\".repeat(40)));\n\tconsole.log();\n\n\t// User status\n\tif (status.user) {\n\t\tconsole.log(\n\t\t\tchalk.green(\"\"),\n\t\t\t\"Logged in as\",\n\t\t\tchalk.cyan(status.user.email),\n\t\t\tstatus.user.tier === \"pro\" ? chalk.magenta(\"Pro \") : \"\",\n\t\t);\n\t} else {\n\t\tconsole.log(chalk.yellow(\"\"), \"Not logged in\");\n\t}\n\n\t// Workspace info\n\tif (status.workspace?.id) {\n\t\tconsole.log(\n\t\t\tchalk.green(\"\"),\n\t\t\t\"Workspace:\",\n\t\t\tchalk.gray(status.workspace.id.substring(0, 8)),\n\t\t\tstatus.workspace.syncEnabled ? chalk.green(\"(synced)\") : chalk.gray(\"(local)\"),\n\t\t);\n\t}\n\tconsole.log();\n\n\t// Vitals\n\tif (status.vitals) {\n\t\tconsole.log(chalk.cyan(\"Stack:\"));\n\t\tif (status.vitals.framework) {\n\t\t\tconsole.log(\"  \", status.vitals.framework);\n\t\t}\n\t\tif (status.vitals.packageManager) {\n\t\t\tconsole.log(\"  \", status.vitals.packageManager);\n\t\t}\n\t\tif (status.vitals.typescript) {\n\t\t\tconsole.log(\"  \", \"TypeScript\", status.vitals.typescriptStrict ? chalk.green(\"(strict)\") : \"\");\n\t\t}\n\t\tconsole.log();\n\t}\n\n\t// Session\n\tif (status.session) {\n\t\tconsole.log(chalk.cyan(\"Active Session:\"));\n\t\tconsole.log(\"  ID:\", chalk.gray(status.session.id.substring(0, 8)));\n\t\tif (status.session.task) {\n\t\t\tconsole.log(\"  Task:\", status.session.task);\n\t\t}\n\t\tconsole.log(\"  Snapshots:\", status.session.snapshotCount);\n\t\tconsole.log();\n\t}\n\n\t// Stats\n\tconsole.log(chalk.cyan(\"Stats:\"));\n\tconsole.log(\"  Protected files:\", status.protection.count);\n\tconsole.log(\"  Snapshots:\", status.snapshots.count, chalk.gray(`(${status.snapshots.totalSize})`));\n\tconsole.log(\"  Violations:\", status.violations.total, chalk.gray(`(${status.violations.recent} this week)`));\n\tconsole.log();\n\n\t// Issues\n\tif (status.issues.length > 0) {\n\t\tconsole.log(chalk.yellow(\"Issues:\"));\n\t\tfor (const issue of status.issues) {\n\t\t\tconst icon = issue.severity === \"error\" ? chalk.red(\"\") : chalk.yellow(\"\");\n\t\t\tconsole.log(` ${icon}`, issue.description);\n\t\t\tif (issue.fix) {\n\t\t\t\tconsole.log(chalk.gray(`    Fix: ${issue.fix}`));\n\t\t\t}\n\t\t}\n\t} else {\n\t\tconsole.log(chalk.green(\"\"), \"No issues detected\");\n\t}\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Format bytes to human readable\n */\nfunction formatBytes(bytes: number): string {\n\tif (bytes === 0) return \"0 KB\";\n\n\tconst units = [\"B\", \"KB\", \"MB\", \"GB\"];\n\tconst exp = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);\n\tconst size = bytes / 1024 ** exp;\n\n\treturn `${size.toFixed(exp > 0 ? 1 : 0)} ${units[exp]}`;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { gatherStatus, detectIssues, formatBytes };\n","/**\n * Intelligence Service\n *\n * @fileoverview Provides singleton access to @snapback/intelligence for CLI commands.\n * This is the bridge between the internal MCP tooling and customer-facing CLI.\n *\n * ## Architecture Context\n *\n * This service implements DUAL-USE architecture:\n * - Internal MCP (`ai_dev_utils/mcp`)  rootDir: `ai_dev_utils/`  For SnapBack dev team\n * - Customer CLI (`apps/cli`)  rootDir: `.snapback/`  For customers\n *\n * Same algorithms from @snapback/intelligence, different data sources.\n *\n * ## Related Files\n *\n * - Spec: `ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md`\n * - Internal MCP: `ai_dev_utils/mcp/server.ts` (reference implementation)\n * - Intelligence Package: `packages/intelligence/src/Intelligence.ts`\n * - Storage Service: `apps/cli/src/services/snapback-dir.ts`\n *\n * ## Storage Layout\n *\n * When initialized, Intelligence expects this structure in .snapback/:\n * ```\n * .snapback/\n *  config.json              # Workspace config (required for init check)\n *  vitals.json              # Workspace vitals (optional)\n *  constraints.md           # User-defined constraints (optional)\n *  embeddings.db            # Semantic search DB (created if enabled)\n *  patterns/\n *     violations.jsonl     # Violation tracking\n *     workspace-patterns.json  # Promoted patterns\n *  learnings/\n *      user-learnings.jsonl # User learnings\n * ```\n *\n * ## Usage Examples\n *\n * ```typescript\n * // Get intelligence for current workspace\n * const intel = await getIntelligence();\n *\n * // Get context before starting work\n * const context = await intel.getContext({\n *   task: \"add authentication\",\n *   keywords: [\"auth\", \"session\"],\n * });\n *\n * // Validate code before committing\n * const result = await intel.validateCode(code, \"src/auth.ts\");\n *\n * // Report a violation (auto-promotes at 3x)\n * const status = await intel.reportViolation({\n *   type: \"missing-error-handling\",\n *   file: \"src/api.ts\",\n *   message: \"No try-catch around async operation\",\n *   reason: \"Forgot to add error handling\",\n *   prevention: \"Always wrap async calls in try-catch\",\n * });\n * ```\n *\n * @see {@link file://ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md}\n * @module services/intelligence-service\n */\n\nimport type { IntelligenceConfig } from \"@snapback/intelligence\";\nimport { Intelligence } from \"@snapback/intelligence\";\n\nimport { getWorkspaceDir, isSnapbackInitialized } from \"./snapback-dir\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Configuration options for workspace intelligence\n *\n * @remarks\n * These map to IntelligenceConfig from @snapback/intelligence.\n * We provide sensible defaults for CLI usage.\n */\nexport interface WorkspaceIntelligenceOptions {\n\t/**\n\t * Enable semantic search using embeddings\n\t * @default false - Disabled for faster startup in CLI\n\t *\n\t * @remarks\n\t * When enabled, creates embeddings.db in .snapback/\n\t * Requires initial indexing which can be slow.\n\t * Consider enabling only for `snap context --semantic` flag.\n\t */\n\tenableSemanticSearch?: boolean;\n\n\t/**\n\t * Enable the learning loop (interaction tracking, feedback)\n\t * @default true\n\t *\n\t * @remarks\n\t * Powers `snap stats` and golden dataset building.\n\t * Tracks CLI interactions for accuracy improvement.\n\t */\n\tenableLearningLoop?: boolean;\n\n\t/**\n\t * Enable auto-promotion of violations to patterns\n\t * @default true\n\t *\n\t * @remarks\n\t * At 3x occurrences: promotes to workspace-patterns.json\n\t * At 5x occurrences: marks for automation\n\t * See ROUTER.md \"Pattern Promotion Thresholds\"\n\t */\n\tenableAutoPromotion?: boolean;\n}\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/**\n * Default context files to index for customer workspaces\n *\n * @remarks\n * Unlike internal MCP which indexes ARCHITECTURE.md, CONSTRAINTS.md, ROUTER.md,\n * customer workspaces have simpler structure. We index what they create.\n *\n * These files are optional - Intelligence handles missing files gracefully.\n */\nconst DEFAULT_CONTEXT_FILES = [\n\t\"patterns/workspace-patterns.json\", // Promoted patterns\n\t\"vitals.json\", // Workspace vitals\n\t\"constraints.md\", // Optional user constraints\n];\n\n// =============================================================================\n// SINGLETON MANAGEMENT\n// =============================================================================\n\n/**\n * Cache of Intelligence instances per workspace path\n *\n * @remarks\n * We cache instances to avoid re-initialization overhead.\n * Each workspace gets its own instance with its own data.\n *\n * Key: Absolute path to workspace root\n * Value: Intelligence instance\n *\n * @internal\n */\nconst instances = new Map<string, Intelligence>();\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n/**\n * Create Intelligence configuration for a customer workspace\n *\n * @param workspaceRoot - Absolute path to workspace root\n * @param options - Optional configuration overrides\n * @returns IntelligenceConfig ready for new Intelligence(config)\n *\n * @remarks\n * This mirrors the config structure in `ai_dev_utils/mcp/server.ts` but\n * adapted for customer workspaces which use .snapback/ directory.\n *\n * Key differences from internal MCP config:\n * - rootDir is .snapback/ not ai_dev_utils/\n * - Fewer context files (customers don't have ROUTER.md, etc.)\n * - Semantic search disabled by default for faster startup\n *\n * @example\n * ```typescript\n * const config = createWorkspaceIntelligenceConfig(\"/path/to/project\");\n * const intel = new Intelligence(config);\n * ```\n *\n * @see {@link file://ai_dev_utils/mcp/server.ts} lines 50-75 for internal config\n */\nexport function createWorkspaceIntelligenceConfig(\n\tworkspaceRoot: string,\n\toptions: WorkspaceIntelligenceOptions = {},\n): IntelligenceConfig {\n\t// Get the .snapback/ directory path\n\tconst snapbackDir = getWorkspaceDir(workspaceRoot);\n\n\treturn {\n\t\t// Root directory for all Intelligence operations\n\t\t// All relative paths are resolved from here\n\t\trootDir: snapbackDir,\n\n\t\t// Directory containing pattern files\n\t\t// Maps to: .snapback/patterns/\n\t\tpatternsDir: \"patterns\",\n\n\t\t// Directory containing learning files\n\t\t// Maps to: .snapback/learnings/\n\t\tlearningsDir: \"learnings\",\n\n\t\t// Optional user-defined constraints file\n\t\t// Maps to: .snapback/constraints.md\n\t\t// Customers can create this to add project-specific rules\n\t\tconstraintsFile: \"constraints.md\",\n\n\t\t// Violation tracking file (JSONL format)\n\t\t// Maps to: .snapback/patterns/violations.jsonl\n\t\t// Auto-created on first violation report\n\t\tviolationsFile: \"patterns/violations.jsonl\",\n\n\t\t// SQLite database for semantic embeddings\n\t\t// Maps to: .snapback/embeddings.db\n\t\t// Only created if enableSemanticSearch is true\n\t\tembeddingsDb: \"embeddings.db\",\n\n\t\t// Files to index for context retrieval\n\t\t// These are searched when user runs `snap context`\n\t\tcontextFiles: DEFAULT_CONTEXT_FILES,\n\n\t\t// Feature flags with sensible defaults for CLI\n\t\tenableSemanticSearch: options.enableSemanticSearch ?? false,\n\t\tenableLearningLoop: options.enableLearningLoop ?? true,\n\t\tenableAutoPromotion: options.enableAutoPromotion ?? true,\n\t};\n}\n\n// =============================================================================\n// MAIN API\n// =============================================================================\n\n/**\n * Get or create Intelligence instance for a workspace\n *\n * @param workspaceRoot - Path to workspace root (defaults to cwd)\n * @param options - Optional configuration overrides\n * @returns Promise<Intelligence> - Initialized Intelligence instance\n * @throws Error if workspace is not initialized (no .snapback/config.json)\n *\n * @remarks\n * This is the main entry point for CLI commands to access Intelligence.\n * It handles:\n * - Checking if workspace is initialized\n * - Caching instances per workspace\n * - Creating new instances with proper config\n *\n * ## Error Handling\n *\n * Throws if:\n * - Workspace not initialized: \"SnapBack not initialized. Run: snap init\"\n * - Config file corrupted: Will bubble up JSON parse error\n *\n * ## Caching Behavior\n *\n * Instances are cached by workspace path. Second call to same workspace\n * returns the cached instance (fast). Call `clearIntelligenceCache()` to\n * force re-initialization.\n *\n * ## Implementation Notes for LLM Agents\n *\n * 1. Always await this function - it's async due to init check\n * 2. Handle the \"not initialized\" error in command handlers\n * 3. The returned Intelligence instance has all methods from the facade\n *\n * @example\n * ```typescript\n * // In a command handler:\n * try {\n *   const intel = await getIntelligence();\n *   const context = await intel.getContext({ task: \"...\" });\n * } catch (error) {\n *   if (error.message.includes(\"not initialized\")) {\n *     console.log(chalk.yellow(\"Run: snap init\"));\n *     process.exit(1);\n *   }\n *   throw error;\n * }\n * ```\n *\n * @see {@link Intelligence} for available methods\n * @see {@link isSnapbackInitialized} for init check logic\n */\nexport async function getIntelligence(\n\tworkspaceRoot?: string,\n\toptions?: WorkspaceIntelligenceOptions,\n): Promise<Intelligence> {\n\t// Resolve workspace path\n\tconst cwd = workspaceRoot || process.cwd();\n\n\t// STEP 1: Check if workspace is initialized\n\t// This verifies .snapback/config.json exists\n\t// Without this, Intelligence would fail on missing directories\n\tif (!(await isSnapbackInitialized(cwd))) {\n\t\tthrow new Error(\"SnapBack not initialized. Run: snap init\");\n\t}\n\n\t// STEP 2: Check cache for existing instance\n\t// This avoids re-initialization overhead on repeated calls\n\t// Note: We cache by path, so different workspaces get different instances\n\tif (instances.has(cwd)) {\n\t\treturn instances.get(cwd)!;\n\t}\n\n\t// STEP 3: Create new Intelligence instance\n\t// This doesn't do heavy initialization - that happens on first use\n\tconst config = createWorkspaceIntelligenceConfig(cwd, options);\n\tconst intelligence = new Intelligence(config);\n\n\t// STEP 4: Cache for future calls\n\tinstances.set(cwd, intelligence);\n\n\treturn intelligence;\n}\n\n/**\n * Clear the Intelligence instance cache\n *\n * @remarks\n * Use this in tests to ensure clean state between test cases.\n * Also disposes any active instances to free resources.\n *\n * ## When to Use\n *\n * - In test `afterEach` or `afterAll` hooks\n * - When workspace config changes and you need fresh instance\n * - When debugging initialization issues\n *\n * @example\n * ```typescript\n * // In test file:\n * afterEach(() => {\n *   clearIntelligenceCache();\n * });\n * ```\n */\nexport function clearIntelligenceCache(): void {\n\t// Dispose all instances to free resources (close DB connections, etc.)\n\tfor (const instance of instances.values()) {\n\t\t// Intelligence.dispose() is async but we fire-and-forget here\n\t\t// In tests, await the individual dispose if needed\n\t\tinstance.dispose().catch(() => {\n\t\t\t// Intentionally silent: dispose errors during cache clear are non-critical\n\t\t\t// The cache is being cleared regardless, and logging would be noisy\n\t\t});\n\t}\n\n\t// Clear the cache\n\tinstances.clear();\n}\n\n/**\n * Check if Intelligence is available for a workspace\n *\n * @param workspaceRoot - Path to workspace root (defaults to cwd)\n * @returns Promise<boolean> - true if Intelligence can be used\n *\n * @remarks\n * This is a non-throwing version of getIntelligence() for conditional logic.\n * Useful when you want to show different UI based on initialization state.\n *\n * @example\n * ```typescript\n * if (await hasIntelligence()) {\n *   // Show full intelligence-powered UI\n * } else {\n *   // Show basic UI with init prompt\n * }\n * ```\n */\nexport async function hasIntelligence(workspaceRoot?: string): Promise<boolean> {\n\ttry {\n\t\tawait getIntelligence(workspaceRoot);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Get Intelligence with semantic search enabled\n *\n * @param workspaceRoot - Path to workspace root (defaults to cwd)\n * @returns Promise<Intelligence> - Instance with semantic search ready\n *\n * @remarks\n * This variant enables semantic search and calls initialize() to ensure\n * the embeddings database is ready. Use for `snap context --semantic`.\n *\n * ## Performance Note\n *\n * First call with semantic search will:\n * 1. Create embeddings.db if not exists\n * 2. Index all context files\n * 3. This can take several seconds\n *\n * Subsequent calls are fast (uses cached embeddings).\n *\n * @example\n * ```typescript\n * // In context command with --semantic flag:\n * const intel = await getIntelligenceWithSemantic();\n * const result = await intel.semanticSearch(query, 2000);\n * ```\n */\nexport async function getIntelligenceWithSemantic(workspaceRoot?: string): Promise<Intelligence> {\n\tconst cwd = workspaceRoot || process.cwd();\n\n\t// Check init first\n\tif (!(await isSnapbackInitialized(cwd))) {\n\t\tthrow new Error(\"SnapBack not initialized. Run: snap init\");\n\t}\n\n\t// Create with semantic search enabled\n\t// Note: We use a different cache key to avoid conflicts\n\tconst cacheKey = `${cwd}:semantic`;\n\n\tif (instances.has(cacheKey)) {\n\t\treturn instances.get(cacheKey)!;\n\t}\n\n\tconst config = createWorkspaceIntelligenceConfig(cwd, {\n\t\tenableSemanticSearch: true,\n\t});\n\n\tconst intelligence = new Intelligence(config);\n\n\t// Initialize semantic search (creates/loads embeddings)\n\tawait intelligence.initialize();\n\n\tinstances.set(cacheKey, intelligence);\n\n\treturn intelligence;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport type { Intelligence };\n","/**\n * CLI-UX-003: CLI-Table3 Integration\n *\n * @fileoverview Table rendering utilities for structured CLI output.\n * Provides formatted tables for risk signals, file summaries, snapshots,\n * and intelligence-related data (context, validation).\n *\n * ## Purpose\n *\n * Tables make data scannable and professional-looking in CLI output.\n * All tables use cli-table3 with consistent styling.\n *\n * ## Table Types\n *\n * | Function | Purpose | Used By |\n * |----------|---------|---------|\n * | createRiskSignalTable | Risk signals with severity | snap analyze |\n * | createFileSummaryTable | File analysis results | snap check |\n * | createSnapshotTable | Snapshot listing | snap list |\n * | createStagedFilesTable | Git staged files | snap check --all |\n * | createContextTable | Learnings for context | snap context |\n * | createValidationTable | Validation results | snap validate |\n *\n * ## Styling\n *\n * - Headers: cyan color\n * - Borders: minimal (empty style)\n * - Word wrap enabled for long content\n * - Truncation for file paths\n *\n * @see {@link file://ai_dev_utils/resources/new_cli/03-cli-table3-integration.spec.md}\n * @see {@link file://ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md}\n * @module utils/tables\n */\n\nimport chalk from \"chalk\";\nimport Table from \"cli-table3\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Risk signal from analysis\n */\nexport interface RiskSignal {\n\tsignal: string;\n\tvalue: number;\n\tdescription?: string;\n}\n\n/**\n * File risk summary for batch analysis\n */\nexport interface FileRiskSummary {\n\tfile: string;\n\triskScore: number;\n\triskLevel: string;\n\ttopSignal?: string;\n}\n\n/**\n * Learning entry for context display\n *\n * @remarks\n * Matches the shape returned by Intelligence.getContext().relevantLearnings\n */\nexport interface LearningEntry {\n\ttrigger: string;\n\taction: string;\n\ttype: string;\n}\n\n/**\n * Validation result for display\n *\n * @remarks\n * Matches the shape returned by validate command processing\n */\nexport interface ValidationResult {\n\tfile: string;\n\tpassed: boolean;\n\tconfidence: number;\n\tissues: number;\n\trecommendation: \"auto_merge\" | \"quick_review\" | \"full_review\" | \"error\";\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Render severity as visual indicator\n *\n * @param value - The risk value (0-10)\n * @param maxValue - Maximum possible value (default 10)\n * @returns Visual severity indicator string (e.g., \"\")\n *\n * @remarks\n * Uses filled and empty dots to show severity level:\n * - 3 filled dots = high (red)\n * - 2 filled dots = medium (yellow)\n * - 1 filled dot = low (green)\n *\n * @example\n * ```typescript\n * renderSeverity(8.5)  // \"\" in red\n * renderSeverity(5.0)  // \"\" in yellow\n * renderSeverity(2.0)  // \"\" in green\n * ```\n */\nexport function renderSeverity(value: number, maxValue = 10): string {\n\tconst normalized = Math.min(value / maxValue, 1);\n\tconst filled = Math.round(normalized * 3);\n\tconst empty = 3 - filled;\n\n\tconst dot = \"\";\n\tconst emptyDot = \"\";\n\n\tlet color: typeof chalk.red;\n\tif (normalized > 0.7) {\n\t\tcolor = chalk.red;\n\t} else if (normalized > 0.4) {\n\t\tcolor = chalk.yellow;\n\t} else {\n\t\tcolor = chalk.green;\n\t}\n\n\treturn color(dot.repeat(filled)) + chalk.gray(emptyDot.repeat(empty));\n}\n\n/**\n * Truncate file path intelligently\n *\n * @param path - File path to truncate\n * @param maxLength - Maximum length allowed\n * @returns Truncated path with ellipsis if needed\n *\n * @remarks\n * Preserves:\n * - First directory (for context)\n * - Filename (always visible)\n *\n * Middle directories are replaced with \"...\"\n *\n * @example\n * ```typescript\n * truncatePath(\"src/components/auth/LoginForm.tsx\", 30)\n * // Returns: \"src/.../LoginForm.tsx\"\n * ```\n */\nexport function truncatePath(path: string, maxLength: number): string {\n\tif (path.length <= maxLength) return path;\n\n\tconst parts = path.split(\"/\");\n\tif (parts.length <= 2) {\n\t\treturn \"...\" + path.slice(-(maxLength - 3));\n\t}\n\n\t// Keep filename and first directory\n\tconst filename = parts[parts.length - 1];\n\tconst firstDir = parts[0];\n\n\tif (filename.length + firstDir.length + 5 > maxLength) {\n\t\treturn \"...\" + filename.slice(-(maxLength - 3));\n\t}\n\n\treturn `${firstDir}/.../${filename}`;\n}\n\n/**\n * Format timestamp as relative time\n *\n * @param date - Date to format\n * @returns Human-readable relative time string\n *\n * @example\n * ```typescript\n * formatRelativeTime(new Date(Date.now() - 120000))\n * // Returns: \"2m ago\"\n * ```\n */\nexport function formatRelativeTime(date: Date): string {\n\tconst now = new Date();\n\tconst diffMs = now.getTime() - date.getTime();\n\tconst diffMins = Math.floor(diffMs / 60000);\n\tconst diffHours = Math.floor(diffMins / 60);\n\tconst diffDays = Math.floor(diffHours / 24);\n\n\tif (diffMins < 1) return \"just now\";\n\tif (diffMins < 60) return `${diffMins}m ago`;\n\tif (diffHours < 24) return `${diffHours}h ago`;\n\tif (diffDays < 7) return `${diffDays}d ago`;\n\n\treturn date.toLocaleDateString();\n}\n\n/**\n * Format ISO date string for human-readable display\n *\n * @param isoDate - ISO date string or Date object\n * @returns Formatted date string (e.g., \"Dec 25, 2024\")\n *\n * @example\n * ```typescript\n * formatDate(\"2024-12-25T10:30:00Z\")\n * // Returns: \"Dec 25, 2024\"\n * ```\n */\nexport function formatDate(isoDate: string | Date): string {\n\tconst date = typeof isoDate === \"string\" ? new Date(isoDate) : isoDate;\n\treturn date.toLocaleDateString(\"en-US\", {\n\t\tmonth: \"short\",\n\t\tday: \"numeric\",\n\t\tyear: \"numeric\",\n\t});\n}\n\n/**\n * Format confidence as percentage with color\n *\n * @param confidence - Confidence value 0-1\n * @returns Colored percentage string\n *\n * @example\n * ```typescript\n * formatConfidence(0.95)  // \"95%\" in green\n * formatConfidence(0.65)  // \"65%\" in yellow\n * formatConfidence(0.35)  // \"35%\" in red\n * ```\n */\nexport function formatConfidence(confidence: number): string {\n\tconst percentage = Math.round(confidence * 100);\n\tconst text = `${percentage}%`;\n\n\tif (percentage >= 80) {\n\t\treturn chalk.green(text);\n\t}\n\tif (percentage >= 50) {\n\t\treturn chalk.yellow(text);\n\t}\n\treturn chalk.red(text);\n}\n\n/**\n * Format recommendation for display\n *\n * @param recommendation - Recommendation from validation pipeline\n * @returns Colored recommendation string\n */\nexport function formatRecommendation(recommendation: string): string {\n\tswitch (recommendation) {\n\t\tcase \"auto_merge\":\n\t\t\treturn chalk.green(\"auto_merge\");\n\t\tcase \"quick_review\":\n\t\t\treturn chalk.yellow(\"quick_rev\");\n\t\tcase \"full_review\":\n\t\t\treturn chalk.red(\"full_rev\");\n\t\tcase \"error\":\n\t\t\treturn chalk.red(\"error\");\n\t\tdefault:\n\t\t\treturn chalk.gray(recommendation);\n\t}\n}\n\n// =============================================================================\n// RISK TABLE FUNCTIONS\n// =============================================================================\n\n/**\n * Create a table for risk signals\n *\n * @param signals - Array of risk signals to display\n * @returns Formatted table string\n *\n * @remarks\n * Displays signals sorted by value descending with severity indicators.\n * Only shows signals with value > 0.\n *\n * @example\n * ```typescript\n * const table = createRiskSignalTable([\n *   { signal: \"complexity\", value: 8.5 },\n *   { signal: \"churn\", value: 3.2 },\n * ]);\n * console.log(table);\n * ```\n */\nexport function createRiskSignalTable(signals: RiskSignal[]): string {\n\tif (signals.length === 0) {\n\t\treturn chalk.green(\"No risk signals detected.\");\n\t}\n\n\t// Sort by value descending\n\tconst sorted = [...signals].sort((a, b) => b.value - a.value);\n\n\tconst table = new Table({\n\t\thead: [chalk.cyan(\"Signal\"), chalk.cyan(\"Score\"), chalk.cyan(\"Severity\")],\n\t\tstyle: {\n\t\t\thead: [],\n\t\t\tborder: [],\n\t\t},\n\t\tcolWidths: [20, 8, 12],\n\t});\n\n\tfor (const signal of sorted) {\n\t\t// Only show signals with value > 0\n\t\tif (signal.value <= 0) continue;\n\n\t\ttable.push([signal.signal, signal.value.toFixed(1), renderSeverity(signal.value)]);\n\t}\n\n\treturn table.toString();\n}\n\n/**\n * Create a summary table for batch file analysis\n *\n * @param files - Array of file risk summaries\n * @returns Formatted table string\n *\n * @remarks\n * Displays files sorted by risk score with color-coded levels.\n * Used by `snap check` command.\n *\n * @example\n * ```typescript\n * const table = createFileSummaryTable([\n *   { file: \"src/auth.ts\", riskScore: 8.5, riskLevel: \"high\", topSignal: \"complexity\" },\n *   { file: \"src/utils.ts\", riskScore: 2.1, riskLevel: \"low\" },\n * ]);\n * console.log(table);\n * ```\n */\nexport function createFileSummaryTable(files: FileRiskSummary[]): string {\n\tif (files.length === 0) {\n\t\treturn chalk.green(\"No files analyzed.\");\n\t}\n\n\t// Sort by risk score descending\n\tconst sorted = [...files].sort((a, b) => b.riskScore - a.riskScore);\n\n\tconst table = new Table({\n\t\thead: [chalk.cyan(\"File\"), chalk.cyan(\"Risk\"), chalk.cyan(\"Level\"), chalk.cyan(\"Top Signal\")],\n\t\tstyle: {\n\t\t\thead: [],\n\t\t\tborder: [],\n\t\t},\n\t\tcolWidths: [40, 8, 10, 15],\n\t\twordWrap: true,\n\t});\n\n\tfor (const file of sorted) {\n\t\tconst levelColor =\n\t\t\tfile.riskLevel === \"high\" ? chalk.red : file.riskLevel === \"medium\" ? chalk.yellow : chalk.green;\n\n\t\ttable.push([\n\t\t\ttruncatePath(file.file, 38),\n\t\t\tfile.riskScore.toFixed(1),\n\t\t\tlevelColor(file.riskLevel.toUpperCase()),\n\t\t\tfile.topSignal || \"-\",\n\t\t]);\n\t}\n\n\treturn table.toString();\n}\n\n// =============================================================================\n// SNAPSHOT TABLE FUNCTIONS\n// =============================================================================\n\n/**\n * Create a compact inline table for snapshot listing\n *\n * @param snapshots - Array of snapshot objects\n * @returns Formatted table string\n *\n * @remarks\n * Displays snapshots with relative timestamps.\n * Used by `snap list` command.\n *\n * @example\n * ```typescript\n * const table = createSnapshotTable([\n *   { id: \"abc123def\", timestamp: new Date(), message: \"Before refactor\", fileCount: 12 },\n * ]);\n * console.log(table);\n * ```\n */\nexport function createSnapshotTable(\n\tsnapshots: Array<{\n\t\tid: string;\n\t\ttimestamp: Date;\n\t\tmessage?: string;\n\t\tfileCount?: number;\n\t}>,\n): string {\n\tif (snapshots.length === 0) {\n\t\treturn chalk.yellow(\"No snapshots found.\");\n\t}\n\n\tconst table = new Table({\n\t\thead: [chalk.cyan(\"ID\"), chalk.cyan(\"Created\"), chalk.cyan(\"Message\"), chalk.cyan(\"Files\")],\n\t\tstyle: {\n\t\t\thead: [],\n\t\t\tborder: [],\n\t\t},\n\t\tcolWidths: [12, 22, 30, 8],\n\t\twordWrap: true,\n\t});\n\n\tfor (const snap of snapshots) {\n\t\ttable.push([\n\t\t\tsnap.id.substring(0, 8),\n\t\t\tformatRelativeTime(snap.timestamp),\n\t\t\tsnap.message || chalk.gray(\"(none)\"),\n\t\t\tsnap.fileCount?.toString() || \"-\",\n\t\t]);\n\t}\n\n\treturn table.toString();\n}\n\n/**\n * Create a staged files table for pre-commit display\n *\n * @param files - Array of staged file info\n * @returns Formatted table string\n *\n * @remarks\n * Used by `snap check --all` command.\n */\nexport function createStagedFilesTable(\n\tfiles: Array<{\n\t\tpath: string;\n\t\tstatus: string;\n\t\triskScore?: number;\n\t}>,\n): string {\n\tif (files.length === 0) {\n\t\treturn chalk.yellow(\"No staged files.\");\n\t}\n\n\tconst table = new Table({\n\t\thead: [chalk.cyan(\"File\"), chalk.cyan(\"Status\"), chalk.cyan(\"Risk\")],\n\t\tstyle: {\n\t\t\thead: [],\n\t\t\tborder: [],\n\t\t},\n\t\tcolWidths: [50, 12, 10],\n\t});\n\n\tfor (const file of files) {\n\t\tconst statusColor =\n\t\t\tfile.status === \"added\"\n\t\t\t\t? chalk.green\n\t\t\t\t: file.status === \"deleted\"\n\t\t\t\t\t? chalk.red\n\t\t\t\t\t: file.status === \"renamed\"\n\t\t\t\t\t\t? chalk.blue\n\t\t\t\t\t\t: chalk.yellow;\n\n\t\tconst riskDisplay = file.riskScore !== undefined ? renderSeverity(file.riskScore) : chalk.gray(\"-\");\n\n\t\ttable.push([truncatePath(file.path, 48), statusColor(file.status), riskDisplay]);\n\t}\n\n\treturn table.toString();\n}\n\n// =============================================================================\n// INTELLIGENCE TABLE FUNCTIONS (CLI-UX-005)\n// =============================================================================\n\n/**\n * Create a table for context learnings\n *\n * @param learnings - Array of learning entries\n * @returns Formatted table string\n *\n * @remarks\n * Displays learnings from Intelligence.getContext().relevantLearnings.\n * Used by `snap context` command.\n *\n * ## Implementation Notes for LLM Agents\n *\n * 1. Learnings have { trigger, action, type } shape\n * 2. Trigger is the keyword/situation that triggers the learning\n * 3. Action is what to do when triggered\n * 4. Type is one of: pattern, pitfall, efficiency, discovery, workflow\n *\n * @example\n * ```typescript\n * const table = createContextTable([\n *   { trigger: \"auth\", action: \"Use @snapback/auth package\", type: \"pattern\" },\n *   { trigger: \"testing\", action: \"Use 4-path coverage\", type: \"pattern\" },\n * ]);\n * console.log(table);\n * ```\n */\nexport function createContextTable(learnings: LearningEntry[]): string {\n\tif (learnings.length === 0) {\n\t\treturn chalk.gray(\"No relevant learnings found.\");\n\t}\n\n\tconst table = new Table({\n\t\thead: [chalk.cyan(\"Type\"), chalk.cyan(\"Trigger\"), chalk.cyan(\"Action\")],\n\t\tstyle: {\n\t\t\thead: [],\n\t\t\tborder: [],\n\t\t},\n\t\tcolWidths: [12, 20, 45],\n\t\twordWrap: true,\n\t});\n\n\tfor (const learning of learnings) {\n\t\t// Color-code the type\n\t\tconst typeColor = getTypeColor(learning.type);\n\n\t\ttable.push([typeColor(learning.type), learning.trigger, truncateText(learning.action, 42)]);\n\t}\n\n\treturn table.toString();\n}\n\n/**\n * Create a table for validation results\n *\n * @param results - Array of validation results\n * @returns Formatted table string\n *\n * @remarks\n * Displays validation results with pass/fail, confidence, and recommendation.\n * Used by `snap validate` command.\n *\n * ## Column Meanings\n *\n * - File: Path to the validated file (truncated)\n * - Passed:  or \n * - Confidence: 0-100% with color coding\n * - Issues: Number of issues found\n * - Recommendation: auto_merge / quick_review / full_review\n *\n * @example\n * ```typescript\n * const table = createValidationTable([\n *   { file: \"src/auth.ts\", passed: false, confidence: 0.65, issues: 3, recommendation: \"full_review\" },\n *   { file: \"src/utils.ts\", passed: true, confidence: 0.95, issues: 0, recommendation: \"auto_merge\" },\n * ]);\n * console.log(table);\n * ```\n */\nexport function createValidationTable(results: ValidationResult[]): string {\n\tif (results.length === 0) {\n\t\treturn chalk.gray(\"No files validated.\");\n\t}\n\n\tconst table = new Table({\n\t\thead: [\n\t\t\tchalk.cyan(\"File\"),\n\t\t\tchalk.cyan(\"Passed\"),\n\t\t\tchalk.cyan(\"Confidence\"),\n\t\t\tchalk.cyan(\"Issues\"),\n\t\t\tchalk.cyan(\"Recommendation\"),\n\t\t],\n\t\tstyle: {\n\t\t\thead: [],\n\t\t\tborder: [],\n\t\t},\n\t\tcolWidths: [35, 8, 12, 8, 14],\n\t\twordWrap: true,\n\t});\n\n\tfor (const result of results) {\n\t\ttable.push([\n\t\t\ttruncatePath(result.file, 33),\n\t\t\tresult.passed ? chalk.green(\"\") : chalk.red(\"\"),\n\t\t\tformatConfidence(result.confidence),\n\t\t\tresult.issues.toString(),\n\t\t\tformatRecommendation(result.recommendation),\n\t\t]);\n\t}\n\n\treturn table.toString();\n}\n\n// =============================================================================\n// HELPER FUNCTIONS (PRIVATE)\n// =============================================================================\n\n/**\n * Get color function for learning type\n *\n * @param type - Learning type\n * @returns Chalk color function\n *\n * @internal\n */\nfunction getTypeColor(type: string): typeof chalk.blue {\n\tswitch (type) {\n\t\tcase \"pattern\":\n\t\t\treturn chalk.blue;\n\t\tcase \"pitfall\":\n\t\t\treturn chalk.red;\n\t\tcase \"efficiency\":\n\t\t\treturn chalk.green;\n\t\tcase \"discovery\":\n\t\t\treturn chalk.yellow;\n\t\tcase \"workflow\":\n\t\t\treturn chalk.magenta;\n\t\tdefault:\n\t\t\treturn chalk.gray;\n\t}\n}\n\n/**\n * Truncate text with ellipsis\n *\n * @param text - Text to truncate\n * @param maxLength - Maximum length\n * @returns Truncated text\n *\n * @internal\n */\nfunction truncateText(text: string, maxLength: number): string {\n\tif (text.length <= maxLength) return text;\n\treturn text.slice(0, maxLength - 3) + \"...\";\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport type { LearningEntry as ContextLearning, ValidationResult as FileValidationResult };\n","/**\n * Context Command\n *\n * @fileoverview Implements `snap context` - Get relevant context before starting work.\n * This is the CLI equivalent of the MCP's `codebase.start_task()` tool.\n *\n * ## Purpose\n *\n * Before implementing any code changes, developers should understand:\n * - Relevant patterns and constraints\n * - Past learnings that apply\n * - Recent violations to avoid\n *\n * This command surfaces that context in a digestible format.\n *\n * ## Usage Examples\n *\n * ```bash\n * # Get context for a task\n * snap context \"add user authentication\"\n *\n * # Include files you plan to modify\n * snap context \"refactor auth\" --files src/auth.ts src/session.ts\n *\n * # Search with specific keywords\n * snap context --keywords auth session jwt\n *\n * # Machine-readable output\n * snap context \"add auth\" --json\n *\n * # With semantic search (slower, more accurate)\n * snap context \"add auth\" --semantic\n * ```\n *\n * ## Output Format\n *\n * Default output uses boxen for visual hierarchy:\n * ```\n * \n *    Context Loaded                  \n *                                      \n *   Hard Rules: 12 constraints         \n *   Patterns: 8 patterns               \n *   Learnings: 3 relevant              \n *   Violations: 2 to avoid             \n * \n *\n * Relevant Learnings:\n * \n *  Trigger   Action                    \n * \n *  auth      Use @snapback/auth...     \n * \n *\n *  Recent Violations (avoid these):\n *    missing-error-handling: No try-catch...\n *     Fix: Always wrap async calls in try-catch\n * ```\n *\n * ## Related\n *\n * - Spec: `ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md`\n * - MCP equivalent: `ai_dev_utils/mcp/server.ts`  `handleStartTask()`\n * - Intelligence method: `Intelligence.getContext()`\n *\n * @see {@link file://ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md}\n * @module commands/context\n */\n\nimport type { ContextResult } from \"@snapback/intelligence\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport { getIntelligence, getIntelligenceWithSemantic } from \"../services/intelligence-service\";\nimport { displayBox } from \"../utils/display\";\nimport { createContextTable } from \"../utils/tables\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Options parsed from command line\n *\n * @internal\n */\ninterface ContextOptions {\n\t/** Files the user plans to modify */\n\tfiles?: string[];\n\t/** Keywords to search for in patterns/learnings */\n\tkeywords?: string[];\n\t/** Output as JSON instead of formatted */\n\tjson?: boolean;\n\t/** Use semantic search (slower, more accurate) */\n\tsemantic?: boolean;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the context command\n *\n * @returns Commander Command instance\n *\n * @remarks\n * ## Implementation Notes for LLM Agents\n *\n * 1. This command is the CLI equivalent of MCP's `start_task` tool\n * 2. It uses the Intelligence facade from @snapback/intelligence\n * 3. Display utilities should be imported from ../utils/display\n * 4. Table utilities should be imported from ../utils/tables\n *\n * ## Error Handling\n *\n * Handle these cases:\n * - Workspace not initialized  Show \"Run: snap init\"\n * - No task or keywords provided  Show usage hint\n * - Intelligence errors  Show error message, exit 1\n *\n * ## Display Strategy\n *\n * 1. Use `displayBox()` for the summary (type: \"info\")\n * 2. Use `createContextTable()` for learnings list\n * 3. Use plain chalk for violations (they're warnings)\n * 4. Always show the tip at the end\n *\n * @example\n * ```typescript\n * // In apps/cli/src/index.ts:\n * import { createContextCommand } from \"./commands/context\";\n * program.addCommand(createContextCommand());\n * ```\n */\nexport function createContextCommand(): Command {\n\tconst context = new Command(\"context\")\n\t\t.description(\"Get relevant context before starting work\")\n\t\t.argument(\"[task]\", \"Description of what you want to implement\")\n\t\t.option(\"-f, --files <files...>\", \"Files you plan to modify\")\n\t\t.option(\"-k, --keywords <keywords...>\", \"Keywords to search for\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.option(\"--semantic\", \"Use semantic search (slower, more accurate)\")\n\t\t.action(async (task: string | undefined, options: ContextOptions) => {\n\t\t\tawait handleContextCommand(task, options);\n\t\t});\n\n\treturn context;\n}\n\n// =============================================================================\n// COMMAND HANDLER\n// =============================================================================\n\n/**\n * Handle the context command execution\n *\n * @param task - Optional task description\n * @param options - Command options\n *\n * @remarks\n * ## Implementation Flow\n *\n * 1. Get Intelligence instance (with or without semantic)\n * 2. Build context input from task + files + keywords\n * 3. Call intelligence.getContext()\n * 4. Format and display results\n *\n * ## Intelligence.getContext() Input\n *\n * ```typescript\n * interface ContextInput {\n *   task: string;           // What user wants to do\n *   files?: string[];       // Files they'll modify\n *   keywords?: string[];    // Search terms\n * }\n * ```\n *\n * ## Intelligence.getContext() Output\n *\n * The result contains:\n * - `hardRules`: String of constraint rules\n * - `patterns`: String of patterns\n * - `relevantLearnings`: Array of {trigger, action, type}\n * - `recentViolations`: Array of {type, message, prevention}\n * - `semanticContext`: If semantic search enabled\n * - `hint`: Helpful tip for the user\n *\n * @internal\n */\nasync function handleContextCommand(task: string | undefined, options: ContextOptions): Promise<void> {\n\tconst cwd = process.cwd();\n\n\ttry {\n\t\t// STEP 1: Get Intelligence instance\n\t\t// Use semantic variant if --semantic flag is set\n\t\tconst intelligence = options.semantic ? await getIntelligenceWithSemantic(cwd) : await getIntelligence(cwd);\n\n\t\t// STEP 2: Build context input\n\t\t// If no task provided, use a generic one\n\t\t// Keywords can come from --keywords or be extracted from task\n\t\tconst contextInput = {\n\t\t\ttask: task || \"general development\",\n\t\t\tfiles: options.files || [],\n\t\t\tkeywords: options.keywords || extractKeywords(task),\n\t\t};\n\n\t\t// STEP 3: Get context from Intelligence\n\t\t// This searches patterns, learnings, and violations\n\t\tconst result = await intelligence.getContext(contextInput);\n\n\t\t// STEP 4: Handle JSON output mode\n\t\tif (options.json) {\n\t\t\tconsole.log(JSON.stringify(result, null, 2));\n\t\t\treturn;\n\t\t}\n\n\t\t// STEP 5: Display formatted output\n\t\tdisplayContextResults(result, options.semantic);\n\t} catch (error: unknown) {\n\t\t// Handle known error cases\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\n\t\tif (message.includes(\"not initialized\")) {\n\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\tprocess.exit(1);\n\t\t}\n\n\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\tprocess.exit(1);\n\t}\n}\n\n// =============================================================================\n// DISPLAY FUNCTIONS\n// =============================================================================\n\n/**\n * Display context results in formatted output\n *\n * @param result - Context result from Intelligence\n * @param usedSemantic - Whether semantic search was used\n *\n * @remarks\n * ## Display Hierarchy\n *\n * 1. Summary box (always shown)\n *    - Shows counts of rules, patterns, learnings, violations\n *    - If semantic used, shows compression ratio\n *\n * 2. Learnings table (if any learnings found)\n *    - Uses cli-table3 via createContextTable()\n *    - Shows trigger and action columns\n *\n * 3. Violations list (if any violations found)\n *    - Plain text with chalk styling\n *    - Shows type, message, and prevention tip\n *\n * 4. Tip (always shown)\n *    - Reminds user to validate before committing\n *\n * @internal\n */\nfunction displayContextResults(result: ContextResult, usedSemantic?: boolean): void {\n\t// PART 1: Summary box\n\tconst summaryContent = formatContextSummary(result, usedSemantic);\n\n\tconsole.log(\n\t\tdisplayBox({\n\t\t\ttitle: \" Context Loaded\",\n\t\t\tcontent: summaryContent,\n\t\t\ttype: \"info\",\n\t\t}),\n\t);\n\n\t// PART 2: Learnings table\n\tif (result.relevantLearnings && result.relevantLearnings.length > 0) {\n\t\tconsole.log();\n\t\tconsole.log(chalk.cyan(\"Relevant Learnings:\"));\n\t\tconsole.log(createContextTable(result.relevantLearnings));\n\t}\n\n\t// PART 3: Violations to avoid\n\tif (result.recentViolations && result.recentViolations.length > 0) {\n\t\tconsole.log();\n\t\tconsole.log(chalk.yellow(\" Recent Violations (avoid these):\"));\n\n\t\t// Show up to 3 violations to avoid overwhelming output\n\t\tfor (const violation of result.recentViolations.slice(0, 3)) {\n\t\t\tconsole.log(chalk.gray(`   ${violation.type}: ${violation.message}`));\n\t\t\tif (violation.prevention) {\n\t\t\t\tconsole.log(chalk.green(`    Fix: ${violation.prevention}`));\n\t\t\t}\n\t\t}\n\n\t\t// Hint if there are more\n\t\tif (result.recentViolations.length > 3) {\n\t\t\tconsole.log(chalk.gray(`  ... and ${result.recentViolations.length - 3} more`));\n\t\t}\n\t}\n\n\t// PART 4: Tip\n\tconsole.log();\n\tconsole.log(chalk.gray(\"Tip: Run 'snap validate <file>' before committing\"));\n}\n\n/**\n * Format context summary for display in box\n *\n * @param result - Context result from Intelligence\n * @param usedSemantic - Whether semantic search was used\n * @returns Formatted string for box content\n *\n * @remarks\n * Creates a multi-line summary showing:\n * - Number of hard rules (from hardRules string)\n * - Number of patterns (from patterns string)\n * - Number of relevant learnings\n * - Number of violations to avoid\n * - Semantic compression ratio (if used)\n *\n * @internal\n */\nfunction formatContextSummary(result: ContextResult, usedSemantic?: boolean): string {\n\tconst parts: string[] = [];\n\n\t// Count hard rules (lines in hardRules string that start with ##)\n\tif (result.hardRules) {\n\t\tconst ruleCount = (result.hardRules.match(/^##/gm) || []).length || \"loaded\";\n\t\tparts.push(`${chalk.bold(\"Hard Rules:\")} ${ruleCount} constraints`);\n\t}\n\n\t// Count patterns (non-empty lines in patterns string)\n\tif (result.patterns) {\n\t\tconst patternCount = result.patterns.split(\"\\n\").filter(Boolean).length;\n\t\tparts.push(`${chalk.bold(\"Patterns:\")} ${patternCount} patterns`);\n\t}\n\n\t// Count learnings\n\tif (result.relevantLearnings?.length) {\n\t\tparts.push(`${chalk.bold(\"Learnings:\")} ${result.relevantLearnings.length} relevant`);\n\t}\n\n\t// Count violations\n\tif (result.recentViolations?.length) {\n\t\tparts.push(`${chalk.bold(\"Violations:\")} ${result.recentViolations.length} to avoid`);\n\t}\n\n\t// Semantic search info\n\tif (usedSemantic && result.semanticContext) {\n\t\tparts.push(\n\t\t\t`${chalk.bold(\"Semantic:\")} ${result.semanticContext.sections} sections (${result.semanticContext.compression} compression)`,\n\t\t);\n\t}\n\n\t// If no context found, show a helpful message\n\tif (parts.length === 0) {\n\t\tparts.push(\"No specific context found for this task.\");\n\t\tparts.push(\"Try adding --keywords to refine the search.\");\n\t}\n\n\treturn parts.join(\"\\n\");\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Extract keywords from task description\n *\n * @param task - Task description string\n * @returns Array of keywords\n *\n * @remarks\n * Simple keyword extraction that:\n * - Splits on whitespace\n * - Filters out common words (the, a, an, to, for, etc.)\n * - Returns up to 5 keywords\n *\n * This is a fallback when --keywords isn't provided.\n *\n * @example\n * ```typescript\n * extractKeywords(\"add user authentication system\")\n * // Returns: [\"add\", \"user\", \"authentication\", \"system\"]\n * ```\n *\n * @internal\n */\nfunction extractKeywords(task: string | undefined): string[] {\n\tif (!task) {\n\t\treturn [];\n\t}\n\n\t// Common words to filter out\n\tconst stopWords = new Set([\n\t\t\"the\",\n\t\t\"a\",\n\t\t\"an\",\n\t\t\"to\",\n\t\t\"for\",\n\t\t\"of\",\n\t\t\"in\",\n\t\t\"on\",\n\t\t\"with\",\n\t\t\"and\",\n\t\t\"or\",\n\t\t\"is\",\n\t\t\"are\",\n\t\t\"it\",\n\t\t\"this\",\n\t\t\"that\",\n\t]);\n\n\t// Split, filter, and limit\n\treturn task\n\t\t.toLowerCase()\n\t\t.split(/\\s+/)\n\t\t.filter((word) => word.length > 2 && !stopWords.has(word))\n\t\t.slice(0, 5);\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { handleContextCommand };\n","/**\n * Stats Command\n *\n * @fileoverview Implements `snap stats` - Show learning engine statistics.\n * This is the CLI equivalent of the MCP's `codebase.get_learning_stats()` tool.\n *\n * ## Purpose\n *\n * The learning engine tracks interactions and violations to improve over time.\n * This command shows:\n * - How many interactions have been logged\n * - Feedback rate (how often users provide feedback)\n * - Accuracy rate (when feedback says AI was correct)\n * - Golden examples (high-confidence correct examples)\n * - Violation patterns and their promotion status\n *\n * ## Learning Loop Overview\n *\n * ```\n * Week 1: Bootstrap\n *  User creates patterns, records learnings\n *  violations.jsonl starts accumulating\n *  Golden dataset is empty\n *\n * Week 2-4: Pattern Recognition\n *  Same violations appear multiple times\n *  At 3x  auto-promoted to workspace-patterns.json\n *  User feedback improves accuracy\n *  Golden examples start accumulating\n *\n * Month 2+: Self-Sustaining\n *  Patterns catch most violations automatically\n *  High accuracy rate from golden examples\n *  New patterns continue to be learned\n * ```\n *\n * ## Usage Examples\n *\n * ```bash\n * # Show learning statistics\n * snap stats\n *\n * # Machine-readable output\n * snap stats --json\n * ```\n *\n * ## Output Format\n *\n * ```\n * \n *    Learning Statistics                 \n *                                          \n *   Total Interactions: 142                \n *   Feedback Rate: 68%                     \n *   Accuracy Rate: 94%                     \n *   Golden Examples: 23                    \n * \n *\n * Violation Patterns:\n * \n *  Type                      Count  Status                 \n * \n *  missing-error-handling    5       Ready for automation\n *  vague-assertion           3       Ready for promotion \n *  layer-boundary-violation  1       Tracking            \n * \n *\n * Violations at 3x  promoted | 5x  automated\n * ```\n *\n * ## Related\n *\n * - Spec: `ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md`\n * - MCP equivalent: `ai_dev_utils/mcp/server.ts`  `handleGetLearningStats()`\n * - Intelligence methods: `Intelligence.getStats()`, `Intelligence.getViolationsSummary()`\n *\n * @see {@link file://ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md}\n * @module commands/stats\n */\n\nimport type { LearningStats, ViolationsSummary } from \"@snapback/intelligence\";\nimport chalk from \"chalk\";\nimport Table from \"cli-table3\";\nimport { Command } from \"commander\";\n\nimport { getIntelligence } from \"../services/intelligence-service\";\nimport { displayBox } from \"../utils/display\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Options parsed from command line\n *\n * @internal\n */\ninterface StatsOptions {\n\t/** Output as JSON */\n\tjson?: boolean;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the stats command\n *\n * @returns Commander Command instance\n *\n * @remarks\n * ## Implementation Notes for LLM Agents\n *\n * 1. This command uses two Intelligence methods:\n *    - `getStats()`  LearningStats (sync)\n *    - `getViolationsSummary()`  ViolationsSummary (sync)\n *\n * 2. Display uses:\n *    - `displayBox()` for the learning stats summary\n *    - `cli-table3` directly for the violations table\n *\n * 3. Both methods are synchronous (no await needed after getting Intelligence)\n *\n * ## Empty State Handling\n *\n * If no interactions/violations yet:\n * - Show stats box with zeros\n * - Show helpful message about recording learnings\n * - Don't show empty violations table\n *\n * @example\n * ```typescript\n * // In apps/cli/src/index.ts:\n * import { createStatsCommand } from \"./commands/stats\";\n * program.addCommand(createStatsCommand());\n * ```\n */\nexport function createStatsCommand(): Command {\n\tconst stats = new Command(\"stats\")\n\t\t.description(\"Show learning statistics\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options: StatsOptions) => {\n\t\t\tawait handleStatsCommand(options);\n\t\t});\n\n\treturn stats;\n}\n\n// =============================================================================\n// COMMAND HANDLER\n// =============================================================================\n\n/**\n * Handle the stats command execution\n *\n * @param options - Command options\n *\n * @remarks\n * ## Implementation Flow\n *\n * 1. Get Intelligence instance\n * 2. Get learning stats and violations summary\n * 3. Format and display results\n *\n * ## Intelligence Methods Used\n *\n * ```typescript\n * // Get learning statistics\n * const learningStats = intelligence.getStats();\n *\n * // Get violations summary\n * const violationsSummary = intelligence.getViolationsSummary();\n * ```\n *\n * Both methods are synchronous after Intelligence is initialized.\n *\n * @internal\n */\nasync function handleStatsCommand(options: StatsOptions): Promise<void> {\n\tconst cwd = process.cwd();\n\n\ttry {\n\t\t// STEP 1: Get Intelligence instance\n\t\tconst intelligence = await getIntelligence(cwd);\n\n\t\t// STEP 2: Get stats (sync methods)\n\t\tconst learningStats = intelligence.getStats();\n\t\tconst violationsSummary = intelligence.getViolationsSummary();\n\n\t\t// STEP 3: Handle JSON output\n\t\tif (options.json) {\n\t\t\tconsole.log(\n\t\t\t\tJSON.stringify(\n\t\t\t\t\t{\n\t\t\t\t\t\tlearning: learningStats,\n\t\t\t\t\t\tviolations: violationsSummary,\n\t\t\t\t\t},\n\t\t\t\t\tnull,\n\t\t\t\t\t2,\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\t// STEP 4: Display formatted output\n\t\tdisplayStatsResults(learningStats, violationsSummary);\n\t} catch (error: unknown) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\n\t\tif (message.includes(\"not initialized\")) {\n\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\tprocess.exit(1);\n\t\t}\n\n\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\tprocess.exit(1);\n\t}\n}\n\n// =============================================================================\n// DISPLAY FUNCTIONS\n// =============================================================================\n\n/**\n * Display stats results in formatted output\n *\n * @param learningStats - Stats from Intelligence.getStats()\n * @param violationsSummary - Summary from Intelligence.getViolationsSummary()\n *\n * @remarks\n * ## Display Structure\n *\n * 1. Learning stats box\n *    - Total interactions\n *    - Feedback rate (as percentage)\n *    - Accuracy rate (as percentage)\n *    - Golden examples count\n *\n * 2. Violations table (if any)\n *    - Type, count, status columns\n *    - Limited to top 10 by count\n *\n * 3. Legend\n *    - Explains the promotion thresholds\n *\n * @internal\n */\nfunction displayStatsResults(learningStats: LearningStats, violationsSummary: ViolationsSummary): void {\n\t// PART 1: Learning stats box\n\tconsole.log(\n\t\tdisplayBox({\n\t\t\ttitle: \" Learning Statistics\",\n\t\t\tcontent: formatLearningStats(learningStats),\n\t\t\ttype: \"info\",\n\t\t}),\n\t);\n\n\t// PART 2: Violations table (if any violations exist)\n\tif (violationsSummary.byType.length > 0) {\n\t\tconsole.log();\n\t\tconsole.log(chalk.cyan(\"Violation Patterns:\"));\n\n\t\t// Create table with cli-table3\n\t\tconst table = new Table({\n\t\t\thead: [chalk.cyan(\"Type\"), chalk.cyan(\"Count\"), chalk.cyan(\"Status\")],\n\t\t\tstyle: { head: [], border: [] },\n\t\t});\n\n\t\t// Add rows (limit to top 10)\n\t\tfor (const v of violationsSummary.byType.slice(0, 10)) {\n\t\t\tconst displayStatus = formatViolationStatus(v.status);\n\t\t\ttable.push([v.type, String(v.count), displayStatus]);\n\t\t}\n\n\t\tconsole.log(table.toString());\n\n\t\t// Show if there are more\n\t\tif (violationsSummary.byType.length > 10) {\n\t\t\tconsole.log(chalk.gray(`  ... and ${violationsSummary.byType.length - 10} more types`));\n\t\t}\n\t} else {\n\t\t// No violations - show helpful message\n\t\tconsole.log();\n\t\tconsole.log(chalk.gray(\"No violations recorded yet.\"));\n\t\tconsole.log(chalk.gray('Record with: snap patterns report \"type\" \"file\" \"message\"'));\n\t}\n\n\t// PART 3: Legend\n\tconsole.log();\n\tconsole.log(chalk.gray(\"Violations at 3x  promoted | 5x  automated\"));\n}\n\n/**\n * Format learning stats for display in box\n *\n * @param stats - Learning statistics\n * @returns Formatted string for box content\n *\n * @remarks\n * Calculates percentages and formats with chalk styling.\n *\n * @internal\n */\nfunction formatLearningStats(stats: LearningStats): string {\n\t// Calculate feedback rate\n\tconst feedbackRate =\n\t\tstats.totalInteractions > 0 ? Math.round((stats.feedbackReceived / stats.totalInteractions) * 100) : 0;\n\n\t// Accuracy rate is already 0-1, convert to percentage\n\tconst accuracyRate = Math.round(stats.correctRate * 100);\n\n\treturn [\n\t\t`${chalk.bold(\"Total Interactions:\")} ${stats.totalInteractions}`,\n\t\t`${chalk.bold(\"Feedback Rate:\")} ${feedbackRate}%`,\n\t\t`${chalk.bold(\"Accuracy Rate:\")} ${accuracyRate}%`,\n\t\t`${chalk.bold(\"Golden Examples:\")} ${stats.goldenExamples}`,\n\t].join(\"\\n\");\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n/**\n * Format violation status for display\n *\n * @param status - Status from ViolationsSummary\n * @returns Formatted string with emoji\n *\n * @internal\n */\nfunction formatViolationStatus(status: string): string {\n\tswitch (status) {\n\t\tcase \"tracking\":\n\t\t\treturn \" Tracking\";\n\t\tcase \"ready_for_promotion\":\n\t\t\treturn \" Ready for promotion\";\n\t\tcase \"ready_for_automation\":\n\t\t\treturn \" Ready for automation\";\n\t\tcase \"promoted\":\n\t\t\treturn \" Promoted\";\n\t\tcase \"automated\":\n\t\t\treturn \" Automated\";\n\t\tdefault:\n\t\t\treturn status;\n\t}\n}\n\nexport { handleStatsCommand };\n","/**\n * CLI-UX-002: Git Integration\n *\n * Provides git operations for staged files detection, content retrieval,\n * and diff display. Fixes the `check` command to analyze staged files only.\n *\n * @see ai_dev_utils/resources/new_cli/02-execa-integration.spec.md\n */\n\nimport { execa } from \"execa\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface GitClientOptions {\n\tcwd?: string;\n\ttimeout?: number;\n}\n\nexport interface StagedFile {\n\tpath: string;\n\tstatus: \"added\" | \"modified\" | \"deleted\" | \"renamed\" | \"copied\";\n\toldPath?: string;\n}\n\nexport interface DiffHunk {\n\theader: string;\n\tadditions: number;\n\tdeletions: number;\n\tcontent: string;\n}\n\n// =============================================================================\n// CUSTOM ERRORS\n// =============================================================================\n\nexport class GitNotInstalledError extends Error {\n\tconstructor() {\n\t\tsuper(\"Git is not installed or not accessible in PATH\");\n\t\tthis.name = \"GitNotInstalledError\";\n\t}\n}\n\nexport class GitNotRepositoryError extends Error {\n\tconstructor(path: string) {\n\t\tsuper(`Not a git repository: ${path}`);\n\t\tthis.name = \"GitNotRepositoryError\";\n\t}\n}\n\nexport class GitBinaryFileError extends Error {\n\tconstructor(path: string) {\n\t\tsuper(`Cannot read binary file: ${path}`);\n\t\tthis.name = \"GitBinaryFileError\";\n\t}\n}\n\n// =============================================================================\n// GIT CLIENT CLASS\n// =============================================================================\n\nexport class GitClient {\n\tprivate cwd: string;\n\tprivate timeout: number;\n\n\tconstructor(options: GitClientOptions = {}) {\n\t\tthis.cwd = options.cwd || process.cwd();\n\t\tthis.timeout = options.timeout || 10000;\n\t}\n\n\t/**\n\t * Check if git is installed\n\t */\n\tasync isGitInstalled(): Promise<boolean> {\n\t\ttry {\n\t\t\tawait execa(\"git\", [\"--version\"], { timeout: 5000 });\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Check if cwd is inside a git repository\n\t */\n\tasync isGitRepository(): Promise<boolean> {\n\t\ttry {\n\t\t\tawait execa(\"git\", [\"rev-parse\", \"--is-inside-work-tree\"], {\n\t\t\t\tcwd: this.cwd,\n\t\t\t\ttimeout: this.timeout,\n\t\t\t});\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Get repository root path\n\t */\n\tasync getRepositoryRoot(): Promise<string> {\n\t\tconst { stdout } = await execa(\"git\", [\"rev-parse\", \"--show-toplevel\"], {\n\t\t\tcwd: this.cwd,\n\t\t\ttimeout: this.timeout,\n\t\t});\n\t\treturn stdout.trim();\n\t}\n\n\t/**\n\t * Get list of staged files with their status\n\t */\n\tasync getStagedFiles(): Promise<StagedFile[]> {\n\t\ttry {\n\t\t\tconst { stdout } = await execa(\"git\", [\"diff\", \"--cached\", \"--name-status\"], {\n\t\t\t\tcwd: this.cwd,\n\t\t\t\ttimeout: this.timeout,\n\t\t\t});\n\n\t\t\tif (!stdout.trim()) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\treturn stdout\n\t\t\t\t.split(/\\r?\\n/) // Cross-platform: handles both \\n (Unix) and \\r\\n (Windows)\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.map((line) => this.parseStatusLine(line));\n\t\t} catch (error) {\n\t\t\tif (this.isNotRepositoryError(error)) {\n\t\t\t\tthrow new GitNotRepositoryError(this.cwd);\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Get staged file content (what will be committed)\n\t */\n\tasync getStagedContent(filePath: string): Promise<string> {\n\t\ttry {\n\t\t\tconst { stdout } = await execa(\"git\", [\"show\", `:${filePath}`], {\n\t\t\t\tcwd: this.cwd,\n\t\t\t\ttimeout: this.timeout,\n\t\t\t});\n\t\t\treturn stdout;\n\t\t} catch (error) {\n\t\t\tif (this.isBinaryFileError(error)) {\n\t\t\t\tthrow new GitBinaryFileError(filePath);\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Get diff of staged changes for a file\n\t */\n\tasync getStagedDiff(filePath?: string): Promise<string> {\n\t\tconst args = [\"diff\", \"--cached\", \"--color=always\"];\n\t\tif (filePath) {\n\t\t\targs.push(\"--\", filePath);\n\t\t}\n\n\t\tconst { stdout } = await execa(\"git\", args, {\n\t\t\tcwd: this.cwd,\n\t\t\ttimeout: this.timeout,\n\t\t});\n\t\treturn stdout;\n\t}\n\n\t/**\n\t * Get diff statistics\n\t */\n\tasync getStagedStats(): Promise<{ additions: number; deletions: number; files: number }> {\n\t\tconst { stdout } = await execa(\"git\", [\"diff\", \"--cached\", \"--numstat\"], {\n\t\t\tcwd: this.cwd,\n\t\t\ttimeout: this.timeout,\n\t\t});\n\n\t\tlet additions = 0;\n\t\tlet deletions = 0;\n\t\tlet files = 0;\n\n\t\tfor (const line of stdout.split(/\\r?\\n/).filter(Boolean)) {\n\t\t\tconst [add, del] = line.split(\"\\t\");\n\t\t\tif (add !== \"-\") additions += Number.parseInt(add, 10);\n\t\t\tif (del !== \"-\") deletions += Number.parseInt(del, 10);\n\t\t\tfiles++;\n\t\t}\n\n\t\treturn { additions, deletions, files };\n\t}\n\n\t/**\n\t * Get current branch name\n\t */\n\tasync getCurrentBranch(): Promise<string> {\n\t\tconst { stdout } = await execa(\"git\", [\"branch\", \"--show-current\"], {\n\t\t\tcwd: this.cwd,\n\t\t\ttimeout: this.timeout,\n\t\t});\n\t\treturn stdout.trim();\n\t}\n\n\t/**\n\t * Get short commit hash of HEAD\n\t */\n\tasync getHeadCommit(): Promise<string> {\n\t\tconst { stdout } = await execa(\"git\", [\"rev-parse\", \"--short\", \"HEAD\"], {\n\t\t\tcwd: this.cwd,\n\t\t\ttimeout: this.timeout,\n\t\t});\n\t\treturn stdout.trim();\n\t}\n\n\t// ===========================================================================\n\t// PRIVATE HELPERS\n\t// ===========================================================================\n\n\tprivate parseStatusLine(line: string): StagedFile {\n\t\tconst [status, ...pathParts] = line.split(\"\\t\");\n\t\tconst path = pathParts[pathParts.length - 1];\n\t\tconst oldPath = pathParts.length > 1 ? pathParts[0] : undefined;\n\n\t\treturn {\n\t\t\tpath,\n\t\t\tstatus: this.parseStatus(status),\n\t\t\t...(oldPath && { oldPath }),\n\t\t};\n\t}\n\n\tprivate parseStatus(status: string): StagedFile[\"status\"] {\n\t\tconst char = status.charAt(0);\n\t\tswitch (char) {\n\t\t\tcase \"A\":\n\t\t\t\treturn \"added\";\n\t\t\tcase \"M\":\n\t\t\t\treturn \"modified\";\n\t\t\tcase \"D\":\n\t\t\t\treturn \"deleted\";\n\t\t\tcase \"R\":\n\t\t\t\treturn \"renamed\";\n\t\t\tcase \"C\":\n\t\t\t\treturn \"copied\";\n\t\t\tdefault:\n\t\t\t\treturn \"modified\";\n\t\t}\n\t}\n\n\tprivate isNotRepositoryError(error: unknown): boolean {\n\t\treturn error instanceof Error && error.message.toLowerCase().includes(\"not a git repository\");\n\t}\n\n\tprivate isBinaryFileError(error: unknown): boolean {\n\t\treturn error instanceof Error && error.message.toLowerCase().includes(\"binary\");\n\t}\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Check if a file is a code file worth analyzing\n */\nexport function isCodeFile(filePath: string): boolean {\n\tconst codeExtensions = [\n\t\t\".ts\",\n\t\t\".tsx\",\n\t\t\".js\",\n\t\t\".jsx\",\n\t\t\".mjs\",\n\t\t\".cjs\",\n\t\t\".py\",\n\t\t\".java\",\n\t\t\".go\",\n\t\t\".rs\",\n\t\t\".rb\",\n\t\t\".php\",\n\t\t\".c\",\n\t\t\".cpp\",\n\t\t\".h\",\n\t\t\".hpp\",\n\t\t\".cs\",\n\t\t\".swift\",\n\t\t\".kt\",\n\t\t\".scala\",\n\t\t\".clj\",\n\t\t\".ex\",\n\t\t\".exs\",\n\t];\n\n\treturn codeExtensions.some((ext) => filePath.endsWith(ext));\n}\n\n/**\n * Create GitClient with validation\n */\nexport async function createValidatedGitClient(options?: GitClientOptions): Promise<GitClient> {\n\tconst client = new GitClient(options);\n\n\tif (!(await client.isGitInstalled())) {\n\t\tthrow new GitNotInstalledError();\n\t}\n\n\tif (!(await client.isGitRepository())) {\n\t\tthrow new GitNotRepositoryError(options?.cwd || process.cwd());\n\t}\n\n\treturn client;\n}\n","/**\n * CLI-UX-004: Log-Update Integration\n *\n * Progress tracking utilities for real-time CLI feedback.\n * Provides file-by-file progress updates during multi-file operations.\n *\n * @see ai_dev_utils/resources/new_cli/04-log-update-integration.spec.md\n */\n\nimport chalk from \"chalk\";\nimport logUpdate from \"log-update\";\nimport ora, { type Ora } from \"ora\";\n\n// =============================================================================\n// TYPES (spec lines 94-99)\n// =============================================================================\n\nexport interface ProgressTrackerOptions {\n\ttotal: number;\n\tlabel?: string;\n\tquiet?: boolean;\n\tshowElapsed?: boolean;\n}\n\n// =============================================================================\n// PROGRESS TRACKER CLASS (spec lines 101-204)\n// =============================================================================\n\nexport class ProgressTracker {\n\tprivate current = 0;\n\tprivate total: number;\n\tprivate label: string;\n\tprivate quiet: boolean;\n\tprivate showElapsed: boolean;\n\tprivate startTime: number;\n\tprivate spinner: Ora | null = null;\n\tprivate isTTY: boolean;\n\n\tconstructor(options: ProgressTrackerOptions) {\n\t\tthis.total = options.total;\n\t\tthis.label = options.label || \"Processing\";\n\t\tthis.quiet = options.quiet || false;\n\t\tthis.showElapsed = options.showElapsed ?? true;\n\t\tthis.startTime = Date.now();\n\t\tthis.isTTY = process.stdout.isTTY ?? false;\n\t}\n\n\t/**\n\t * Start the progress tracker\n\t */\n\tstart(): void {\n\t\tif (this.quiet) return;\n\n\t\tif (this.isTTY) {\n\t\t\tthis.spinner = ora({\n\t\t\t\ttext: this.formatProgress(\"\"),\n\t\t\t\tspinner: \"dots\",\n\t\t\t}).start();\n\t\t} else {\n\t\t\t// Non-TTY: just log start\n\t\t\tconsole.log(`${this.label}: Starting (${this.total} items)`);\n\t\t}\n\t}\n\n\t/**\n\t * Update progress with current item\n\t */\n\tupdate(currentItem: string): void {\n\t\tthis.current++;\n\n\t\tif (this.quiet) return;\n\n\t\tconst progressText = this.formatProgress(currentItem);\n\n\t\tif (this.isTTY && this.spinner) {\n\t\t\tthis.spinner.text = progressText;\n\t\t} else {\n\t\t\t// Non-TTY: log every 10th item or significant items\n\t\t\tif (this.current % 10 === 0 || this.current === this.total) {\n\t\t\t\tconsole.log(`[${this.current}/${this.total}] ${currentItem}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Complete the progress with final message\n\t */\n\tcomplete(message: string): void {\n\t\tif (this.quiet) return;\n\n\t\tif (this.isTTY && this.spinner) {\n\t\t\tthis.spinner.succeed(message);\n\t\t} else {\n\t\t\tconsole.log(` ${message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Fail the progress with error message\n\t */\n\tfail(message: string): void {\n\t\tif (this.isTTY && this.spinner) {\n\t\t\tthis.spinner.fail(message);\n\t\t} else {\n\t\t\tconsole.error(` ${message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Get elapsed time string\n\t */\n\tgetElapsed(): string {\n\t\tconst elapsed = Date.now() - this.startTime;\n\t\tif (elapsed < 1000) return `${elapsed}ms`;\n\t\treturn `${(elapsed / 1000).toFixed(1)}s`;\n\t}\n\n\t/**\n\t * Get current progress count\n\t */\n\tgetCurrent(): number {\n\t\treturn this.current;\n\t}\n\n\t/**\n\t * Get total count\n\t */\n\tgetTotal(): number {\n\t\treturn this.total;\n\t}\n\n\tprivate formatProgress(currentItem: string): string {\n\t\tconst counter = chalk.cyan(`[${this.current}/${this.total}]`);\n\t\tconst item = currentItem ? chalk.gray(this.truncateItem(currentItem, 40)) : \"\";\n\t\tconst elapsed =\n\t\t\tthis.showElapsed && Date.now() - this.startTime > 2000 ? chalk.dim(` (${this.getElapsed()})`) : \"\";\n\n\t\treturn `${this.label} ${counter} ${item}${elapsed}`;\n\t}\n\n\tprivate truncateItem(item: string, maxLength: number): string {\n\t\tif (item.length <= maxLength) return item;\n\t\treturn \"...\" + item.slice(-(maxLength - 3));\n\t}\n}\n\n// =============================================================================\n// LIVE LOGGER (spec lines 206-229)\n// =============================================================================\n\n/**\n * Simple log-update wrapper for custom progress displays\n * Handles TTY detection and provides update/done/clear methods.\n */\nexport function createLiveLogger() {\n\tconst isTTY = process.stdout.isTTY ?? false;\n\n\treturn {\n\t\tupdate: (text: string) => {\n\t\t\tif (isTTY) {\n\t\t\t\tlogUpdate(text);\n\t\t\t}\n\t\t},\n\t\tdone: () => {\n\t\t\tif (isTTY) {\n\t\t\t\tlogUpdate.done();\n\t\t\t}\n\t\t},\n\t\tclear: () => {\n\t\t\tif (isTTY) {\n\t\t\t\tlogUpdate.clear();\n\t\t\t}\n\t\t},\n\t};\n}\n\n// =============================================================================\n// PROGRESS BAR RENDERER (spec lines 231-247)\n// =============================================================================\n\n/**\n * Progress bar renderer\n * Renders a visual progress bar with percentage.\n *\n * @param current - Current progress count\n * @param total - Total count\n * @param width - Bar width in characters (default 30)\n * @returns Formatted progress bar string\n */\nexport function renderProgressBar(current: number, total: number, width = 30): string {\n\tconst percentage = Math.min(current / total, 1);\n\tconst filled = Math.round(percentage * width);\n\tconst empty = width - filled;\n\n\tconst bar = chalk.green(\"\".repeat(filled)) + chalk.gray(\"\".repeat(empty));\n\tconst percent = chalk.cyan(`${Math.round(percentage * 100)}%`);\n\n\treturn `${bar} ${percent}`;\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Create a simple single-line progress indicator\n *\n * @param current - Current item number\n * @param total - Total items\n * @param item - Current item name\n * @returns Formatted progress line\n */\nexport function formatProgressLine(current: number, total: number, item: string): string {\n\tconst counter = chalk.cyan(`[${current}/${total}]`);\n\tconst truncatedItem = item.length > 50 ? \"...\" + item.slice(-47) : item;\n\treturn `${counter} ${chalk.gray(truncatedItem)}`;\n}\n\n/**\n * Format a duration in milliseconds to human-readable string\n *\n * @param ms - Duration in milliseconds\n * @returns Formatted duration string\n */\nexport function formatDuration(ms: number): string {\n\tif (ms < 1000) return `${ms}ms`;\n\tif (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;\n\tconst minutes = Math.floor(ms / 60000);\n\tconst seconds = Math.round((ms % 60000) / 1000);\n\treturn `${minutes}m ${seconds}s`;\n}\n","/**\n * Validate Command\n *\n * @fileoverview Implements `snap validate` - Run 7-layer validation pipeline on code.\n * This is the CLI equivalent of the MCP's `codebase.validate_code()` tool.\n *\n * ## Purpose\n *\n * Before committing code, developers should validate that it:\n * - Has no syntax errors\n * - Follows type conventions\n * - Passes architecture checks\n * - Has no security issues\n * - Meets performance standards\n *\n * This command runs the full ValidationPipeline from @snapback/intelligence.\n *\n * ## The 7 Validation Layers\n *\n * 1. **Syntax**: Basic parsing and structure\n * 2. **Types**: Type consistency and inference\n * 3. **Tests**: Test coverage and quality\n * 4. **Architecture**: Layer boundaries, import rules\n * 5. **Security**: Secrets, injection vulnerabilities\n * 6. **Dependencies**: Phantom deps, version conflicts\n * 7. **Performance**: Bundle size, complexity\n *\n * ## Usage Examples\n *\n * ```bash\n * # Validate a single file\n * snap validate src/auth.ts\n *\n * # Validate all staged files (pre-commit)\n * snap validate --all\n *\n * # Quiet mode - only output if issues found\n * snap validate --all --quiet\n *\n * # Machine-readable output\n * snap validate src/auth.ts --json\n * ```\n *\n * ## Output Format\n *\n * Default output shows progress and results table:\n * ```\n * Validating... src/auth.ts  100% (1/1)\n *\n * \n *  File             Passed  Confidence  Issues        \n * \n *  src/auth.ts             65%         3 (full_rev)  \n * \n *\n * \n *    Validation Failed                   \n *                                          \n *   src/auth.ts: 3 issues                  \n * \n * ```\n *\n * ## Related\n *\n * - Spec: `ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md`\n * - MCP equivalent: `ai_dev_utils/mcp/server.ts`  `handleValidateCode()`\n * - Intelligence method: `Intelligence.validateCode()` / `Intelligence.checkPatterns()`\n * - Pipeline: `packages/intelligence/src/validation/ValidationPipeline.ts`\n *\n * @see {@link file://ai_dev_utils/resources/new_cli/05-intelligence-integration.spec.md}\n * @module commands/validate\n */\n\nimport { readFile } from \"node:fs/promises\";\nimport { resolve } from \"node:path\";\nimport type { ReviewRecommendation } from \"@snapback/intelligence\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport { GitClient, isCodeFile } from \"../services/git-client\";\nimport { getIntelligence } from \"../services/intelligence-service\";\nimport { displayBox } from \"../utils/display\";\nimport { ProgressTracker } from \"../utils/progress\";\nimport { createValidationTable } from \"../utils/tables\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Options parsed from command line\n *\n * @internal\n */\ninterface ValidateOptions {\n\t/** Validate all staged files instead of specific file */\n\tall?: boolean;\n\t/** Only output if issues found */\n\tquiet?: boolean;\n\t/** Output as JSON */\n\tjson?: boolean;\n}\n\n/**\n * Result for a single file validation\n *\n * @remarks\n * This is used for both display and JSON output.\n * Maps to the shape expected by createValidationTable().\n */\nexport interface FileValidationResult {\n\t/** File path relative to workspace root */\n\tfile: string;\n\t/** Whether all critical checks passed */\n\tpassed: boolean;\n\t/** Confidence score 0-1 (displayed as percentage) */\n\tconfidence: number;\n\t/** Total number of issues found */\n\tissues: number;\n\t/**\n\t * Review recommendation from pipeline\n\t * - \"auto_merge\": Safe to merge automatically\n\t * - \"quick_review\": Minor issues, quick review needed\n\t * - \"full_review\": Critical issues, full review required\n\t * - \"error\": Validation failed (couldn't read file, etc.)\n\t */\n\trecommendation: ReviewRecommendation | \"error\";\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the validate command\n *\n * @returns Commander Command instance\n *\n * @remarks\n * ## Implementation Notes for LLM Agents\n *\n * 1. This command uses Intelligence.validateCode() for the heavy lifting\n * 2. For --all mode, use GitClient to get staged files\n * 3. Use ProgressTracker for real-time feedback (CLI-UX-004)\n * 4. Use createValidationTable() for results display (CLI-UX-003)\n * 5. Use displayBox() for summary (CLI-UX-001)\n *\n * ## Exit Codes\n *\n * - 0: All files passed validation\n * - 1: One or more files failed validation\n *\n * ## Error Handling\n *\n * - File not found  Include in results with recommendation: \"error\"\n * - Can't read file (binary, permissions)  Skip with warning\n * - Git errors  Show helpful message about git init\n *\n * @example\n * ```typescript\n * // In apps/cli/src/index.ts:\n * import { createValidateCommand } from \"./commands/validate\";\n * program.addCommand(createValidateCommand());\n * ```\n */\nexport function createValidateCommand(): Command {\n\tconst validate = new Command(\"validate\")\n\t\t.description(\"Run validation pipeline on code\")\n\t\t.argument(\"[file]\", \"File to validate\")\n\t\t.option(\"-a, --all\", \"Validate all staged files\")\n\t\t.option(\"-q, --quiet\", \"Only output if issues found\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (file: string | undefined, options: ValidateOptions) => {\n\t\t\tawait handleValidateCommand(file, options);\n\t\t});\n\n\treturn validate;\n}\n\n// =============================================================================\n// COMMAND HANDLER\n// =============================================================================\n\n/**\n * Handle the validate command execution\n *\n * @param file - Optional specific file to validate\n * @param options - Command options\n *\n * @remarks\n * ## Implementation Flow\n *\n * 1. Determine files to validate (specific file or staged files)\n * 2. Show progress tracker\n * 3. For each file:\n *    a. Read file content\n *    b. Call intelligence.validateCode()\n *    c. Collect results\n * 4. Display results table\n * 5. Show summary box if failures\n * 6. Exit with appropriate code\n *\n * ## Intelligence.validateCode() Input\n *\n * ```typescript\n * validateCode(code: string, filePath: string): Promise<PipelineResult>\n * ```\n *\n * ## Intelligence.validateCode() Output\n *\n * ```typescript\n * interface PipelineResult {\n *   overall: {\n *     passed: boolean;        // All critical checks passed\n *     confidence: number;     // 0-1 confidence score\n *     totalIssues: number;    // Sum of all issues\n *   };\n *   recommendation: \"auto_merge\" | \"quick_review\" | \"full_review\";\n *   layers: LayerResult[];    // Results from each of 7 layers\n *   focusPoints: string[];    // Key areas to review\n * }\n * ```\n *\n * @internal\n */\nasync function handleValidateCommand(file: string | undefined, options: ValidateOptions): Promise<void> {\n\tconst cwd = process.cwd();\n\n\ttry {\n\t\t// STEP 1: Get Intelligence instance\n\t\tconst intelligence = await getIntelligence(cwd);\n\n\t\t// STEP 2: Determine files to validate\n\t\tconst filesToValidate = await getFilesToValidate(file, options.all, cwd);\n\n\t\tif (filesToValidate.length === 0) {\n\t\t\tif (!options.quiet) {\n\t\t\t\tconsole.log(chalk.yellow(\"No files to validate\"));\n\t\t\t\tconsole.log(chalk.gray(\"Usage: snap validate <file> or snap validate --all\"));\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\t// STEP 3: Set up progress tracking\n\t\tconst progress = new ProgressTracker({\n\t\t\ttotal: filesToValidate.length,\n\t\t\tlabel: \"Validating\",\n\t\t\tquiet: options.quiet,\n\t\t});\n\n\t\tprogress.start();\n\n\t\t// STEP 4: Validate each file\n\t\tconst results: FileValidationResult[] = [];\n\t\tlet hasErrors = false;\n\t\tlet progressCompleted = false;\n\n\t\ttry {\n\t\t\tfor (const filePath of filesToValidate) {\n\t\t\t\tprogress.update(filePath);\n\n\t\t\t\ttry {\n\t\t\t\t\t// Read file content\n\t\t\t\t\tconst content = await readFile(resolve(cwd, filePath), \"utf-8\");\n\n\t\t\t\t\t// Run validation pipeline\n\t\t\t\t\tconst pipelineResult = await intelligence.validateCode(content, filePath);\n\n\t\t\t\t\t// Collect result\n\t\t\t\t\tresults.push({\n\t\t\t\t\t\tfile: filePath,\n\t\t\t\t\t\tpassed: pipelineResult.overall.passed,\n\t\t\t\t\t\tconfidence: pipelineResult.overall.confidence,\n\t\t\t\t\t\tissues: pipelineResult.overall.totalIssues,\n\t\t\t\t\t\trecommendation: pipelineResult.recommendation,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!pipelineResult.overall.passed) {\n\t\t\t\t\t\thasErrors = true;\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// File couldn't be read/validated\n\t\t\t\t\t// Include in results as error\n\t\t\t\t\tresults.push({\n\t\t\t\t\t\tfile: filePath,\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\tconfidence: 0,\n\t\t\t\t\t\tissues: 1,\n\t\t\t\t\t\trecommendation: \"error\",\n\t\t\t\t\t});\n\t\t\t\t\thasErrors = true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// STEP 5: Complete progress\n\t\t\tconst passedCount = results.filter((r) => r.passed).length;\n\n\t\t\tif (hasErrors) {\n\t\t\t\tprogress.fail(`${passedCount}/${results.length} files passed`);\n\t\t\t} else {\n\t\t\t\tprogress.complete(`All ${results.length} files passed validation`);\n\t\t\t}\n\t\t\tprogressCompleted = true;\n\n\t\t\t// STEP 6: Output results\n\t\t\tif (options.json) {\n\t\t\t\tconsole.log(JSON.stringify(results, null, 2));\n\t\t\t} else if (!options.quiet || hasErrors) {\n\t\t\t\tdisplayValidationResults(results, hasErrors);\n\t\t\t}\n\n\t\t\t// STEP 7: Exit with appropriate code\n\t\t\tprocess.exit(hasErrors ? 1 : 0);\n\t\t} finally {\n\t\t\t// Ensure progress is stopped if an error occurred before completion\n\t\t\tif (!progressCompleted) {\n\t\t\t\tprogress.fail(\"Validation interrupted\");\n\t\t\t}\n\t\t}\n\t} catch (error: unknown) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\n\t\tif (message.includes(\"not initialized\")) {\n\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\tprocess.exit(1);\n\t\t}\n\n\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\tprocess.exit(1);\n\t}\n}\n\n// =============================================================================\n// FILE DISCOVERY\n// =============================================================================\n\n/**\n * Get list of files to validate\n *\n * @param file - Specific file if provided\n * @param all - Whether --all flag was set\n * @param cwd - Current working directory\n * @returns Array of file paths to validate\n *\n * @remarks\n * ## Logic\n *\n * 1. If specific file provided  validate just that file\n * 2. If --all flag  get staged files from git, filter to code files\n * 3. If neither  return empty (will show usage hint)\n *\n * ## Code File Detection\n *\n * Uses isCodeFile() from git-client.ts which checks:\n * - .ts, .tsx, .js, .jsx extensions\n * - Excludes .d.ts declaration files\n * - Excludes node_modules, .git, etc.\n *\n * @internal\n */\nasync function getFilesToValidate(file: string | undefined, all: boolean | undefined, cwd: string): Promise<string[]> {\n\t// Case 1: Specific file provided\n\tif (file) {\n\t\treturn [file];\n\t}\n\n\t// Case 2: --all flag - get staged files\n\tif (all) {\n\t\ttry {\n\t\t\tconst git = new GitClient({ cwd });\n\n\t\t\t// Check git is available and we're in a repo\n\t\t\tif (!(await git.isGitInstalled())) {\n\t\t\t\tconsole.log(chalk.yellow(\"Git is not installed. Cannot detect staged files.\"));\n\t\t\t\tconsole.log(chalk.gray(\"Install git or specify a file: snap validate <file>\"));\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tif (!(await git.isGitRepository())) {\n\t\t\t\tconsole.log(chalk.yellow(\"Not a git repository. Cannot detect staged files.\"));\n\t\t\t\tconsole.log(chalk.gray(\"Initialize git or specify a file: snap validate <file>\"));\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\t// Get staged files\n\t\t\tconst stagedFiles = await git.getStagedFiles();\n\n\t\t\t// Filter to code files, exclude deleted files\n\t\t\treturn stagedFiles.filter((f) => f.status !== \"deleted\" && isCodeFile(f.path)).map((f) => f.path);\n\t\t} catch {\n\t\t\t// Git error - fall back to empty list\n\t\t\tconsole.log(chalk.yellow(\"Could not get staged files\"));\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t// Case 3: Neither - empty list\n\treturn [];\n}\n\n// =============================================================================\n// DISPLAY FUNCTIONS\n// =============================================================================\n\n/**\n * Display validation results\n *\n * @param results - Array of validation results\n * @param hasErrors - Whether any files failed\n *\n * @remarks\n * ## Display Structure\n *\n * 1. Results table (always if not quiet)\n *    - Uses createValidationTable()\n *    - Shows file, passed status, confidence, issues\n *\n * 2. Summary box (only if errors)\n *    - Uses displayBox() with type: \"error\"\n *    - Lists failed files\n *\n * 3. Tip (only if errors)\n *    - Suggests running patterns report\n *\n * @internal\n */\nfunction displayValidationResults(results: FileValidationResult[], hasErrors: boolean): void {\n\t// PART 1: Results table\n\tconsole.log();\n\tconsole.log(createValidationTable(results));\n\n\t// PART 2: Summary box for failures\n\tif (hasErrors) {\n\t\tconst failedFiles = results.filter((r) => !r.passed);\n\n\t\tconsole.log();\n\t\tconsole.log(\n\t\t\tdisplayBox({\n\t\t\t\ttitle: \" Validation Failed\",\n\t\t\t\tcontent: formatValidationSummary(failedFiles),\n\t\t\t\ttype: \"error\",\n\t\t\t}),\n\t\t);\n\n\t\t// PART 3: Tip\n\t\tconsole.log(chalk.gray(\"\\nRun 'snap patterns report' to track recurring issues\"));\n\t}\n}\n\n/**\n * Format failed files for summary box\n *\n * @param failures - Array of failed file results\n * @returns Formatted string for box content\n *\n * @internal\n */\nfunction formatValidationSummary(failures: FileValidationResult[]): string {\n\treturn failures.map((f) => `${chalk.bold(f.file)}: ${f.issues} issue${f.issues !== 1 ? \"s\" : \"\"}`).join(\"\\n\");\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { handleValidateCommand };\n","/**\n * Interactive Prompts Module\n *\n * Beautiful, accessible prompts for CLI interactions.\n * Includes confirmation dialogs, selection menus, and progress displays.\n *\n * Patterns from: GitHub CLI, Vercel CLI, Stripe CLI\n *\n * @module ui/prompts\n */\n\nimport chalk from \"chalk\";\nimport ora, { type Ora } from \"ora\";\nimport * as readline from \"readline\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface ConfirmOptions {\n\tmessage: string;\n\tdefault?: boolean;\n\ttimeout?: number;\n}\n\nexport interface SelectOption<T = string> {\n\tlabel: string;\n\tvalue: T;\n\thint?: string;\n\tdisabled?: boolean;\n}\n\nexport interface SelectOptions<T = string> {\n\tmessage: string;\n\toptions: SelectOption<T>[];\n\tdefault?: T;\n}\n\nexport interface ProgressOptions {\n\ttext: string;\n\tspinner?: \"dots\" | \"line\" | \"arc\" | \"arrow\";\n}\n\nexport interface MultiStepOptions {\n\tsteps: string[];\n\tcurrentStep: number;\n}\n\n// =============================================================================\n// CONFIRMATION PROMPTS\n// =============================================================================\n\n/**\n * Ask for confirmation before destructive operations\n */\nexport async function confirm(options: ConfirmOptions): Promise<boolean> {\n\tconst { message, default: defaultValue = false, timeout } = options;\n\n\tconst hint = defaultValue ? \"[Y/n]\" : \"[y/N]\";\n\tconst prompt = `${chalk.yellow(\"?\")} ${message} ${chalk.gray(hint)} `;\n\n\treturn new Promise((resolve) => {\n\t\tconst rl = readline.createInterface({\n\t\t\tinput: process.stdin,\n\t\t\toutput: process.stdout,\n\t\t});\n\n\t\tlet timeoutId: NodeJS.Timeout | undefined;\n\n\t\tif (timeout) {\n\t\t\ttimeoutId = setTimeout(() => {\n\t\t\t\tconsole.log(chalk.gray(`\\nNo response, defaulting to ${defaultValue ? \"yes\" : \"no\"}`));\n\t\t\t\trl.close();\n\t\t\t\tresolve(defaultValue);\n\t\t\t}, timeout);\n\t\t}\n\n\t\trl.question(prompt, (answer) => {\n\t\t\tif (timeoutId) clearTimeout(timeoutId);\n\t\t\trl.close();\n\n\t\t\tconst trimmed = answer.trim().toLowerCase();\n\n\t\t\tif (trimmed === \"\") {\n\t\t\t\tresolve(defaultValue);\n\t\t\t} else if (trimmed === \"y\" || trimmed === \"yes\") {\n\t\t\t\tresolve(true);\n\t\t\t} else {\n\t\t\t\tresolve(false);\n\t\t\t}\n\t\t});\n\t});\n}\n\n/**\n * Require explicit confirmation with typed input\n */\nexport async function confirmDangerous(message: string, confirmText: string): Promise<boolean> {\n\tconst prompt = `${chalk.red(\"!\")} ${message}\\n  Type \"${chalk.bold(confirmText)}\" to confirm: `;\n\n\treturn new Promise((resolve) => {\n\t\tconst rl = readline.createInterface({\n\t\t\tinput: process.stdin,\n\t\t\toutput: process.stdout,\n\t\t});\n\n\t\trl.question(prompt, (answer) => {\n\t\t\trl.close();\n\t\t\tresolve(answer.trim() === confirmText);\n\t\t});\n\t});\n}\n\n// =============================================================================\n// SELECTION PROMPTS\n// =============================================================================\n\n/**\n * Display a selection menu\n */\nexport async function select<T = string>(options: SelectOptions<T>): Promise<T | undefined> {\n\tconst { message, options: choices, default: defaultValue } = options;\n\n\tconsole.log(`${chalk.cyan(\"?\")} ${message}`);\n\tconsole.log();\n\n\t// Display options\n\tfor (let i = 0; i < choices.length; i++) {\n\t\tconst choice = choices[i];\n\t\tconst isDefault = choice.value === defaultValue;\n\t\tconst marker = isDefault ? chalk.cyan(\"\") : \" \";\n\t\tconst number = chalk.gray(`${i + 1}.`);\n\t\tconst label = choice.disabled ? chalk.gray(choice.label) : choice.label;\n\t\tconst hint = choice.hint ? chalk.gray(` (${choice.hint})`) : \"\";\n\t\tconst disabled = choice.disabled ? chalk.gray(\" [disabled]\") : \"\";\n\n\t\tconsole.log(`  ${marker} ${number} ${label}${hint}${disabled}`);\n\t}\n\n\tconsole.log();\n\n\treturn new Promise((resolve) => {\n\t\tconst rl = readline.createInterface({\n\t\t\tinput: process.stdin,\n\t\t\toutput: process.stdout,\n\t\t});\n\n\t\tconst prompt = chalk.gray(\"Enter number (or press Enter for default): \");\n\n\t\trl.question(prompt, (answer) => {\n\t\t\trl.close();\n\n\t\t\tconst trimmed = answer.trim();\n\n\t\t\tif (trimmed === \"\") {\n\t\t\t\tresolve(defaultValue);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst index = Number.parseInt(trimmed, 10) - 1;\n\n\t\t\tif (Number.isNaN(index) || index < 0 || index >= choices.length) {\n\t\t\t\tconsole.log(chalk.red(\"Invalid selection\"));\n\t\t\t\tresolve(undefined);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst choice = choices[index];\n\n\t\t\tif (choice.disabled) {\n\t\t\t\tconsole.log(chalk.red(\"That option is disabled\"));\n\t\t\t\tresolve(undefined);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresolve(choice.value);\n\t\t});\n\t});\n}\n\n// =============================================================================\n// PROGRESS INDICATORS\n// =============================================================================\n\n/**\n * Create a spinner for async operations\n */\nexport function spinner(options: ProgressOptions | string): Ora {\n\tconst opts = typeof options === \"string\" ? { text: options } : options;\n\tconst { text, spinner: spinnerType = \"dots\" } = opts;\n\n\treturn ora({\n\t\ttext,\n\t\tspinner: spinnerType,\n\t\tcolor: \"cyan\",\n\t});\n}\n\n/**\n * Run an async operation with a spinner\n */\nexport async function withSpinner<T>(\n\ttext: string,\n\tfn: () => Promise<T>,\n\toptions?: {\n\t\tsuccessText?: string;\n\t\tfailText?: string;\n\t},\n): Promise<T> {\n\tconst s = spinner(text).start();\n\n\ttry {\n\t\tconst result = await fn();\n\t\ts.succeed(options?.successText || text);\n\t\treturn result;\n\t} catch (error) {\n\t\ts.fail(options?.failText || text);\n\t\tthrow error;\n\t}\n}\n\n/**\n * Display a progress bar\n */\nexport function progressBar(current: number, total: number, width = 30): string {\n\tconst percent = Math.round((current / total) * 100);\n\tconst filled = Math.round((current / total) * width);\n\tconst empty = width - filled;\n\n\tconst bar = chalk.cyan(\"\".repeat(filled)) + chalk.gray(\"\".repeat(empty));\n\tconst label = `${current}/${total}`;\n\tconst percentage = chalk.gray(`${percent}%`);\n\n\treturn `${bar} ${label} ${percentage}`;\n}\n\n/**\n * Display step progress (e.g., \"Step 2 of 5\")\n */\nexport function stepProgress(options: MultiStepOptions): string {\n\tconst { steps, currentStep } = options;\n\tconst total = steps.length;\n\n\tconst lines: string[] = [];\n\tlines.push(chalk.cyan.bold(`Step ${currentStep + 1} of ${total}: ${steps[currentStep]}`));\n\tlines.push(\"\");\n\n\tfor (let i = 0; i < steps.length; i++) {\n\t\tconst step = steps[i];\n\t\tlet marker: string;\n\t\tlet label: string;\n\n\t\tif (i < currentStep) {\n\t\t\tmarker = chalk.green(\"\");\n\t\t\tlabel = chalk.gray(step);\n\t\t} else if (i === currentStep) {\n\t\t\tmarker = chalk.cyan(\"\");\n\t\t\tlabel = chalk.white(step);\n\t\t} else {\n\t\t\tmarker = chalk.gray(\"\");\n\t\t\tlabel = chalk.gray(step);\n\t\t}\n\n\t\tlines.push(`  ${marker} ${label}`);\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n\n// =============================================================================\n// TEXT INPUT\n// =============================================================================\n\n/**\n * Prompt for text input\n */\nexport async function input(\n\tmessage: string,\n\toptions?: {\n\t\tdefault?: string;\n\t\tvalidate?: (value: string) => string | boolean;\n\t\tmask?: boolean;\n\t},\n): Promise<string> {\n\tconst { default: defaultValue, validate, mask } = options || {};\n\n\tconst defaultHint = defaultValue ? chalk.gray(` (${defaultValue})`) : \"\";\n\tconst prompt = `${chalk.cyan(\"?\")} ${message}${defaultHint}: `;\n\n\treturn new Promise((resolve) => {\n\t\tconst rl = readline.createInterface({\n\t\t\tinput: process.stdin,\n\t\t\toutput: process.stdout,\n\t\t});\n\n\t\t// For password masking, we'd need more complex handling\n\t\t// This is a simplified version\n\t\trl.question(prompt, (answer) => {\n\t\t\trl.close();\n\n\t\t\tconst value = answer.trim() || defaultValue || \"\";\n\n\t\t\tif (validate) {\n\t\t\t\tconst validation = validate(value);\n\n\t\t\t\tif (typeof validation === \"string\") {\n\t\t\t\t\tconsole.log(chalk.red(` ${validation}`));\n\t\t\t\t\tresolve(\"\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (validation === false) {\n\t\t\t\t\tconsole.log(chalk.red(\" Invalid input\"));\n\t\t\t\t\tresolve(\"\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tresolve(value);\n\t\t});\n\t});\n}\n\n// =============================================================================\n// STATUS MESSAGES\n// =============================================================================\n\nexport const status = {\n\tsuccess: (message: string) => console.log(chalk.green(\"\"), message),\n\terror: (message: string) => console.log(chalk.red(\"\"), message),\n\twarning: (message: string) => console.log(chalk.yellow(\"!\"), message),\n\tinfo: (message: string) => console.log(chalk.blue(\"\"), message),\n\tdebug: (message: string) => console.log(chalk.gray(\"\"), chalk.gray(message)),\n\tstep: (message: string) => console.log(chalk.cyan(\"\"), message),\n\tdone: (message: string) => console.log(chalk.green(\"\"), chalk.green(message)),\n};\n\n// =============================================================================\n// DRY RUN MODE\n// =============================================================================\n\n/**\n * Display a dry-run diff preview\n */\nexport function dryRunPreview(changes: DryRunChange[]): void {\n\tconsole.log(chalk.yellow.bold(\"\\n DRY RUN - No changes will be made\\n\"));\n\n\tfor (const change of changes) {\n\t\tconst icon =\n\t\t\tchange.type === \"create\" ? chalk.green(\"+\") : change.type === \"delete\" ? chalk.red(\"-\") : chalk.yellow(\"~\");\n\n\t\tconsole.log(`${icon} ${change.path}`);\n\n\t\tif (change.details) {\n\t\t\tfor (const detail of change.details) {\n\t\t\t\tif (detail.startsWith(\"+\")) {\n\t\t\t\t\tconsole.log(chalk.green(`    ${detail}`));\n\t\t\t\t} else if (detail.startsWith(\"-\")) {\n\t\t\t\t\tconsole.log(chalk.red(`    ${detail}`));\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(chalk.gray(`    ${detail}`));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tconsole.log(chalk.yellow(\"\\nRun without --dry-run to apply these changes.\"));\n}\n\nexport interface DryRunChange {\n\ttype: \"create\" | \"update\" | \"delete\";\n\tpath: string;\n\tdetails?: string[];\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport const prompts = {\n\tconfirm,\n\tconfirmDangerous,\n\tselect,\n\tinput,\n\tspinner,\n\twithSpinner,\n\tprogressBar,\n\tstepProgress,\n\tstatus,\n\tdryRunPreview,\n};\n","/**\n * Safe Operations Module\n *\n * Utilities for making destructive CLI operations safer.\n * Includes dry-run mode, confirmation prompts, and undo support.\n *\n * Patterns from: Terraform, Git, GitHub CLI\n *\n * @module utils/safe-ops\n */\n\nimport chalk from \"chalk\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport { confirm, confirmDangerous, type DryRunChange, dryRunPreview } from \"../ui/prompts\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface SafeOperationOptions {\n\tdryRun?: boolean;\n\tforce?: boolean;\n\tverbose?: boolean;\n}\n\nexport interface UndoableOperation {\n\tid: string;\n\tdescription: string;\n\ttimestamp: Date;\n\tchanges: OperationChange[];\n\tcanUndo: boolean;\n}\n\nexport interface OperationChange {\n\ttype: \"create\" | \"update\" | \"delete\";\n\tpath: string;\n\tbefore?: string;\n\tafter?: string;\n}\n\n// =============================================================================\n// OPERATION HISTORY (for undo support)\n// =============================================================================\n\nconst HISTORY_FILE = \".snapback/operation-history.json\";\nconst MAX_HISTORY_SIZE = 50;\n\ninterface OperationHistory {\n\toperations: UndoableOperation[];\n}\n\n/**\n * Get the operations history file path\n */\nfunction getHistoryPath(): string {\n\tconst homeDir = process.env.HOME || process.env.USERPROFILE || \"\";\n\treturn path.join(homeDir, HISTORY_FILE);\n}\n\n/**\n * Load operation history\n */\nfunction loadHistory(): OperationHistory {\n\ttry {\n\t\tconst historyPath = getHistoryPath();\n\t\tif (fs.existsSync(historyPath)) {\n\t\t\treturn JSON.parse(fs.readFileSync(historyPath, \"utf-8\"));\n\t\t}\n\t} catch {\n\t\t// Ignore errors\n\t}\n\treturn { operations: [] };\n}\n\n/**\n * Save operation history\n */\nfunction saveHistory(history: OperationHistory): void {\n\ttry {\n\t\tconst historyPath = getHistoryPath();\n\t\tconst dir = path.dirname(historyPath);\n\t\tfs.mkdirSync(dir, { recursive: true });\n\n\t\t// Trim to max size\n\t\tif (history.operations.length > MAX_HISTORY_SIZE) {\n\t\t\thistory.operations = history.operations.slice(-MAX_HISTORY_SIZE);\n\t\t}\n\n\t\tfs.writeFileSync(historyPath, JSON.stringify(history, null, 2));\n\t} catch {\n\t\t// Ignore errors - history is best-effort\n\t}\n}\n\n/**\n * Record an operation for potential undo\n */\nexport function recordOperation(operation: UndoableOperation): void {\n\tconst history = loadHistory();\n\thistory.operations.push(operation);\n\tsaveHistory(history);\n}\n\n/**\n * Get the most recent undoable operation\n */\nexport function getLastOperation(): UndoableOperation | undefined {\n\tconst history = loadHistory();\n\treturn history.operations.filter((op) => op.canUndo).pop();\n}\n\n/**\n * Get recent operations\n */\nexport function getRecentOperations(count = 10): UndoableOperation[] {\n\tconst history = loadHistory();\n\treturn history.operations.slice(-count).reverse();\n}\n\n/**\n * Remove an operation from history (after undo)\n */\nexport function removeOperation(id: string): void {\n\tconst history = loadHistory();\n\thistory.operations = history.operations.filter((op) => op.id !== id);\n\tsaveHistory(history);\n}\n\n// =============================================================================\n// DRY RUN MODE\n// =============================================================================\n\n/**\n * Check if dry-run mode is enabled and display preview\n */\nexport function handleDryRun(options: SafeOperationOptions, changes: DryRunChange[]): boolean {\n\tif (!options.dryRun) {\n\t\treturn false; // Not a dry run, proceed with actual operation\n\t}\n\n\tdryRunPreview(changes);\n\treturn true; // Was a dry run, operation should be skipped\n}\n\n/**\n * Create a diff for display\n */\nexport function createDiff(before: string, after: string): string[] {\n\tconst beforeLines = before.split(\"\\n\");\n\tconst afterLines = after.split(\"\\n\");\n\tconst diff: string[] = [];\n\n\t// Simple line-by-line diff\n\tconst maxLines = Math.max(beforeLines.length, afterLines.length);\n\n\tfor (let i = 0; i < maxLines; i++) {\n\t\tconst beforeLine = beforeLines[i];\n\t\tconst afterLine = afterLines[i];\n\n\t\tif (beforeLine === undefined && afterLine !== undefined) {\n\t\t\tdiff.push(`+ ${afterLine}`);\n\t\t} else if (afterLine === undefined && beforeLine !== undefined) {\n\t\t\tdiff.push(`- ${beforeLine}`);\n\t\t} else if (beforeLine !== afterLine) {\n\t\t\tdiff.push(`- ${beforeLine}`);\n\t\t\tdiff.push(`+ ${afterLine}`);\n\t\t}\n\t}\n\n\treturn diff;\n}\n\n// =============================================================================\n// CONFIRMATION PROMPTS\n// =============================================================================\n\n/**\n * Prompt for confirmation based on operation risk level\n */\nexport async function confirmOperation(\n\tdescription: string,\n\toptions: SafeOperationOptions & { riskLevel?: \"low\" | \"medium\" | \"high\" },\n): Promise<boolean> {\n\t// Skip confirmation if --force is set\n\tif (options.force) {\n\t\treturn true;\n\t}\n\n\tconst { riskLevel = \"low\" } = options;\n\n\tif (riskLevel === \"high\") {\n\t\t// For dangerous operations, require typing confirmation\n\t\tconsole.log(chalk.red.bold(\"\\n  DANGEROUS OPERATION\"));\n\t\tconsole.log(chalk.white(description));\n\t\tconsole.log();\n\n\t\treturn confirmDangerous(\"This action cannot be undone.\", \"yes, delete\");\n\t}\n\n\tif (riskLevel === \"medium\") {\n\t\t// For medium-risk operations, use standard confirmation\n\t\tconsole.log(chalk.yellow(\"\\n  This operation may modify files\"));\n\t\treturn confirm({\n\t\t\tmessage: description,\n\t\t\tdefault: false,\n\t\t});\n\t}\n\n\t// For low-risk operations, use simple confirmation\n\treturn confirm({\n\t\tmessage: description,\n\t\tdefault: true,\n\t});\n}\n\n/**\n * Display what will be affected before an operation\n */\nexport function showAffectedFiles(files: string[], action: string): void {\n\tconsole.log(chalk.cyan(`\\nFiles that will be ${action}:`));\n\n\tif (files.length > 10) {\n\t\t// Show first 10 and summarize\n\t\tfor (const file of files.slice(0, 10)) {\n\t\t\tconsole.log(chalk.gray(`   ${file}`));\n\t\t}\n\t\tconsole.log(chalk.gray(`  ... and ${files.length - 10} more files`));\n\t} else {\n\t\tfor (const file of files) {\n\t\t\tconsole.log(chalk.gray(`   ${file}`));\n\t\t}\n\t}\n\tconsole.log();\n}\n\n// =============================================================================\n// UNDO CAPABILITY\n// =============================================================================\n\n/**\n * Attempt to undo the last operation\n */\nexport async function undoLastOperation(): Promise<boolean> {\n\tconst lastOp = getLastOperation();\n\n\tif (!lastOp) {\n\t\tconsole.log(chalk.yellow(\"No undoable operations found\"));\n\t\treturn false;\n\t}\n\n\tif (!lastOp.canUndo) {\n\t\tconsole.log(chalk.yellow(\"The last operation cannot be undone\"));\n\t\treturn false;\n\t}\n\n\tconsole.log(chalk.cyan(\"\\nLast operation:\"));\n\tconsole.log(chalk.white(`  ${lastOp.description}`));\n\tconsole.log(chalk.gray(`  ${lastOp.timestamp}`));\n\tconsole.log(chalk.gray(`  Changes: ${lastOp.changes.length} files`));\n\tconsole.log();\n\n\tconst shouldUndo = await confirm({\n\t\tmessage: \"Undo this operation?\",\n\t\tdefault: false,\n\t});\n\n\tif (!shouldUndo) {\n\t\treturn false;\n\t}\n\n\t// Perform undo\n\tlet success = true;\n\n\tfor (const change of lastOp.changes) {\n\t\ttry {\n\t\t\tswitch (change.type) {\n\t\t\t\tcase \"create\":\n\t\t\t\t\t// Undo create = delete the file\n\t\t\t\t\tif (change.path && fs.existsSync(change.path)) {\n\t\t\t\t\t\tfs.unlinkSync(change.path);\n\t\t\t\t\t\tconsole.log(chalk.red(`  - Removed ${change.path}`));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"delete\":\n\t\t\t\t\t// Undo delete = restore the file\n\t\t\t\t\tif (change.before !== undefined) {\n\t\t\t\t\t\tfs.writeFileSync(change.path, change.before);\n\t\t\t\t\t\tconsole.log(chalk.green(`  + Restored ${change.path}`));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"update\":\n\t\t\t\t\t// Undo update = restore previous content\n\t\t\t\t\tif (change.before !== undefined) {\n\t\t\t\t\t\tfs.writeFileSync(change.path, change.before);\n\t\t\t\t\t\tconsole.log(chalk.yellow(`  ~ Reverted ${change.path}`));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.log(chalk.red(`   Failed to undo ${change.path}`));\n\t\t\tsuccess = false;\n\t\t}\n\t}\n\n\tif (success) {\n\t\tremoveOperation(lastOp.id);\n\t\tconsole.log(chalk.green(\"\\n Operation undone successfully\"));\n\t} else {\n\t\tconsole.log(chalk.yellow(\"\\n! Some changes could not be undone\"));\n\t}\n\n\treturn success;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport const safeOps = {\n\thandleDryRun,\n\tconfirmOperation,\n\tshowAffectedFiles,\n\trecordOperation,\n\tgetLastOperation,\n\tgetRecentOperations,\n\tundoLastOperation,\n\tcreateDiff,\n};\n","/**\n * Learn Command\n *\n * Implements snap learn - Record learnings for future reference.\n * Learnings are stored in .snapback/learnings/user-learnings.jsonl\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\tgenerateId,\n\tgetLearnings,\n\tisSnapbackInitialized,\n\ttype LearningEntry,\n\trecordLearning,\n} from \"../services/snapback-dir\";\nimport { formatDate } from \"../utils\";\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the learn command\n */\nexport function createLearnCommand(): Command {\n\tconst learn = new Command(\"learn\")\n\t\t.description(\"Record learnings for future reference\")\n\t\t.argument(\"<trigger>\", \"When to apply this learning (keyword or situation)\")\n\t\t.argument(\"<action>\", \"What to do when triggered\")\n\t\t.option(\"-t, --type <type>\", \"Learning type: pattern, pitfall, efficiency, discovery, workflow\", \"pattern\")\n\t\t.option(\"-s, --source <source>\", \"Where this learning came from\", \"cli\")\n\t\t.action(async (trigger: string, action: string, options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Validate type\n\t\t\t\tconst validTypes = [\"pattern\", \"pitfall\", \"efficiency\", \"discovery\", \"workflow\"];\n\t\t\t\tif (!validTypes.includes(options.type)) {\n\t\t\t\t\tconsole.log(chalk.red(`Invalid type: ${options.type}`));\n\t\t\t\t\tconsole.log(chalk.gray(`Valid types: ${validTypes.join(\", \")}`));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Create learning entry\n\t\t\t\tconst learning: LearningEntry = {\n\t\t\t\t\tid: generateId(\"L\"),\n\t\t\t\t\ttype: options.type as LearningEntry[\"type\"],\n\t\t\t\t\ttrigger,\n\t\t\t\t\taction,\n\t\t\t\t\tsource: options.source,\n\t\t\t\t\tcreatedAt: new Date().toISOString(),\n\t\t\t\t};\n\n\t\t\t\tawait recordLearning(learning, cwd);\n\n\t\t\t\tconsole.log(chalk.green(\"\"), \"Learning recorded\");\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(`  ${chalk.cyan(\"Type:\")}    ${formatType(learning.type)}`);\n\t\t\t\tconsole.log(`  ${chalk.cyan(\"Trigger:\")} ${trigger}`);\n\t\t\t\tconsole.log(`  ${chalk.cyan(\"Action:\")}  ${action}`);\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(chalk.gray(`Query with: snap learn list --keyword \"${trigger.split(\" \")[0]}\"`));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Add list subcommand\n\tlearn\n\t\t.command(\"list\")\n\t\t.description(\"List recorded learnings\")\n\t\t.option(\"-t, --type <type>\", \"Filter by type\")\n\t\t.option(\"-k, --keyword <keyword>\", \"Search by keyword in trigger\")\n\t\t.option(\"-n, --number <count>\", \"Number of learnings to show\", \"20\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tlet learnings = await getLearnings(cwd);\n\n\t\t\t\t// Filter by type\n\t\t\t\tif (options.type) {\n\t\t\t\t\tlearnings = learnings.filter((l) => l.type === options.type);\n\t\t\t\t}\n\n\t\t\t\t// Filter by keyword\n\t\t\t\tif (options.keyword) {\n\t\t\t\t\tconst keyword = options.keyword.toLowerCase();\n\t\t\t\t\tlearnings = learnings.filter(\n\t\t\t\t\t\t(l) => l.trigger.toLowerCase().includes(keyword) || l.action.toLowerCase().includes(keyword),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// Limit\n\t\t\t\tconst count = Number.parseInt(options.number, 10);\n\t\t\t\tconst recent = learnings.slice(-count).reverse();\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(recent, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (recent.length === 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No learnings found\"));\n\t\t\t\t\tconsole.log(chalk.gray('Record with: snap learn \"trigger\" \"action\"'));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(`Learnings (${recent.length}):`));\n\t\t\t\tconsole.log();\n\n\t\t\t\tfor (const learning of recent) {\n\t\t\t\t\tconsole.log(formatType(learning.type), chalk.bold(learning.trigger));\n\t\t\t\t\tconsole.log(`   ${learning.action}`);\n\t\t\t\t\tconsole.log(chalk.gray(`  ${formatDate(learning.createdAt)}  ${learning.source}`));\n\t\t\t\t\tconsole.log();\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn learn;\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Format learning type with emoji\n */\nfunction formatType(type: LearningEntry[\"type\"]): string {\n\tconst formats: Record<LearningEntry[\"type\"], string> = {\n\t\tpattern: chalk.blue(\" pattern\"),\n\t\tpitfall: chalk.red(\"  pitfall\"),\n\t\tefficiency: chalk.green(\" efficiency\"),\n\t\tdiscovery: chalk.yellow(\" discovery\"),\n\t\tworkflow: chalk.magenta(\" workflow\"),\n\t};\n\n\treturn formats[type] || type;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { formatType };\n","/**\n * Patterns Command\n *\n * Implements snap patterns list/report - Manage workspace patterns.\n * Patterns are auto-promoted from violations after 3 occurrences.\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport { exec } from \"node:child_process\";\nimport { join } from \"node:path\";\nimport { promisify } from \"node:util\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\tgetViolations,\n\tisSnapbackInitialized,\n\treadSnapbackJson,\n\trecordViolation,\n\ttype ViolationEntry,\n\twriteSnapbackJson,\n} from \"../services/snapback-dir\";\nimport { formatDate } from \"../utils\";\n\nconst execAsync = promisify(exec);\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface WorkspacePattern {\n\ttype: string;\n\tdescription: string;\n\tprevention: string;\n\toccurrences: number;\n\tpromotedAt: string;\n\tlastSeenAt: string;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the patterns command with subcommands\n */\nexport function createPatternsCommand(): Command {\n\tconst patterns = new Command(\"patterns\").description(\"Manage workspace patterns\");\n\n\tpatterns\n\t\t.command(\"list\")\n\t\t.description(\"List promoted patterns\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst patternsList = await readSnapbackJson<WorkspacePattern[]>(\n\t\t\t\t\t\"patterns/workspace-patterns.json\",\n\t\t\t\t\tcwd,\n\t\t\t\t);\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(patternsList || [], null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!patternsList || patternsList.length === 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No patterns recorded yet\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Patterns are promoted after 3 occurrences of the same violation.\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(`Active Patterns (${patternsList.length}):`));\n\t\t\t\tconsole.log();\n\n\t\t\t\tfor (const pattern of patternsList) {\n\t\t\t\t\tconsole.log(chalk.bold(pattern.type));\n\t\t\t\t\tconsole.log(`  ${pattern.description}`);\n\t\t\t\t\tconsole.log(chalk.green(`  Prevention: ${pattern.prevention}`));\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\tchalk.gray(\n\t\t\t\t\t\t\t`  Occurrences: ${pattern.occurrences}  Last seen: ${formatDate(pattern.lastSeenAt)}`,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t\tconsole.log();\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tpatterns\n\t\t.command(\"report\")\n\t\t.description(\"Report a pattern violation\")\n\t\t.argument(\"<type>\", \"Violation type (e.g., 'layer-boundary-violation')\")\n\t\t.argument(\"<file>\", \"File where it occurred\")\n\t\t.argument(\"<message>\", \"What happened\")\n\t\t.option(\"-p, --prevention <prevention>\", \"How to prevent in future\")\n\t\t.action(async (type: string, file: string, message: string, options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Get existing violations\n\t\t\t\tconst violations = await getViolations(cwd);\n\n\t\t\t\t// Count occurrences of this type\n\t\t\t\tconst count = violations.filter((v) => v.type === type).length + 1;\n\n\t\t\t\t// Record new violation\n\t\t\t\tconst violation: ViolationEntry = {\n\t\t\t\t\ttype,\n\t\t\t\t\tfile,\n\t\t\t\t\tmessage,\n\t\t\t\t\tcount,\n\t\t\t\t\tdate: new Date().toISOString(),\n\t\t\t\t\t...(options.prevention && { prevention: options.prevention }),\n\t\t\t\t};\n\n\t\t\t\tawait recordViolation(violation, cwd);\n\n\t\t\t\tconsole.log(chalk.yellow(\"\"), `Violation recorded: ${type}`);\n\t\t\t\tconsole.log(chalk.gray(`  File: ${file}`));\n\t\t\t\tconsole.log(chalk.gray(`  Message: ${message}`));\n\t\t\t\tconsole.log(chalk.gray(`  Occurrences: ${count}/3 for promotion`));\n\n\t\t\t\t// Auto-promote at 3x\n\t\t\t\tif (count >= 3) {\n\t\t\t\t\tawait promoteToPattern(type, message, options.prevention, cwd);\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(chalk.green(\"\"), `Pattern promoted: ${type}`);\n\t\t\t\t\tconsole.log(chalk.gray(\"  This pattern will now be detected automatically.\"));\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tpatterns\n\t\t.command(\"violations\")\n\t\t.description(\"Show recent violations\")\n\t\t.option(\"-n, --number <count>\", \"Number of violations to show\", \"20\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst violations = await getViolations(cwd);\n\t\t\t\tconst count = Number.parseInt(options.number, 10);\n\t\t\t\tconst recent = violations.slice(-count).reverse();\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(recent, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (recent.length === 0) {\n\t\t\t\t\tconsole.log(chalk.green(\"\"), \"No violations recorded\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(`Recent Violations (${recent.length}):`));\n\t\t\t\tconsole.log();\n\n\t\t\t\t// Group by type\n\t\t\t\tconst grouped = new Map<string, ViolationEntry[]>();\n\t\t\t\tfor (const v of recent) {\n\t\t\t\t\tconst existing = grouped.get(v.type) || [];\n\t\t\t\t\texisting.push(v);\n\t\t\t\t\tgrouped.set(v.type, existing);\n\t\t\t\t}\n\n\t\t\t\tfor (const [type, vList] of grouped) {\n\t\t\t\t\tconst count = vList.length;\n\t\t\t\t\tconst promotionStatus = count >= 3 ? chalk.green(\"(promoted)\") : chalk.gray(`(${count}/3)`);\n\t\t\t\t\tconsole.log(chalk.bold(type), promotionStatus);\n\n\t\t\t\t\tfor (const v of vList.slice(0, 3)) {\n\t\t\t\t\t\tconsole.log(chalk.gray(`  ${v.file}`));\n\t\t\t\t\t\tconsole.log(chalk.gray(`    ${v.message}`));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (vList.length > 3) {\n\t\t\t\t\t\tconsole.log(chalk.gray(`  ... and ${vList.length - 3} more`));\n\t\t\t\t\t}\n\t\t\t\t\tconsole.log();\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tpatterns\n\t\t.command(\"summary\")\n\t\t.description(\"Show violation summary and promotion status\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst violations = await getViolations(cwd);\n\t\t\t\tconst patterns =\n\t\t\t\t\t(await readSnapbackJson<WorkspacePattern[]>(\"patterns/workspace-patterns.json\", cwd)) || [];\n\n\t\t\t\t// Count by type\n\t\t\t\tconst typeCounts = new Map<string, number>();\n\t\t\t\tfor (const v of violations) {\n\t\t\t\t\ttypeCounts.set(v.type, (typeCounts.get(v.type) || 0) + 1);\n\t\t\t\t}\n\n\t\t\t\tconst summary = {\n\t\t\t\t\ttotalViolations: violations.length,\n\t\t\t\t\tpromotedPatterns: patterns.length,\n\t\t\t\t\tpendingPromotion: [...typeCounts.entries()].filter(([_, count]) => count >= 2 && count < 3).length,\n\t\t\t\t\tbyType: Object.fromEntries(typeCounts),\n\t\t\t\t};\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(summary, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"Pattern Summary:\"));\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(`  Total violations:     ${summary.totalViolations}`);\n\t\t\t\tconsole.log(`  Promoted patterns:    ${summary.promotedPatterns}`);\n\t\t\t\tconsole.log(`  Pending promotion:    ${summary.pendingPromotion}`);\n\t\t\t\tconsole.log();\n\n\t\t\t\tif (typeCounts.size > 0) {\n\t\t\t\t\tconsole.log(chalk.cyan(\"By Type:\"));\n\t\t\t\t\tconst sorted = [...typeCounts.entries()].sort((a, b) => b[1] - a[1]);\n\t\t\t\t\tfor (const [type, count] of sorted) {\n\t\t\t\t\t\tconst status = count >= 3 ? chalk.green(\"promoted\") : chalk.gray(`${count}/3`);\n\t\t\t\t\t\tconsole.log(`  ${type.padEnd(30)} ${count} (${status})`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tpatterns\n\t\t.command(\"debt\")\n\t\t.description(\"Scan for TODO/FIXME/XXX comments (technical debt markers)\")\n\t\t.option(\"-d, --dir <directory>\", \"Directory to scan\", \".\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.option(\"--verbose\", \"Show file paths for each item\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\t\t\tconst targetDir = options.dir === \".\" ? cwd : join(cwd, options.dir);\n\n\t\t\ttry {\n\t\t\t\tconst debtItems = await scanTechnicalDebt(targetDir, cwd);\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(debtItems, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (debtItems.length === 0) {\n\t\t\t\t\tconsole.log(chalk.green(\"\"), \"No technical debt markers found\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Group by type\n\t\t\t\tconst grouped = {\n\t\t\t\t\tTODO: debtItems.filter((d) => d.type === \"TODO\"),\n\t\t\t\t\tFIXME: debtItems.filter((d) => d.type === \"FIXME\"),\n\t\t\t\t\tXXX: debtItems.filter((d) => d.type === \"XXX\"),\n\t\t\t\t\tHACK: debtItems.filter((d) => d.type === \"HACK\"),\n\t\t\t\t};\n\n\t\t\t\tconsole.log(chalk.cyan(`Technical Debt Report (${debtItems.length} items):`));\n\t\t\t\tconsole.log();\n\n\t\t\t\t// Summary\n\t\t\t\tconsole.log(chalk.bold(\"Summary:\"));\n\t\t\t\tif (grouped.FIXME.length > 0) {\n\t\t\t\t\tconsole.log(chalk.red(`  FIXME:  ${grouped.FIXME.length} (high priority)`));\n\t\t\t\t}\n\t\t\t\tif (grouped.XXX.length > 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(`  XXX:    ${grouped.XXX.length} (needs attention)`));\n\t\t\t\t}\n\t\t\t\tif (grouped.HACK.length > 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(`  HACK:   ${grouped.HACK.length} (temporary workarounds)`));\n\t\t\t\t}\n\t\t\t\tif (grouped.TODO.length > 0) {\n\t\t\t\t\tconsole.log(chalk.blue(`  TODO:   ${grouped.TODO.length} (planned work)`));\n\t\t\t\t}\n\t\t\t\tconsole.log();\n\n\t\t\t\t// Details if verbose\n\t\t\t\tif (options.verbose) {\n\t\t\t\t\tfor (const [type, items] of Object.entries(grouped)) {\n\t\t\t\t\t\tif (items.length === 0) continue;\n\n\t\t\t\t\t\tconst color =\n\t\t\t\t\t\t\ttype === \"FIXME\"\n\t\t\t\t\t\t\t\t? chalk.red\n\t\t\t\t\t\t\t\t: type === \"XXX\" || type === \"HACK\"\n\t\t\t\t\t\t\t\t\t? chalk.yellow\n\t\t\t\t\t\t\t\t\t: chalk.blue;\n\n\t\t\t\t\t\tconsole.log(color(`${type} (${items.length}):`));\n\n\t\t\t\t\t\tfor (const item of items.slice(0, 10)) {\n\t\t\t\t\t\t\tconsole.log(chalk.gray(`  ${item.file}:${item.line}`));\n\t\t\t\t\t\t\tconsole.log(`    ${item.text.substring(0, 80)}${item.text.length > 80 ? \"...\" : \"\"}`);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (items.length > 10) {\n\t\t\t\t\t\t\tconsole.log(chalk.gray(`  ... and ${items.length - 10} more`));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// Show top priority items\n\t\t\t\t\tconst highPriority = [...grouped.FIXME, ...grouped.XXX].slice(0, 5);\n\t\t\t\t\tif (highPriority.length > 0) {\n\t\t\t\t\t\tconsole.log(chalk.bold(\"High Priority Items:\"));\n\t\t\t\t\t\tfor (const item of highPriority) {\n\t\t\t\t\t\t\tconst color = item.type === \"FIXME\" ? chalk.red : chalk.yellow;\n\t\t\t\t\t\t\tconsole.log(`  ${color(item.type)} ${chalk.gray(item.file + \":\" + item.line)}`);\n\t\t\t\t\t\t\tconsole.log(`    ${item.text.substring(0, 70)}${item.text.length > 70 ? \"...\" : \"\"}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t}\n\n\t\t\t\t\tconsole.log(chalk.gray(\"Use --verbose for full report\"));\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn patterns;\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Promote a violation type to a pattern after 3 occurrences\n */\nasync function promoteToPattern(\n\ttype: string,\n\tdescription: string,\n\tprevention: string | undefined,\n\tworkspaceRoot: string,\n): Promise<void> {\n\t// Get violations for this type\n\tconst violations = await getViolations(workspaceRoot);\n\tconst typeViolations = violations.filter((v) => v.type === type);\n\tconst occurrences = typeViolations.length;\n\n\t// Get existing patterns\n\tconst patterns =\n\t\t(await readSnapbackJson<WorkspacePattern[]>(\"patterns/workspace-patterns.json\", workspaceRoot)) || [];\n\n\t// Check if already promoted\n\tconst existingIndex = patterns.findIndex((p) => p.type === type);\n\n\tconst pattern: WorkspacePattern = {\n\t\ttype,\n\t\tdescription,\n\t\tprevention: prevention || typeViolations.find((v) => v.prevention)?.prevention || \"Review and fix manually\",\n\t\toccurrences,\n\t\tpromotedAt: existingIndex >= 0 ? patterns[existingIndex].promotedAt : new Date().toISOString(),\n\t\tlastSeenAt: new Date().toISOString(),\n\t};\n\n\tif (existingIndex >= 0) {\n\t\tpatterns[existingIndex] = pattern;\n\t} else {\n\t\tpatterns.push(pattern);\n\t}\n\n\tawait writeSnapbackJson(\"patterns/workspace-patterns.json\", patterns, workspaceRoot);\n}\n\n/**\n * Scan for technical debt markers (TODO, FIXME, etc.)\n */\nasync function scanTechnicalDebt(_directory: string, _workspaceRoot: string): Promise<any[]> {\n\t// Stub implementation\n\treturn [];\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { promoteToPattern };\n","/**\n * Protect Command\n *\n * Implements snap protect add/remove/list - Manage file protection.\n * Protected files are stored in .snapback/protected.json\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport { access, constants } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\tgetProtectedFiles,\n\tisSnapbackInitialized,\n\ttype ProtectedFile,\n\tsaveProtectedFiles,\n} from \"../services/snapback-dir\";\nimport { formatDate } from \"../utils\";\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the protect command with subcommands\n */\nexport function createProtectCommand(): Command {\n\tconst protect = new Command(\"protect\").description(\"Manage file protection\");\n\n\tprotect\n\t\t.command(\"add\")\n\t\t.description(\"Add a file or pattern to protection\")\n\t\t.argument(\"<pattern>\", \"File path or glob pattern to protect\")\n\t\t.option(\"-r, --reason <reason>\", \"Reason for protection\")\n\t\t.action(async (pattern: string, options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Get current protected files\n\t\t\t\tconst protectedFiles = await getProtectedFiles(cwd);\n\n\t\t\t\t// Check if already protected\n\t\t\t\tconst existing = protectedFiles.find((f) => f.pattern === pattern);\n\t\t\t\tif (existing) {\n\t\t\t\t\tconsole.log(chalk.yellow(`Already protected: ${pattern}`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Validate pattern exists (for exact paths, not globs)\n\t\t\t\tif (!pattern.includes(\"*\") && !pattern.includes(\"**\")) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait access(join(cwd, pattern), constants.F_OK);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tconsole.log(chalk.yellow(`Warning: File not found: ${pattern}`));\n\t\t\t\t\t\tconsole.log(chalk.gray(\"Protection will still be added for future files matching this path.\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Add protection\n\t\t\t\tconst newProtection: ProtectedFile = {\n\t\t\t\t\tpattern,\n\t\t\t\t\taddedAt: new Date().toISOString(),\n\t\t\t\t\t...(options.reason && { reason: options.reason }),\n\t\t\t\t};\n\n\t\t\t\tprotectedFiles.push(newProtection);\n\t\t\t\tawait saveProtectedFiles(protectedFiles, cwd);\n\n\t\t\t\tconsole.log(chalk.green(\"\"), `Added protection: ${pattern}`);\n\t\t\t\tif (options.reason) {\n\t\t\t\t\tconsole.log(chalk.gray(`  Reason: ${options.reason}`));\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tprotect\n\t\t.command(\"remove\")\n\t\t.description(\"Remove a file or pattern from protection\")\n\t\t.argument(\"<pattern>\", \"File path or glob pattern to unprotect\")\n\t\t.action(async (pattern: string) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Get current protected files\n\t\t\t\tconst protectedFiles = await getProtectedFiles(cwd);\n\n\t\t\t\t// Find and remove\n\t\t\t\tconst index = protectedFiles.findIndex((f) => f.pattern === pattern);\n\t\t\t\tif (index === -1) {\n\t\t\t\t\tconsole.log(chalk.yellow(`Not protected: ${pattern}`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tprotectedFiles.splice(index, 1);\n\t\t\t\tawait saveProtectedFiles(protectedFiles, cwd);\n\n\t\t\t\tconsole.log(chalk.green(\"\"), `Removed protection: ${pattern}`);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tprotect\n\t\t.command(\"list\")\n\t\t.description(\"List all protected files\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst protectedFiles = await getProtectedFiles(cwd);\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(protectedFiles, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (protectedFiles.length === 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No files protected\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap protect add <pattern>\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"Protected files:\"));\n\t\t\t\tconsole.log();\n\n\t\t\t\tfor (const file of protectedFiles) {\n\t\t\t\t\tconsole.log(chalk.green(\"\"), file.pattern);\n\t\t\t\t\tif (file.reason) {\n\t\t\t\t\t\tconsole.log(chalk.gray(`  Reason: ${file.reason}`));\n\t\t\t\t\t}\n\t\t\t\t\tconsole.log(chalk.gray(`  Added: ${formatDate(file.addedAt)}`));\n\t\t\t\t}\n\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(chalk.gray(`Total: ${protectedFiles.length} protected`));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Add shorthand for common protections\n\tprotect\n\t\t.command(\"env\")\n\t\t.description(\"Protect all .env files\")\n\t\t.action(async () => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst patterns = [\".env\", \".env.*\", \"*.env\"];\n\t\t\t\tconst protectedFiles = await getProtectedFiles(cwd);\n\t\t\t\tlet added = 0;\n\n\t\t\t\tfor (const pattern of patterns) {\n\t\t\t\t\tif (!protectedFiles.some((f) => f.pattern === pattern)) {\n\t\t\t\t\t\tprotectedFiles.push({\n\t\t\t\t\t\t\tpattern,\n\t\t\t\t\t\t\taddedAt: new Date().toISOString(),\n\t\t\t\t\t\t\treason: \"Environment variables\",\n\t\t\t\t\t\t});\n\t\t\t\t\t\tadded++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (added > 0) {\n\t\t\t\t\tawait saveProtectedFiles(protectedFiles, cwd);\n\t\t\t\t\tconsole.log(chalk.green(\"\"), `Added ${added} environment file patterns`);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(chalk.yellow(\"Environment files already protected\"));\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tprotect\n\t\t.command(\"config\")\n\t\t.description(\"Protect common configuration files\")\n\t\t.action(async () => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst patterns = [\n\t\t\t\t\t\"*.config.js\",\n\t\t\t\t\t\"*.config.ts\",\n\t\t\t\t\t\"*.config.mjs\",\n\t\t\t\t\t\"tsconfig.json\",\n\t\t\t\t\t\"package.json\",\n\t\t\t\t\t\"pnpm-lock.yaml\",\n\t\t\t\t\t\"yarn.lock\",\n\t\t\t\t\t\"package-lock.json\",\n\t\t\t\t];\n\n\t\t\t\tconst protectedFiles = await getProtectedFiles(cwd);\n\t\t\t\tlet added = 0;\n\n\t\t\t\tfor (const pattern of patterns) {\n\t\t\t\t\tif (!protectedFiles.some((f) => f.pattern === pattern)) {\n\t\t\t\t\t\tprotectedFiles.push({\n\t\t\t\t\t\t\tpattern,\n\t\t\t\t\t\t\taddedAt: new Date().toISOString(),\n\t\t\t\t\t\t\treason: \"Configuration file\",\n\t\t\t\t\t\t});\n\t\t\t\t\t\tadded++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (added > 0) {\n\t\t\t\t\tawait saveProtectedFiles(protectedFiles, cwd);\n\t\t\t\t\tconsole.log(chalk.green(\"\"), `Added ${added} configuration file patterns`);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(chalk.yellow(\"Configuration files already protected\"));\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn protect;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n// formatDate now exported from ../utils (consolidated utility)\n","/**\n * Session Command\n *\n * Implements snap session start/status/end - Manage development sessions.\n * Sessions track task context and snapshot count.\n *\n * @see implementation_plan.md Section 1.2\n */\n\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\tappendSnapbackJsonl,\n\tendCurrentSession,\n\tgenerateId,\n\tgetCurrentSession,\n\tisSnapbackInitialized,\n\ttype SessionState,\n\tsaveCurrentSession,\n} from \"../services/snapback-dir\";\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the session command with subcommands\n */\nexport function createSessionCommand(): Command {\n\tconst session = new Command(\"session\").description(\"Manage development sessions\");\n\n\tsession\n\t\t.command(\"start\")\n\t\t.description(\"Start a new development session\")\n\t\t.argument(\"[task]\", \"Task description\")\n\t\t.option(\"-f, --force\", \"End current session and start a new one\")\n\t\t.action(async (task: string | undefined, options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Check for existing session\n\t\t\t\tconst existingSession = await getCurrentSession(cwd);\n\t\t\t\tif (existingSession && !options.force) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"A session is already active:\"));\n\t\t\t\t\tconsole.log(`  ID: ${chalk.gray(existingSession.id.substring(0, 8))}`);\n\t\t\t\t\tif (existingSession.task) {\n\t\t\t\t\t\tconsole.log(`  Task: ${existingSession.task}`);\n\t\t\t\t\t}\n\t\t\t\t\tconsole.log(`  Started: ${formatTimeAgo(existingSession.startedAt)}`);\n\t\t\t\t\tconsole.log(`  Snapshots: ${existingSession.snapshotCount}`);\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(chalk.gray(\"Use --force to end this session and start a new one\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// End existing session if forcing\n\t\t\t\tif (existingSession && options.force) {\n\t\t\t\t\tawait archiveSession(existingSession, cwd);\n\t\t\t\t\tconsole.log(chalk.gray(`Ended previous session: ${existingSession.id.substring(0, 8)}`));\n\t\t\t\t}\n\n\t\t\t\t// Create new session\n\t\t\t\tconst newSession: SessionState = {\n\t\t\t\t\tid: generateId(\"sess\"),\n\t\t\t\t\ttask,\n\t\t\t\t\tstartedAt: new Date().toISOString(),\n\t\t\t\t\tsnapshotCount: 0,\n\t\t\t\t};\n\n\t\t\t\tawait saveCurrentSession(newSession, cwd);\n\n\t\t\t\tconsole.log(chalk.green(\"\"), \"Session started\");\n\t\t\t\tconsole.log(`  ID: ${chalk.gray(newSession.id.substring(0, 8))}`);\n\t\t\t\tif (task) {\n\t\t\t\t\tconsole.log(`  Task: ${task}`);\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tsession\n\t\t.command(\"status\")\n\t\t.description(\"Show current session status\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst currentSession = await getCurrentSession(cwd);\n\n\t\t\t\tif (!currentSession) {\n\t\t\t\t\tif (options.json) {\n\t\t\t\t\t\tconsole.log(JSON.stringify({ active: false }, null, 2));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(chalk.yellow(\"No active session\"));\n\t\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap session start [task]\"));\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify({ active: true, ...currentSession }, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"Active Session:\"));\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(`  ID:        ${chalk.gray(currentSession.id.substring(0, 8))}`);\n\t\t\t\tif (currentSession.task) {\n\t\t\t\t\tconsole.log(`  Task:      ${currentSession.task}`);\n\t\t\t\t}\n\t\t\t\tconsole.log(`  Started:   ${formatTimeAgo(currentSession.startedAt)}`);\n\t\t\t\tconsole.log(`  Snapshots: ${currentSession.snapshotCount}`);\n\t\t\t\tconsole.log(`  Duration:  ${formatDuration(currentSession.startedAt)}`);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tsession\n\t\t.command(\"end\")\n\t\t.description(\"End the current session\")\n\t\t.option(\"-m, --message <message>\", \"Session end message/summary\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst currentSession = await getCurrentSession(cwd);\n\n\t\t\t\tif (!currentSession) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No active session\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Archive the session\n\t\t\t\tawait archiveSession(currentSession, cwd, options.message);\n\t\t\t\tawait endCurrentSession(cwd);\n\n\t\t\t\tconst duration = formatDuration(currentSession.startedAt);\n\n\t\t\t\tconsole.log(chalk.green(\"\"), \"Session ended\");\n\t\t\t\tconsole.log(`  ID:        ${chalk.gray(currentSession.id.substring(0, 8))}`);\n\t\t\t\tconsole.log(`  Duration:  ${duration}`);\n\t\t\t\tconsole.log(`  Snapshots: ${currentSession.snapshotCount}`);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tsession\n\t\t.command(\"history\")\n\t\t.description(\"Show session history\")\n\t\t.option(\"-n, --number <count>\", \"Number of sessions to show\", \"10\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst { loadSnapbackJsonl } = await import(\"../services/snapback-dir\");\n\t\t\t\tconst history = await loadSnapbackJsonl<ArchivedSession>(\"session/history.jsonl\", cwd);\n\n\t\t\t\tconst count = Number.parseInt(options.number, 10);\n\t\t\t\tconst recent = history.slice(-count).reverse();\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(recent, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (recent.length === 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No session history\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"Recent Sessions:\"));\n\t\t\t\tconsole.log();\n\n\t\t\t\tfor (const session of recent) {\n\t\t\t\t\tconst duration = formatDurationFromDates(session.startedAt, session.endedAt);\n\t\t\t\t\tconsole.log(chalk.gray(session.id.substring(0, 8)), session.task || chalk.gray(\"(no task)\"));\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t`  ${formatDate(session.startedAt)}  ${duration}  ${session.snapshotCount} snapshots`,\n\t\t\t\t\t);\n\t\t\t\t\tif (session.endMessage) {\n\t\t\t\t\t\tconsole.log(chalk.gray(`  \"${session.endMessage}\"`));\n\t\t\t\t\t}\n\t\t\t\t\tconsole.log();\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn session;\n}\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface ArchivedSession extends SessionState {\n\tendedAt: string;\n\tendMessage?: string;\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Archive a session to history\n */\nasync function archiveSession(session: SessionState, workspaceRoot: string, endMessage?: string): Promise<void> {\n\tconst archived: ArchivedSession = {\n\t\t...session,\n\t\tendedAt: new Date().toISOString(),\n\t\t...(endMessage && { endMessage }),\n\t};\n\n\tawait appendSnapbackJsonl(\"session/history.jsonl\", archived, workspaceRoot);\n}\n\n/**\n * Format time ago (e.g., \"2 hours ago\")\n */\nfunction formatTimeAgo(isoDate: string): string {\n\tconst date = new Date(isoDate);\n\tconst now = new Date();\n\tconst seconds = Math.floor((now.getTime() - date.getTime()) / 1000);\n\n\tif (seconds < 60) return \"just now\";\n\tif (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;\n\tif (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;\n\treturn `${Math.floor(seconds / 86400)} days ago`;\n}\n\n/**\n * Format duration from start time to now\n */\nfunction formatDuration(startIso: string): string {\n\tconst start = new Date(startIso);\n\tconst now = new Date();\n\tconst seconds = Math.floor((now.getTime() - start.getTime()) / 1000);\n\n\treturn formatSeconds(seconds);\n}\n\n/**\n * Format duration between two dates\n */\nfunction formatDurationFromDates(startIso: string, endIso: string): string {\n\tconst start = new Date(startIso);\n\tconst end = new Date(endIso);\n\tconst seconds = Math.floor((end.getTime() - start.getTime()) / 1000);\n\n\treturn formatSeconds(seconds);\n}\n\n/**\n * Format seconds to human readable\n */\nfunction formatSeconds(seconds: number): string {\n\tif (seconds < 60) return `${seconds}s`;\n\tif (seconds < 3600) return `${Math.floor(seconds / 60)}m`;\n\n\tconst hours = Math.floor(seconds / 3600);\n\tconst minutes = Math.floor((seconds % 3600) / 60);\n\treturn minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;\n}\n\n/**\n * Format date for display\n */\nfunction formatDate(isoDate: string): string {\n\tconst date = new Date(isoDate);\n\treturn date.toLocaleDateString(\"en-US\", {\n\t\tmonth: \"short\",\n\t\tday: \"numeric\",\n\t\thour: \"2-digit\",\n\t\tminute: \"2-digit\",\n\t});\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { archiveSession, formatTimeAgo, formatDuration };\n","/**\n * Watcher Service\n *\n * Continuous file watching daemon for behavioral learning.\n * Uses chokidar pattern from packages/core/src/utils/watcher.ts\n *\n * Watches for:\n * - File changes in workspace (for protection suggestions)\n * - .snapback/ changes (for pattern promotion)\n * - Config file changes (for auto-detection)\n *\n * Records behavioral signals:\n * - Which files are frequently modified\n * - Which files trigger rollbacks\n * - Patterns in developer activity\n *\n * @see the_vision.md - behavioral learning\n * @see lib_implementation.md TASK 5 - chokidar\n */\n\nimport { EventEmitter } from \"node:events\";\nimport { basename, relative } from \"node:path\";\nimport type { FSWatcher } from \"chokidar\";\nimport chokidar from \"chokidar\";\n\nimport {\n\tappendSnapbackJsonl,\n\tgetProtectedFiles,\n\tgetViolations,\n\tgetWorkspaceDir,\n\tisSnapbackInitialized,\n\ttype LearningEntry,\n\tloadSnapbackJsonl,\n} from \"./snapback-dir\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface WatcherConfig {\n\t/** Workspace root directory */\n\tworkspaceRoot: string;\n\t/** Debounce delay in ms (default: 120) */\n\tdebounceMs?: number;\n\t/** Max depth for directory watching (default: 10) */\n\tdepth?: number;\n\t/** Patterns to ignore */\n\tignored?: string[];\n\t/** Enable verbose logging */\n\tverbose?: boolean;\n}\n\nexport interface BehavioralSignal {\n\ttype: \"file_change\" | \"file_add\" | \"file_delete\" | \"protection_added\" | \"violation_detected\";\n\tpath: string;\n\ttimestamp: string;\n\tmetadata?: Record<string, unknown>;\n}\n\nexport interface WatcherStats {\n\tstartedAt: string;\n\tfilesWatched: number;\n\tsignalsRecorded: number;\n\tpatternsDetected: number;\n\tlastActivityAt: string | null;\n}\n\nexport type WatcherEvent = \"ready\" | \"change\" | \"add\" | \"unlink\" | \"error\" | \"signal\" | \"pattern\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\nconst DEFAULT_CONFIG: Partial<WatcherConfig> = {\n\tdebounceMs: 120,\n\tdepth: 10,\n\tignored: [\n\t\t\"**/{node_modules,.git,.vscode,dist,.next,.nuxt,coverage}/**\",\n\t\t\"**/*.log\",\n\t\t\"**/.*cache*/**\",\n\t\t\"**/.snapback/snapshots/**\",\n\t\t\"**/.snapback/embeddings.db\",\n\t],\n};\n\n// Critical file patterns that should suggest protection\nconst CRITICAL_FILE_PATTERNS = [\n\t/\\.env.*$/,\n\t/config\\.(json|yaml|yml|toml)$/,\n\t/secrets?\\.(json|yaml|yml)$/,\n\t/\\.pem$/,\n\t/\\.key$/,\n\t/auth\\.ts$/,\n\t/middleware\\.ts$/,\n\t/schema\\.(ts|prisma)$/,\n];\n\n// Patterns that indicate potential issues\nconst RISKY_CHANGE_PATTERNS = [\n\t/package\\.json$/,\n\t/package-lock\\.json$/,\n\t/pnpm-lock\\.yaml$/,\n\t/yarn\\.lock$/,\n\t/tsconfig\\.json$/,\n];\n\n// =============================================================================\n// WATCHER CLASS\n// =============================================================================\n\nexport class SnapbackWatcher extends EventEmitter {\n\tprivate watcher: FSWatcher | null = null;\n\tprivate config: WatcherConfig;\n\tprivate stats: WatcherStats;\n\tprivate signalBuffer: BehavioralSignal[] = [];\n\tprivate flushTimer: NodeJS.Timeout | null = null;\n\tprivate changeCountByFile: Map<string, number> = new Map();\n\n\tconstructor(config: WatcherConfig) {\n\t\tsuper();\n\t\tthis.config = { ...DEFAULT_CONFIG, ...config };\n\t\tthis.stats = {\n\t\t\tstartedAt: new Date().toISOString(),\n\t\t\tfilesWatched: 0,\n\t\t\tsignalsRecorded: 0,\n\t\t\tpatternsDetected: 0,\n\t\t\tlastActivityAt: null,\n\t\t};\n\t}\n\n\t/**\n\t * Start watching the workspace\n\t */\n\tasync start(): Promise<void> {\n\t\tif (this.watcher) {\n\t\t\tthrow new Error(\"Watcher already started\");\n\t\t}\n\n\t\t// Verify snapback is initialized\n\t\tif (!(await isSnapbackInitialized(this.config.workspaceRoot))) {\n\t\t\tthrow new Error(\"SnapBack not initialized. Run: snap init\");\n\t\t}\n\n\t\tconst { workspaceRoot, debounceMs, depth, ignored } = this.config;\n\n\t\tthis.log(\"Starting watcher...\");\n\n\t\tthis.watcher = chokidar.watch(workspaceRoot, {\n\t\t\tignoreInitial: true,\n\t\t\tignored: ignored,\n\t\t\tawaitWriteFinish: { stabilityThreshold: debounceMs, pollInterval: 50 },\n\t\t\tignorePermissionErrors: true,\n\t\t\tdepth: depth,\n\t\t\tpersistent: true,\n\t\t});\n\n\t\t// Set up event handlers\n\t\tthis.watcher\n\t\t\t.on(\"ready\", () => {\n\t\t\t\tthis.stats.filesWatched = this.getWatchedCount();\n\t\t\t\tthis.log(`Ready. Watching ${this.stats.filesWatched} files`);\n\t\t\t\tthis.emit(\"ready\", this.stats);\n\t\t\t})\n\t\t\t.on(\"change\", (path) => this.handleChange(\"change\", path))\n\t\t\t.on(\"add\", (path) => this.handleChange(\"add\", path))\n\t\t\t.on(\"unlink\", (path) => this.handleChange(\"unlink\", path))\n\t\t\t.on(\"error\", (error: unknown) => {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tthis.log(`Error: ${message}`, true);\n\t\t\t\tthis.emit(\"error\", error);\n\t\t\t});\n\n\t\t// Watch .snapback/ specifically for pattern promotion\n\t\tthis.watchSnapbackDir();\n\n\t\t// Start flush timer\n\t\tthis.startFlushTimer();\n\t}\n\n\t/**\n\t * Stop watching\n\t */\n\tasync stop(): Promise<void> {\n\t\tif (this.flushTimer) {\n\t\t\tclearInterval(this.flushTimer);\n\t\t\tthis.flushTimer = null;\n\t\t}\n\n\t\t// Flush remaining signals\n\t\tawait this.flushSignals();\n\n\t\tif (this.watcher) {\n\t\t\tawait this.watcher.close();\n\t\t\tthis.watcher = null;\n\t\t\tthis.log(\"Stopped\");\n\t\t}\n\t}\n\n\t/**\n\t * Get current stats\n\t */\n\tgetStats(): WatcherStats {\n\t\treturn { ...this.stats };\n\t}\n\n\t/**\n\t * Check if watcher is running\n\t */\n\tisRunning(): boolean {\n\t\treturn this.watcher !== null;\n\t}\n\n\t// =============================================================================\n\t// PRIVATE METHODS\n\t// =============================================================================\n\n\tprivate handleChange(type: \"change\" | \"add\" | \"unlink\", path: string): void {\n\t\tconst relativePath = relative(this.config.workspaceRoot, path);\n\n\t\tthis.stats.lastActivityAt = new Date().toISOString();\n\n\t\t// Create signal\n\t\tconst signal: BehavioralSignal = {\n\t\t\ttype: type === \"add\" ? \"file_add\" : type === \"unlink\" ? \"file_delete\" : \"file_change\",\n\t\t\tpath: relativePath,\n\t\t\ttimestamp: this.stats.lastActivityAt,\n\t\t};\n\n\t\t// Track change frequency\n\t\tconst count = (this.changeCountByFile.get(relativePath) || 0) + 1;\n\t\tthis.changeCountByFile.set(relativePath, count);\n\n\t\t// Check if file is critical\n\t\tconst isCritical = this.isCriticalFile(relativePath);\n\t\tconst isRisky = this.isRiskyChange(relativePath);\n\n\t\tif (isCritical) {\n\t\t\tsignal.metadata = { critical: true };\n\t\t\tthis.emit(\"signal\", { ...signal, suggestion: \"Consider protecting this file\" });\n\t\t}\n\n\t\tif (isRisky) {\n\t\t\tsignal.metadata = { ...signal.metadata, risky: true };\n\t\t}\n\n\t\t// Buffer signal for batch write\n\t\tthis.signalBuffer.push(signal);\n\n\t\t// Emit event\n\t\tthis.emit(type, relativePath, { isCritical, isRisky, changeCount: count });\n\n\t\t// Check for patterns\n\t\tthis.detectPatterns(relativePath, count);\n\n\t\tthis.log(`${type}: ${relativePath}${isCritical ? \" [CRITICAL]\" : \"\"}${isRisky ? \" [RISKY]\" : \"\"}`);\n\t}\n\n\tprivate watchSnapbackDir(): void {\n\t\tconst snapbackDir = getWorkspaceDir(this.config.workspaceRoot);\n\n\t\t// Watch violations.jsonl for auto-promotion\n\t\tconst violationsWatcher = chokidar.watch(`${snapbackDir}/patterns/violations.jsonl`, {\n\t\t\tignoreInitial: true,\n\t\t\tawaitWriteFinish: { stabilityThreshold: 200, pollInterval: 50 },\n\t\t});\n\n\t\tviolationsWatcher.on(\"change\", async () => {\n\t\t\tawait this.checkViolationPromotion();\n\t\t});\n\t}\n\n\tprivate async checkViolationPromotion(): Promise<void> {\n\t\ttry {\n\t\t\tconst violations = await getViolations(this.config.workspaceRoot);\n\n\t\t\t// Count by type\n\t\t\tconst typeCounts = new Map<string, number>();\n\t\t\tfor (const v of violations) {\n\t\t\t\ttypeCounts.set(v.type, (typeCounts.get(v.type) || 0) + 1);\n\t\t\t}\n\n\t\t\t// Check for promotion candidates (3+ occurrences)\n\t\t\tfor (const [type, count] of typeCounts) {\n\t\t\t\tif (count >= 3) {\n\t\t\t\t\tthis.emit(\"pattern\", {\n\t\t\t\t\t\ttype: \"PROMOTION_READY\",\n\t\t\t\t\t\tviolationType: type,\n\t\t\t\t\t\tcount,\n\t\t\t\t\t\tmessage: `Violation \"${type}\" seen ${count}x - ready for promotion`,\n\t\t\t\t\t});\n\t\t\t\t\tthis.stats.patternsDetected++;\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors\n\t\t}\n\t}\n\n\tprivate detectPatterns(path: string, changeCount: number): void {\n\t\t// Detect frequently changed files\n\t\tif (changeCount >= 5) {\n\t\t\tthis.emit(\"pattern\", {\n\t\t\t\ttype: \"FREQUENTLY_CHANGED\",\n\t\t\t\tpath,\n\t\t\t\tcount: changeCount,\n\t\t\t\tmessage: `File \"${basename(path)}\" changed ${changeCount}x - consider protection`,\n\t\t\t});\n\t\t\tthis.stats.patternsDetected++;\n\t\t}\n\n\t\t// Detect if critical file is unprotected\n\t\tif (this.isCriticalFile(path) && changeCount >= 2) {\n\t\t\tthis.checkProtectionSuggestion(path);\n\t\t}\n\t}\n\n\tprivate async checkProtectionSuggestion(path: string): Promise<void> {\n\t\tconst protectedFiles = await getProtectedFiles(this.config.workspaceRoot);\n\t\tconst isProtected = protectedFiles.some(\n\t\t\t(p) =>\n\t\t\t\tp.pattern === path ||\n\t\t\t\t(p.pattern.includes(\"*\") && new RegExp(p.pattern.replace(/\\*/g, \".*\")).test(path)),\n\t\t);\n\n\t\tif (!isProtected) {\n\t\t\tthis.emit(\"signal\", {\n\t\t\t\ttype: \"protection_added\",\n\t\t\t\tpath,\n\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\tsuggestion: `Consider: snap protect add \"${path}\"`,\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate isCriticalFile(path: string): boolean {\n\t\treturn CRITICAL_FILE_PATTERNS.some((pattern) => pattern.test(path));\n\t}\n\n\tprivate isRiskyChange(path: string): boolean {\n\t\treturn RISKY_CHANGE_PATTERNS.some((pattern) => pattern.test(path));\n\t}\n\n\tprivate startFlushTimer(): void {\n\t\t// Flush signals every 30 seconds\n\t\tthis.flushTimer = setInterval(() => {\n\t\t\tthis.flushSignals().catch(() => {\n\t\t\t\t// Ignore flush errors\n\t\t\t});\n\t\t}, 30000);\n\t}\n\n\tprivate async flushSignals(): Promise<void> {\n\t\tif (this.signalBuffer.length === 0) return;\n\n\t\tconst signals = [...this.signalBuffer];\n\t\tthis.signalBuffer = [];\n\n\t\tfor (const signal of signals) {\n\t\t\tawait appendSnapbackJsonl(\"learnings/behavioral-signals.jsonl\", signal, this.config.workspaceRoot);\n\t\t\tthis.stats.signalsRecorded++;\n\t\t}\n\t}\n\n\tprivate getWatchedCount(): number {\n\t\tif (!this.watcher) return 0;\n\t\tconst watched = this.watcher.getWatched();\n\t\treturn Object.values(watched).reduce((acc, files) => acc + files.length, 0);\n\t}\n\n\tprivate log(message: string, isError = false): void {\n\t\tif (this.config.verbose) {\n\t\t\tconst prefix = \"[SnapBack Watch]\";\n\t\t\tif (isError) {\n\t\t\t\tconsole.error(`${prefix} ${message}`);\n\t\t\t} else {\n\t\t\t\tconsole.log(`${prefix} ${message}`);\n\t\t\t}\n\t\t}\n\t}\n}\n\n// =============================================================================\n// FACTORY FUNCTION\n// =============================================================================\n\n/**\n * Create a watcher for a workspace\n */\nexport function createWatcher(config: WatcherConfig): SnapbackWatcher {\n\treturn new SnapbackWatcher(config);\n}\n\n// =============================================================================\n// BEHAVIORAL LEARNING HELPERS\n// =============================================================================\n\n/**\n * Get behavioral signals from a workspace\n */\nexport async function getBehavioralSignals(workspaceRoot?: string): Promise<BehavioralSignal[]> {\n\treturn loadSnapbackJsonl<BehavioralSignal>(\"learnings/behavioral-signals.jsonl\", workspaceRoot);\n}\n\n/**\n * Analyze behavioral signals and generate learnings\n */\nexport async function analyzeBehavioralSignals(workspaceRoot?: string): Promise<LearningEntry[]> {\n\tconst signals = await getBehavioralSignals(workspaceRoot);\n\n\tif (signals.length === 0) return [];\n\n\t// Count changes by file\n\tconst fileCounts = new Map<string, number>();\n\tfor (const signal of signals) {\n\t\tif (signal.type === \"file_change\") {\n\t\t\tfileCounts.set(signal.path, (fileCounts.get(signal.path) || 0) + 1);\n\t\t}\n\t}\n\n\tconst learnings: LearningEntry[] = [];\n\n\t// Generate learnings for frequently changed files\n\tfor (const [path, count] of fileCounts) {\n\t\tif (count >= 10) {\n\t\t\tlearnings.push({\n\t\t\t\tid: `behavioral_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`,\n\t\t\t\ttype: \"pattern\",\n\t\t\t\ttrigger: `editing ${basename(path)}`,\n\t\t\t\taction: `This file is frequently modified (${count}x). Consider adding protection.`,\n\t\t\t\tsource: \"behavioral-analysis\",\n\t\t\t\tcreatedAt: new Date().toISOString(),\n\t\t\t});\n\t\t}\n\t}\n\n\treturn learnings;\n}\n","/**\n * Watch Command\n *\n * Implements snap watch - Continuous file watching daemon for behavioral learning.\n *\n * Usage:\n *   snap watch              # Start watching (foreground)\n *   snap watch --verbose    # With detailed logging\n *   snap watch stop         # Not implemented yet (uses Ctrl+C)\n *   snap watch status       # Show watcher status\n *\n * @see implementation_plan.md - behavioral learning\n * @see the_vision.md - \"learnFromBehavior\" concept\n */\n\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport { isSnapbackInitialized } from \"../services/snapback-dir\";\nimport { analyzeBehavioralSignals, createWatcher, getBehavioralSignals, type WatcherStats } from \"../services/watcher\";\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the watch command\n */\nexport function createWatchCommand(): Command {\n\tconst watch = new Command(\"watch\")\n\t\t.description(\"Start file watcher for behavioral learning\")\n\t\t.option(\"-v, --verbose\", \"Enable verbose logging\")\n\t\t.option(\"--depth <number>\", \"Max directory depth\", \"10\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// Check if initialized\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized in this workspace\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"SnapBack Watch\"));\n\t\t\t\tconsole.log(chalk.gray(\"Continuous behavioral learning daemon\"));\n\t\t\t\tconsole.log();\n\n\t\t\t\t// Create watcher\n\t\t\t\tconst watcher = createWatcher({\n\t\t\t\t\tworkspaceRoot: cwd,\n\t\t\t\t\tverbose: options.verbose,\n\t\t\t\t\tdepth: Number.parseInt(options.depth, 10),\n\t\t\t\t});\n\n\t\t\t\t// Set up event handlers\n\t\t\t\twatcher.on(\"ready\", (stats: WatcherStats) => {\n\t\t\t\t\tconsole.log(chalk.green(\"\"), `Watching ${stats.filesWatched} files`);\n\t\t\t\t\tconsole.log(chalk.gray(\"  Press Ctrl+C to stop\"));\n\t\t\t\t\tconsole.log();\n\t\t\t\t});\n\n\t\t\t\twatcher.on(\n\t\t\t\t\t\"change\",\n\t\t\t\t\t(path: string, meta: { isCritical: boolean; isRisky: boolean; changeCount: number }) => {\n\t\t\t\t\t\tconst icon = meta.isCritical\n\t\t\t\t\t\t\t? chalk.red(\"\")\n\t\t\t\t\t\t\t: meta.isRisky\n\t\t\t\t\t\t\t\t? chalk.yellow(\"\")\n\t\t\t\t\t\t\t\t: chalk.blue(\"\");\n\t\t\t\t\t\tconsole.log(`${icon} ${chalk.dim(\"changed:\")} ${path}`);\n\n\t\t\t\t\t\tif (meta.isCritical && meta.changeCount === 1) {\n\t\t\t\t\t\t\tconsole.log(chalk.yellow(`   Consider: snap protect add \"${path}\"`));\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t);\n\n\t\t\t\twatcher.on(\"add\", (path: string) => {\n\t\t\t\t\tconsole.log(`${chalk.green(\"+\")} ${chalk.dim(\"added:\")} ${path}`);\n\t\t\t\t});\n\n\t\t\t\twatcher.on(\"unlink\", (path: string) => {\n\t\t\t\t\tconsole.log(`${chalk.red(\"-\")} ${chalk.dim(\"deleted:\")} ${path}`);\n\t\t\t\t});\n\n\t\t\t\twatcher.on(\"signal\", (signal: { path: string; suggestion?: string }) => {\n\t\t\t\t\tif (signal.suggestion) {\n\t\t\t\t\t\tconsole.log(chalk.yellow(\"\"), signal.suggestion);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\twatcher.on(\"pattern\", (pattern: { type: string; message: string }) => {\n\t\t\t\t\tif (pattern.type === \"PROMOTION_READY\") {\n\t\t\t\t\t\tconsole.log(chalk.magenta(\"\"), pattern.message);\n\t\t\t\t\t\tconsole.log(chalk.gray(\"   Run: snap patterns promote\"));\n\t\t\t\t\t} else if (pattern.type === \"FREQUENTLY_CHANGED\") {\n\t\t\t\t\t\tconsole.log(chalk.yellow(\"\"), pattern.message);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\twatcher.on(\"error\", (error: Error) => {\n\t\t\t\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t\t\t\t});\n\n\t\t\t\t// Handle graceful shutdown\n\t\t\t\tconst shutdown = async () => {\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(chalk.gray(\"Stopping watcher...\"));\n\t\t\t\t\tawait watcher.stop();\n\n\t\t\t\t\tconst stats = watcher.getStats();\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(chalk.cyan(\"Session Summary:\"));\n\t\t\t\t\tconsole.log(`  Signals recorded: ${stats.signalsRecorded}`);\n\t\t\t\t\tconsole.log(`  Patterns detected: ${stats.patternsDetected}`);\n\n\t\t\t\t\tif (stats.signalsRecorded > 0) {\n\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t\tconsole.log(chalk.gray(\"Analyze with: snap watch analyze\"));\n\t\t\t\t\t}\n\n\t\t\t\t\tprocess.exit(0);\n\t\t\t\t};\n\n\t\t\t\tprocess.on(\"SIGINT\", shutdown);\n\t\t\t\tprocess.on(\"SIGTERM\", shutdown);\n\n\t\t\t\t// Start watching\n\t\t\t\tawait watcher.start();\n\n\t\t\t\t// Keep process alive\n\t\t\t\tawait new Promise(() => {});\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Add status subcommand\n\twatch\n\t\t.command(\"status\")\n\t\t.description(\"Show watcher statistics\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst signals = await getBehavioralSignals(cwd);\n\n\t\t\t\t// Compute stats\n\t\t\t\tconst stats = {\n\t\t\t\t\ttotalSignals: signals.length,\n\t\t\t\t\tbyType: {} as Record<string, number>,\n\t\t\t\t\tmostChanged: [] as { path: string; count: number }[],\n\t\t\t\t\tcriticalChanges: 0,\n\t\t\t\t};\n\n\t\t\t\tconst fileCounts = new Map<string, number>();\n\n\t\t\t\tfor (const signal of signals) {\n\t\t\t\t\tstats.byType[signal.type] = (stats.byType[signal.type] || 0) + 1;\n\n\t\t\t\t\tif (signal.type === \"file_change\") {\n\t\t\t\t\t\tfileCounts.set(signal.path, (fileCounts.get(signal.path) || 0) + 1);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (signal.metadata?.critical) {\n\t\t\t\t\t\tstats.criticalChanges++;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Top 5 most changed\n\t\t\t\tstats.mostChanged = [...fileCounts.entries()]\n\t\t\t\t\t.sort((a, b) => b[1] - a[1])\n\t\t\t\t\t.slice(0, 5)\n\t\t\t\t\t.map(([path, count]) => ({ path, count }));\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(stats, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"Watcher Statistics:\"));\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(`  Total signals:     ${stats.totalSignals}`);\n\t\t\t\tconsole.log(`  Critical changes:  ${stats.criticalChanges}`);\n\t\t\t\tconsole.log();\n\n\t\t\t\tif (Object.keys(stats.byType).length > 0) {\n\t\t\t\t\tconsole.log(chalk.gray(\"By Type:\"));\n\t\t\t\t\tfor (const [type, count] of Object.entries(stats.byType)) {\n\t\t\t\t\t\tconsole.log(`  ${type}: ${count}`);\n\t\t\t\t\t}\n\t\t\t\t\tconsole.log();\n\t\t\t\t}\n\n\t\t\t\tif (stats.mostChanged.length > 0) {\n\t\t\t\t\tconsole.log(chalk.gray(\"Most Changed Files:\"));\n\t\t\t\t\tfor (const { path, count } of stats.mostChanged) {\n\t\t\t\t\t\tconsole.log(`  ${count}x  ${path}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (stats.totalSignals === 0) {\n\t\t\t\t\tconsole.log(chalk.gray(\"No behavioral data yet.\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Start watching: snap watch\"));\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Add analyze subcommand\n\twatch\n\t\t.command(\"analyze\")\n\t\t.description(\"Analyze behavioral signals and generate learnings\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"SnapBack not initialized\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tconst learnings = await analyzeBehavioralSignals(cwd);\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(learnings, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (learnings.length === 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No actionable patterns detected yet.\"));\n\t\t\t\t\tconsole.log(chalk.gray(\"Continue using snap watch to collect more data.\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(`Behavioral Insights (${learnings.length}):`));\n\t\t\t\tconsole.log();\n\n\t\t\t\tfor (const learning of learnings) {\n\t\t\t\t\tconsole.log(chalk.bold(` ${learning.trigger}`));\n\t\t\t\t\tconsole.log(`   ${learning.action}`);\n\t\t\t\t\tconsole.log();\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.gray('Record as learning: snap learn \"trigger\" \"action\"'));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn watch;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { createWatchCommand as default };\n","/**\n * CommitRiskSystem - Research-Aligned Risk Scoring for Commit Prompts\n *\n * Implements a continuous RiskScore  [0, 1.5+] that drives:\n * - Whether to suggest a commit\n * - Whether to create a snapshot\n *\n * Based on 2026 research:\n * - Time and Lines  proxy for batch size / PR size (reviewability, defect detection)\n * - Files  cross-cutting surface area (architectural risk)\n * - AI  risk amplifier when suggestions are heavy\n * - Churn  historic \"this user tends to rewrite code soon\" (aggregating junk danger)\n * - Phase  critical vs feature vs refactor vs exploratory (different baselines)\n *\n * @packageDocumentation\n */\n\nimport type { DevelopmentPhase } from \"./learning/PhaseDetector.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Phase types mapped to commit risk (aligned with PhaseDetector)\n */\nexport type CommitPhase = \"critical\" | \"feature\" | \"refactor\" | \"exploratory\";\n\n/**\n * Maps DevelopmentPhase to CommitPhase\n */\nexport function mapToCommitPhase(phase: DevelopmentPhase): CommitPhase {\n\tswitch (phase) {\n\t\tcase \"hotfix\":\n\t\tcase \"release\":\n\t\t\treturn \"critical\";\n\t\tcase \"feature\":\n\t\tcase \"unknown\":\n\t\t\treturn \"feature\";\n\t\tcase \"refactor\":\n\t\t\treturn \"refactor\";\n\t\tcase \"exploratory\":\n\t\t\treturn \"exploratory\";\n\t}\n}\n\n/**\n * Risk evaluation context\n */\nexport interface RiskContext {\n\t/** Minutes since last git commit */\n\tminutesSinceCommit: number;\n\t/** Lines changed since last commit */\n\tlinesChanged: number;\n\t/** Files touched since last commit */\n\tfilesChanged: number;\n\t/** Fraction of lines from AI (0-1) */\n\taiFraction: number;\n\t/** Local churn percent (0-100) - % of lines re-touched within 2 weeks */\n\tchurnPercent: number;\n\t/** Current development phase */\n\tphase: CommitPhase;\n\t/** Current timestamp */\n\tnow: number;\n}\n\n/**\n * Risk score breakdown\n */\nexport interface RiskBreakdown {\n\t/** Time-based risk (0-1) */\n\ttimeRisk: number;\n\t/** Lines-based risk (0-1) */\n\tlinesRisk: number;\n\t/** Files-based risk (0-1) */\n\tfilesRisk: number;\n\t/** AI contribution risk (0-1) */\n\taiRisk: number;\n\t/** Churn history risk (0-1) */\n\tchurnRisk: number;\n\t/** Raw score before phase adjustment */\n\trawScore: number;\n\t/** Phase multiplier applied */\n\tphaseMultiplier: number;\n\t/** Final risk score (0-1.5+) */\n\tfinalScore: number;\n}\n\n/**\n * Action recommended based on risk score\n */\nexport type RiskAction = \"none\" | \"auto_snapshot\" | \"suggest_commit\" | \"strong_commit\";\n\n/**\n * UI escalation level for commit prompts\n */\nexport type EscalationLevel = \"none\" | \"status_bar\" | \"notification\" | \"modal\";\n\n/**\n * Risk evaluation result\n */\nexport interface RiskEvaluation {\n\t/** Final risk score (0-1.5+) */\n\tscore: number;\n\t/** Breakdown of contributing factors */\n\tbreakdown: RiskBreakdown;\n\t/** Recommended action */\n\taction: RiskAction;\n\t/** UI escalation level */\n\tescalation: EscalationLevel;\n\t/** Human-readable reason */\n\treason: string;\n\t/** Educational message for the user */\n\teducational?: string;\n\t/** Context that was evaluated */\n\tcontext: RiskContext;\n}\n\n/**\n * User tuning configuration\n */\nexport interface UserTuning {\n\t/** Multiplies all thresholds (0.8-1.2) */\n\tthresholdScale: number;\n\t/** Multiplies prompt cooldown (0.5-2.0) */\n\tpromptCooldownScale: number;\n\t/** Multiplies snapshot cooldown (0.5-2.0) */\n\tsnapshotCooldownScale: number;\n}\n\n/**\n * Outcome tracking for self-tuning\n */\nexport interface SessionOutcome {\n\t/** Unique session ID */\n\tsessionId: string;\n\t/** Peak risk score before commit */\n\tmaxRiskScore: number;\n\t/** Lines at time of commit */\n\tlinesAtCommit: number;\n\t/** Files at time of commit */\n\tfilesAtCommit: number;\n\t/** AI contribution fraction */\n\taiFraction: number;\n\t/** Churn percent */\n\tchurnPercent: number;\n\t/** Phase during session */\n\tphase: CommitPhase;\n\t/** Had revert within 2 weeks */\n\thadRevertWithin2Weeks: boolean;\n\t/** Had bug fix within 2 weeks */\n\thadBugFixWithin2Weeks: boolean;\n\t/** PR size when created */\n\tprSizeLines?: number;\n\t/** PR review time in minutes */\n\tprReviewTimeMin?: number;\n\t/** PR comments count */\n\tprCommentsCount?: number;\n\t/** Timestamp of outcome recording */\n\ttimestamp: number;\n}\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Default weight configuration - normalized to ~1.0 */\nconst DEFAULT_WEIGHTS = {\n\twT: 0.3, // time since last commit\n\twL: 0.25, // lines changed\n\twF: 0.15, // files touched\n\twA: 0.2, // AI contribution\n\twC: 0.1, // local churn history\n};\n\n/** Phase-aware time baselines (minutes) */\nconst PHASE_BASELINES: Record<CommitPhase, number> = {\n\tcritical: 15, // commit every 10-15 min\n\tfeature: 30, // commit every 15-30 min\n\trefactor: 60, // commit every 45-75 min\n\texploratory: 120, // commit every 2-3 hours\n};\n\n/** Phase-aware hard caps (minutes) */\nconst PHASE_HARD_CAPS: Record<CommitPhase, number> = {\n\tcritical: 45,\n\tfeature: 90,\n\trefactor: 120,\n\texploratory: 240,\n};\n\n/** Phase multipliers for risk adjustment */\nconst PHASE_MULTIPLIERS: Record<CommitPhase, number> = {\n\tcritical: 1.4,\n\tfeature: 1.0,\n\trefactor: 1.1,\n\texploratory: 0.8,\n};\n\n/** Action thresholds */\nconst DEFAULT_THRESHOLDS = {\n\tautoSnapshot: 0.35, // snapshot only\n\tsuggestCommit: 0.55, // nudge to commit\n\tstrongCommit: 0.8, // assertive prompt\n};\n\n/** Cooldown timers (ms) */\nconst DEFAULT_COOLDOWNS = {\n\tminSnapshotInterval: 5 * 60 * 1000, // 5 minutes\n\tminPromptInterval: 10 * 60 * 1000, // 10 minutes\n};\n\n/** Hysteresis bands for threshold crossings */\nconst HYSTERESIS = {\n\tsnapshotEnter: 0.35,\n\tsnapshotExit: 0.25,\n\tpromptEnter: 0.55,\n\tpromptExit: 0.45,\n\tstrongEnter: 0.8,\n\tstrongExit: 0.7,\n};\n\n/** Default user tuning */\nconst DEFAULT_USER_TUNING: UserTuning = {\n\tthresholdScale: 1.0,\n\tpromptCooldownScale: 1.0,\n\tsnapshotCooldownScale: 1.0,\n};\n\n/** Weight bounds for optimization */\nconst WEIGHT_BOUNDS = {\n\tmin: 0.05, // No weight goes below 5%\n\tmax: 0.5, // No weight exceeds 50%\n\tstepSize: 0.02, // Hill-climbing step size\n};\n\n/** PR metrics thresholds for quality prediction */\nconst PR_METRICS_THRESHOLDS = {\n\t/** PR review time above this (minutes) indicates quality issues */\n\treviewTimeDanger: 120,\n\t/** PR comments above this indicates complexity/issues */\n\tcommentsDanger: 15,\n\t/** Minimum PRs needed for weight adjustment */\n\tminPRsForAdjustment: 10,\n};\n\n// =============================================================================\n// SUB-SCORE COMPUTATIONS (normalized 0-1)\n// =============================================================================\n\n/**\n * Compute time-based risk (phase-aware)\n * Uses smooth curve that ramps steeply near cap\n */\nfunction computeTimeRisk(minutesSinceCommit: number, phase: CommitPhase): number {\n\tconst base = PHASE_BASELINES[phase];\n\tconst cap = PHASE_HARD_CAPS[phase];\n\n\tif (minutesSinceCommit <= base) {\n\t\treturn 0;\n\t}\n\n\tconst over = minutesSinceCommit - base;\n\tconst range = Math.max(cap - base, 1);\n\n\t// 0  1 as we move from base to cap, steeper near the top\n\tconst x = Math.min(over / range, 1);\n\tconst shaped = x ** 1.5;\n\n\treturn shaped;\n}\n\n/**\n * Compute lines-based risk\n * Based on PR size research: <200 low, 200-400 moderate, 400-1000 high, >1000 dangerous\n */\nfunction computeLinesRisk(linesChanged: number): number {\n\tif (linesChanged <= 50) {\n\t\treturn 0; // trivially small\n\t}\n\tif (linesChanged <= 200) {\n\t\t// gentle ramp 50-200  0-0.3\n\t\treturn 0.3 * ((linesChanged - 50) / 150);\n\t}\n\tif (linesChanged <= 400) {\n\t\t// 200-400  0.3-0.6\n\t\treturn 0.3 + 0.3 * ((linesChanged - 200) / 200);\n\t}\n\tif (linesChanged <= 1000) {\n\t\t// 400-1000  0.6-1.0 (steep)\n\t\treturn 0.6 + 0.4 * ((linesChanged - 400) / 600);\n\t}\n\t// >1000 lines: hard cap at 1.0\n\treturn 1.0;\n}\n\n/**\n * Compute files-based risk\n * More files = more cross-cutting change = higher architectural risk\n */\nfunction computeFilesRisk(filesChanged: number): number {\n\tif (filesChanged <= 2) {\n\t\treturn 0;\n\t}\n\tif (filesChanged <= 6) {\n\t\t// 3-6 files: 0-0.6\n\t\treturn 0.6 * ((filesChanged - 2) / 4);\n\t}\n\t// 7+ files: cap at 1.0\n\treturn 1.0;\n}\n\n/**\n * Compute AI contribution risk\n * Higher AI fraction = higher risk of unreviewed/untested code\n */\nfunction computeAiRisk(aiFraction: number): number {\n\t// Below 20% AI, treat as low risk\n\tif (aiFraction <= 0.2) {\n\t\treturn 0;\n\t}\n\n\tconst x = (aiFraction - 0.2) / 0.8; // 0-1 when 20-100%\n\treturn Math.min(x ** 1.3, 1); // slightly convex\n}\n\n/**\n * Compute churn risk\n * Based on % of lines re-touched within 2 weeks\n */\nfunction computeChurnRisk(churnPercent: number): number {\n\t// 0-15%: 0-0.3\n\tif (churnPercent <= 15) {\n\t\treturn 0.3 * (churnPercent / 15);\n\t}\n\t// 15-30%: 0.3-0.7\n\tif (churnPercent <= 30) {\n\t\treturn 0.3 + 0.4 * ((churnPercent - 15) / 15);\n\t}\n\t// >30%: 0.7-1.0\n\tif (churnPercent >= 60) {\n\t\treturn 1.0;\n\t}\n\treturn 0.7 + 0.3 * ((churnPercent - 30) / 30);\n}\n\n// =============================================================================\n// COMMIT RISK SYSTEM\n// =============================================================================\n\n/**\n * CommitRiskSystem - Self-tuning risk evaluation for commit prompts\n *\n * @example\n * ```typescript\n * const riskSystem = new CommitRiskSystem();\n *\n * // Evaluate current risk\n * const evaluation = riskSystem.evaluate({\n *   minutesSinceCommit: 45,\n *   linesChanged: 250,\n *   filesChanged: 4,\n *   aiFraction: 0.35,\n *   churnPercent: 12,\n *   phase: 'feature',\n *   now: Date.now()\n * });\n *\n * if (evaluation.action === 'suggest_commit') {\n *   showCommitPrompt(evaluation.reason);\n * }\n * ```\n */\nexport class CommitRiskSystem {\n\tprivate weights = { ...DEFAULT_WEIGHTS };\n\tprivate thresholds = { ...DEFAULT_THRESHOLDS };\n\tprivate userTuning: UserTuning = { ...DEFAULT_USER_TUNING };\n\n\t// State tracking\n\tprivate lastSnapshotAt: number | null = null;\n\tprivate lastPromptAt: number | null = null;\n\tprivate isInSnapshotState = false;\n\tprivate isInPromptState = false;\n\tprivate isInStrongState = false;\n\n\t// Outcome tracking for self-tuning\n\tprivate outcomes: SessionOutcome[] = [];\n\tprivate readonly maxOutcomes = 500;\n\n\tconstructor(userTuning?: Partial<UserTuning>) {\n\t\tif (userTuning) {\n\t\t\tthis.userTuning = { ...DEFAULT_USER_TUNING, ...userTuning };\n\t\t}\n\t}\n\n\t/**\n\t * Evaluate risk and determine recommended action\n\t */\n\tevaluate(context: RiskContext): RiskEvaluation {\n\t\tconst breakdown = this.computeBreakdown(context);\n\t\tconst scaledThresholds = this.applyUserScaling();\n\n\t\t// Determine action with hysteresis\n\t\tconst { action, escalation } = this.determineAction(breakdown.finalScore, scaledThresholds, context.now);\n\n\t\t// Generate human-readable reason\n\t\tconst { reason, educational } = this.generateReason(breakdown, action, context);\n\n\t\treturn {\n\t\t\tscore: breakdown.finalScore,\n\t\t\tbreakdown,\n\t\t\taction,\n\t\t\tescalation,\n\t\t\treason,\n\t\t\teducational,\n\t\t\tcontext,\n\t\t};\n\t}\n\n\t/**\n\t * Check if action should be taken (respects cooldowns)\n\t */\n\tshouldAct(evaluation: RiskEvaluation): boolean {\n\t\tconst { action } = evaluation;\n\t\tconst now = evaluation.context.now;\n\t\tconst cooldowns = this.getScaledCooldowns();\n\n\t\tswitch (action) {\n\t\t\tcase \"none\":\n\t\t\t\treturn false;\n\t\t\tcase \"auto_snapshot\":\n\t\t\t\treturn this.lastSnapshotAt === null || now - this.lastSnapshotAt > cooldowns.minSnapshotInterval;\n\t\t\tcase \"suggest_commit\":\n\t\t\tcase \"strong_commit\":\n\t\t\t\treturn this.lastPromptAt === null || now - this.lastPromptAt > cooldowns.minPromptInterval;\n\t\t}\n\t}\n\n\t/**\n\t * Record that a snapshot was created\n\t */\n\trecordSnapshot(now: number = Date.now()): void {\n\t\tthis.lastSnapshotAt = now;\n\t}\n\n\t/**\n\t * Record that a prompt was shown\n\t */\n\trecordPrompt(now: number = Date.now()): void {\n\t\tthis.lastPromptAt = now;\n\t}\n\n\t/**\n\t * Record session outcome for self-tuning\n\t */\n\trecordOutcome(outcome: SessionOutcome): void {\n\t\tthis.outcomes.push(outcome);\n\t\tif (this.outcomes.length > this.maxOutcomes) {\n\t\t\tthis.outcomes.shift();\n\t\t}\n\t}\n\n\t/**\n\t * Get outcome statistics for calibration\n\t */\n\tgetOutcomeStats(): {\n\t\ttotalSessions: number;\n\t\tbadOutcomeRate: number;\n\t\tavgRiskAtBadOutcome: number;\n\t\tbucketStats: Map<string, { count: number; badRate: number }>;\n\t} {\n\t\tconst total = this.outcomes.length;\n\t\tif (total === 0) {\n\t\t\treturn {\n\t\t\t\ttotalSessions: 0,\n\t\t\t\tbadOutcomeRate: 0,\n\t\t\t\tavgRiskAtBadOutcome: 0,\n\t\t\t\tbucketStats: new Map(),\n\t\t\t};\n\t\t}\n\n\t\tconst badOutcomes = this.outcomes.filter((o) => o.hadRevertWithin2Weeks || o.hadBugFixWithin2Weeks);\n\t\tconst badOutcomeRate = badOutcomes.length / total;\n\t\tconst avgRiskAtBadOutcome =\n\t\t\tbadOutcomes.length > 0 ? badOutcomes.reduce((sum, o) => sum + o.maxRiskScore, 0) / badOutcomes.length : 0;\n\n\t\t// Bucket by risk score\n\t\tconst buckets = new Map<string, { total: number; bad: number }>();\n\t\t// Buckets: 0-0.3, 0.3-0.5, 0.5-0.7, 0.7-0.9, 0.9+\n\n\t\tfor (const outcome of this.outcomes) {\n\t\t\tconst score = outcome.maxRiskScore;\n\t\t\tlet bucket: string;\n\t\t\tif (score < 0.3) {\n\t\t\t\tbucket = \"0-0.3\";\n\t\t\t} else if (score < 0.5) {\n\t\t\t\tbucket = \"0.3-0.5\";\n\t\t\t} else if (score < 0.7) {\n\t\t\t\tbucket = \"0.5-0.7\";\n\t\t\t} else if (score < 0.9) {\n\t\t\t\tbucket = \"0.7-0.9\";\n\t\t\t} else {\n\t\t\t\tbucket = \"0.9+\";\n\t\t\t}\n\n\t\t\tconst existing = buckets.get(bucket) ?? { total: 0, bad: 0 };\n\t\t\texisting.total++;\n\t\t\tif (outcome.hadRevertWithin2Weeks || outcome.hadBugFixWithin2Weeks) {\n\t\t\t\texisting.bad++;\n\t\t\t}\n\t\t\tbuckets.set(bucket, existing);\n\t\t}\n\n\t\tconst bucketStats = new Map<string, { count: number; badRate: number }>();\n\t\tfor (const [bucket, stats] of buckets) {\n\t\t\tbucketStats.set(bucket, {\n\t\t\t\tcount: stats.total,\n\t\t\t\tbadRate: stats.total > 0 ? stats.bad / stats.total : 0,\n\t\t\t});\n\t\t}\n\n\t\treturn {\n\t\t\ttotalSessions: total,\n\t\t\tbadOutcomeRate,\n\t\t\tavgRiskAtBadOutcome,\n\t\t\tbucketStats,\n\t\t};\n\t}\n\n\t/**\n\t * Recalibrate thresholds based on outcomes\n\t * Call periodically (e.g., weekly)\n\t */\n\trecalibrate(targetBadOutcomeRate = 0.15): { adjusted: boolean; changes: string[] } {\n\t\tconst stats = this.getOutcomeStats();\n\t\tconst changes: string[] = [];\n\n\t\tif (stats.totalSessions < 20) {\n\t\t\treturn { adjusted: false, changes: [\"Insufficient data for calibration (need 20+ sessions)\"] };\n\t\t}\n\n\t\t// Check if bad outcomes cluster below suggestCommit threshold\n\t\tconst belowThreshold = this.outcomes.filter((o) => o.maxRiskScore < this.thresholds.suggestCommit);\n\t\tconst badBelowThreshold = belowThreshold.filter((o) => o.hadRevertWithin2Weeks || o.hadBugFixWithin2Weeks);\n\t\tconst badRateBelowThreshold = belowThreshold.length > 0 ? badBelowThreshold.length / belowThreshold.length : 0;\n\n\t\t// Adjust thresholds based on outcome distribution\n\t\tif (badRateBelowThreshold > targetBadOutcomeRate) {\n\t\t\t// Lower thresholds - be more sensitive\n\t\t\tthis.thresholds.suggestCommit = Math.max(0.3, this.thresholds.suggestCommit - 0.05);\n\t\t\tthis.thresholds.autoSnapshot = Math.max(0.2, this.thresholds.autoSnapshot - 0.05);\n\t\t\tchanges.push(`Lowered thresholds (bad rate below threshold: ${(badRateBelowThreshold * 100).toFixed(1)}%)`);\n\t\t} else if (badRateBelowThreshold < targetBadOutcomeRate / 2) {\n\t\t\t// Raise thresholds - less sensitive\n\t\t\tthis.thresholds.suggestCommit = Math.min(0.7, this.thresholds.suggestCommit + 0.05);\n\t\t\tthis.thresholds.autoSnapshot = Math.min(0.5, this.thresholds.autoSnapshot + 0.05);\n\t\t\tchanges.push(`Raised thresholds (bad rate below threshold: ${(badRateBelowThreshold * 100).toFixed(1)}%)`);\n\t\t}\n\n\t\treturn { adjusted: changes.length > 0, changes };\n\t}\n\n\t/**\n\t * Optimize weights using hill-climbing based on predictive power\n\t *\n\t * Analyzes which factors (time, lines, files, AI, churn) best predict\n\t * bad outcomes and adjusts weights accordingly.\n\t *\n\t * @returns Optimization result with changes made\n\t */\n\toptimizeWeights(): {\n\t\toptimized: boolean;\n\t\tchanges: string[];\n\t\tfactorCorrelations: Record<string, number>;\n\t} {\n\t\tconst changes: string[] = [];\n\n\t\tif (this.outcomes.length < 30) {\n\t\t\treturn {\n\t\t\t\toptimized: false,\n\t\t\t\tchanges: [\"Insufficient data for weight optimization (need 30+ sessions)\"],\n\t\t\t\tfactorCorrelations: {},\n\t\t\t};\n\t\t}\n\n\t\t// Calculate correlation between each factor and bad outcomes\n\t\tconst correlations = this.calculateFactorCorrelations();\n\n\t\t// Normalize correlations to get relative importance\n\t\tconst totalCorrelation = Object.values(correlations).reduce((sum, c) => sum + Math.abs(c), 0);\n\t\tif (totalCorrelation === 0) {\n\t\t\treturn {\n\t\t\t\toptimized: false,\n\t\t\t\tchanges: [\"No correlation between factors and outcomes\"],\n\t\t\t\tfactorCorrelations: correlations,\n\t\t\t};\n\t\t}\n\n\t\t// Hill-climbing: adjust weights toward factors with higher predictive power\n\t\tconst factorKeys: Array<keyof typeof this.weights> = [\"wT\", \"wL\", \"wF\", \"wA\", \"wC\"];\n\t\tconst correlationMap: Record<keyof typeof this.weights, number> = {\n\t\t\twT: correlations.time,\n\t\t\twL: correlations.lines,\n\t\t\twF: correlations.files,\n\t\t\twA: correlations.ai,\n\t\t\twC: correlations.churn,\n\t\t};\n\n\t\t// Calculate target weights based on correlation strength\n\t\tconst targetWeights: Record<keyof typeof this.weights, number> = { wT: 0, wL: 0, wF: 0, wA: 0, wC: 0 };\n\t\tfor (const key of factorKeys) {\n\t\t\t// Use absolute correlation - both high positive and negative correlations are informative\n\t\t\ttargetWeights[key] = Math.abs(correlationMap[key]) / totalCorrelation;\n\t\t\t// Clamp to bounds\n\t\t\ttargetWeights[key] = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, targetWeights[key]));\n\t\t}\n\n\t\t// Normalize target weights to sum to ~1\n\t\tconst targetSum = Object.values(targetWeights).reduce((sum, w) => sum + w, 0);\n\t\tfor (const key of factorKeys) {\n\t\t\ttargetWeights[key] = targetWeights[key] / targetSum;\n\t\t}\n\n\t\t// Apply hill-climbing step toward target\n\t\tlet adjusted = false;\n\t\tfor (const key of factorKeys) {\n\t\t\tconst current = this.weights[key];\n\t\t\tconst target = targetWeights[key];\n\t\t\tconst diff = target - current;\n\n\t\t\tif (Math.abs(diff) > WEIGHT_BOUNDS.stepSize / 2) {\n\t\t\t\tconst step = diff > 0 ? WEIGHT_BOUNDS.stepSize : -WEIGHT_BOUNDS.stepSize;\n\t\t\t\tconst newWeight = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, current + step));\n\n\t\t\t\tif (newWeight !== current) {\n\t\t\t\t\tconst factorName = this.getFactorName(key);\n\t\t\t\t\tchanges.push(`Adjusted ${factorName} weight: ${current.toFixed(2)}  ${newWeight.toFixed(2)}`);\n\t\t\t\t\tthis.weights[key] = newWeight;\n\t\t\t\t\tadjusted = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Re-normalize weights to sum to 1\n\t\tif (adjusted) {\n\t\t\tthis.normalizeWeights();\n\t\t}\n\n\t\treturn {\n\t\t\toptimized: adjusted,\n\t\t\tchanges: changes.length > 0 ? changes : [\"Weights already optimal for current data\"],\n\t\t\tfactorCorrelations: correlations,\n\t\t};\n\t}\n\n\t/**\n\t * Recalibrate using PR metrics (review time and comments count)\n\t *\n\t * PRs with long review times or many comments indicate the commit\n\t * was too large or complex. Use this signal to adjust sensitivity.\n\t *\n\t * @returns Calibration result with changes\n\t */\n\trecalibrateWithPRMetrics(): {\n\t\tadjusted: boolean;\n\t\tchanges: string[];\n\t\tprAnalysis: {\n\t\t\ttotalPRs: number;\n\t\t\tavgReviewTime: number;\n\t\t\tavgComments: number;\n\t\t\tproblematicPRRate: number;\n\t\t};\n\t} {\n\t\tconst changes: string[] = [];\n\n\t\t// Filter outcomes with PR metrics\n\t\tconst outcomesWithPR = this.outcomes.filter(\n\t\t\t(o) => o.prReviewTimeMin !== undefined || o.prCommentsCount !== undefined,\n\t\t);\n\n\t\tif (outcomesWithPR.length < PR_METRICS_THRESHOLDS.minPRsForAdjustment) {\n\t\t\treturn {\n\t\t\t\tadjusted: false,\n\t\t\t\tchanges: [\n\t\t\t\t\t`Insufficient PR data (have ${outcomesWithPR.length}, need ${PR_METRICS_THRESHOLDS.minPRsForAdjustment})`,\n\t\t\t\t],\n\t\t\t\tprAnalysis: {\n\t\t\t\t\ttotalPRs: outcomesWithPR.length,\n\t\t\t\t\tavgReviewTime: 0,\n\t\t\t\t\tavgComments: 0,\n\t\t\t\t\tproblematicPRRate: 0,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Calculate PR metrics - pre-filter to avoid redundant iterations\n\t\tconst outcomesWithReviewTime = outcomesWithPR.filter((o) => o.prReviewTimeMin !== undefined);\n\t\tconst outcomesWithComments = outcomesWithPR.filter((o) => o.prCommentsCount !== undefined);\n\n\t\tconst avgReviewTime =\n\t\t\toutcomesWithReviewTime.length > 0\n\t\t\t\t? outcomesWithReviewTime.reduce((sum, o) => sum + (o.prReviewTimeMin ?? 0), 0) /\n\t\t\t\t\toutcomesWithReviewTime.length\n\t\t\t\t: 0;\n\n\t\tconst avgComments =\n\t\t\toutcomesWithComments.length > 0\n\t\t\t\t? outcomesWithComments.reduce((sum, o) => sum + (o.prCommentsCount ?? 0), 0) /\n\t\t\t\t\toutcomesWithComments.length\n\t\t\t\t: 0;\n\n\t\t// Identify problematic PRs (long review time OR many comments)\n\t\tconst problematicPRs = outcomesWithPR.filter(\n\t\t\t(o) =>\n\t\t\t\t(o.prReviewTimeMin ?? 0) > PR_METRICS_THRESHOLDS.reviewTimeDanger ||\n\t\t\t\t(o.prCommentsCount ?? 0) > PR_METRICS_THRESHOLDS.commentsDanger,\n\t\t);\n\t\tconst problematicRate = problematicPRs.length / outcomesWithPR.length;\n\n\t\t// Analyze correlation between risk score at commit and PR quality\n\t\tconst lowRiskProblematic = problematicPRs.filter((o) => o.maxRiskScore < this.thresholds.suggestCommit);\n\t\tconst lowRiskProblematicRate =\n\t\t\tproblematicPRs.length > 0 ? lowRiskProblematic.length / problematicPRs.length : 0;\n\n\t\t// If problematic PRs often came from low-risk sessions, lower thresholds\n\t\tif (problematicRate > 0.3 && lowRiskProblematicRate > 0.5) {\n\t\t\tthis.thresholds.suggestCommit = Math.max(0.3, this.thresholds.suggestCommit - 0.05);\n\t\t\tthis.thresholds.autoSnapshot = Math.max(0.2, this.thresholds.autoSnapshot - 0.05);\n\t\t\tchanges.push(\n\t\t\t\t`Lowered thresholds: ${(lowRiskProblematicRate * 100).toFixed(0)}% of problematic PRs came from low-risk sessions`,\n\t\t\t);\n\t\t}\n\n\t\t// If PRs are generally fine even at higher risk, relax thresholds\n\t\tif (problematicRate < 0.15 && avgReviewTime < PR_METRICS_THRESHOLDS.reviewTimeDanger / 2) {\n\t\t\tthis.thresholds.suggestCommit = Math.min(0.7, this.thresholds.suggestCommit + 0.03);\n\t\t\tchanges.push(`Raised thresholds: PR quality is good (${(problematicRate * 100).toFixed(0)}% problematic)`);\n\t\t}\n\n\t\t// Adjust lines weight based on PR size correlation\n\t\tconst largePRs = outcomesWithPR.filter((o) => (o.prSizeLines ?? 0) > 400);\n\t\tconst largePRProblematicRate =\n\t\t\tlargePRs.length > 0 ? largePRs.filter((o) => problematicPRs.includes(o)).length / largePRs.length : 0;\n\n\t\tif (largePRProblematicRate > 0.5 && this.weights.wL < WEIGHT_BOUNDS.max) {\n\t\t\tthis.weights.wL = Math.min(WEIGHT_BOUNDS.max, this.weights.wL + WEIGHT_BOUNDS.stepSize);\n\t\t\tthis.normalizeWeights();\n\t\t\tchanges.push(\n\t\t\t\t`Increased lines weight: ${(largePRProblematicRate * 100).toFixed(0)}% of large PRs were problematic`,\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tadjusted: changes.length > 0,\n\t\t\tchanges: changes.length > 0 ? changes : [\"PR metrics indicate current calibration is appropriate\"],\n\t\t\tprAnalysis: {\n\t\t\t\ttotalPRs: outcomesWithPR.length,\n\t\t\t\tavgReviewTime,\n\t\t\t\tavgComments,\n\t\t\t\tproblematicPRRate: problematicRate,\n\t\t\t},\n\t\t};\n\t}\n\n\t/**\n\t * Set thresholds directly (for cloud sync)\n\t *\n\t * Allows external systems to apply threshold adjustments.\n\t * Validates bounds before applying.\n\t */\n\tsetThresholds(thresholds: Partial<typeof DEFAULT_THRESHOLDS>): void {\n\t\tif (thresholds.autoSnapshot !== undefined) {\n\t\t\tthis.thresholds.autoSnapshot = Math.max(0.1, Math.min(0.6, thresholds.autoSnapshot));\n\t\t}\n\t\tif (thresholds.suggestCommit !== undefined) {\n\t\t\tthis.thresholds.suggestCommit = Math.max(0.2, Math.min(0.8, thresholds.suggestCommit));\n\t\t}\n\t\tif (thresholds.strongCommit !== undefined) {\n\t\t\tthis.thresholds.strongCommit = Math.max(0.5, Math.min(1.0, thresholds.strongCommit));\n\t\t}\n\t}\n\n\t/**\n\t * Get current weights (for persistence/display)\n\t */\n\tgetWeights(): typeof DEFAULT_WEIGHTS {\n\t\treturn { ...this.weights };\n\t}\n\n\t/**\n\t * Set weights directly (for persistence restoration)\n\t */\n\tsetWeights(weights: Partial<typeof DEFAULT_WEIGHTS>): void {\n\t\tif (weights.wT !== undefined) {\n\t\t\tthis.weights.wT = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, weights.wT));\n\t\t}\n\t\tif (weights.wL !== undefined) {\n\t\t\tthis.weights.wL = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, weights.wL));\n\t\t}\n\t\tif (weights.wF !== undefined) {\n\t\t\tthis.weights.wF = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, weights.wF));\n\t\t}\n\t\tif (weights.wA !== undefined) {\n\t\t\tthis.weights.wA = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, weights.wA));\n\t\t}\n\t\tif (weights.wC !== undefined) {\n\t\t\tthis.weights.wC = Math.max(WEIGHT_BOUNDS.min, Math.min(WEIGHT_BOUNDS.max, weights.wC));\n\t\t}\n\t\tthis.normalizeWeights();\n\t}\n\n\t/**\n\t * Update user tuning preferences\n\t */\n\tsetUserTuning(tuning: Partial<UserTuning>): void {\n\t\tthis.userTuning = {\n\t\t\t...this.userTuning,\n\t\t\t...tuning,\n\t\t\t// Enforce bounds\n\t\t\tthresholdScale: Math.max(0.8, Math.min(1.2, tuning.thresholdScale ?? this.userTuning.thresholdScale)),\n\t\t\tpromptCooldownScale: Math.max(\n\t\t\t\t0.5,\n\t\t\t\tMath.min(2.0, tuning.promptCooldownScale ?? this.userTuning.promptCooldownScale),\n\t\t\t),\n\t\t\tsnapshotCooldownScale: Math.max(\n\t\t\t\t0.5,\n\t\t\t\tMath.min(2.0, tuning.snapshotCooldownScale ?? this.userTuning.snapshotCooldownScale),\n\t\t\t),\n\t\t};\n\t}\n\n\t/**\n\t * Get current configuration (for debugging/display)\n\t */\n\tgetConfig(): {\n\t\tweights: typeof DEFAULT_WEIGHTS;\n\t\tthresholds: typeof DEFAULT_THRESHOLDS;\n\t\tuserTuning: UserTuning;\n\t\tscaledThresholds: typeof DEFAULT_THRESHOLDS;\n\t} {\n\t\treturn {\n\t\t\tweights: { ...this.weights },\n\t\t\tthresholds: { ...this.thresholds },\n\t\t\tuserTuning: { ...this.userTuning },\n\t\t\tscaledThresholds: this.applyUserScaling(),\n\t\t};\n\t}\n\n\t/**\n\t * Get all session outcomes for persistence\n\t * Used by external storage layer to save calibration data\n\t */\n\tgetOutcomes(): SessionOutcome[] {\n\t\treturn [...this.outcomes];\n\t}\n\n\t/**\n\t * Restore session outcomes from persistence\n\t * Used on initialization to restore self-tuning state\n\t */\n\tsetOutcomes(outcomes: SessionOutcome[]): void {\n\t\t// Validate and cap at maxOutcomes\n\t\tthis.outcomes = outcomes.slice(-this.maxOutcomes);\n\t}\n\n\t/**\n\t * Reset state (for testing or user reset)\n\t */\n\treset(): void {\n\t\tthis.lastSnapshotAt = null;\n\t\tthis.lastPromptAt = null;\n\t\tthis.isInSnapshotState = false;\n\t\tthis.isInPromptState = false;\n\t\tthis.isInStrongState = false;\n\t}\n\n\t// =========================================================================\n\t// INTERNAL\n\t// =========================================================================\n\n\tprivate computeBreakdown(context: RiskContext): RiskBreakdown {\n\t\tconst timeRisk = computeTimeRisk(context.minutesSinceCommit, context.phase);\n\t\tconst linesRisk = computeLinesRisk(context.linesChanged);\n\t\tconst filesRisk = computeFilesRisk(context.filesChanged);\n\t\tconst aiRisk = computeAiRisk(context.aiFraction);\n\t\tconst churnRisk = computeChurnRisk(context.churnPercent);\n\n\t\tconst rawScore =\n\t\t\tthis.weights.wT * timeRisk +\n\t\t\tthis.weights.wL * linesRisk +\n\t\t\tthis.weights.wF * filesRisk +\n\t\t\tthis.weights.wA * aiRisk +\n\t\t\tthis.weights.wC * churnRisk;\n\n\t\tconst phaseMultiplier = PHASE_MULTIPLIERS[context.phase];\n\t\tlet finalScore = rawScore * phaseMultiplier;\n\n\t\t// Clamp to 0-1.5 (allow >1 for extreme cases)\n\t\tfinalScore = Math.min(Math.max(finalScore, 0), 1.5);\n\n\t\treturn {\n\t\t\ttimeRisk,\n\t\t\tlinesRisk,\n\t\t\tfilesRisk,\n\t\t\taiRisk,\n\t\t\tchurnRisk,\n\t\t\trawScore,\n\t\t\tphaseMultiplier,\n\t\t\tfinalScore,\n\t\t};\n\t}\n\n\tprivate applyUserScaling(): typeof DEFAULT_THRESHOLDS {\n\t\tconst scale = this.userTuning.thresholdScale;\n\t\treturn {\n\t\t\tautoSnapshot: this.thresholds.autoSnapshot * scale,\n\t\t\tsuggestCommit: this.thresholds.suggestCommit * scale,\n\t\t\tstrongCommit: this.thresholds.strongCommit * scale,\n\t\t};\n\t}\n\n\tprivate getScaledCooldowns(): typeof DEFAULT_COOLDOWNS {\n\t\treturn {\n\t\t\tminSnapshotInterval: DEFAULT_COOLDOWNS.minSnapshotInterval * this.userTuning.snapshotCooldownScale,\n\t\t\tminPromptInterval: DEFAULT_COOLDOWNS.minPromptInterval * this.userTuning.promptCooldownScale,\n\t\t};\n\t}\n\n\tprivate determineAction(\n\t\tscore: number,\n\t\t_thresholds: typeof DEFAULT_THRESHOLDS,\n\t\t_now: number,\n\t): { action: RiskAction; escalation: EscalationLevel; enteredState: boolean } {\n\t\t// Apply hysteresis for threshold crossings\n\t\tlet action: RiskAction = \"none\";\n\t\tlet escalation: EscalationLevel = \"none\";\n\t\tlet enteredState = false;\n\n\t\t// Strong commit threshold\n\t\tif (score >= HYSTERESIS.strongEnter && !this.isInStrongState) {\n\t\t\tthis.isInStrongState = true;\n\t\t\tenteredState = true;\n\t\t} else if (score < HYSTERESIS.strongExit && this.isInStrongState) {\n\t\t\tthis.isInStrongState = false;\n\t\t}\n\n\t\t// Prompt threshold\n\t\tif (score >= HYSTERESIS.promptEnter && !this.isInPromptState) {\n\t\t\tthis.isInPromptState = true;\n\t\t\tenteredState = true;\n\t\t} else if (score < HYSTERESIS.promptExit && this.isInPromptState) {\n\t\t\tthis.isInPromptState = false;\n\t\t}\n\n\t\t// Snapshot threshold\n\t\tif (score >= HYSTERESIS.snapshotEnter && !this.isInSnapshotState) {\n\t\t\tthis.isInSnapshotState = true;\n\t\t\tenteredState = true;\n\t\t} else if (score < HYSTERESIS.snapshotExit && this.isInSnapshotState) {\n\t\t\tthis.isInSnapshotState = false;\n\t\t}\n\n\t\t// Determine action based on current state\n\t\tif (this.isInStrongState) {\n\t\t\taction = \"strong_commit\";\n\t\t\tescalation = \"modal\";\n\t\t} else if (this.isInPromptState) {\n\t\t\taction = \"suggest_commit\";\n\t\t\tescalation = \"notification\";\n\t\t} else if (this.isInSnapshotState) {\n\t\t\taction = \"auto_snapshot\";\n\t\t\tescalation = \"status_bar\";\n\t\t}\n\n\t\treturn { action, escalation, enteredState };\n\t}\n\n\tprivate generateReason(\n\t\tbreakdown: RiskBreakdown,\n\t\taction: RiskAction,\n\t\tcontext: RiskContext,\n\t): { reason: string; educational?: string } {\n\t\tconst { timeRisk, linesRisk, filesRisk, aiRisk, churnRisk, finalScore } = breakdown;\n\n\t\t// Find primary risk contributor\n\t\tconst risks = [\n\t\t\t{ name: \"time\", value: timeRisk * this.weights.wT },\n\t\t\t{ name: \"lines\", value: linesRisk * this.weights.wL },\n\t\t\t{ name: \"files\", value: filesRisk * this.weights.wF },\n\t\t\t{ name: \"ai\", value: aiRisk * this.weights.wA },\n\t\t\t{ name: \"churn\", value: churnRisk * this.weights.wC },\n\t\t].sort((a, b) => b.value - a.value);\n\n\t\tconst primary = risks[0];\n\n\t\tlet reason: string;\n\t\tlet educational: string | undefined;\n\n\t\tswitch (action) {\n\t\t\tcase \"strong_commit\":\n\t\t\t\treason = `High risk (${(finalScore * 100).toFixed(0)}%) - commit strongly recommended`;\n\t\t\t\teducational = `Your ${primary.name} risk is high. Research shows commits at this level have 3x higher defect rates.`;\n\t\t\t\tbreak;\n\t\t\tcase \"suggest_commit\":\n\t\t\t\treason = `Moderate risk (${(finalScore * 100).toFixed(0)}%) - consider committing`;\n\t\t\t\teducational =\n\t\t\t\t\tprimary.name === \"time\"\n\t\t\t\t\t\t? `You've been working ${context.minutesSinceCommit} minutes without a commit. Smaller, frequent commits improve code review quality.`\n\t\t\t\t\t\t: primary.name === \"lines\"\n\t\t\t\t\t\t\t? `${context.linesChanged} lines changed. PRs over 400 lines have 40% lower review effectiveness.`\n\t\t\t\t\t\t\t: primary.name === \"ai\"\n\t\t\t\t\t\t\t\t? `${(context.aiFraction * 100).toFixed(0)}% AI-generated code. Consider reviewing and committing before more AI additions.`\n\t\t\t\t\t\t\t\t: \"Consider committing to reduce accumulated risk.\";\n\t\t\t\tbreak;\n\t\t\tcase \"auto_snapshot\":\n\t\t\t\treason = `Low-moderate risk (${(finalScore * 100).toFixed(0)}%) - snapshot created`;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treason = `Session health good (${(finalScore * 100).toFixed(0)}%)`;\n\t\t}\n\n\t\treturn { reason, educational };\n\t}\n\n\t/**\n\t * Calculate correlation between each factor and bad outcomes\n\t * Uses point-biserial correlation approximation\n\t */\n\tprivate calculateFactorCorrelations(): Record<string, number> {\n\t\tconst badOutcomes = this.outcomes.filter((o) => o.hadRevertWithin2Weeks || o.hadBugFixWithin2Weeks);\n\t\tconst goodOutcomes = this.outcomes.filter((o) => !o.hadRevertWithin2Weeks && !o.hadBugFixWithin2Weeks);\n\n\t\tif (badOutcomes.length === 0 || goodOutcomes.length === 0) {\n\t\t\treturn { time: 0, lines: 0, files: 0, ai: 0, churn: 0 };\n\t\t}\n\n\t\t// For each factor, calculate mean difference between bad and good outcomes\n\t\t// Higher mean in bad outcomes = positive correlation with bad outcomes\n\t\tconst calcCorrelation = (extract: (o: SessionOutcome) => number, normalize: (v: number) => number): number => {\n\t\t\tconst badMean = badOutcomes.reduce((sum, o) => sum + normalize(extract(o)), 0) / badOutcomes.length;\n\t\t\tconst goodMean = goodOutcomes.reduce((sum, o) => sum + normalize(extract(o)), 0) / goodOutcomes.length;\n\n\t\t\t// Simple difference as correlation proxy (positive = factor predicts bad outcomes)\n\t\t\treturn badMean - goodMean;\n\t\t};\n\n\t\treturn {\n\t\t\ttime: calcCorrelation(\n\t\t\t\t(o) => {\n\t\t\t\t\t// Estimate time risk from session data - use lines as proxy for session length\n\t\t\t\t\treturn o.linesAtCommit / 10; // Rough approximation of minutes\n\t\t\t\t},\n\t\t\t\t(v) => Math.min(v / 60, 1), // Normalize to 0-1 based on 60 min cap\n\t\t\t),\n\t\t\tlines: calcCorrelation(\n\t\t\t\t(o) => o.linesAtCommit,\n\t\t\t\t(v) => Math.min(v / 1000, 1), // Normalize to 0-1 based on 1000 lines\n\t\t\t),\n\t\t\tfiles: calcCorrelation(\n\t\t\t\t(o) => o.filesAtCommit,\n\t\t\t\t(v) => Math.min(v / 10, 1), // Normalize to 0-1 based on 10 files\n\t\t\t),\n\t\t\tai: calcCorrelation(\n\t\t\t\t(o) => o.aiFraction,\n\t\t\t\t(v) => v, // Already 0-1\n\t\t\t),\n\t\t\tchurn: calcCorrelation(\n\t\t\t\t(o) => o.churnPercent,\n\t\t\t\t(v) => Math.min(v / 100, 1), // Normalize to 0-1\n\t\t\t),\n\t\t};\n\t}\n\n\t/**\n\t * Get human-readable factor name\n\t */\n\tprivate getFactorName(key: keyof typeof DEFAULT_WEIGHTS): string {\n\t\tswitch (key) {\n\t\t\tcase \"wT\":\n\t\t\t\treturn \"time\";\n\t\t\tcase \"wL\":\n\t\t\t\treturn \"lines\";\n\t\t\tcase \"wF\":\n\t\t\t\treturn \"files\";\n\t\t\tcase \"wA\":\n\t\t\t\treturn \"AI\";\n\t\t\tcase \"wC\":\n\t\t\t\treturn \"churn\";\n\t\t}\n\t}\n\n\t/**\n\t * Normalize weights to sum to 1\n\t */\n\tprivate normalizeWeights(): void {\n\t\tconst sum = this.weights.wT + this.weights.wL + this.weights.wF + this.weights.wA + this.weights.wC;\n\t\tif (sum > 0 && Math.abs(sum - 1) > 0.001) {\n\t\t\tthis.weights.wT /= sum;\n\t\t\tthis.weights.wL /= sum;\n\t\t\tthis.weights.wF /= sum;\n\t\t\tthis.weights.wA /= sum;\n\t\t\tthis.weights.wC /= sum;\n\t\t}\n\t}\n}\n\n// =============================================================================\n// FACTORY\n// =============================================================================\n\n/**\n * Factory function to create CommitRiskSystem\n */\nexport function createCommitRiskSystem(userTuning?: Partial<UserTuning>): CommitRiskSystem {\n\treturn new CommitRiskSystem(userTuning);\n}\n\n// =============================================================================\n// EXPORTS FOR TESTING/EXTENSION\n// =============================================================================\n\nexport {\n\tcomputeTimeRisk,\n\tcomputeLinesRisk,\n\tcomputeFilesRisk,\n\tcomputeAiRisk,\n\tcomputeChurnRisk,\n\tPHASE_BASELINES,\n\tPHASE_HARD_CAPS,\n\tPHASE_MULTIPLIERS,\n\tDEFAULT_WEIGHTS,\n\tDEFAULT_THRESHOLDS,\n\tDEFAULT_COOLDOWNS,\n\tHYSTERESIS,\n\tWEIGHT_BOUNDS,\n\tPR_METRICS_THRESHOLDS,\n};\n\n// =============================================================================\n// PERSISTENCE HELPER\n// =============================================================================\n\n/**\n * Serializable state for CommitRiskSystem persistence\n */\nexport interface CommitRiskSystemState {\n\t/** Self-tuning outcomes */\n\toutcomes: SessionOutcome[];\n\t/** Current weights (if modified from defaults) */\n\tweights?: typeof DEFAULT_WEIGHTS;\n\t/** Current thresholds (if modified from defaults) */\n\tthresholds?: typeof DEFAULT_THRESHOLDS;\n\t/** User tuning preferences */\n\tuserTuning?: UserTuning;\n\t/** Last snapshot timestamp */\n\tlastSnapshotAt: number | null;\n\t/** Last prompt timestamp */\n\tlastPromptAt: number | null;\n}\n\n/**\n * Serialize CommitRiskSystem to JSON-safe state\n */\nexport function serializeCommitRiskSystem(system: CommitRiskSystem): CommitRiskSystemState {\n\tconst config = system.getConfig();\n\treturn {\n\t\toutcomes: system.getOutcomes(),\n\t\tweights: config.weights,\n\t\tthresholds: config.thresholds,\n\t\tuserTuning: config.userTuning,\n\t\tlastSnapshotAt: null, // Externally managed\n\t\tlastPromptAt: null, // Externally managed\n\t};\n}\n\n/**\n * Deserialize CommitRiskSystem from persisted state\n */\nexport function deserializeCommitRiskSystem(state: CommitRiskSystemState): CommitRiskSystem {\n\tconst system = new CommitRiskSystem(state.userTuning);\n\tif (state.outcomes.length > 0) {\n\t\tsystem.setOutcomes(state.outcomes);\n\t}\n\t// Restore learned weights if present\n\tif (state.weights) {\n\t\tsystem.setWeights(state.weights);\n\t}\n\t// Restore calibrated thresholds if present\n\tif (state.thresholds) {\n\t\tsystem.setThresholds(state.thresholds);\n\t}\n\treturn system;\n}\n","/**\n * @snapback/intelligence/vitals/constants\n *\n * Centralized threshold constants for vitals system.\n * Single source of truth - ALL consumers MUST import from here.\n *\n * UX Principles (from industry best practices):\n * - Visual hierarchy: critical > high > moderate > low\n * - Consistency: same thresholds across UI, MCP, CLI\n * - Frictionless: clear actionable boundaries\n *\n * @module vitals/constants\n */\n\n// =============================================================================\n// PRESSURE THRESHOLDS (0-100 scale)\n// =============================================================================\n\n/**\n * Pressure thresholds for snapshot recommendations.\n *\n * @example\n * ```typescript\n * import { PRESSURE_THRESHOLDS } from '@snapback/intelligence/vitals';\n *\n * if (pressure > PRESSURE_THRESHOLDS.critical) {\n *   // Immediate snapshot required\n * } else if (pressure > PRESSURE_THRESHOLDS.high) {\n *   // Snapshot strongly recommended\n * }\n * ```\n */\nexport const PRESSURE_THRESHOLDS = {\n\t/** Low pressure - no action needed */\n\tlow: 25,\n\t/** Moderate pressure - consider snapshotting soon */\n\tmoderate: 50,\n\t/** High pressure - snapshot recommended */\n\thigh: 75,\n\t/** Critical pressure - immediate snapshot required */\n\tcritical: 80,\n} as const;\n\nexport type PressureThresholdLevel = keyof typeof PRESSURE_THRESHOLDS;\n\n// =============================================================================\n// OXYGEN THRESHOLDS (0-100% coverage)\n// =============================================================================\n\n/**\n * Oxygen (snapshot coverage) thresholds.\n * Higher is better - 100% means all modified files have recent snapshots.\n */\nexport const OXYGEN_THRESHOLDS = {\n\t/** Critical - very low coverage, high risk */\n\tcritical: 30,\n\t/** Low - needs attention */\n\tlow: 50,\n\t/** Moderate - acceptable but could improve */\n\tmoderate: 70,\n\t/** Good - healthy coverage */\n\tgood: 85,\n} as const;\n\nexport type OxygenThresholdLevel = keyof typeof OXYGEN_THRESHOLDS;\n\n// =============================================================================\n// TEMPERATURE THRESHOLDS (0-100% AI activity)\n// =============================================================================\n\n/**\n * Temperature (AI activity) thresholds.\n * Based on percentage of AI-assisted changes in the window.\n */\nexport const TEMPERATURE_THRESHOLDS = {\n\t/** Cold - minimal AI activity */\n\tcold: 0,\n\t/** Warm - some AI activity detected */\n\twarm: 20,\n\t/** Hot - significant AI activity */\n\thot: 50,\n\t/** Burning - heavy AI activity, extra caution needed */\n\tburning: 80,\n} as const;\n\nexport type TemperatureThresholdLevel = keyof typeof TEMPERATURE_THRESHOLDS;\n\n// =============================================================================\n// PULSE THRESHOLDS (changes per minute)\n// =============================================================================\n\n/**\n * Pulse (change velocity) thresholds.\n * Measured in file changes per minute.\n */\nexport const PULSE_THRESHOLDS = {\n\t/** Resting - minimal activity */\n\tresting: 0,\n\t/** Elevated - moderate activity */\n\televated: 15,\n\t/** Racing - high activity */\n\tracing: 30,\n\t/** Critical - very high activity, potential automation */\n\tcritical: 50,\n} as const;\n\nexport type PulseThresholdLevel = keyof typeof PULSE_THRESHOLDS;\n\n// =============================================================================\n// TRAJECTORY THRESHOLDS (combined metrics)\n// =============================================================================\n\n/**\n * Trajectory state thresholds - used for combined analysis.\n * These define when to transition between trajectory states.\n */\nexport const TRAJECTORY_THRESHOLDS = {\n\t/** Pressure level that contributes to escalating trajectory */\n\tescalatingPressure: 60,\n\t/** Oxygen level below which contributes to escalating trajectory */\n\tescalatingOxygen: 70,\n\t/** Pressure level for critical trajectory */\n\tcriticalPressure: 80,\n\t/** Oxygen level below which contributes to critical trajectory */\n\tcriticalOxygen: 50,\n\t/** Pressure drop required to enter recovering state */\n\trecoveringPressureDrop: 10,\n\t/** Oxygen level required for recovering state */\n\trecoveringOxygen: 70,\n} as const;\n\n// =============================================================================\n// URGENCY SCORING\n// =============================================================================\n\n/**\n * Urgency score thresholds for snapshot recommendations.\n * Scores are calculated from combined vitals.\n */\nexport const URGENCY_THRESHOLDS = {\n\t/** No urgency - healthy state */\n\tnone: 0,\n\t/** Low urgency - optional action */\n\tlow: 20,\n\t/** Medium urgency - should act soon */\n\tmedium: 40,\n\t/** High urgency - should act now */\n\thigh: 60,\n\t/** Critical urgency - immediate action required */\n\tcritical: 80,\n} as const;\n\nexport type UrgencyThresholdLevel = keyof typeof URGENCY_THRESHOLDS;\n\n// =============================================================================\n// TIME-BASED THRESHOLDS\n// =============================================================================\n\n/**\n * Time-based thresholds for staleness and recommendations.\n */\nexport const TIME_THRESHOLDS = {\n\t/** Minutes until snapshot considered stale */\n\tstaleSnapshotMinutes: 30,\n\t/** Minutes of no snapshot before optional recommendation */\n\toptionalSnapshotMinutes: 60,\n\t/** Sliding window for pulse calculation (seconds) */\n\tpulseWindowSeconds: 60,\n\t/** Sliding window for temperature decay (seconds) */\n\ttemperatureWindowSeconds: 300,\n} as const;\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Get pressure level name from value.\n */\nexport function getPressureLevel(value: number): PressureThresholdLevel {\n\tif (value >= PRESSURE_THRESHOLDS.critical) {\n\t\treturn \"critical\";\n\t}\n\tif (value >= PRESSURE_THRESHOLDS.high) {\n\t\treturn \"high\";\n\t}\n\tif (value >= PRESSURE_THRESHOLDS.moderate) {\n\t\treturn \"moderate\";\n\t}\n\treturn \"low\";\n}\n\n/**\n * Get oxygen level name from value.\n */\nexport function getOxygenLevel(value: number): OxygenThresholdLevel {\n\tif (value >= OXYGEN_THRESHOLDS.good) {\n\t\treturn \"good\";\n\t}\n\tif (value >= OXYGEN_THRESHOLDS.moderate) {\n\t\treturn \"moderate\";\n\t}\n\tif (value >= OXYGEN_THRESHOLDS.low) {\n\t\treturn \"low\";\n\t}\n\treturn \"critical\";\n}\n\n/**\n * Calculate urgency score from vitals.\n * Returns 0-100 score based on combined metrics.\n */\nexport function calculateUrgencyScore(vitals: {\n\tpressure: number;\n\toxygen: number;\n\ttemperatureLevel: \"cold\" | \"warm\" | \"hot\" | \"burning\";\n}): number {\n\tlet score = 0;\n\n\t// Pressure contributes up to 40 points\n\tscore += Math.min((vitals.pressure / 100) * 40, 40);\n\n\t// Low oxygen contributes up to 25 points\n\tif (vitals.oxygen < OXYGEN_THRESHOLDS.low) {\n\t\tscore += Math.min(((OXYGEN_THRESHOLDS.low - vitals.oxygen) / OXYGEN_THRESHOLDS.low) * 25, 25);\n\t}\n\n\t// Temperature contributes up to 20 points\n\tconst tempScores = { cold: 0, warm: 5, hot: 15, burning: 20 };\n\tscore += tempScores[vitals.temperatureLevel];\n\n\t// Cap at 100\n\treturn Math.min(Math.round(score), 100);\n}\n\n/**\n * Get urgency level from score.\n */\nexport function getUrgencyLevel(score: number): UrgencyThresholdLevel {\n\tif (score >= URGENCY_THRESHOLDS.critical) {\n\t\treturn \"critical\";\n\t}\n\tif (score >= URGENCY_THRESHOLDS.high) {\n\t\treturn \"high\";\n\t}\n\tif (score >= URGENCY_THRESHOLDS.medium) {\n\t\treturn \"medium\";\n\t}\n\tif (score >= URGENCY_THRESHOLDS.low) {\n\t\treturn \"low\";\n\t}\n\treturn \"none\";\n}\n\n/**\n * Check if snapshot should be recommended based on vitals.\n */\nexport function shouldRecommendSnapshot(vitals: {\n\tpressure: number;\n\toxygen: number;\n\ttrajectory: \"stable\" | \"escalating\" | \"critical\" | \"recovering\";\n}): { should: boolean; urgency: UrgencyThresholdLevel; reason: string } {\n\t// Critical trajectory always recommends\n\tif (vitals.trajectory === \"critical\") {\n\t\treturn {\n\t\t\tshould: true,\n\t\t\turgency: \"critical\",\n\t\t\treason: \"Critical workspace state - immediate snapshot required\",\n\t\t};\n\t}\n\n\t// High pressure recommends\n\tif (vitals.pressure >= PRESSURE_THRESHOLDS.high) {\n\t\treturn {\n\t\t\tshould: true,\n\t\t\turgency: \"high\",\n\t\t\treason: `High pressure (${vitals.pressure}%) - snapshot recommended`,\n\t\t};\n\t}\n\n\t// Escalating with moderate pressure recommends\n\tif (vitals.trajectory === \"escalating\" && vitals.pressure >= PRESSURE_THRESHOLDS.moderate) {\n\t\treturn {\n\t\t\tshould: true,\n\t\t\turgency: \"medium\",\n\t\t\treason: \"Escalating trajectory - consider creating a snapshot\",\n\t\t};\n\t}\n\n\t// Low oxygen with moderate pressure recommends\n\tif (vitals.oxygen < OXYGEN_THRESHOLDS.low && vitals.pressure >= PRESSURE_THRESHOLDS.moderate) {\n\t\treturn {\n\t\t\tshould: true,\n\t\t\turgency: \"medium\",\n\t\t\treason: `Low snapshot coverage (${vitals.oxygen}%) with unsaved changes`,\n\t\t};\n\t}\n\n\treturn {\n\t\tshould: false,\n\t\turgency: \"none\",\n\t\treason: \"Workspace healthy - no snapshot needed\",\n\t};\n}\n","/**\n * DORAMetrics - Developer Experience Performance Metrics\n *\n * Implements DORA metrics adapted for SnapBack's snapshot-based workflow:\n * - Recovery Time: Time from restore request to successful restoration\n * - Lead Time: Time from code change to snapshot protection\n * - Snapshot Frequency: How often snapshots are created\n * - Recovery Success Rate: Percentage of successful restores\n * - Rework Rate: Percentage of snapshots created due to recovery scenarios\n *\n * Based on 2026 DORA best practices:\n * - Real-time data collection (not batch)\n * - Context-aware thresholds\n * - Integration with developer workflow\n *\n * @see https://dora.dev/guides/dora-metrics/\n * @packageDocumentation\n */\n\n/**\n * Snapshot creation event for DORA tracking\n */\nexport interface SnapshotEvent {\n\t/** Unique snapshot ID */\n\tsnapshotId: string;\n\t/** Timestamp of snapshot creation */\n\ttimestamp: number;\n\t/** Time since last code change (lead time proxy) */\n\ttimeSinceLastChange: number;\n\t/** Whether this was triggered by recovery scenario */\n\tisRecoveryTriggered: boolean;\n\t/** Trigger source */\n\ttrigger: \"manual\" | \"auto\" | \"ai-detected\" | \"recovery\";\n}\n\n/**\n * Recovery event for DORA tracking\n */\nexport interface RecoveryEvent {\n\t/** Snapshot ID that was restored */\n\tsnapshotId: string;\n\t/** Timestamp when restore was requested */\n\trequestTime: number;\n\t/** Timestamp when restore completed */\n\tcompletionTime: number;\n\t/** Whether restore was successful */\n\tsuccess: boolean;\n\t/** Number of files restored */\n\tfilesRestored: number;\n\t/** Reason for failure (if any) */\n\tfailureReason?: string;\n}\n\n/**\n * DORA metrics snapshot\n */\nexport interface DORASnapshot {\n\t/** Mean time to recovery in milliseconds */\n\tmeanTimeToRecovery: number;\n\t/** Average lead time from change to protection (ms) */\n\tleadTimeForProtection: number;\n\t/** Snapshots per hour */\n\tsnapshotFrequency: number;\n\t/** Success rate of recovery operations (0-100) */\n\trecoverySuccessRate: number;\n\t/** Percentage of recovery-triggered snapshots (0-100) */\n\treworkRate: number;\n\t/** Total snapshots in measurement window */\n\ttotalSnapshots: number;\n\t/** Total recoveries in measurement window */\n\ttotalRecoveries: number;\n\t/** Performance tier based on DORA benchmarks */\n\tperformanceTier: \"elite\" | \"high\" | \"medium\" | \"low\";\n}\n\n/**\n * DORA performance thresholds (adapted from 2026 benchmarks)\n * Based on snapshot/recovery context rather than deployment\n */\nconst DORA_THRESHOLDS = {\n\telite: {\n\t\tmeanTimeToRecovery: 2000, // < 2 seconds\n\t\tleadTimeForProtection: 60000, // < 1 minute\n\t\tsnapshotFrequency: 4, // > 4 per hour\n\t\trecoverySuccessRate: 99, // > 99%\n\t},\n\thigh: {\n\t\tmeanTimeToRecovery: 5000, // < 5 seconds\n\t\tleadTimeForProtection: 300000, // < 5 minutes\n\t\tsnapshotFrequency: 2, // > 2 per hour\n\t\trecoverySuccessRate: 95, // > 95%\n\t},\n\tmedium: {\n\t\tmeanTimeToRecovery: 10000, // < 10 seconds\n\t\tleadTimeForProtection: 900000, // < 15 minutes\n\t\tsnapshotFrequency: 1, // > 1 per hour\n\t\trecoverySuccessRate: 85, // > 85%\n\t},\n};\n\n/**\n * DORAMetrics - Tracks developer experience performance metrics\n *\n * @example\n * ```typescript\n * const dora = new DORAMetrics(\"workspace-123\");\n *\n * // Record snapshot creation\n * dora.recordSnapshot({\n *   snapshotId: \"snap-1\",\n *   timestamp: Date.now(),\n *   timeSinceLastChange: 30000,\n *   isRecoveryTriggered: false,\n *   trigger: \"auto\"\n * });\n *\n * // Record recovery\n * dora.recordRecovery({\n *   snapshotId: \"snap-1\",\n *   requestTime: Date.now(),\n *   completionTime: Date.now() + 1500,\n *   success: true,\n *   filesRestored: 5\n * });\n *\n * // Get metrics\n * const metrics = dora.getMetrics();\n * console.log(metrics.performanceTier); // \"elite\"\n * ```\n */\nexport class DORAMetrics {\n\t// biome-ignore lint/correctness/noUnusedPrivateClassMembers: stored for context/debugging\n\tprivate readonly workspaceId: string;\n\tprivate readonly snapshotEvents: SnapshotEvent[] = [];\n\tprivate readonly recoveryEvents: RecoveryEvent[] = [];\n\tprivate readonly measurementWindowMs: number;\n\n\t/**\n\t * Create a new DORAMetrics tracker\n\t * @param workspaceId - Workspace identifier\n\t * @param measurementWindowMs - Time window for metrics (default: 1 hour)\n\t */\n\tconstructor(workspaceId: string, measurementWindowMs: number = 60 * 60 * 1000) {\n\t\tthis.workspaceId = workspaceId;\n\t\tthis.measurementWindowMs = measurementWindowMs;\n\t}\n\n\t/**\n\t * Record a snapshot creation event\n\t */\n\trecordSnapshot(event: SnapshotEvent): void {\n\t\tthis.snapshotEvents.push(event);\n\t\tthis.pruneOldEvents();\n\t}\n\n\t/**\n\t * Record a recovery event\n\t */\n\trecordRecovery(event: RecoveryEvent): void {\n\t\tthis.recoveryEvents.push(event);\n\t\tthis.pruneOldEvents();\n\t}\n\n\t/**\n\t * Get current DORA metrics snapshot\n\t */\n\tgetMetrics(now: number = Date.now()): DORASnapshot {\n\t\tconst cutoff = now - this.measurementWindowMs;\n\t\tconst recentSnapshots = this.snapshotEvents.filter((e) => e.timestamp >= cutoff);\n\t\tconst recentRecoveries = this.recoveryEvents.filter((e) => e.requestTime >= cutoff);\n\n\t\t// Calculate Mean Time To Recovery\n\t\tconst successfulRecoveries = recentRecoveries.filter((r) => r.success);\n\t\tconst meanTimeToRecovery =\n\t\t\tsuccessfulRecoveries.length > 0\n\t\t\t\t? successfulRecoveries.reduce((sum, r) => sum + (r.completionTime - r.requestTime), 0) /\n\t\t\t\t\tsuccessfulRecoveries.length\n\t\t\t\t: 0;\n\n\t\t// Calculate Lead Time for Protection\n\t\tconst leadTimeForProtection =\n\t\t\trecentSnapshots.length > 0\n\t\t\t\t? recentSnapshots.reduce((sum, s) => sum + s.timeSinceLastChange, 0) / recentSnapshots.length\n\t\t\t\t: 0;\n\n\t\t// Calculate Snapshot Frequency (per hour)\n\t\tconst hoursInWindow = this.measurementWindowMs / (60 * 60 * 1000);\n\t\tconst snapshotFrequency = recentSnapshots.length / hoursInWindow;\n\n\t\t// Calculate Recovery Success Rate\n\t\tconst recoverySuccessRate =\n\t\t\trecentRecoveries.length > 0 ? (successfulRecoveries.length / recentRecoveries.length) * 100 : 100;\n\n\t\t// Calculate Rework Rate (recovery-triggered snapshots)\n\t\tconst recoveryTriggered = recentSnapshots.filter((s) => s.isRecoveryTriggered);\n\t\tconst reworkRate = recentSnapshots.length > 0 ? (recoveryTriggered.length / recentSnapshots.length) * 100 : 0;\n\n\t\t// Determine performance tier\n\t\tconst performanceTier = this.calculatePerformanceTier({\n\t\t\tmeanTimeToRecovery,\n\t\t\tleadTimeForProtection,\n\t\t\tsnapshotFrequency,\n\t\t\trecoverySuccessRate,\n\t\t});\n\n\t\treturn {\n\t\t\tmeanTimeToRecovery: Math.round(meanTimeToRecovery),\n\t\t\tleadTimeForProtection: Math.round(leadTimeForProtection),\n\t\t\tsnapshotFrequency: Math.round(snapshotFrequency * 10) / 10,\n\t\t\trecoverySuccessRate: Math.round(recoverySuccessRate * 10) / 10,\n\t\t\treworkRate: Math.round(reworkRate * 10) / 10,\n\t\t\ttotalSnapshots: recentSnapshots.length,\n\t\t\ttotalRecoveries: recentRecoveries.length,\n\t\t\tperformanceTier,\n\t\t};\n\t}\n\n\t/**\n\t * Get recovery time for a specific recovery (for real-time tracking)\n\t */\n\tgetRecoveryTime(snapshotId: string): number | null {\n\t\tconst recovery = this.recoveryEvents.find((r) => r.snapshotId === snapshotId && r.success);\n\t\tif (!recovery) {\n\t\t\treturn null;\n\t\t}\n\t\treturn recovery.completionTime - recovery.requestTime;\n\t}\n\n\t/**\n\t * Get trend direction for key metrics\n\t */\n\tgetTrends(now: number = Date.now()): {\n\t\trecoveryTrend: \"improving\" | \"stable\" | \"degrading\";\n\t\tfrequencyTrend: \"improving\" | \"stable\" | \"degrading\";\n\t} {\n\t\tconst currentWindow = this.measurementWindowMs;\n\t\tconst halfWindow = currentWindow / 2;\n\n\t\t// Compare first half to second half\n\t\tconst midpoint = now - halfWindow;\n\t\tconst cutoff = now - currentWindow;\n\n\t\tconst firstHalfRecoveries = this.recoveryEvents.filter(\n\t\t\t(r) => r.requestTime >= cutoff && r.requestTime < midpoint,\n\t\t);\n\t\tconst secondHalfRecoveries = this.recoveryEvents.filter((r) => r.requestTime >= midpoint);\n\n\t\tconst firstHalfSnapshots = this.snapshotEvents.filter((s) => s.timestamp >= cutoff && s.timestamp < midpoint);\n\t\tconst secondHalfSnapshots = this.snapshotEvents.filter((s) => s.timestamp >= midpoint);\n\n\t\t// Calculate average recovery times\n\t\tconst firstRecoveryAvg = this.calculateAvgRecoveryTime(firstHalfRecoveries);\n\t\tconst secondRecoveryAvg = this.calculateAvgRecoveryTime(secondHalfRecoveries);\n\n\t\t// Determine trends\n\t\tconst recoveryTrend =\n\t\t\tsecondRecoveryAvg < firstRecoveryAvg * 0.9\n\t\t\t\t? \"improving\"\n\t\t\t\t: secondRecoveryAvg > firstRecoveryAvg * 1.1\n\t\t\t\t\t? \"degrading\"\n\t\t\t\t\t: \"stable\";\n\n\t\tconst frequencyTrend =\n\t\t\tsecondHalfSnapshots.length > firstHalfSnapshots.length * 1.1\n\t\t\t\t? \"improving\"\n\t\t\t\t: secondHalfSnapshots.length < firstHalfSnapshots.length * 0.9\n\t\t\t\t\t? \"degrading\"\n\t\t\t\t\t: \"stable\";\n\n\t\treturn { recoveryTrend, frequencyTrend };\n\t}\n\n\t/**\n\t * Reset all metrics (for testing or workspace reset)\n\t */\n\treset(): void {\n\t\tthis.snapshotEvents.length = 0;\n\t\tthis.recoveryEvents.length = 0;\n\t}\n\n\t// =========================================================================\n\t// INTERNAL\n\t// =========================================================================\n\n\tprivate calculateAvgRecoveryTime(recoveries: RecoveryEvent[]): number {\n\t\tconst successful = recoveries.filter((r) => r.success);\n\t\tif (successful.length === 0) {\n\t\t\treturn 0;\n\t\t}\n\t\treturn successful.reduce((sum, r) => sum + (r.completionTime - r.requestTime), 0) / successful.length;\n\t}\n\n\tprivate calculatePerformanceTier(metrics: {\n\t\tmeanTimeToRecovery: number;\n\t\tleadTimeForProtection: number;\n\t\tsnapshotFrequency: number;\n\t\trecoverySuccessRate: number;\n\t}): \"elite\" | \"high\" | \"medium\" | \"low\" {\n\t\tconst { meanTimeToRecovery, leadTimeForProtection, snapshotFrequency, recoverySuccessRate } = metrics;\n\n\t\t// Elite: All metrics meet elite thresholds\n\t\tif (\n\t\t\tmeanTimeToRecovery <= DORA_THRESHOLDS.elite.meanTimeToRecovery &&\n\t\t\tleadTimeForProtection <= DORA_THRESHOLDS.elite.leadTimeForProtection &&\n\t\t\tsnapshotFrequency >= DORA_THRESHOLDS.elite.snapshotFrequency &&\n\t\t\trecoverySuccessRate >= DORA_THRESHOLDS.elite.recoverySuccessRate\n\t\t) {\n\t\t\treturn \"elite\";\n\t\t}\n\n\t\t// High: All metrics meet high thresholds\n\t\tif (\n\t\t\tmeanTimeToRecovery <= DORA_THRESHOLDS.high.meanTimeToRecovery &&\n\t\t\tleadTimeForProtection <= DORA_THRESHOLDS.high.leadTimeForProtection &&\n\t\t\tsnapshotFrequency >= DORA_THRESHOLDS.high.snapshotFrequency &&\n\t\t\trecoverySuccessRate >= DORA_THRESHOLDS.high.recoverySuccessRate\n\t\t) {\n\t\t\treturn \"high\";\n\t\t}\n\n\t\t// Medium: All metrics meet medium thresholds\n\t\tif (\n\t\t\tmeanTimeToRecovery <= DORA_THRESHOLDS.medium.meanTimeToRecovery &&\n\t\t\tleadTimeForProtection <= DORA_THRESHOLDS.medium.leadTimeForProtection &&\n\t\t\tsnapshotFrequency >= DORA_THRESHOLDS.medium.snapshotFrequency &&\n\t\t\trecoverySuccessRate >= DORA_THRESHOLDS.medium.recoverySuccessRate\n\t\t) {\n\t\t\treturn \"medium\";\n\t\t}\n\n\t\treturn \"low\";\n\t}\n\n\tprivate pruneOldEvents(): void {\n\t\tconst cutoff = Date.now() - this.measurementWindowMs * 2; // Keep 2x window for trend analysis\n\n\t\t// Remove old snapshot events\n\t\twhile (this.snapshotEvents.length > 0 && this.snapshotEvents[0].timestamp < cutoff) {\n\t\t\tthis.snapshotEvents.shift();\n\t\t}\n\n\t\t// Remove old recovery events\n\t\twhile (this.recoveryEvents.length > 0 && this.recoveryEvents[0].requestTime < cutoff) {\n\t\t\tthis.recoveryEvents.shift();\n\t\t}\n\t}\n}\n\n/**\n * Factory function to create DORAMetrics instance\n */\nexport function createDORAMetrics(workspaceId: string): DORAMetrics {\n\treturn new DORAMetrics(workspaceId);\n}\n","/**\n * DocFreshnessSensor - Documentation freshness tracking\n *\n * Detects stale documentation by comparing markdown file mtimes\n * against source code mtimes. Prevents reliance on outdated docs.\n *\n * Uses glob (already installed) for file discovery.\n *\n * @performance Budget: <50ms for typical workspace\n */\n\nimport { stat } from \"node:fs/promises\";\nimport { dirname, relative } from \"node:path\";\n\nexport interface DocFreshnessConfig {\n\t/** Hours until doc considered stale (default: 72 = 3 days) */\n\tstaleHours: number;\n\t/** Patterns for documentation files */\n\tdocPatterns: string[];\n\t/** Patterns for source files to compare against */\n\tsourcePatterns: string[];\n}\n\nexport const DEFAULT_DOC_FRESHNESS_CONFIG: DocFreshnessConfig = {\n\tstaleHours: 72,\n\tdocPatterns: [\"**/*.md\", \"**/CLAUDE.md\", \"**/*-audit.md\", \"**/*-report.md\", \"**/*ROADMAP*.md\", \"**/*ISSUES*.md\"],\n\tsourcePatterns: [\"**/*.ts\", \"**/*.tsx\", \"**/*.js\", \"**/*.jsx\"],\n};\n\nexport interface StaleDoc {\n\t/** Path to the stale document */\n\tpath: string;\n\t/** Last modified timestamp */\n\tmtime: number;\n\t/** Hours since last modification */\n\thoursStale: number;\n\t/** Related source files that are newer */\n\tnewerSourceFiles: string[];\n\t/** Severity based on staleness */\n\tseverity: \"warning\" | \"error\";\n}\n\nexport interface DocFreshnessState {\n\t/** Overall freshness score 0-100 (100 = all fresh) */\n\tvalue: number;\n\t/** Number of stale documents */\n\tstaleCount: number;\n\t/** List of stale documents with details */\n\tstaleDocs: StaleDoc[];\n\t/** Total documents analyzed */\n\ttotalDocs: number;\n}\n\nexport interface DocFreshnessResult {\n\tstate: DocFreshnessState;\n\tsuccess: boolean;\n\terror?: string;\n\tduration: number;\n}\n\n/**\n * DocFreshnessSensor tracks how up-to-date documentation is\n * relative to source code changes.\n *\n * Freshness represents trust in documentation accuracy.\n * Lower freshness = docs may contain outdated information.\n */\nexport class DocFreshnessSensor {\n\tprivate readonly config: DocFreshnessConfig;\n\n\tconstructor(config: Partial<DocFreshnessConfig> = {}) {\n\t\tthis.config = { ...DEFAULT_DOC_FRESHNESS_CONFIG, ...config };\n\t}\n\n\t/**\n\t * Analyze documentation freshness in a directory\n\t *\n\t * @param workspaceRoot - Root directory to analyze\n\t * @returns Freshness analysis result\n\t */\n\tasync analyze(workspaceRoot: string): Promise<DocFreshnessResult> {\n\t\tconst startTime = Date.now();\n\n\t\ttry {\n\t\t\t// Dynamic import glob\n\t\t\tconst { glob } = await import(\"glob\");\n\n\t\t\t// Find all doc files\n\t\t\tconst docFiles = await glob(this.config.docPatterns, {\n\t\t\t\tcwd: workspaceRoot,\n\t\t\t\tabsolute: true,\n\t\t\t\tignore: [\"**/node_modules/**\", \"**/dist/**\", \"**/.next/**\"],\n\t\t\t});\n\n\t\t\t// Find all source files\n\t\t\tconst sourceFiles = await glob(this.config.sourcePatterns, {\n\t\t\t\tcwd: workspaceRoot,\n\t\t\t\tabsolute: true,\n\t\t\t\tignore: [\"**/node_modules/**\", \"**/dist/**\", \"**/.next/**\"],\n\t\t\t});\n\n\t\t\t// Get mtimes for all files\n\t\t\tconst docMtimes = await this.getMtimes(docFiles);\n\t\t\tconst sourceMtimes = await this.getMtimes(sourceFiles);\n\n\t\t\t// Analyze staleness\n\t\t\tconst now = Date.now();\n\t\t\tconst staleThreshold = now - this.config.staleHours * 60 * 60 * 1000;\n\t\t\tconst staleDocs: StaleDoc[] = [];\n\n\t\t\tfor (const [docPath, docMtime] of docMtimes) {\n\t\t\t\tconst hoursStale = (now - docMtime) / (60 * 60 * 1000);\n\n\t\t\t\t// Find related source files in same or child directories\n\t\t\t\tconst docDir = dirname(docPath);\n\t\t\t\tconst newerSourceFiles: string[] = [];\n\n\t\t\t\tfor (const [srcPath, srcMtime] of sourceMtimes) {\n\t\t\t\t\t// Source file is related if in same directory tree\n\t\t\t\t\tif (srcPath.startsWith(docDir) && srcMtime > docMtime) {\n\t\t\t\t\t\tnewerSourceFiles.push(relative(workspaceRoot, srcPath));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Doc is stale if older than threshold OR has newer source files\n\t\t\t\tconst isStale = docMtime < staleThreshold || newerSourceFiles.length > 0;\n\n\t\t\t\tif (isStale) {\n\t\t\t\t\tstaleDocs.push({\n\t\t\t\t\t\tpath: relative(workspaceRoot, docPath),\n\t\t\t\t\t\tmtime: docMtime,\n\t\t\t\t\t\thoursStale: Math.round(hoursStale),\n\t\t\t\t\t\tnewerSourceFiles: newerSourceFiles.slice(0, 5), // Limit for brevity\n\t\t\t\t\t\tseverity: hoursStale > this.config.staleHours * 2 ? \"error\" : \"warning\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Calculate freshness score\n\t\t\tconst freshDocs = docMtimes.size - staleDocs.length;\n\t\t\tconst freshnessValue = docMtimes.size > 0 ? Math.round((freshDocs / docMtimes.size) * 100) : 100;\n\n\t\t\treturn {\n\t\t\t\tstate: {\n\t\t\t\t\tvalue: freshnessValue,\n\t\t\t\t\tstaleCount: staleDocs.length,\n\t\t\t\t\tstaleDocs: staleDocs.sort((a, b) => b.hoursStale - a.hoursStale),\n\t\t\t\t\ttotalDocs: docMtimes.size,\n\t\t\t\t},\n\t\t\t\tsuccess: true,\n\t\t\t\tduration: Date.now() - startTime,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tstate: {\n\t\t\t\t\tvalue: 0,\n\t\t\t\t\tstaleCount: 0,\n\t\t\t\t\tstaleDocs: [],\n\t\t\t\t\ttotalDocs: 0,\n\t\t\t\t},\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\tduration: Date.now() - startTime,\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Quick check for specific documentation files\n\t *\n\t * @param docPaths - Absolute paths to doc files\n\t * @param workspaceRoot - Workspace root for relative source lookup\n\t */\n\tasync checkSpecificDocs(\n\t\tdocPaths: string[],\n\t\t_workspaceRoot: string,\n\t): Promise<Map<string, { stale: boolean; hoursOld: number }>> {\n\t\tconst results = new Map<string, { stale: boolean; hoursOld: number }>();\n\t\tconst now = Date.now();\n\t\tconst staleThreshold = now - this.config.staleHours * 60 * 60 * 1000;\n\n\t\tfor (const docPath of docPaths) {\n\t\t\ttry {\n\t\t\t\tconst stats = await stat(docPath);\n\t\t\t\tconst hoursOld = Math.round((now - stats.mtimeMs) / (60 * 60 * 1000));\n\t\t\t\tresults.set(docPath, {\n\t\t\t\t\tstale: stats.mtimeMs < staleThreshold,\n\t\t\t\t\thoursOld,\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\t// File doesn't exist or can't be read\n\t\t\t\tresults.set(docPath, { stale: true, hoursOld: -1 });\n\t\t\t}\n\t\t}\n\n\t\treturn results;\n\t}\n\n\t/**\n\t * Get mtimes for a list of files\n\t */\n\tprivate async getMtimes(files: string[]): Promise<Map<string, number>> {\n\t\tconst mtimes = new Map<string, number>();\n\n\t\tconst results = await Promise.allSettled(\n\t\t\tfiles.map(async (file) => {\n\t\t\t\tconst stats = await stat(file);\n\t\t\t\treturn { file, mtime: stats.mtimeMs };\n\t\t\t}),\n\t\t);\n\n\t\tfor (const result of results) {\n\t\t\tif (result.status === \"fulfilled\") {\n\t\t\t\tmtimes.set(result.value.file, result.value.mtime);\n\t\t\t}\n\t\t}\n\n\t\treturn mtimes;\n\t}\n}\n\n/**\n * Format stale docs for human-readable output\n */\nexport function formatStaleDocs(staleDocs: StaleDoc[]): string {\n\tif (staleDocs.length === 0) {\n\t\treturn \"All documentation is fresh\";\n\t}\n\n\treturn staleDocs\n\t\t.map((doc) => {\n\t\t\tconst icon = doc.severity === \"error\" ? \"!!!\" : \"!\";\n\t\t\tconst newerFiles =\n\t\t\t\tdoc.newerSourceFiles.length > 0 ? ` (${doc.newerSourceFiles.length} newer source files)` : \"\";\n\t\t\treturn `${icon} ${doc.path}: ${doc.hoursStale}h stale${newerFiles}`;\n\t\t})\n\t\t.join(\"\\n\");\n}\n","/**\n * JSONL Store\n *\n * Atomic JSONL file operations for learnings, violations, and interactions.\n * Uses atomically package for safe writes that prevent corruption.\n */\n\nimport * as fs from \"node:fs\";\nimport * as path from \"node:path\";\nimport { generateId as contractsGenerateId } from \"@snapback/contracts/id-generator\";\nimport { writeFile } from \"atomically\";\n\n/**\n * Load all records from a JSONL file\n */\nexport function loadJsonl<T>(filepath: string): T[] {\n\tif (!fs.existsSync(filepath)) {\n\t\treturn [];\n\t}\n\ttry {\n\t\treturn fs\n\t\t\t.readFileSync(filepath, \"utf-8\")\n\t\t\t.split(/\\r?\\n/) // Cross-platform: handles both \\n (Unix) and \\r\\n (Windows)\n\t\t\t.filter((line) => line.trim())\n\t\t\t.map((line) => JSON.parse(line) as T);\n\t} catch (e) {\n\t\tconsole.error(`[JsonlStore] Error loading ${filepath}:`, e);\n\t\treturn [];\n\t}\n}\n\n/**\n * Append a record to a JSONL file (sync)\n */\nexport function appendJsonl<T>(filepath: string, data: T): void {\n\tconst dir = path.dirname(filepath);\n\tif (!fs.existsSync(dir)) {\n\t\tfs.mkdirSync(dir, { recursive: true });\n\t}\n\tfs.appendFileSync(filepath, `${JSON.stringify(data)}\\n`);\n}\n\n/**\n * Append a record to a JSONL file (async, atomic)\n */\nexport async function appendJsonlAsync<T>(filepath: string, data: T): Promise<void> {\n\tconst dir = path.dirname(filepath);\n\tif (!fs.existsSync(dir)) {\n\t\tfs.mkdirSync(dir, { recursive: true });\n\t}\n\ttry {\n\t\tconst existing = fs.existsSync(filepath) ? fs.readFileSync(filepath, \"utf-8\") : \"\";\n\t\tawait writeFile(filepath, `${existing + JSON.stringify(data)}\\n`);\n\t} catch {\n\t\t// Fallback to sync append\n\t\tfs.appendFileSync(filepath, `${JSON.stringify(data)}\\n`);\n\t}\n}\n\n/**\n * Write all records to a JSONL file (atomic replace)\n */\nexport async function writeJsonl<T>(filepath: string, records: T[]): Promise<void> {\n\tconst dir = path.dirname(filepath);\n\tif (!fs.existsSync(dir)) {\n\t\tfs.mkdirSync(dir, { recursive: true });\n\t}\n\tconst content = `${records.map((r) => JSON.stringify(r)).join(\"\\n\")}\\n`;\n\ttry {\n\t\tawait writeFile(filepath, content);\n\t} catch {\n\t\t// Fallback to sync write\n\t\tfs.writeFileSync(filepath, content);\n\t}\n}\n\n/**\n * Find a record by predicate\n */\nexport function findInJsonl<T>(filepath: string, predicate: (item: T) => boolean): T | undefined {\n\tconst records = loadJsonl<T>(filepath);\n\treturn records.find(predicate);\n}\n\n/**\n * Update a record that matches the predicate\n */\nexport async function updateInJsonl<T>(\n\tfilepath: string,\n\tpredicate: (item: T) => boolean,\n\tupdater: (item: T) => T,\n): Promise<boolean> {\n\tconst records = loadJsonl<T>(filepath);\n\tlet updated = false;\n\n\tconst newRecords = records.map((record) => {\n\t\tif (predicate(record)) {\n\t\t\tupdated = true;\n\t\t\treturn updater(record);\n\t\t}\n\t\treturn record;\n\t});\n\n\tif (updated) {\n\t\tawait writeJsonl(filepath, newRecords);\n\t}\n\n\treturn updated;\n}\n\n/**\n * Count records matching a predicate\n */\nexport function countInJsonl<T>(filepath: string, predicate?: (item: T) => boolean): number {\n\tconst records = loadJsonl<T>(filepath);\n\tif (!predicate) {\n\t\treturn records.length;\n\t}\n\treturn records.filter(predicate).length;\n}\n\n/**\n * Generate a unique ID - delegates to @snapback/contracts\n * Re-exported for backwards compatibility\n */\nexport function generateId(prefix = \"ID\"): string {\n\treturn contractsGenerateId(prefix);\n}\n","/**\n * PatternLookup - Phase 4 Feature\n * Provides intelligent pattern discovery for specific code scenarios.\n */\n\nimport path from \"node:path\";\nimport { loadJsonl } from \"../storage/index.js\";\nimport type { ResolvedConfig } from \"../types/config.js\";\nimport type { Learning, Violation } from \"../types/learning.js\";\n\nexport interface PatternMatch {\n\t/** Pattern or learning that matched */\n\tcontent: Learning | Violation;\n\t/** Match relevance score (0-1) */\n\trelevance: number;\n\t/** Reason for match */\n\treason: string;\n\t/** Additional context */\n\tcontext: {\n\t\ttype: \"pattern\" | \"learning\" | \"violation\";\n\t\tkeywords: string[];\n\t\trelatedFiles?: string[];\n\t};\n}\n\nexport class PatternLookup {\n\tprivate config: ResolvedConfig;\n\tprivate learningsCache: Learning[] | null = null;\n\tprivate violationsCache: Violation[] | null = null;\n\n\tconstructor(config: ResolvedConfig) {\n\t\tthis.config = config;\n\t}\n\n\t/**\n\t * Find patterns by scenario, file, or problem\n\t */\n\tlookup(query: \"scenario\" | \"file\" | \"problem\", value: string, extra?: string | string[]): PatternMatch[] {\n\t\tconst keywords =\n\t\t\tquery === \"scenario\"\n\t\t\t\t? (extra as string[]) || []\n\t\t\t\t: query === \"file\"\n\t\t\t\t\t? this.extractFileKeywords(value)\n\t\t\t\t\t: (value\n\t\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t\t.split(/\\s+/)\n\t\t\t\t\t\t\t.filter((w) => w.length > 2) as string[]);\n\n\t\treturn this.scoreAndFilter(value, keywords, extra as string | undefined);\n\t}\n\n\t/**\n\t * Extract keywords from file path\n\t */\n\tprivate extractFileKeywords(filePath: string): string[] {\n\t\tconst ext = path.extname(filePath).slice(1);\n\t\tconst dirs = path\n\t\t\t.dirname(filePath)\n\t\t\t.split(\"/\")\n\t\t\t.filter((p) => p && !p.startsWith(\".\"));\n\t\tconst name = path.basename(filePath).split(\".\")[0];\n\t\treturn [ext, ...dirs, name].filter(Boolean);\n\t}\n\n\t/**\n\t * Score, filter, and return top matches\n\t */\n\tprivate scoreAndFilter(scenario: string, keywords: string[], fileContext?: string): PatternMatch[] {\n\t\tconst results: PatternMatch[] = [];\n\t\tconst searchText = scenario.toLowerCase();\n\n\t\tfor (const learning of this.loadLearnings()) {\n\t\t\tconst score = this.scoreMatch(learning, searchText, keywords, fileContext);\n\t\t\tif (score > 0.3) {\n\t\t\t\tresults.push({\n\t\t\t\t\tcontent: learning,\n\t\t\t\t\trelevance: score,\n\t\t\t\t\treason: `Learning relevant to ${scenario}`,\n\t\t\t\t\tcontext: {\n\t\t\t\t\t\ttype: \"learning\",\n\t\t\t\t\t\tkeywords: Array.isArray(learning.trigger) ? learning.trigger : [learning.trigger],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tfor (const violation of this.loadViolations()) {\n\t\t\tconst score = this.scoreMatch(violation, searchText, keywords, fileContext);\n\t\t\tif (score > 0.3) {\n\t\t\t\tresults.push({\n\t\t\t\t\tcontent: violation,\n\t\t\t\t\trelevance: score,\n\t\t\t\t\treason: `Similar pattern detected in ${violation.file}`,\n\t\t\t\t\tcontext: {\n\t\t\t\t\t\ttype: \"violation\",\n\t\t\t\t\t\tkeywords: [violation.type],\n\t\t\t\t\t\trelatedFiles: [violation.file],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn results.sort((a, b) => b.relevance - a.relevance).slice(0, 10);\n\t}\n\n\t/**\n\t * Score relevance of a pattern match\n\t */\n\tprivate scoreMatch(item: Learning | Violation, scenario: string, keywords: string[], fileContext?: string): number {\n\t\tconst searchText = this.extractSearchText(item).toLowerCase();\n\n\t\tconst scenarioMatch = searchText.includes(scenario) ? 40 : this.countOverlap(scenario, searchText) * 20;\n\t\tconst keywordMatch =\n\t\t\t(keywords.filter((kw) => searchText.includes(kw.toLowerCase())).length / Math.max(keywords.length, 1)) * 40;\n\t\tconst fileMatch = fileContext && \"file\" in item && item.file.includes(fileContext) ? 20 : 0;\n\n\t\treturn Math.min((scenarioMatch + keywordMatch + fileMatch) / 100, 1);\n\t}\n\n\t/**\n\t * Count token overlap between texts\n\t */\n\tprivate countOverlap(text1: string, text2: string): number {\n\t\tconst tokens1 = new Set(text1.split(/\\s+/));\n\t\tconst tokens2 = new Set(text2.split(/\\s+/));\n\t\tconst overlap = [...tokens1].filter((t) => tokens2.has(t)).length;\n\t\treturn overlap > 0 ? 1 : 0;\n\t}\n\n\t/**\n\t * Extract searchable text from learning or violation\n\t */\n\tprivate extractSearchText(item: Learning | Violation): string {\n\t\tif (\"action\" in item) {\n\t\t\tconst triggers = Array.isArray(item.trigger) ? item.trigger.join(\" \") : item.trigger;\n\t\t\treturn `${triggers} ${item.action} ${item.solution || \"\"} ${item.context || \"\"}`;\n\t\t}\n\t\treturn `${item.type} ${item.whatHappened} ${item.whyItHappened} ${item.prevention}`;\n\t}\n\n\t/**\n\t * Load learnings (with caching)\n\t */\n\tprivate loadLearnings(): Learning[] {\n\t\tif (!this.learningsCache) {\n\t\t\tconst learningsPath = path.join(this.config.rootDir, this.config.learningsDir, \"learnings.jsonl\");\n\t\t\tthis.learningsCache = loadJsonl<Learning>(learningsPath);\n\t\t}\n\t\treturn this.learningsCache;\n\t}\n\n\t/**\n\t * Load violations (with caching)\n\t */\n\tprivate loadViolations(): Violation[] {\n\t\tif (!this.violationsCache) {\n\t\t\tconst violationsPath = path.join(this.config.rootDir, this.config.violationsFile);\n\t\t\tthis.violationsCache = loadJsonl<Violation>(violationsPath);\n\t\t}\n\t\treturn this.violationsCache;\n\t}\n\n\tclearCache(): void {\n\t\tthis.learningsCache = null;\n\t\tthis.violationsCache = null;\n\t}\n}\n","/**\n * @snapback/intelligence - Vitals Learning Types\n *\n * Type definitions for Phase 4: Learning & Calibration\n * - User behavior learning\n * - Per-workspace threshold calibration\n * - Trajectory prediction\n */\n\nimport type { Trajectory, Urgency, VitalsSnapshot } from \"./vitals.js\";\n\n// =============================================================================\n// USER BEHAVIOR LEARNING\n// =============================================================================\n\n/** Risk tolerance profile inferred from user behavior */\nexport type RiskProfile = \"conservative\" | \"balanced\" | \"aggressive\";\n\n/** Timing classification for snapshot events */\nexport type SnapshotTiming = \"early\" | \"aligned\" | \"late\" | \"missed\";\n\n/** A recorded observation of user snapshot behavior */\nexport interface SnapshotObservation {\n\t/** Unique observation ID */\n\tid: string;\n\t/** Workspace this observation belongs to */\n\tworkspaceId: string;\n\t/** Timestamp when observation was recorded */\n\ttimestamp: number;\n\t/** Vitals snapshot at time of observation */\n\tvitals: VitalsSnapshot;\n\t/** Whether user created a snapshot */\n\tuserCreatedSnapshot: boolean;\n\t/** Whether vitals recommended a snapshot at this moment */\n\tvitalsRecommended: boolean;\n\t/** Urgency level when observation was made */\n\turgencyAtTime: Urgency;\n\t/** Timing classification */\n\ttiming: SnapshotTiming;\n}\n\n/** User behavior statistics derived from observations */\nexport interface BehaviorStats {\n\t/** Total observations recorded */\n\ttotalObservations: number;\n\t/** Times user created snapshot when recommended */\n\talignedSnapshots: number;\n\t/** Times user created snapshot before recommendation (early) */\n\tearlySnapshots: number;\n\t/** Times user created snapshot after recommendation (late) */\n\tlateSnapshots: number;\n\t/** Times vitals recommended but user didn't snapshot */\n\tmissedRecommendations: number;\n\t/** Inferred risk profile */\n\triskProfile: RiskProfile;\n\t/** Average pressure when user snapshots */\n\tavgPressureAtSnapshot: number;\n\t/** Average oxygen when user snapshots */\n\tavgOxygenAtSnapshot: number;\n}\n\n// =============================================================================\n// THRESHOLD CALIBRATION\n// =============================================================================\n\n/** Calibration status */\nexport type CalibrationStatus = \"uncalibrated\" | \"learning\" | \"calibrated\" | \"locked\";\n\n/** Per-workspace threshold calibration profile */\nexport interface WorkspaceProfile {\n\t/** Workspace identifier */\n\tworkspaceId: string;\n\t/** Calibration status */\n\tstatus: CalibrationStatus;\n\t/** Number of observations used for calibration */\n\tobservationCount: number;\n\t/** Learned threshold adjustments (multipliers applied to defaults) */\n\tthresholdAdjustments: ThresholdAdjustments;\n\t/** Inferred risk tolerance (0-1 scale, 0=conservative, 1=aggressive) */\n\triskTolerance: number;\n\t/** Typical pulse level for this workspace */\n\ttypicalPulseLevel: number;\n\t/** Average snapshots per hour */\n\tsnapshotFrequency: number;\n\t/** Last calibration timestamp */\n\tlastCalibratedAt: number;\n\t/** Confidence in calibration (0-1) */\n\tconfidence: number;\n}\n\n/** Threshold adjustment multipliers */\nexport interface ThresholdAdjustments {\n\t/** Multiplier for pulse thresholds */\n\tpulseMultiplier: number;\n\t/** Multiplier for temperature thresholds */\n\ttemperatureMultiplier: number;\n\t/** Multiplier for pressure warning threshold */\n\tpressureMultiplier: number;\n\t/** Multiplier for oxygen warning threshold */\n\toxygenMultiplier: number;\n}\n\n/** Default (neutral) threshold adjustments */\nexport const DEFAULT_THRESHOLD_ADJUSTMENTS: ThresholdAdjustments = {\n\tpulseMultiplier: 1.0,\n\ttemperatureMultiplier: 1.0,\n\tpressureMultiplier: 1.0,\n\toxygenMultiplier: 1.0,\n};\n\n/** Calibration thresholds */\nexport const CALIBRATION_THRESHOLDS = {\n\t/** Minimum observations before starting calibration */\n\tMIN_OBSERVATIONS_TO_START: 5,\n\t/** Observations needed for full calibration */\n\tOBSERVATIONS_FOR_CALIBRATION: 20,\n\t/** Observations to lock calibration (stable) */\n\tOBSERVATIONS_TO_LOCK: 50,\n\t/** Confidence threshold to apply adjustments */\n\tCONFIDENCE_THRESHOLD: 0.7,\n} as const;\n\n// =============================================================================\n// TRAJECTORY PREDICTION\n// =============================================================================\n\n/** Predicted trajectory state */\nexport interface TrajectoryForecast {\n\t/** Current trajectory */\n\tcurrent: Trajectory;\n\t/** Predicted trajectory in 5 minutes */\n\tin5Minutes: Trajectory;\n\t/** Predicted trajectory in 10 minutes */\n\tin10Minutes: Trajectory;\n\t/** Confidence in predictions (0-1) */\n\tconfidence: number;\n\t/** Trend direction */\n\ttrend: \"improving\" | \"stable\" | \"worsening\";\n\t/** Time until next predicted state change (ms), null if stable */\n\ttimeToStateChange: number | null;\n}\n\n/** Prediction context used for forecasting */\nexport interface PredictionContext {\n\t/** Recent history (last N snapshots) */\n\trecentHistory: VitalsSnapshot[];\n\t/** Rate of pressure change (per minute) */\n\tpressureRate: number;\n\t/** Rate of oxygen change (per minute) */\n\toxygenRate: number;\n\t/** Temperature trend */\n\ttemperatureTrend: \"cooling\" | \"stable\" | \"heating\";\n\t/** Pulse trend */\n\tpulseTrend: \"slowing\" | \"stable\" | \"accelerating\";\n}\n\n// =============================================================================\n// PROACTIVE SUGGESTIONS\n// =============================================================================\n\n/** Urgency level for suggestions */\nexport type SuggestionUrgency = \"info\" | \"nudge\" | \"warning\" | \"urgent\";\n\n/** A proactive suggestion for the user */\nexport interface ProactiveSuggestion {\n\t/** Unique suggestion ID */\n\tid: string;\n\t/** Type of suggestion */\n\ttype: \"snapshot\" | \"pause\" | \"review\" | \"acknowledge\";\n\t/** Human-readable message */\n\tmessage: string;\n\t/** Urgency level */\n\turgency: SuggestionUrgency;\n\t/** Predicted time until critical (ms), null if not applicable */\n\ttimeUntilCritical: number | null;\n\t/** Whether user has dismissed this suggestion */\n\tdismissed: boolean;\n\t/** Timestamp when suggestion was generated */\n\tgeneratedAt: number;\n}\n\n// =============================================================================\n// STORAGE TYPES\n// =============================================================================\n\n/** Learning store for a workspace */\nexport interface VitalsLearningStore {\n\t/** Path to observations JSONL file */\n\tobservationsPath: string;\n\t/** Path to workspace profile JSON file */\n\tprofilePath: string;\n}\n\n// =============================================================================\n// EVENTS\n// =============================================================================\n\n/** Calibration event emitted when profile is updated */\nexport interface CalibrationEvent {\n\tworkspaceId: string;\n\tstatus: CalibrationStatus;\n\tprofile: WorkspaceProfile;\n}\n\n/** Suggestion event emitted when proactive suggestion is generated */\nexport interface SuggestionEvent {\n\tsuggestion: ProactiveSuggestion;\n\tforecast: TrajectoryForecast;\n}\n","/**\n * PhaseDetector - Development Phase Detection via Git Branch Analysis\n *\n * Analyzes git branch names to detect the current development phase and\n * adjusts snapshot thresholds accordingly. Different phases have different\n * risk profiles:\n *\n * - Hotfix: High risk, frequent snapshots (10 min intervals, 50 line max)\n * - Feature: Medium risk, moderate snapshots (15-30 min intervals, 300 line max)\n * - Refactor: Lower risk, less frequent (45-75 min intervals, 400 line max)\n * - Exploratory: Lowest urgency, milestone-based snapshots\n *\n * @packageDocumentation\n */\n\n/**\n * Development phase types detected from branch names\n */\nexport type DevelopmentPhase = \"hotfix\" | \"feature\" | \"refactor\" | \"exploratory\" | \"release\" | \"unknown\";\n\n/**\n * Threshold multipliers for each development phase\n * Lower multiplier = more protective (lower thresholds)\n */\nexport interface PhaseThresholds {\n\t/** Multiplier for snapshot interval (lower = more frequent) */\n\tintervalMultiplier: number;\n\t/** Maximum lines before forcing a snapshot */\n\tmaxLinesBeforeSnapshot: number;\n\t/** Risk multiplier for pressure calculations */\n\triskMultiplier: number;\n\t/** Recommended snapshot interval in minutes */\n\trecommendedIntervalMinutes: number;\n\t/** AI-adjusted interval in minutes */\n\taiAdjustedIntervalMinutes: number;\n}\n\n/**\n * Phase detection result\n */\nexport interface PhaseDetectionResult {\n\t/** Detected development phase */\n\tphase: DevelopmentPhase;\n\t/** Confidence score (0-1) */\n\tconfidence: number;\n\t/** Branch name that was analyzed */\n\tbranchName: string;\n\t/** Matched pattern (if any) */\n\tmatchedPattern?: string;\n\t/** Recommended thresholds for this phase */\n\tthresholds: PhaseThresholds;\n}\n\n/**\n * Branch patterns for phase detection\n */\nconst PHASE_PATTERNS: Record<DevelopmentPhase, RegExp[]> = {\n\thotfix: [/^hotfix\\//i, /^fix\\//i, /^bugfix\\//i, /^patch\\//i, /^urgent\\//i, /^emergency\\//i, /^critical\\//i],\n\tfeature: [/^feature\\//i, /^feat\\//i, /^add\\//i, /^implement\\//i, /^new\\//i, /^enhancement\\//i],\n\trefactor: [/^refactor\\//i, /^cleanup\\//i, /^tech-debt\\//i, /^improvement\\//i, /^optimize\\//i, /^chore\\//i],\n\trelease: [/^release\\//i, /^release-/i, /^v\\d+\\.\\d+/i, /^version\\//i],\n\texploratory: [/^experiment\\//i, /^spike\\//i, /^poc\\//i, /^prototype\\//i, /^try\\//i, /^test\\//i, /^wip\\//i],\n\tunknown: [], // No patterns - fallback\n};\n\n/**\n * Default thresholds per development phase\n * Based on research: different phases have different risk profiles\n */\nconst PHASE_THRESHOLDS: Record<DevelopmentPhase, PhaseThresholds> = {\n\thotfix: {\n\t\tintervalMultiplier: 0.5, // Most protective\n\t\tmaxLinesBeforeSnapshot: 50,\n\t\triskMultiplier: 1.5, // Higher risk sensitivity\n\t\trecommendedIntervalMinutes: 15,\n\t\taiAdjustedIntervalMinutes: 10,\n\t},\n\tfeature: {\n\t\tintervalMultiplier: 1.0, // Standard\n\t\tmaxLinesBeforeSnapshot: 300,\n\t\triskMultiplier: 1.0,\n\t\trecommendedIntervalMinutes: 45,\n\t\taiAdjustedIntervalMinutes: 20,\n\t},\n\trefactor: {\n\t\tintervalMultiplier: 1.5, // Less protective\n\t\tmaxLinesBeforeSnapshot: 400,\n\t\triskMultiplier: 0.8,\n\t\trecommendedIntervalMinutes: 90,\n\t\taiAdjustedIntervalMinutes: 60,\n\t},\n\trelease: {\n\t\tintervalMultiplier: 0.7, // More protective for releases\n\t\tmaxLinesBeforeSnapshot: 100,\n\t\triskMultiplier: 1.3,\n\t\trecommendedIntervalMinutes: 20,\n\t\taiAdjustedIntervalMinutes: 15,\n\t},\n\texploratory: {\n\t\tintervalMultiplier: 2.0, // Least protective\n\t\tmaxLinesBeforeSnapshot: 1000, // No effective limit\n\t\triskMultiplier: 0.5,\n\t\trecommendedIntervalMinutes: 120, // Milestone-based\n\t\taiAdjustedIntervalMinutes: 90,\n\t},\n\tunknown: {\n\t\tintervalMultiplier: 1.0, // Default/standard\n\t\tmaxLinesBeforeSnapshot: 300,\n\t\triskMultiplier: 1.0,\n\t\trecommendedIntervalMinutes: 45,\n\t\taiAdjustedIntervalMinutes: 25,\n\t},\n};\n\n/**\n * PhaseDetector - Detects development phase from git branch names\n *\n * @example\n * ```typescript\n * const detector = new PhaseDetector();\n * const result = detector.detectPhase('feature/add-user-auth');\n * console.log(result.phase); // 'feature'\n * console.log(result.thresholds.recommendedIntervalMinutes); // 45\n * ```\n */\n/**\n * Manual override configuration\n */\nexport interface PhaseOverride {\n\t/** Overridden phase */\n\tphase: DevelopmentPhase;\n\t/** Workspace ID this override applies to */\n\tworkspaceId: string;\n\t/** Expiry timestamp (null = never expires) */\n\texpiresAt: number | null;\n\t/** Reason for override */\n\treason?: string;\n}\n\nexport class PhaseDetector {\n\tprivate cachedPhase: PhaseDetectionResult | null = null;\n\tprivate lastBranch: string | null = null;\n\t/** Manual phase overrides by workspace */\n\tprivate overrides: Map<string, PhaseOverride> = new Map();\n\n\t/**\n\t * Detect development phase from branch name\n\t * Respects manual overrides when set for the workspace\n\t *\n\t * @param branchName - Git branch name (e.g., \"feature/add-auth\")\n\t * @param workspaceId - Optional workspace ID for override lookup\n\t * @returns Phase detection result with thresholds\n\t */\n\tdetectPhase(branchName: string, workspaceId?: string): PhaseDetectionResult {\n\t\t// Check for manual override first\n\t\tif (workspaceId) {\n\t\t\tconst override = this.getOverride(workspaceId);\n\t\t\tif (override) {\n\t\t\t\treturn {\n\t\t\t\t\tphase: override.phase,\n\t\t\t\t\tconfidence: 1.0, // Manual override is 100% confident\n\t\t\t\t\tbranchName,\n\t\t\t\t\tmatchedPattern: `manual:${override.reason ?? \"user-override\"}`,\n\t\t\t\t\tthresholds: PHASE_THRESHOLDS[override.phase],\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Use cache if branch hasn't changed\n\t\tif (this.lastBranch === branchName && this.cachedPhase) {\n\t\t\treturn this.cachedPhase;\n\t\t}\n\n\t\t// Check each phase pattern\n\t\tfor (const [phase, patterns] of Object.entries(PHASE_PATTERNS) as [DevelopmentPhase, RegExp[]][]) {\n\t\t\tfor (const pattern of patterns) {\n\t\t\t\tif (pattern.test(branchName)) {\n\t\t\t\t\tconst result: PhaseDetectionResult = {\n\t\t\t\t\t\tphase,\n\t\t\t\t\t\tconfidence: 0.9, // High confidence for pattern match\n\t\t\t\t\t\tbranchName,\n\t\t\t\t\t\tmatchedPattern: pattern.source,\n\t\t\t\t\t\tthresholds: PHASE_THRESHOLDS[phase],\n\t\t\t\t\t};\n\t\t\t\t\tthis.cachedPhase = result;\n\t\t\t\t\tthis.lastBranch = branchName;\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Fallback: try to infer from branch structure\n\t\tconst inferredPhase = this.inferPhaseFromStructure(branchName);\n\t\tconst result: PhaseDetectionResult = {\n\t\t\tphase: inferredPhase.phase,\n\t\t\tconfidence: inferredPhase.confidence,\n\t\t\tbranchName,\n\t\t\tthresholds: PHASE_THRESHOLDS[inferredPhase.phase],\n\t\t};\n\n\t\tthis.cachedPhase = result;\n\t\tthis.lastBranch = branchName;\n\t\treturn result;\n\t}\n\n\t/**\n\t * Infer phase from branch structure when no pattern matches\n\t */\n\tprivate inferPhaseFromStructure(branchName: string): { phase: DevelopmentPhase; confidence: number } {\n\t\t// Main/master branches are typically feature work\n\t\tif (branchName === \"main\" || branchName === \"master\" || branchName === \"develop\") {\n\t\t\treturn { phase: \"feature\", confidence: 0.6 };\n\t\t}\n\n\t\t// Branches with ticket numbers often indicate feature work\n\t\tif (/[A-Z]+-\\d+/.test(branchName)) {\n\t\t\treturn { phase: \"feature\", confidence: 0.5 };\n\t\t}\n\n\t\t// Branches with \"fix\" or \"bug\" in the name\n\t\tif (/fix|bug/i.test(branchName)) {\n\t\t\treturn { phase: \"hotfix\", confidence: 0.6 };\n\t\t}\n\n\t\t// Branches with version numbers\n\t\tif (/\\d+\\.\\d+/.test(branchName)) {\n\t\t\treturn { phase: \"release\", confidence: 0.5 };\n\t\t}\n\n\t\treturn { phase: \"unknown\", confidence: 0.3 };\n\t}\n\n\t/**\n\t * Get threshold multiplier for current phase\n\t * Used by ThresholdCalibrator to adjust vitals thresholds\n\t */\n\tgetThresholdMultiplier(branchName: string): number {\n\t\tconst detection = this.detectPhase(branchName);\n\t\treturn detection.thresholds.intervalMultiplier;\n\t}\n\n\t/**\n\t * Get risk multiplier for current phase\n\t * Used to adjust pressure calculations\n\t */\n\tgetRiskMultiplier(branchName: string): number {\n\t\tconst detection = this.detectPhase(branchName);\n\t\treturn detection.thresholds.riskMultiplier;\n\t}\n\n\t/**\n\t * Check if current phase requires more frequent snapshots\n\t */\n\trequiresFrequentSnapshots(branchName: string): boolean {\n\t\tconst detection = this.detectPhase(branchName);\n\t\treturn detection.phase === \"hotfix\" || detection.phase === \"release\";\n\t}\n\n\t/**\n\t * Get recommended snapshot interval based on phase\n\t * @param aiActive - Whether AI tools are currently active\n\t */\n\tgetRecommendedInterval(branchName: string, aiActive: boolean): number {\n\t\tconst detection = this.detectPhase(branchName);\n\t\treturn aiActive\n\t\t\t? detection.thresholds.aiAdjustedIntervalMinutes\n\t\t\t: detection.thresholds.recommendedIntervalMinutes;\n\t}\n\n\t/**\n\t * Check if lines changed exceeds phase threshold\n\t */\n\texceedsLineThreshold(branchName: string, linesChanged: number): boolean {\n\t\tconst detection = this.detectPhase(branchName);\n\t\treturn linesChanged >= detection.thresholds.maxLinesBeforeSnapshot;\n\t}\n\n\t/**\n\t * Clear cached detection (for testing or branch changes)\n\t */\n\tclearCache(): void {\n\t\tthis.cachedPhase = null;\n\t\tthis.lastBranch = null;\n\t}\n\n\t// =========================================================================\n\t// MANUAL PHASE OVERRIDE (workspace-scoped with expiry)\n\t// =========================================================================\n\n\t/**\n\t * Set manual phase override for a workspace\n\t * Useful when cross-branch work doesn't match branch name\n\t *\n\t * @param workspaceId - Workspace identifier\n\t * @param phase - Phase to force\n\t * @param expiryMinutes - Minutes until override expires (null = never)\n\t * @param reason - Optional reason for the override\n\t */\n\tsetOverride(\n\t\tworkspaceId: string,\n\t\tphase: DevelopmentPhase,\n\t\texpiryMinutes: number | null = 120, // Default 2 hours\n\t\treason?: string,\n\t): void {\n\t\tconst expiresAt = expiryMinutes !== null ? Date.now() + expiryMinutes * 60 * 1000 : null;\n\t\tthis.overrides.set(workspaceId, {\n\t\t\tphase,\n\t\t\tworkspaceId,\n\t\t\texpiresAt,\n\t\t\treason,\n\t\t});\n\t\t// Clear cache to force re-detection\n\t\tthis.clearCache();\n\t}\n\n\t/**\n\t * Remove manual phase override for a workspace\n\t */\n\tclearOverride(workspaceId: string): void {\n\t\tthis.overrides.delete(workspaceId);\n\t\tthis.clearCache();\n\t}\n\n\t/**\n\t * Get current override for a workspace (if valid)\n\t * Automatically clears expired overrides\n\t */\n\tgetOverride(workspaceId: string): PhaseOverride | null {\n\t\tconst override = this.overrides.get(workspaceId);\n\t\tif (!override) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check expiry\n\t\tif (override.expiresAt !== null && Date.now() > override.expiresAt) {\n\t\t\tthis.overrides.delete(workspaceId);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn override;\n\t}\n\n\t/**\n\t * Check if workspace has an active override\n\t */\n\thasOverride(workspaceId: string): boolean {\n\t\treturn this.getOverride(workspaceId) !== null;\n\t}\n\n\t/**\n\t * Get all active overrides (for debugging/UI)\n\t */\n\tgetAllOverrides(): PhaseOverride[] {\n\t\tconst now = Date.now();\n\t\tconst active: PhaseOverride[] = [];\n\n\t\tfor (const [id, override] of this.overrides) {\n\t\t\tif (override.expiresAt !== null && now > override.expiresAt) {\n\t\t\t\tthis.overrides.delete(id);\n\t\t\t} else {\n\t\t\t\tactive.push(override);\n\t\t\t}\n\t\t}\n\n\t\treturn active;\n\t}\n\n\t// =========================================================================\n\t// PERSISTENCE (Workspace State)\n\t// =========================================================================\n\n\t/**\n\t * Serialize overrides to JSON-safe format for workspace state persistence\n\t * Automatically removes expired overrides during serialization\n\t *\n\t * @returns Record of active workspace overrides\n\t */\n\tserializeOverrides(): Record<string, PhaseOverride> {\n\t\tconst now = Date.now();\n\t\tconst active: Record<string, PhaseOverride> = {};\n\n\t\tfor (const [id, override] of this.overrides) {\n\t\t\t// Skip expired overrides\n\t\t\tif (override.expiresAt !== null && now > override.expiresAt) {\n\t\t\t\tthis.overrides.delete(id);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tactive[id] = override;\n\t\t}\n\n\t\treturn active;\n\t}\n\n\t/**\n\t * Restore overrides from persisted workspace state\n\t * Validates structure and removes already-expired entries\n\t *\n\t * @param data Persisted overrides record\n\t */\n\tdeserializeOverrides(data: Record<string, PhaseOverride>): void {\n\t\tconst now = Date.now();\n\t\tthis.overrides.clear();\n\n\t\tfor (const [id, override] of Object.entries(data)) {\n\t\t\t// Validate structure\n\t\t\tif (!override.phase || !override.workspaceId) {\n\t\t\t\tcontinue; // Skip invalid entries\n\t\t\t}\n\n\t\t\t// Skip already-expired\n\t\t\tif (override.expiresAt !== null && now > override.expiresAt) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis.overrides.set(id, override);\n\t\t}\n\t}\n\n\t/**\n\t * Get all available thresholds for reference\n\t */\n\tstatic getPhaseThresholds(): Record<DevelopmentPhase, PhaseThresholds> {\n\t\treturn { ...PHASE_THRESHOLDS };\n\t}\n\n\t/**\n\t * Get all available patterns for reference\n\t */\n\tstatic getPhasePatterns(): Record<DevelopmentPhase, string[]> {\n\t\tconst result: Record<DevelopmentPhase, string[]> = {} as any;\n\t\tfor (const [phase, patterns] of Object.entries(PHASE_PATTERNS)) {\n\t\t\tresult[phase as DevelopmentPhase] = patterns.map((p) => p.source);\n\t\t}\n\t\treturn result;\n\t}\n}\n","/**\n * SnapshotSuggester - Phase 4 Feature\n * Provides proactive snapshot suggestions based on vitals trajectory analysis.\n */\n\nimport type { Trajectory, VitalsSnapshot } from \"../../types/vitals.js\";\nimport type { TrajectoryForecast } from \"../../types/vitals-learning.js\";\n\nexport interface SnapshotSuggestion {\n\t/** Recommendation score (0-100, higher = more urgent) */\n\turgency: number;\n\t/** Reason for the suggestion */\n\treason: string;\n\t/** Recommended action */\n\trecommendation: \"now\" | \"soon\" | \"monitor\";\n\t/** Supporting metrics */\n\tmetrics: {\n\t\tpressureRate: number;\n\t\taiActivityBurst: boolean;\n\t\tcriticalFilesTouched: number;\n\t\ttrajectoryConfidence: number;\n\t};\n}\n\nexport class SnapshotSuggester {\n\tprivate snapshotHistory: Array<{ timestamp: number; trajectory: Trajectory }> = [];\n\tprivate readonly maxHistorySize = 50;\n\n\t/**\n\t * Analyze current vitals and suggest snapshot\n\t */\n\tsuggestSnapshot(snapshot: VitalsSnapshot, forecast: TrajectoryForecast | null): SnapshotSuggestion {\n\t\tconst metrics = this.buildMetrics(snapshot, forecast);\n\t\tconst urgency = this.scoreUrgency(metrics);\n\t\tconst { reason, recommendation } = this.buildRecommendation(urgency, metrics);\n\n\t\tthis.recordSnapshot(snapshot);\n\t\treturn { urgency, reason, recommendation, metrics };\n\t}\n\n\t/**\n\t * Build metrics from vitals and forecast\n\t */\n\tprivate buildMetrics(snapshot: VitalsSnapshot, forecast: TrajectoryForecast | null): SnapshotSuggestion[\"metrics\"] {\n\t\tconst lastSnapshot = this.snapshotHistory[this.snapshotHistory.length - 1];\n\t\tconst timeDiffMinutes = lastSnapshot ? (snapshot.timestamp - lastSnapshot.timestamp) / 60000 : 0;\n\n\t\treturn {\n\t\t\tpressureRate: timeDiffMinutes > 0 ? snapshot.pressure.value / timeDiffMinutes : 0,\n\t\t\taiActivityBurst:\n\t\t\t\tsnapshot.temperature.aiPercentage > 70 && (lastSnapshot?.trajectory ?? \"stable\") === \"stable\",\n\t\t\tcriticalFilesTouched: snapshot.pressure.criticalFilesTouched.length,\n\t\t\ttrajectoryConfidence: forecast?.confidence ?? this.calculateConsistency(),\n\t\t};\n\t}\n\n\t/**\n\t * Calculate urgency score (0-100)\n\t */\n\tprivate scoreUrgency(m: SnapshotSuggestion[\"metrics\"]): number {\n\t\treturn Math.min(\n\t\t\tMath.min(m.pressureRate * 5, 40) +\n\t\t\t\t(m.aiActivityBurst ? 20 : 0) +\n\t\t\t\tMath.min(m.criticalFilesTouched * 5, 25) +\n\t\t\t\t(1 - m.trajectoryConfidence) * 15,\n\t\t\t100,\n\t\t);\n\t}\n\n\t/**\n\t * Build recommendation from urgency and metrics\n\t */\n\tprivate buildRecommendation(\n\t\turgency: number,\n\t\tm: SnapshotSuggestion[\"metrics\"],\n\t): { reason: string; recommendation: \"now\" | \"soon\" | \"monitor\" } {\n\t\tconst reasons = {\n\t\t\tnow: [\n\t\t\t\tm.aiActivityBurst && \"AI activity spike detected\",\n\t\t\t\tm.criticalFilesTouched > 0 && \"critical files modified\",\n\t\t\t\tm.pressureRate > 10 && \"rapid risk escalation\",\n\t\t\t].filter(Boolean),\n\t\t\tsoon: [\n\t\t\t\tm.pressureRate > 5 && \"moderate pressure increase\",\n\t\t\t\tm.trajectoryConfidence < 0.6 && \"uncertain trajectory\",\n\t\t\t].filter(Boolean),\n\t\t};\n\n\t\tif (urgency >= 75) {\n\t\t\treturn {\n\t\t\t\trecommendation: \"now\",\n\t\t\t\treason: `Create snapshot immediately: ${reasons.now.join(\", \")}`,\n\t\t\t};\n\t\t}\n\t\tif (urgency >= 50) {\n\t\t\treturn {\n\t\t\t\trecommendation: \"soon\",\n\t\t\t\treason: `Create snapshot soon: ${reasons.soon.join(\", \")}`,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\trecommendation: \"monitor\",\n\t\t\treason: \"Current state is stable. Continue monitoring.\",\n\t\t};\n\t}\n\n\t/**\n\t * Calculate trajectory consistency from history\n\t */\n\tprivate calculateConsistency(): number {\n\t\tif (this.snapshotHistory.length < 2) {\n\t\t\treturn 0.5;\n\t\t}\n\t\tconst recent = this.snapshotHistory.slice(-5);\n\t\treturn recent.filter((s) => s.trajectory === \"stable\").length / recent.length;\n\t}\n\n\t/**\n\t * Record snapshot in history\n\t */\n\tprivate recordSnapshot(snapshot: VitalsSnapshot): void {\n\t\tthis.snapshotHistory.push({\n\t\t\ttimestamp: snapshot.timestamp,\n\t\t\ttrajectory: snapshot.trajectory,\n\t\t});\n\t\tif (this.snapshotHistory.length > this.maxHistorySize) {\n\t\t\tthis.snapshotHistory.shift();\n\t\t}\n\t}\n\n\treset(): void {\n\t\tthis.snapshotHistory = [];\n\t}\n}\n","/**\n * TeamAggregator - Phase 4 Feature\n * Aggregates behavioral metrics across team members for multi-user workspaces.\n */\n\nimport type { BehavioralMetadata } from \"../../types/vitals.js\";\n\nexport interface UserMetrics {\n\tuserId: string;\n\tusername: string;\n\tmetadata: BehavioralMetadata;\n\ttimestamp: number;\n}\n\nexport interface TeamAggregation {\n\tteamId: string;\n\taggregationTime: number;\n\tmemberCount: number;\n\tmetrics: {\n\t\tavgAIAcceptanceRate: number;\n\t\tavgChurnRate: number;\n\t\tavgTestPassRate: number;\n\t\tavgSessionDuration: number;\n\t\ttotalFileSaves: number;\n\t\ttotalAISuggestions: number;\n\t};\n\tdistribution: {\n\t\taiAcceptanceRate: DistributionStats;\n\t\tchurnRate: DistributionStats;\n\t\ttestPassRate: DistributionStats;\n\t};\n\ttopContributors: Array<{\n\t\tuserId: string;\n\t\tusername: string;\n\t\tscore: number;\n\t\treason: string;\n\t}>;\n\tconcerns: TeamConcern[];\n}\n\nexport interface DistributionStats {\n\tmin: number;\n\tmax: number;\n\tmean: number;\n\tmedian: number;\n\tstdDev: number;\n}\n\nexport interface TeamConcern {\n\ttype: \"low_test_coverage\" | \"high_churn\" | \"low_ai_adoption\" | \"anomaly\";\n\tseverity: \"low\" | \"medium\" | \"high\";\n\taffectedUsers: string[];\n\tdescription: string;\n\trecommendation: string;\n}\n\nexport interface UserComparison {\n\tuserId: string;\n\tusername: string;\n\tmetrics: BehavioralMetadata;\n\tcomparison: {\n\t\taiAcceptanceRate: { value: number; vsTeam: number };\n\t\tchurnRate: { value: number; vsTeam: number };\n\t\ttestPassRate: { value: number; vsTeam: number };\n\t\tsessionDuration: { value: number; vsTeam: number };\n\t};\n\tstatus: \"exceeding\" | \"average\" | \"below_average\" | \"concerning\";\n}\n\nexport class TeamAggregator {\n\tprivate userMetrics: Map<string, UserMetrics> = new Map();\n\n\tconstructor(private teamId: string) {}\n\n\trecordUserMetrics(userId: string, username: string, metadata: BehavioralMetadata): void {\n\t\tthis.userMetrics.set(userId, { userId, username, metadata, timestamp: Date.now() });\n\t}\n\n\tgetTeamAggregation(): TeamAggregation {\n\t\tconst users = Array.from(this.userMetrics.values());\n\t\tif (users.length === 0) {\n\t\t\treturn this.getEmptyAggregation();\n\t\t}\n\n\t\tconst metrics = this.aggregateMetrics(users);\n\t\tconst distribution = this.getDistribution(users);\n\n\t\treturn {\n\t\t\tteamId: this.teamId,\n\t\t\taggregationTime: Date.now(),\n\t\t\tmemberCount: users.length,\n\t\t\tmetrics,\n\t\t\tdistribution,\n\t\t\ttopContributors: this.getTopContributors(users),\n\t\t\tconcerns: this.detectConcerns(users, metrics),\n\t\t};\n\t}\n\n\tgetUserComparison(userId: string): UserComparison | null {\n\t\tconst user = this.userMetrics.get(userId);\n\t\tif (!user) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst teamAgg = this.getTeamAggregation();\n\t\tconst m = user.metadata;\n\t\tconst t = teamAgg.metrics;\n\n\t\treturn {\n\t\t\tuserId,\n\t\t\tusername: user.username,\n\t\t\tmetrics: m,\n\t\t\tcomparison: {\n\t\t\t\taiAcceptanceRate: { value: m.aiAcceptanceRate, vsTeam: t.avgAIAcceptanceRate },\n\t\t\t\tchurnRate: { value: m.churnRate, vsTeam: t.avgChurnRate },\n\t\t\t\ttestPassRate: { value: m.testPassRate, vsTeam: t.avgTestPassRate },\n\t\t\t\tsessionDuration: { value: m.sessionDuration, vsTeam: t.avgSessionDuration },\n\t\t\t},\n\t\t\tstatus: this.determineStatus(m, t),\n\t\t};\n\t}\n\n\t/**\n\t * Aggregate metrics with cleaner reducer pattern\n\t */\n\tprivate aggregateMetrics(users: UserMetrics[]) {\n\t\tconst sum = <K extends keyof BehavioralMetadata>(key: K) =>\n\t\t\tusers.reduce((acc, u) => acc + (u.metadata[key] as number), 0);\n\n\t\tconst count = users.length;\n\n\t\treturn {\n\t\t\tavgAIAcceptanceRate: sum(\"aiAcceptanceRate\") / count,\n\t\t\tavgChurnRate: sum(\"churnRate\") / count,\n\t\t\tavgTestPassRate: sum(\"testPassRate\") / count,\n\t\t\tavgSessionDuration: sum(\"sessionDuration\") / count,\n\t\t\ttotalFileSaves: sum(\"fileSaveCount\"),\n\t\t\ttotalAISuggestions: sum(\"aiSuggestionsShown\"),\n\t\t};\n\t}\n\n\t/**\n\t * Get distribution statistics for key metrics\n\t */\n\tprivate getDistribution(users: UserMetrics[]) {\n\t\tconst stats = (key: keyof BehavioralMetadata): DistributionStats => {\n\t\t\tconst values = users.map((u) => u.metadata[key]).filter((v): v is number => typeof v === \"number\");\n\n\t\t\tif (values.length === 0) {\n\t\t\t\treturn { min: 0, max: 0, mean: 0, median: 0, stdDev: 0 };\n\t\t\t}\n\n\t\t\tconst sorted = [...values].sort((a, b) => a - b);\n\t\t\tconst mean = values.reduce((a, b) => a + b, 0) / values.length;\n\t\t\tconst variance = values.reduce((sum, v) => sum + (v - mean) ** 2, 0) / values.length;\n\n\t\t\treturn {\n\t\t\t\tmin: sorted[0],\n\t\t\t\tmax: sorted[sorted.length - 1],\n\t\t\t\tmean,\n\t\t\t\tmedian: sorted[Math.floor(sorted.length / 2)],\n\t\t\t\tstdDev: Math.sqrt(variance),\n\t\t\t};\n\t\t};\n\n\t\treturn {\n\t\t\taiAcceptanceRate: stats(\"aiAcceptanceRate\"),\n\t\t\tchurnRate: stats(\"churnRate\"),\n\t\t\ttestPassRate: stats(\"testPassRate\"),\n\t\t};\n\t}\n\n\t/**\n\t * Identify top contributing team members with scoring\n\t */\n\tprivate getTopContributors(users: UserMetrics[]): TeamAggregation[\"topContributors\"] {\n\t\tconst scored = users.map((u) => {\n\t\t\tconst m = u.metadata;\n\t\t\tconst score =\n\t\t\t\tm.aiAcceptanceRate * 30 +\n\t\t\t\tm.testPassRate * 30 +\n\t\t\t\t(1 - Math.min(m.churnRate / 50, 1)) * 20 +\n\t\t\t\t(m.sessionDuration / 3600000) * 20;\n\n\t\t\tconst reasons: Record<string, boolean> = {\n\t\t\t\t\"High AI adoption and acceptance\": m.aiAcceptanceRate > 0.7,\n\t\t\t\t\"Strong test coverage and quality\": m.testPassRate > 0.8,\n\t\t\t\t\"Stable, focused development\": m.churnRate < 5,\n\t\t\t};\n\t\t\tconst reason = Object.entries(reasons).find(([, v]) => v)?.[0] ?? \"Consistent contributor\";\n\n\t\t\treturn { userId: u.userId, username: u.username, score, reason };\n\t\t});\n\n\t\treturn scored.sort((a, b) => b.score - a.score).slice(0, 5);\n\t}\n\n\t/**\n\t * Detect team-wide concerns\n\t */\n\tprivate detectConcerns(users: UserMetrics[], metrics: TeamAggregation[\"metrics\"]): TeamConcern[] {\n\t\tconst concerns: TeamConcern[] = [];\n\t\tconst LOW_TEST = users.filter((u) => u.metadata.testPassRate < 0.5);\n\t\tconst HIGH_CHURN = users.filter((u) => u.metadata.churnRate > 20);\n\n\t\tif (LOW_TEST.length > users.length * 0.3) {\n\t\t\tconcerns.push({\n\t\t\t\ttype: \"low_test_coverage\",\n\t\t\t\tseverity: \"high\",\n\t\t\t\taffectedUsers: LOW_TEST.map((u) => u.username),\n\t\t\t\tdescription: `${LOW_TEST.length} team members have test pass rates below 50%`,\n\t\t\t\trecommendation: \"Encourage test-driven development and pair programming sessions\",\n\t\t\t});\n\t\t}\n\n\t\tif (HIGH_CHURN.length > 0) {\n\t\t\tconcerns.push({\n\t\t\t\ttype: \"high_churn\",\n\t\t\t\tseverity: HIGH_CHURN.length > users.length * 0.3 ? \"high\" : \"medium\",\n\t\t\t\taffectedUsers: HIGH_CHURN.map((u) => u.username),\n\t\t\t\tdescription: `${HIGH_CHURN.length} team members showing high code churn (>20 lines/min)`,\n\t\t\t\trecommendation: \"Review code complexity and consider refactoring sessions\",\n\t\t\t});\n\t\t}\n\n\t\tif (metrics.avgAIAcceptanceRate < 0.3) {\n\t\t\tconcerns.push({\n\t\t\t\ttype: \"low_ai_adoption\",\n\t\t\t\tseverity: \"medium\",\n\t\t\t\taffectedUsers: users.filter((u) => u.metadata.aiAcceptanceRate < 0.2).map((u) => u.username),\n\t\t\t\tdescription: \"Team AI acceptance rate is below 30%\",\n\t\t\t\trecommendation: \"Provide AI tool training and integrate AI suggestions into workflow\",\n\t\t\t});\n\t\t}\n\n\t\treturn concerns;\n\t}\n\n\t/**\n\t * Determine user status relative to team baseline\n\t */\n\tprivate determineStatus(user: BehavioralMetadata, team: TeamAggregation[\"metrics\"]): UserComparison[\"status\"] {\n\t\tconst score = [\n\t\t\tuser.aiAcceptanceRate >= team.avgAIAcceptanceRate ? 1 : 0,\n\t\t\tuser.testPassRate >= team.avgTestPassRate ? 1 : 0,\n\t\t\tuser.churnRate <= team.avgChurnRate ? 1 : 0,\n\t\t].reduce((a, b) => a + b, 0);\n\n\t\treturn score === 3 ? \"exceeding\" : score === 2 ? \"average\" : score === 1 ? \"below_average\" : \"concerning\";\n\t}\n\n\tprivate getEmptyAggregation(): TeamAggregation {\n\t\tconst empty = { min: 0, max: 0, mean: 0, median: 0, stdDev: 0 };\n\n\t\treturn {\n\t\t\tteamId: this.teamId,\n\t\t\taggregationTime: Date.now(),\n\t\t\tmemberCount: 0,\n\t\t\tmetrics: {\n\t\t\t\tavgAIAcceptanceRate: 0,\n\t\t\t\tavgChurnRate: 0,\n\t\t\t\tavgTestPassRate: 0,\n\t\t\t\tavgSessionDuration: 0,\n\t\t\t\ttotalFileSaves: 0,\n\t\t\t\ttotalAISuggestions: 0,\n\t\t\t},\n\t\t\tdistribution: {\n\t\t\t\taiAcceptanceRate: empty,\n\t\t\t\tchurnRate: empty,\n\t\t\t\ttestPassRate: empty,\n\t\t\t},\n\t\t\ttopContributors: [],\n\t\t\tconcerns: [],\n\t\t};\n\t}\n\n\treset(): void {\n\t\tthis.userMetrics.clear();\n\t}\n}\n","/**\n * ThresholdCalibrator - Per-workspace threshold calibration\n *\n * Adjusts vitals thresholds based on observed user behavior patterns.\n * Conservative users get stricter thresholds, aggressive users get relaxed thresholds.\n *\n * @lifecycle uncalibrated  learning  calibrated  locked\n * @performance Budget: <10ms for updateFromBehavior(), <5ms for getAdjustedThresholds()\n */\n\nimport type { CalibrationStatus, ThresholdAdjustments, WorkspaceProfile } from \"../../types/vitals-learning.js\";\nimport { CALIBRATION_THRESHOLDS, DEFAULT_THRESHOLD_ADJUSTMENTS } from \"../../types/vitals-learning.js\";\nimport type { UserBehaviorLearner } from \"./UserBehaviorLearner.js\";\n\n/** Clamp value to range */\nfunction clamp(value: number, min: number, max: number): number {\n\treturn Math.max(min, Math.min(max, value));\n}\n\n/**\n * Calibrates per-workspace thresholds based on user behavior.\n */\nexport class ThresholdCalibrator {\n\tprivate readonly workspaceId: string;\n\tprivate readonly learner: UserBehaviorLearner;\n\n\tprivate profile: WorkspaceProfile;\n\n\tconstructor(workspaceId: string, learner: UserBehaviorLearner) {\n\t\tthis.workspaceId = workspaceId;\n\t\tthis.learner = learner;\n\n\t\t// Initialize with uncalibrated profile\n\t\tthis.profile = this.createInitialProfile();\n\t}\n\n\t/**\n\t * Create initial uncalibrated profile.\n\t */\n\tprivate createInitialProfile(): WorkspaceProfile {\n\t\treturn {\n\t\t\tworkspaceId: this.workspaceId,\n\t\t\tstatus: \"uncalibrated\",\n\t\t\tobservationCount: 0,\n\t\t\tthresholdAdjustments: { ...DEFAULT_THRESHOLD_ADJUSTMENTS },\n\t\t\triskTolerance: 0.5, // Neutral\n\t\t\ttypicalPulseLevel: 0,\n\t\t\tsnapshotFrequency: 0,\n\t\t\tlastCalibratedAt: 0,\n\t\t\tconfidence: 0,\n\t\t};\n\t}\n\n\t/**\n\t * Update calibration from behavior learner's observations.\n\t */\n\tupdateFromBehavior(): void {\n\t\tconst stats = this.learner.getStats();\n\t\tconst observations = this.learner.getObservations();\n\n\t\tthis.profile.observationCount = stats.totalObservations;\n\n\t\t// Update status based on observation count\n\t\tthis.profile.status = this.calculateStatus(stats.totalObservations);\n\n\t\t// Calculate risk tolerance (0 = conservative, 1 = aggressive)\n\t\tthis.profile.riskTolerance = this.calculateRiskTolerance(stats);\n\n\t\t// Calculate confidence\n\t\tthis.profile.confidence = this.calculateConfidence(stats);\n\n\t\t// Calculate typical pulse level\n\t\tthis.profile.typicalPulseLevel = this.calculateTypicalPulseLevel(observations);\n\n\t\t// Update threshold adjustments if we have enough data\n\t\tif (this.profile.status !== \"uncalibrated\") {\n\t\t\tthis.profile.thresholdAdjustments = this.calculateAdjustments(stats);\n\t\t\tthis.profile.lastCalibratedAt = Date.now();\n\t\t}\n\t}\n\n\t/**\n\t * Calculate calibration status from observation count.\n\t */\n\tprivate calculateStatus(count: number): CalibrationStatus {\n\t\tif (count >= CALIBRATION_THRESHOLDS.OBSERVATIONS_TO_LOCK) {\n\t\t\treturn \"locked\";\n\t\t}\n\t\tif (count >= CALIBRATION_THRESHOLDS.OBSERVATIONS_FOR_CALIBRATION) {\n\t\t\treturn \"calibrated\";\n\t\t}\n\t\tif (count >= CALIBRATION_THRESHOLDS.MIN_OBSERVATIONS_TO_START) {\n\t\t\treturn \"learning\";\n\t\t}\n\t\treturn \"uncalibrated\";\n\t}\n\n\t/**\n\t * Calculate risk tolerance from behavior stats.\n\t * 0 = conservative (early snapshots), 0.5 = balanced, 1 = aggressive (missed/late)\n\t */\n\tprivate calculateRiskTolerance(stats: {\n\t\ttotalObservations: number;\n\t\tearlySnapshots: number;\n\t\tlateSnapshots: number;\n\t\tmissedRecommendations: number;\n\t}): number {\n\t\tif (stats.totalObservations === 0) {\n\t\t\treturn 0.5;\n\t\t}\n\n\t\t// Early  conservative (0), Late/Missed  aggressive (1)\n\t\tconst earlyRatio = stats.earlySnapshots / stats.totalObservations;\n\t\tconst aggressiveRatio = (stats.lateSnapshots + stats.missedRecommendations) / stats.totalObservations;\n\n\t\t// Scale: 0 (all early)  0.5 (balanced)  1 (all missed/late)\n\t\tif (earlyRatio > aggressiveRatio) {\n\t\t\t// Conservative bias\n\t\t\treturn 0.5 - earlyRatio * 0.5;\n\t\t}\n\t\tif (aggressiveRatio > earlyRatio) {\n\t\t\t// Aggressive bias\n\t\t\treturn 0.5 + aggressiveRatio * 0.5;\n\t\t}\n\t\treturn 0.5; // Balanced\n\t}\n\n\t/**\n\t * Calculate confidence in calibration.\n\t */\n\tprivate calculateConfidence(stats: {\n\t\ttotalObservations: number;\n\t\tearlySnapshots: number;\n\t\talignedSnapshots: number;\n\t\tlateSnapshots: number;\n\t\tmissedRecommendations: number;\n\t\triskProfile: string;\n\t}): number {\n\t\tif (stats.totalObservations === 0) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst count = stats.totalObservations;\n\n\t\t// Base confidence from observation count\n\t\tconst countConfidence = Math.min(count / CALIBRATION_THRESHOLDS.OBSERVATIONS_FOR_CALIBRATION, 1.0);\n\n\t\t// Consistency confidence - how dominant is the primary behavior?\n\t\tconst behaviors = [\n\t\t\tstats.earlySnapshots,\n\t\t\tstats.alignedSnapshots,\n\t\t\tstats.lateSnapshots,\n\t\t\tstats.missedRecommendations,\n\t\t];\n\t\tconst maxBehavior = Math.max(...behaviors);\n\t\tconst consistency = count > 0 ? maxBehavior / count : 0;\n\n\t\t// Entropy penalty: penalize when multiple behaviors are present\n\t\t// A truly consistent user should have >60% in one category\n\t\tconst entropyPenalty = consistency < 0.6 ? 0.15 : 0;\n\n\t\t// Combined confidence (weight count more initially, consistency more later)\n\t\tconst confidence = countConfidence * 0.6 + consistency * 0.4 - entropyPenalty;\n\n\t\treturn clamp(confidence, 0, 1);\n\t}\n\n\t/**\n\t * Calculate typical pulse level from observations.\n\t */\n\tprivate calculateTypicalPulseLevel(\n\t\tobservations: Array<{ vitals: { pulse: { changesPerMinute: number } } }>,\n\t): number {\n\t\tif (observations.length === 0) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst total = observations.reduce((sum, obs) => sum + obs.vitals.pulse.changesPerMinute, 0);\n\t\treturn total / observations.length;\n\t}\n\n\t/**\n\t * Calculate threshold adjustments based on risk profile.\n\t */\n\tprivate calculateAdjustments(stats: { riskProfile: string }): ThresholdAdjustments {\n\t\t// Base multiplier from risk profile\n\t\tlet baseMultiplier: number;\n\n\t\tswitch (stats.riskProfile) {\n\t\t\tcase \"conservative\":\n\t\t\t\t// Lower thresholds = more sensitive/protective\n\t\t\t\tbaseMultiplier = 0.7;\n\t\t\t\tbreak;\n\t\t\tcase \"aggressive\":\n\t\t\t\t// Higher thresholds = less nagging\n\t\t\t\tbaseMultiplier = 1.3;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbaseMultiplier = 1.0;\n\t\t}\n\n\t\t// Clamp to safe range\n\t\tconst clampedMultiplier = clamp(baseMultiplier, 0.5, 2.0);\n\n\t\treturn {\n\t\t\tpulseMultiplier: clampedMultiplier,\n\t\t\ttemperatureMultiplier: clampedMultiplier,\n\t\t\tpressureMultiplier: clampedMultiplier,\n\t\t\toxygenMultiplier: clampedMultiplier,\n\t\t};\n\t}\n\n\t/**\n\t * Get the current workspace profile.\n\t */\n\tgetProfile(): WorkspaceProfile {\n\t\treturn { ...this.profile };\n\t}\n\n\t/**\n\t * Get adjusted thresholds for use in vitals calculations.\n\t * Returns defaults if uncalibrated.\n\t */\n\tgetAdjustedThresholds(): ThresholdAdjustments {\n\t\tif (this.profile.status === \"uncalibrated\") {\n\t\t\treturn { ...DEFAULT_THRESHOLD_ADJUSTMENTS };\n\t\t}\n\t\treturn { ...this.profile.thresholdAdjustments };\n\t}\n\n\t/**\n\t * Reset calibration to initial state.\n\t */\n\treset(): void {\n\t\tthis.profile = this.createInitialProfile();\n\t\tthis.learner.reset();\n\t}\n}\n","/**\n * TrajectoryPredictor - Forecasts trajectory changes\n *\n * Analyzes vitals history to predict future states and time to critical.\n * Uses simple linear regression on pressure/oxygen rates.\n *\n * @performance Budget: <10ms for predict()\n */\n\nimport type { Trajectory, VitalsSnapshot } from \"../../types/vitals.js\";\nimport type { PredictionContext, TrajectoryForecast } from \"../../types/vitals-learning.js\";\n\n/** Clamp value to range */\nfunction clamp(value: number, min: number, max: number): number {\n\treturn Math.max(min, Math.min(max, value));\n}\n\n/**\n * Predicts trajectory changes based on vitals history.\n */\nexport class TrajectoryPredictor {\n\t// biome-ignore lint/correctness/noUnusedPrivateClassMembers: stored for context/debugging\n\tprivate readonly workspaceId: string;\n\tprivate history: VitalsSnapshot[] = [];\n\tprivate readonly maxHistory = 100;\n\n\tconstructor(workspaceId: string) {\n\t\tthis.workspaceId = workspaceId;\n\t}\n\n\t/**\n\t * Record vitals snapshots for prediction.\n\t */\n\trecordSnapshots(snapshots: VitalsSnapshot[]): void {\n\t\tthis.history.push(...snapshots);\n\n\t\t// Limit history size\n\t\tif (this.history.length > this.maxHistory) {\n\t\t\tthis.history = this.history.slice(-this.maxHistory);\n\t\t}\n\t}\n\n\t/**\n\t * Predict trajectory changes.\n\t */\n\tpredict(): TrajectoryForecast {\n\t\tif (this.history.length === 0) {\n\t\t\treturn this.createDefaultForecast();\n\t\t}\n\n\t\tconst context = this.calculateContext();\n\t\tconst current = this.getCurrentTrajectory();\n\t\tconst trend = this.calculateTrend(context);\n\t\tconst confidence = this.calculateConfidence();\n\n\t\t// Predict future trajectories\n\t\tconst in5Minutes = this.predictTrajectoryAt(context, 5);\n\t\tconst in10Minutes = this.predictTrajectoryAt(context, 10);\n\n\t\t// Calculate time to state change\n\t\tconst timeToStateChange = this.calculateTimeToStateChange(context, current);\n\n\t\treturn {\n\t\t\tcurrent,\n\t\t\tin5Minutes,\n\t\t\tin10Minutes,\n\t\t\tconfidence,\n\t\t\ttrend,\n\t\t\ttimeToStateChange,\n\t\t};\n\t}\n\n\t/**\n\t * Get prediction context.\n\t */\n\tgetContext(): PredictionContext {\n\t\treturn this.calculateContext();\n\t}\n\n\t/**\n\t * Reset history.\n\t */\n\treset(): void {\n\t\tthis.history = [];\n\t}\n\n\t/**\n\t * Create default forecast when no data.\n\t */\n\tprivate createDefaultForecast(): TrajectoryForecast {\n\t\treturn {\n\t\t\tcurrent: \"stable\",\n\t\t\tin5Minutes: \"stable\",\n\t\t\tin10Minutes: \"stable\",\n\t\t\tconfidence: 0,\n\t\t\ttrend: \"stable\",\n\t\t\ttimeToStateChange: null,\n\t\t};\n\t}\n\n\t/**\n\t * Get current trajectory from most recent snapshot.\n\t */\n\tprivate getCurrentTrajectory(): Trajectory {\n\t\tif (this.history.length === 0) {\n\t\t\treturn \"stable\";\n\t\t}\n\t\treturn this.history[this.history.length - 1].trajectory;\n\t}\n\n\t/**\n\t * Calculate prediction context from history.\n\t */\n\tprivate calculateContext(): PredictionContext {\n\t\tconst recentHistory = this.history.slice(-10); // Last 10 snapshots\n\n\t\tif (recentHistory.length < 2) {\n\t\t\treturn {\n\t\t\t\trecentHistory,\n\t\t\t\tpressureRate: 0,\n\t\t\t\toxygenRate: 0,\n\t\t\t\ttemperatureTrend: \"stable\",\n\t\t\t\tpulseTrend: \"stable\",\n\t\t\t};\n\t\t}\n\n\t\t// Calculate rates (per minute)\n\t\tconst pressureRate = this.calculateRate(recentHistory, (s) => s.pressure.value);\n\t\tconst oxygenRate = this.calculateRate(recentHistory, (s) => s.oxygen.value);\n\n\t\t// Calculate trends\n\t\tconst temperatureTrend = this.calculateTemperatureTrend(recentHistory);\n\t\tconst pulseTrend = this.calculatePulseTrend(recentHistory);\n\n\t\treturn {\n\t\t\trecentHistory,\n\t\t\tpressureRate,\n\t\t\toxygenRate,\n\t\t\ttemperatureTrend,\n\t\t\tpulseTrend,\n\t\t};\n\t}\n\n\t/**\n\t * Calculate rate of change per minute.\n\t */\n\tprivate calculateRate(snapshots: VitalsSnapshot[], getValue: (s: VitalsSnapshot) => number): number {\n\t\tif (snapshots.length < 2) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst first = snapshots[0];\n\t\tconst last = snapshots[snapshots.length - 1];\n\n\t\tconst valueDelta = getValue(last) - getValue(first);\n\t\tconst timeDeltaMinutes = (last.timestamp - first.timestamp) / 60000;\n\n\t\tif (timeDeltaMinutes === 0) {\n\t\t\treturn 0;\n\t\t}\n\n\t\treturn valueDelta / timeDeltaMinutes;\n\t}\n\n\t/**\n\t * Calculate temperature trend.\n\t */\n\tprivate calculateTemperatureTrend(snapshots: VitalsSnapshot[]): \"cooling\" | \"stable\" | \"heating\" {\n\t\tif (snapshots.length < 2) {\n\t\t\treturn \"stable\";\n\t\t}\n\n\t\tconst first = snapshots[0].temperature.aiPercentage;\n\t\tconst last = snapshots[snapshots.length - 1].temperature.aiPercentage;\n\t\tconst delta = last - first;\n\n\t\tif (delta > 5) {\n\t\t\treturn \"heating\";\n\t\t}\n\t\tif (delta < -5) {\n\t\t\treturn \"cooling\";\n\t\t}\n\t\treturn \"stable\";\n\t}\n\n\t/**\n\t * Calculate pulse trend.\n\t */\n\tprivate calculatePulseTrend(snapshots: VitalsSnapshot[]): \"slowing\" | \"stable\" | \"accelerating\" {\n\t\tif (snapshots.length < 2) {\n\t\t\treturn \"stable\";\n\t\t}\n\n\t\tconst first = snapshots[0].pulse.changesPerMinute;\n\t\tconst last = snapshots[snapshots.length - 1].pulse.changesPerMinute;\n\t\tconst delta = last - first;\n\n\t\tif (delta > 5) {\n\t\t\treturn \"accelerating\";\n\t\t}\n\t\tif (delta < -5) {\n\t\t\treturn \"slowing\";\n\t\t}\n\t\treturn \"stable\";\n\t}\n\n\t/**\n\t * Calculate overall trend from context.\n\t */\n\tprivate calculateTrend(context: PredictionContext): \"improving\" | \"stable\" | \"worsening\" {\n\t\t// Calculate recent pressure rate (last 3 snapshots) for better plateau detection\n\t\tconst recent = context.recentHistory.slice(-3);\n\t\tconst recentRate = this.calculateRate(recent, (s) => s.pressure.value);\n\n\t\t// Check if pressure is stable (rate near zero)\n\t\tif (Math.abs(recentRate) < 1) {\n\t\t\treturn \"stable\";\n\t\t}\n\n\t\tif (recentRate > 0) {\n\t\t\treturn \"worsening\";\n\t\t}\n\t\tif (recentRate < 0) {\n\t\t\treturn \"improving\";\n\t\t}\n\n\t\treturn \"stable\";\n\t}\n\n\t/**\n\t * Calculate confidence in predictions.\n\t */\n\tprivate calculateConfidence(): number {\n\t\tconst count = this.history.length;\n\n\t\tif (count === 0) {\n\t\t\treturn 0;\n\t\t}\n\t\tif (count === 1) {\n\t\t\treturn 0.2;\n\t\t}\n\t\tif (count < 3) {\n\t\t\treturn 0.4;\n\t\t}\n\t\tif (count < 5) {\n\t\t\treturn 0.6;\n\t\t}\n\t\tif (count < 10) {\n\t\t\treturn 0.75;\n\t\t}\n\n\t\treturn 0.9;\n\t}\n\n\t/**\n\t * Predict trajectory at a future time (in minutes).\n\t */\n\tprivate predictTrajectoryAt(context: PredictionContext, minutesAhead: number): Trajectory {\n\t\tif (this.history.length === 0) {\n\t\t\treturn \"stable\";\n\t\t}\n\n\t\tconst current = this.history[this.history.length - 1];\n\t\tconst currentPressure = current.pressure.value;\n\n\t\t// Project pressure based on rate\n\t\tconst projectedPressure = clamp(currentPressure + context.pressureRate * minutesAhead, 0, 100);\n\n\t\t// Convert to trajectory\n\t\tif (projectedPressure > 80) {\n\t\t\treturn \"critical\";\n\t\t}\n\t\tif (projectedPressure > 60) {\n\t\t\treturn \"escalating\";\n\t\t}\n\t\treturn \"stable\";\n\t}\n\n\t/**\n\t * Calculate time until trajectory state change.\n\t * Returns null if stable or already critical.\n\t */\n\tprivate calculateTimeToStateChange(context: PredictionContext, current: Trajectory): number | null {\n\t\tif (current === \"critical\") {\n\t\t\treturn null;\n\t\t}\n\t\tif (context.pressureRate <= 0) {\n\t\t\treturn null; // Improving or stable\n\t\t}\n\n\t\tconst currentPressure = this.history.length > 0 ? this.history[this.history.length - 1].pressure.value : 0;\n\n\t\t// Calculate time to reach next threshold\n\t\tlet targetPressure: number;\n\n\t\tif (current === \"stable\") {\n\t\t\ttargetPressure = 60; // Threshold to escalating\n\t\t} else {\n\t\t\ttargetPressure = 80; // Threshold to critical\n\t\t}\n\n\t\tif (currentPressure >= targetPressure) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst pressureDelta = targetPressure - currentPressure;\n\t\tconst timeMinutes = pressureDelta / context.pressureRate;\n\n\t\t// Convert to milliseconds\n\t\treturn Math.round(timeMinutes * 60000);\n\t}\n}\n","/**\n * UserBehaviorLearner - Tracks user snapshot patterns\n *\n * Records observations of when users create snapshots relative to vitals recommendations.\n * Infers user's risk tolerance profile and provides statistics for threshold calibration.\n *\n * @performance Budget: <5ms for recordObservation(), <10ms for getStats()\n */\n\nimport type { Urgency, VitalsSnapshot } from \"../../types/vitals.js\";\nimport type { BehaviorStats, RiskProfile, SnapshotObservation, SnapshotTiming } from \"../../types/vitals-learning.js\";\n\n/** Input for recording an observation */\nexport interface ObservationInput {\n\tvitals: VitalsSnapshot;\n\tuserCreatedSnapshot: boolean;\n\tvitalsRecommended: boolean;\n}\n\n/** Generate unique ID */\nfunction generateId(): string {\n\treturn `obs-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\n}\n\n/**\n * Learns from user snapshot behavior to calibrate thresholds.\n */\nexport class UserBehaviorLearner {\n\tprivate readonly workspaceId: string;\n\tprivate observations: SnapshotObservation[] = [];\n\tprivate readonly maxHistory = 100;\n\n\tconstructor(workspaceId: string) {\n\t\tthis.workspaceId = workspaceId;\n\t}\n\n\t/**\n\t * Record an observation of user behavior.\n\t */\n\trecordObservation(input: ObservationInput): SnapshotObservation {\n\t\tconst timing = this.classifyTiming(input);\n\t\tconst urgency = this.calculateUrgency(input.vitals);\n\n\t\tconst observation: SnapshotObservation = {\n\t\t\tid: generateId(),\n\t\t\tworkspaceId: this.workspaceId,\n\t\t\ttimestamp: Date.now(),\n\t\t\tvitals: input.vitals,\n\t\t\tuserCreatedSnapshot: input.userCreatedSnapshot,\n\t\t\tvitalsRecommended: input.vitalsRecommended,\n\t\t\turgencyAtTime: urgency,\n\t\t\ttiming,\n\t\t};\n\n\t\tthis.observations.push(observation);\n\n\t\t// Bound history\n\t\tif (this.observations.length > this.maxHistory) {\n\t\t\tthis.observations.shift();\n\t\t}\n\n\t\treturn observation;\n\t}\n\n\t/**\n\t * Classify the timing of the observation.\n\t */\n\tprivate classifyTiming(input: ObservationInput): SnapshotTiming {\n\t\tif (!input.userCreatedSnapshot && input.vitalsRecommended) {\n\t\t\treturn \"missed\";\n\t\t}\n\n\t\tif (input.userCreatedSnapshot && !input.vitalsRecommended) {\n\t\t\treturn \"early\";\n\t\t}\n\n\t\tif (input.userCreatedSnapshot && input.vitalsRecommended) {\n\t\t\t// Check if user was late (critical trajectory or very high pressure)\n\t\t\tif (input.vitals.trajectory === \"critical\" || input.vitals.pressure.value > 80) {\n\t\t\t\treturn \"late\";\n\t\t\t}\n\t\t\treturn \"aligned\";\n\t\t}\n\n\t\t// No snapshot, no recommendation = not tracked as significant\n\t\treturn \"aligned\";\n\t}\n\n\t/**\n\t * Calculate urgency from vitals.\n\t */\n\tprivate calculateUrgency(vitals: VitalsSnapshot): Urgency {\n\t\tif (vitals.trajectory === \"critical\") {\n\t\t\treturn \"critical\";\n\t\t}\n\t\tif (vitals.pressure.value > 80) {\n\t\t\treturn \"high\";\n\t\t}\n\t\tif (vitals.pressure.value > 60 || vitals.trajectory === \"escalating\") {\n\t\t\treturn \"medium\";\n\t\t}\n\t\tif (vitals.pressure.value > 40) {\n\t\t\treturn \"low\";\n\t\t}\n\t\treturn \"none\";\n\t}\n\n\t/**\n\t * Get behavior statistics.\n\t */\n\tgetStats(): BehaviorStats {\n\t\tconst total = this.observations.length;\n\n\t\tif (total === 0) {\n\t\t\treturn {\n\t\t\t\ttotalObservations: 0,\n\t\t\t\talignedSnapshots: 0,\n\t\t\t\tearlySnapshots: 0,\n\t\t\t\tlateSnapshots: 0,\n\t\t\t\tmissedRecommendations: 0,\n\t\t\t\triskProfile: \"balanced\",\n\t\t\t\tavgPressureAtSnapshot: 0,\n\t\t\t\tavgOxygenAtSnapshot: 0,\n\t\t\t};\n\t\t}\n\n\t\tconst aligned = this.observations.filter((o) => o.timing === \"aligned\" && o.userCreatedSnapshot).length;\n\t\tconst early = this.observations.filter((o) => o.timing === \"early\").length;\n\t\tconst late = this.observations.filter((o) => o.timing === \"late\").length;\n\t\tconst missed = this.observations.filter((o) => o.timing === \"missed\").length;\n\n\t\t// Calculate averages for snapshots only\n\t\tconst snapshotObs = this.observations.filter((o) => o.userCreatedSnapshot);\n\t\tconst avgPressure =\n\t\t\tsnapshotObs.length > 0\n\t\t\t\t? snapshotObs.reduce((sum, o) => sum + o.vitals.pressure.value, 0) / snapshotObs.length\n\t\t\t\t: 0;\n\t\tconst avgOxygen =\n\t\t\tsnapshotObs.length > 0\n\t\t\t\t? snapshotObs.reduce((sum, o) => sum + o.vitals.oxygen.value, 0) / snapshotObs.length\n\t\t\t\t: 0;\n\n\t\t// Infer risk profile\n\t\tconst riskProfile = this.inferRiskProfile(early, aligned, late, missed, total);\n\n\t\treturn {\n\t\t\ttotalObservations: total,\n\t\t\talignedSnapshots: aligned,\n\t\t\tearlySnapshots: early,\n\t\t\tlateSnapshots: late,\n\t\t\tmissedRecommendations: missed,\n\t\t\triskProfile,\n\t\t\tavgPressureAtSnapshot: Math.round(avgPressure),\n\t\t\tavgOxygenAtSnapshot: Math.round(avgOxygen),\n\t\t};\n\t}\n\n\t/**\n\t * Infer risk profile from observation patterns.\n\t */\n\tprivate inferRiskProfile(\n\t\tearly: number,\n\t\t_aligned: number,\n\t\tlate: number,\n\t\tmissed: number,\n\t\ttotal: number,\n\t): RiskProfile {\n\t\tif (total < 3) {\n\t\t\treturn \"balanced\"; // Not enough data\n\t\t}\n\n\t\tconst earlyRatio = early / total;\n\t\tconst missedRatio = missed / total;\n\t\tconst lateRatio = late / total;\n\n\t\t// Conservative: Early snapshots dominate (>50%)\n\t\tif (earlyRatio > 0.5) {\n\t\t\treturn \"conservative\";\n\t\t}\n\n\t\t// Aggressive: Missed + late dominate (>50%)\n\t\tif (missedRatio + lateRatio > 0.5) {\n\t\t\treturn \"aggressive\";\n\t\t}\n\n\t\t// Balanced: Mixed behavior\n\t\treturn \"balanced\";\n\t}\n\n\t/**\n\t * Get all observations.\n\t */\n\tgetObservations(): SnapshotObservation[] {\n\t\treturn [...this.observations];\n\t}\n\n\t/**\n\t * Reset all observations.\n\t */\n\treset(): void {\n\t\tthis.observations = [];\n\t}\n}\n","/**\n * OxygenSensor - Snapshot coverage tracking\n *\n * Measures how well-protected the workspace is based on:\n * - What percentage of modified files have snapshots\n * - How recent those snapshots are (stale = low oxygen)\n * - Critical file coverage weighted 2x\n *\n * @performance Budget: <1ms per operation\n */\n\nimport type { OxygenConfig } from \"../types/vitals.js\";\n\n/** Default oxygen configuration */\nexport const DEFAULT_OXYGEN_CONFIG: OxygenConfig = {\n\tstaleMinutes: 30, // Snapshots older than 30 min are stale\n\tcriticalWeight: 2, // Critical files count 2x\n};\n\n/** Oxygen state with metrics */\nexport interface OxygenState {\n\tvalue: number; // 0-100\n\tcoveragePercentage: number;\n\tstaleSnapshots: number;\n}\n\n/** Patterns for critical files */\nconst CRITICAL_FILE_PATTERNS: RegExp[] = [\n\t/package\\.json$/,\n\t/\\.env($|\\.)/,\n\t/tsconfig\\.json$/,\n\t/pnpm-lock\\.yaml$/,\n\t/\\.lock$/,\n\t/migrations?\\//,\n\t/schema\\.(sql|prisma|graphql)$/,\n];\n\n/**\n * Tracks snapshot coverage of modified files.\n *\n * Oxygen represents how \"protected\" the current work is.\n * Higher oxygen = more snapshots covering active files.\n */\nexport class OxygenSensor {\n\t/** Map of file path to snapshot timestamp */\n\tprivate snapshots: Map<string, number> = new Map();\n\t/** Set of files that have been modified */\n\tprivate modifiedFiles: Set<string> = new Set();\n\tprivate readonly config: OxygenConfig;\n\n\tconstructor(config: Partial<OxygenConfig> = {}) {\n\t\tthis.config = { ...DEFAULT_OXYGEN_CONFIG, ...config };\n\t}\n\n\t/**\n\t * Record a file modification.\n\t * @param filePath Path of the modified file\n\t */\n\trecordModification(filePath: string): void {\n\t\tthis.modifiedFiles.add(filePath);\n\t}\n\n\t/**\n\t * Record a snapshot creation for a file.\n\t * @param filePath Path of the snapshotted file\n\t * @param timestamp Optional: snapshot time for testing\n\t */\n\trecordSnapshot(filePath: string, timestamp: number = Date.now()): void {\n\t\tthis.snapshots.set(filePath, timestamp);\n\t\t// File is no longer \"modified without snapshot\"\n\t\tthis.modifiedFiles.delete(filePath);\n\t}\n\n\t/**\n\t * Record multiple snapshots at once (e.g., workspace-wide snapshot).\n\t * @param filePaths Paths of snapshotted files\n\t * @param timestamp Optional: snapshot time for testing\n\t */\n\trecordBulkSnapshot(filePaths: string[], timestamp: number = Date.now()): void {\n\t\tfor (const filePath of filePaths) {\n\t\t\tthis.recordSnapshot(filePath, timestamp);\n\t\t}\n\t}\n\n\t/**\n\t * Get current oxygen level and metrics.\n\t * @param now Optional: current time for testing\n\t */\n\tgetLevel(now: number = Date.now()): OxygenState {\n\t\tconst staleThreshold = now - this.config.staleMinutes * 60 * 1000;\n\n\t\tlet covered = 0;\n\t\tlet total = 0;\n\t\tlet stale = 0;\n\n\t\t// Calculate coverage based on modified files\n\t\tfor (const file of this.modifiedFiles) {\n\t\t\tconst isCritical = this.isCriticalFile(file);\n\t\t\tconst weight = isCritical ? this.config.criticalWeight : 1;\n\t\t\ttotal += weight;\n\n\t\t\tconst snapshotTime = this.snapshots.get(file);\n\t\t\tif (snapshotTime) {\n\t\t\t\tif (snapshotTime > staleThreshold) {\n\t\t\t\t\tcovered += weight;\n\t\t\t\t} else {\n\t\t\t\t\tstale++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Note: Files with snapshots that aren't in modifiedFiles are fully protected\n\t\t// and don't need to be counted - they're already safe\n\n\t\t// If no modified files, oxygen is 100%\n\t\tconst coveragePercentage = total > 0 ? (covered / total) * 100 : 100;\n\n\t\treturn {\n\t\t\tvalue: Math.round(coveragePercentage),\n\t\t\tcoveragePercentage: Math.round(coveragePercentage),\n\t\t\tstaleSnapshots: stale,\n\t\t};\n\t}\n\n\t/**\n\t * Get list of modified files without snapshots.\n\t */\n\tgetUncoveredFiles(): string[] {\n\t\treturn Array.from(this.modifiedFiles).filter((file) => !this.snapshots.has(file));\n\t}\n\n\t/**\n\t * Get count of tracked files.\n\t */\n\tgetCounts(): { modified: number; snapshots: number } {\n\t\treturn {\n\t\t\tmodified: this.modifiedFiles.size,\n\t\t\tsnapshots: this.snapshots.size,\n\t\t};\n\t}\n\n\t/**\n\t * Clear all tracking data.\n\t */\n\treset(): void {\n\t\tthis.snapshots.clear();\n\t\tthis.modifiedFiles.clear();\n\t}\n\n\t/**\n\t * Check if a file path matches critical file patterns.\n\t */\n\tprivate isCriticalFile(filePath: string): boolean {\n\t\treturn CRITICAL_FILE_PATTERNS.some((pattern) => pattern.test(filePath));\n\t}\n}\n","/**\n * PressureGauge - Risk accumulation tracking\n *\n * Measures the buildup of risk over time when changes are made without snapshots.\n * Pressure increases with:\n * - Time since last snapshot\n * - Number of unsnapshot'd changes\n * - Critical file modifications (2x multiplier)\n *\n * Pressure decreases when:\n * - A snapshot is created (50% decay)\n *\n * @performance Budget: <1ms per operation\n */\n\nimport type { PressureConfig } from \"../types/vitals.js\";\n\n/** Default pressure configuration */\nexport const DEFAULT_PRESSURE_CONFIG: PressureConfig = {\n\tbaseRate: 5, // 5% pressure per minute\n\tcriticalMultiplier: 2, // 2x for critical files\n\tdecayOnSnapshot: 50, // Release 50% on snapshot\n\tmaxPressure: 100,\n};\n\n/** Pressure state result */\nexport interface PressureState {\n\tvalue: number; // 0-100\n\tunsnapshotedChanges: number;\n\ttimeSinceLastSnapshot: number; // minutes\n\tcriticalFilesTouched: string[];\n}\n\n/**\n * Structured snapshot recommendation based on pressure analysis\n * 2026 best practice: Actionable, context-aware recommendations\n */\nexport interface PressureRecommendation {\n\t/** Should a snapshot be created now? */\n\tshouldSnapshot: boolean;\n\t/** Urgency level (0-100) */\n\turgency: number;\n\t/** Primary reason for recommendation */\n\treason: string;\n\t/** Detailed context for the recommendation */\n\tcontext: {\n\t\t/** Current pressure value */\n\t\tpressure: number;\n\t\t/** Number of unsnapshot'd changes */\n\t\tchanges: number;\n\t\t/** Minutes since last snapshot */\n\t\tminutesSinceSnapshot: number;\n\t\t/** Critical files affected */\n\t\tcriticalFiles: string[];\n\t};\n\t/** Suggested action for the user */\n\taction: \"snapshot_now\" | \"snapshot_soon\" | \"monitor\" | \"none\";\n\t/** Educational message explaining why this matters */\n\teducational?: string;\n}\n\n/** Patterns for critical files that warrant extra protection */\nconst CRITICAL_FILE_PATTERNS: RegExp[] = [\n\t/package\\.json$/,\n\t/\\.env($|\\.)/,\n\t/tsconfig\\.json$/,\n\t/pnpm-lock\\.yaml$/,\n\t/\\.lock$/,\n\t/migrations?\\//,\n\t/schema\\.(sql|prisma|graphql)$/,\n\t/docker-compose\\.ya?ml$/,\n\t/Dockerfile$/,\n];\n\n/**\n * Tracks risk pressure accumulation.\n *\n * Pressure builds continuously:\n * - Base rate per minute of elapsed time\n * - Per-change rate (higher for critical files)\n *\n * Pressure releases on snapshot creation.\n */\nexport class PressureGauge {\n\tprivate changeBasedPressure = 0;\n\tprivate unsnapshotedChanges = 0;\n\tprivate lastSnapshotTime: number;\n\tprivate criticalFilesTouched: Set<string> = new Set();\n\tprivate readonly config: PressureConfig;\n\n\tconstructor(config: Partial<PressureConfig> = {}, initialTime: number = Date.now()) {\n\t\tthis.config = { ...DEFAULT_PRESSURE_CONFIG, ...config };\n\t\tthis.lastSnapshotTime = initialTime;\n\t}\n\n\t/**\n\t * Record a file change, accumulating pressure.\n\t * @param filePath Path of the modified file\n\t */\n\trecordChange(filePath: string): void {\n\t\tthis.unsnapshotedChanges++;\n\n\t\tconst isCritical = this.isCriticalFile(filePath);\n\t\tif (isCritical) {\n\t\t\tthis.criticalFilesTouched.add(filePath);\n\t\t}\n\n\t\t// Accumulate pressure per change\n\t\t// Each change adds baseRate/10 (so 10 changes = 1 minute worth of pressure)\n\t\tconst multiplier = isCritical ? this.config.criticalMultiplier : 1;\n\t\tconst increment = (this.config.baseRate * multiplier) / 10;\n\t\tthis.changeBasedPressure = Math.min(this.config.maxPressure, this.changeBasedPressure + increment);\n\t}\n\n\t/**\n\t * Record a snapshot, releasing pressure.\n\t * @param now Optional timestamp for testing\n\t */\n\trecordSnapshot(now: number = Date.now()): void {\n\t\t// Decay pressure by configured percentage\n\t\tthis.changeBasedPressure = Math.max(0, this.changeBasedPressure * (1 - this.config.decayOnSnapshot / 100));\n\t\tthis.unsnapshotedChanges = 0;\n\t\tthis.criticalFilesTouched.clear();\n\t\tthis.lastSnapshotTime = now;\n\t}\n\n\t/**\n\t * Get current pressure state.\n\t * @param now Optional timestamp for testing\n\t */\n\tgetState(now: number = Date.now()): PressureState {\n\t\tconst minutesSinceSnapshot = Math.max(0, (now - this.lastSnapshotTime) / 60000);\n\n\t\t// Time-based pressure ONLY accumulates when there are unsnapshot changes\n\t\t// This prevents false alarms when workspace is idle\n\t\tconst timePressure = this.unsnapshotedChanges > 0 ? minutesSinceSnapshot * this.config.baseRate : 0;\n\n\t\t// Total pressure is change-based + time-based, capped at max\n\t\tconst totalPressure = Math.min(this.config.maxPressure, this.changeBasedPressure + timePressure);\n\n\t\treturn {\n\t\t\tvalue: Math.round(totalPressure),\n\t\t\tunsnapshotedChanges: this.unsnapshotedChanges,\n\t\t\ttimeSinceLastSnapshot: Math.round(minutesSinceSnapshot),\n\t\t\tcriticalFilesTouched: Array.from(this.criticalFilesTouched),\n\t\t};\n\t}\n\n\t/**\n\t * Reset the gauge to initial state.\n\t * @param now Optional timestamp for testing\n\t */\n\treset(now: number = Date.now()): void {\n\t\tthis.changeBasedPressure = 0;\n\t\tthis.unsnapshotedChanges = 0;\n\t\tthis.criticalFilesTouched.clear();\n\t\tthis.lastSnapshotTime = now;\n\t}\n\n\t/**\n\t * Check if a file path matches critical file patterns.\n\t */\n\tprivate isCriticalFile(filePath: string): boolean {\n\t\treturn CRITICAL_FILE_PATTERNS.some((pattern) => pattern.test(filePath));\n\t}\n\n\t// =========================================================================\n\t// RECOMMENDATIONS API (2026 industry standard)\n\t// =========================================================================\n\n\t/**\n\t * Get structured snapshot recommendation based on current pressure state\n\t *\n\t * 2026 Best Practice: Recommendations should be:\n\t * - Actionable (clear next step)\n\t * - Context-aware (includes relevant data)\n\t * - Educational (explains why it matters)\n\t *\n\t * @param now Optional timestamp for testing\n\t * @returns Structured recommendation with action and context\n\t */\n\tgetRecommendation(now: number = Date.now()): PressureRecommendation {\n\t\tconst state = this.getState(now);\n\t\tconst { value, unsnapshotedChanges, timeSinceLastSnapshot, criticalFilesTouched } = state;\n\n\t\t// Determine urgency and action based on thresholds\n\t\tlet shouldSnapshot = false;\n\t\tlet urgency = 0;\n\t\tlet reason = \"\";\n\t\tlet action: PressureRecommendation[\"action\"] = \"none\";\n\t\tlet educational: string | undefined;\n\n\t\t// Critical pressure (>=80): Immediate action needed\n\t\tif (value >= 80) {\n\t\t\tshouldSnapshot = true;\n\t\t\turgency = 100;\n\t\t\treason = `Critical pressure (${value}%) - immediate snapshot recommended`;\n\t\t\taction = \"snapshot_now\";\n\t\t\teducational =\n\t\t\t\t\"High pressure indicates significant unsnapshot'd work. Creating a snapshot now protects against potential loss.\";\n\t\t}\n\t\t// High pressure (>=60): Snapshot soon\n\t\telse if (value >= 60) {\n\t\t\tshouldSnapshot = true;\n\t\t\turgency = 75;\n\t\t\treason = `High pressure (${value}%) - snapshot recommended`;\n\t\t\taction = \"snapshot_soon\";\n\t\t\teducational = \"Risk is accumulating. A snapshot within the next few minutes will keep your work protected.\";\n\t\t}\n\t\t// Moderate pressure (>=40): Monitor closely\n\t\telse if (value >= 40) {\n\t\t\tshouldSnapshot = false;\n\t\t\turgency = 50;\n\t\t\treason = `Moderate pressure (${value}%) - monitoring recommended`;\n\t\t\taction = \"monitor\";\n\t\t\teducational =\n\t\t\t\t\"Your session is progressing normally. Consider a snapshot if you're about to start risky changes.\";\n\t\t}\n\t\t// Low pressure (<40): No action needed\n\t\telse {\n\t\t\tshouldSnapshot = false;\n\t\t\turgency = value;\n\t\t\treason = \"Session health is good - no action needed\";\n\t\t\taction = \"none\";\n\t\t}\n\n\t\t// Boost urgency if critical files are touched\n\t\tif (criticalFilesTouched.length > 0 && value >= 30) {\n\t\t\turgency = Math.min(100, urgency + 20);\n\t\t\treason = `${reason} (critical files modified)`;\n\t\t\tif (action === \"monitor\") {\n\t\t\t\taction = \"snapshot_soon\";\n\t\t\t\tshouldSnapshot = true;\n\t\t\t}\n\t\t\teducational = `Critical files (${criticalFilesTouched.slice(0, 2).join(\", \")}) have been modified. These files typically require more protection.`;\n\t\t}\n\n\t\treturn {\n\t\t\tshouldSnapshot,\n\t\t\turgency,\n\t\t\treason,\n\t\t\tcontext: {\n\t\t\t\tpressure: value,\n\t\t\t\tchanges: unsnapshotedChanges,\n\t\t\t\tminutesSinceSnapshot: timeSinceLastSnapshot,\n\t\t\t\tcriticalFiles: criticalFilesTouched,\n\t\t\t},\n\t\t\taction,\n\t\t\teducational,\n\t\t};\n\t}\n\n\t/**\n\t * Get multiple recommendations for different scenarios\n\t * Useful for UI components that need to show options\n\t */\n\tgetRecommendations(now: number = Date.now()): PressureRecommendation[] {\n\t\tconst primary = this.getRecommendation(now);\n\t\tconst recommendations = [primary];\n\n\t\t// If monitoring is recommended, also suggest proactive snapshot\n\t\tif (primary.action === \"monitor\" && primary.context.changes > 5) {\n\t\t\trecommendations.push({\n\t\t\t\tshouldSnapshot: true,\n\t\t\t\turgency: 30,\n\t\t\t\treason: \"Proactive snapshot opportunity\",\n\t\t\t\tcontext: primary.context,\n\t\t\t\taction: \"snapshot_soon\",\n\t\t\t\teducational: \"You have unsnapshot'd work. A proactive snapshot now ensures you have a recovery point.\",\n\t\t\t});\n\t\t}\n\n\t\treturn recommendations;\n\t}\n}\n","/**\n * PulseTracker - Change velocity monitoring\n *\n * Tracks the rate of file changes to determine workspace \"pulse\" level.\n * Uses a sliding window to calculate changes per minute.\n *\n * @performance Budget: <1ms per operation (called on every file save)\n */\n\nimport type { PulseConfig, PulseLevel } from \"../types/vitals.js\";\n\n/** Default pulse configuration */\nexport const DEFAULT_PULSE_CONFIG: PulseConfig = {\n\televated: 15, // changes/min\n\tracing: 30,\n\tcritical: 50,\n\twindowSeconds: 60,\n};\n\n/** Pulse level result with metrics */\nexport interface PulseState {\n\tlevel: PulseLevel;\n\tchangesPerMinute: number;\n}\n\n/**\n * Tracks change velocity over a sliding time window.\n *\n * Uses timestamps array with O(n) pruning on read.\n * For performance, pruning happens lazily during getLevel().\n */\nexport class PulseTracker {\n\tprivate changes: number[] = [];\n\tprivate readonly config: PulseConfig;\n\n\tconstructor(config: Partial<PulseConfig> = {}) {\n\t\tthis.config = { ...DEFAULT_PULSE_CONFIG, ...config };\n\t}\n\n\t/**\n\t * Record a file change event.\n\t * @performance O(1) - just pushes timestamp\n\t */\n\trecordChange(timestamp: number = Date.now()): void {\n\t\tthis.changes.push(timestamp);\n\t}\n\n\t/**\n\t * Get current pulse level and changes per minute.\n\t * @performance O(n) where n = changes in window\n\t */\n\tgetLevel(now: number = Date.now()): PulseState {\n\t\tthis.pruneOld(now);\n\n\t\tconst changesPerMinute =\n\t\t\tthis.config.windowSeconds > 0 ? (this.changes.length / this.config.windowSeconds) * 60 : 0;\n\n\t\treturn {\n\t\t\tlevel: this.classifyLevel(changesPerMinute),\n\t\t\tchangesPerMinute: Math.round(changesPerMinute),\n\t\t};\n\t}\n\n\t/**\n\t * Get raw change count in current window (for testing).\n\t */\n\tgetChangeCount(now: number = Date.now()): number {\n\t\tthis.pruneOld(now);\n\t\treturn this.changes.length;\n\t}\n\n\t/**\n\t * Clear all recorded changes.\n\t */\n\treset(): void {\n\t\tthis.changes = [];\n\t}\n\n\t/**\n\t * Remove events outside the sliding window.\n\t */\n\tprivate pruneOld(now: number): void {\n\t\tconst cutoff = now - this.config.windowSeconds * 1000;\n\t\t// Filter in place for memory efficiency\n\t\tthis.changes = this.changes.filter((t) => t > cutoff);\n\t}\n\n\t/**\n\t * Classify changes/min into a pulse level.\n\t */\n\tprivate classifyLevel(changesPerMinute: number): PulseLevel {\n\t\tif (changesPerMinute >= this.config.critical) {\n\t\t\treturn \"critical\";\n\t\t}\n\t\tif (changesPerMinute >= this.config.racing) {\n\t\t\treturn \"racing\";\n\t\t}\n\t\tif (changesPerMinute >= this.config.elevated) {\n\t\t\treturn \"elevated\";\n\t\t}\n\t\treturn \"resting\";\n\t}\n}\n","/**\n * TemperatureMonitor - AI activity level tracking\n *\n * Monitors the ratio of AI vs human activity to determine \"temperature\".\n * Higher AI activity = hotter temperature = more need for protection.\n *\n * Uses a decay window to cool down over time when AI activity stops.\n *\n * @performance Budget: <1ms per operation\n */\n\nimport type { TemperatureConfig, TempLevel } from \"../types/vitals.js\";\n\n/** Default temperature configuration */\nexport const DEFAULT_TEMPERATURE_CONFIG: TemperatureConfig = {\n\twarm: 20, // 20% AI activity\n\thot: 50, // 50% AI activity\n\tburning: 80, // 80% AI activity\n\tdecaySeconds: 300, // 5 minutes to cool down\n};\n\n/** Temperature state with metrics */\nexport interface TemperatureState {\n\tlevel: TempLevel;\n\taiPercentage: number;\n\tdetectedTool?: string;\n}\n\ninterface AIEvent {\n\ttimestamp: number;\n\ttool?: string;\n}\n\n/**\n * Monitors AI vs human activity within a decay window.\n *\n * Temperature rises with AI activity and cools over time.\n */\nexport class TemperatureMonitor {\n\tprivate aiEvents: AIEvent[] = [];\n\tprivate humanEvents: number[] = [];\n\tprivate readonly config: TemperatureConfig;\n\n\tconstructor(config: Partial<TemperatureConfig> = {}) {\n\t\tthis.config = { ...DEFAULT_TEMPERATURE_CONFIG, ...config };\n\t}\n\n\t/**\n\t * Record AI-assisted activity.\n\t * @param tool Optional: which AI tool (e.g., \"Cursor\", \"Copilot\", \"Claude\")\n\t * @param timestamp Optional: event time for testing\n\t */\n\trecordAIActivity(tool?: string, timestamp: number = Date.now()): void {\n\t\tthis.aiEvents.push({ timestamp, tool });\n\t}\n\n\t/**\n\t * Record human (non-AI) activity.\n\t * @param timestamp Optional: event time for testing\n\t */\n\trecordHumanActivity(timestamp: number = Date.now()): void {\n\t\tthis.humanEvents.push(timestamp);\n\t}\n\n\t/**\n\t * Get current temperature level and metrics.\n\t * @param now Optional: current time for testing\n\t */\n\tgetLevel(now: number = Date.now()): TemperatureState {\n\t\tthis.pruneOld(now);\n\n\t\tconst total = this.aiEvents.length + this.humanEvents.length;\n\t\tconst aiPercentage = total > 0 ? (this.aiEvents.length / total) * 100 : 0;\n\n\t\t// Most recent AI tool\n\t\tconst detectedTool = this.aiEvents.length > 0 ? this.aiEvents[this.aiEvents.length - 1].tool : undefined;\n\n\t\treturn {\n\t\t\tlevel: this.classifyLevel(aiPercentage),\n\t\t\taiPercentage: Math.round(aiPercentage),\n\t\t\tdetectedTool,\n\t\t};\n\t}\n\n\t/**\n\t * Get counts for testing.\n\t */\n\tgetCounts(now: number = Date.now()): { ai: number; human: number } {\n\t\tthis.pruneOld(now);\n\t\treturn {\n\t\t\tai: this.aiEvents.length,\n\t\t\thuman: this.humanEvents.length,\n\t\t};\n\t}\n\n\t/**\n\t * Clear all recorded activity.\n\t */\n\treset(): void {\n\t\tthis.aiEvents = [];\n\t\tthis.humanEvents = [];\n\t}\n\n\t/**\n\t * Remove events outside the decay window.\n\t */\n\tprivate pruneOld(now: number): void {\n\t\tconst cutoff = now - this.config.decaySeconds * 1000;\n\t\tthis.aiEvents = this.aiEvents.filter((e) => e.timestamp > cutoff);\n\t\tthis.humanEvents = this.humanEvents.filter((t) => t > cutoff);\n\t}\n\n\t/**\n\t * Classify AI percentage into a temperature level.\n\t */\n\tprivate classifyLevel(aiPercentage: number): TempLevel {\n\t\tif (aiPercentage >= this.config.burning) {\n\t\t\treturn \"burning\";\n\t\t}\n\t\tif (aiPercentage >= this.config.hot) {\n\t\t\treturn \"hot\";\n\t\t}\n\t\tif (aiPercentage >= this.config.warm) {\n\t\t\treturn \"warm\";\n\t\t}\n\t\treturn \"cold\";\n\t}\n}\n","/**\n * TrustMetricsAPI - Extension  Web Console Data Sync Specification\n *\n * Defines the trust-building metrics interface for senior developers who've\n * experienced code loss from AI-assisted development. Provides:\n *\n * 1. **Extension Webview** - Real-time actionable metrics (commit risk, live vitals)\n * 2. **Web Console** - Historical analysis (DORA trends, team benchmarks)\n * 3. **Both** - Core trust metrics with different detail levels\n *\n * Based on 2026 research: Trust requires transparency, proof of effectiveness,\n * and progressive disclosure of complexity.\n *\n * @packageDocumentation\n */\n\nimport type { RiskBreakdown, RiskEvaluation } from \"./CommitRiskSystem.js\";\nimport type { DORASnapshot, RecoveryEvent } from \"./DORAMetrics.js\";\nimport type { DevelopmentPhase, PhaseDetectionResult } from \"./learning/PhaseDetector.js\";\nimport type { PressureRecommendation, PressureState } from \"./PressureGauge.js\";\n\n// =============================================================================\n// CORE TRUST METRICS (Both Extension + Console)\n// =============================================================================\n\n/**\n * Recovery confidence score based on past outcomes\n */\nexport interface RecoveryConfidence {\n\t/** Overall confidence score (0-100) */\n\tscore: number;\n\t/** Number of successful recoveries */\n\tsuccessfulRecoveries: number;\n\t/** Number of failed recoveries */\n\tfailedRecoveries: number;\n\t/** Mean time to recovery (ms) */\n\tmeanTimeToRecovery: number;\n\t/** Trend direction */\n\ttrend: \"improving\" | \"stable\" | \"degrading\";\n\t/** Last recovery timestamp */\n\tlastRecoveryAt: number | null;\n\t/** AI tool calibration confidence */\n\taiToolCalibration: number;\n}\n\n/**\n * Snapshot chain integrity status\n */\nexport interface ChainIntegrity {\n\t/** Chain is intact and recoverable */\n\tisIntact: boolean;\n\t/** Number of snapshots in chain */\n\tchainLength: number;\n\t/** Has PRE_ROLLBACK checkpoints */\n\thasRollbackPoints: boolean;\n\t/** Oldest recoverable snapshot timestamp */\n\toldestRecoverable: number | null;\n\t/** Gap warnings (missing links) */\n\tgaps: Array<{\n\t\tstart: number;\n\t\tend: number;\n\t\treason: string;\n\t}>;\n}\n\n/**\n * Session protection status\n */\nexport interface SessionProtection {\n\t/** Current session is protected */\n\tisProtected: boolean;\n\t/** Minutes since last snapshot */\n\tminutesSinceSnapshot: number;\n\t/** Files modified since snapshot */\n\tfilesSinceSnapshot: number;\n\t/** Lines changed since snapshot */\n\tlinesSinceSnapshot: number;\n\t/** Estimated recovery time (ms) */\n\testimatedRecoveryTime: number;\n\t/** Protection coverage (0-100) */\n\tcoveragePercent: number;\n}\n\n/**\n * Core trust metrics bundle - available in both extension and console\n */\nexport interface CoreTrustMetrics {\n\t/** Recovery confidence score */\n\trecoveryConfidence: RecoveryConfidence;\n\t/** Snapshot chain integrity */\n\tchainIntegrity: ChainIntegrity;\n\t/** Current session protection */\n\tsessionProtection: SessionProtection;\n\t/** DORA performance tier */\n\tperformanceTier: \"elite\" | \"high\" | \"medium\" | \"low\";\n\t/** Last updated timestamp */\n\tupdatedAt: number;\n}\n\n// =============================================================================\n// EXTENSION WEBVIEW METRICS (Real-time, in-context)\n// =============================================================================\n\n/**\n * Live session vitals for extension dashboard\n */\nexport interface LiveVitals {\n\t/** Pulse - change velocity */\n\tpulse: {\n\t\tlevel: \"resting\" | \"active\" | \"elevated\" | \"racing\";\n\t\tchangesPerMinute: number;\n\t};\n\t/** Temperature - AI activity */\n\ttemperature: {\n\t\tlevel: \"cool\" | \"warm\" | \"hot\" | \"critical\";\n\t\taiPercentage: number;\n\t};\n\t/** Pressure - risk accumulation */\n\tpressure: PressureState;\n\t/** Oxygen - snapshot coverage */\n\toxygen: {\n\t\tlevel: \"healthy\" | \"low\" | \"critical\";\n\t\tcoveragePercent: number;\n\t};\n\t/** Overall trajectory */\n\ttrajectory: \"improving\" | \"stable\" | \"declining\" | \"critical\";\n}\n\n/**\n * Commit risk for extension (real-time)\n */\nexport interface ExtensionCommitRisk {\n\t/** Current risk score (0-1.5) */\n\tscore: number;\n\t/** Risk breakdown by factor */\n\tbreakdown: RiskBreakdown;\n\t/** Recommended action */\n\taction: \"none\" | \"auto_snapshot\" | \"suggest_commit\" | \"strong_commit\";\n\t/** UI escalation level */\n\tescalation: \"none\" | \"status_bar\" | \"notification\" | \"modal\";\n\t/** Human-readable reason */\n\treason: string;\n\t/** Educational message */\n\teducational?: string;\n}\n\n/**\n * Recent activity audit trail\n */\nexport interface ActivityAuditEntry {\n\t/** Entry type */\n\ttype: \"snapshot_created\" | \"recovery_performed\" | \"risk_threshold_crossed\" | \"ai_detected\";\n\t/** Timestamp */\n\ttimestamp: number;\n\t/** Description */\n\tdescription: string;\n\t/** Associated file (if any) */\n\tfile?: string;\n\t/** Was this protective action? */\n\twasProtective: boolean;\n}\n\n/**\n * Extension webview metrics bundle\n */\nexport interface ExtensionMetrics {\n\t/** Core trust metrics */\n\tcore: CoreTrustMetrics;\n\t/** Live vitals */\n\tvitals: LiveVitals;\n\t/** Current commit risk */\n\tcommitRisk: ExtensionCommitRisk;\n\t/** Current phase detection */\n\tphase: PhaseDetectionResult;\n\t/** Snapshot recommendation */\n\trecommendation: PressureRecommendation;\n\t/** Recent activity (last 10 entries) */\n\trecentActivity: ActivityAuditEntry[];\n\t/** \"SnapBack saved you X times\" counter */\n\tsaveCount: {\n\t\ttoday: number;\n\t\tthisWeek: number;\n\t\tallTime: number;\n\t};\n}\n\n// =============================================================================\n// WEB CONSOLE METRICS (Historical analysis)\n// =============================================================================\n\n/**\n * DORA trend data point\n */\nexport interface DORATrendPoint {\n\t/** Timestamp */\n\ttimestamp: number;\n\t/** DORA metrics snapshot */\n\tmetrics: DORASnapshot;\n}\n\n/**\n * Recovery failure with details\n */\nexport interface RecoveryFailureDetail {\n\t/** Snapshot ID that failed */\n\tsnapshotId: string;\n\t/** Failure timestamp */\n\ttimestamp: number;\n\t/** Failure reason */\n\treason: string;\n\t/** Files affected */\n\tfilesAffected: number;\n\t/** Was eventually recovered via different path? */\n\teventuallyRecovered: boolean;\n}\n\n/**\n * Team benchmark comparison\n */\nexport interface TeamBenchmark {\n\t/** Metric name */\n\tmetric: string;\n\t/** User's value */\n\tuserValue: number;\n\t/** Team average */\n\tteamAverage: number;\n\t/** Team percentile (0-100) */\n\tpercentile: number;\n\t/** Elite threshold for this metric */\n\teliteThreshold: number;\n}\n\n/**\n * Session history entry\n */\nexport interface SessionHistoryEntry {\n\t/** Session ID */\n\tsessionId: string;\n\t/** Start timestamp */\n\tstartTime: number;\n\t/** End timestamp */\n\tendTime: number;\n\t/** Phase during session */\n\tphase: DevelopmentPhase;\n\t/** Peak risk score */\n\tpeakRiskScore: number;\n\t/** Snapshots created */\n\tsnapshotsCreated: number;\n\t/** Recoveries performed */\n\trecoveriesPerformed: number;\n\t/** Lines committed */\n\tlinesCommitted: number;\n\t/** AI contribution fraction */\n\taiFraction: number;\n\t/** Had bad outcome (revert/bug) */\n\thadBadOutcome: boolean;\n}\n\n/**\n * Risk calibration data for self-tuning visualization\n */\nexport interface RiskCalibrationData {\n\t/** Total sessions analyzed */\n\ttotalSessions: number;\n\t/** Bad outcome rate overall */\n\tbadOutcomeRate: number;\n\t/** Threshold adjustment history */\n\tthresholdHistory: Array<{\n\t\ttimestamp: number;\n\t\toldThreshold: number;\n\t\tnewThreshold: number;\n\t\treason: string;\n\t}>;\n\t/** Risk score buckets with outcome rates */\n\tbucketStats: Array<{\n\t\trange: string;\n\t\tsessions: number;\n\t\tbadOutcomeRate: number;\n\t}>;\n}\n\n/**\n * Web console metrics bundle\n */\nexport interface WebConsoleMetrics {\n\t/** Core trust metrics */\n\tcore: CoreTrustMetrics;\n\t/** Full DORA metrics snapshot */\n\tdora: DORASnapshot;\n\t/** DORA trends (last 30 days) */\n\tdoraTrends: DORATrendPoint[];\n\t/** Recovery failure log (last 20) */\n\trecoveryFailures: RecoveryFailureDetail[];\n\t/** Team benchmarks (if available) */\n\tteamBenchmarks: TeamBenchmark[];\n\t/** Session history (last 50) */\n\tsessionHistory: SessionHistoryEntry[];\n\t/** Risk calibration data */\n\triskCalibration: RiskCalibrationData;\n\t/** Cumulative stats */\n\tcumulativeStats: {\n\t\ttotalSnapshots: number;\n\t\ttotalRecoveries: number;\n\t\ttotalLinesProtected: number;\n\t\ttotalHoursProtected: number;\n\t\tfirstSnapshotAt: number | null;\n\t};\n}\n\n// =============================================================================\n// SYNC PROTOCOL\n// =============================================================================\n\n/**\n * Sync request from extension to console\n */\nexport interface SyncRequest {\n\t/** Request type */\n\ttype: \"full\" | \"incremental\" | \"metrics_only\";\n\t/** Workspace ID */\n\tworkspaceId: string;\n\t/** Last sync timestamp (for incremental) */\n\tlastSyncAt?: number;\n\t/** User ID (for team features) */\n\tuserId?: string;\n}\n\n/**\n * Sync response from console to extension\n */\nexport interface SyncResponse {\n\t/** Response status */\n\tstatus: \"success\" | \"partial\" | \"error\";\n\t/** Synced data */\n\tdata?: {\n\t\t/** Updated metrics */\n\t\tmetrics: Partial<WebConsoleMetrics>;\n\t\t/** Team benchmarks (if available) */\n\t\tteamBenchmarks?: TeamBenchmark[];\n\t\t/** Threshold adjustments from cloud calibration */\n\t\tthresholdAdjustments?: {\n\t\t\tsuggestCommit: number;\n\t\t\tautoSnapshot: number;\n\t\t};\n\t};\n\t/** Error message (if any) */\n\terror?: string;\n\t/** Sync timestamp */\n\tsyncedAt: number;\n}\n\n/**\n * Event payload for real-time updates\n */\nexport interface MetricsUpdateEvent {\n\t/** Event type */\n\ttype: \"vitals\" | \"commit_risk\" | \"snapshot\" | \"recovery\" | \"phase_change\";\n\t/** Workspace ID */\n\tworkspaceId: string;\n\t/** Payload data */\n\tpayload: Partial<ExtensionMetrics>;\n\t/** Event timestamp */\n\ttimestamp: number;\n}\n\n// =============================================================================\n// API SERVICE INTERFACE\n// =============================================================================\n\n/**\n * TrustMetricsService - Interface for metrics collection and sync\n *\n * @example\n * ```typescript\n * // In extension\n * const service = createTrustMetricsService(workspaceId);\n *\n * // Get extension metrics\n * const metrics = service.getExtensionMetrics();\n * dashboard.render(metrics);\n *\n * // Subscribe to updates\n * service.onUpdate((event) => {\n *   dashboard.update(event.payload);\n * });\n *\n * // Sync to web console\n * await service.syncToConsole({ type: 'incremental', lastSyncAt });\n * ```\n */\nexport interface TrustMetricsService {\n\t/** Get current extension metrics */\n\tgetExtensionMetrics(): ExtensionMetrics;\n\n\t/** Get web console metrics */\n\tgetWebConsoleMetrics(): WebConsoleMetrics;\n\n\t/** Get core trust metrics only */\n\tgetCoreTrustMetrics(): CoreTrustMetrics;\n\n\t/** Record a snapshot event */\n\trecordSnapshot(event: {\n\t\tsnapshotId: string;\n\t\ttimestamp: number;\n\t\tfilesProtected: number;\n\t\tlinesProtected: number;\n\t\ttrigger: \"manual\" | \"auto\" | \"ai-detected\" | \"recovery\";\n\t}): void;\n\n\t/** Record a recovery event */\n\trecordRecovery(event: RecoveryEvent): void;\n\n\t/** Record commit risk evaluation */\n\trecordRiskEvaluation(evaluation: RiskEvaluation): void;\n\n\t/** Subscribe to metrics updates */\n\tonUpdate(callback: (event: MetricsUpdateEvent) => void): () => void;\n\n\t/** Sync to web console */\n\tsyncToConsole(request: SyncRequest): Promise<SyncResponse>;\n\n\t/** Apply threshold adjustments from cloud */\n\tapplyThresholdAdjustments(adjustments: { suggestCommit: number; autoSnapshot: number }): void;\n}\n\n// =============================================================================\n// DISPLAY FORMATTERS\n// =============================================================================\n\n/**\n * Format recovery confidence for display\n */\nexport function formatRecoveryConfidence(confidence: RecoveryConfidence): string {\n\tif (confidence.score >= 95) {\n\t\treturn \"Excellent\";\n\t}\n\tif (confidence.score >= 85) {\n\t\treturn \"High\";\n\t}\n\tif (confidence.score >= 70) {\n\t\treturn \"Good\";\n\t}\n\tif (confidence.score >= 50) {\n\t\treturn \"Moderate\";\n\t}\n\treturn \"Building Trust\";\n}\n\n/**\n * Format mean time to recovery for display\n */\nexport function formatMTTR(ms: number): string {\n\tif (ms < 1000) {\n\t\treturn `${ms}ms`;\n\t}\n\tif (ms < 60000) {\n\t\treturn `${(ms / 1000).toFixed(1)}s`;\n\t}\n\treturn `${(ms / 60000).toFixed(1)}m`;\n}\n\n/**\n * Format chain integrity for display\n */\nexport function formatChainIntegrity(chain: ChainIntegrity): string {\n\tif (!chain.isIntact) {\n\t\treturn \"Gaps Detected\";\n\t}\n\tif (chain.hasRollbackPoints && chain.chainLength >= 5) {\n\t\treturn \"Fully Protected\";\n\t}\n\tif (chain.chainLength >= 3) {\n\t\treturn \"Protected\";\n\t}\n\treturn \"Building Chain\";\n}\n\n/**\n * Format DORA tier with emoji\n */\nexport function formatDORATier(tier: \"elite\" | \"high\" | \"medium\" | \"low\"): string {\n\tswitch (tier) {\n\t\tcase \"elite\":\n\t\t\treturn \" Elite\";\n\t\tcase \"high\":\n\t\t\treturn \" High\";\n\t\tcase \"medium\":\n\t\t\treturn \" Medium\";\n\t\tcase \"low\":\n\t\t\treturn \" Building\";\n\t}\n}\n\n/**\n * Format save count message\n */\nexport function formatSaveCount(count: { today: number; thisWeek: number; allTime: number }): string {\n\tif (count.today > 0) {\n\t\treturn `SnapBack protected your work ${count.today} time${count.today === 1 ? \"\" : \"s\"} today`;\n\t}\n\tif (count.thisWeek > 0) {\n\t\treturn `SnapBack protected your work ${count.thisWeek} time${count.thisWeek === 1 ? \"\" : \"s\"} this week`;\n\t}\n\tif (count.allTime > 0) {\n\t\treturn `SnapBack has protected your work ${count.allTime} time${count.allTime === 1 ? \"\" : \"s\"}`;\n\t}\n\treturn \"SnapBack is ready to protect your work\";\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\n// All types exported inline above\n","/**\n * TrustMetricsServiceImpl - Concrete implementation of TrustMetricsService\n *\n * Collects and aggregates trust-building metrics from:\n * - DORAMetrics (recovery success, MTTR)\n * - CommitRiskSystem (risk evaluations, outcomes)\n * - SnapshotChain (integrity, coverage)\n * - PressureGauge (recommendations, activity)\n *\n * Provides data for both extension webview (real-time) and web console (historical).\n *\n * @packageDocumentation\n */\n\nimport type { CommitRiskSystem, RiskEvaluation } from \"./CommitRiskSystem.js\";\nimport type { DORAMetrics, DORASnapshot, RecoveryEvent } from \"./DORAMetrics.js\";\nimport type { PhaseDetectionResult } from \"./learning/PhaseDetector.js\";\nimport type { PressureRecommendation } from \"./PressureGauge.js\";\nimport type {\n\tActivityAuditEntry,\n\tChainIntegrity,\n\tCoreTrustMetrics,\n\tDORATrendPoint,\n\tExtensionMetrics,\n\tLiveVitals,\n\tMetricsUpdateEvent,\n\tRecoveryConfidence,\n\tRecoveryFailureDetail,\n\tSessionHistoryEntry,\n\tSessionProtection,\n\tSyncRequest,\n\tSyncResponse,\n\tWebConsoleMetrics,\n} from \"./TrustMetricsAPI.js\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Maximum entries for various tracking arrays */\nconst TRACKING_LIMITS = {\n\t/** Maximum snapshot chain entries */\n\tmaxSnapshotChain: 100,\n\t/** Maximum AI calibration events */\n\tmaxAIToolEvents: 100,\n\t/** Maximum recovery failures to return */\n\tmaxRecoveryFailures: 20,\n\t/** Minimum AI events for calibration calculation */\n\tminAIEventsForCalibration: 10,\n\t/** AI calibration smoothing divisor */\n\taiCalibrationSmoothingDivisor: 50,\n\t/** Default AI tool calibration confidence */\n\tdefaultAICalibration: 85,\n} as const;\n\n/** Time constants in milliseconds */\nconst TIME_CONSTANTS = {\n\t/** Gap threshold for chain integrity (4 hours) */\n\tchainGapThresholdMs: 4 * 60 * 60 * 1000,\n\t/** One day in milliseconds */\n\toneDayMs: 24 * 60 * 60 * 1000,\n\t/** Protection threshold in minutes */\n\tprotectionThresholdMinutes: 30,\n\t/** Maximum unsnapshoted changes for protection */\n\tmaxUnsnapshotedChangesForProtection: 100,\n} as const;\n\n/** Estimation constants */\nconst ESTIMATION_CONSTANTS = {\n\t/** Estimated lines per file change */\n\tlinesPerFileEstimate: 10,\n\t/** Base recovery time in ms */\n\tbaseRecoveryTimeMs: 2000,\n\t/** Recovery time per file in ms */\n\trecoveryTimePerFileMs: 100,\n\t/** Default recent snapshot files estimate */\n\tdefaultRecentSnapshotFiles: 5,\n} as const;\n\n// =============================================================================\n// TYPE MAPPINGS\n// =============================================================================\n\n/** Valid pulse levels */\ntype PulseLevel = \"resting\" | \"active\" | \"elevated\" | \"racing\";\n\n/** Valid temperature levels */\ntype TemperatureLevel = \"cool\" | \"warm\" | \"hot\" | \"critical\";\n\n/** Valid trajectory values */\ntype Trajectory = \"improving\" | \"stable\" | \"declining\" | \"critical\";\n\n/**\n * Map string to valid pulse level with fallback\n */\nfunction toPulseLevel(level: string): PulseLevel {\n\tconst validLevels: PulseLevel[] = [\"resting\", \"active\", \"elevated\", \"racing\"];\n\treturn validLevels.includes(level as PulseLevel) ? (level as PulseLevel) : \"active\";\n}\n\n/**\n * Map string to valid temperature level with fallback\n */\nfunction toTemperatureLevel(level: string): TemperatureLevel {\n\tconst validLevels: TemperatureLevel[] = [\"cool\", \"warm\", \"hot\", \"critical\"];\n\treturn validLevels.includes(level as TemperatureLevel) ? (level as TemperatureLevel) : \"warm\";\n}\n\n/**\n * Map string to valid trajectory with fallback\n */\nfunction toTrajectory(trajectory: string): Trajectory {\n\tconst validTrajectories: Trajectory[] = [\"improving\", \"stable\", \"declining\", \"critical\"];\n\treturn validTrajectories.includes(trajectory as Trajectory) ? (trajectory as Trajectory) : \"stable\";\n}\n\n// =============================================================================\n// IMPLEMENTATION\n// =============================================================================\n\n/**\n * Configuration for TrustMetricsServiceImpl\n */\nexport interface TrustMetricsConfig {\n\t/** Workspace identifier */\n\tworkspaceId: string;\n\t/** Maximum audit trail entries to keep */\n\tmaxAuditEntries?: number;\n\t/** Metrics measurement window (ms) */\n\tmeasurementWindow?: number;\n\t/** Maximum session history entries to keep */\n\tmaxSessionHistory?: number;\n\t/** Maximum DORA trend points to keep */\n\tmaxDORATrendPoints?: number;\n\t/** Maximum threshold history entries to keep */\n\tmaxThresholdHistory?: number;\n}\n\n/**\n * Dependencies injected into TrustMetricsServiceImpl\n */\nexport interface TrustMetricsDeps {\n\t/** DORA metrics tracker */\n\tdoraMetrics: DORAMetrics;\n\t/** Commit risk system */\n\tcommitRiskSystem?: CommitRiskSystem;\n\t/** Get current vitals snapshot (optional - for LiveVitals) */\n\tgetVitals?: () => {\n\t\tpulse: { level: string; changesPerMinute: number };\n\t\ttemperature: { level: string; aiPercentage: number };\n\t\tpressure: {\n\t\t\tvalue: number;\n\t\t\tunsnapshotedChanges: number;\n\t\t\ttimeSinceLastSnapshot: number;\n\t\t\tcriticalFilesTouched: string[];\n\t\t};\n\t\toxygen: { value: number };\n\t\ttrajectory: string;\n\t} | null;\n\t/** Get current phase detection (optional) */\n\tgetCurrentPhase?: () => PhaseDetectionResult;\n\t/** Get pressure recommendation (optional) */\n\tgetPressureRecommendation?: () => PressureRecommendation;\n}\n\n/**\n * TrustMetricsServiceImpl - Collects and exposes trust metrics\n *\n * @example\n * ```typescript\n * const service = new TrustMetricsServiceImpl(\n *   { workspaceId: 'my-workspace' },\n *   { doraMetrics, commitRiskSystem, getVitals }\n * );\n *\n * // Record events\n * service.recordSnapshot({\n *   snapshotId: 'snap-1',\n *   timestamp: Date.now(),\n *   filesProtected: 5,\n *   linesProtected: 150,\n *   trigger: 'auto'\n * });\n *\n * // Get metrics\n * const extensionMetrics = service.getExtensionMetrics();\n * const consoleMetrics = service.getWebConsoleMetrics();\n * ```\n */\nexport class TrustMetricsServiceImpl {\n\tprivate readonly config: Required<TrustMetricsConfig>;\n\tprivate readonly deps: TrustMetricsDeps;\n\tprivate disposed = false;\n\n\t// Activity audit trail\n\tprivate auditTrail: ActivityAuditEntry[] = [];\n\n\t// Save counters\n\tprivate saveCount = {\n\t\ttoday: 0,\n\t\tthisWeek: 0,\n\t\tallTime: 0,\n\t};\n\tprivate lastResetDate = new Date().toDateString();\n\n\t// Event listeners\n\tprivate updateListeners: Array<(event: MetricsUpdateEvent) => void> = [];\n\n\t// Session history tracking\n\tprivate sessionHistory: SessionHistoryEntry[] = [];\n\tprivate currentSession: Partial<SessionHistoryEntry> | null = null;\n\n\t// DORA trend tracking\n\tprivate doraTrends: DORATrendPoint[] = [];\n\tprivate lastDORATrendRecordedAt = 0;\n\n\t// Threshold history tracking\n\tprivate thresholdHistory: Array<{\n\t\ttimestamp: number;\n\t\toldThreshold: number;\n\t\tnewThreshold: number;\n\t\treason: string;\n\t}> = [];\n\n\t// Cumulative stats tracking\n\tprivate cumulativeStats = {\n\t\ttotalLinesProtected: 0,\n\t\ttotalHoursProtected: 0,\n\t\tfirstSnapshotAt: null as number | null,\n\t\tsessionStartTime: Date.now(),\n\t};\n\n\t// Chain integrity tracking\n\tprivate snapshotChain: Array<{\n\t\tsnapshotId: string;\n\t\ttimestamp: number;\n\t\tparentId?: string;\n\t}> = [];\n\n\t// Last recovery tracking\n\tprivate lastRecoveryAt: number | null = null;\n\n\t// AI tool calibration data\n\tprivate aiToolEvents: Array<{\n\t\ttimestamp: number;\n\t\tpredicted: boolean;\n\t\tactual: boolean;\n\t}> = [];\n\n\tconstructor(config: TrustMetricsConfig, deps: TrustMetricsDeps) {\n\t\tthis.config = {\n\t\t\tworkspaceId: config.workspaceId,\n\t\t\tmaxAuditEntries: config.maxAuditEntries ?? 100,\n\t\t\tmeasurementWindow: config.measurementWindow ?? 60 * 60 * 1000, // 1 hour\n\t\t\tmaxSessionHistory: config.maxSessionHistory ?? 50,\n\t\t\tmaxDORATrendPoints: config.maxDORATrendPoints ?? 30, // 30 days\n\t\t\tmaxThresholdHistory: config.maxThresholdHistory ?? 20,\n\t\t};\n\t\tthis.deps = deps;\n\t}\n\n\t// =========================================================================\n\t// PUBLIC API\n\t// =========================================================================\n\n\t/**\n\t * Get current extension metrics (real-time, in-context)\n\t */\n\tgetExtensionMetrics(): ExtensionMetrics {\n\t\tconst core = this.getCoreTrustMetrics();\n\t\tconst vitals = this.getLiveVitals();\n\t\tconst commitRisk = this.getCurrentCommitRisk();\n\t\tconst phase = this.deps.getCurrentPhase?.() ?? this.getDefaultPhase();\n\t\tconst recommendation = this.deps.getPressureRecommendation?.() ?? this.getDefaultRecommendation();\n\n\t\treturn {\n\t\t\tcore,\n\t\t\tvitals,\n\t\t\tcommitRisk,\n\t\t\tphase,\n\t\t\trecommendation,\n\t\t\trecentActivity: this.getRecentActivity(10),\n\t\t\tsaveCount: this.getSaveCount(),\n\t\t};\n\t}\n\n\t/**\n\t * Get web console metrics (historical analysis)\n\t */\n\tgetWebConsoleMetrics(): WebConsoleMetrics {\n\t\tconst core = this.getCoreTrustMetrics();\n\t\tconst dora = this.deps.doraMetrics.getMetrics();\n\n\t\t// Record DORA trend point if enough time has passed (daily)\n\t\tthis.maybeRecordDORATrend(dora);\n\n\t\treturn {\n\t\t\tcore,\n\t\t\tdora,\n\t\t\tdoraTrends: this.getDORATrends(),\n\t\t\trecoveryFailures: this.getRecoveryFailures(),\n\t\t\tteamBenchmarks: this.getTeamBenchmarks(),\n\t\t\tsessionHistory: this.getSessionHistory(),\n\t\t\triskCalibration: this.getRiskCalibration(),\n\t\t\tcumulativeStats: this.getCumulativeStats(),\n\t\t};\n\t}\n\n\t/**\n\t * Get core trust metrics only\n\t */\n\tgetCoreTrustMetrics(): CoreTrustMetrics {\n\t\tconst dora = this.deps.doraMetrics.getMetrics();\n\n\t\treturn {\n\t\t\trecoveryConfidence: this.calculateRecoveryConfidence(dora),\n\t\t\tchainIntegrity: this.getChainIntegrity(),\n\t\t\tsessionProtection: this.getSessionProtection(),\n\t\t\tperformanceTier: dora.performanceTier,\n\t\t\tupdatedAt: Date.now(),\n\t\t};\n\t}\n\n\t/**\n\t * Record a snapshot event\n\t */\n\trecordSnapshot(event: {\n\t\tsnapshotId: string;\n\t\ttimestamp: number;\n\t\tfilesProtected: number;\n\t\tlinesProtected: number;\n\t\ttrigger: \"manual\" | \"auto\" | \"ai-detected\" | \"recovery\";\n\t\tparentSnapshotId?: string;\n\t}): void {\n\t\t// Add to audit trail\n\t\tthis.addAuditEntry({\n\t\t\ttype: \"snapshot_created\",\n\t\t\ttimestamp: event.timestamp,\n\t\t\tdescription: `Snapshot created (${event.trigger}): ${event.filesProtected} files, ${event.linesProtected} lines`,\n\t\t\twasProtective: event.trigger === \"auto\" || event.trigger === \"ai-detected\",\n\t\t});\n\n\t\t// Track snapshot chain\n\t\tthis.snapshotChain.push({\n\t\t\tsnapshotId: event.snapshotId,\n\t\t\ttimestamp: event.timestamp,\n\t\t\tparentId: event.parentSnapshotId,\n\t\t});\n\n\t\t// Cap chain to configured limit\n\t\tif (this.snapshotChain.length > TRACKING_LIMITS.maxSnapshotChain) {\n\t\t\tthis.snapshotChain.shift();\n\t\t}\n\n\t\t// Update cumulative stats\n\t\tthis.cumulativeStats.totalLinesProtected += event.linesProtected;\n\t\tif (this.cumulativeStats.firstSnapshotAt === null) {\n\t\t\tthis.cumulativeStats.firstSnapshotAt = event.timestamp;\n\t\t}\n\n\t\t// Increment save counters\n\t\tthis.incrementSaveCount();\n\n\t\t// Emit update event\n\t\tthis.emitUpdate(\"snapshot\", {\n\t\t\tcore: this.getCoreTrustMetrics(),\n\t\t\trecentActivity: this.getRecentActivity(10),\n\t\t\tsaveCount: this.getSaveCount(),\n\t\t} as Partial<ExtensionMetrics>);\n\t}\n\n\t/**\n\t * Record a recovery event\n\t */\n\trecordRecovery(event: RecoveryEvent): void {\n\t\t// Pass to DORA metrics\n\t\tthis.deps.doraMetrics.recordRecovery(event);\n\n\t\t// Track last recovery timestamp\n\t\tthis.lastRecoveryAt = event.completionTime;\n\n\t\t// Add to audit trail\n\t\tthis.addAuditEntry({\n\t\t\ttype: \"recovery_performed\",\n\t\t\ttimestamp: event.requestTime,\n\t\t\tdescription: event.success\n\t\t\t\t? `Recovery succeeded: ${event.filesRestored} files in ${event.completionTime - event.requestTime}ms`\n\t\t\t\t: `Recovery failed: ${event.failureReason ?? \"unknown error\"}`,\n\t\t\twasProtective: false,\n\t\t});\n\n\t\t// Track AI calibration event (did we predict this recovery was needed?)\n\t\t// For now, assume prediction was correct if recovery succeeded\n\t\tthis.aiToolEvents.push({\n\t\t\ttimestamp: event.requestTime,\n\t\t\tpredicted: true, // We predicted recovery might be needed\n\t\t\tactual: event.success, // Recovery was actually successful\n\t\t});\n\n\t\t// Cap AI events to configured limit\n\t\tif (this.aiToolEvents.length > TRACKING_LIMITS.maxAIToolEvents) {\n\t\t\tthis.aiToolEvents.shift();\n\t\t}\n\n\t\t// Emit update event\n\t\tthis.emitUpdate(\"recovery\", {\n\t\t\tcore: this.getCoreTrustMetrics(),\n\t\t\trecentActivity: this.getRecentActivity(10),\n\t\t} as Partial<ExtensionMetrics>);\n\t}\n\n\t/**\n\t * Record commit risk evaluation\n\t */\n\trecordRiskEvaluation(evaluation: RiskEvaluation): void {\n\t\t// Add to audit trail if threshold crossed\n\t\tif (evaluation.score >= 0.55) {\n\t\t\tthis.addAuditEntry({\n\t\t\t\ttype: \"risk_threshold_crossed\",\n\t\t\t\ttimestamp: evaluation.context.now,\n\t\t\t\tdescription: `Risk score: ${(evaluation.score * 100).toFixed(0)}% - ${evaluation.reason}`,\n\t\t\t\twasProtective: evaluation.action === \"auto_snapshot\",\n\t\t\t});\n\t\t}\n\n\t\t// Emit update event\n\t\tthis.emitUpdate(\"commit_risk\", {\n\t\t\tcommitRisk: {\n\t\t\t\tscore: evaluation.score,\n\t\t\t\tbreakdown: evaluation.breakdown,\n\t\t\t\taction: evaluation.action,\n\t\t\t\tescalation: evaluation.escalation,\n\t\t\t\treason: evaluation.reason,\n\t\t\t\teducational: evaluation.educational,\n\t\t\t},\n\t\t} as Partial<ExtensionMetrics>);\n\t}\n\n\t/**\n\t * Subscribe to metrics updates\n\t */\n\tonUpdate(callback: (event: MetricsUpdateEvent) => void): () => void {\n\t\tthis.updateListeners.push(callback);\n\t\treturn () => {\n\t\t\tconst index = this.updateListeners.indexOf(callback);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.updateListeners.splice(index, 1);\n\t\t\t}\n\t\t};\n\t}\n\n\t/**\n\t * Sync to web console\n\t */\n\tasync syncToConsole(_request: SyncRequest): Promise<SyncResponse> {\n\t\t// TODO: Implement actual API sync\n\t\t// This is a placeholder that returns local data\n\t\tconst consoleMetrics = this.getWebConsoleMetrics();\n\n\t\treturn {\n\t\t\tstatus: \"success\",\n\t\t\tdata: {\n\t\t\t\tmetrics: consoleMetrics,\n\t\t\t},\n\t\t\tsyncedAt: Date.now(),\n\t\t};\n\t}\n\n\t/**\n\t * Apply threshold adjustments from cloud\n\t */\n\tapplyThresholdAdjustments(adjustments: { suggestCommit: number; autoSnapshot: number }): void {\n\t\tif (this.deps.commitRiskSystem) {\n\t\t\tconst currentConfig = this.deps.commitRiskSystem.getConfig();\n\n\t\t\t// Record threshold history for suggestCommit\n\t\t\tif (adjustments.suggestCommit !== currentConfig.thresholds.suggestCommit) {\n\t\t\t\tthis.thresholdHistory.push({\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\toldThreshold: currentConfig.thresholds.suggestCommit,\n\t\t\t\t\tnewThreshold: adjustments.suggestCommit,\n\t\t\t\t\treason: \"Cloud sync adjustment\",\n\t\t\t\t});\n\n\t\t\t\t// Cap threshold history\n\t\t\t\tif (this.thresholdHistory.length > this.config.maxThresholdHistory) {\n\t\t\t\t\tthis.thresholdHistory.shift();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Apply the thresholds\n\t\t\tthis.deps.commitRiskSystem.setThresholds(adjustments);\n\t\t}\n\t}\n\n\t/**\n\t * Dispose of resources and clear state\n\t * Call when the service is no longer needed to prevent memory leaks\n\t */\n\tdispose(): void {\n\t\tif (this.disposed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.disposed = true;\n\n\t\t// Clear all listeners\n\t\tthis.updateListeners.length = 0;\n\n\t\t// Clear tracking data\n\t\tthis.auditTrail.length = 0;\n\t\tthis.sessionHistory.length = 0;\n\t\tthis.doraTrends.length = 0;\n\t\tthis.thresholdHistory.length = 0;\n\t\tthis.snapshotChain.length = 0;\n\t\tthis.aiToolEvents.length = 0;\n\n\t\t// Clear current session\n\t\tthis.currentSession = null;\n\t}\n\n\t/**\n\t * Check if the service has been disposed\n\t */\n\tisDisposed(): boolean {\n\t\treturn this.disposed;\n\t}\n\n\t/**\n\t * Start a new session for history tracking\n\t * @throws Error if sessionId is empty or service is disposed\n\t */\n\tstartSession(sessionId: string): void {\n\t\tif (this.disposed) {\n\t\t\tthrow new Error(\"TrustMetricsService has been disposed\");\n\t\t}\n\t\tif (!sessionId || sessionId.trim().length === 0) {\n\t\t\tthrow new Error(\"sessionId must be a non-empty string\");\n\t\t}\n\n\t\tconst phase = this.deps.getCurrentPhase?.() ?? this.getDefaultPhase();\n\n\t\tthis.currentSession = {\n\t\t\tsessionId: sessionId.trim(),\n\t\t\tstartTime: Date.now(),\n\t\t\tphase: phase.phase,\n\t\t\tpeakRiskScore: 0,\n\t\t\tsnapshotsCreated: 0,\n\t\t\trecoveriesPerformed: 0,\n\t\t\tlinesCommitted: 0,\n\t\t\taiFraction: 0,\n\t\t\thadBadOutcome: false,\n\t\t};\n\t}\n\n\t/**\n\t * End the current session and add to history\n\t */\n\tendSession(outcome: { linesCommitted: number; aiFraction: number; hadBadOutcome: boolean }): void {\n\t\tif (!this.currentSession || !this.currentSession.sessionId || !this.currentSession.startTime) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst completedSession: SessionHistoryEntry = {\n\t\t\tsessionId: this.currentSession.sessionId,\n\t\t\tstartTime: this.currentSession.startTime,\n\t\t\tendTime: Date.now(),\n\t\t\tphase: this.currentSession.phase ?? \"unknown\",\n\t\t\tpeakRiskScore: this.currentSession.peakRiskScore ?? 0,\n\t\t\tsnapshotsCreated: this.currentSession.snapshotsCreated ?? 0,\n\t\t\trecoveriesPerformed: this.currentSession.recoveriesPerformed ?? 0,\n\t\t\tlinesCommitted: outcome.linesCommitted,\n\t\t\taiFraction: outcome.aiFraction,\n\t\t\thadBadOutcome: outcome.hadBadOutcome,\n\t\t};\n\n\t\tthis.sessionHistory.push(completedSession);\n\n\t\t// Cap session history\n\t\tif (this.sessionHistory.length > this.config.maxSessionHistory) {\n\t\t\tthis.sessionHistory.shift();\n\t\t}\n\n\t\t// Update cumulative hours protected\n\t\tconst sessionHours = (completedSession.endTime - completedSession.startTime) / (1000 * 60 * 60);\n\t\tthis.cumulativeStats.totalHoursProtected += sessionHours;\n\n\t\tthis.currentSession = null;\n\t}\n\n\t/**\n\t * Update current session with risk evaluation\n\t */\n\tupdateSessionRisk(riskScore: number): void {\n\t\tif (this.currentSession) {\n\t\t\tthis.currentSession.peakRiskScore = Math.max(this.currentSession.peakRiskScore ?? 0, riskScore);\n\t\t}\n\t}\n\n\t/**\n\t * Increment snapshot count for current session\n\t */\n\tincrementSessionSnapshots(): void {\n\t\tif (this.currentSession) {\n\t\t\tthis.currentSession.snapshotsCreated = (this.currentSession.snapshotsCreated ?? 0) + 1;\n\t\t}\n\t}\n\n\t/**\n\t * Increment recovery count for current session\n\t */\n\tincrementSessionRecoveries(): void {\n\t\tif (this.currentSession) {\n\t\t\tthis.currentSession.recoveriesPerformed = (this.currentSession.recoveriesPerformed ?? 0) + 1;\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// PRIVATE HELPERS\n\t// =========================================================================\n\n\tprivate getLiveVitals(): LiveVitals {\n\t\tconst vitals = this.deps.getVitals?.();\n\t\tif (!vitals) {\n\t\t\treturn this.getDefaultVitals();\n\t\t}\n\n\t\treturn {\n\t\t\tpulse: {\n\t\t\t\tlevel: toPulseLevel(vitals.pulse.level),\n\t\t\t\tchangesPerMinute: vitals.pulse.changesPerMinute,\n\t\t\t},\n\t\t\ttemperature: {\n\t\t\t\tlevel: toTemperatureLevel(vitals.temperature.level),\n\t\t\t\taiPercentage: vitals.temperature.aiPercentage,\n\t\t\t},\n\t\t\tpressure: vitals.pressure,\n\t\t\toxygen: {\n\t\t\t\tlevel: vitals.oxygen.value > 70 ? \"healthy\" : vitals.oxygen.value > 30 ? \"low\" : \"critical\",\n\t\t\t\tcoveragePercent: vitals.oxygen.value,\n\t\t\t},\n\t\t\ttrajectory: toTrajectory(vitals.trajectory),\n\t\t};\n\t}\n\n\tprivate getCurrentCommitRisk(): ExtensionMetrics[\"commitRisk\"] {\n\t\t// Return default safe state if no commit risk system\n\t\treturn {\n\t\t\tscore: 0,\n\t\t\tbreakdown: {\n\t\t\t\ttimeRisk: 0,\n\t\t\t\tlinesRisk: 0,\n\t\t\t\tfilesRisk: 0,\n\t\t\t\taiRisk: 0,\n\t\t\t\tchurnRisk: 0,\n\t\t\t\trawScore: 0,\n\t\t\t\tphaseMultiplier: 1.0,\n\t\t\t\tfinalScore: 0,\n\t\t\t},\n\t\t\taction: \"none\",\n\t\t\tescalation: \"none\",\n\t\t\treason: \"Session health good\",\n\t\t};\n\t}\n\n\tprivate calculateRecoveryConfidence(dora: DORASnapshot): RecoveryConfidence {\n\t\tconst score = Math.min(\n\t\t\tdora.recoverySuccessRate,\n\t\t\tdora.performanceTier === \"elite\" ? 100 : dora.performanceTier === \"high\" ? 90 : 75,\n\t\t);\n\n\t\tconst trends = this.deps.doraMetrics.getTrends();\n\n\t\treturn {\n\t\t\tscore,\n\t\t\tsuccessfulRecoveries: Math.round(dora.totalRecoveries * (dora.recoverySuccessRate / 100)),\n\t\t\tfailedRecoveries: Math.round(dora.totalRecoveries * (1 - dora.recoverySuccessRate / 100)),\n\t\t\tmeanTimeToRecovery: dora.meanTimeToRecovery,\n\t\t\ttrend: trends.recoveryTrend,\n\t\t\tlastRecoveryAt: this.lastRecoveryAt,\n\t\t\taiToolCalibration: this.calculateAIToolCalibration(),\n\t\t};\n\t}\n\n\t/**\n\t * Calculate AI tool calibration score from prediction accuracy\n\t * Measures how well the system predicted risk vs actual outcomes\n\t */\n\tprivate calculateAIToolCalibration(): number {\n\t\tif (this.aiToolEvents.length < TRACKING_LIMITS.minAIEventsForCalibration) {\n\t\t\treturn TRACKING_LIMITS.defaultAICalibration;\n\t\t}\n\n\t\t// Calculate accuracy: how often prediction matched actual outcome\n\t\tconst correct = this.aiToolEvents.filter((e) => e.predicted === e.actual).length;\n\t\tconst accuracy = (correct / this.aiToolEvents.length) * 100;\n\n\t\t// Smooth toward default to avoid wild swings\n\t\tconst smoothingFactor = Math.min(this.aiToolEvents.length / TRACKING_LIMITS.aiCalibrationSmoothingDivisor, 1);\n\t\treturn TRACKING_LIMITS.defaultAICalibration * (1 - smoothingFactor) + accuracy * smoothingFactor;\n\t}\n\n\tprivate getChainIntegrity(): ChainIntegrity {\n\t\tconst chainLength = this.snapshotChain.length;\n\t\tconst gaps: ChainIntegrity[\"gaps\"] = [];\n\n\t\t// Check for gaps in the chain (time gaps above threshold indicate missing snapshots)\n\t\tfor (let i = 1; i < this.snapshotChain.length; i++) {\n\t\t\tconst prev = this.snapshotChain[i - 1];\n\t\t\tconst curr = this.snapshotChain[i];\n\t\t\tconst timeDiff = curr.timestamp - prev.timestamp;\n\n\t\t\tif (timeDiff > TIME_CONSTANTS.chainGapThresholdMs) {\n\t\t\t\tconst hoursGap = Math.round(timeDiff / (60 * 60 * 1000));\n\t\t\t\tgaps.push({\n\t\t\t\t\tstart: prev.timestamp,\n\t\t\t\t\tend: curr.timestamp,\n\t\t\t\t\treason: `${hoursGap} hour gap between snapshots`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Check for rollback points (snapshots created specifically for recovery)\n\t\tconst hasRollbackPoints = this.auditTrail.some(\n\t\t\t(entry) => entry.type === \"snapshot_created\" && entry.description.includes(\"recovery\"),\n\t\t);\n\n\t\tconst oldestRecoverable = chainLength > 0 ? this.snapshotChain[0].timestamp : null;\n\n\t\treturn {\n\t\t\tisIntact: gaps.length === 0,\n\t\t\tchainLength,\n\t\t\thasRollbackPoints,\n\t\t\toldestRecoverable,\n\t\t\tgaps,\n\t\t};\n\t}\n\n\tprivate getSessionProtection(): SessionProtection {\n\t\tconst vitals = this.deps.getVitals?.();\n\n\t\tif (!vitals) {\n\t\t\treturn {\n\t\t\t\tisProtected: true,\n\t\t\t\tminutesSinceSnapshot: 0,\n\t\t\t\tfilesSinceSnapshot: 0,\n\t\t\t\tlinesSinceSnapshot: 0,\n\t\t\t\testimatedRecoveryTime: ESTIMATION_CONSTANTS.baseRecoveryTimeMs,\n\t\t\t\tcoveragePercent: 100,\n\t\t\t};\n\t\t}\n\n\t\tconst minutesSinceSnapshot = vitals.pressure.timeSinceLastSnapshot / (60 * 1000);\n\t\tconst isProtected =\n\t\t\tminutesSinceSnapshot < TIME_CONSTANTS.protectionThresholdMinutes &&\n\t\t\tvitals.pressure.unsnapshotedChanges < TIME_CONSTANTS.maxUnsnapshotedChangesForProtection;\n\n\t\t// Estimate recovery time based on chain length and snapshot size\n\t\tconst recentSnapshotFiles = this.snapshotChain.length > 0 ? ESTIMATION_CONSTANTS.defaultRecentSnapshotFiles : 0;\n\t\tconst estimatedRecoveryTime =\n\t\t\tESTIMATION_CONSTANTS.baseRecoveryTimeMs + recentSnapshotFiles * ESTIMATION_CONSTANTS.recoveryTimePerFileMs;\n\n\t\t// Coverage based on how much of the session is protected\n\t\tconst coveragePercent = Math.max(0, Math.min(100, 100 - vitals.pressure.value));\n\n\t\treturn {\n\t\t\tisProtected,\n\t\t\tminutesSinceSnapshot,\n\t\t\tfilesSinceSnapshot: vitals.pressure.unsnapshotedChanges,\n\t\t\tlinesSinceSnapshot: vitals.pressure.unsnapshotedChanges * ESTIMATION_CONSTANTS.linesPerFileEstimate,\n\t\t\testimatedRecoveryTime,\n\t\t\tcoveragePercent,\n\t\t};\n\t}\n\n\tprivate getDORATrends(): WebConsoleMetrics[\"doraTrends\"] {\n\t\treturn [...this.doraTrends];\n\t}\n\n\tprivate maybeRecordDORATrend(dora: DORASnapshot): void {\n\t\tconst now = Date.now();\n\n\t\t// Record at most once per day\n\t\tif (now - this.lastDORATrendRecordedAt < TIME_CONSTANTS.oneDayMs) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.doraTrends.push({\n\t\t\ttimestamp: now,\n\t\t\tmetrics: { ...dora },\n\t\t});\n\n\t\t// Cap to max entries\n\t\tif (this.doraTrends.length > this.config.maxDORATrendPoints) {\n\t\t\tthis.doraTrends.shift();\n\t\t}\n\n\t\tthis.lastDORATrendRecordedAt = now;\n\t}\n\n\tprivate getRecoveryFailures(): WebConsoleMetrics[\"recoveryFailures\"] {\n\t\t// Extract recovery failures from audit trail\n\t\tconst failures: RecoveryFailureDetail[] = [];\n\n\t\tfor (const entry of this.auditTrail) {\n\t\t\tif (entry.type === \"recovery_performed\" && entry.description.includes(\"failed\")) {\n\t\t\t\t// Parse failure details from description\n\t\t\t\tconst match = entry.description.match(/Recovery failed: (.+)/);\n\t\t\t\tfailures.push({\n\t\t\t\t\tsnapshotId: `snap-${entry.timestamp}`, // Best effort ID\n\t\t\t\t\ttimestamp: entry.timestamp,\n\t\t\t\t\treason: match?.[1] ?? \"unknown error\",\n\t\t\t\t\tfilesAffected: 0, // Not tracked in audit entry\n\t\t\t\t\teventuallyRecovered: false, // Would need to check subsequent entries\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Return most recent failures\n\t\treturn failures.slice(-TRACKING_LIMITS.maxRecoveryFailures);\n\t}\n\n\tprivate getSessionHistory(): SessionHistoryEntry[] {\n\t\treturn [...this.sessionHistory].slice(-this.config.maxSessionHistory);\n\t}\n\n\tprivate getTeamBenchmarks(): WebConsoleMetrics[\"teamBenchmarks\"] {\n\t\t// Team benchmarks require aggregated data from multiple users\n\t\t// For now, return empty array - would be populated by web console sync\n\t\treturn [];\n\t}\n\n\tprivate getRiskCalibration(): WebConsoleMetrics[\"riskCalibration\"] {\n\t\tconst stats = this.deps.commitRiskSystem?.getOutcomeStats();\n\t\tif (!stats) {\n\t\t\treturn {\n\t\t\t\ttotalSessions: 0,\n\t\t\t\tbadOutcomeRate: 0,\n\t\t\t\tthresholdHistory: this.thresholdHistory,\n\t\t\t\tbucketStats: [],\n\t\t\t};\n\t\t}\n\n\t\tconst bucketStats = Array.from(stats.bucketStats.entries()).map(([range, data]) => ({\n\t\t\trange,\n\t\t\tsessions: data.count,\n\t\t\tbadOutcomeRate: data.badRate,\n\t\t}));\n\n\t\treturn {\n\t\t\ttotalSessions: stats.totalSessions,\n\t\t\tbadOutcomeRate: stats.badOutcomeRate,\n\t\t\tthresholdHistory: this.thresholdHistory,\n\t\t\tbucketStats,\n\t\t};\n\t}\n\n\tprivate getCumulativeStats(): WebConsoleMetrics[\"cumulativeStats\"] {\n\t\tconst dora = this.deps.doraMetrics.getMetrics();\n\t\tconst hoursProtected = (Date.now() - this.cumulativeStats.sessionStartTime) / (1000 * 60 * 60);\n\n\t\treturn {\n\t\t\ttotalSnapshots: dora.totalSnapshots,\n\t\t\ttotalRecoveries: dora.totalRecoveries,\n\t\t\ttotalLinesProtected: this.cumulativeStats.totalLinesProtected,\n\t\t\ttotalHoursProtected: this.cumulativeStats.totalHoursProtected + hoursProtected,\n\t\t\tfirstSnapshotAt: this.cumulativeStats.firstSnapshotAt,\n\t\t};\n\t}\n\n\tprivate addAuditEntry(entry: ActivityAuditEntry): void {\n\t\tthis.auditTrail.push(entry);\n\t\tif (this.auditTrail.length > this.config.maxAuditEntries) {\n\t\t\tthis.auditTrail.shift();\n\t\t}\n\t}\n\n\tprivate getRecentActivity(count: number): ActivityAuditEntry[] {\n\t\treturn this.auditTrail.slice(-count).reverse();\n\t}\n\n\tprivate incrementSaveCount(): void {\n\t\t// Reset counters if day/week changed\n\t\tconst today = new Date().toDateString();\n\t\tif (today !== this.lastResetDate) {\n\t\t\tconst lastDate = new Date(this.lastResetDate);\n\t\t\tconst currentDate = new Date(today);\n\t\t\tconst daysDiff = Math.floor((currentDate.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24));\n\n\t\t\tif (daysDiff >= 1) {\n\t\t\t\tthis.saveCount.today = 0;\n\t\t\t}\n\t\t\tif (daysDiff >= 7) {\n\t\t\t\tthis.saveCount.thisWeek = 0;\n\t\t\t}\n\t\t\tthis.lastResetDate = today;\n\t\t}\n\n\t\tthis.saveCount.today++;\n\t\tthis.saveCount.thisWeek++;\n\t\tthis.saveCount.allTime++;\n\t}\n\n\tprivate getSaveCount(): ExtensionMetrics[\"saveCount\"] {\n\t\treturn { ...this.saveCount };\n\t}\n\n\tprivate emitUpdate(type: MetricsUpdateEvent[\"type\"], payload: Partial<ExtensionMetrics>): void {\n\t\tconst event: MetricsUpdateEvent = {\n\t\t\ttype,\n\t\t\tworkspaceId: this.config.workspaceId,\n\t\t\tpayload,\n\t\t\ttimestamp: Date.now(),\n\t\t};\n\n\t\tfor (const listener of this.updateListeners) {\n\t\t\ttry {\n\t\t\t\tlistener(event);\n\t\t\t} catch {\n\t\t\t\t// Swallow listener errors to prevent cascade failures\n\t\t\t}\n\t\t}\n\t}\n\n\t// Default fallbacks\n\tprivate getDefaultVitals(): LiveVitals {\n\t\treturn {\n\t\t\tpulse: { level: \"resting\", changesPerMinute: 0 },\n\t\t\ttemperature: { level: \"cool\", aiPercentage: 0 },\n\t\t\tpressure: { value: 0, unsnapshotedChanges: 0, timeSinceLastSnapshot: 0, criticalFilesTouched: [] },\n\t\t\toxygen: { level: \"healthy\", coveragePercent: 100 },\n\t\t\ttrajectory: \"stable\",\n\t\t};\n\t}\n\n\tprivate getDefaultPhase(): PhaseDetectionResult {\n\t\treturn {\n\t\t\tphase: \"unknown\",\n\t\t\tconfidence: 0.3,\n\t\t\tbranchName: \"main\",\n\t\t\tthresholds: {\n\t\t\t\tintervalMultiplier: 1.0,\n\t\t\t\tmaxLinesBeforeSnapshot: 300,\n\t\t\t\triskMultiplier: 1.0,\n\t\t\t\trecommendedIntervalMinutes: 45,\n\t\t\t\taiAdjustedIntervalMinutes: 25,\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate getDefaultRecommendation(): PressureRecommendation {\n\t\treturn {\n\t\t\tshouldSnapshot: false,\n\t\t\turgency: 0,\n\t\t\treason: \"Session health good - no action needed\",\n\t\t\tcontext: {\n\t\t\t\tpressure: 0,\n\t\t\t\tchanges: 0,\n\t\t\t\tminutesSinceSnapshot: 0,\n\t\t\t\tcriticalFiles: [],\n\t\t\t},\n\t\t\taction: \"none\",\n\t\t};\n\t}\n}\n\n/**\n * Factory function to create TrustMetricsServiceImpl\n */\nexport function createTrustMetricsService(config: TrustMetricsConfig, deps: TrustMetricsDeps): TrustMetricsServiceImpl {\n\treturn new TrustMetricsServiceImpl(config, deps);\n}\n","/**\n * BehaviorTracker - Collects behavioral metadata during dev sessions\n *\n * Phase 2 enhancement: Tracks developer workflow patterns\n * - Session duration\n * - AI acceptance rate\n * - Code churn\n * - Test pass rate\n */\n\nimport type { BehavioralMetadata } from \"../types/vitals.js\";\n\ninterface EditEvent {\n\ttimestamp: number;\n\tlinesAdded: number;\n\tlinesDeleted: number;\n}\n\ninterface TestEvent {\n\ttimestamp: number;\n\tpassed: boolean;\n}\n\ninterface AISuggestionEvent {\n\ttimestamp: number;\n\taccepted: boolean;\n}\n\nexport class BehaviorTracker {\n\tprivate sessionStart: number;\n\tprivate edits: EditEvent[] = [];\n\tprivate tests: TestEvent[] = [];\n\tprivate aiSuggestions: AISuggestionEvent[] = [];\n\tprivate fileSaves = 0;\n\n\tconstructor(initialTime: number = Date.now()) {\n\t\tthis.sessionStart = initialTime;\n\t}\n\n\t/**\n\t * Record a file edit event\n\t */\n\trecordEdit(linesAdded: number, linesDeleted: number, timestamp: number = Date.now()): void {\n\t\tthis.edits.push({ timestamp, linesAdded, linesDeleted });\n\t}\n\n\t/**\n\t * Record a file save\n\t */\n\trecordFileSave(): void {\n\t\tthis.fileSaves++;\n\t}\n\n\t/**\n\t * Record a test execution result\n\t */\n\trecordTest(passed: boolean, timestamp: number = Date.now()): void {\n\t\tthis.tests.push({ timestamp, passed });\n\t}\n\n\t/**\n\t * Record an AI suggestion event\n\t */\n\trecordAISuggestion(accepted: boolean, timestamp: number = Date.now()): void {\n\t\tthis.aiSuggestions.push({ timestamp, accepted });\n\t}\n\n\t/**\n\t * Record a snapshot creation (resets session)\n\t */\n\trecordSnapshot(timestamp: number = Date.now()): void {\n\t\tthis.sessionStart = timestamp;\n\t\t// Don't clear metrics - preserve for analytics\n\t}\n\n\t/**\n\t * Get current behavioral metadata\n\t */\n\tgetMetadata(now: number = Date.now()): BehavioralMetadata {\n\t\tconst sessionDuration = now - this.sessionStart;\n\n\t\t// Calculate AI acceptance rate\n\t\tconst totalSuggestions = this.aiSuggestions.length;\n\t\tconst acceptedSuggestions = this.aiSuggestions.filter((s) => s.accepted).length;\n\t\tconst rejectedSuggestions = totalSuggestions - acceptedSuggestions;\n\t\tconst aiAcceptanceRate = totalSuggestions > 0 ? acceptedSuggestions / totalSuggestions : 0;\n\n\t\t// Calculate code churn rate (lines per minute)\n\t\tconst totalLinesChanged = this.edits.reduce((sum, e) => sum + e.linesAdded + e.linesDeleted, 0);\n\t\tconst sessionMinutes = sessionDuration / (60 * 1000);\n\t\tconst churnRate = sessionMinutes > 0 ? totalLinesChanged / sessionMinutes : 0;\n\n\t\t// Calculate test pass rate\n\t\tconst totalTests = this.tests.length;\n\t\tconst passedTests = this.tests.filter((t) => t.passed).length;\n\t\tconst testPassRate = totalTests > 0 ? passedTests / totalTests : 1.0; // Default to 100% if no tests\n\n\t\t// Calculate average time between edits\n\t\tlet avgTimeBetweenEdits = 0;\n\t\tif (this.edits.length > 1) {\n\t\t\tconst intervals: number[] = [];\n\t\t\tfor (let i = 1; i < this.edits.length; i++) {\n\t\t\t\tintervals.push(this.edits[i].timestamp - this.edits[i - 1].timestamp);\n\t\t\t}\n\t\t\tavgTimeBetweenEdits = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;\n\t\t}\n\n\t\treturn {\n\t\t\tsessionDuration,\n\t\t\taiAcceptanceRate,\n\t\t\tchurnRate,\n\t\t\ttestPassRate,\n\t\t\tfileSaveCount: this.fileSaves,\n\t\t\taiSuggestionsShown: totalSuggestions,\n\t\t\taiSuggestionsAccepted: acceptedSuggestions,\n\t\t\taiSuggestionsRejected: rejectedSuggestions,\n\t\t\tavgTimeBetweenEdits,\n\t\t};\n\t}\n\n\t/**\n\t * Reset all tracking data\n\t */\n\treset(timestamp: number = Date.now()): void {\n\t\tthis.sessionStart = timestamp;\n\t\tthis.edits = [];\n\t\tthis.tests = [];\n\t\tthis.aiSuggestions = [];\n\t\tthis.fileSaves = 0;\n\t}\n\n\t/**\n\t * Get raw metrics for testing\n\t */\n\tgetRawCounts(): {\n\t\tedits: number;\n\t\ttests: number;\n\t\tsuggestions: number;\n\t\tsaves: number;\n\t} {\n\t\treturn {\n\t\t\tedits: this.edits.length,\n\t\t\ttests: this.tests.length,\n\t\t\tsuggestions: this.aiSuggestions.length,\n\t\t\tsaves: this.fileSaves,\n\t\t};\n\t}\n}\n","/**\n * WorkspaceVitals - Core vitals orchestrator\n *\n * Combines all four vital signs into a unified workspace health monitor:\n * - Pulse: Change velocity\n * - Temperature: AI activity level\n * - Pressure: Risk accumulation\n * - Oxygen: Snapshot coverage\n *\n * Phase 4 additions:\n * - User behavior learning\n * - Per-workspace threshold calibration\n * - Trajectory prediction\n *\n * Provides decision support for when to create snapshots and guides AI agents.\n *\n * @performance Budget: <10ms for current() snapshot\n */\n\nimport { EventEmitter } from \"node:events\";\nimport type {\n\tAgentGuidance,\n\tAIDetectionEvent,\n\tSnapshotDecision,\n\tSnapshotEvent,\n\tTrajectory,\n\tVitalsConfig,\n\tVitalsFileChangeEvent,\n\tVitalsSnapshot,\n} from \"../types/vitals.js\";\nimport type { ThresholdAdjustments, TrajectoryForecast } from \"../types/vitals-learning.js\";\nimport { BehaviorTracker } from \"./BehaviorTracker.js\";\nimport { OXYGEN_THRESHOLDS, PRESSURE_THRESHOLDS, TRAJECTORY_THRESHOLDS } from \"./constants.js\";\nimport { PhaseDetector } from \"./learning/PhaseDetector.js\";\nimport { ThresholdCalibrator } from \"./learning/ThresholdCalibrator.js\";\nimport { TrajectoryPredictor } from \"./learning/TrajectoryPredictor.js\";\nimport { UserBehaviorLearner } from \"./learning/UserBehaviorLearner.js\";\nimport { DEFAULT_OXYGEN_CONFIG, OxygenSensor } from \"./OxygenSensor.js\";\nimport { DEFAULT_PRESSURE_CONFIG, PressureGauge } from \"./PressureGauge.js\";\nimport { DEFAULT_PULSE_CONFIG, PulseTracker } from \"./PulseTracker.js\";\nimport { DEFAULT_TEMPERATURE_CONFIG, TemperatureMonitor } from \"./TemperatureMonitor.js\";\n\n/** Default vitals configuration */\nexport const DEFAULT_VITALS_CONFIG: VitalsConfig = {\n\tpulse: DEFAULT_PULSE_CONFIG,\n\ttemperature: DEFAULT_TEMPERATURE_CONFIG,\n\tpressure: DEFAULT_PRESSURE_CONFIG,\n\toxygen: DEFAULT_OXYGEN_CONFIG,\n};\n\n/**\n * Unified workspace vitals monitor.\n *\n * Singleton per workspace ID to maintain consistent state.\n * Emits events: 'update', 'warning', 'critical'\n */\nexport class WorkspaceVitals extends EventEmitter {\n\tprivate static instances: Map<string, WorkspaceVitals> = new Map();\n\n\tprivate readonly pulse: PulseTracker;\n\tprivate readonly temperature: TemperatureMonitor;\n\tprivate readonly pressure: PressureGauge;\n\tprivate readonly oxygen: OxygenSensor;\n\tprivate readonly config: VitalsConfig;\n\tprivate history: VitalsSnapshot[] = [];\n\tprivate readonly maxHistory = 100;\n\n\t// Phase 4: Learning components\n\t// biome-ignore lint/correctness/noUnusedPrivateClassMembers: stored for context/debugging\n\tprivate readonly workspaceId: string;\n\tprivate readonly learner: UserBehaviorLearner;\n\tprivate readonly calibrator: ThresholdCalibrator;\n\tprivate readonly predictor: TrajectoryPredictor;\n\tprivate readonly phaseDetector: PhaseDetector;\n\tprivate currentBranch = \"main\";\n\n\t// Phase 2: Behavioral metadata tracking\n\tprivate readonly behaviorTracker: BehaviorTracker;\n\n\tprivate constructor(workspaceId: string, config: Partial<VitalsConfig> = {}, initialTime: number = Date.now()) {\n\t\tsuper();\n\t\tthis.workspaceId = workspaceId;\n\t\tthis.config = {\n\t\t\tpulse: { ...DEFAULT_VITALS_CONFIG.pulse, ...config.pulse },\n\t\t\ttemperature: { ...DEFAULT_VITALS_CONFIG.temperature, ...config.temperature },\n\t\t\tpressure: { ...DEFAULT_VITALS_CONFIG.pressure, ...config.pressure },\n\t\t\toxygen: { ...DEFAULT_VITALS_CONFIG.oxygen, ...config.oxygen },\n\t\t};\n\n\t\tthis.pulse = new PulseTracker(this.config.pulse);\n\t\tthis.temperature = new TemperatureMonitor(this.config.temperature);\n\t\tthis.pressure = new PressureGauge(this.config.pressure, initialTime);\n\t\tthis.oxygen = new OxygenSensor(this.config.oxygen);\n\n\t\t// Initialize learning components\n\t\tthis.learner = new UserBehaviorLearner(workspaceId);\n\t\tthis.calibrator = new ThresholdCalibrator(workspaceId, this.learner);\n\t\tthis.predictor = new TrajectoryPredictor(workspaceId);\n\t\tthis.phaseDetector = new PhaseDetector();\n\n\t\t// Initialize behavior tracking\n\t\tthis.behaviorTracker = new BehaviorTracker(initialTime);\n\t}\n\n\t/**\n\t * Get or create WorkspaceVitals for a workspace.\n\t * Singleton per workspaceId.\n\t */\n\tstatic for(workspaceId: string, config?: Partial<VitalsConfig>): WorkspaceVitals {\n\t\tlet instance = WorkspaceVitals.instances.get(workspaceId);\n\t\tif (!instance) {\n\t\t\tinstance = new WorkspaceVitals(workspaceId, config);\n\t\t\tWorkspaceVitals.instances.set(workspaceId, instance);\n\t\t}\n\t\treturn instance;\n\t}\n\n\t/**\n\t * Create a new instance (for testing - bypasses singleton).\n\t */\n\tstatic create(config?: Partial<VitalsConfig>, initialTime?: number): WorkspaceVitals {\n\t\treturn new WorkspaceVitals(`test-${Date.now()}`, config, initialTime);\n\t}\n\n\t/**\n\t * Clear all singleton instances (for testing).\n\t */\n\tstatic clearInstances(): void {\n\t\tWorkspaceVitals.instances.clear();\n\t}\n\n\t/**\n\t * Try to get an existing WorkspaceVitals instance.\n\t * Returns undefined if none exists for the workspace.\n\t */\n\tstatic tryGet(workspaceId: string): WorkspaceVitals | undefined {\n\t\treturn WorkspaceVitals.instances.get(workspaceId);\n\t}\n\n\t// =========================================================================\n\t// EVENT HANDLERS\n\t// =========================================================================\n\n\t/**\n\t * Handle a file change event.\n\t */\n\tonFileChange(event: VitalsFileChangeEvent, now: number = Date.now()): void {\n\t\tthis.pulse.recordChange(now);\n\t\tthis.pressure.recordChange(event.path);\n\t\tthis.oxygen.recordModification(event.path);\n\n\t\tif (event.isAI) {\n\t\t\tthis.temperature.recordAIActivity(event.tool, now);\n\t\t} else {\n\t\t\tthis.temperature.recordHumanActivity(now);\n\t\t}\n\n\t\tthis.checkAndEmit(now);\n\t}\n\n\t/**\n\t * Handle a snapshot creation event.\n\t */\n\tonSnapshot(event: SnapshotEvent, now: number = Date.now()): void {\n\t\tthis.pressure.recordSnapshot(now);\n\t\tthis.oxygen.recordSnapshot(event.filePath, now);\n\t\tthis.behaviorTracker.recordSnapshot(now);\n\t\tthis.checkAndEmit(now);\n\t}\n\n\t/**\n\t * Handle AI detection event.\n\t */\n\tonAIDetected(detection: AIDetectionEvent, now: number = Date.now()): void {\n\t\tif (detection.confidence > 0.6) {\n\t\t\tthis.temperature.recordAIActivity(detection.tool, now);\n\t\t}\n\t\tthis.checkAndEmit(now);\n\t}\n\n\t// =========================================================================\n\t// CURRENT STATE\n\t// =========================================================================\n\n\t/**\n\t * Get current vitals snapshot.\n\t * NOTE: This is a pure getter - does NOT mutate history.\n\t * Use recordHistorySnapshot() for explicit history recording.\n\t */\n\tcurrent(now: number = Date.now()): VitalsSnapshot {\n\t\tconst pulseData = this.pulse.getLevel(now);\n\t\tconst tempData = this.temperature.getLevel(now);\n\t\tconst pressureData = this.pressure.getState(now);\n\t\tconst oxygenData = this.oxygen.getLevel(now);\n\n\t\tconst snapshot: VitalsSnapshot = {\n\t\t\ttimestamp: now,\n\t\t\tpulse: pulseData,\n\t\t\ttemperature: tempData,\n\t\t\tpressure: pressureData,\n\t\t\toxygen: oxygenData,\n\t\t\ttrajectory: this.calculateTrajectory(pulseData, tempData, pressureData, oxygenData),\n\t\t\t// Include behavioral metadata\n\t\t\tbehavior: this.behaviorTracker.getMetadata(now),\n\t\t};\n\n\t\treturn snapshot;\n\t}\n\n\t/**\n\t * Explicitly record a history snapshot.\n\t * Call this on meaningful state changes (e.g., after onFileChange, onSnapshot).\n\t * History is bounded FIFO with maxHistory limit.\n\t */\n\trecordHistorySnapshot(now: number = Date.now()): void {\n\t\tconst snapshot = this.current(now);\n\n\t\t// Record history (bounded FIFO)\n\t\tthis.history.push(snapshot);\n\t\tif (this.history.length > this.maxHistory) {\n\t\t\tthis.history.shift();\n\t\t}\n\t}\n\n\t/**\n\t * Get historical snapshots.\n\t */\n\tgetHistory(): VitalsSnapshot[] {\n\t\treturn [...this.history];\n\t}\n\n\t/**\n\t * Get structured pressure recommendation for snapshot decisions.\n\t *\n\t * This provides actionable, context-aware recommendations based on\n\t * current pressure state. Use this to enhance AutoDecisionEngine\n\t * with educational messaging and urgency levels.\n\t *\n\t * @param now Optional timestamp for testing\n\t * @returns PressureRecommendation with action, urgency, and educational context\n\t */\n\tgetPressureRecommendation(now: number = Date.now()) {\n\t\treturn this.pressure.getRecommendation(now);\n\t}\n\n\t// =========================================================================\n\t// DECISION SUPPORT\n\t// =========================================================================\n\n\t/**\n\t * Determine if a snapshot should be created.\n\t * Uses centralized thresholds from constants.ts\n\t */\n\tshouldSnapshot(now: number = Date.now()): SnapshotDecision {\n\t\tconst vitals = this.current(now);\n\n\t\tif (vitals.trajectory === \"critical\") {\n\t\t\treturn {\n\t\t\t\tshould: true,\n\t\t\t\treason: \"Critical risk state - immediate snapshot recommended\",\n\t\t\t\turgency: \"critical\",\n\t\t\t};\n\t\t}\n\n\t\tif (vitals.pressure.value >= PRESSURE_THRESHOLDS.critical) {\n\t\t\treturn {\n\t\t\t\tshould: true,\n\t\t\t\treason: `High pressure (${vitals.pressure.value}%) - ${vitals.pressure.unsnapshotedChanges} unsaved changes`,\n\t\t\t\turgency: \"high\",\n\t\t\t};\n\t\t}\n\n\t\tif (vitals.pressure.criticalFilesTouched.length > 0 && vitals.oxygen.value < OXYGEN_THRESHOLDS.low) {\n\t\t\treturn {\n\t\t\t\tshould: true,\n\t\t\t\treason: `Critical files modified without snapshot: ${vitals.pressure.criticalFilesTouched.join(\", \")}`,\n\t\t\t\turgency: \"high\",\n\t\t\t};\n\t\t}\n\n\t\tif (vitals.temperature.level === \"burning\" && vitals.oxygen.value < OXYGEN_THRESHOLDS.moderate) {\n\t\t\treturn {\n\t\t\t\tshould: true,\n\t\t\t\treason: \"Heavy AI activity with low snapshot coverage\",\n\t\t\t\turgency: \"medium\",\n\t\t\t};\n\t\t}\n\n\t\tif (vitals.pressure.value >= PRESSURE_THRESHOLDS.moderate) {\n\t\t\treturn {\n\t\t\t\tshould: false,\n\t\t\t\treason: \"Consider snapshotting soon\",\n\t\t\t\turgency: \"low\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tshould: false,\n\t\t\treason: \"No immediate action needed\",\n\t\t\turgency: \"none\",\n\t\t};\n\t}\n\n\t/**\n\t * Get guidance for AI agents.\n\t */\n\tgetAgentGuidance(now: number = Date.now()): AgentGuidance {\n\t\tconst vitals = this.current(now);\n\t\tconst snapshotDecision = this.shouldSnapshot(now);\n\n\t\tconst blockedOps: string[] = [];\n\t\tif (vitals.trajectory === \"critical\") {\n\t\t\tblockedOps.push(\"delete\", \"refactor-large\", \"mass-rename\");\n\t\t}\n\n\t\tconst safeOps = [\"read\", \"analyze\", \"suggest\"];\n\t\tif (vitals.oxygen.value > 80 && vitals.pressure.value < 40) {\n\t\t\tsafeOps.push(\"write\", \"modify\", \"refactor-small\");\n\t\t}\n\n\t\treturn {\n\t\t\tshouldSnapshot: snapshotDecision.should,\n\t\t\tsnapshotReason: snapshotDecision.should ? snapshotDecision.reason : undefined,\n\t\t\triskyFiles: vitals.pressure.criticalFilesTouched,\n\t\t\tsafeOperations: safeOps,\n\t\t\tblockedOperations: blockedOps,\n\t\t\tsuggestion: this.getSuggestion(vitals),\n\t\t};\n\t}\n\n\t/**\n\t * Get threshold multiplier for dynamic risk adjustment.\n\t */\n\tgetThresholdMultiplier(now: number = Date.now()): number {\n\t\tconst vitals = this.current(now);\n\n\t\t// High temperature  more protective (lower threshold)\n\t\tconst tempMultiplier = {\n\t\t\tcold: 1.2,\n\t\t\twarm: 1.0,\n\t\t\thot: 0.8,\n\t\t\tburning: 0.6,\n\t\t}[vitals.temperature.level];\n\n\t\t// High oxygen  less protective (higher threshold)\n\t\tconst oxygenMultiplier = vitals.oxygen.value > 80 ? 1.2 : 1.0;\n\n\t\t// High pressure  more protective\n\t\tconst pressureMultiplier = vitals.pressure.value > 60 ? 0.8 : 1.0;\n\n\t\treturn tempMultiplier * oxygenMultiplier * pressureMultiplier;\n\t}\n\n\t// =========================================================================\n\t// PHASE 4: LEARNING & CALIBRATION\n\t// =========================================================================\n\n\t/**\n\t * Record user behavior for learning.\n\t * Call when user creates a snapshot to learn their patterns.\n\t */\n\trecordBehavior(userCreatedSnapshot: boolean, now: number = Date.now()): void {\n\t\tconst vitals = this.current(now);\n\t\tconst decision = this.shouldSnapshot(now);\n\n\t\t// Record observation\n\t\tthis.learner.recordObservation({\n\t\t\tvitals,\n\t\t\tuserCreatedSnapshot,\n\t\t\tvitalsRecommended: decision.should,\n\t\t});\n\n\t\t// Update calibration\n\t\tthis.calibrator.updateFromBehavior();\n\n\t\t// Record for trajectory prediction\n\t\tthis.predictor.recordSnapshots([vitals]);\n\t}\n\n\t/**\n\t * Get calibrated threshold adjustments.\n\t * Returns per-workspace learned adjustments (multipliers).\n\t */\n\tgetCalibratedThresholds(): ThresholdAdjustments {\n\t\treturn this.calibrator.getAdjustedThresholds();\n\t}\n\n\t/**\n\t * Get trajectory forecast.\n\t * Predicts future trajectory based on recent history.\n\t */\n\tgetForecast(): TrajectoryForecast {\n\t\treturn this.predictor.predict();\n\t}\n\n\t/**\n\t * Get user behavior statistics.\n\t */\n\tgetBehaviorStats() {\n\t\treturn this.learner.getStats();\n\t}\n\n\t/**\n\t * Get workspace calibration profile.\n\t */\n\tgetCalibrationProfile() {\n\t\treturn this.calibrator.getProfile();\n\t}\n\n\t/**\n\t * Reset learning data for this workspace.\n\t */\n\tresetLearning(): void {\n\t\tthis.calibrator.reset();\n\t\tthis.predictor.reset();\n\t}\n\n\t// =========================================================================\n\t// PHASE 2: BEHAVIORAL METADATA TRACKING\n\t// =========================================================================\n\n\t/**\n\t * Record a file edit event for behavioral analytics.\n\t */\n\trecordEdit(linesAdded: number, linesDeleted: number, timestamp: number = Date.now()): void {\n\t\tthis.behaviorTracker.recordEdit(linesAdded, linesDeleted, timestamp);\n\t}\n\n\t/**\n\t * Record a file save event.\n\t */\n\trecordFileSave(): void {\n\t\tthis.behaviorTracker.recordFileSave();\n\t}\n\n\t/**\n\t * Record a test execution result.\n\t */\n\trecordTest(passed: boolean, timestamp: number = Date.now()): void {\n\t\tthis.behaviorTracker.recordTest(passed, timestamp);\n\t}\n\n\t/**\n\t * Record an AI suggestion event.\n\t * @param accepted Whether the user accepted the AI suggestion\n\t */\n\trecordAISuggestion(accepted: boolean, timestamp: number = Date.now()): void {\n\t\tthis.behaviorTracker.recordAISuggestion(accepted, timestamp);\n\t}\n\n\t/**\n\t * Get current behavioral metadata.\n\t */\n\tgetBehavioralMetadata(now: number = Date.now()) {\n\t\treturn this.behaviorTracker.getMetadata(now);\n\t}\n\n\t// =========================================================================\n\t// PHASE DETECTION (Development Phase-Aware Thresholds)\n\t// =========================================================================\n\n\t/**\n\t * Set the current git branch for phase-aware calculations.\n\t * PhaseDetector uses branch naming patterns to adjust thresholds.\n\t * - hotfix/*  More protective (0.7x intervals, 1.5x risk)\n\t * - feature/*  Standard thresholds\n\t * - release/*  More protective (0.75x intervals, 1.3x risk)\n\t */\n\tsetCurrentBranch(branchName: string): void {\n\t\tthis.currentBranch = branchName;\n\t\t// Clear cached phase detection\n\t\tthis.phaseDetector.clearCache();\n\t}\n\n\t/**\n\t * Get current branch name.\n\t */\n\tgetCurrentBranch(): string {\n\t\treturn this.currentBranch;\n\t}\n\n\t/**\n\t * Get phase-aware risk multiplier for pressure calculations.\n\t * Hotfix branches return higher multipliers (more protective).\n\t * Feature branches return standard multipliers.\n\t */\n\tgetPhaseRiskMultiplier(): number {\n\t\treturn this.phaseDetector.getRiskMultiplier(this.currentBranch);\n\t}\n\n\t/**\n\t * Get phase-aware threshold multiplier for intervals.\n\t * Hotfix branches return lower multipliers (more frequent checks).\n\t */\n\tgetPhaseThresholdMultiplier(): number {\n\t\treturn this.phaseDetector.getThresholdMultiplier(this.currentBranch);\n\t}\n\n\t/**\n\t * Get the detected development phase for current branch.\n\t */\n\tgetDetectedPhase(): ReturnType<typeof this.phaseDetector.detectPhase> {\n\t\treturn this.phaseDetector.detectPhase(this.currentBranch);\n\t}\n\n\t/**\n\t * Check if current phase requires more frequent snapshots.\n\t */\n\trequiresFrequentSnapshots(): boolean {\n\t\treturn this.phaseDetector.requiresFrequentSnapshots(this.currentBranch);\n\t}\n\n\t/**\n\t * Get combined threshold multiplier (calibrator + phase).\n\t * This is the primary method for adaptive thresholds.\n\t */\n\tgetCombinedThresholdMultiplier(now: number = Date.now()): number {\n\t\tconst baseMultiplier = this.getThresholdMultiplier(now);\n\t\tconst phaseMultiplier = this.getPhaseThresholdMultiplier();\n\t\treturn baseMultiplier * phaseMultiplier;\n\t}\n\n\t// =========================================================================\n\t// INTERNAL\n\t// =========================================================================\n\n\tprivate calculateTrajectory(\n\t\tpulse: VitalsSnapshot[\"pulse\"],\n\t\ttemp: VitalsSnapshot[\"temperature\"],\n\t\tpressure: VitalsSnapshot[\"pressure\"],\n\t\toxygen: VitalsSnapshot[\"oxygen\"],\n\t): Trajectory {\n\t\t// Critical: High pressure + Burning temp + Low oxygen\n\t\tif (\n\t\t\tpressure.value >= TRAJECTORY_THRESHOLDS.criticalPressure &&\n\t\t\ttemp.level === \"burning\" &&\n\t\t\toxygen.value < TRAJECTORY_THRESHOLDS.criticalOxygen\n\t\t) {\n\t\t\treturn \"critical\";\n\t\t}\n\n\t\t// Escalating: Rising pressure or heat without coverage\n\t\tif (\n\t\t\t(pressure.value >= TRAJECTORY_THRESHOLDS.escalatingPressure &&\n\t\t\t\toxygen.value < TRAJECTORY_THRESHOLDS.escalatingOxygen) ||\n\t\t\t(temp.level === \"hot\" && pulse.level === \"racing\")\n\t\t) {\n\t\t\treturn \"escalating\";\n\t\t}\n\n\t\t// Recovering: Decreasing pressure, good oxygen\n\t\tconst recentHistory = this.history.slice(-5);\n\t\tif (recentHistory.length >= 3) {\n\t\t\tconst latestPressure = recentHistory[recentHistory.length - 1]?.pressure.value ?? 0;\n\t\t\tconst earliestPressure = recentHistory[0]?.pressure.value ?? 0;\n\t\t\tconst pressureTrend = latestPressure - earliestPressure;\n\t\t\tif (\n\t\t\t\tpressureTrend < -TRAJECTORY_THRESHOLDS.recoveringPressureDrop &&\n\t\t\t\toxygen.value >= TRAJECTORY_THRESHOLDS.recoveringOxygen\n\t\t\t) {\n\t\t\t\treturn \"recovering\";\n\t\t\t}\n\t\t}\n\n\t\treturn \"stable\";\n\t}\n\n\tprivate getSuggestion(vitals: VitalsSnapshot): string {\n\t\tif (vitals.trajectory === \"critical\") {\n\t\t\treturn \"STOP: Create a checkpoint before making more changes\";\n\t\t}\n\t\tif (vitals.trajectory === \"escalating\") {\n\t\t\treturn \"Consider creating a snapshot - risk is accumulating\";\n\t\t}\n\t\tif (vitals.pressure.value >= PRESSURE_THRESHOLDS.critical) {\n\t\t\treturn \"High pressure - create a snapshot before continuing\";\n\t\t}\n\t\tif (vitals.pressure.value >= PRESSURE_THRESHOLDS.moderate) {\n\t\t\treturn \"Moderate pressure - consider creating a snapshot soon\";\n\t\t}\n\t\tif (vitals.temperature.level === \"burning\") {\n\t\t\treturn \"Heavy AI activity detected - extra caution recommended\";\n\t\t}\n\t\tif (vitals.oxygen.value < OXYGEN_THRESHOLDS.low) {\n\t\t\treturn \"Low snapshot coverage - protect your work\";\n\t\t}\n\t\treturn \"Proceed normally\";\n\t}\n\n\tprivate checkAndEmit(now: number): void {\n\t\tconst vitals = this.current(now);\n\t\tconst decision = this.shouldSnapshot(now);\n\n\t\tif (decision.urgency === \"critical\") {\n\t\t\tthis.emit(\"critical\", vitals);\n\t\t} else if (decision.urgency === \"high\") {\n\t\t\tthis.emit(\"warning\", vitals);\n\t\t}\n\n\t\tthis.emit(\"update\", vitals);\n\t}\n}\n","/**\n *  SnapBack Branding System\n *\n * Centralized branding, voice, and messaging for consistent AI agent communication.\n * Follows the SnapBack MCP Agent Instructions specification.\n *\n * @module branding\n */\n\n// =============================================================================\n// Brand Identity\n// =============================================================================\n\n/** The SnapBack brand prefix for all announcements */\nexport const BRAND_PREFIX = \" SnapBack:\";\n\n/** Compact wire format prefix (for token-efficient responses) */\nexport const WIRE_PREFIX = \"\";\n\n/**\n * Internal separator between wire format (agent-only) and user message.\n * Format: [wire format]\\n---\\n[user message]\n *\n * Agents should:\n * 1. Parse everything BEFORE \"---\" for structured data\n * 2. Display everything AFTER \"---\" to the user\n */\nexport const INTERNAL_SEPARATOR = \"\\n---\\n\";\n\n// =============================================================================\n// Voice Calibration\n// =============================================================================\n\n/**\n * Voice tone guidelines:\n * - Confident but not loud\n * - Helpful, not heroic\n * - Brief and clear\n * - Warm, not corporate\n */\n\n// =============================================================================\n// Message Templates by Operation Type\n// =============================================================================\n\nexport const messages = {\n\t// -------------------------------------------------------------------------\n\t// Snapshot/Checkpoint Operations\n\t// -------------------------------------------------------------------------\n\tsnapshot: {\n\t\t/** Default checkpoint created message */\n\t\tcreated: (context?: string) =>\n\t\t\tcontext\n\t\t\t\t? `${BRAND_PREFIX} Got it. Checkpoint created before ${context}.`\n\t\t\t\t: `${BRAND_PREFIX} Checkpoint created.`,\n\n\t\t/** Checkpoint with file count */\n\t\tcreatedWithStats: (files: number, lines: number) =>\n\t\t\t`${BRAND_PREFIX} Created checkpoint. Captured ${files} file${files !== 1 ? \"s\" : \"\"}, ${lines.toLocaleString()} lines.`,\n\n\t\t/** Proactive checkpoint before risky operation */\n\t\tproactive: (reason: string) => `${BRAND_PREFIX} Creating a checkpoint first${reason}.`,\n\n\t\t/** Checkpoint reused */\n\t\treused: () => `${BRAND_PREFIX} Recent checkpoint available.`,\n\n\t\t/** Checkpoint skipped */\n\t\tskipped: () => `${BRAND_PREFIX} Skipped checkpointalready protected.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Restore Operations\n\t// -------------------------------------------------------------------------\n\trestore: {\n\t\t/** Single file restored */\n\t\tsingle: (filename: string, timeAgo: string) => `${BRAND_PREFIX} Restored \\`${filename}\\` to ${timeAgo}.`,\n\n\t\t/** Multiple files restored */\n\t\tmultiple: (count: number, timeAgo: string) => `${BRAND_PREFIX} Restored ${count} files to ${timeAgo}.`,\n\n\t\t/** Restore with reassurance about saved changes */\n\t\twithReassurance: (filename: string, snapshotId: string) =>\n\t\t\t`${BRAND_PREFIX} Restored \\`${filename}\\`. Your recent changes are saved in snapshot #${snapshotId} if you need them back.`,\n\n\t\t/** Preview mode */\n\t\tpreview: (count: number) => `${BRAND_PREFIX} Would restore ${count} file${count !== 1 ? \"s\" : \"\"}.`,\n\n\t\t/** Can't restore - unsaved changes */\n\t\tcantRestoreUnsaved: (filename: string) =>\n\t\t\t`${BRAND_PREFIX} Can't restore \\`${filename}\\`you have unsaved changes. Save or discard first?`,\n\n\t\t/** Snapshot not found */\n\t\tnotFound: () => `${BRAND_PREFIX} No checkpoint found for that file. Want to create one now?`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Protection Status/Warnings\n\t// -------------------------------------------------------------------------\n\tprotection: {\n\t\t/** Gentle nudge for unprotected changes */\n\t\tnudge: (lines: number) =>\n\t\t\t`${BRAND_PREFIX} You've got ${lines.toLocaleString()}+ lines of unprotected changes. Want a checkpoint?`,\n\n\t\t/** Warning before risky operation */\n\t\tbeforeRisky: (filename: string) =>\n\t\t\t`${BRAND_PREFIX} No recent checkpoint for \\`${filename}\\`. Should I create one before we continue?`,\n\n\t\t/** All clear status */\n\t\tallClear: (minutesAgo: number) =>\n\t\t\t`${BRAND_PREFIX} You're covered. Last checkpoint was ${minutesAgo} minute${minutesAgo !== 1 ? \"s\" : \"\"} ago.`,\n\n\t\t/** Files protected count */\n\t\tprotected: (count: number) => `${BRAND_PREFIX} ${count} file${count !== 1 ? \"s\" : \"\"} protected.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Session Operations\n\t// -------------------------------------------------------------------------\n\tsession: {\n\t\t/** AI session started */\n\t\tstarted: () => `${BRAND_PREFIX} AI session detected. Auto-protecting changes.`,\n\n\t\t/** Session summary on completion */\n\t\tcomplete: (checkpoints: number, files: number) =>\n\t\t\t`${BRAND_PREFIX} Session complete. ${checkpoints} checkpoint${checkpoints !== 1 ? \"s\" : \"\"}, ${files} file${files !== 1 ? \"s\" : \"\"} protected.`,\n\n\t\t/** Task started */\n\t\ttaskStarted: (taskDesc?: string) =>\n\t\t\ttaskDesc ? `${BRAND_PREFIX} Got it. Starting: ${taskDesc}` : `${BRAND_PREFIX} Task started.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Validation/Check Operations\n\t// -------------------------------------------------------------------------\n\tvalidation: {\n\t\t/** All checks passed */\n\t\tpassed: () => `${BRAND_PREFIX} All clear. Code looks good.`,\n\n\t\t/** Issues found */\n\t\tissues: (errors: number, warnings: number) =>\n\t\t\t`${BRAND_PREFIX} Found ${errors} error${errors !== 1 ? \"s\" : \"\"}, ${warnings} warning${warnings !== 1 ? \"s\" : \"\"}.`,\n\n\t\t/** Quick validation complete */\n\t\tquickComplete: () => `${BRAND_PREFIX} Quick check done.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Learning Operations\n\t// -------------------------------------------------------------------------\n\tlearning: {\n\t\t/** Learning captured */\n\t\tcaptured: (type: string) => `${BRAND_PREFIX} Got it. ${capitalize(type)} captured for next time.`,\n\n\t\t/** Learning applied */\n\t\tapplied: (count: number) =>\n\t\t\t`${BRAND_PREFIX} Applied ${count} past learning${count !== 1 ? \"s\" : \"\"} to this task.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Violation Operations\n\t// -------------------------------------------------------------------------\n\tviolation: {\n\t\t/** Violation recorded */\n\t\trecorded: (type: string, count: number) => `${BRAND_PREFIX} Noted: ${type} (occurrence #${count}).`,\n\n\t\t/** Violation promoted to pattern */\n\t\tpromoted: (type: string) => `${BRAND_PREFIX} Heads up: ${type} is now a tracked patternseen 3+ times.`,\n\n\t\t/** Violation marked for automation */\n\t\tautomate: (type: string) => `${BRAND_PREFIX} ${type} marked for automationseen 5+ times.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Errors & Edge Cases\n\t// -------------------------------------------------------------------------\n\terror: {\n\t\t/** Generic error */\n\t\tgeneric: (reason: string) => `${BRAND_PREFIX} Couldn't complete${reason}.`,\n\n\t\t/** Storage issue */\n\t\tstorage: () => `${BRAND_PREFIX} Heads uprunning low on snapshot storage. Older checkpoints will auto-clean.`,\n\n\t\t/** Not found */\n\t\tnotFound: (what: string) => `${BRAND_PREFIX} ${what} not found.`,\n\t},\n\n\t// -------------------------------------------------------------------------\n\t// Token Savings (optional, only when meaningful)\n\t// -------------------------------------------------------------------------\n\tefficiency: {\n\t\t/** Token savings report */\n\t\ttokensSaved: (tokens: number) =>\n\t\t\t`${BRAND_PREFIX} Saved you ~${tokens.toLocaleString()} tokens vs. re-prompting.`,\n\n\t\t/** Session savings summary */\n\t\tsessionSavings: (restores: number, dollarsSaved: string) =>\n\t\t\t`${BRAND_PREFIX} This session: ${restores} restore${restores !== 1 ? \"s\" : \"\"}  ~$${dollarsSaved} in tokens saved.`,\n\t},\n} as const;\n\n// =============================================================================\n// Wire Format Helpers\n// =============================================================================\n\n/**\n * Wire format options\n */\nexport interface WireFormatOptions {\n\t/** Use compact positional format instead of labeled (default: false = labeled) */\n\tcompact?: boolean;\n}\n\n/**\n * Format a response in wire format with  brand prefix\n *\n * Default: Labeled format for LLM comprehension\n *   |S|id:task_1|snap:snap_a|risk:M|prot:85\n *\n * Compact (opt-in): Positional format for token efficiency\n *   |S|task_1|snap_a|M|85\n *\n * @param type - Wire type code (S, C, X, E, R, L, V, !)\n * @param fields - Named fields as key-value pairs\n * @param options - Format options (compact mode)\n */\nexport function formatWireLabeled(\n\ttype: string,\n\tfields: Record<string, string | number | undefined>,\n\toptions?: WireFormatOptions,\n): string {\n\tconst parts = [WIRE_PREFIX, type];\n\tconst entries = Object.entries(fields).filter(([, v]) => v !== undefined);\n\n\tif (options?.compact) {\n\t\t// Compact: positional values only\n\t\tparts.push(...entries.map(([, v]) => String(v)));\n\t} else {\n\t\t// Labeled: key:value pairs (default for LLM comprehension)\n\t\tparts.push(...entries.map(([k, v]) => `${k}:${v}`));\n\t}\n\n\treturn parts.join(\"|\");\n}\n\n/**\n * Legacy: Format a response in compact wire format with  brand prefix\n * Format: |TYPE|field1|field2|...\n *\n * @deprecated Use formatWireLabeled with compact: true instead\n */\nexport function formatWire(type: string, ...fields: (string | number)[]): string {\n\treturn [WIRE_PREFIX, type, ...fields.map(String)].join(\"|\");\n}\n\n/**\n * Format a human-readable branded message\n */\nexport function formatMessage(message: string): string {\n\t// If message already has brand prefix, return as-is\n\tif (message.startsWith(BRAND_PREFIX) || message.startsWith(WIRE_PREFIX)) {\n\t\treturn message;\n\t}\n\treturn `${BRAND_PREFIX} ${message}`;\n}\n\n/**\n * Compress a string for wire format (replace spaces, truncate)\n */\nexport function compress(s: string, maxLength: number): string {\n\tconst clean = s.replace(/\\s+/g, \"\");\n\treturn clean.length > maxLength ? `${clean.slice(0, maxLength - 1)}` : clean;\n}\n\n/**\n * Get relative time string (e.g., \"2m\", \"1h\", \"3d\")\n */\nexport function getRelativeTime(timestamp: number): string {\n\tconst diff = Date.now() - timestamp;\n\tconst minutes = Math.floor(diff / 60000);\n\tconst hours = Math.floor(minutes / 60);\n\tconst days = Math.floor(hours / 24);\n\n\tif (days > 0) {\n\t\treturn `${days}d`;\n\t}\n\tif (hours > 0) {\n\t\treturn `${hours}h`;\n\t}\n\tif (minutes > 0) {\n\t\treturn `${minutes}m`;\n\t}\n\treturn \"just now\";\n}\n\n/**\n * Get human-readable relative time (e.g., \"2 minutes ago\")\n */\nexport function getRelativeTimeHuman(timestamp: number): string {\n\tconst diff = Date.now() - timestamp;\n\tconst minutes = Math.floor(diff / 60000);\n\tconst hours = Math.floor(minutes / 60);\n\tconst days = Math.floor(hours / 24);\n\n\tif (days > 0) {\n\t\treturn `${days} day${days !== 1 ? \"s\" : \"\"} ago`;\n\t}\n\tif (hours > 0) {\n\t\treturn `${hours} hour${hours !== 1 ? \"s\" : \"\"} ago`;\n\t}\n\tif (minutes > 0) {\n\t\treturn `${minutes} minute${minutes !== 1 ? \"s\" : \"\"} ago`;\n\t}\n\treturn \"just now\";\n}\n\n// =============================================================================\n// Response Builders\n// =============================================================================\n\nexport interface WireResponse {\n\t/** The wire format string */\n\twire: string;\n\t/** Optional human-readable message */\n\tmessage?: string;\n}\n\n/**\n * Build a start task response\n *\n * Wire format (labeled):\n *   |S|id:<taskId>|snap:<snapshotId>|risk:<L/M/H>|prot:<0-100>|dirty:<count>|status:<text>|learn:<compressed>\n *\n * Wire format (compact):\n *   |S|<taskId>|<snapshotId>|<risk>|<prot>|<dirty>|<status>|<learnings>\n */\nexport function buildStartResponse(\n\tdata: {\n\t\ttaskId: string;\n\t\tsnapshotId?: string;\n\t\trisk: \"L\" | \"M\" | \"H\";\n\t\tprotection: number;\n\t\tdirty: number;\n\t\tsnapshotStatus: \"created\" | \"reused\" | \"skipped\";\n\t\tlearnings?: string[];\n\t\thotspots?: string[];\n\t\ttaskDescription?: string;\n\t},\n\toptions?: WireFormatOptions,\n): WireResponse {\n\tconst learningsStr =\n\t\tdata.learnings\n\t\t\t?.slice(0, 3)\n\t\t\t.map((l) => compress(l, 40))\n\t\t\t.join(\",\") || \"\";\n\tconst hotspotsStr = data.hotspots?.slice(0, 2).join(\",\") || \"\";\n\n\tconst wire = formatWireLabeled(\n\t\t\"S\",\n\t\t{\n\t\t\tid: data.taskId,\n\t\t\tsnap: data.snapshotId || \"none\",\n\t\t\trisk: data.risk,\n\t\t\tprot: data.protection,\n\t\t\tdirty: data.dirty,\n\t\t\tstatus: data.snapshotStatus,\n\t\t\t...(learningsStr && { learn: learningsStr }),\n\t\t\t...(hotspotsStr && { hotspots: hotspotsStr }),\n\t\t},\n\t\toptions,\n\t);\n\n\tconst message =\n\t\tdata.snapshotStatus === \"created\"\n\t\t\t? messages.snapshot.created(data.taskDescription)\n\t\t\t: data.snapshotStatus === \"reused\"\n\t\t\t\t? messages.snapshot.reused()\n\t\t\t\t: undefined;\n\n\treturn { wire, message };\n}\n\n/**\n * Build a check/validation response\n *\n * Wire format (labeled):\n *   |C|status:</>|err:<n>E|warn:<n>W|ts:<//>|lint:<//>|tests:<//>|issues:<compressed>\n *\n * Wire format (compact):\n *   |C|<status>|<errors>E|<warnings>W|<indicators>|<issues>\n */\nexport function buildCheckResponse(\n\tdata: {\n\t\tmode: \"S\" | \"C\" | \"Q\" | \"F\" | \"P\";\n\t\tstatus: \"OK\" | \"ERR\";\n\t\terrors: number;\n\t\twarnings: number;\n\t\tchecked?: { typescript: boolean; lint: boolean; tests: boolean | \"skipped\" };\n\t\tissues?: string[];\n\t},\n\toptions?: WireFormatOptions,\n): WireResponse {\n\t// Build status indicators\n\tconst tsStatus = data.checked?.typescript ? \"\" : \"\";\n\tconst lintStatus = data.checked?.lint ? \"\" : \"\";\n\tconst testsStatus = data.checked?.tests === true ? \"\" : data.checked?.tests === \"skipped\" ? \"\" : \"\";\n\tconst issuesStr =\n\t\tdata.issues\n\t\t\t?.slice(0, 3)\n\t\t\t.map((i) => compress(i, 40))\n\t\t\t.join(\",\") || \"\";\n\n\tconst wire = formatWireLabeled(\n\t\tdata.mode,\n\t\t{\n\t\t\tstatus: data.status === \"OK\" ? \"\" : \"\",\n\t\t\terr: `${data.errors}E`,\n\t\t\twarn: `${data.warnings}W`,\n\t\t\tts: tsStatus,\n\t\t\tlint: lintStatus,\n\t\t\ttests: testsStatus,\n\t\t\t...(issuesStr && { issues: issuesStr }),\n\t\t},\n\t\toptions,\n\t);\n\n\tconst message =\n\t\tdata.status === \"OK\" ? messages.validation.passed() : messages.validation.issues(data.errors, data.warnings);\n\n\treturn { wire, message };\n}\n\n/**\n * Build a restore response\n */\nexport function buildRestoreResponse(data: { files: string[]; snapshotTime: number; isDry?: boolean }): WireResponse {\n\tconst timeAgo = getRelativeTimeHuman(data.snapshotTime);\n\n\tif (data.isDry) {\n\t\tconst wire = formatWire(\"R\", \"DRY\", `${data.files.length}f`, ...data.files.slice(0, 5));\n\t\treturn { wire, message: messages.restore.preview(data.files.length) };\n\t}\n\n\tconst wire = formatWire(\"R\", \"OK\", `${data.files.length}f`, ...data.files.slice(0, 5));\n\tconst message =\n\t\tdata.files.length === 1\n\t\t\t? messages.restore.single(data.files[0], timeAgo)\n\t\t\t: messages.restore.multiple(data.files.length, timeAgo);\n\n\treturn { wire, message };\n}\n\n/**\n * Build a list snapshots response\n */\nexport function buildListResponse(\n\tsnapshots: Array<{ id: string; createdAt: number; fileCount: number }>,\n): WireResponse {\n\tif (snapshots.length === 0) {\n\t\treturn {\n\t\t\twire: formatWire(\"R\", \"0\", \"No snapshots available\"),\n\t\t\tmessage: messages.restore.notFound(),\n\t\t};\n\t}\n\n\tconst parts = snapshots.slice(0, 5).map((snap) => {\n\t\tconst age = getRelativeTime(snap.createdAt);\n\t\treturn `${snap.id.slice(0, 8)}:${age}:${snap.fileCount}f`;\n\t});\n\n\treturn {\n\t\twire: formatWire(\"R\", String(snapshots.length), ...parts),\n\t};\n}\n\n/**\n * Build an end task response\n *\n * Wire format (labeled):\n *   |E|status:<OK/FAIL>|learn:<n>L|files:<n>F|lines:<+added-removed>|summary:<compressed>|<survey-json>\n *\n * Wire format (compact):\n *   |E|<status>|<learnings>L|<files>F|<lines>|<summary>\n */\nexport function buildEndResponse(\n\tdata: {\n\t\tsuccess: boolean;\n\t\tlearningsCount: number;\n\t\tfilesModified: number;\n\t\tlinesAdded: number;\n\t\tlinesRemoved: number;\n\t\tlearnings?: string[];\n\t\ttokensSaved?: number;\n\t\tsavingsPercent?: number;\n\t\tmistakesPrevented?: number;\n\t\tsurvey?: Record<string, unknown>;\n\t},\n\toptions?: WireFormatOptions,\n): WireResponse {\n\tconst learningsStr =\n\t\tdata.learnings\n\t\t\t?.slice(0, 2)\n\t\t\t.map((l) => compress(l, 30))\n\t\t\t.join(\",\") || \"\";\n\n\tconst wire = formatWireLabeled(\n\t\t\"E\",\n\t\t{\n\t\t\tstatus: data.success ? \"OK\" : \"FAIL\",\n\t\t\tlearn: `${data.learningsCount}L`,\n\t\t\tfiles: `${data.filesModified}F`,\n\t\t\tlines: `+${data.linesAdded}-${data.linesRemoved}`,\n\t\t\t...(learningsStr && { summary: learningsStr }),\n\t\t},\n\t\toptions,\n\t);\n\n\t// Append survey as JSON if present (not in wire format fields)\n\tconst wireWithSurvey = data.survey ? `${wire}|${JSON.stringify(data.survey)}` : wire;\n\n\t// Build efficiency stats line\n\tconst statsParts: string[] = [];\n\tif (data.tokensSaved && data.tokensSaved > 500) {\n\t\tstatsParts.push(` ~${data.tokensSaved.toLocaleString()} tokens saved (${data.savingsPercent}%)`);\n\t}\n\tif (data.mistakesPrevented && data.mistakesPrevented > 0) {\n\t\tstatsParts.push(` ${data.mistakesPrevented} ${data.mistakesPrevented === 1 ? \"issue\" : \"issues\"} prevented`);\n\t}\n\tif (data.learningsCount > 0) {\n\t\tstatsParts.push(` ${data.learningsCount} captured`);\n\t}\n\n\tconst message = statsParts.length > 0 ? statsParts.join(\" | \") : undefined;\n\n\treturn { wire: wireWithSurvey, message };\n}\n\n/**\n * Learning type mapping from abbreviated to full words\n */\nexport const LEARNING_TYPE_MAP: Record<string, string> = {\n\tpat: \"pattern\",\n\tpattern: \"pattern\",\n\tpit: \"pitfall\",\n\tpitfall: \"pitfall\",\n\teff: \"efficiency\",\n\tefficiency: \"efficiency\",\n\tdisc: \"discovery\",\n\tdiscovery: \"discovery\",\n\twf: \"workflow\",\n\tworkflow: \"workflow\",\n};\n\n/**\n * Build a learning response\n *\n * Wire format (labeled):\n *   |L|status:OK|id:<learningId>|type:<pattern/pitfall/efficiency/discovery/workflow>\n *\n * Wire format (compact):\n *   |L|OK|<id>|<type>\n */\nexport function buildLearnResponse(data: { id: string; type: string }, options?: WireFormatOptions): WireResponse {\n\tconst fullType = LEARNING_TYPE_MAP[data.type] || data.type;\n\n\tconst wire = formatWireLabeled(\n\t\t\"L\",\n\t\t{\n\t\t\tstatus: \"OK\",\n\t\t\tid: data.id,\n\t\t\ttype: fullType,\n\t\t},\n\t\toptions,\n\t);\n\n\treturn {\n\t\twire,\n\t\tmessage: messages.learning.captured(fullType),\n\t};\n}\n\n/**\n * Build a violation response\n *\n * Wire format (labeled):\n *   |V|status:OK|type:<violationType>|count:<n>|promote:<NO/PROMOTED>|auto:<NO/YES>\n *\n * Wire format (compact):\n *   |V|OK|<type>|<count>|PROMOTE?|AUTOMATE?\n */\nexport function buildViolationResponse(\n\tdata: {\n\t\ttype: string;\n\t\tcount: number;\n\t\tshouldPromote?: boolean;\n\t\tshouldAutomate?: boolean;\n\t},\n\toptions?: WireFormatOptions,\n): WireResponse {\n\tconst wire = formatWireLabeled(\n\t\t\"V\",\n\t\t{\n\t\t\tstatus: \"OK\",\n\t\t\ttype: data.type,\n\t\t\tcount: data.count,\n\t\t\tpromote: data.shouldPromote ? \"PROMOTED\" : \"NO\",\n\t\t\tauto: data.shouldAutomate ? \"YES\" : \"NO\",\n\t\t},\n\t\toptions,\n\t);\n\n\tconst message = data.shouldAutomate\n\t\t? messages.violation.automate(data.type)\n\t\t: data.shouldPromote\n\t\t\t? messages.violation.promoted(data.type)\n\t\t\t: messages.violation.recorded(data.type, data.count);\n\n\treturn {\n\t\twire,\n\t\tmessage,\n\t};\n}\n\n/**\n * Build an error response\n *\n * Wire format (labeled):\n *   |!|code:<ERROR_CODE>|reason:<compressed>\n *\n * Wire format (compact):\n *   |!|<code>|<reason>\n */\nexport function buildErrorResponse(reason: string, code?: string, options?: WireFormatOptions): WireResponse {\n\tconst wire = formatWireLabeled(\n\t\t\"!\",\n\t\t{\n\t\t\tcode: code || \"ERR\",\n\t\t\treason: compress(reason, 60),\n\t\t},\n\t\toptions,\n\t);\n\n\treturn {\n\t\twire,\n\t\tmessage: messages.error.generic(reason),\n\t};\n}\n\n// =============================================================================\n// Utility Functions\n// =============================================================================\n\nfunction capitalize(s: string): string {\n\treturn s.charAt(0).toUpperCase() + s.slice(1);\n}\n\n/**\n * Format tool result with optional human message\n * When humanize=true, includes friendly message after wire format\n */\nexport function formatToolResult(response: WireResponse, humanize = false): string {\n\tif (humanize && response.message) {\n\t\treturn `${response.wire}\\n${response.message}`;\n\t}\n\treturn response.wire;\n}\n","/**\n * Error Codes and Structured Logging\n *\n * P1-002: Stable error codes for all handlers\n * P1-003: Structured logging with request IDs\n *\n * @module errors\n */\n\nimport { randomUUID } from \"node:crypto\";\n\n// ============================================================================\n// P1-002: Stable Error Codes\n// ============================================================================\n\n/**\n * Error codes for MCP tool responses\n * Format: CATEGORY_SPECIFIC_ERROR\n */\nexport const ErrorCodes = {\n\t// Validation errors (1xx)\n\tMISSING_REQUIRED_PARAM: \"E101_MISSING_REQUIRED_PARAM\",\n\tINVALID_PARAM_TYPE: \"E102_INVALID_PARAM_TYPE\",\n\tINVALID_PARAM_VALUE: \"E103_INVALID_PARAM_VALUE\",\n\tVALIDATION_FAILED: \"E104_VALIDATION_FAILED\",\n\tPATH_TRAVERSAL_BLOCKED: \"E105_PATH_TRAVERSAL_BLOCKED\",\n\n\t// Resource errors (2xx)\n\tFILE_NOT_FOUND: \"E201_FILE_NOT_FOUND\",\n\tSNAPSHOT_NOT_FOUND: \"E202_SNAPSHOT_NOT_FOUND\",\n\tSESSION_NOT_FOUND: \"E203_SESSION_NOT_FOUND\",\n\tCONTEXT_NOT_INITIALIZED: \"E204_CONTEXT_NOT_INITIALIZED\",\n\n\t// Permission errors (3xx)\n\tTIER_GATE_BLOCKED: \"E301_TIER_GATE_BLOCKED\",\n\tOPERATION_NOT_ALLOWED: \"E302_OPERATION_NOT_ALLOWED\",\n\tPERMISSION_DENIED: \"E303_PERMISSION_DENIED\",\n\n\t// Runtime errors (4xx)\n\tSNAPSHOT_CREATE_FAILED: \"E401_SNAPSHOT_CREATE_FAILED\",\n\tSNAPSHOT_RESTORE_FAILED: \"E402_SNAPSHOT_RESTORE_FAILED\",\n\tSTORAGE_ERROR: \"E403_STORAGE_ERROR\",\n\tCONTEXT_OPERATION_FAILED: \"E404_CONTEXT_OPERATION_FAILED\",\n\tSESSION_OPERATION_FAILED: \"E405_SESSION_OPERATION_FAILED\",\n\n\t// Unknown errors (5xx)\n\tUNKNOWN_TOOL: \"E501_UNKNOWN_TOOL\",\n\tHANDLER_ERROR: \"E502_HANDLER_ERROR\",\n\tINTERNAL_ERROR: \"E503_INTERNAL_ERROR\",\n} as const;\n\nexport type ErrorCode = (typeof ErrorCodes)[keyof typeof ErrorCodes];\n\n// ============================================================================\n// P1-003: Structured Logging\n// ============================================================================\n\n/**\n * Request context for structured logging\n */\nexport interface RequestContext {\n\trequestId: string;\n\ttool: string;\n\tstartTime: number;\n\tuserId?: string;\n\ttier?: string;\n}\n\n/**\n * Create a new request context\n */\nexport function createRequestContext(tool: string, options?: { userId?: string; tier?: string }): RequestContext {\n\treturn {\n\t\trequestId: randomUUID().slice(0, 8), // Short ID for readability\n\t\ttool,\n\t\tstartTime: Date.now(),\n\t\tuserId: options?.userId,\n\t\ttier: options?.tier,\n\t};\n}\n\n/**\n * Log levels\n */\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\n/**\n * Structured log entry\n */\nexport interface LogEntry {\n\ttimestamp: string;\n\tlevel: LogLevel;\n\trequestId: string;\n\ttool: string;\n\tmessage: string;\n\tduration?: number;\n\terror?: {\n\t\tcode: ErrorCode;\n\t\tmessage: string;\n\t\tdetails?: Record<string, unknown>;\n\t};\n\tmetadata?: Record<string, unknown>;\n}\n\n/**\n * Log to stderr with structured format\n */\nexport function log(level: LogLevel, ctx: RequestContext, message: string, metadata?: Record<string, unknown>): void {\n\tconst entry: LogEntry = {\n\t\ttimestamp: new Date().toISOString(),\n\t\tlevel,\n\t\trequestId: ctx.requestId,\n\t\ttool: ctx.tool,\n\t\tmessage,\n\t\tduration: Date.now() - ctx.startTime,\n\t\tmetadata,\n\t};\n\n\t// Log as JSON for structured parsing\n\tconsole.error(`[SnapBack MCP] ${JSON.stringify(entry)}`);\n}\n\n/**\n * Log error with structured format\n */\nexport function logError(\n\tctx: RequestContext,\n\tcode: ErrorCode,\n\tmessage: string,\n\tdetails?: Record<string, unknown>,\n): void {\n\tconst entry: LogEntry = {\n\t\ttimestamp: new Date().toISOString(),\n\t\tlevel: \"error\",\n\t\trequestId: ctx.requestId,\n\t\ttool: ctx.tool,\n\t\tmessage,\n\t\tduration: Date.now() - ctx.startTime,\n\t\terror: { code, message, details },\n\t};\n\n\tconsole.error(`[SnapBack MCP] ${JSON.stringify(entry)}`);\n}\n\n/**\n * Log successful completion\n */\nexport function logSuccess(ctx: RequestContext, message: string, metadata?: Record<string, unknown>): void {\n\tlog(\"info\", ctx, message, { ...metadata, status: \"success\" });\n}\n\n// ============================================================================\n// Structured Error Response Builder\n// ============================================================================\n\n/**\n * Build a structured error response\n */\nexport function buildErrorResponse(\n\tcode: ErrorCode,\n\tmessage: string,\n\tdetails?: Record<string, unknown>,\n): {\n\terror: ErrorCode;\n\tmessage: string;\n\tdetails?: Record<string, unknown>;\n} {\n\treturn {\n\t\terror: code,\n\t\tmessage,\n\t\t...(details && { details }),\n\t};\n}\n\n/**\n * Common error responses\n */\nexport const CommonErrors = {\n\tmissingParam: (param: string) =>\n\t\tbuildErrorResponse(ErrorCodes.MISSING_REQUIRED_PARAM, `Missing required parameter: ${param}`, { param }),\n\n\tinvalidParam: (param: string, expected: string, received: unknown) =>\n\t\tbuildErrorResponse(ErrorCodes.INVALID_PARAM_VALUE, `Invalid value for ${param}: expected ${expected}`, {\n\t\t\tparam,\n\t\t\texpected,\n\t\t\treceived,\n\t\t}),\n\n\tfileNotFound: (filePath: string) =>\n\t\tbuildErrorResponse(ErrorCodes.FILE_NOT_FOUND, `File not found: ${filePath}`, { filePath }),\n\n\tsnapshotNotFound: (snapshotId: string) =>\n\t\tbuildErrorResponse(ErrorCodes.SNAPSHOT_NOT_FOUND, `Snapshot not found: ${snapshotId}`, { snapshotId }),\n\n\tpathTraversalBlocked: (path: string, reason: string) =>\n\t\tbuildErrorResponse(ErrorCodes.PATH_TRAVERSAL_BLOCKED, reason, { path }),\n\n\ttierGateBlocked: (tool: string, requiredTier: string, currentTier: string) =>\n\t\tbuildErrorResponse(ErrorCodes.TIER_GATE_BLOCKED, `Tool '${tool}' requires ${requiredTier} tier`, {\n\t\t\ttool,\n\t\t\trequiredTier,\n\t\t\tcurrentTier,\n\t\t\tupgradeUrl: \"https://snapback.dev/pricing\",\n\t\t}),\n\n\thandlerError: (tool: string, message: string) => buildErrorResponse(ErrorCodes.HANDLER_ERROR, message, { tool }),\n\n\tpermissionDenied: (path: string, operation: string) =>\n\t\tbuildErrorResponse(ErrorCodes.PERMISSION_DENIED, \"Enable full features with quick local setup\", {\n\t\t\tpath,\n\t\t\toperation,\n\t\t\taction: {\n\t\t\t\ttype: \"cli_install\",\n\t\t\t\tcommand: \"npm install -g @snapback/cli && snapback tools configure\",\n\t\t\t\tdescription: \"One command enables full capabilities\",\n\t\t\t\ttime_estimate: \"~30 seconds\",\n\t\t\t},\n\t\t\thelp_url: \"https://docs.snapback.dev/cli/setup\",\n\t\t\t_llm: {\n\t\t\t\tsuggest: \"I can enable full SnapBack features with a quick CLI install. Want me to help?\",\n\t\t\t\tauto_offer: true,\n\t\t\t},\n\t\t}),\n};\n","/**\n * MCP Session State Management\n *\n * Maintains session state across tool calls for composite tool support.\n * Enables \"pair programmer\" workflow with task tracking, change detection,\n * and proactive observations.\n *\n * @module session/state\n */\n\nimport { execSync } from \"node:child_process\";\nimport { existsSync, mkdirSync, readFileSync, unlinkSync, writeFileSync } from \"node:fs\";\nimport { dirname, join } from \"node:path\";\nimport { log, type RequestContext } from \"../errors.js\";\n\n// Create a module-level request context for logging\nconst moduleCtx: RequestContext = {\n\trequestId: \"session-state\",\n\ttool: \"session/state\",\n\tstartTime: Date.now(),\n};\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * File change tracked during a task\n */\nexport interface FileChange {\n\tfile: string;\n\ttype: \"created\" | \"modified\" | \"deleted\";\n\ttimestamp: number;\n\taiAttributed: boolean;\n\tlinesChanged: number;\n}\n\n/**\n * Proactive observation from extension\n */\nexport interface Observation {\n\ttype: \"risk\" | \"pattern\" | \"suggestion\" | \"warning\" | \"progress\";\n\tmessage: string;\n\ttimestamp: number;\n\tcontext?: Record<string, unknown>;\n}\n\n/**\n * Git file status at a point in time\n */\nexport interface GitFileStatus {\n\tfile: string;\n\tstatus: \"A\" | \"M\" | \"D\" | \"?\";\n\ttimestamp: number;\n}\n\n/**\n * Task intent types - matches begin-task.ts\n */\nexport type TaskIntent = \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\n/**\n * Learning IDs shown to the LLM, grouped by type for attribution\n */\nexport interface ShownLearnings {\n\tpatterns: string[];\n\tpitfalls: string[];\n\tother: string[]; // efficiency, discovery, workflow\n}\n\n/**\n * Current task being worked on\n */\nexport interface CurrentTask {\n\tid: string;\n\tdescription: string;\n\tstartedAt: number;\n\tplannedFiles: string[];\n\tsnapshotId?: string;\n\tkeywords: string[];\n\t/** Inferred intent from task description */\n\tintent?: TaskIntent;\n\t/** Git state when task started - used to filter what_changed/review_work */\n\tgitBaseline?: GitFileStatus[];\n\t/** Learning IDs shown at task start, for feedback attribution at task end */\n\tshownLearnings?: ShownLearnings;\n}\n\n/**\n * Risk area categories\n */\nexport type RiskArea = \"auth\" | \"payment\" | \"database\" | \"config\" | \"api\" | \"security\";\n\n/**\n * Complete MCP session state\n */\nexport interface MCPSessionState {\n\t/** Current task tracking */\n\tcurrentTask: CurrentTask | null;\n\n\t/** Changes since task start (populated by extension bridge) */\n\tchangesSinceTaskStart: FileChange[];\n\n\t/** Proactive observations (populated by extension) */\n\tpendingObservations: Observation[];\n\n\t/** Learnings surfaced this session */\n\tsurfacedLearnings: string[];\n\n\t/** Risk areas touched */\n\triskAreasTouched: RiskArea[];\n\n\t/** Files that have been validated with check_patterns */\n\tvalidatedFiles: string[];\n\n\t/** Session statistics */\n\tstats: {\n\t\ttasksCompleted: number;\n\t\tsnapshotsCreated: number;\n\t\trestoresPerformed: number;\n\t\tlearningsCaptured: number;\n\t};\n\n\t/** Suggested learnings pending acceptance */\n\tpendingSuggestedLearnings: Array<{\n\t\ttype: string;\n\t\ttrigger: string;\n\t\taction: string;\n\t}>;\n}\n\n// =============================================================================\n// STATE MANAGEMENT\n// =============================================================================\n\n/**\n * In-memory session state per workspace\n * Key: workspaceRoot path\n */\nconst sessionStates = new Map<string, MCPSessionState>();\n\n/**\n * Create default session state\n */\nfunction createDefaultState(): MCPSessionState {\n\treturn {\n\t\tcurrentTask: null,\n\t\tchangesSinceTaskStart: [],\n\t\tpendingObservations: [],\n\t\tsurfacedLearnings: [],\n\t\triskAreasTouched: [],\n\t\tvalidatedFiles: [],\n\t\tstats: {\n\t\t\ttasksCompleted: 0,\n\t\t\tsnapshotsCreated: 0,\n\t\t\trestoresPerformed: 0,\n\t\t\tlearningsCaptured: 0,\n\t\t},\n\t\tpendingSuggestedLearnings: [],\n\t};\n}\n\n/**\n * Get session state for a workspace (creates if needed)\n */\nexport function getSessionState(workspaceRoot: string): MCPSessionState {\n\tif (!sessionStates.has(workspaceRoot)) {\n\t\t// Try to load from disk first\n\t\tconst loaded = loadStateFromDisk(workspaceRoot);\n\t\tsessionStates.set(workspaceRoot, loaded || createDefaultState());\n\t}\n\tconst state = sessionStates.get(workspaceRoot);\n\tif (!state) {\n\t\tthrow new Error(`Failed to get session state for ${workspaceRoot}`);\n\t}\n\treturn state;\n}\n\n/**\n * Update session state\n */\nexport function updateSessionState(workspaceRoot: string, updates: Partial<MCPSessionState>): MCPSessionState {\n\tconst current = getSessionState(workspaceRoot);\n\tconst updated = { ...current, ...updates };\n\tsessionStates.set(workspaceRoot, updated);\n\n\t// Persist to disk for recovery\n\tsaveStateToDisk(workspaceRoot, updated);\n\n\treturn updated;\n}\n\n/**\n * Clear session state (on session end)\n */\nexport function clearSessionState(workspaceRoot: string): void {\n\tsessionStates.delete(workspaceRoot);\n\tclearStateFromDisk(workspaceRoot);\n}\n\n// =============================================================================\n// TASK MANAGEMENT\n// =============================================================================\n\n/**\n * Generate a unique task ID\n */\nexport function generateTaskId(): string {\n\tconst timestamp = Date.now().toString(36);\n\tconst random = Math.random().toString(36).substring(2, 8);\n\treturn `task_${timestamp}_${random}`;\n}\n\n/**\n * Start a new task\n * Captures git baseline to enable task-scoped change tracking\n */\nexport function startTask(\n\tworkspaceRoot: string,\n\ttask: Omit<CurrentTask, \"id\" | \"startedAt\" | \"gitBaseline\">,\n): CurrentTask {\n\t// Capture git state BEFORE starting task\n\tconst gitBaseline = captureGitBaseline(workspaceRoot);\n\n\tconst currentTask: CurrentTask = {\n\t\t...task,\n\t\tid: generateTaskId(),\n\t\tstartedAt: Date.now(),\n\t\tgitBaseline,\n\t};\n\n\tupdateSessionState(workspaceRoot, {\n\t\tcurrentTask,\n\t\tchangesSinceTaskStart: [],\n\t\tpendingObservations: [],\n\t});\n\n\treturn currentTask;\n}\n\n/**\n * End current task\n */\nexport function endTask(workspaceRoot: string, outcome: \"completed\" | \"abandoned\" | \"blocked\"): CurrentTask | null {\n\tconst state = getSessionState(workspaceRoot);\n\tconst task = state.currentTask;\n\n\tif (task) {\n\t\t// Update stats\n\t\tif (outcome === \"completed\") {\n\t\t\tstate.stats.tasksCompleted++;\n\t\t}\n\n\t\t// Clear task but preserve stats\n\t\tupdateSessionState(workspaceRoot, {\n\t\t\tcurrentTask: null,\n\t\t\tchangesSinceTaskStart: [],\n\t\t\tpendingObservations: [],\n\t\t\tpendingSuggestedLearnings: [],\n\t\t});\n\t}\n\n\treturn task;\n}\n\n/**\n * Get current task (or null)\n */\nexport function getCurrentTask(workspaceRoot: string): CurrentTask | null {\n\treturn getSessionState(workspaceRoot).currentTask;\n}\n\n// =============================================================================\n// CHANGE TRACKING\n// =============================================================================\n\n/**\n * Record a file change\n */\nexport function recordFileChange(workspaceRoot: string, change: FileChange): void {\n\tconst state = getSessionState(workspaceRoot);\n\n\t// Only track if task is active\n\tif (!state.currentTask) {\n\t\treturn;\n\t}\n\n\t// Add to changes list\n\tstate.changesSinceTaskStart.push(change);\n\n\t// Detect risk areas from file path\n\tconst riskAreas = detectRiskAreas(change.file);\n\tfor (const area of riskAreas) {\n\t\tif (!state.riskAreasTouched.includes(area)) {\n\t\t\tstate.riskAreasTouched.push(area);\n\t\t}\n\t}\n\n\tupdateSessionState(workspaceRoot, state);\n}\n\n/**\n * Detect risk areas from file path\n */\nfunction detectRiskAreas(filePath: string): RiskArea[] {\n\tconst areas: RiskArea[] = [];\n\tconst lowerPath = filePath.toLowerCase();\n\n\tif (lowerPath.includes(\"auth\") || lowerPath.includes(\"login\") || lowerPath.includes(\"session\")) {\n\t\tareas.push(\"auth\");\n\t}\n\tif (lowerPath.includes(\"payment\") || lowerPath.includes(\"stripe\") || lowerPath.includes(\"billing\")) {\n\t\tareas.push(\"payment\");\n\t}\n\tif (lowerPath.includes(\"database\") || lowerPath.includes(\"db\") || lowerPath.includes(\"migration\")) {\n\t\tareas.push(\"database\");\n\t}\n\tif (lowerPath.includes(\"config\") || lowerPath.includes(\".env\") || lowerPath.includes(\"settings\")) {\n\t\tareas.push(\"config\");\n\t}\n\tif (lowerPath.includes(\"api\") || lowerPath.includes(\"route\") || lowerPath.includes(\"endpoint\")) {\n\t\tareas.push(\"api\");\n\t}\n\tif (lowerPath.includes(\"security\") || lowerPath.includes(\"crypto\") || lowerPath.includes(\"secret\")) {\n\t\tareas.push(\"security\");\n\t}\n\n\treturn areas;\n}\n\n// =============================================================================\n// OBSERVATIONS\n// =============================================================================\n\n/**\n * Push an observation (from extension or internally)\n */\nexport function pushObservation(workspaceRoot: string, observation: Observation): void {\n\tconst state = getSessionState(workspaceRoot);\n\n\tstate.pendingObservations.push(observation);\n\n\t// Limit queue size (keep recent 50)\n\tif (state.pendingObservations.length > 50) {\n\t\tstate.pendingObservations = state.pendingObservations.slice(-50);\n\t}\n\n\tupdateSessionState(workspaceRoot, state);\n}\n\n/**\n * Drain pending observations (returns and clears)\n */\nexport function drainPendingObservations(workspaceRoot: string): Observation[] {\n\tconst state = getSessionState(workspaceRoot);\n\tconst observations = [...state.pendingObservations];\n\n\tupdateSessionState(workspaceRoot, {\n\t\tpendingObservations: [],\n\t});\n\n\treturn observations;\n}\n\n// =============================================================================\n// PERSISTENCE\n// =============================================================================\n\n/**\n * Get state file path\n */\nfunction getStateFilePath(workspaceRoot: string): string {\n\treturn join(workspaceRoot, \".snapback\", \"mcp\", \"session-state.json\");\n}\n\n/**\n * Save state to disk\n */\nfunction saveStateToDisk(workspaceRoot: string, state: MCPSessionState): void {\n\tconst filePath = getStateFilePath(workspaceRoot);\n\n\ttry {\n\t\tconst dir = dirname(filePath);\n\t\tif (!existsSync(dir)) {\n\t\t\tmkdirSync(dir, { recursive: true });\n\t\t}\n\n\t\twriteFileSync(filePath, JSON.stringify(state, null, 2), \"utf8\");\n\t} catch (error) {\n\t\t// Log at debug level - write errors are non-critical but useful for debugging\n\t\tlog(\"debug\", moduleCtx, \"Failed to persist session state to disk\", {\n\t\t\tfilePath,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t}\n}\n\n/**\n * Load state from disk\n */\nfunction loadStateFromDisk(workspaceRoot: string): MCPSessionState | null {\n\tconst filePath = getStateFilePath(workspaceRoot);\n\n\ttry {\n\t\tif (existsSync(filePath)) {\n\t\t\tconst content = readFileSync(filePath, \"utf8\");\n\t\t\treturn JSON.parse(content) as MCPSessionState;\n\t\t}\n\t} catch (error) {\n\t\t// Log at debug level - read errors may indicate corrupted state file\n\t\tlog(\"debug\", moduleCtx, \"Failed to load session state from disk\", {\n\t\t\tfilePath,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t}\n\n\treturn null;\n}\n\n/**\n * Clear state from disk\n */\nfunction clearStateFromDisk(workspaceRoot: string): void {\n\tconst filePath = getStateFilePath(workspaceRoot);\n\n\ttry {\n\t\tif (existsSync(filePath)) {\n\t\t\tunlinkSync(filePath);\n\t\t}\n\t} catch (error) {\n\t\t// Log at debug level - delete errors are non-critical\n\t\tlog(\"debug\", moduleCtx, \"Failed to clear session state file\", {\n\t\t\tfilePath,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t}\n}\n\n// =============================================================================\n// GIT BASELINE HELPERS\n// =============================================================================\n\n/**\n * Capture current git status as baseline\n * Call this when starting a task to know what was already modified\n */\nexport function captureGitBaseline(workspaceRoot: string): GitFileStatus[] {\n\tconst baseline: GitFileStatus[] = [];\n\tconst now = Date.now();\n\n\ttry {\n\t\tconst result = execSync(\"git status --porcelain\", {\n\t\t\tcwd: workspaceRoot,\n\t\t\tencoding: \"utf8\",\n\t\t\ttimeout: 5000, // 5s timeout to prevent blocking\n\t\t});\n\n\t\tfor (const line of result.split(\"\\n\")) {\n\t\t\tif (!line.trim()) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst statusCode = line.substring(0, 2);\n\t\t\tconst file = line.substring(3).trim();\n\n\t\t\tlet status: \"A\" | \"M\" | \"D\" | \"?\" = \"M\";\n\t\t\tif (statusCode.includes(\"A\") || statusCode === \"??\") {\n\t\t\t\tstatus = statusCode === \"??\" ? \"?\" : \"A\";\n\t\t\t} else if (statusCode.includes(\"D\")) {\n\t\t\t\tstatus = \"D\";\n\t\t\t}\n\n\t\t\tbaseline.push({ file, status, timestamp: now });\n\t\t}\n\t} catch (error) {\n\t\t// Git not available or not a git repo - log at debug level and return empty baseline\n\t\tlog(\"debug\", moduleCtx, \"Git baseline capture failed (not a git repo or git unavailable)\", {\n\t\t\tworkspaceRoot,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t});\n\t}\n\n\treturn baseline;\n}\n\n/**\n * Check if a file was in the baseline (existed before task started)\n */\nexport function isInBaseline(file: string, baseline: GitFileStatus[] | undefined): boolean {\n\tif (!baseline || baseline.length === 0) {\n\t\treturn false;\n\t}\n\treturn baseline.some((b) => b.file === file);\n}\n\n/**\n * Get baseline file set for quick lookup\n */\nexport function getBaselineFileSet(workspaceRoot: string): Set<string> {\n\tconst state = getSessionState(workspaceRoot);\n\tconst baseline = state.currentTask?.gitBaseline || [];\n\treturn new Set(baseline.map((b) => b.file));\n}\n\n// =============================================================================\n// UTILITIES\n// =============================================================================\n\n/**\n * Extract keywords from task description\n */\nexport function extractKeywords(taskDescription: string): string[] {\n\t// Remove common words and punctuation\n\tconst stopWords = new Set([\n\t\t\"a\",\n\t\t\"an\",\n\t\t\"the\",\n\t\t\"to\",\n\t\t\"for\",\n\t\t\"of\",\n\t\t\"in\",\n\t\t\"on\",\n\t\t\"at\",\n\t\t\"and\",\n\t\t\"or\",\n\t\t\"but\",\n\t\t\"is\",\n\t\t\"are\",\n\t\t\"was\",\n\t\t\"were\",\n\t\t\"be\",\n\t\t\"been\",\n\t\t\"being\",\n\t\t\"have\",\n\t\t\"has\",\n\t\t\"had\",\n\t\t\"do\",\n\t\t\"does\",\n\t\t\"did\",\n\t\t\"will\",\n\t\t\"would\",\n\t\t\"could\",\n\t\t\"should\",\n\t\t\"may\",\n\t\t\"might\",\n\t\t\"i\",\n\t\t\"we\",\n\t\t\"you\",\n\t\t\"they\",\n\t\t\"it\",\n\t\t\"this\",\n\t\t\"that\",\n\t\t\"with\",\n\t\t\"from\",\n\t\t\"by\",\n\t\t\"add\",\n\t\t\"update\",\n\t\t\"fix\",\n\t\t\"implement\",\n\t\t\"create\",\n\t\t\"make\",\n\t\t\"change\",\n\t\t\"modify\",\n\t]);\n\n\tconst words = taskDescription\n\t\t.toLowerCase()\n\t\t.replace(/[^\\w\\s-]/g, \" \")\n\t\t.split(/\\s+/)\n\t\t.filter((word) => word.length > 2 && !stopWords.has(word));\n\n\t// Return unique keywords (max 5)\n\treturn [...new Set(words)].slice(0, 5);\n}\n\n/**\n * Format duration in human-readable format\n */\nexport function formatDuration(ms: number): string {\n\tconst minutes = Math.floor(ms / 60000);\n\tconst hours = Math.floor(minutes / 60);\n\n\tif (hours > 0) {\n\t\tconst remainingMinutes = minutes % 60;\n\t\treturn `${hours}h ${remainingMinutes}m`;\n\t}\n\n\tif (minutes > 0) {\n\t\treturn `${minutes} minute${minutes !== 1 ? \"s\" : \"\"}`;\n\t}\n\n\treturn \"less than a minute\";\n}\n","/**\n * Knowledge Ingestion Service\n *\n * Indexes learnings into the KnowledgeStore for hybrid retrieval.\n * Bridges the gap between JSONL learning storage and SQLite+FTS5+embeddings.\n *\n * @module services/knowledge-ingestion-service\n */\n\nimport { existsSync, readFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport { type Chunk, getEmbedding, KnowledgeStore, preloadEmbeddings } from \"@snapback/intelligence\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface Learning {\n\tid: string;\n\ttype: string;\n\ttrigger: string | string[];\n\taction: string;\n\tsource?: string;\n\ttimestamp?: string;\n\ttier?: string;\n\tdomain?: string;\n\tpriority?: string;\n}\n\nexport interface IngestionResult {\n\tsuccess: boolean;\n\tindexed: number;\n\tskipped: number;\n\terrors: string[];\n\tembeddingsGenerated: number;\n}\n\ninterface IngestionStats {\n\ttotalChunks: number;\n\twithEmbedding: number;\n\tmissingEmbedding: number;\n\tbyType: Record<string, number>;\n}\n\n// =============================================================================\n// SERVICE\n// =============================================================================\n\n/**\n * Cache of KnowledgeStore instances per workspace\n */\nconst stores = new Map<string, KnowledgeStore>();\n\n/**\n * Track indexed learning IDs to avoid re-indexing\n */\nconst indexedIds = new Map<string, Set<string>>();\n\n/**\n * Whether embeddings model is ready\n */\nlet embeddingsReady = false;\nlet embeddingsLoading = false;\n\n/**\n * Get or create KnowledgeStore for a workspace\n */\nfunction getStore(workspaceRoot: string): KnowledgeStore {\n\tlet store = stores.get(workspaceRoot);\n\tif (!store) {\n\t\tconst dbPath = join(workspaceRoot, \".snapback\", \"knowledge.db\");\n\t\tstore = new KnowledgeStore({ dbPath });\n\t\tstores.set(workspaceRoot, store);\n\t}\n\treturn store;\n}\n\n/**\n * Get or create indexed IDs set for a workspace\n */\nfunction getIndexedIds(workspaceRoot: string): Set<string> {\n\tlet ids = indexedIds.get(workspaceRoot);\n\tif (!ids) {\n\t\tids = new Set();\n\t\tindexedIds.set(workspaceRoot, ids);\n\t}\n\treturn ids;\n}\n\n/**\n * Ensure embeddings model is loaded\n * Safe to call multiple times - will only load once\n */\nexport async function ensureEmbeddingsReady(): Promise<boolean> {\n\tif (embeddingsReady) {\n\t\treturn true;\n\t}\n\n\tif (embeddingsLoading) {\n\t\t// Wait for existing load\n\t\tlet attempts = 0;\n\t\twhile (embeddingsLoading && attempts < 100) {\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t\tattempts++;\n\t\t}\n\t\treturn embeddingsReady;\n\t}\n\n\tembeddingsLoading = true;\n\ttry {\n\t\tawait preloadEmbeddings();\n\t\tembeddingsReady = true;\n\t\tconsole.log(\"[KnowledgeIngestion] Embeddings model loaded\");\n\t\treturn true;\n\t} catch (error) {\n\t\tconsole.warn(\"[KnowledgeIngestion] Failed to load embeddings model:\", error);\n\t\treturn false;\n\t} finally {\n\t\tembeddingsLoading = false;\n\t}\n}\n\n/**\n * Check if embeddings are available without loading\n */\nexport function isEmbeddingsAvailable(): boolean {\n\treturn embeddingsReady;\n}\n\n/**\n * Index a single learning into the KnowledgeStore\n *\n * @param workspaceRoot - Workspace root path\n * @param learning - Learning to index\n * @param generateEmbedding - Whether to generate embedding (default: true if model ready)\n */\nexport async function indexLearning(\n\tworkspaceRoot: string,\n\tlearning: Learning,\n\tgenerateEmbedding = true,\n): Promise<{ success: boolean; error?: string }> {\n\ttry {\n\t\tconst store = getStore(workspaceRoot);\n\t\tconst indexed = getIndexedIds(workspaceRoot);\n\n\t\t// Skip if already indexed\n\t\tif (indexed.has(learning.id)) {\n\t\t\treturn { success: true };\n\t\t}\n\n\t\t// Map learning type to chunk source_type\n\t\tconst sourceType = mapLearningTypeToSourceType(learning.type);\n\n\t\t// Build chunk text from trigger (can be string or array)\n\t\tconst triggerText = Array.isArray(learning.trigger) ? learning.trigger.join(\", \") : learning.trigger;\n\n\t\t// Create chunk\n\t\tconst chunk: Omit<Chunk, \"created_at\" | \"updated_at\"> = {\n\t\t\tid: learning.id,\n\t\t\tsource_type: sourceType,\n\t\t\tsource_id: learning.id,\n\t\t\tchunk_text: triggerText,\n\t\t\tcontext_text: learning.action,\n\t\t\tauthority: getAuthorityScore(learning),\n\t\t\tstatus: \"active\",\n\t\t\tmetadata: {\n\t\t\t\toriginalType: learning.type,\n\t\t\t\tsource: learning.source,\n\t\t\t\tdomain: learning.domain,\n\t\t\t\tpriority: learning.priority,\n\t\t\t\ttimestamp: learning.timestamp,\n\t\t\t},\n\t\t};\n\n\t\t// Insert chunk\n\t\tstore.insertChunk(chunk);\n\t\tindexed.add(learning.id);\n\n\t\t// Generate and store embedding if requested and model is ready\n\t\tif (generateEmbedding && embeddingsReady) {\n\t\t\ttry {\n\t\t\t\tconst textForEmbedding = `${triggerText} ${learning.action}`;\n\t\t\t\tconst embedding = await getEmbedding(textForEmbedding);\n\t\t\t\tstore.storeEmbedding(learning.id, embedding);\n\t\t\t} catch (error) {\n\t\t\t\t// Log but don't fail - chunk is still indexed for keyword search\n\t\t\t\tconsole.warn(`[KnowledgeIngestion] Failed to generate embedding for ${learning.id}:`, error);\n\t\t\t}\n\t\t}\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t// Handle duplicate key errors gracefully\n\t\tif (message.includes(\"UNIQUE constraint\")) {\n\t\t\tgetIndexedIds(workspaceRoot).add(learning.id);\n\t\t\treturn { success: true };\n\t\t}\n\t\treturn { success: false, error: message };\n\t}\n}\n\n/**\n * Index all learnings from JSONL files into KnowledgeStore\n *\n * @param workspaceRoot - Workspace root path\n * @param options - Indexing options\n */\nexport async function indexAllLearnings(\n\tworkspaceRoot: string,\n\toptions: {\n\t\t/** Force re-index even if already indexed */\n\t\tforce?: boolean;\n\t\t/** Skip embedding generation for speed */\n\t\tskipEmbeddings?: boolean;\n\t\t/** Specific files to index (default: all) */\n\t\tfiles?: string[];\n\t} = {},\n): Promise<IngestionResult> {\n\tconst result: IngestionResult = {\n\t\tsuccess: true,\n\t\tindexed: 0,\n\t\tskipped: 0,\n\t\terrors: [],\n\t\tembeddingsGenerated: 0,\n\t};\n\n\tconst learningsDir = join(workspaceRoot, \".snapback\", \"learnings\");\n\tif (!existsSync(learningsDir)) {\n\t\treturn result;\n\t}\n\n\t// Determine which files to index\n\tconst defaultFiles = [\n\t\t\"hot.jsonl\",\n\t\t\"learnings.jsonl\",\n\t\t\"domain-vscode.jsonl\",\n\t\t\"domain-web.jsonl\",\n\t\t\"domain-mcp-cli.jsonl\",\n\t\t\"domain-testing.jsonl\",\n\t\t\"anti-patterns.jsonl\",\n\t\t\"architecture-patterns.jsonl\",\n\t\t\"user-learnings.jsonl\",\n\t];\n\tconst filesToIndex = options.files || defaultFiles;\n\n\t// Ensure embeddings ready if not skipping\n\tconst generateEmbeddings = !options.skipEmbeddings && (await ensureEmbeddingsReady());\n\n\t// Clear indexed IDs if forcing\n\tif (options.force) {\n\t\tindexedIds.delete(workspaceRoot);\n\t}\n\n\t// Index each file\n\tfor (const filename of filesToIndex) {\n\t\tconst filePath = join(learningsDir, filename);\n\t\tif (!existsSync(filePath)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\ttry {\n\t\t\tconst content = readFileSync(filePath, \"utf8\");\n\t\t\tconst lines = content.split(\"\\n\").filter((line) => line.trim());\n\n\t\t\tfor (const line of lines) {\n\t\t\t\ttry {\n\t\t\t\t\tconst learning = JSON.parse(line) as Learning;\n\t\t\t\t\tif (!learning.id) {\n\t\t\t\t\t\t// Generate ID for seed data without IDs\n\t\t\t\t\t\tlearning.id = `seed_${filename.replace(\".jsonl\", \"\")}_${result.indexed}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst indexResult = await indexLearning(workspaceRoot, learning, generateEmbeddings);\n\n\t\t\t\t\tif (indexResult.success) {\n\t\t\t\t\t\tresult.indexed++;\n\t\t\t\t\t\tif (generateEmbeddings) {\n\t\t\t\t\t\t\tresult.embeddingsGenerated++;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (indexResult.error) {\n\t\t\t\t\t\tresult.errors.push(`${learning.id}: ${indexResult.error}`);\n\t\t\t\t\t}\n\t\t\t\t} catch (parseError) {\n\t\t\t\t\tresult.errors.push(`Parse error in ${filename}: ${parseError}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (readError) {\n\t\t\tresult.errors.push(`Read error for ${filename}: ${readError}`);\n\t\t}\n\t}\n\n\tresult.success = result.errors.length === 0;\n\treturn result;\n}\n\n/**\n * Get indexing statistics for a workspace\n */\nexport function getIngestionStats(workspaceRoot: string): IngestionStats {\n\ttry {\n\t\tconst store = getStore(workspaceRoot);\n\t\tconst stats = store.getStats();\n\t\tconst embeddingStats = store.getEmbeddingStats();\n\n\t\treturn {\n\t\t\ttotalChunks: stats.totalChunks,\n\t\t\twithEmbedding: embeddingStats.withEmbedding,\n\t\t\tmissingEmbedding: embeddingStats.missing,\n\t\t\tbyType: stats.byType,\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\ttotalChunks: 0,\n\t\t\twithEmbedding: 0,\n\t\t\tmissingEmbedding: 0,\n\t\t\tbyType: {},\n\t\t};\n\t}\n}\n\n/**\n * Invalidate cache for a workspace\n * Call when learnings are added/updated\n */\nexport function invalidateCache(workspaceRoot: string): void {\n\tindexedIds.delete(workspaceRoot);\n\n\t// Also invalidate HybridRetriever cache by closing store\n\tconst store = stores.get(workspaceRoot);\n\tif (store) {\n\t\tstore.close();\n\t\tstores.delete(workspaceRoot);\n\t}\n}\n\n/**\n * Dispose all resources\n */\nexport function disposeAll(): void {\n\tfor (const store of stores.values()) {\n\t\tstore.close();\n\t}\n\tstores.clear();\n\tindexedIds.clear();\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Map learning type string to Chunk source_type\n */\nfunction mapLearningTypeToSourceType(type: string): Chunk[\"source_type\"] {\n\tswitch (type.toLowerCase()) {\n\t\tcase \"pattern\":\n\t\tcase \"pat\":\n\t\t\treturn \"pattern\";\n\t\tcase \"pitfall\":\n\t\tcase \"pit\":\n\t\tcase \"anti-pattern\":\n\t\t\treturn \"violation\";\n\t\tcase \"architecture\":\n\t\tcase \"arch\":\n\t\tcase \"adr\":\n\t\t\treturn \"adr\";\n\t\tdefault:\n\t\t\treturn \"learning\";\n\t}\n}\n\n/**\n * Calculate authority score based on learning metadata\n */\nfunction getAuthorityScore(learning: Learning): number {\n\tlet score = 0.5; // Base score\n\n\t// Hot tier gets higher authority\n\tif (learning.tier === \"hot\") {\n\t\tscore += 0.3;\n\t} else if (learning.tier === \"warm\") {\n\t\tscore += 0.1;\n\t}\n\n\t// Priority boost\n\tif (learning.priority === \"critical\") {\n\t\tscore += 0.2;\n\t} else if (learning.priority === \"high\") {\n\t\tscore += 0.1;\n\t}\n\n\t// Seed data is authoritative\n\tif (learning.source === \"seed\") {\n\t\tscore += 0.1;\n\t}\n\n\treturn Math.min(1.0, score);\n}\n","/**\n * Hybrid Retrieval Service\n *\n * Provides adaptive semantic+keyword retrieval for learnings.\n * Uses query classification to optimize RRF weights.\n *\n * Features:\n * - Adaptive weights based on query classification\n * - Confidence thresholding (skip hybrid when uncertain)\n * - Fallback to keyword-only when embeddings unavailable\n * - Cache invalidation on learning updates\n * - Auto-indexing of learnings on first use\n *\n * @see packages/intelligence/src/knowledge/retriever.ts\n */\n\nimport { join } from \"node:path\";\nimport {\n\tcalculateMetadataBoost,\n\tcalculateRerankingScore,\n\tclassifyQuery,\n\tcosineSimilarity,\n\texpandQuery,\n\tgetConfidenceLevel,\n\tgetEmbedding,\n\tgetRetrievalStrategy,\n\ttype HistoricalSignals,\n\tHybridRetriever,\n\tKnowledgeStore,\n\ttype QueryClassification,\n\ttype QueryComplexity,\n\ttype RetrievalResult,\n\ttype RetrievalStrategy,\n} from \"@snapback/intelligence\";\nimport {\n\tensureEmbeddingsReady,\n\ttype IngestionResult,\n\tindexAllLearnings,\n\tisEmbeddingsAvailable,\n} from \"./knowledge-ingestion-service.js\";\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\n/**\n * Minimum classification confidence to use adaptive weights\n * Below this, fall back to balanced weights (0.5/0.5)\n */\nconst MIN_CLASSIFICATION_CONFIDENCE = 0.5;\n\n/**\n * Cache TTL in milliseconds (5 minutes)\n * After this, retriever will be recreated on next use\n */\nconst CACHE_TTL_MS = 5 * 60 * 1000;\n\n/**\n * Maximum candidates to consider for reranking\n * Reranking is expensive, so we limit candidates\n */\nconst RERANK_CANDIDATE_LIMIT = 15;\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Enhanced retrieval metrics for observability\n * @see https://arxiv.org/abs/2501.07391 - RAG best practices\n */\nexport interface RetrievalMetrics {\n\tqueryLength: number;\n\tclassificationType: string;\n\tclassificationComplexity: QueryComplexity;\n\tclassificationConfidence: number;\n\tembeddingsAvailable: boolean;\n\tstrategy: RetrievalStrategy;\n\tretrievalSkipped: boolean;\n\tqueryExpansionUsed: boolean;\n\texpandedQueries: number;\n\trerankingApplied: boolean;\n\tsemanticCandidates: number;\n\tkeywordCandidates: number;\n\tfusedCount: number;\n\trerankedCount: number;\n\tfinalResultCount: number;\n\tlatencyMs: number;\n\tfallbackUsed?: \"keyword-only\" | \"balanced-weights\" | \"skipped\";\n\tindexingPerformed: boolean;\n}\n\n// =============================================================================\n// STATE\n// =============================================================================\n\ninterface CachedRetriever {\n\tstore: KnowledgeStore;\n\tretriever: HybridRetriever;\n\tcreatedAt: number;\n\tindexed: boolean;\n}\n\n// Cache of HybridRetriever instances per workspace\nconst retrievers = new Map<string, CachedRetriever>();\n\n// Track whether workspace has been indexed\nconst indexedWorkspaces = new Set<string>();\n\n// =============================================================================\n// PUBLIC API\n// =============================================================================\n\n/**\n * Get or create a HybridRetriever for a workspace\n *\n * @param workspaceRoot - Absolute path to workspace root\n * @returns HybridRetriever instance configured for the workspace\n */\nexport function getHybridRetriever(workspaceRoot: string): HybridRetriever {\n\tconst cached = retrievers.get(workspaceRoot);\n\n\t// Check if cache is still valid\n\tif (cached && Date.now() - cached.createdAt < CACHE_TTL_MS) {\n\t\treturn cached.retriever;\n\t}\n\n\t// Clean up stale cache\n\tif (cached) {\n\t\tcached.store.close();\n\t\tretrievers.delete(workspaceRoot);\n\t}\n\n\t// Create new instance\n\tconst dbPath = join(workspaceRoot, \".snapback\", \"knowledge.db\");\n\tconst store = new KnowledgeStore({ dbPath });\n\tconst retriever = new HybridRetriever(store, {\n\t\t// Default config - adaptive weights override per-query\n\t\tsemanticWeight: 0.5,\n\t\tkeywordWeight: 0.5,\n\t\tk: 60, // Standard RRF parameter\n\t\tlimit: 10,\n\t\tminConfidence: 0.1,\n\t\tcandidateMultiplier: 3,\n\t});\n\n\tretrievers.set(workspaceRoot, {\n\t\tstore,\n\t\tretriever,\n\t\tcreatedAt: Date.now(),\n\t\tindexed: indexedWorkspaces.has(workspaceRoot),\n\t});\n\n\treturn retriever;\n}\n\n/**\n * Retrieve learnings using adaptive hybrid search\n *\n * Classifies the query to determine optimal semantic vs keyword weights:\n * - Factual queries (specific lookups): keyword=0.7, semantic=0.3\n * - Conceptual queries (understanding): semantic=0.7, keyword=0.3\n * - Exploratory queries (browsing): balanced 0.5/0.5\n *\n * Includes fallback behaviors:\n * - Low confidence classification  balanced weights\n * - Embeddings unavailable  keyword-only search\n * - Empty KnowledgeStore  auto-index learnings first\n *\n * @param workspaceRoot - Workspace root path\n * @param query - Search query (task description or keywords)\n * @returns Retrieval results with classification metadata\n */\nexport async function retrieveAdaptive(\n\tworkspaceRoot: string,\n\tquery: string,\n): Promise<{\n\tresults: RetrievalResult[];\n\tclassification: QueryClassification;\n\tstats: {\n\t\tsemanticCandidates: number;\n\t\tkeywordCandidates: number;\n\t\tfusedCount: number;\n\t\tlatencyMs: number;\n\t\tfallbackUsed?: \"keyword-only\" | \"balanced-weights\";\n\t\tindexingPerformed?: boolean;\n\t};\n}> {\n\tconst startTime = performance.now();\n\n\t// Step 0: Auto-index learnings if not done yet\n\tlet indexingPerformed = false;\n\tif (!indexedWorkspaces.has(workspaceRoot)) {\n\t\ttry {\n\t\t\tconst indexResult = await indexAllLearnings(workspaceRoot, {\n\t\t\t\tskipEmbeddings: !isEmbeddingsAvailable(),\n\t\t\t});\n\t\t\tindexedWorkspaces.add(workspaceRoot);\n\t\t\tindexingPerformed = indexResult.indexed > 0;\n\n\t\t\tif (indexingPerformed) {\n\t\t\t\tconsole.log(`[HybridRetrieval] Auto-indexed ${indexResult.indexed} learnings for ${workspaceRoot}`);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.warn(\"[HybridRetrieval] Auto-indexing failed:\", error);\n\t\t}\n\t}\n\n\t// Step 1: Classify the query\n\tconst classification = classifyQuery(query);\n\n\t// Step 2: Determine if we should use adaptive weights\n\tlet fallbackUsed: \"keyword-only\" | \"balanced-weights\" | undefined;\n\n\t// Check if embeddings are available for semantic search\n\tconst embeddingsAvailable = isEmbeddingsAvailable();\n\n\tif (!embeddingsAvailable) {\n\t\t// Fallback to keyword-only search\n\t\tfallbackUsed = \"keyword-only\";\n\t\treturn keywordOnlySearch(workspaceRoot, query, classification, startTime, {\n\t\t\tfallbackUsed,\n\t\t\tindexingPerformed,\n\t\t});\n\t}\n\n\t// Check classification confidence\n\tif (classification.confidence < MIN_CLASSIFICATION_CONFIDENCE) {\n\t\t// Low confidence - use balanced weights instead of adaptive\n\t\tfallbackUsed = \"balanced-weights\";\n\t\t// Override weights to balanced\n\t\tclassification.weights = { semantic: 0.5, keyword: 0.5 };\n\t}\n\n\t// Step 3: Run adaptive retrieval\n\ttry {\n\t\tconst retriever = getHybridRetriever(workspaceRoot);\n\t\tconst result = await retriever.retrieveAdaptive(query);\n\n\t\treturn {\n\t\t\tresults: result.results,\n\t\t\tclassification:\n\t\t\t\tfallbackUsed === \"balanced-weights\"\n\t\t\t\t\t? { ...result.classification, weights: { semantic: 0.5, keyword: 0.5 } }\n\t\t\t\t\t: result.classification,\n\t\t\tstats: {\n\t\t\t\t...result.stats,\n\t\t\t\tfallbackUsed,\n\t\t\t\tindexingPerformed,\n\t\t\t},\n\t\t};\n\t} catch (error) {\n\t\t// If hybrid retrieval fails, fall back to keyword-only\n\t\tconsole.warn(\"[HybridRetrieval] Hybrid retrieval failed, using keyword fallback:\", error);\n\t\treturn keywordOnlySearch(workspaceRoot, query, classification, startTime, {\n\t\t\tfallbackUsed: \"keyword-only\",\n\t\t\tindexingPerformed,\n\t\t});\n\t}\n}\n\n/**\n * Keyword-only search fallback\n *\n * Used when:\n * - Embeddings model is not loaded\n * - Hybrid retrieval fails\n * - Explicit request for keyword search\n */\nasync function keywordOnlySearch(\n\tworkspaceRoot: string,\n\tquery: string,\n\tclassification: QueryClassification,\n\tstartTime: number,\n\tmetadata: {\n\t\tfallbackUsed: \"keyword-only\" | \"balanced-weights\";\n\t\tindexingPerformed: boolean;\n\t},\n): Promise<{\n\tresults: RetrievalResult[];\n\tclassification: QueryClassification;\n\tstats: {\n\t\tsemanticCandidates: number;\n\t\tkeywordCandidates: number;\n\t\tfusedCount: number;\n\t\tlatencyMs: number;\n\t\tfallbackUsed?: \"keyword-only\" | \"balanced-weights\";\n\t\tindexingPerformed?: boolean;\n\t};\n}> {\n\tconst cached = retrievers.get(workspaceRoot);\n\tconst store =\n\t\tcached?.store ??\n\t\tnew KnowledgeStore({\n\t\t\tdbPath: join(workspaceRoot, \".snapback\", \"knowledge.db\"),\n\t\t});\n\n\t// Run keyword-only search\n\tconst keywordResults = store.searchKeyword(query, 10);\n\tconst elapsed = performance.now() - startTime;\n\n\t// Convert to RetrievalResult format\n\tconst results: RetrievalResult[] = keywordResults.map((chunk, index) => ({\n\t\tchunk,\n\t\tscore: 1 / (60 + index + 1), // RRF-style score\n\t\tconfidence: 0.5 + 0.3 * (1 - index / keywordResults.length), // Decreasing confidence\n\t\tsources: {\n\t\t\tkeyword: { rank: index + 1 },\n\t\t},\n\t}));\n\n\treturn {\n\t\tresults,\n\t\tclassification: {\n\t\t\t...classification,\n\t\t\tweights: { semantic: 0, keyword: 1 }, // Keyword-only\n\t\t},\n\t\tstats: {\n\t\t\tsemanticCandidates: 0,\n\t\t\tkeywordCandidates: keywordResults.length,\n\t\t\tfusedCount: keywordResults.length,\n\t\t\tlatencyMs: elapsed,\n\t\t\t...metadata,\n\t\t},\n\t};\n}\n\n/**\n * Pre-classify a query without retrieving\n * Useful for understanding what retrieval strategy will be used\n *\n * @param query - Query to classify\n * @returns Classification with type, confidence, and weights\n */\nexport function classifyQueryType(query: string): QueryClassification {\n\treturn classifyQuery(query);\n}\n\n/**\n * Initialize hybrid retrieval for a workspace\n *\n * Call during server startup for optimal first-query performance:\n * 1. Preloads embeddings model\n * 2. Indexes existing learnings\n * 3. Warms up the retriever cache\n *\n * @param workspaceRoot - Workspace root path\n */\nexport async function initializeHybridRetrieval(workspaceRoot: string): Promise<{\n\tembeddingsReady: boolean;\n\tindexingResult: IngestionResult;\n}> {\n\t// Step 1: Preload embeddings model\n\tconst embeddingsReady = await ensureEmbeddingsReady();\n\n\t// Step 2: Index existing learnings\n\tconst indexingResult = await indexAllLearnings(workspaceRoot, {\n\t\tskipEmbeddings: !embeddingsReady,\n\t});\n\tindexedWorkspaces.add(workspaceRoot);\n\n\t// Step 3: Warm up retriever cache\n\tgetHybridRetriever(workspaceRoot);\n\n\tconsole.log(\n\t\t`[HybridRetrieval] Initialized for ${workspaceRoot}: ` +\n\t\t\t`embeddings=${embeddingsReady}, indexed=${indexingResult.indexed}`,\n\t);\n\n\treturn { embeddingsReady, indexingResult };\n}\n\n/**\n * Invalidate cache for a workspace\n * Call when learnings are added/updated\n */\nexport function invalidateRetrieverCache(workspaceRoot: string): void {\n\tconst cached = retrievers.get(workspaceRoot);\n\tif (cached) {\n\t\tcached.store.close();\n\t\tretrievers.delete(workspaceRoot);\n\t}\n\tindexedWorkspaces.delete(workspaceRoot);\n}\n\n/**\n * Dispose retriever for a workspace\n * Call when workspace is closed\n */\nexport function disposeRetriever(workspaceRoot: string): void {\n\tinvalidateRetrieverCache(workspaceRoot);\n}\n\n/**\n * Dispose all retrievers\n * Call on server shutdown\n */\nexport function disposeAllRetrievers(): void {\n\tfor (const [, cached] of retrievers) {\n\t\tcached.store.close();\n\t}\n\tretrievers.clear();\n\tindexedWorkspaces.clear();\n}\n\n/**\n * Get retrieval statistics for monitoring\n */\nexport function getRetrievalStats(workspaceRoot: string): {\n\tcacheHit: boolean;\n\tcacheAgeMs: number;\n\tindexed: boolean;\n\tembeddingsAvailable: boolean;\n} {\n\tconst cached = retrievers.get(workspaceRoot);\n\treturn {\n\t\tcacheHit: !!cached,\n\t\tcacheAgeMs: cached ? Date.now() - cached.createdAt : 0,\n\t\tindexed: indexedWorkspaces.has(workspaceRoot),\n\t\tembeddingsAvailable: isEmbeddingsAvailable(),\n\t};\n}\n\n// =============================================================================\n// ENHANCED RETRIEVAL (V2) - 2025 Best Practices\n// =============================================================================\n\n/**\n * Enhanced adaptive retrieval with 2025 best practices:\n * - Query complexity classification for retrieval strategy\n * - Query expansion for factual queries\n * - Post-RRF reranking for improved relevance\n * - Comprehensive metrics for observability\n *\n * @see https://arxiv.org/abs/2501.07391 - RAG best practices\n * @see https://www.meilisearch.com/blog/adaptive-rag\n * @see https://www.elastic.co/search-labs/blog/weighted-reciprocal-rank-fusion-rrf\n */\nexport async function retrieveAdaptiveV2(\n\tworkspaceRoot: string,\n\tquery: string,\n): Promise<{\n\tresults: RetrievalResult[];\n\tclassification: QueryClassification;\n\tstrategy: RetrievalStrategy;\n\tmetrics: RetrievalMetrics;\n}> {\n\tconst startTime = performance.now();\n\n\t// Initialize metrics\n\tconst metrics: RetrievalMetrics = {\n\t\tqueryLength: query.length,\n\t\tclassificationType: \"unknown\",\n\t\tclassificationComplexity: \"moderate\",\n\t\tclassificationConfidence: 0,\n\t\tembeddingsAvailable: isEmbeddingsAvailable(),\n\t\tstrategy: { shouldRetrieve: true, topK: 10, useReranking: false, useExpansion: false },\n\t\tretrievalSkipped: false,\n\t\tqueryExpansionUsed: false,\n\t\texpandedQueries: 1,\n\t\trerankingApplied: false,\n\t\tsemanticCandidates: 0,\n\t\tkeywordCandidates: 0,\n\t\tfusedCount: 0,\n\t\trerankedCount: 0,\n\t\tfinalResultCount: 0,\n\t\tlatencyMs: 0,\n\t\tindexingPerformed: false,\n\t};\n\n\t// Step 0: Auto-index learnings if not done yet\n\tif (!indexedWorkspaces.has(workspaceRoot)) {\n\t\ttry {\n\t\t\tconst indexResult = await indexAllLearnings(workspaceRoot, {\n\t\t\t\tskipEmbeddings: !metrics.embeddingsAvailable,\n\t\t\t});\n\t\t\tindexedWorkspaces.add(workspaceRoot);\n\t\t\tmetrics.indexingPerformed = indexResult.indexed > 0;\n\n\t\t\tif (metrics.indexingPerformed) {\n\t\t\t\tconsole.log(`[HybridRetrieval] Auto-indexed ${indexResult.indexed} learnings for ${workspaceRoot}`);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.warn(\"[HybridRetrieval] Auto-indexing failed:\", error);\n\t\t}\n\t}\n\n\t// Step 1: Classify the query (type + complexity)\n\tconst classification = classifyQuery(query);\n\tmetrics.classificationType = classification.type;\n\tmetrics.classificationComplexity = classification.complexity;\n\tmetrics.classificationConfidence = classification.confidence;\n\n\t// Step 2: Determine retrieval strategy based on complexity\n\tconst strategy = getRetrievalStrategy(classification.complexity, classification.type, classification.confidence);\n\tmetrics.strategy = strategy;\n\n\t// Step 3: Check if retrieval should be skipped (simple queries)\n\tif (!strategy.shouldRetrieve) {\n\t\tmetrics.retrievalSkipped = true;\n\t\tmetrics.fallbackUsed = \"skipped\";\n\t\tmetrics.latencyMs = performance.now() - startTime;\n\n\t\tconsole.log(`[HybridRetrieval] Skipped retrieval for simple query: \"${query.slice(0, 50)}...\"`);\n\n\t\treturn {\n\t\t\tresults: [],\n\t\t\tclassification,\n\t\t\tstrategy,\n\t\t\tmetrics,\n\t\t};\n\t}\n\n\t// Step 4: Check embeddings availability\n\tif (!metrics.embeddingsAvailable) {\n\t\tmetrics.fallbackUsed = \"keyword-only\";\n\t\tconst result = await keywordOnlySearchV2(workspaceRoot, query, classification, strategy, metrics, startTime);\n\t\treturn result;\n\t}\n\n\t// Step 5: Check classification confidence\n\tif (classification.confidence < MIN_CLASSIFICATION_CONFIDENCE) {\n\t\tmetrics.fallbackUsed = \"balanced-weights\";\n\t\tclassification.weights = { semantic: 0.5, keyword: 0.5 };\n\t}\n\n\t// Step 6: Query expansion (for factual queries)\n\tlet queries = [query];\n\tif (strategy.useExpansion) {\n\t\tqueries = expandQuery(query, classification.type);\n\t\tmetrics.queryExpansionUsed = queries.length > 1;\n\t\tmetrics.expandedQueries = queries.length;\n\t}\n\n\t// Step 7: Run adaptive retrieval\n\ttry {\n\t\tconst retriever = getHybridRetriever(workspaceRoot);\n\n\t\t// Update retriever config for this query's strategy\n\t\tretriever.updateConfig({ limit: strategy.topK });\n\n\t\t// Run retrieval (potentially with multiple queries)\n\t\tlet allResults: RetrievalResult[] = [];\n\n\t\tfor (const q of queries) {\n\t\t\tconst result = await retriever.retrieveAdaptive(q);\n\t\t\tmetrics.semanticCandidates += result.stats.semanticCandidates;\n\t\t\tmetrics.keywordCandidates += result.stats.keywordCandidates;\n\t\t\tallResults = allResults.concat(result.results);\n\t\t}\n\n\t\t// Deduplicate results by chunk ID\n\t\tconst seen = new Set<string>();\n\t\tconst dedupedResults = allResults.filter((r) => {\n\t\t\tif (seen.has(r.chunk.id)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tseen.add(r.chunk.id);\n\t\t\treturn true;\n\t\t});\n\n\t\tmetrics.fusedCount = dedupedResults.length;\n\n\t\t// Step 8: Apply reranking if enabled (with three-layer confidence model)\n\t\tlet finalResults = dedupedResults;\n\t\tif (strategy.useReranking && dedupedResults.length > 1) {\n\t\t\tconst cached = retrievers.get(workspaceRoot);\n\t\t\tfinalResults = await rerankResults(query, dedupedResults, cached?.store);\n\t\t\tmetrics.rerankingApplied = true;\n\t\t\tmetrics.rerankedCount = finalResults.length;\n\t\t}\n\n\t\t// Limit to topK\n\t\tfinalResults = finalResults.slice(0, strategy.topK);\n\t\tmetrics.finalResultCount = finalResults.length;\n\t\tmetrics.latencyMs = performance.now() - startTime;\n\n\t\tconsole.log(\n\t\t\t`[HybridRetrieval] V2 retrieval [${classification.type}/${classification.complexity}]: ` +\n\t\t\t\t`${finalResults.length} results in ${metrics.latencyMs.toFixed(2)}ms ` +\n\t\t\t\t`(expansion=${metrics.queryExpansionUsed}, rerank=${metrics.rerankingApplied})`,\n\t\t);\n\n\t\treturn {\n\t\t\tresults: finalResults,\n\t\t\tclassification:\n\t\t\t\tmetrics.fallbackUsed === \"balanced-weights\"\n\t\t\t\t\t? { ...classification, weights: { semantic: 0.5, keyword: 0.5 } }\n\t\t\t\t\t: classification,\n\t\t\tstrategy,\n\t\t\tmetrics,\n\t\t};\n\t} catch (error) {\n\t\t// Fallback to keyword-only on error\n\t\tconsole.warn(\"[HybridRetrieval] V2 retrieval failed, using keyword fallback:\", error);\n\t\tmetrics.fallbackUsed = \"keyword-only\";\n\t\treturn keywordOnlySearchV2(workspaceRoot, query, classification, strategy, metrics, startTime);\n\t}\n}\n\n/**\n * Rerank results using three-layer confidence model\n *\n * Per ADR specification, combines:\n * - Layer 1: Retrieval score (semantic similarity)\n * - Layer 2: Historical signals (success rate, usage)\n * - Layer 3: Metadata signals (authority, status, recency)\n *\n * @see https://www.dbi-services.com/blog/rag-series-hybrid-search-with-re-ranking/\n */\nasync function rerankResults(\n\tquery: string,\n\tresults: RetrievalResult[],\n\tstore?: KnowledgeStore,\n): Promise<RetrievalResult[]> {\n\t// Only rerank top candidates\n\tconst candidates = results.slice(0, RERANK_CANDIDATE_LIMIT);\n\n\ttry {\n\t\t// Get query embedding\n\t\tconst queryEmbedding = await getEmbedding(query);\n\n\t\t// Get historical signals for all chunks (batch operation)\n\t\tconst chunkIds = candidates.map((r) => r.chunk.id);\n\t\tconst historicalSignalsMap: Map<string, HistoricalSignals> = store\n\t\t\t? store.getChunksWithSignals(chunkIds)\n\t\t\t: new Map();\n\n\t\t// Score each result using three-layer confidence model\n\t\tconst scored = await Promise.all(\n\t\t\tcandidates.map(async (result) => {\n\t\t\t\t// Layer 1: Get semantic similarity (retrieval score)\n\t\t\t\tlet semanticScore = result.sources.semantic?.similarity ?? 0;\n\n\t\t\t\t// If no semantic similarity, compute it\n\t\t\t\tif (!semanticScore && result.chunk.chunk_text) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst chunkEmbedding = await getEmbedding(result.chunk.chunk_text);\n\t\t\t\t\t\tsemanticScore = cosineSimilarity(queryEmbedding, chunkEmbedding);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Keep original score on embedding failure\n\t\t\t\t\t\tsemanticScore = result.score;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Layer 2: Get historical signals\n\t\t\t\tconst historicalSignals = historicalSignalsMap.get(result.chunk.id);\n\n\t\t\t\t// Layer 3: Calculate metadata boost (authority, status, recency)\n\t\t\t\tconst metadataBoost = calculateMetadataBoost(result.chunk);\n\n\t\t\t\t// Combined score using three-layer model\n\t\t\t\tconst rerankScore = calculateRerankingScore(semanticScore, result.chunk, historicalSignals);\n\n\t\t\t\t// Confidence level for display\n\t\t\t\tconst confidenceLevel = getConfidenceLevel(rerankScore);\n\n\t\t\t\treturn {\n\t\t\t\t\t...result,\n\t\t\t\t\trerankedScore: rerankScore,\n\t\t\t\t\tmetadataBoost,\n\t\t\t\t\tconfidenceLevel,\n\t\t\t\t\thistoricalSignals,\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\n\t\t// Sort by reranked score\n\t\tscored.sort((a, b) => b.rerankedScore - a.rerankedScore);\n\n\t\t// Return with updated scores and confidence\n\t\treturn scored.map(({ rerankedScore, metadataBoost, confidenceLevel, historicalSignals, ...result }) => ({\n\t\t\t...result,\n\t\t\tscore: rerankedScore,\n\t\t\tconfidence: rerankedScore,\n\t\t\t// Add metadata to sources for observability\n\t\t\tsources: {\n\t\t\t\t...result.sources,\n\t\t\t\treranking: {\n\t\t\t\t\tmetadataBoost,\n\t\t\t\t\tconfidenceLevel,\n\t\t\t\t\thasHistoricalSignals: !!historicalSignals,\n\t\t\t\t},\n\t\t\t},\n\t\t}));\n\t} catch (error) {\n\t\tconsole.warn(\"[HybridRetrieval] Reranking failed, keeping original order:\", error);\n\t\treturn candidates;\n\t}\n}\n\n/**\n * Keyword-only search fallback for V2\n */\nasync function keywordOnlySearchV2(\n\tworkspaceRoot: string,\n\tquery: string,\n\tclassification: QueryClassification,\n\tstrategy: RetrievalStrategy,\n\tmetrics: RetrievalMetrics,\n\tstartTime: number,\n): Promise<{\n\tresults: RetrievalResult[];\n\tclassification: QueryClassification;\n\tstrategy: RetrievalStrategy;\n\tmetrics: RetrievalMetrics;\n}> {\n\tconst cached = retrievers.get(workspaceRoot);\n\tconst store =\n\t\tcached?.store ??\n\t\tnew KnowledgeStore({\n\t\t\tdbPath: join(workspaceRoot, \".snapback\", \"knowledge.db\"),\n\t\t});\n\n\t// Run keyword-only search\n\tconst keywordResults = store.searchKeyword(query, strategy.topK);\n\tmetrics.keywordCandidates = keywordResults.length;\n\tmetrics.fusedCount = keywordResults.length;\n\tmetrics.finalResultCount = keywordResults.length;\n\tmetrics.latencyMs = performance.now() - startTime;\n\n\t// Convert to RetrievalResult format\n\tconst results: RetrievalResult[] = keywordResults.map((chunk, index) => ({\n\t\tchunk,\n\t\tscore: 1 / (60 + index + 1), // RRF-style score\n\t\tconfidence: 0.5 + 0.3 * (1 - index / Math.max(keywordResults.length, 1)),\n\t\tsources: {\n\t\t\tkeyword: { rank: index + 1 },\n\t\t},\n\t}));\n\n\treturn {\n\t\tresults,\n\t\tclassification: {\n\t\t\t...classification,\n\t\t\tweights: { semantic: 0, keyword: 1 },\n\t\t},\n\t\tstrategy,\n\t\tmetrics,\n\t};\n}\n","/**\n * Intelligence Facade Singleton\n *\n * Provides lazy-initialized Intelligence instances per workspace.\n * Used by MCP handlers to access validation, learning, and context retrieval.\n *\n * @module facades/intelligence\n */\n\nimport { Intelligence } from \"@snapback/intelligence\";\n\n/**\n * Cache of Intelligence instances by workspace root\n * Singleton pattern ensures consistent state across tool calls\n */\nconst instances = new Map<string, Intelligence>();\n\n/**\n * Get or create an Intelligence instance for a workspace\n *\n * Intelligence is the shared session store across all surfaces (Extension, MCP, CLI).\n * All surfaces use the same workspace-keyed persistence path for session coordination.\n *\n * @param workspaceRoot - Absolute path to workspace root\n * @returns Intelligence instance configured for the workspace\n *\n * @example\n * ```typescript\n * const intel = getIntelligence(\"/path/to/workspace\");\n * const context = await intel.getContext({ task: \"Add auth\" });\n * ```\n */\nexport function getIntelligence(workspaceRoot: string): Intelligence {\n\tif (!instances.has(workspaceRoot)) {\n\t\tconst intel = new Intelligence({\n\t\t\trootDir: workspaceRoot,\n\t\t\t// Free tier defaults - semantic search disabled\n\t\t\tenableSemanticSearch: false,\n\t\t\tenableLearningLoop: true,\n\t\t\t// Enable enhanced validation (Biome + TypeScript + dynamic confidence)\n\t\t\tenhancedValidation: true,\n\t\t\t// Storage paths relative to workspace\n\t\t\tpatternsDir: \".snapback/patterns\",\n\t\t\tlearningsDir: \".snapback/learnings\",\n\t\t\tconstraintsFile: \".snapback/constraints.json\",\n\t\t\t// Session persistence for cross-surface coordination\n\t\t\t// All surfaces (Extension, MCP, CLI) share this same path\n\t\t\tsessionPersistence: {\n\t\t\t\tpath: `${workspaceRoot}/.snapback/session/sessions.jsonl`,\n\t\t\t\tautosave: true,\n\t\t\t},\n\t\t});\n\t\tinstances.set(workspaceRoot, intel);\n\t}\n\tconst instance = instances.get(workspaceRoot);\n\tif (!instance) {\n\t\tthrow new Error(`Failed to get Intelligence instance for ${workspaceRoot}`);\n\t}\n\treturn instance;\n}\n\n/**\n * Initialize Intelligence instance for a workspace\n * Call once at server startup for workspaces needing async features\n *\n * @param workspaceRoot - Absolute path to workspace root\n */\nexport async function initializeIntelligence(workspaceRoot: string): Promise<void> {\n\tconst intel = getIntelligence(workspaceRoot);\n\tawait intel.initialize();\n}\n\n/**\n * Dispose of Intelligence instance for a workspace\n * Call when workspace is closed or server is shutting down\n *\n * @param workspaceRoot - Absolute path to workspace root\n */\nexport async function disposeIntelligence(workspaceRoot: string): Promise<void> {\n\tconst intel = instances.get(workspaceRoot);\n\tif (intel) {\n\t\tawait intel.dispose();\n\t\tinstances.delete(workspaceRoot);\n\t}\n}\n\n/**\n * Dispose all Intelligence instances\n * Call on server shutdown\n */\nexport async function disposeAllIntelligence(): Promise<void> {\n\tconst disposals = Array.from(instances.entries()).map(async ([root, intel]) => {\n\t\tawait intel.dispose();\n\t\tinstances.delete(root);\n\t});\n\tawait Promise.all(disposals);\n}\n\n/**\n * Get count of active Intelligence instances\n * Useful for debugging and monitoring\n */\nexport function getActiveInstanceCount(): number {\n\treturn instances.size;\n}\n","/**\n * Composite Tool: begin_task\n *\n * Single entry point that replaces the manual workflow:\n * get_context  snapshot_create  get_learnings  session.start\n *\n * Reduces 5+ tool calls to 1 for starting any development task.\n *\n * @see pair_programmer.md Section 2.1\n * @module facades/begin-task\n */\n\nimport { existsSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport { beginTaskViaDaemon } from \"../daemon/client-facade.js\";\nimport type { ToolHandler, ToolResult } from \"../registry.js\";\nimport { type DependencyContext, getDependencyGraphService } from \"../services/dependency-graph-service.js\";\nimport { createErrorCacheService } from \"../services/error-cache-service.js\";\nimport { createGitContextService } from \"../services/git-context-service.js\";\nimport { classifyQueryType, retrieveAdaptive } from \"../services/hybrid-retrieval-service.js\";\nimport { createSnapshotService } from \"../services/snapshot-service.js\";\nimport { getTestCoverageService, type TestCoverageContext } from \"../services/test-coverage-service.js\";\nimport { TieredLearningService } from \"../services/tiered-learning-service.js\";\nimport {\n\tdrainPendingObservations,\n\textractKeywords,\n\tgetSessionState,\n\ttype RiskArea,\n\tstartTask,\n} from \"../session/state.js\";\nimport type { ErrorContext, GitContext } from \"../types/context.js\";\nimport { getIntelligence } from \"./intelligence.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface RiskAssessment {\n\toverallRisk: \"low\" | \"medium\" | \"high\";\n\triskAreas: RiskArea[];\n\trecommendations: string[];\n}\n\n/**\n * Task intent types for intent-aware context loading\n * @see Archaeological Feedback Synthesis - P0: Intent-Aware Context\n */\nexport type TaskIntent = \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\n/**\n * Intent-specific context loading configuration\n * Controls what context is pre-loaded based on user intent\n */\nconst INTENT_CONTEXT_CONFIG: Record<\n\tTaskIntent,\n\t{\n\t\tprioritize: string[];\n\t\tinclude: string[];\n\t\texclude: string[];\n\t}\n> = {\n\timplement: {\n\t\tprioritize: [\"contracts\", \"patterns\", \"tests\"],\n\t\tinclude: [\"architecture\", \"constraints\"],\n\t\texclude: [\"violations\"], // Don't distract during new work\n\t},\n\tdebug: {\n\t\tprioritize: [\"violations\", \"failures\", \"history\"],\n\t\tinclude: [\"tests\", \"patterns\"],\n\t\texclude: [], // Need all context for debugging\n\t},\n\trefactor: {\n\t\tprioritize: [\"canonical\", \"patterns\", \"duplicates\"],\n\t\tinclude: [\"architecture\", \"migrations\"],\n\t\texclude: [],\n\t},\n\treview: {\n\t\tprioritize: [\"checklist\", \"risks\", \"coverage\"],\n\t\tinclude: [\"constraints\", \"violations\"],\n\t\texclude: [],\n\t},\n\texplore: {\n\t\tprioritize: [\"architecture\", \"genealogy\", \"epochs\"],\n\t\tinclude: [\"history\", \"decisions\"],\n\t\texclude: [\"violations\"], // Not relevant for exploration\n\t},\n};\n\n/**\n * Infer intent from task description using keyword matching\n */\nfunction inferIntent(task: string): TaskIntent {\n\tconst lower = task.toLowerCase();\n\n\t// Debug indicators\n\tif (\n\t\tlower.includes(\"fix\") ||\n\t\tlower.includes(\"bug\") ||\n\t\tlower.includes(\"error\") ||\n\t\tlower.includes(\"debug\") ||\n\t\tlower.includes(\"broken\") ||\n\t\tlower.includes(\"failing\")\n\t) {\n\t\treturn \"debug\";\n\t}\n\n\t// Refactor indicators\n\tif (\n\t\tlower.includes(\"refactor\") ||\n\t\tlower.includes(\"clean\") ||\n\t\tlower.includes(\"rename\") ||\n\t\tlower.includes(\"move\") ||\n\t\tlower.includes(\"extract\") ||\n\t\tlower.includes(\"consolidate\")\n\t) {\n\t\treturn \"refactor\";\n\t}\n\n\t// Review indicators\n\tif (\n\t\tlower.includes(\"review\") ||\n\t\tlower.includes(\"check\") ||\n\t\tlower.includes(\"audit\") ||\n\t\tlower.includes(\"verify\") ||\n\t\tlower.includes(\"validate\")\n\t) {\n\t\treturn \"review\";\n\t}\n\n\t// Explore indicators\n\tif (\n\t\tlower.includes(\"explore\") ||\n\t\tlower.includes(\"understand\") ||\n\t\tlower.includes(\"how does\") ||\n\t\tlower.includes(\"what is\") ||\n\t\tlower.includes(\"where is\") ||\n\t\tlower.includes(\"find\")\n\t) {\n\t\treturn \"explore\";\n\t}\n\n\t// Default to implement\n\treturn \"implement\";\n}\n\n/**\n * Get intent-specific context loading hints\n */\nexport function getIntentContextHints(intent: TaskIntent): {\n\tprioritize: string[];\n\tinclude: string[];\n\texclude: string[];\n} {\n\treturn INTENT_CONTEXT_CONFIG[intent];\n}\n\ninterface SkippedTestInfo {\n\tfile: string;\n\ttype: \"describe\" | \"it\" | \"test\";\n\tname?: string;\n\tline: number;\n}\n\ninterface StaticAnalysisOutput {\n\t/** Skipped tests found in planned files */\n\tskippedTests: SkippedTestInfo[];\n\t/** Whether analysis completed successfully */\n\tsuccess: boolean;\n\t/** Analysis duration in ms */\n\tduration: number;\n\t/** Errors encountered */\n\terrors: string[];\n}\n\n/**\n * Proactive guidance from AdvisoryEngine\n */\ninterface ProactiveGuidance {\n\t/** Brief summary for LLM */\n\tsummary: string;\n\t/** Proactive suggestions (ranked by priority) */\n\tsuggestions: Array<{\n\t\ttext: string;\n\t\tpriority: number;\n\t\tconfidence: number;\n\t\tcategory: \"testing\" | \"snapshot\" | \"validation\" | \"documentation\" | \"safety\";\n\t\tfiles?: string[];\n\t}>;\n}\n\n/**\n * Context warning for stale data detection\n */\ninterface ContextWarning {\n\t/** Warning type: context_stale (detected) or context_rebuilt (auto-fixed) */\n\ttype: \"context_stale\" | \"context_rebuilt\";\n\t/** Human-readable warning message */\n\tmessage: string;\n\t/** Action taken or recommended */\n\taction: \"auto_rebuilt\" | \"manual_scan_recommended\" | \"none_required\";\n\t/** Days since last scan */\n\tdaysSinceScanned?: number;\n\t/** Threshold that was exceeded */\n\tthreshold?: number;\n}\n\n/**\n * Context staleness check result\n */\ninterface StalenessCheckResult {\n\t/** Whether context exists */\n\texists: boolean;\n\t/** Whether context is stale */\n\tisStale: boolean;\n\t/** Days since last scan */\n\tdaysSinceScanned: number;\n\t/** Configured threshold */\n\tthreshold: number;\n\t/** Last scan timestamp */\n\tlastScanned?: string;\n}\n\ninterface BeginTaskOutput {\n\ttaskId: string;\n\t/** Detected or provided intent for context loading */\n\tintent: TaskIntent;\n\t/** Intent-specific context loading hints */\n\tintentHints: {\n\t\tprioritize: string[];\n\t\tinclude: string[];\n\t\texclude: string[];\n\t};\n\tsnapshot: {\n\t\tcreated: boolean;\n\t\tid?: string;\n\t\treason?: string;\n\t};\n\tpatterns: Array<{\n\t\tname: string;\n\t\tdescription: string;\n\t\texamples?: string[];\n\t}>;\n\tconstraints: Array<{\n\t\tdomain: string;\n\t\tname: string;\n\t\tvalue: number | string;\n\t\tdescription: string;\n\t}>;\n\tlearnings: Array<{\n\t\ttype: string;\n\t\ttrigger: string;\n\t\taction: string;\n\t\tsource?: string;\n\t\trelevanceScore: number;\n\t}>;\n\tobservations: Array<{\n\t\ttype: string;\n\t\tmessage: string;\n\t}>;\n\triskAssessment: RiskAssessment;\n\tnextActions: Array<{\n\t\ttool: string;\n\t\tpriority: number;\n\t\treason: string;\n\t}>;\n\t/** Static analysis results for planned files */\n\tstaticAnalysis?: StaticAnalysisOutput;\n\t/** Last known errors for planned files (P0 context enhancement) */\n\tlastKnownErrors?: ErrorContext;\n\t/** Git change context (P0 context enhancement) */\n\tgitContext?: GitContext;\n\t/** Dependency context for planned files (P1 context enhancement) */\n\tdependencyContext?: DependencyContext;\n\t/** Test coverage context for planned files (P1 context enhancement) */\n\ttestCoverage?: TestCoverageContext;\n\t/** Proactive guidance from AdvisoryEngine */\n\tproactive_guidance?: ProactiveGuidance;\n\t/** Warnings about stale context that was auto-rebuilt */\n\tcontextWarnings?: ContextWarning[];\n}\n\n/**\n * Compact output format for token efficiency\n * Target: ~400 bytes (~100 tokens) vs ~5KB (~1300 tokens) for full output\n *\n * @see Stress test results showing 92% token reduction\n */\ninterface BeginTaskCompactOutput {\n\t/** Task ID for tracking */\n\ttaskId: string;\n\t/** Overall risk level */\n\trisk: \"low\" | \"medium\" | \"high\";\n\t/** Protection score 0-100 */\n\tprotection: number;\n\t/** Count of uncommitted files (not full list) */\n\tdirtyFiles: number;\n\t/** Key constraints as simple key:value */\n\tconstraints: Record<string, string>;\n\t/** Top learnings as plain strings (action only) */\n\tlearnings: string[];\n\t/** Warnings only if present */\n\twarnings: string[];\n\t/** Snapshot status */\n\tsnapshot: \"created\" | \"reused\" | \"skipped\";\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Default staleness threshold in days\n */\nconst DEFAULT_STALE_AFTER_DAYS = 7;\n\n/**\n * Check if context is stale\n * Returns staleness status without modifying anything\n */\nfunction checkContextStaleness(workspaceRoot: string): StalenessCheckResult {\n\tconst ctxPath = join(workspaceRoot, \".snapback\", \"ctx\", \"context.json\");\n\n\tif (!existsSync(ctxPath)) {\n\t\treturn {\n\t\t\texists: false,\n\t\t\tisStale: false,\n\t\t\tdaysSinceScanned: 0,\n\t\t\tthreshold: DEFAULT_STALE_AFTER_DAYS,\n\t\t};\n\t}\n\n\ttry {\n\t\tconst content = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\tconst lastScanned = content.lastScanned;\n\t\tconst staleAfterDays = content.staleAfterDays || DEFAULT_STALE_AFTER_DAYS;\n\n\t\tif (!lastScanned) {\n\t\t\t// No lastScanned means we can't determine staleness\n\t\t\t// Treat as fresh to avoid false positives\n\t\t\treturn {\n\t\t\t\texists: true,\n\t\t\t\tisStale: false,\n\t\t\t\tdaysSinceScanned: 0,\n\t\t\t\tthreshold: staleAfterDays,\n\t\t\t};\n\t\t}\n\n\t\tconst scanTime = new Date(lastScanned).getTime();\n\t\tconst daysSinceScanned = Math.floor((Date.now() - scanTime) / (1000 * 60 * 60 * 24));\n\t\tconst isStale = daysSinceScanned > staleAfterDays;\n\n\t\treturn {\n\t\t\texists: true,\n\t\t\tisStale,\n\t\t\tdaysSinceScanned,\n\t\t\tthreshold: staleAfterDays,\n\t\t\tlastScanned,\n\t\t};\n\t} catch {\n\t\t// If we can't read context, treat as non-existent\n\t\treturn {\n\t\t\texists: false,\n\t\t\tisStale: false,\n\t\t\tdaysSinceScanned: 0,\n\t\t\tthreshold: DEFAULT_STALE_AFTER_DAYS,\n\t\t};\n\t}\n}\n\n/**\n * Rebuild stale context by updating lastScanned\n * This is a lightweight rebuild - just refreshes the timestamp\n * For full rebuild, use context op=scan\n */\nfunction rebuildContext(workspaceRoot: string): { success: boolean; error?: string } {\n\tconst ctxPath = join(workspaceRoot, \".snapback\", \"ctx\", \"context.json\");\n\n\ttry {\n\t\tif (!existsSync(ctxPath)) {\n\t\t\treturn { success: false, error: \"Context file does not exist\" };\n\t\t}\n\n\t\tconst content = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\n\t\t// Update lastScanned to now\n\t\tcontent.lastScanned = new Date().toISOString();\n\n\t\twriteFileSync(ctxPath, JSON.stringify(content, null, 2));\n\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t};\n\t}\n}\n\n/**\n * Check context staleness and auto-rebuild if needed\n * Returns warnings for the response\n */\nfunction handleStaleContext(workspaceRoot: string): ContextWarning[] {\n\tconst warnings: ContextWarning[] = [];\n\tconst staleness = checkContextStaleness(workspaceRoot);\n\n\tif (!staleness.exists || !staleness.isStale) {\n\t\t// No context or context is fresh - no warnings\n\t\treturn warnings;\n\t}\n\n\t// Context is stale - attempt auto-rebuild\n\tconst rebuild = rebuildContext(workspaceRoot);\n\n\tif (rebuild.success) {\n\t\twarnings.push({\n\t\t\ttype: \"context_rebuilt\",\n\t\t\tmessage: `Context was stale (${staleness.daysSinceScanned} days since last scan, threshold: ${staleness.threshold} days). Auto-rebuilt.`,\n\t\t\taction: \"auto_rebuilt\",\n\t\t\tdaysSinceScanned: staleness.daysSinceScanned,\n\t\t\tthreshold: staleness.threshold,\n\t\t});\n\t} else {\n\t\t// Rebuild failed - warn but suggest manual action\n\t\twarnings.push({\n\t\t\ttype: \"context_stale\",\n\t\t\tmessage: `Context is stale (${staleness.daysSinceScanned} days since last scan, threshold: ${staleness.threshold} days). Auto-rebuild failed: ${rebuild.error}`,\n\t\t\taction: \"manual_scan_recommended\",\n\t\t\tdaysSinceScanned: staleness.daysSinceScanned,\n\t\t\tthreshold: staleness.threshold,\n\t\t});\n\t}\n\n\treturn warnings;\n}\n\n/**\n * Assess risk of planned files\n */\nfunction assessRisk(files: string[], _workspaceRoot: string): RiskAssessment {\n\tconst riskAreas: RiskArea[] = [];\n\tconst recommendations: string[] = [];\n\n\tfor (const file of files) {\n\t\tconst lowerPath = file.toLowerCase();\n\n\t\tif (lowerPath.includes(\"auth\") || lowerPath.includes(\"login\")) {\n\t\t\tif (!riskAreas.includes(\"auth\")) {\n\t\t\t\triskAreas.push(\"auth\");\n\t\t\t}\n\t\t}\n\t\tif (lowerPath.includes(\"payment\") || lowerPath.includes(\"stripe\")) {\n\t\t\tif (!riskAreas.includes(\"payment\")) {\n\t\t\t\triskAreas.push(\"payment\");\n\t\t\t}\n\t\t}\n\t\tif (lowerPath.includes(\"database\") || lowerPath.includes(\"migration\")) {\n\t\t\tif (!riskAreas.includes(\"database\")) {\n\t\t\t\triskAreas.push(\"database\");\n\t\t\t}\n\t\t}\n\t\tif (lowerPath.includes(\"config\") || lowerPath.includes(\".env\")) {\n\t\t\tif (!riskAreas.includes(\"config\")) {\n\t\t\t\triskAreas.push(\"config\");\n\t\t\t}\n\t\t}\n\t\tif (lowerPath.includes(\"api\") || lowerPath.includes(\"route\")) {\n\t\t\tif (!riskAreas.includes(\"api\")) {\n\t\t\t\triskAreas.push(\"api\");\n\t\t\t}\n\t\t}\n\t\tif (lowerPath.includes(\"security\") || lowerPath.includes(\"crypto\")) {\n\t\t\tif (!riskAreas.includes(\"security\")) {\n\t\t\t\triskAreas.push(\"security\");\n\t\t\t}\n\t\t}\n\t}\n\n\t// Determine overall risk\n\tconst criticalAreas: RiskArea[] = [\"auth\", \"payment\", \"security\"];\n\tconst hasCritical = riskAreas.some((a) => criticalAreas.includes(a));\n\tconst overallRisk: \"low\" | \"medium\" | \"high\" = hasCritical\n\t\t? \"high\"\n\t\t: riskAreas.length >= 2\n\t\t\t? \"medium\"\n\t\t\t: riskAreas.length > 0\n\t\t\t\t? \"medium\"\n\t\t\t\t: \"low\";\n\n\t// Build recommendations\n\tif (riskAreas.includes(\"auth\")) {\n\t\trecommendations.push(\"Test with both valid and invalid credentials\");\n\t}\n\tif (riskAreas.includes(\"payment\")) {\n\t\trecommendations.push(\"Use test mode/sandbox for payment testing\");\n\t}\n\tif (riskAreas.includes(\"database\")) {\n\t\trecommendations.push(\"Verify migrations can be rolled back\");\n\t}\n\tif (riskAreas.includes(\"config\")) {\n\t\trecommendations.push(\"Ensure secrets are not committed\");\n\t}\n\tif (files.length >= 5) {\n\t\trecommendations.push(\"Consider breaking into smaller focused changes\");\n\t}\n\n\treturn { overallRisk, riskAreas, recommendations };\n}\n\n/**\n * Decide if snapshot should be auto-created\n */\nfunction shouldAutoSnapshot(risk: RiskAssessment, files?: string[]): boolean {\n\t// Always snapshot for high risk\n\tif (risk.overallRisk === \"high\") {\n\t\treturn true;\n\t}\n\n\t// Snapshot if touching critical areas\n\tconst criticalAreas: RiskArea[] = [\"auth\", \"payment\", \"database\", \"security\"];\n\tif (risk.riskAreas.some((a) => criticalAreas.includes(a))) {\n\t\treturn true;\n\t}\n\n\t// Snapshot if modifying 3+ files\n\tif (files && files.length >= 3) {\n\t\treturn true;\n\t}\n\n\t// Medium risk + config files\n\tif (risk.overallRisk === \"medium\" && files?.some((f) => f.includes(\"config\") || f.endsWith(\".env\"))) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n// NOTE: getLearningsFromFile removed - replaced by TieredLearningService\n// which implements intent-based loading from hot/warm tiers for 97% token reduction\n\n/**\n * Get context constraints from .snapback/ctx/context.json\n */\nfunction getConstraints(workspaceRoot: string): Array<{\n\tdomain: string;\n\tname: string;\n\tvalue: number | string;\n\tdescription: string;\n}> {\n\tconst ctxPath = join(workspaceRoot, \".snapback\", \"ctx\", \"context.json\");\n\n\tif (!existsSync(ctxPath)) {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\tconst content = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\tconst constraints: Array<{\n\t\t\tdomain: string;\n\t\t\tname: string;\n\t\t\tvalue: number | string;\n\t\t\tdescription: string;\n\t\t}> = [];\n\n\t\tif (content.constraints) {\n\t\t\tfor (const [domain, domainConstraints] of Object.entries(content.constraints)) {\n\t\t\t\tfor (const [name, constraint] of Object.entries(domainConstraints as Record<string, any>)) {\n\t\t\t\t\tconstraints.push({\n\t\t\t\t\t\tdomain,\n\t\t\t\t\t\tname,\n\t\t\t\t\t\tvalue: constraint.max || constraint.value,\n\t\t\t\t\t\tdescription: constraint.description || \"\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn constraints;\n\t} catch {\n\t\treturn [];\n\t}\n}\n\n/**\n * Generate next actions based on context\n */\nfunction generateNextActions(\n\trisk: RiskAssessment,\n\t_learnings: Array<{ type: string }>,\n\tstaticAnalysis?: StaticAnalysisOutput,\n): Array<{ tool: string; priority: number; reason: string }> {\n\tconst actions: Array<{ tool: string; priority: number; reason: string }> = [];\n\n\t// If skipped tests found, suggest enabling them first\n\tif (staticAnalysis?.skippedTests && staticAnalysis.skippedTests.length > 0) {\n\t\tactions.push({\n\t\t\ttool: \"enable_skipped_tests\",\n\t\t\tpriority: 1,\n\t\t\treason: `${staticAnalysis.skippedTests.length} skipped test(s) may be ready to enable`,\n\t\t});\n\t}\n\n\t// Always suggest quick_check after implementation\n\tactions.push({\n\t\ttool: \"quick_check\",\n\t\tpriority: 2,\n\t\treason: \"Validate changes after implementation\",\n\t});\n\n\t// If high risk, suggest frequent validation\n\tif (risk.overallRisk === \"high\") {\n\t\tactions.push({\n\t\t\ttool: \"what_changed\",\n\t\t\tpriority: 3,\n\t\t\treason: \"Track changes in high-risk area\",\n\t\t});\n\t}\n\n\t// Before commit\n\tactions.push({\n\t\ttool: \"review_work\",\n\t\tpriority: 4,\n\t\treason: \"Review before committing\",\n\t});\n\n\treturn actions;\n}\n\n/**\n * Run static analysis on planned files\n * Uses dynamic import to avoid build-time coupling with @snapback/core\n */\nasync function runStaticAnalysis(files: string[], workspaceRoot: string): Promise<StaticAnalysisOutput> {\n\tconst startTime = Date.now();\n\tconst result: StaticAnalysisOutput = {\n\t\tskippedTests: [],\n\t\tsuccess: true,\n\t\tduration: 0,\n\t\terrors: [],\n\t};\n\n\t// Only analyze test files\n\tconst testFiles = files.filter((f) => f.includes(\".test.\") || f.includes(\".spec.\") || f.includes(\"__tests__\"));\n\n\tif (testFiles.length === 0) {\n\t\tresult.duration = Date.now() - startTime;\n\t\treturn result;\n\t}\n\n\ttry {\n\t\t// Build file map with contents\n\t\tconst fileMap = new Map<string, string>();\n\t\tfor (const filePath of testFiles) {\n\t\t\tconst fullPath = filePath.startsWith(\"/\") ? filePath : join(workspaceRoot, filePath);\n\t\t\tif (existsSync(fullPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tconst content = readFileSync(fullPath, \"utf8\");\n\t\t\t\t\tfileMap.set(filePath, content);\n\t\t\t\t} catch {\n\t\t\t\t\t// Skip files that can't be read\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (fileMap.size === 0) {\n\t\t\tresult.duration = Date.now() - startTime;\n\t\t\treturn result;\n\t\t}\n\n\t\t// Dynamic import to avoid build-time coupling\n\t\tconst { analyzeSkippedTests } = await import(\"@snapback/core/analysis\");\n\t\tconst analysisResults = analyzeSkippedTests(fileMap);\n\n\t\tfor (const analysisResult of analysisResults) {\n\t\t\tif (!analysisResult.parsed && analysisResult.error) {\n\t\t\t\tresult.errors.push(`Parse error in ${analysisResult.file}: ${analysisResult.error}`);\n\t\t\t}\n\t\t\tfor (const skipped of analysisResult.skipped) {\n\t\t\t\tresult.skippedTests.push({\n\t\t\t\t\tfile: skipped.file,\n\t\t\t\t\ttype: skipped.type,\n\t\t\t\t\tname: skipped.name,\n\t\t\t\t\tline: skipped.line,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t} catch (error) {\n\t\t// Static analysis is optional - don't fail the task\n\t\tresult.errors.push(`Static analysis unavailable: ${error instanceof Error ? error.message : String(error)}`);\n\t}\n\n\tresult.duration = Date.now() - startTime;\n\tresult.success = result.errors.length === 0;\n\n\treturn result;\n}\n\n/**\n * Generate proactive guidance using AdvisoryEngine\n * Runs the SkippedTestRule and other advisory rules to provide suggestions\n */\nasync function generateProactiveGuidance(files: string[], workspaceRoot: string): Promise<ProactiveGuidance> {\n\tconst guidance: ProactiveGuidance = {\n\t\tsummary:\n\t\t\tfiles.length > 0 ? `Analyzing ${files.length} file${files.length > 1 ? \"s\" : \"\"}` : \"No files targeted\",\n\t\tsuggestions: [],\n\t};\n\n\ttry {\n\t\t// Use AdvisoryEngine from @snapback/intelligence\n\t\tconst { AdvisoryEngine, SkippedTestRule } = await import(\"@snapback/intelligence\");\n\n\t\tconst engine = new AdvisoryEngine();\n\t\t// Register SkippedTestRule for skipped test detection\n\t\tengine.registerRule(SkippedTestRule);\n\n\t\t// Build trigger context for advisory rules\n\t\t// Read test file contents for SkippedTestRule\n\t\tconst testFiles = files.filter((f) => f.includes(\".test.\") || f.includes(\".spec.\") || f.includes(\"__tests__\"));\n\n\t\tfor (const testFile of testFiles) {\n\t\t\tconst fullPath = testFile.startsWith(\"/\") ? testFile : join(workspaceRoot, testFile);\n\t\t\tif (existsSync(fullPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tconst code = readFileSync(fullPath, \"utf8\");\n\n\t\t\t\t\t// Create context with code for SkippedTestRule\n\t\t\t\t\tconst triggerContext = {\n\t\t\t\t\t\tfiles: [testFile],\n\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\triskLevel: \"low\" as const,\n\t\t\t\t\t\t\ttoolCallCount: 0,\n\t\t\t\t\t\t\tfilesModified: 0,\n\t\t\t\t\t\t\tloopsDetected: 0,\n\t\t\t\t\t\t\tconsecutiveFileModifications: new Map<string, number>(),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfragility: new Map<string, number>(),\n\t\t\t\t\t\trecentViolations: [] as Array<{ type: string; file: string }>,\n\t\t\t\t\t\tcode, // Extended property for SkippedTestRule\n\t\t\t\t\t};\n\n\t\t\t\t\tconst advisoryContext = engine.enrich(triggerContext);\n\n\t\t\t\t\t// Add suggestions from advisory context\n\t\t\t\t\tfor (const suggestion of advisoryContext.suggestions) {\n\t\t\t\t\t\tguidance.suggestions.push({\n\t\t\t\t\t\t\ttext: suggestion.text,\n\t\t\t\t\t\t\tpriority: suggestion.priority,\n\t\t\t\t\t\t\tconfidence: suggestion.confidence,\n\t\t\t\t\t\t\tcategory: suggestion.category,\n\t\t\t\t\t\t\tfiles: suggestion.files,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Skip files that can't be read\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Update summary if we have suggestions\n\t\tif (guidance.suggestions.length > 0) {\n\t\t\tconst skippedTestSuggestions = guidance.suggestions.filter((s) => s.category === \"testing\");\n\t\t\tif (skippedTestSuggestions.length > 0) {\n\t\t\t\tguidance.summary = `Found ${skippedTestSuggestions.length} testing suggestion(s)`;\n\t\t\t}\n\t\t}\n\n\t\t// Sort suggestions by priority (1 = highest)\n\t\tguidance.suggestions.sort((a, b) => a.priority - b.priority);\n\t} catch {\n\t\t// Advisory guidance is optional - continue without it\n\t\tguidance.summary = \"Advisory analysis unavailable\";\n\t}\n\n\treturn guidance;\n}\n\n// =============================================================================\n// COMPACT OUTPUT FORMATTER\n// =============================================================================\n\n/**\n * Format full output as compact result for token efficiency\n * Reduces ~5KB (~1300 tokens) to ~400B (~100 tokens)\n */\nfunction formatCompactResult(output: BeginTaskOutput, gitContext?: GitContext): BeginTaskCompactOutput {\n\t// Extract key constraints as simple strings\n\tconst constraintMap: Record<string, string> = {};\n\tfor (const c of output.constraints.slice(0, 4)) {\n\t\tconstraintMap[c.name] =\n\t\t\tString(c.value) + (c.name.includes(\"time\") ? \"ms\" : c.name.includes(\"bundle\") ? \"MB\" : \"\");\n\t}\n\n\t// Extract top 2 learnings as action strings only\n\tconst learningStrings = output.learnings.slice(0, 2).map((l) => l.action.substring(0, 100)); // Truncate long actions\n\n\t// Build warnings from various sources\n\tconst warnings: string[] = [];\n\tif (output.contextWarnings?.length) {\n\t\twarnings.push(output.contextWarnings[0].message);\n\t}\n\tif (output.proactive_guidance?.suggestions?.length) {\n\t\tconst topSuggestion = output.proactive_guidance.suggestions[0];\n\t\tif (topSuggestion.priority <= 2) {\n\t\t\twarnings.push(topSuggestion.text);\n\t\t}\n\t}\n\tif (output.staticAnalysis?.skippedTests?.length) {\n\t\twarnings.push(`${output.staticAnalysis.skippedTests.length} skipped test(s)`);\n\t}\n\n\t// Determine snapshot status\n\tlet snapshotStatus: \"created\" | \"reused\" | \"skipped\";\n\tif (output.snapshot.created) {\n\t\tsnapshotStatus = \"created\";\n\t} else if (output.snapshot.id) {\n\t\tsnapshotStatus = \"reused\";\n\t} else {\n\t\tsnapshotStatus = \"skipped\";\n\t}\n\n\treturn {\n\t\ttaskId: output.taskId,\n\t\trisk: output.riskAssessment.overallRisk,\n\t\tprotection: 100, // Default - would need vitals integration for real value\n\t\tdirtyFiles: gitContext?.uncommittedChanges?.length ?? 0,\n\t\tconstraints: constraintMap,\n\t\tlearnings: learningStrings,\n\t\twarnings: warnings.slice(0, 2), // Max 2 warnings\n\t\tsnapshot: snapshotStatus,\n\t};\n}\n\n/**\n * Format compact output as plain text for minimal token usage\n * Target: 3-4 lines of text\n */\nfunction formatCompactText(compact: BeginTaskCompactOutput): string {\n\tconst lines: string[] = [];\n\n\t// Line 1: Status summary\n\tconst snapshotIcon = compact.snapshot === \"created\" ? \"\" : compact.snapshot === \"reused\" ? \"\" : \"\";\n\tlines.push(\n\t\t` ${compact.taskId} | risk:${compact.risk} | protection:${compact.protection}% | dirty:${compact.dirtyFiles} | ${snapshotIcon} ${compact.snapshot}`,\n\t);\n\n\t// Line 2: Constraints (if any)\n\tif (Object.keys(compact.constraints).length > 0) {\n\t\tconst constraintStr = Object.entries(compact.constraints)\n\t\t\t.map(([k, v]) => `${k}<${v}`)\n\t\t\t.join(\", \");\n\t\tlines.push(`constraints: ${constraintStr}`);\n\t}\n\n\t// Line 3: Learnings (if any)\n\tif (compact.learnings.length > 0) {\n\t\tlines.push(`learnings: ${compact.learnings.join(\" | \")}`);\n\t}\n\n\t// Line 4: Warnings (only if present)\n\tif (compact.warnings.length > 0) {\n\t\tlines.push(` ${compact.warnings.join(\" | \")}`);\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n\n// =============================================================================\n// HANDLER\n// =============================================================================\n\n/**\n * Helper to create JSON result\n */\nfunction result(text: string, isError = false): ToolResult {\n\treturn {\n\t\tcontent: [{ type: \"text\", text }],\n\t\tisError,\n\t};\n}\n\n/**\n * begin_task - Start any development task\n *\n * Combines: get_context + snapshot_create + get_learnings + session.start\n *\n * DAEMON-FIRST ARCHITECTURE:\n * 1. Try to delegate to daemon for cross-surface coordination (Extension, MCP, CLI)\n * 2. If daemon unavailable, fall back to local Intelligence\n */\nexport const handleBeginTask: ToolHandler = async (args, context): Promise<ToolResult> => {\n\tconst input = args as Record<string, unknown>;\n\tconst task = input.task as string | undefined;\n\tconst files = input.files as string[] | undefined;\n\tconst providedKeywords = input.keywords as string[] | undefined;\n\tconst skipSnapshot = input.skipSnapshot as boolean | undefined;\n\tconst compact = input.compact !== false; // Default to true for token efficiency\n\tconst intent = (input.intent as TaskIntent | undefined) ?? inferIntent(task || \"\");\n\tconst intentHints = getIntentContextHints(intent);\n\n\tif (!task) {\n\t\treturn result(\n\t\t\tJSON.stringify({\n\t\t\t\terror: \"E102_MISSING_PARAM\",\n\t\t\t\tmessage: \"Required parameter 'task' is missing\",\n\t\t\t}),\n\t\t\ttrue,\n\t\t);\n\t}\n\n\tconst workspaceRoot = context.workspaceRoot;\n\n\t// 0. Check context staleness and auto-rebuild if needed\n\tconst contextWarnings = handleStaleContext(workspaceRoot);\n\n\t// 1. Extract keywords from task description if not provided\n\tconst keywords = providedKeywords ?? extractKeywords(task);\n\n\t// =========================================================================\n\t// DAEMON-FIRST: Try delegating to daemon for cross-surface coordination\n\t// =========================================================================\n\tconst daemonResult = await beginTaskViaDaemon(workspaceRoot, task, files, keywords);\n\n\tif (daemonResult) {\n\t\t// Daemon is available - use its response directly\n\t\t// This ensures Extension, MCP, and CLI all share the same session state\n\n\t\t// Still need to start local tracking for MCP-specific state\n\t\tstartTask(workspaceRoot, {\n\t\t\tdescription: task,\n\t\t\tplannedFiles: files || [],\n\t\t\tsnapshotId: daemonResult.snapshot.id,\n\t\t\tkeywords,\n\t\t});\n\n\t\t// Drain any pending observations from extension\n\t\tconst observations = drainPendingObservations(workspaceRoot).map((o) => ({\n\t\t\ttype: o.type,\n\t\t\tmessage: o.message,\n\t\t}));\n\n\t\t// Get local-only context enhancements (error cache, git context)\n\t\tlet lastKnownErrors: ErrorContext | undefined;\n\t\tif (files && files.length > 0) {\n\t\t\ttry {\n\t\t\t\tconst errorCacheService = createErrorCacheService(workspaceRoot);\n\t\t\t\tconst cachedErrors = errorCacheService.getErrorsForFiles(files);\n\t\t\t\tif (cachedErrors.length > 0) {\n\t\t\t\t\tlastKnownErrors = {\n\t\t\t\t\t\ttypescript: cachedErrors\n\t\t\t\t\t\t\t.filter((e) => e.source === \"typescript\")\n\t\t\t\t\t\t\t.map((e) => ({ ...e, age: e.age })),\n\t\t\t\t\t\ttests: cachedErrors.filter((e) => e.source === \"test\").map((e) => ({ ...e, age: e.age })),\n\t\t\t\t\t\tlintErrors: cachedErrors.filter((e) => e.source === \"lint\").map((e) => ({ ...e, age: e.age })),\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Error cache is optional\n\t\t\t}\n\t\t}\n\n\t\tlet gitContext: GitContext | undefined;\n\t\ttry {\n\t\t\tconst gitContextService = createGitContextService(workspaceRoot);\n\t\t\tgitContext = await gitContextService.getContext(files || []);\n\t\t\tif (\n\t\t\t\t!gitContext.branch.current &&\n\t\t\t\tgitContext.uncommittedChanges.length === 0 &&\n\t\t\t\tgitContext.recentCommits.length === 0\n\t\t\t) {\n\t\t\t\tgitContext = undefined;\n\t\t\t}\n\t\t} catch {\n\t\t\t// Git context is optional\n\t\t}\n\n\t\t// Run static analysis for planned files (skipped test detection)\n\t\t// NOTE: Daemon doesn't provide this, so we run it locally\n\t\tlet staticAnalysis: StaticAnalysisOutput | undefined;\n\t\tif (files && files.length > 0) {\n\t\t\tstaticAnalysis = await runStaticAnalysis(files, workspaceRoot);\n\t\t}\n\n\t\t// Get dependency context for planned files (P1 context enhancement)\n\t\t// NOTE: Daemon doesn't provide this, so we run it locally\n\t\tlet dependencyContext: DependencyContext | undefined;\n\t\tif (files && files.length > 0) {\n\t\t\ttry {\n\t\t\t\tconst depGraphService = getDependencyGraphService(workspaceRoot);\n\t\t\t\tdependencyContext = await depGraphService.getContextForFiles(files);\n\t\t\t\tif (\n\t\t\t\t\tObject.keys(dependencyContext.planned).length === 0 &&\n\t\t\t\t\tdependencyContext.circular.length === 0 &&\n\t\t\t\t\tdependencyContext.suggestions.length === 0\n\t\t\t\t) {\n\t\t\t\t\tdependencyContext = undefined;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Dependency graph is optional - madge might not be available\n\t\t\t}\n\t\t}\n\n\t\t// Get test coverage context for planned files (P1 context enhancement)\n\t\t// NOTE: Daemon doesn't provide this, so we run it locally\n\t\tlet testCoverage: TestCoverageContext | undefined;\n\t\tif (files && files.length > 0) {\n\t\t\ttry {\n\t\t\t\tconst coverageService = getTestCoverageService(workspaceRoot);\n\t\t\t\ttestCoverage = coverageService.getContextForFiles(files);\n\t\t\t\tif (testCoverage.summary.filesWithTests === 0 && testCoverage.summary.averageCoverage === 0) {\n\t\t\t\t\ttestCoverage = undefined;\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Coverage context is optional\n\t\t\t}\n\t\t}\n\n\t\t// Generate proactive guidance from AdvisoryEngine\n\t\t// NOTE: Daemon doesn't provide this, so we run it locally\n\t\tconst proactive_guidance = await generateProactiveGuidance(files || [], workspaceRoot);\n\n\t\t// Build enhanced output with daemon data + local context\n\t\tconst output: BeginTaskOutput = {\n\t\t\ttaskId: daemonResult.taskId,\n\t\t\tintent,\n\t\t\tintentHints,\n\t\t\tsnapshot: daemonResult.snapshot,\n\t\t\tpatterns: daemonResult.patterns as BeginTaskOutput[\"patterns\"],\n\t\t\tconstraints: daemonResult.constraints as BeginTaskOutput[\"constraints\"],\n\t\t\tlearnings: daemonResult.learnings as BeginTaskOutput[\"learnings\"],\n\t\t\tobservations,\n\t\t\triskAssessment: daemonResult.riskAssessment as BeginTaskOutput[\"riskAssessment\"],\n\t\t\tnextActions: daemonResult.nextActions as BeginTaskOutput[\"nextActions\"],\n\t\t\tstaticAnalysis,\n\t\t\tlastKnownErrors,\n\t\t\tgitContext,\n\t\t\tdependencyContext,\n\t\t\ttestCoverage,\n\t\t\tproactive_guidance,\n\t\t\tcontextWarnings: contextWarnings.length > 0 ? contextWarnings : undefined,\n\t\t};\n\n\t\t// Return compact or full output based on flag\n\t\tif (compact) {\n\t\t\tconst compactOutput = formatCompactResult(output, gitContext);\n\t\t\treturn result(formatCompactText(compactOutput));\n\t\t}\n\n\t\tconst hint = daemonResult.snapshot.created\n\t\t\t? `Safety snapshot created via daemon: ${daemonResult.snapshot.id}`\n\t\t\t: daemonResult.learnings.length > 0\n\t\t\t\t? `${daemonResult.learnings.length} relevant learning(s) found`\n\t\t\t\t: \"Ready to start coding! (daemon-coordinated)\";\n\n\t\treturn result(\n\t\t\tJSON.stringify(\n\t\t\t\t{\n\t\t\t\t\t...output,\n\t\t\t\t\tmessage: `Task started: ${task}`,\n\t\t\t\t\t_hint: hint,\n\t\t\t\t\t_source: \"daemon\", // Indicate response came from daemon\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\t2,\n\t\t\t),\n\t\t);\n\t}\n\n\t// =========================================================================\n\t// FALLBACK: Daemon unavailable, use local Intelligence\n\t// =========================================================================\n\n\t// 2. Assess risk of planned files\n\tconst riskAssessment = files\n\t\t? assessRisk(files, workspaceRoot)\n\t\t: {\n\t\t\t\toverallRisk: \"low\" as const,\n\t\t\t\triskAreas: [] as RiskArea[],\n\t\t\t\trecommendations: [],\n\t\t\t};\n\n\t// 3. Auto-decide snapshot creation using SnapshotService\n\tlet snapshot: BeginTaskOutput[\"snapshot\"] = { created: false };\n\n\tif (!skipSnapshot && shouldAutoSnapshot(riskAssessment, files) && files && files.length > 0) {\n\t\tconst snapshotService = createSnapshotService(workspaceRoot);\n\t\tconst snapshotResult = await snapshotService.createFromFiles(files, {\n\t\t\tdescription: `Pre-task: ${task}`,\n\t\t\ttrigger: \"ai-detection\",\n\t\t\tskipDedup: false,\n\t\t\tdedupWindow: 5,\n\t\t});\n\n\t\tif (snapshotResult.success) {\n\t\t\tif (snapshotResult.reused) {\n\t\t\t\t// Reusing existing snapshot\n\t\t\t\tsnapshot = {\n\t\t\t\t\tcreated: false,\n\t\t\t\t\tid: snapshotResult.reusedSnapshotId,\n\t\t\t\t\treason: snapshotResult.reusedReason,\n\t\t\t\t};\n\t\t\t} else if (snapshotResult.snapshot) {\n\t\t\t\t// New snapshot created\n\t\t\t\tsnapshot = {\n\t\t\t\t\tcreated: true,\n\t\t\t\t\tid: snapshotResult.snapshot.id,\n\t\t\t\t\treason: `Auto-created: ${riskAssessment.overallRisk} risk task touching ${riskAssessment.riskAreas.join(\", \") || \"planned files\"}`,\n\t\t\t\t};\n\n\t\t\t\t// Update session stats\n\t\t\t\tconst state = getSessionState(workspaceRoot);\n\t\t\t\tstate.stats.snapshotsCreated++;\n\t\t\t}\n\t\t} else {\n\t\t\t// Snapshot creation failed\n\t\t\tsnapshot = {\n\t\t\t\tcreated: false,\n\t\t\t\treason: `Snapshot creation failed: ${snapshotResult.error}`,\n\t\t\t};\n\t\t}\n\t}\n\n\t// 4. Get relevant learnings using tiered storage (P0 token efficiency)\n\t// Loads hot tier (always) + warm tier (based on intent) - never auto-loads cold tier\n\tconst tieredLearningService = new TieredLearningService(workspaceRoot);\n\tconst tieredLearnings = await tieredLearningService.loadTieredLearnings({\n\t\tintent,\n\t\tkeywords,\n\t\tmaxLearnings: 10,\n\t});\n\n\t// Track learning access for hot tier auto-promotion\n\tconst learningIds = tieredLearnings.map((l) => l.id).filter((id): id is string => !!id);\n\tif (learningIds.length > 0) {\n\t\ttieredLearningService.trackAccess(learningIds);\n\t}\n\n\t// Group learning IDs by type for feedback attribution at task end\n\t// This enables survey data (patterns_used, pitfalls_avoided) to trigger trackApplied()\n\tconst shownLearnings = {\n\t\tpatterns: tieredLearnings.filter((l) => l.type === \"pattern\" && l.id).map((l) => l.id as string),\n\t\tpitfalls: tieredLearnings.filter((l) => l.type === \"pitfall\" && l.id).map((l) => l.id as string),\n\t\tother: tieredLearnings\n\t\t\t.filter((l) => l.id && ![\"pattern\", \"pitfall\"].includes(l.type))\n\t\t\t.map((l) => l.id as string),\n\t};\n\n\tconst learnings = tieredLearnings.map((l) => ({\n\t\ttype: l.type,\n\t\ttrigger: Array.isArray(l.trigger) ? l.trigger.join(\", \") : l.trigger,\n\t\taction: l.action,\n\t\tsource: l.source,\n\t\trelevanceScore: l.score / (keywords.length || 1),\n\t}));\n\n\t// 4b. Enhance with adaptive hybrid retrieval (semantic + keyword fusion)\n\t// Uses query classification to optimize RRF weights for better recall\n\tlet hybridRetrievalStats:\n\t\t| {\n\t\t\t\tqueryType: string;\n\t\t\t\tsemanticWeight: number;\n\t\t\t\tkeywordWeight: number;\n\t\t\t\tresultsFound: number;\n\t\t\t\tlatencyMs: number;\n\t\t  }\n\t\t| undefined;\n\ttry {\n\t\t// Build a search query from task + keywords\n\t\tconst searchQuery = [task, ...keywords].join(\" \");\n\t\tconst classification = classifyQueryType(searchQuery);\n\n\t\t// Only run hybrid retrieval if we have a knowledge store with data\n\t\tconst hybridResult = await retrieveAdaptive(workspaceRoot, searchQuery);\n\n\t\tif (hybridResult.results.length > 0) {\n\t\t\t// Merge hybrid results with tiered learnings (deduplicate by content)\n\t\t\tconst existingTriggers = new Set(learnings.map((l) => l.trigger));\n\n\t\t\tfor (const result of hybridResult.results.slice(0, 5)) {\n\t\t\t\tconst chunkText = result.chunk.chunk_text;\n\t\t\t\tif (!existingTriggers.has(chunkText)) {\n\t\t\t\t\t// Map source_type to learning type string\n\t\t\t\t\tconst sourceType = result.chunk.source_type;\n\t\t\t\t\tconst learningType =\n\t\t\t\t\t\tsourceType === \"pattern\"\n\t\t\t\t\t\t\t? \"pattern\"\n\t\t\t\t\t\t\t: sourceType === \"violation\"\n\t\t\t\t\t\t\t\t? \"pitfall\"\n\t\t\t\t\t\t\t\t: sourceType === \"adr\"\n\t\t\t\t\t\t\t\t\t? \"architecture\"\n\t\t\t\t\t\t\t\t\t: \"discovery\"; // Default to discovery for unknown types\n\n\t\t\t\t\tlearnings.push({\n\t\t\t\t\t\ttype: learningType,\n\t\t\t\t\t\ttrigger: chunkText,\n\t\t\t\t\t\taction: result.chunk.context_text || chunkText,\n\t\t\t\t\t\tsource: \"hybrid-retrieval\",\n\t\t\t\t\t\trelevanceScore: result.confidence,\n\t\t\t\t\t});\n\t\t\t\t\texistingTriggers.add(chunkText);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\thybridRetrievalStats = {\n\t\t\t\tqueryType: classification.type,\n\t\t\t\tsemanticWeight: classification.weights.semantic,\n\t\t\t\tkeywordWeight: classification.weights.keyword,\n\t\t\t\tresultsFound: hybridResult.results.length,\n\t\t\t\tlatencyMs: hybridResult.stats.latencyMs,\n\t\t\t};\n\n\t\t\t// Log hybrid retrieval stats for debugging/monitoring\n\t\t\tconsole.log(\n\t\t\t\t`[Hybrid Retrieval] ${hybridRetrievalStats.queryType} query: ` +\n\t\t\t\t\t`${hybridRetrievalStats.resultsFound} results in ${hybridRetrievalStats.latencyMs.toFixed(1)}ms ` +\n\t\t\t\t\t`(sem=${hybridRetrievalStats.semanticWeight}, kw=${hybridRetrievalStats.keywordWeight})`,\n\t\t\t);\n\t\t}\n\t} catch {\n\t\t// Hybrid retrieval is optional - continue without it if knowledge store not available\n\t}\n\n\t// 5. Get patterns from Intelligence (if available)\n\tlet patterns: BeginTaskOutput[\"patterns\"] = [];\n\ttry {\n\t\tconst intel = getIntelligence(workspaceRoot);\n\t\tconst contextResult = await intel.getContext({ task, keywords });\n\n\t\t// Extract patterns from context\n\t\tif (contextResult.patterns) {\n\t\t\tconst patternLines = contextResult.patterns.split(\"\\n\").filter(Boolean);\n\t\t\tpatterns = patternLines.slice(0, 5).map((line) => ({\n\t\t\t\tname: line.substring(0, 50),\n\t\t\t\tdescription: line,\n\t\t\t}));\n\t\t}\n\t} catch {\n\t\t// Intelligence not available - continue without patterns\n\t}\n\n\t// 6. Get constraints\n\tconst constraints = getConstraints(workspaceRoot);\n\n\t// 7. Run static analysis on planned files (skipped tests, etc.)\n\tlet staticAnalysis: StaticAnalysisOutput | undefined;\n\tif (files && files.length > 0) {\n\t\tstaticAnalysis = await runStaticAnalysis(files, workspaceRoot);\n\t}\n\n\t// 8. Get error context for planned files (P0 context enhancement)\n\tlet lastKnownErrors: ErrorContext | undefined;\n\tif (files && files.length > 0) {\n\t\ttry {\n\t\t\tconst errorCacheService = createErrorCacheService(workspaceRoot);\n\t\t\tconst cachedErrors = errorCacheService.getErrorsForFiles(files);\n\n\t\t\tif (cachedErrors.length > 0) {\n\t\t\t\t// Group errors by source type\n\t\t\t\tlastKnownErrors = {\n\t\t\t\t\ttypescript: cachedErrors\n\t\t\t\t\t\t.filter((e) => e.source === \"typescript\")\n\t\t\t\t\t\t.map((e) => ({ ...e, age: e.age })),\n\t\t\t\t\ttests: cachedErrors.filter((e) => e.source === \"test\").map((e) => ({ ...e, age: e.age })),\n\t\t\t\t\tlintErrors: cachedErrors.filter((e) => e.source === \"lint\").map((e) => ({ ...e, age: e.age })),\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\t// Error cache is optional - continue without it\n\t\t}\n\t}\n\n\t// 9. Get git context for planned files (P0 context enhancement)\n\tlet gitContext: GitContext | undefined;\n\ttry {\n\t\tconst gitContextService = createGitContextService(workspaceRoot);\n\t\tgitContext = await gitContextService.getContext(files || []);\n\n\t\t// Only include if there's meaningful content\n\t\tif (\n\t\t\t!gitContext.branch.current &&\n\t\t\tgitContext.uncommittedChanges.length === 0 &&\n\t\t\tgitContext.recentCommits.length === 0\n\t\t) {\n\t\t\tgitContext = undefined;\n\t\t}\n\t} catch {\n\t\t// Git context is optional - continue without it\n\t}\n\n\t// 9b. Get dependency context for planned files (P1 context enhancement)\n\t// Provides import/export relationships and circular dependency detection\n\tlet dependencyContext: DependencyContext | undefined;\n\tif (files && files.length > 0) {\n\t\ttry {\n\t\t\tconst depGraphService = getDependencyGraphService(workspaceRoot);\n\t\t\tdependencyContext = await depGraphService.getContextForFiles(files);\n\n\t\t\t// Only include if there's meaningful content\n\t\t\tif (\n\t\t\t\tObject.keys(dependencyContext.planned).length === 0 &&\n\t\t\t\tdependencyContext.circular.length === 0 &&\n\t\t\t\tdependencyContext.suggestions.length === 0\n\t\t\t) {\n\t\t\t\tdependencyContext = undefined;\n\t\t\t}\n\t\t} catch {\n\t\t\t// Dependency graph is optional - madge might not be available\n\t\t}\n\t}\n\n\t// 9c. Get test coverage context for planned files (P1 context enhancement)\n\t// Provides coverage info and test file mappings\n\tlet testCoverage: TestCoverageContext | undefined;\n\tif (files && files.length > 0) {\n\t\ttry {\n\t\t\tconst coverageService = getTestCoverageService(workspaceRoot);\n\t\t\ttestCoverage = coverageService.getContextForFiles(files);\n\n\t\t\t// Only include if there's meaningful content\n\t\t\tif (testCoverage.summary.filesWithTests === 0 && testCoverage.summary.averageCoverage === 0) {\n\t\t\t\ttestCoverage = undefined;\n\t\t\t}\n\t\t} catch {\n\t\t\t// Coverage context is optional\n\t\t}\n\t}\n\n\t// 10. Drain pending observations from extension\n\tconst observations = drainPendingObservations(workspaceRoot).map((o) => ({\n\t\ttype: o.type,\n\t\tmessage: o.message,\n\t}));\n\n\t// 11. Start task tracking (including intent for completion hints)\n\t// shownLearnings enables feedback attribution: survey data  trackApplied()\n\tconst currentTask = startTask(workspaceRoot, {\n\t\tdescription: task,\n\t\tplannedFiles: files || [],\n\t\tsnapshotId: snapshot.id,\n\t\tkeywords,\n\t\tintent,\n\t\tshownLearnings,\n\t});\n\n\t// Update risk areas touched\n\tconst state = getSessionState(workspaceRoot);\n\tstate.riskAreasTouched = riskAssessment.riskAreas;\n\n\t// 11b. Start Intelligence session with same task ID for cross-surface coordination\n\t// This enables Extension, MCP, and CLI to share file modification tracking\n\ttry {\n\t\tconst intel = getIntelligence(workspaceRoot);\n\t\tintel.startSession(currentTask.id, {\n\t\t\tworkspaceId: workspaceRoot,\n\t\t\ttags: keywords,\n\t\t});\n\t} catch {\n\t\t// Intelligence session start is best-effort, don't fail the task\n\t}\n\n\t// 12. Generate next actions (informed by static analysis and errors)\n\tconst nextActions = generateNextActions(riskAssessment, learnings, staticAnalysis);\n\n\t// 12b. Generate proactive guidance from AdvisoryEngine\n\tconst proactive_guidance = await generateProactiveGuidance(files || [], workspaceRoot);\n\n\t// 13. Build response with enhanced context\n\tconst output: BeginTaskOutput = {\n\t\ttaskId: currentTask.id,\n\t\tintent,\n\t\tintentHints,\n\t\tsnapshot,\n\t\tpatterns,\n\t\tconstraints,\n\t\tlearnings,\n\t\tobservations,\n\t\triskAssessment,\n\t\tnextActions,\n\t\tstaticAnalysis,\n\t\tlastKnownErrors,\n\t\tgitContext,\n\t\tdependencyContext,\n\t\ttestCoverage,\n\t\tproactive_guidance,\n\t\tcontextWarnings: contextWarnings.length > 0 ? contextWarnings : undefined,\n\t};\n\n\t// Return compact or full output based on flag\n\tif (compact) {\n\t\tconst compactOutput = formatCompactResult(output, gitContext);\n\t\treturn result(formatCompactText(compactOutput));\n\t}\n\n\t// Generate hint based on most useful information (full output only)\n\tconst skippedCount = staticAnalysis?.skippedTests?.length ?? 0;\n\tconst knownErrorCount =\n\t\t(lastKnownErrors?.typescript?.length ?? 0) +\n\t\t(lastKnownErrors?.tests?.length ?? 0) +\n\t\t(lastKnownErrors?.lintErrors?.length ?? 0);\n\tconst uncommittedCount = gitContext?.uncommittedChanges?.length ?? 0;\n\n\tlet hint: string;\n\tif (contextWarnings.length > 0) {\n\t\tconst rebuiltWarning = contextWarnings.find((w) => w.type === \"context_rebuilt\");\n\t\tif (rebuiltWarning) {\n\t\t\thint = ` Context was stale and auto-rebuilt (${rebuiltWarning.daysSinceScanned} days old)`;\n\t\t} else {\n\t\t\thint = ` Context is stale - consider running 'context op=scan'`;\n\t\t}\n\t} else if (knownErrorCount > 0) {\n\t\thint = ` ${knownErrorCount} known error(s) in planned files - check lastKnownErrors`;\n\t} else if (skippedCount > 0) {\n\t\thint = ` ${skippedCount} skipped test(s) found - may need enabling`;\n\t} else if (uncommittedCount > 0) {\n\t\thint = ` ${uncommittedCount} uncommitted change(s) in working tree`;\n\t} else if (snapshot.created) {\n\t\thint = `Safety snapshot created: ${snapshot.id}`;\n\t} else if (learnings.length > 0) {\n\t\thint = `${learnings.length} relevant learning(s) found`;\n\t} else {\n\t\thint = \"Ready to start coding!\";\n\t}\n\n\treturn result(\n\t\tJSON.stringify(\n\t\t\t{\n\t\t\t\t...output,\n\t\t\t\tmessage: `Task started: ${task}`,\n\t\t\t\t_hint: hint,\n\t\t\t},\n\t\t\tnull,\n\t\t\t2,\n\t\t),\n\t);\n};\n","/**\n * Composite Tool: complete_task\n *\n * Gracefully ends the current task with:\n * - Session summary\n * - Learning capture prompts\n * - Optional snapshot creation\n * - Statistics update\n *\n * @see pair_programmer.md Section 2.5\n * @module facades/complete-task\n */\n\nimport { appendFileSync, existsSync, mkdirSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport type { PerceivedHelp } from \"@snapback/contracts\";\nimport { endTaskViaDaemon } from \"../daemon/client-facade.js\";\nimport type { ToolHandler, ToolResult } from \"../registry.js\";\nimport { createSnapshotService } from \"../services/snapshot-service.js\";\nimport { endTask, formatDuration, getCurrentTask, getSessionState, type TaskIntent } from \"../session/state.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Behavior change tracking for accountability\n * Tracks whether user would have behaved differently without SnapBack\n */\ninterface AccountabilityBehavior {\n\t/** Would the user have behaved differently without SnapBack watching? */\n\tbehaved_differently: boolean;\n\t/** How did they behave differently? e.g., \"Fixed skipped tests instead of leaving them\" */\n\thow?: string;\n\t/** What triggered the behavior change? e.g., \"begin_task showed 2 skipped tests\" */\n\ttriggered_by?: string;\n\t/** Effort change compared to without SnapBack */\n\teffort_change?: \"more\" | \"same\" | \"less\";\n}\n\n/**\n * Reflection input for accountability tracking\n * Extended with behavior tracking per Session Feedback spec\n */\ninterface ReflectionInput {\n\t/** User's perception of how much SnapBack helped */\n\tperceived_help: PerceivedHelp;\n\t/** Accountability behavior tracking */\n\taccountability?: AccountabilityBehavior;\n}\n\n/**\n * Behavior change type classification\n */\ntype BehaviorChangeType =\n\t| \"worked_harder\"\n\t| \"fixed_vs_skipped\"\n\t| \"tested_more\"\n\t| \"documented_more\"\n\t| \"safer_approach\"\n\t| \"other\";\n\n/**\n * SnapBack feature that triggered accountability\n */\ntype SnapBackFeature =\n\t| \"begin_task_context\"\n\t| \"learn_system\"\n\t| \"checkpoint_visibility\"\n\t| \"review_work\"\n\t| \"complete_task_reflection\"\n\t| \"general_awareness\";\n\n/**\n * Accountability effect output matching the schema from @snapback/contracts\n * Extended with behavior tracking per Session Feedback spec\n */\ninterface AccountabilityEffectOutput {\n\t/** Session identifier */\n\tsession_id: string;\n\t/** Session duration in milliseconds */\n\tsession_duration_ms: number;\n\t/** User's perception of how much SnapBack helped */\n\tperceived_help: \"significantly\" | \"somewhat\" | \"not_really\" | \"blocked\";\n\t/** Actual changes made during the session */\n\tactual_changes: {\n\t\tfiles_modified: number;\n\t\tlines_added: number;\n\t\tlines_removed: number;\n\t\tsnapshots_used: number;\n\t};\n\t/** Issues prevented by SnapBack */\n\tprevented_issues: {\n\t\trollbacks_avoided: number;\n\t\tpattern_violations_caught: number;\n\t\tskipped_tests_flagged: number;\n\t};\n\t/** User's subscription tier */\n\ttier: string;\n\t/** Accountability behavior tracking (new in Session Feedback spec) */\n\taccountability_behavior?: {\n\t\t/** Did user behave differently because of SnapBack? */\n\t\twould_have_behaved_differently: boolean;\n\t\t/** Type of behavior change */\n\t\tbehavior_change_type?: BehaviorChangeType;\n\t\t/** What triggered the accountability */\n\t\twhat_triggered_accountability?: string;\n\t\t/** Effort change */\n\t\teffort_delta?: \"significantly_more\" | \"somewhat_more\" | \"same\" | \"less\";\n\t\t/** Which SnapBack feature was responsible */\n\t\tsnapback_feature_responsible?: SnapBackFeature;\n\t\t/** Did the outcome improve because of accountability? */\n\t\toutcome_improved?: boolean;\n\t};\n}\n\ninterface CompleteTaskInput {\n\t/** Outcome of the task */\n\toutcome?: \"completed\" | \"abandoned\" | \"blocked\";\n\t/** Create final snapshot (default: true for completed tasks) */\n\tcreateSnapshot?: boolean;\n\t/** Learnings to capture (indices from pending suggestions) */\n\tacceptLearnings?: number[];\n\t/** Custom learning to add */\n\tcustomLearning?: {\n\t\ttype: \"pattern\" | \"pitfall\" | \"efficiency\" | \"discovery\" | \"workflow\";\n\t\ttrigger: string;\n\t\taction: string;\n\t};\n\t/** Notes about the task completion */\n\tnotes?: string;\n\t/** Reflection for accountability tracking */\n\treflection?: ReflectionInput;\n}\n\ninterface CompleteTaskOutput {\n\ttaskId: string;\n\ttaskDescription: string;\n\toutcome: \"completed\" | \"abandoned\" | \"blocked\";\n\tduration: string;\n\tsummary: {\n\t\tfilesChanged: number;\n\t\tlinesChanged: number;\n\t\tsnapshotsCreated: number;\n\t\triskAreasTouched: string[];\n\t};\n\tlearningsCaptured: number;\n\tfinalSnapshot?: {\n\t\tid: string;\n\t\tfileCount: number;\n\t};\n\tsessionStats: {\n\t\ttasksCompleted: number;\n\t\ttotalSnapshots: number;\n\t\ttotalLearnings: number;\n\t};\n\tnextActions: Array<{\n\t\ttool: string;\n\t\tpriority: number;\n\t\treason: string;\n\t}>;\n\t/** Accountability effect when reflection is provided */\n\taccountability_effect?: AccountabilityEffectOutput;\n\t/** Warnings about issues that occurred during completion */\n\t_warnings?: string[];\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Result of attempting to append a learning\n */\ninterface AppendLearningResult {\n\tsuccess: boolean;\n\terror?: string;\n}\n\n/**\n * Append learning to JSONL file\n * Returns success/error instead of silently swallowing errors\n */\nfunction appendLearning(\n\tworkspaceRoot: string,\n\tlearning: { type: string; trigger: string; action: string; source?: string },\n): AppendLearningResult {\n\tconst learningsDir = join(workspaceRoot, \".snapback\", \"learnings\");\n\tconst learningsPath = join(learningsDir, \"learnings.jsonl\");\n\n\ttry {\n\t\tif (!existsSync(learningsDir)) {\n\t\t\tmkdirSync(learningsDir, { recursive: true });\n\t\t}\n\n\t\tconst entry = {\n\t\t\t...learning,\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\tsource: learning.source || \"task_completion\",\n\t\t};\n\n\t\tappendFileSync(learningsPath, JSON.stringify(entry) + \"\\n\", \"utf8\");\n\t\treturn { success: true };\n\t} catch (error) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\terror: error instanceof Error ? error.message : \"Unknown write error\",\n\t\t};\n\t}\n}\n\n/**\n * Infer behavior change type from description\n */\nfunction inferBehaviorType(how: string): BehaviorChangeType {\n\tconst lowered = how.toLowerCase();\n\tif (lowered.includes(\"fix\") && lowered.includes(\"skip\")) return \"fixed_vs_skipped\";\n\tif (lowered.includes(\"test\")) return \"tested_more\";\n\tif (lowered.includes(\"doc\") || lowered.includes(\"comment\")) return \"documented_more\";\n\tif (lowered.includes(\"safe\") || lowered.includes(\"careful\")) return \"safer_approach\";\n\tif (lowered.includes(\"thorough\") || lowered.includes(\"harder\")) return \"worked_harder\";\n\treturn \"other\";\n}\n\n/**\n * Map effort change to output format\n */\nfunction mapEffortDelta(change?: \"more\" | \"same\" | \"less\"): \"significantly_more\" | \"somewhat_more\" | \"same\" | \"less\" {\n\tswitch (change) {\n\t\tcase \"more\":\n\t\t\treturn \"somewhat_more\";\n\t\tcase \"less\":\n\t\t\treturn \"less\";\n\t\tdefault:\n\t\t\treturn \"same\";\n\t}\n}\n\n/**\n * Infer which SnapBack feature triggered accountability\n */\nfunction inferFeature(trigger?: string): SnapBackFeature {\n\tif (!trigger) return \"general_awareness\";\n\tconst lowered = trigger.toLowerCase();\n\tif (lowered.includes(\"begin_task\")) return \"begin_task_context\";\n\tif (lowered.includes(\"learn\")) return \"learn_system\";\n\tif (lowered.includes(\"checkpoint\") || lowered.includes(\"snapshot\")) return \"checkpoint_visibility\";\n\tif (lowered.includes(\"review\")) return \"review_work\";\n\tif (lowered.includes(\"complete\")) return \"complete_task_reflection\";\n\treturn \"general_awareness\";\n}\n\n/**\n * Build accountability effect from reflection and session data\n * Extended with behavior tracking per Session Feedback spec\n */\nfunction buildAccountabilityEffect(\n\treflection: ReflectionInput,\n\ttaskId: string,\n\tdurationMs: number,\n\tfilesChanged: number,\n\tlinesChanged: number,\n\tsnapshotsCreated: number,\n\ttier: string,\n\toutcome: \"completed\" | \"abandoned\" | \"blocked\",\n): AccountabilityEffectOutput {\n\t// Validate perceived_help is a valid value\n\tconst validValues = [\"significantly\", \"somewhat\", \"not_really\", \"blocked\"] as const;\n\tconst perceived_help = validValues.includes(reflection.perceived_help as unknown as (typeof validValues)[number])\n\t\t? reflection.perceived_help\n\t\t: \"somewhat\"; // Fallback for invalid values\n\n\t// Build base accountability output\n\tconst result: AccountabilityEffectOutput = {\n\t\tsession_id: taskId,\n\t\tsession_duration_ms: durationMs,\n\t\tperceived_help,\n\t\tactual_changes: {\n\t\t\tfiles_modified: filesChanged,\n\t\t\tlines_added: Math.max(0, Math.floor(linesChanged * 0.7)), // Estimate: 70% adds\n\t\t\tlines_removed: Math.max(0, Math.floor(linesChanged * 0.3)), // Estimate: 30% removes\n\t\t\tsnapshots_used: snapshotsCreated,\n\t\t},\n\t\tprevented_issues: {\n\t\t\t// These would ideally come from session tracking\n\t\t\t// For now, we provide reasonable defaults based on session activity\n\t\t\trollbacks_avoided: snapshotsCreated > 0 ? 1 : 0,\n\t\t\tpattern_violations_caught: 0, // Would need check_patterns tracking\n\t\t\tskipped_tests_flagged: 0, // Would need staticAnalysis tracking\n\t\t},\n\t\ttier,\n\t};\n\n\t// Add accountability behavior tracking if provided\n\tif (reflection.accountability !== undefined) {\n\t\tif (reflection.accountability.behaved_differently) {\n\t\t\tresult.accountability_behavior = {\n\t\t\t\twould_have_behaved_differently: true,\n\t\t\t\tbehavior_change_type: reflection.accountability.how\n\t\t\t\t\t? inferBehaviorType(reflection.accountability.how)\n\t\t\t\t\t: \"other\",\n\t\t\t\twhat_triggered_accountability: reflection.accountability.triggered_by,\n\t\t\t\teffort_delta: mapEffortDelta(reflection.accountability.effort_change),\n\t\t\t\tsnapback_feature_responsible: inferFeature(reflection.accountability.triggered_by),\n\t\t\t\toutcome_improved: outcome === \"completed\",\n\t\t\t};\n\t\t} else {\n\t\t\t// Track when user explicitly says they didn't behave differently\n\t\t\tresult.accountability_behavior = {\n\t\t\t\twould_have_behaved_differently: false,\n\t\t\t};\n\t\t}\n\t}\n\n\treturn result;\n}\n\n// =============================================================================\n// INTENT-AWARE COMPLETION\n// =============================================================================\n\n/**\n * Intent-specific completion hints\n * Provides tailored feedback based on what the user was trying to accomplish\n */\nconst INTENT_COMPLETION_HINTS: Record<TaskIntent, { completed: string; abandoned: string; blocked: string }> = {\n\timplement: {\n\t\tcompleted: \"Feature implemented. Consider running tests to verify.\",\n\t\tabandoned: \"Implementation paused. Snapshot preserved for resumption.\",\n\t\tblocked: \"Blocked on implementation. Check learnings for similar issues.\",\n\t},\n\tdebug: {\n\t\tcompleted: \"Bug fixed! Consider recording the fix as a learning.\",\n\t\tabandoned: \"Debug session paused. Current state preserved.\",\n\t\tblocked: \"Still debugging. Try get_learnings for similar issues.\",\n\t},\n\trefactor: {\n\t\tcompleted: \"Refactoring complete. Run tests to ensure no regressions.\",\n\t\tabandoned: \"Refactor paused. Partial changes preserved in snapshot.\",\n\t\tblocked: \"Blocked on refactor. Consider smaller incremental changes.\",\n\t},\n\treview: {\n\t\tcompleted: \"Review complete. Consider recording any patterns discovered.\",\n\t\tabandoned: \"Review paused. Notes preserved.\",\n\t\tblocked: \"Review blocked. May need additional context or access.\",\n\t},\n\texplore: {\n\t\tcompleted: \"Exploration complete. Consider recording discoveries as learnings.\",\n\t\tabandoned: \"Exploration paused. Findings preserved.\",\n\t\tblocked: \"Exploration blocked. Try a different approach.\",\n\t},\n};\n\n/**\n * Get intent-specific completion hint\n */\nfunction getIntentHint(\n\tintent: TaskIntent | undefined,\n\toutcome: \"completed\" | \"abandoned\" | \"blocked\",\n): string | undefined {\n\tif (!intent) return undefined;\n\treturn INTENT_COMPLETION_HINTS[intent]?.[outcome];\n}\n\n// =============================================================================\n// HANDLER\n// =============================================================================\n\nfunction result(text: string, isError = false): ToolResult {\n\treturn {\n\t\tcontent: [{ type: \"text\", text }],\n\t\tisError,\n\t};\n}\n\n/**\n * complete_task - Gracefully end the current task\n *\n * DAEMON-FIRST ARCHITECTURE:\n * 1. Try to end task via daemon for cross-surface coordination\n * 2. If daemon unavailable, use local state\n */\nexport const handleCompleteTask: ToolHandler = async (args, context): Promise<ToolResult> => {\n\tconst {\n\t\toutcome = \"completed\",\n\t\tcreateSnapshot = outcome === \"completed\",\n\t\tacceptLearnings = [],\n\t\tcustomLearning,\n\t\tnotes,\n\t\treflection,\n\t} = args as CompleteTaskInput;\n\n\tconst workspaceRoot = context.workspaceRoot;\n\tconst state = getSessionState(workspaceRoot);\n\tconst task = getCurrentTask(workspaceRoot);\n\n\tif (!task) {\n\t\treturn result(\n\t\t\tJSON.stringify({\n\t\t\t\terror: \"E301_NO_ACTIVE_TASK\",\n\t\t\t\tmessage: \"No active task to complete. Use begin_task to start one.\",\n\t\t\t\t_hint: \"Start a new task with begin_task before trying to complete it.\",\n\t\t\t}),\n\t\t\ttrue,\n\t\t);\n\t}\n\n\t// =========================================================================\n\t// DAEMON-FIRST: Try ending task via daemon\n\t// =========================================================================\n\tconst daemonResult = await endTaskViaDaemon(workspaceRoot, outcome);\n\n\tif (daemonResult) {\n\t\t// Daemon handled the task end - it has the authoritative state\n\t\t// We still need to end local state and handle learning capture\n\n\t\t// Track warnings for user visibility\n\t\tconst warnings: string[] = [];\n\n\t\t// Check for unvalidated files (pre-completion validation warning)\n\t\tconst modifiedFiles = state.changesSinceTaskStart.map((c) => c.file);\n\t\tconst validatedFiles = state.validatedFiles || [];\n\t\tconst unvalidatedFiles = modifiedFiles.filter((f) => !validatedFiles.includes(f));\n\t\tif (unvalidatedFiles.length > 0) {\n\t\t\twarnings.push(\n\t\t\t\t`${unvalidatedFiles.length} file(s) modified but not validated. Consider running check_patterns before committing.`,\n\t\t\t);\n\t\t}\n\n\t\t// Capture accepted learnings locally with error tracking\n\t\tlet learningsCaptured = 0;\n\t\tconst failedLearnings: string[] = [];\n\t\tfor (const idx of acceptLearnings) {\n\t\t\tif (idx >= 0 && idx < state.pendingSuggestedLearnings.length) {\n\t\t\t\tconst learning = state.pendingSuggestedLearnings[idx];\n\t\t\t\tconst result = appendLearning(workspaceRoot, learning);\n\t\t\t\tif (result.success) {\n\t\t\t\t\tlearningsCaptured++;\n\t\t\t\t} else {\n\t\t\t\t\tfailedLearnings.push(`Learning ${idx}: ${result.error}`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (customLearning) {\n\t\t\tconst result = appendLearning(workspaceRoot, customLearning);\n\t\t\tif (result.success) {\n\t\t\t\tlearningsCaptured++;\n\t\t\t} else {\n\t\t\t\tfailedLearnings.push(`Custom learning: ${result.error}`);\n\t\t\t}\n\t\t}\n\n\t\tif (failedLearnings.length > 0) {\n\t\t\twarnings.push(`Failed to save ${failedLearnings.length} learning(s): ${failedLearnings.join(\"; \")}`);\n\t\t}\n\n\t\tstate.stats.learningsCaptured += learningsCaptured;\n\n\t\t// End local task tracking\n\t\tendTask(workspaceRoot, outcome);\n\n\t\t// Build next actions\n\t\tconst nextActions: Array<{ tool: string; priority: number; reason: string }> = [];\n\t\tif (outcome === \"completed\") {\n\t\t\tnextActions.push({ tool: \"begin_task\", priority: 2, reason: \"Start your next task\" });\n\t\t} else if (outcome === \"blocked\") {\n\t\t\tnextActions.push({\n\t\t\t\ttool: \"get_learnings\",\n\t\t\t\tpriority: 1,\n\t\t\t\treason: \"Check if similar issues were solved before\",\n\t\t\t});\n\t\t}\n\t\tif (learningsCaptured === 0 && daemonResult.summary.filesModified > 3) {\n\t\t\tnextActions.push({ tool: \"learn\", priority: 3, reason: \"Consider capturing a pattern from this work\" });\n\t\t}\n\n\t\t// Build accountability effect if reflection provided (daemon path)\n\t\tlet accountability_effect: AccountabilityEffectOutput | undefined;\n\t\tif (reflection?.perceived_help) {\n\t\t\taccountability_effect = buildAccountabilityEffect(\n\t\t\t\treflection,\n\t\t\t\ttask.id,\n\t\t\t\tdaemonResult.summary.duration,\n\t\t\t\tdaemonResult.summary.filesModified,\n\t\t\t\tdaemonResult.summary.linesChanged,\n\t\t\t\tdaemonResult.snapshot.created ? 1 : 0,\n\t\t\t\tcontext.tier || \"free\",\n\t\t\t\toutcome,\n\t\t\t);\n\t\t}\n\n\t\tconst output: CompleteTaskOutput = {\n\t\t\ttaskId: task.id,\n\t\t\ttaskDescription: task.description,\n\t\t\toutcome,\n\t\t\tduration: formatDuration(daemonResult.summary.duration),\n\t\t\tsummary: {\n\t\t\t\tfilesChanged: daemonResult.summary.filesModified,\n\t\t\t\tlinesChanged: daemonResult.summary.linesChanged,\n\t\t\t\tsnapshotsCreated: daemonResult.snapshot.created ? 1 : 0,\n\t\t\t\triskAreasTouched: state.riskAreasTouched,\n\t\t\t},\n\t\t\tlearningsCaptured: learningsCaptured + daemonResult.learningsAccepted,\n\t\t\tfinalSnapshot: daemonResult.snapshot.created\n\t\t\t\t? { id: \"daemon-snapshot\", fileCount: daemonResult.summary.filesModified }\n\t\t\t\t: undefined,\n\t\t\tsessionStats: {\n\t\t\t\ttasksCompleted: state.stats.tasksCompleted,\n\t\t\t\ttotalSnapshots: state.stats.snapshotsCreated,\n\t\t\t\ttotalLearnings: state.stats.learningsCaptured,\n\t\t\t},\n\t\t\tnextActions,\n\t\t\taccountability_effect,\n\t\t\t_warnings: warnings.length > 0 ? warnings : undefined,\n\t\t};\n\n\t\tconst emoji = outcome === \"completed\" ? \"\" : outcome === \"blocked\" ? \"\" : \"\";\n\t\tconst intentHint = getIntentHint(task.intent, outcome);\n\t\tconst baseHint =\n\t\t\toutcome === \"completed\"\n\t\t\t\t? `Task completed in ${formatDuration(daemonResult.summary.duration)}! ${daemonResult.summary.filesModified} file(s), ${daemonResult.summary.linesChanged} line(s) changed.`\n\t\t\t\t: outcome === \"blocked\"\n\t\t\t\t\t? \"Task blocked. Check learnings for similar issues.\"\n\t\t\t\t\t: \"Task abandoned.\";\n\t\tconst hint = intentHint ? `${baseHint} ${intentHint}` : baseHint;\n\n\t\treturn result(\n\t\t\tJSON.stringify(\n\t\t\t\t{\n\t\t\t\t\t...output,\n\t\t\t\t\tmessage: `${emoji} ${hint}`,\n\t\t\t\t\t_hint: notes ? `Notes: ${notes}` : hint,\n\t\t\t\t\t_intentHint: intentHint,\n\t\t\t\t\t_source: \"daemon\",\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\t2,\n\t\t\t),\n\t\t);\n\t}\n\n\t// =========================================================================\n\t// FALLBACK: Daemon unavailable, use local state\n\t// =========================================================================\n\n\t// Track warnings for user visibility\n\tconst fallbackWarnings: string[] = [];\n\n\t// Calculate duration\n\tconst durationMs = Date.now() - task.startedAt;\n\tconst duration = formatDuration(durationMs);\n\n\t// Calculate summary\n\tconst filesChanged = state.changesSinceTaskStart.length;\n\tconst linesChanged = state.changesSinceTaskStart.reduce((sum, c) => sum + c.linesChanged, 0);\n\n\t// Check for unvalidated files (pre-completion validation warning)\n\tconst modifiedFilePaths = state.changesSinceTaskStart.map((c) => c.file);\n\tconst validatedFilePaths = state.validatedFiles || [];\n\tconst unvalidatedFilePaths = modifiedFilePaths.filter((f) => !validatedFilePaths.includes(f));\n\tif (unvalidatedFilePaths.length > 0) {\n\t\tfallbackWarnings.push(\n\t\t\t`${unvalidatedFilePaths.length} file(s) modified but not validated. Consider running check_patterns before committing.`,\n\t\t);\n\t}\n\n\t// Create final snapshot if requested\n\tlet finalSnapshot: CompleteTaskOutput[\"finalSnapshot\"];\n\n\tif (createSnapshot && filesChanged > 0) {\n\t\tconst filePaths = state.changesSinceTaskStart.map((c) => c.file);\n\t\tconst snapshotService = createSnapshotService(workspaceRoot);\n\t\tconst snapshotResult = await snapshotService.createFromFiles(filePaths, {\n\t\t\tdescription: `Task complete: ${task.description}`,\n\t\t\ttrigger: \"ai-detection\",\n\t\t\tskipDedup: true, // Always create final snapshot\n\t\t});\n\n\t\tif (snapshotResult.success && snapshotResult.snapshot) {\n\t\t\tfinalSnapshot = {\n\t\t\t\tid: snapshotResult.snapshot.id,\n\t\t\t\tfileCount: snapshotResult.snapshot.fileCount,\n\t\t\t};\n\t\t\tstate.stats.snapshotsCreated++;\n\t\t}\n\t}\n\n\t// Capture accepted learnings with error tracking\n\tlet learningsCaptured = 0;\n\tconst failedLearningWrites: string[] = [];\n\n\t// Accept pending suggested learnings\n\tfor (const idx of acceptLearnings) {\n\t\tif (idx >= 0 && idx < state.pendingSuggestedLearnings.length) {\n\t\t\tconst learning = state.pendingSuggestedLearnings[idx];\n\t\t\tconst writeResult = appendLearning(workspaceRoot, learning);\n\t\t\tif (writeResult.success) {\n\t\t\t\tlearningsCaptured++;\n\t\t\t} else {\n\t\t\t\tfailedLearningWrites.push(`Learning ${idx}: ${writeResult.error}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t// Add custom learning if provided\n\tif (customLearning) {\n\t\tconst writeResult = appendLearning(workspaceRoot, customLearning);\n\t\tif (writeResult.success) {\n\t\t\tlearningsCaptured++;\n\t\t} else {\n\t\t\tfailedLearningWrites.push(`Custom learning: ${writeResult.error}`);\n\t\t}\n\t}\n\n\tif (failedLearningWrites.length > 0) {\n\t\tfallbackWarnings.push(\n\t\t\t`Failed to save ${failedLearningWrites.length} learning(s): ${failedLearningWrites.join(\"; \")}`,\n\t\t);\n\t}\n\n\t// Update session stats\n\tstate.stats.learningsCaptured += learningsCaptured;\n\n\t// End the task\n\tendTask(workspaceRoot, outcome);\n\n\t// Build next actions\n\tconst nextActions: Array<{ tool: string; priority: number; reason: string }> = [];\n\n\tif (outcome === \"completed\") {\n\t\tnextActions.push({\n\t\t\ttool: \"begin_task\",\n\t\t\tpriority: 2,\n\t\t\treason: \"Start your next task\",\n\t\t});\n\t} else if (outcome === \"blocked\") {\n\t\tnextActions.push({\n\t\t\ttool: \"get_learnings\",\n\t\t\tpriority: 1,\n\t\t\treason: \"Check if similar issues were solved before\",\n\t\t});\n\t}\n\n\tif (learningsCaptured === 0 && filesChanged > 3) {\n\t\tnextActions.push({\n\t\t\ttool: \"learn\",\n\t\t\tpriority: 3,\n\t\t\treason: \"Consider capturing a pattern from this work\",\n\t\t});\n\t}\n\n\t// Build accountability effect if reflection provided\n\tlet accountability_effect: AccountabilityEffectOutput | undefined;\n\tif (reflection?.perceived_help) {\n\t\taccountability_effect = buildAccountabilityEffect(\n\t\t\treflection,\n\t\t\ttask.id,\n\t\t\tdurationMs,\n\t\t\tfilesChanged,\n\t\t\tlinesChanged,\n\t\t\tfinalSnapshot ? 1 : 0,\n\t\t\tcontext.tier || \"free\",\n\t\t\toutcome,\n\t\t);\n\t}\n\n\tconst output: CompleteTaskOutput = {\n\t\ttaskId: task.id,\n\t\ttaskDescription: task.description,\n\t\toutcome,\n\t\tduration,\n\t\tsummary: {\n\t\t\tfilesChanged,\n\t\t\tlinesChanged,\n\t\t\tsnapshotsCreated: finalSnapshot ? 1 : 0,\n\t\t\triskAreasTouched: state.riskAreasTouched,\n\t\t},\n\t\tlearningsCaptured,\n\t\tfinalSnapshot,\n\t\tsessionStats: {\n\t\t\ttasksCompleted: state.stats.tasksCompleted,\n\t\t\ttotalSnapshots: state.stats.snapshotsCreated,\n\t\t\ttotalLearnings: state.stats.learningsCaptured,\n\t\t},\n\t\tnextActions,\n\t\taccountability_effect,\n\t\t_warnings: fallbackWarnings.length > 0 ? fallbackWarnings : undefined,\n\t};\n\n\t// Build completion message\n\tconst emoji = outcome === \"completed\" ? \"\" : outcome === \"blocked\" ? \"\" : \"\";\n\tconst intentHint = getIntentHint(task.intent, outcome);\n\tconst baseHint =\n\t\toutcome === \"completed\"\n\t\t\t? `Task completed in ${duration}! ${filesChanged} file(s), ${linesChanged} line(s) changed.`\n\t\t\t: outcome === \"blocked\"\n\t\t\t\t? \"Task blocked. Check learnings for similar issues.\"\n\t\t\t\t: \"Task abandoned.\";\n\tconst hint = intentHint ? `${baseHint} ${intentHint}` : baseHint;\n\n\treturn result(\n\t\tJSON.stringify(\n\t\t\t{\n\t\t\t\t...output,\n\t\t\t\tmessage: `${emoji} ${hint}`,\n\t\t\t\t_hint: notes ? `Notes: ${notes}` : hint,\n\t\t\t\t_intentHint: intentHint,\n\t\t\t},\n\t\t\tnull,\n\t\t\t2,\n\t\t),\n\t);\n};\n","/**\n * Pairing Protocol Generator\n *\n * Generates context-aware guidance for AI agents using SnapBack.\n * This protocol is injected into system prompts to guide tool usage.\n *\n * Architecture:\n * - Reads session state for context\n * - Generates dynamic recommendations\n * - Provides quick reference for tool usage\n *\n * @module facades/pairing-protocol\n */\n\nimport { formatDuration, getCurrentTask, getSessionState, type MCPSessionState } from \"../session/state.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Pairing protocol context for AI agents\n */\nexport interface PairingProtocol {\n\t/** Protocol version */\n\tversion: string;\n\n\t/** Current task context (if any) */\n\tcurrentTask: {\n\t\tid: string;\n\t\tdescription: string;\n\t\tduration: string;\n\t\tfilesChanged: number;\n\t\tsnapshotId?: string;\n\t} | null;\n\n\t/** Recent observations to surface */\n\trecentObservations: Array<{\n\t\ttype: string;\n\t\tmessage: string;\n\t\temoji: string;\n\t}>;\n\n\t/** Risk areas currently being modified */\n\triskAreas: string[];\n\n\t/** Session statistics */\n\tsessionStats: {\n\t\ttasksCompleted: number;\n\t\tsnapshotsCreated: number;\n\t\trestoresPerformed: number;\n\t\tlearningsCaptured: number;\n\t};\n\n\t/** Dynamic recommendations */\n\trecommendations: string[];\n\n\t/** Quick reference for tool usage */\n\tquickReference: string;\n\n\t/** Full protocol text (for system prompt injection) */\n\tprotocolText: string;\n}\n\n// =============================================================================\n// EMOJI HELPERS\n// =============================================================================\n\n/**\n * Get emoji for observation type\n */\nfunction getObservationEmoji(type: string): string {\n\tswitch (type) {\n\t\tcase \"risk\":\n\t\t\treturn \"\";\n\t\tcase \"warning\":\n\t\t\treturn \"\";\n\t\tcase \"pattern\":\n\t\t\treturn \"\";\n\t\tcase \"suggestion\":\n\t\t\treturn \"\";\n\t\tcase \"progress\":\n\t\t\treturn \"\";\n\t\tdefault:\n\t\t\treturn \"\";\n\t}\n}\n\n// =============================================================================\n// PROTOCOL GENERATION\n// =============================================================================\n\n/**\n * Generate dynamic recommendations based on session state\n */\nfunction generateRecommendations(state: MCPSessionState): string[] {\n\tconst recommendations: string[] = [];\n\n\t// Check if no task is active\n\tif (!state.currentTask) {\n\t\trecommendations.push(\"Call `begin_task` before making any code changes\");\n\t\treturn recommendations;\n\t}\n\n\t// Check for high risk areas\n\tif (state.riskAreasTouched.length > 0) {\n\t\trecommendations.push(\n\t\t\t`You're modifying ${state.riskAreasTouched.join(\", \")} - a snapshot protects these changes`,\n\t\t);\n\t}\n\n\t// Check for many unsaved observations\n\tif (state.pendingObservations.length > 3) {\n\t\trecommendations.push(`${state.pendingObservations.length} observations pending - review with next tool call`);\n\t}\n\n\t// Check for long-running task\n\tif (state.currentTask) {\n\t\tconst durationMs = Date.now() - state.currentTask.startedAt;\n\t\tconst minutes = durationMs / 60000;\n\n\t\tif (minutes > 30) {\n\t\t\trecommendations.push(\"Task running 30+ minutes - consider using `review_work` to check progress\");\n\t\t}\n\t}\n\n\t// Check for many changes\n\tif (state.changesSinceTaskStart.length > 5) {\n\t\trecommendations.push(\n\t\t\t`${state.changesSinceTaskStart.length} files changed - use \\`what_changed\\` to review scope`,\n\t\t);\n\t}\n\n\t// Check for high AI attribution\n\tconst aiChanges = state.changesSinceTaskStart.filter((c) => c.aiAttributed).length;\n\tif (aiChanges > 3) {\n\t\trecommendations.push(`${aiChanges} AI-attributed changes - review carefully before committing`);\n\t}\n\n\t// Check session stats\n\tif (state.stats.restoresPerformed > 0) {\n\t\trecommendations.push(`You've used restore ${state.stats.restoresPerformed} time(s) - snapshots are helping!`);\n\t}\n\n\treturn recommendations;\n}\n\n/**\n * Generate quick reference text\n */\nfunction generateQuickReference(): string {\n\treturn `\n| Situation | Tool to Call |\n|-----------|-------------|\n| Starting any task | \\`begin_task\\` |\n| \"Did I break anything?\" | \\`quick_check\\` |\n| \"What have I changed?\" | \\`what_changed\\` |\n| Ready to commit | \\`review_work\\` |\n| Task complete | \\`complete_task\\` |\n| Need to undo | \\`snapshot_restore\\` |\n`.trim();\n}\n\n/**\n * Generate full protocol text for system prompt injection\n */\nfunction generateProtocolText(state: MCPSessionState): string {\n\tconst lines: string[] = [\"## SnapBack Pairing Protocol\", \"\"];\n\n\t// Current task status\n\tif (state.currentTask) {\n\t\tconst duration = formatDuration(Date.now() - state.currentTask.startedAt);\n\t\tlines.push(`**Active Task:** ${state.currentTask.description}`);\n\t\tlines.push(`**Duration:** ${duration}`);\n\t\tlines.push(`**Files Changed:** ${state.changesSinceTaskStart.length}`);\n\t\tif (state.currentTask.snapshotId) {\n\t\t\tlines.push(`**Snapshot:** ${state.currentTask.snapshotId} (available for rollback)`);\n\t\t}\n\t\tlines.push(\"\");\n\t} else {\n\t\tlines.push(\"**No active task.** Call `begin_task` before making changes.\");\n\t\tlines.push(\"\");\n\t}\n\n\t// Pending observations\n\tif (state.pendingObservations.length > 0) {\n\t\tlines.push(\"**Recent Observations:**\");\n\t\tfor (const obs of state.pendingObservations.slice(-3)) {\n\t\t\tconst emoji = getObservationEmoji(obs.type);\n\t\t\tlines.push(`- ${emoji} ${obs.message}`);\n\t\t}\n\t\tlines.push(\"\");\n\t}\n\n\t// Risk areas\n\tif (state.riskAreasTouched.length > 0) {\n\t\tlines.push(`**Risk Areas in Scope:** ${state.riskAreasTouched.join(\", \")}`);\n\t\tlines.push(\"\");\n\t}\n\n\t// Tool usage pattern\n\tlines.push(\"### Tool Usage Pattern\");\n\tlines.push(\"\");\n\tlines.push(\"**START of any coding task:**\");\n\tlines.push(\"```\");\n\tlines.push('Call: begin_task({ task: \"description\", files: [\"planned\", \"files\"] })');\n\tlines.push(\"```\");\n\tlines.push(\"\");\n\tlines.push(\"**DURING development:**\");\n\tlines.push(\"- After changes: `quick_check({})` - fast validation\");\n\tlines.push(\"- Review progress: `what_changed({})` - see all changes\");\n\tlines.push(\"\");\n\tlines.push(\"**BEFORE committing:**\");\n\tlines.push(\"```\");\n\tlines.push('Call: review_work({ intent: \"what you accomplished\" })');\n\tlines.push(\"```\");\n\tlines.push(\"\");\n\tlines.push(\"**END of task:**\");\n\tlines.push(\"```\");\n\tlines.push('Call: complete_task({ outcome: \"completed\", acceptLearnings: [0, 1] })');\n\tlines.push(\"```\");\n\tlines.push(\"\");\n\n\t// Quick reference\n\tlines.push(\"### Quick Reference\");\n\tlines.push(\"\");\n\tlines.push(generateQuickReference());\n\n\treturn lines.join(\"\\n\");\n}\n\n/**\n * Generate pairing protocol for a workspace\n */\nexport function generatePairingProtocol(workspaceRoot: string): PairingProtocol {\n\tconst state = getSessionState(workspaceRoot);\n\tconst currentTask = getCurrentTask(workspaceRoot);\n\n\t// Build current task summary\n\tlet taskContext: PairingProtocol[\"currentTask\"] = null;\n\tif (currentTask) {\n\t\ttaskContext = {\n\t\t\tid: currentTask.id,\n\t\t\tdescription: currentTask.description,\n\t\t\tduration: formatDuration(Date.now() - currentTask.startedAt),\n\t\t\tfilesChanged: state.changesSinceTaskStart.length,\n\t\t\tsnapshotId: currentTask.snapshotId,\n\t\t};\n\t}\n\n\t// Build observations\n\tconst recentObservations = state.pendingObservations.slice(-5).map((obs) => ({\n\t\ttype: obs.type,\n\t\tmessage: obs.message,\n\t\temoji: getObservationEmoji(obs.type),\n\t}));\n\n\t// Generate recommendations\n\tconst recommendations = generateRecommendations(state);\n\n\treturn {\n\t\tversion: \"2.0\",\n\t\tcurrentTask: taskContext,\n\t\trecentObservations,\n\t\triskAreas: [...state.riskAreasTouched],\n\t\tsessionStats: { ...state.stats },\n\t\trecommendations,\n\t\tquickReference: generateQuickReference(),\n\t\tprotocolText: generateProtocolText(state),\n\t};\n}\n\n/**\n * Get system prompt addendum based on current session state\n *\n * This is a shorter version suitable for injection into system prompts\n */\nexport function getSystemPromptAddendum(workspaceRoot: string): string {\n\tconst state = getSessionState(workspaceRoot);\n\treturn generateProtocolText(state);\n}\n\n/**\n * Get a minimal context summary for tool responses\n */\nexport function getContextSummary(workspaceRoot: string): {\n\thasActiveTask: boolean;\n\ttaskId?: string;\n\tfilesChanged: number;\n\triskAreas: string[];\n\tpendingObservations: number;\n} {\n\tconst state = getSessionState(workspaceRoot);\n\n\treturn {\n\t\thasActiveTask: state.currentTask !== null,\n\t\ttaskId: state.currentTask?.id,\n\t\tfilesChanged: state.changesSinceTaskStart.length,\n\t\triskAreas: [...state.riskAreasTouched],\n\t\tpendingObservations: state.pendingObservations.length,\n\t};\n}\n","/**\n * ErrorPatternRegistry - Map common error patterns to likely solutions\n *\n * Provides proactive guidance by matching error messages to known solutions.\n * Used by begin_task and quick_check to surface actionable hints.\n *\n * @module services/error-pattern-registry\n */\n\n// =============================================================================\n// Types\n// =============================================================================\n\nexport interface ErrorPattern {\n\t/** Unique identifier */\n\tid: string;\n\t/** Regex or string pattern to match */\n\tpattern: RegExp | string;\n\t/** Category for grouping */\n\tcategory: \"typescript\" | \"filesystem\" | \"module\" | \"build\" | \"test\" | \"lint\";\n\t/** Brief description of the error */\n\tdescription: string;\n\t/** Likely solutions (ordered by probability) */\n\tsolutions: string[];\n\t/** Auto-fixable via simple action */\n\tautoFixable: boolean;\n\t/** Auto-fix action if applicable */\n\tautoFix?: {\n\t\taction: \"create_file\" | \"install_package\" | \"run_command\" | \"normalize_path\";\n\t\tparams?: Record<string, string>;\n\t};\n\t/** Confidence score (0-1) */\n\tconfidence: number;\n}\n\nexport interface MatchResult {\n\tpattern: ErrorPattern;\n\tmatch: RegExpMatchArray | null;\n\t/** Extracted values from pattern groups */\n\textracted: Record<string, string>;\n}\n\n// =============================================================================\n// Registry\n// =============================================================================\n\n/**\n * Built-in error patterns\n * Ordered by specificity (more specific patterns first)\n */\nconst BUILT_IN_PATTERNS: ErrorPattern[] = [\n\t// TypeScript errors\n\t{\n\t\tid: \"ts-property-not-exist\",\n\t\tpattern: /error TS2339: Property '([^']+)' does not exist on type '([^']+)'/,\n\t\tcategory: \"typescript\",\n\t\tdescription: \"Property access on incompatible type\",\n\t\tsolutions: [\n\t\t\t\"Add the property to the type definition\",\n\t\t\t\"Use type assertion if property exists at runtime\",\n\t\t\t\"Check for typos in property name\",\n\t\t],\n\t\tautoFixable: false,\n\t\tconfidence: 0.9,\n\t},\n\t{\n\t\tid: \"ts-type-not-assignable\",\n\t\tpattern: /error TS2322: Type '([^']+)' is not assignable to type '([^']+)'/,\n\t\tcategory: \"typescript\",\n\t\tdescription: \"Type mismatch in assignment\",\n\t\tsolutions: [\n\t\t\t\"Fix the value to match expected type\",\n\t\t\t\"Update the type definition to accept the value\",\n\t\t\t\"Use type assertion if intentional\",\n\t\t],\n\t\tautoFixable: false,\n\t\tconfidence: 0.9,\n\t},\n\t{\n\t\tid: \"ts-argument-not-assignable\",\n\t\tpattern: /error TS2345: Argument of type '([^']+)' is not assignable to parameter of type '([^']+)'/,\n\t\tcategory: \"typescript\",\n\t\tdescription: \"Function argument type mismatch\",\n\t\tsolutions: [\n\t\t\t\"Fix the argument value to match expected type\",\n\t\t\t\"Update function signature to accept the type\",\n\t\t\t\"Use type assertion if intentional\",\n\t\t],\n\t\tautoFixable: false,\n\t\tconfidence: 0.9,\n\t},\n\t{\n\t\tid: \"ts-cannot-find-name\",\n\t\tpattern: /error TS2304: Cannot find name '([^']+)'/,\n\t\tcategory: \"typescript\",\n\t\tdescription: \"Reference to undefined identifier\",\n\t\tsolutions: [\"Import the missing symbol\", \"Check for typos in the name\", \"Declare the variable/type\"],\n\t\tautoFixable: false,\n\t\tconfidence: 0.85,\n\t},\n\t{\n\t\tid: \"ts-module-not-found\",\n\t\tpattern: /error TS2307: Cannot find module '([^']+)'/,\n\t\tcategory: \"typescript\",\n\t\tdescription: \"Module resolution failure\",\n\t\tsolutions: [\n\t\t\t\"Install the package: npm install <package>\",\n\t\t\t\"Check package.json for the dependency\",\n\t\t\t\"Verify tsconfig paths configuration\",\n\t\t],\n\t\tautoFixable: true,\n\t\tautoFix: {\n\t\t\taction: \"install_package\",\n\t\t},\n\t\tconfidence: 0.9,\n\t},\n\n\t// Filesystem errors\n\t{\n\t\tid: \"fs-enoent\",\n\t\tpattern: /ENOENT: no such file or directory(?:, (?:open|stat|read) '([^']+)')?/,\n\t\tcategory: \"filesystem\",\n\t\tdescription: \"File or directory not found\",\n\t\tsolutions: [\n\t\t\t\"Create the missing file/directory\",\n\t\t\t\"Check the path for typos\",\n\t\t\t\"Normalize path separators for cross-platform\",\n\t\t],\n\t\tautoFixable: true,\n\t\tautoFix: {\n\t\t\taction: \"create_file\",\n\t\t},\n\t\tconfidence: 0.95,\n\t},\n\t{\n\t\tid: \"fs-eacces\",\n\t\tpattern: /EACCES: permission denied(?:, (?:open|write|read) '([^']+)')?/,\n\t\tcategory: \"filesystem\",\n\t\tdescription: \"Insufficient permissions\",\n\t\tsolutions: [\"Check file permissions (chmod)\", \"Run with appropriate permissions\", \"Verify the path is correct\"],\n\t\tautoFixable: false,\n\t\tconfidence: 0.9,\n\t},\n\t{\n\t\tid: \"fs-enospc\",\n\t\tpattern: /ENOSPC: no space left on device/,\n\t\tcategory: \"filesystem\",\n\t\tdescription: \"Disk space exhausted\",\n\t\tsolutions: [\"Free up disk space\", \"Clean node_modules and reinstall\", \"Clear temporary files\"],\n\t\tautoFixable: false,\n\t\tconfidence: 0.95,\n\t},\n\n\t// Module resolution\n\t{\n\t\tid: \"module-not-found\",\n\t\tpattern: /Cannot find module '([^']+)'/,\n\t\tcategory: \"module\",\n\t\tdescription: \"Module resolution failure\",\n\t\tsolutions: [\n\t\t\t\"Install the package: npm install <package>\",\n\t\t\t\"Check package.json dependencies\",\n\t\t\t\"Verify the import path is correct\",\n\t\t],\n\t\tautoFixable: true,\n\t\tautoFix: {\n\t\t\taction: \"install_package\",\n\t\t},\n\t\tconfidence: 0.85,\n\t},\n\t{\n\t\tid: \"module-export-not-found\",\n\t\tpattern: /Module '\"([^\"]+)\"' has no exported member '([^']+)'/,\n\t\tcategory: \"module\",\n\t\tdescription: \"Named export not found in module\",\n\t\tsolutions: [\"Check the correct export name\", \"Use default import instead\", \"Update the package version\"],\n\t\tautoFixable: false,\n\t\tconfidence: 0.85,\n\t},\n\n\t// Build errors\n\t{\n\t\tid: \"build-syntax-error\",\n\t\tpattern: /SyntaxError: (?:Unexpected token|Missing semicolon)/,\n\t\tcategory: \"build\",\n\t\tdescription: \"JavaScript/TypeScript syntax error\",\n\t\tsolutions: [\n\t\t\t\"Check for missing brackets or semicolons\",\n\t\t\t\"Verify ESM vs CommonJS syntax\",\n\t\t\t\"Run linter for syntax hints\",\n\t\t],\n\t\tautoFixable: false,\n\t\tconfidence: 0.8,\n\t},\n\n\t// Test errors\n\t{\n\t\tid: \"test-assertion-failed\",\n\t\tpattern: /AssertionError: expected .+ to (?:equal|be|have)/,\n\t\tcategory: \"test\",\n\t\tdescription: \"Test assertion failure\",\n\t\tsolutions: [\n\t\t\t\"Check the expected vs actual values\",\n\t\t\t\"Update the test or fix the implementation\",\n\t\t\t\"Verify test data is correct\",\n\t\t],\n\t\tautoFixable: false,\n\t\tconfidence: 0.8,\n\t},\n\t{\n\t\tid: \"test-timeout\",\n\t\tpattern: /Timeout of \\d+ms exceeded/,\n\t\tcategory: \"test\",\n\t\tdescription: \"Test exceeded timeout\",\n\t\tsolutions: [\n\t\t\t\"Increase test timeout\",\n\t\t\t\"Check for async operations not awaited\",\n\t\t\t\"Verify mock responses are resolving\",\n\t\t],\n\t\tautoFixable: false,\n\t\tconfidence: 0.85,\n\t},\n\n\t// Lint errors\n\t{\n\t\tid: \"lint-unused-var\",\n\t\tpattern: /'([^']+)' is (?:defined but never used|assigned .+ but never used)/,\n\t\tcategory: \"lint\",\n\t\tdescription: \"Unused variable/import\",\n\t\tsolutions: [\n\t\t\t\"Remove the unused variable/import\",\n\t\t\t\"Prefix with underscore if intentional: _var\",\n\t\t\t\"Use the variable in code\",\n\t\t],\n\t\tautoFixable: true,\n\t\tautoFix: {\n\t\t\taction: \"run_command\",\n\t\t\tparams: { command: \"npx biome check --apply\" },\n\t\t},\n\t\tconfidence: 0.9,\n\t},\n];\n\n// =============================================================================\n// ErrorPatternRegistry\n// =============================================================================\n\nexport class ErrorPatternRegistry {\n\tprivate patterns: ErrorPattern[] = [];\n\n\tconstructor() {\n\t\t// Register built-in patterns\n\t\tthis.patterns.push(...BUILT_IN_PATTERNS);\n\t}\n\n\t/**\n\t * Register a custom pattern\n\t */\n\tregister(pattern: ErrorPattern): void {\n\t\tthis.patterns.push(pattern);\n\t}\n\n\t/**\n\t * Match an error message against all patterns\n\t * Returns the best match (highest confidence)\n\t */\n\tmatch(errorMessage: string): MatchResult | null {\n\t\tconst matches: MatchResult[] = [];\n\n\t\tfor (const pattern of this.patterns) {\n\t\t\tconst regex = typeof pattern.pattern === \"string\" ? new RegExp(pattern.pattern) : pattern.pattern;\n\n\t\t\tconst match = errorMessage.match(regex);\n\t\t\tif (match) {\n\t\t\t\t// Extract named groups or positional groups\n\t\t\t\tconst extracted: Record<string, string> = {};\n\t\t\t\tif (match.groups) {\n\t\t\t\t\tObject.assign(extracted, match.groups);\n\t\t\t\t} else {\n\t\t\t\t\t// Use positional indices\n\t\t\t\t\tmatch.slice(1).forEach((val, idx) => {\n\t\t\t\t\t\tif (val) {\n\t\t\t\t\t\t\textracted[`$${idx + 1}`] = val;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tmatches.push({ pattern, match, extracted });\n\t\t\t}\n\t\t}\n\n\t\tif (matches.length === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Return highest confidence match\n\t\treturn matches.reduce((best, current) =>\n\t\t\tcurrent.pattern.confidence > best.pattern.confidence ? current : best,\n\t\t);\n\t}\n\n\t/**\n\t * Match multiple error messages\n\t * Returns unique patterns with occurrence counts\n\t */\n\tmatchMultiple(errors: string[]): Array<MatchResult & { count: number }> {\n\t\tconst matches = new Map<string, MatchResult & { count: number }>();\n\n\t\tfor (const error of errors) {\n\t\t\tconst result = this.match(error);\n\t\t\tif (result) {\n\t\t\t\tconst existing = matches.get(result.pattern.id);\n\t\t\t\tif (existing) {\n\t\t\t\t\texisting.count++;\n\t\t\t\t} else {\n\t\t\t\t\tmatches.set(result.pattern.id, { ...result, count: 1 });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn Array.from(matches.values());\n\t}\n\n\t/**\n\t * Get patterns by category\n\t */\n\tgetByCategory(category: ErrorPattern[\"category\"]): ErrorPattern[] {\n\t\treturn this.patterns.filter((p) => p.category === category);\n\t}\n\n\t/**\n\t * Get all auto-fixable patterns\n\t */\n\tgetAutoFixable(): ErrorPattern[] {\n\t\treturn this.patterns.filter((p) => p.autoFixable);\n\t}\n\n\t/**\n\t * Format match result as hint text\n\t */\n\tformatHint(result: MatchResult): string {\n\t\tconst lines: string[] = [];\n\t\tlines.push(`[${result.pattern.category.toUpperCase()}] ${result.pattern.description}`);\n\n\t\tif (result.pattern.solutions.length > 0) {\n\t\t\tlines.push(\"Solutions:\");\n\t\t\tfor (const solution of result.pattern.solutions.slice(0, 3)) {\n\t\t\t\tlines.push(`  - ${solution}`);\n\t\t\t}\n\t\t}\n\n\t\tif (result.pattern.autoFixable && result.pattern.autoFix) {\n\t\t\tlines.push(`Auto-fix: ${result.pattern.autoFix.action}`);\n\t\t}\n\n\t\treturn lines.join(\"\\n\");\n\t}\n}\n\n// =============================================================================\n// Factory\n// =============================================================================\n\n/** Singleton instance */\nlet instance: ErrorPatternRegistry | null = null;\n\n/**\n * Get the error pattern registry instance\n */\nexport function getErrorPatternRegistry(): ErrorPatternRegistry {\n\tif (!instance) {\n\t\tinstance = new ErrorPatternRegistry();\n\t}\n\treturn instance;\n}\n\n/**\n * Create a fresh registry (for testing)\n */\nexport function createErrorPatternRegistry(): ErrorPatternRegistry {\n\treturn new ErrorPatternRegistry();\n}\n","/**\n * Composite Tool: quick_check\n *\n * Fast parallel validation that checks TypeScript, tests, and lint\n * in a single tool call instead of requiring multiple sequential validations.\n *\n * Reduces validation time by ~60% through parallelization.\n *\n * @see pair_programmer.md Section 2.2\n * @module facades/quick-check\n */\n\nimport { spawn } from \"node:child_process\";\nimport { existsSync } from \"node:fs\";\nimport { basename, dirname, join, relative } from \"node:path\";\nimport type { ToolHandler, ToolResult } from \"../registry.js\";\nimport { createErrorCacheService } from \"../services/error-cache-service.js\";\nimport { getErrorPatternRegistry } from \"../services/error-pattern-registry.js\";\nimport { getCurrentTask, pushObservation } from \"../session/state.js\";\nimport type { CachedError } from \"../types/context.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface QuickCheckInput {\n\t/** File to validate (optional - uses current task files if not specified) */\n\tfile?: string;\n\t/** Files to validate (for batch checking) */\n\tfiles?: string[];\n\t/** Skip TypeScript check */\n\tskipTypeScript?: boolean;\n\t/** Skip test discovery/run */\n\tskipTests?: boolean;\n\t/** Skip lint check */\n\tskipLint?: boolean;\n\t/** Run tests (not just discover them) */\n\trunTests?: boolean;\n}\n\ninterface CheckResult {\n\tpassed: boolean;\n\tduration: number;\n\terrors?: string[];\n\twarnings?: string[];\n}\n\ninterface ErrorSolution {\n\tcategory: string;\n\tdescription: string;\n\tsolutions: string[];\n\tautoFixable: boolean;\n\tcount: number;\n}\n\ninterface QuickCheckOutput {\n\toverall: \"pass\" | \"fail\" | \"warn\";\n\ttypescript: CheckResult;\n\ttests: CheckResult & {\n\t\tdiscovered: number;\n\t\trun?: number;\n\t\tpassedCount?: number;\n\t\tfailedCount?: number;\n\t};\n\tlint: CheckResult;\n\tsummary: string;\n\t/** Matched error patterns with solutions */\n\tsolutions?: ErrorSolution[];\n\tnextActions: Array<{\n\t\ttool: string;\n\t\tpriority: number;\n\t\treason: string;\n\t}>;\n}\n\n// =============================================================================\n// PARALLEL EXECUTION\n// =============================================================================\n\n/**\n * Run command with timeout and capture output\n */\nasync function runCommand(\n\tcmd: string,\n\targs: string[],\n\tcwd: string,\n\ttimeoutMs = 30000,\n): Promise<{ exitCode: number; stdout: string; stderr: string; duration: number }> {\n\tconst start = Date.now();\n\n\treturn new Promise((resolve) => {\n\t\tlet stdout = \"\";\n\t\tlet stderr = \"\";\n\t\tlet killed = false;\n\n\t\tconst proc = spawn(cmd, args, {\n\t\t\tcwd,\n\t\t\tshell: true,\n\t\t\tstdio: [\"pipe\", \"pipe\", \"pipe\"],\n\t\t});\n\n\t\tconst timeout = setTimeout(() => {\n\t\t\tkilled = true;\n\t\t\tproc.kill(\"SIGTERM\");\n\t\t}, timeoutMs);\n\n\t\tproc.stdout?.on(\"data\", (data) => {\n\t\t\tstdout += data.toString();\n\t\t});\n\n\t\tproc.stderr?.on(\"data\", (data) => {\n\t\t\tstderr += data.toString();\n\t\t});\n\n\t\tproc.on(\"close\", (code) => {\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve({\n\t\t\t\texitCode: killed ? -1 : (code ?? 0),\n\t\t\t\tstdout,\n\t\t\t\tstderr,\n\t\t\t\tduration: Date.now() - start,\n\t\t\t});\n\t\t});\n\n\t\tproc.on(\"error\", (err) => {\n\t\t\tclearTimeout(timeout);\n\t\t\tresolve({\n\t\t\t\texitCode: -1,\n\t\t\t\tstdout,\n\t\t\t\tstderr: err.message,\n\t\t\t\tduration: Date.now() - start,\n\t\t\t});\n\t\t});\n\t});\n}\n\n/**\n * Check TypeScript compilation\n */\nasync function checkTypeScript(files: string[], workspaceRoot: string): Promise<CheckResult> {\n\tconst start = Date.now();\n\n\ttry {\n\t\t// Try using tsc with noEmit for checking\n\t\tconst result = await runCommand(\"npx\", [\"tsc\", \"--noEmit\", \"--pretty\", \"false\"], workspaceRoot, 15000);\n\n\t\tconst errors: string[] = [];\n\t\tconst warnings: string[] = [];\n\n\t\t// Parse tsc output\n\t\tconst lines = (result.stdout + result.stderr).split(\"\\n\");\n\t\tfor (const line of lines) {\n\t\t\tif (line.includes(\"error TS\")) {\n\t\t\t\t// Filter to only errors in target files\n\t\t\t\tconst isRelevant = files.some(\n\t\t\t\t\t(f) => line.includes(basename(f)) || line.includes(relative(workspaceRoot, f)),\n\t\t\t\t);\n\t\t\t\tif (isRelevant || files.length === 0) {\n\t\t\t\t\terrors.push(line.trim());\n\t\t\t\t}\n\t\t\t} else if (line.includes(\"warning\")) {\n\t\t\t\twarnings.push(line.trim());\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tpassed: result.exitCode === 0 || errors.length === 0,\n\t\t\tduration: Date.now() - start,\n\t\t\terrors: errors.slice(0, 10), // Limit to first 10 errors\n\t\t\twarnings: warnings.slice(0, 5),\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tpassed: true, // Assume pass if tsc not available\n\t\t\tduration: Date.now() - start,\n\t\t\twarnings: [\"TypeScript check skipped: tsc not available\"],\n\t\t};\n\t}\n}\n\n/**\n * Discover and optionally run tests\n */\ninterface TestCheckResult extends CheckResult {\n\tdiscovered: number;\n\trun?: number;\n\tpassedCount?: number;\n\tfailedCount?: number;\n}\n\nasync function checkTests(files: string[], workspaceRoot: string, runTests: boolean): Promise<TestCheckResult> {\n\tconst start = Date.now();\n\n\t// Find test files related to the modified files\n\tconst testFiles: string[] = [];\n\tfor (const file of files) {\n\t\tconst dir = dirname(file);\n\t\tconst base = basename(file, \".ts\").replace(\".tsx\", \"\");\n\n\t\t// Common test file patterns\n\t\tconst patterns = [\n\t\t\tjoin(dir, `${base}.test.ts`),\n\t\t\tjoin(dir, `${base}.test.tsx`),\n\t\t\tjoin(dir, `${base}.spec.ts`),\n\t\t\tjoin(dir, `${base}.spec.tsx`),\n\t\t\tjoin(dir, \"__tests__\", `${base}.test.ts`),\n\t\t\tjoin(dir, \"__tests__\", `${base}.test.tsx`),\n\t\t];\n\n\t\tfor (const pattern of patterns) {\n\t\t\tconst fullPath = join(workspaceRoot, pattern);\n\t\t\tif (existsSync(fullPath)) {\n\t\t\t\ttestFiles.push(pattern);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (testFiles.length === 0) {\n\t\tconst result: TestCheckResult = {\n\t\t\tpassed: true,\n\t\t\tduration: Date.now() - start,\n\t\t\tdiscovered: 0,\n\t\t\twarnings: [\"No related test files found\"],\n\t\t};\n\t\treturn result;\n\t}\n\n\tif (!runTests) {\n\t\tconst result: TestCheckResult = {\n\t\t\tpassed: true,\n\t\t\tduration: Date.now() - start,\n\t\t\tdiscovered: testFiles.length,\n\t\t\twarnings: [`${testFiles.length} test file(s) discovered but not run. Use runTests: true to execute.`],\n\t\t};\n\t\treturn result;\n\t}\n\n\t// Run tests with vitest\n\ttry {\n\t\tconst result = await runCommand(\n\t\t\t\"npx\",\n\t\t\t[\"vitest\", \"run\", ...testFiles, \"--reporter=json\"],\n\t\t\tworkspaceRoot,\n\t\t\t60000, // 60s timeout for tests\n\t\t);\n\n\t\tconst errors: string[] = [];\n\t\tlet passed = 0;\n\t\tlet failed = 0;\n\n\t\t// Try to parse vitest JSON output\n\t\ttry {\n\t\t\tconst jsonMatch = result.stdout.match(/\\{[\\s\\S]*\"testResults\"[\\s\\S]*\\}/);\n\t\t\tif (jsonMatch) {\n\t\t\t\tconst testResult = JSON.parse(jsonMatch[0]);\n\t\t\t\tpassed = testResult.numPassedTests || 0;\n\t\t\t\tfailed = testResult.numFailedTests || 0;\n\t\t\t\tif (testResult.testResults) {\n\t\t\t\t\tfor (const tr of testResult.testResults) {\n\t\t\t\t\t\tif (tr.status === \"failed\" && tr.message) {\n\t\t\t\t\t\t\terrors.push(tr.message.slice(0, 200));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Fallback: parse console output\n\t\t\tconst passMatch = result.stdout.match(/(\\d+) passed/);\n\t\t\tconst failMatch = result.stdout.match(/(\\d+) failed/);\n\t\t\tif (passMatch) passed = Number.parseInt(passMatch[1], 10);\n\t\t\tif (failMatch) {\n\t\t\t\tfailed = Number.parseInt(failMatch[1], 10);\n\t\t\t\terrors.push(`${failed} test(s) failed`);\n\t\t\t}\n\t\t}\n\n\t\tconst testResult: TestCheckResult = {\n\t\t\tpassed: result.exitCode === 0,\n\t\t\tduration: Date.now() - start,\n\t\t\tdiscovered: testFiles.length,\n\t\t\trun: testFiles.length,\n\t\t\tpassedCount: passed,\n\t\t\tfailedCount: failed,\n\t\t\terrors: errors.slice(0, 5),\n\t\t};\n\t\treturn testResult;\n\t} catch {\n\t\tconst result: TestCheckResult = {\n\t\t\tpassed: true,\n\t\t\tduration: Date.now() - start,\n\t\t\tdiscovered: testFiles.length,\n\t\t\twarnings: [\"Test execution skipped: vitest not available\"],\n\t\t};\n\t\treturn result;\n\t}\n}\n\n/**\n * Check lint with Biome\n */\nasync function checkLint(files: string[], workspaceRoot: string): Promise<CheckResult> {\n\tconst start = Date.now();\n\n\ttry {\n\t\tconst fileArgs = files.map((f) => relative(workspaceRoot, join(workspaceRoot, f)));\n\t\tconst result = await runCommand(\n\t\t\t\"npx\",\n\t\t\t[\"biome\", \"check\", \"--reporter=json\", ...fileArgs],\n\t\t\tworkspaceRoot,\n\t\t\t15000,\n\t\t);\n\n\t\tconst errors: string[] = [];\n\t\tconst warnings: string[] = [];\n\n\t\t// Try to parse Biome JSON output\n\t\ttry {\n\t\t\tconst diagnostics = JSON.parse(result.stdout);\n\t\t\tif (Array.isArray(diagnostics)) {\n\t\t\t\tfor (const diag of diagnostics) {\n\t\t\t\t\tif (diag.severity === \"error\") {\n\t\t\t\t\t\terrors.push(`${diag.path}: ${diag.message}`);\n\t\t\t\t\t} else if (diag.severity === \"warning\") {\n\t\t\t\t\t\twarnings.push(`${diag.path}: ${diag.message}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Fallback: check exit code\n\t\t\tif (result.exitCode !== 0) {\n\t\t\t\tconst lines = result.stderr.split(\"\\n\").filter((l) => l.trim());\n\t\t\t\terrors.push(...lines.slice(0, 5));\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tpassed: result.exitCode === 0 || errors.length === 0,\n\t\t\tduration: Date.now() - start,\n\t\t\terrors: errors.slice(0, 10),\n\t\t\twarnings: warnings.slice(0, 5),\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tpassed: true,\n\t\t\tduration: Date.now() - start,\n\t\t\twarnings: [\"Lint check skipped: biome not available\"],\n\t\t};\n\t}\n}\n\n// =============================================================================\n// HANDLER\n// =============================================================================\n\nfunction result(text: string, isError = false): ToolResult {\n\treturn {\n\t\tcontent: [{ type: \"text\", text }],\n\t\tisError,\n\t};\n}\n\n/**\n * quick_check - Fast parallel validation\n *\n * Runs TypeScript, test discovery, and lint checks in parallel\n */\nexport const handleQuickCheck: ToolHandler = async (args, context): Promise<ToolResult> => {\n\tconst {\n\t\tfile,\n\t\tfiles: providedFiles,\n\t\tskipTypeScript = false,\n\t\tskipTests = false,\n\t\tskipLint = false,\n\t\trunTests = false,\n\t} = args as QuickCheckInput;\n\n\tconst workspaceRoot = context.workspaceRoot;\n\n\t// Determine files to check\n\tlet files: string[] = [];\n\tif (providedFiles && providedFiles.length > 0) {\n\t\tfiles = providedFiles;\n\t} else if (file) {\n\t\tfiles = [file];\n\t} else {\n\t\t// Use current task files\n\t\tconst task = getCurrentTask(workspaceRoot);\n\t\tif (task?.plannedFiles.length) {\n\t\t\tfiles = task.plannedFiles;\n\t\t}\n\t}\n\n\tif (files.length === 0) {\n\t\treturn result(\n\t\t\tJSON.stringify({\n\t\t\t\terror: \"E102_MISSING_PARAM\",\n\t\t\t\tmessage: \"No files specified. Provide 'file', 'files', or start a task with begin_task.\",\n\t\t\t}),\n\t\t\ttrue,\n\t\t);\n\t}\n\n\t// Run all checks in parallel\n\tconst checks = await Promise.all([\n\t\tskipTypeScript\n\t\t\t? Promise.resolve({ passed: true, duration: 0, warnings: [\"Skipped\"] } as CheckResult)\n\t\t\t: checkTypeScript(files, workspaceRoot),\n\t\tskipTests\n\t\t\t? Promise.resolve({ passed: true, duration: 0, discovered: 0, warnings: [\"Skipped\"] } as CheckResult & {\n\t\t\t\t\tdiscovered: number;\n\t\t\t\t})\n\t\t\t: checkTests(files, workspaceRoot, runTests),\n\t\tskipLint\n\t\t\t? Promise.resolve({ passed: true, duration: 0, warnings: [\"Skipped\"] } as CheckResult)\n\t\t\t: checkLint(files, workspaceRoot),\n\t]);\n\n\tconst [typescript, tests, lint] = checks;\n\n\t// Determine overall status\n\tconst allPassed = typescript.passed && tests.passed && lint.passed;\n\tconst hasWarnings =\n\t\t(typescript.warnings?.length ?? 0) > 0 || (tests.warnings?.length ?? 0) > 0 || (lint.warnings?.length ?? 0) > 0;\n\n\tconst overall: \"pass\" | \"fail\" | \"warn\" = allPassed ? (hasWarnings ? \"warn\" : \"pass\") : \"fail\";\n\n\t// Build summary\n\tconst parts: string[] = [];\n\tif (!typescript.passed) parts.push(`TypeScript: ${typescript.errors?.length || 1} error(s)`);\n\tif (!tests.passed) parts.push(`Tests: ${(tests as any).failedCount || 1} failed`);\n\tif (!lint.passed) parts.push(`Lint: ${lint.errors?.length || 1} error(s)`);\n\n\tconst summary = allPassed\n\t\t? `All checks passed in ${typescript.duration + tests.duration + lint.duration}ms`\n\t\t: `Issues found: ${parts.join(\", \")}`;\n\n\t// Push observation for session tracking\n\tif (!allPassed) {\n\t\tpushObservation(workspaceRoot, {\n\t\t\ttype: \"warning\",\n\t\t\tmessage: summary,\n\t\t\ttimestamp: Date.now(),\n\t\t});\n\t}\n\n\t// Cache errors for future begin_task calls (P0 context enhancement)\n\ttry {\n\t\tconst errorCacheService = createErrorCacheService(workspaceRoot);\n\t\tconst errorsToCache: CachedError[] = [];\n\t\tconst now = Date.now();\n\n\t\t// Cache TypeScript errors\n\t\tif (typescript.errors && typescript.errors.length > 0) {\n\t\t\tfor (const errorMsg of typescript.errors) {\n\t\t\t\t// Parse error format: \"file.ts(line,col): error TS1234: message\"\n\t\t\t\tconst match = errorMsg.match(/^(.+?)\\((\\d+),(\\d+)\\):\\s*error\\s+(TS\\d+):\\s*(.+)$/);\n\t\t\t\tif (match) {\n\t\t\t\t\terrorsToCache.push({\n\t\t\t\t\t\tfile: match[1],\n\t\t\t\t\t\tline: Number.parseInt(match[2], 10),\n\t\t\t\t\t\tcolumn: Number.parseInt(match[3], 10),\n\t\t\t\t\t\tcode: match[4],\n\t\t\t\t\t\tmessage: match[5],\n\t\t\t\t\t\tseverity: \"error\",\n\t\t\t\t\t\ttimestamp: now,\n\t\t\t\t\t\tsource: \"typescript\",\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\t// Fallback for non-standard format\n\t\t\t\t\terrorsToCache.push({\n\t\t\t\t\t\tfile: files[0] || \"unknown\",\n\t\t\t\t\t\tline: 0,\n\t\t\t\t\t\tmessage: errorMsg,\n\t\t\t\t\t\tseverity: \"error\",\n\t\t\t\t\t\ttimestamp: now,\n\t\t\t\t\t\tsource: \"typescript\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Cache lint errors\n\t\tif (lint.errors && lint.errors.length > 0) {\n\t\t\tfor (const errorMsg of lint.errors) {\n\t\t\t\t// Parse format: \"file.ts: message\" or just message\n\t\t\t\tconst match = errorMsg.match(/^(.+?):\\s*(.+)$/);\n\t\t\t\tif (match) {\n\t\t\t\t\terrorsToCache.push({\n\t\t\t\t\t\tfile: match[1],\n\t\t\t\t\t\tline: 0,\n\t\t\t\t\t\tmessage: match[2],\n\t\t\t\t\t\tseverity: \"error\",\n\t\t\t\t\t\ttimestamp: now,\n\t\t\t\t\t\tsource: \"lint\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Cache test failures\n\t\tconst testResult = tests as QuickCheckOutput[\"tests\"];\n\t\tif (testResult.errors && testResult.errors.length > 0) {\n\t\t\tfor (const errorMsg of testResult.errors) {\n\t\t\t\terrorsToCache.push({\n\t\t\t\t\tfile: files[0] || \"unknown\",\n\t\t\t\t\tline: 0,\n\t\t\t\t\tmessage: errorMsg,\n\t\t\t\t\tseverity: \"error\",\n\t\t\t\t\ttimestamp: now,\n\t\t\t\t\tsource: \"test\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (errorsToCache.length > 0) {\n\t\t\terrorCacheService.cacheErrors(errorsToCache);\n\t\t}\n\n\t\t// Clear errors for files that passed all checks\n\t\tif (allPassed) {\n\t\t\tfor (const file of files) {\n\t\t\t\terrorCacheService.clearForFile(file);\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// Error caching is optional - don't fail quick_check\n\t}\n\n\t// Match errors against patterns for solution hints\n\tconst solutions: ErrorSolution[] = [];\n\tif (!allPassed) {\n\t\tconst registry = getErrorPatternRegistry();\n\t\tconst allErrors: string[] = [...(typescript.errors || []), ...(lint.errors || []), ...(tests.errors || [])];\n\n\t\tconst matches = registry.matchMultiple(allErrors);\n\t\tfor (const match of matches) {\n\t\t\tsolutions.push({\n\t\t\t\tcategory: match.pattern.category,\n\t\t\t\tdescription: match.pattern.description,\n\t\t\t\tsolutions: match.pattern.solutions,\n\t\t\t\tautoFixable: match.pattern.autoFixable,\n\t\t\t\tcount: match.count,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Build next actions\n\tconst nextActions: Array<{ tool: string; priority: number; reason: string }> = [];\n\n\tif (!typescript.passed) {\n\t\tnextActions.push({\n\t\t\ttool: \"validate\",\n\t\t\tpriority: 1,\n\t\t\treason: \"Fix TypeScript errors before proceeding\",\n\t\t});\n\t}\n\n\tif (!tests.passed) {\n\t\tnextActions.push({\n\t\t\ttool: \"quick_check\",\n\t\t\tpriority: 2,\n\t\t\treason: \"Re-run tests after fixing failures\",\n\t\t});\n\t}\n\n\tif (allPassed) {\n\t\tnextActions.push({\n\t\t\ttool: \"review_work\",\n\t\t\tpriority: 3,\n\t\t\treason: \"All checks passed - ready for review\",\n\t\t});\n\t}\n\n\tconst output: QuickCheckOutput = {\n\t\toverall,\n\t\ttypescript,\n\t\ttests: tests as QuickCheckOutput[\"tests\"],\n\t\tlint,\n\t\tsummary,\n\t\tsolutions: solutions.length > 0 ? solutions : undefined,\n\t\tnextActions,\n\t};\n\n\treturn result(\n\t\tJSON.stringify(\n\t\t\t{\n\t\t\t\t...output,\n\t\t\t\t_hint: allPassed\n\t\t\t\t\t? \"All checks passed! Consider using review_work before committing.\"\n\t\t\t\t\t: \"Issues found. Fix them and run quick_check again.\",\n\t\t\t},\n\t\t\tnull,\n\t\t\t2,\n\t\t),\n\t);\n};\n","/**\n * Response Utilities for MCP Facades\n *\n * Provides:\n * - Response compression for tier-aware output sizing\n * - Smart next_actions with confidence and conditions\n * - Peer coaching tone generation\n * - Snapshot deduplication helpers\n *\n * @module facades/response-utils\n */\n\nimport { existsSync, readdirSync, readFileSync, unlinkSync, writeFileSync } from \"node:fs\";\nimport { hashContent } from \"@snapback-oss/sdk\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface ResponseConfig {\n\ttier: \"pro\" | \"local\" | \"free\";\n\tmaxBytes: number;\n}\n\nexport interface SmartAction {\n\ttool: string;\n\tpriority: 1 | 2 | 3 | 4 | 5;\n\tconfidence: number; // 0-1\n\treason: string;\n\tcondition?: string; // \"if you're about to commit\"\n\tskipIf?: string[]; // conditions to skip this action\n}\n\nexport interface CoachingContext {\n\tlastAction?: string;\n\ttaskPhase?: \"starting\" | \"working\" | \"finishing\";\n\tviolationCount?: number;\n\tsnapshotAge?: number; // minutes\n}\n\nexport interface FileHash {\n\tpath: string;\n\thash: string;\n\tsize: number;\n}\n\n// ============================================================================\n// Response Compression\n// ============================================================================\n\nconst TIER_LIMITS: Record<string, ResponseConfig> = {\n\tpro: { tier: \"pro\", maxBytes: 50 * 1024 }, // 50KB\n\tlocal: { tier: \"local\", maxBytes: 15 * 1024 }, // 15KB\n\tfree: { tier: \"free\", maxBytes: 8 * 1024 }, // 8KB\n};\n\n/**\n * Get response config for a tier\n */\nexport function getResponseConfig(tier: string): ResponseConfig {\n\treturn TIER_LIMITS[tier] || TIER_LIMITS.local;\n}\n\n/**\n * Compress a response object to fit within tier limits\n *\n * Progressive compression strategy:\n * 1. Truncate arrays (learnings, violations, snapshots)\n * 2. Remove verbose fields (formatted, fullDiagnosis)\n * 3. Summarize instead of enumerate\n */\nexport function compressResponse<T extends Record<string, unknown>>(data: T, config: ResponseConfig): T {\n\tconst full = JSON.stringify(data);\n\n\t// If within limits, return as-is\n\tif (full.length <= config.maxBytes) {\n\t\treturn data;\n\t}\n\n\t// Clone for modification\n\tconst compressed = JSON.parse(full) as Record<string, unknown>;\n\n\t// Phase 1: Truncate arrays\n\tconst arrayFields = [\"learnings\", \"relevantLearnings\", \"violations\", \"recentViolations\", \"snapshots\", \"files\"];\n\tconst maxArrayItems = config.tier === \"pro\" ? 10 : config.tier === \"local\" ? 5 : 3;\n\n\tfor (const field of arrayFields) {\n\t\tif (Array.isArray(compressed[field]) && (compressed[field] as unknown[]).length > maxArrayItems) {\n\t\t\tconst arr = compressed[field] as unknown[];\n\t\t\tconst truncated = arr.slice(0, maxArrayItems);\n\t\t\tcompressed[field] = truncated;\n\t\t\tcompressed[`${field}Truncated`] = true;\n\t\t\tcompressed[`${field}Total`] = arr.length;\n\t\t}\n\t}\n\n\t// Check size after phase 1\n\tif (JSON.stringify(compressed).length <= config.maxBytes) {\n\t\treturn compressed as T;\n\t}\n\n\t// Phase 2: Remove verbose fields\n\tconst verboseFields = [\"formatted\", \"fullDiagnosis\", \"stackTrace\", \"rawOutput\", \"fullPath\", \"absolutePath\"];\n\tfor (const field of verboseFields) {\n\t\tif (field in compressed) {\n\t\t\tdelete compressed[field];\n\t\t}\n\t}\n\n\t// Recursively remove from nested objects\n\tfunction removeVerboseNested(obj: Record<string, unknown>): void {\n\t\tfor (const key of Object.keys(obj)) {\n\t\t\tif (verboseFields.includes(key)) {\n\t\t\t\tdelete obj[key];\n\t\t\t} else if (typeof obj[key] === \"object\" && obj[key] !== null && !Array.isArray(obj[key])) {\n\t\t\t\tremoveVerboseNested(obj[key] as Record<string, unknown>);\n\t\t\t}\n\t\t}\n\t}\n\tremoveVerboseNested(compressed);\n\n\t// Check size after phase 2\n\tif (JSON.stringify(compressed).length <= config.maxBytes) {\n\t\treturn compressed as T;\n\t}\n\n\t// Phase 3: Summarize long strings\n\tfunction truncateStrings(obj: Record<string, unknown>, maxLen: number): void {\n\t\tfor (const key of Object.keys(obj)) {\n\t\t\tconst val = obj[key];\n\t\t\tif (typeof val === \"string\" && val.length > maxLen) {\n\t\t\t\tobj[key] = val.slice(0, maxLen) + \"...\";\n\t\t\t} else if (typeof val === \"object\" && val !== null && !Array.isArray(val)) {\n\t\t\t\ttruncateStrings(val as Record<string, unknown>, maxLen);\n\t\t\t}\n\t\t}\n\t}\n\n\tconst maxStringLen = config.tier === \"pro\" ? 500 : config.tier === \"local\" ? 200 : 100;\n\ttruncateStrings(compressed, maxStringLen);\n\n\t// Phase 4: Add compression notice\n\tcompressed._compressed = true;\n\tcompressed._originalSize = full.length;\n\tcompressed._tier = config.tier;\n\n\treturn compressed as T;\n}\n\n// ============================================================================\n// Smart Next Actions\n// ============================================================================\n\n/**\n * Build smart next_actions based on context\n */\nexport function buildSmartActions(\n\tbaseActions: Array<{ tool: string; reason: string; priority?: number }>,\n\tcontext: {\n\t\thealthScore?: number;\n\t\thasUnsavedChanges?: boolean;\n\t\tlastSnapshotMinutes?: number;\n\t\tviolationCount?: number;\n\t\tisNewTask?: boolean;\n\t\thasCodeChanges?: boolean;\n\t},\n): SmartAction[] {\n\tconst actions: SmartAction[] = [];\n\n\t// Convert base actions with enhanced metadata\n\tfor (const base of baseActions) {\n\t\tconst action: SmartAction = {\n\t\t\ttool: base.tool,\n\t\t\tpriority: (base.priority || 2) as 1 | 2 | 3 | 4 | 5,\n\t\t\tconfidence: 0.7,\n\t\t\treason: base.reason,\n\t\t};\n\n\t\t// Enhance based on tool type and context\n\t\tswitch (base.tool) {\n\t\t\tcase \"snapshot_create\":\n\t\t\t\taction.confidence = context.hasUnsavedChanges ? 0.95 : 0.5;\n\t\t\t\taction.condition = \"Before making risky changes\";\n\t\t\t\taction.skipIf = [\"Files unchanged since last snapshot\"];\n\t\t\t\tif ((context.lastSnapshotMinutes ?? 0) < 5) {\n\t\t\t\t\taction.confidence = 0.2;\n\t\t\t\t\taction.skipIf?.push(\"Recent snapshot exists\");\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase \"check_patterns\":\n\t\t\t\taction.confidence = context.hasCodeChanges ? 0.95 : 0.6;\n\t\t\t\taction.condition = \"Before committing code\";\n\t\t\t\taction.skipIf = [\"Already validated this session\"];\n\t\t\t\tbreak;\n\n\t\t\tcase \"get_context\":\n\t\t\t\taction.confidence = context.isNewTask ? 0.95 : 0.4;\n\t\t\t\taction.condition = \"When starting a new task\";\n\t\t\t\taction.skipIf = [\"Context already loaded for this task\"];\n\t\t\t\tbreak;\n\n\t\t\tcase \"get_learnings\":\n\t\t\t\taction.confidence = (context.violationCount ?? 0) > 2 ? 0.85 : 0.5;\n\t\t\t\taction.condition = \"When encountering repeated issues\";\n\t\t\t\tbreak;\n\n\t\t\tcase \"report_violation\":\n\t\t\t\taction.confidence = 0.8;\n\t\t\t\taction.condition = \"After catching a mistake\";\n\t\t\t\tbreak;\n\t\t}\n\n\t\tactions.push(action);\n\t}\n\n\t// Sort by priority and confidence\n\treturn actions.sort((a, b) => {\n\t\tif (a.priority !== b.priority) return a.priority - b.priority;\n\t\treturn b.confidence - a.confidence;\n\t});\n}\n\n// ============================================================================\n// Peer Coaching Tone\n// ============================================================================\n\nconst COACHING_TEMPLATES = {\n\tstarting: [\n\t\t\"Let's get started! I'll keep an eye on things as you work.\",\n\t\t\"Ready to help. Remember: get_context  work  check_patterns  commit.\",\n\t\t\"Starting fresh. I'll remind you about patterns as we go.\",\n\t],\n\tworking: [\n\t\t\"Looking good so far.\",\n\t\t\"Nice progress! Consider a snapshot checkpoint.\",\n\t\t\"Solid work. I'll flag any patterns I notice.\",\n\t],\n\tfinishing: [\n\t\t\"Almost there! Don't forget check_patterns before committing.\",\n\t\t\"Wrapping up nicely. Ready for final validation?\",\n\t\t\"Great session! Time to validate and commit.\",\n\t],\n\tafterSnapshot: [\n\t\t\"Snapshot saved. You're safe to experiment now.\",\n\t\t\"Got your back with that snapshot. Go ahead and try it.\",\n\t\t\"Checkpoint created. Feel free to be bold.\",\n\t],\n\tafterViolation: [\n\t\t\"Noted that for next time. We'll catch it earlier.\",\n\t\t\"Learning recorded. I'll remind you about this pattern.\",\n\t\t\"Good catch. This will help us avoid it in the future.\",\n\t],\n\thighRisk: [\n\t\t\" Heads up: this is a sensitive area. Snapshot first?\",\n\t\t\"This touches critical files. Let's create a safety net.\",\n\t\t\"High-risk change detected. Consider snapshotting first.\",\n\t],\n};\n\n/**\n * Generate a peer coaching hint based on context\n */\nexport function generateCoachingHint(context: CoachingContext): string | null {\n\tconst { lastAction, taskPhase, violationCount, snapshotAge } = context;\n\n\t// After specific actions\n\tif (lastAction === \"snapshot_create\") {\n\t\treturn randomChoice(COACHING_TEMPLATES.afterSnapshot);\n\t}\n\tif (lastAction === \"report_violation\") {\n\t\treturn randomChoice(COACHING_TEMPLATES.afterViolation);\n\t}\n\n\t// High risk situations\n\tif ((snapshotAge ?? 0) > 60 && taskPhase === \"working\") {\n\t\treturn randomChoice(COACHING_TEMPLATES.highRisk);\n\t}\n\n\t// Based on task phase\n\tif (taskPhase && COACHING_TEMPLATES[taskPhase]) {\n\t\t// Only sometimes add phase-based hints (avoid being chatty)\n\t\tif (Math.random() > 0.7) {\n\t\t\treturn randomChoice(COACHING_TEMPLATES[taskPhase]);\n\t\t}\n\t}\n\n\t// Violation-based coaching\n\tif ((violationCount ?? 0) > 3) {\n\t\treturn `I've noticed ${violationCount} violations this session. Want me to pull up relevant learnings?`;\n\t}\n\n\treturn null;\n}\n\nfunction randomChoice<T>(arr: T[]): T {\n\treturn arr[Math.floor(Math.random() * arr.length)];\n}\n\n// ============================================================================\n// Snapshot Deduplication\n// ============================================================================\n\n/**\n * Compute hash for a file's content (truncated for display)\n * @deprecated Use hashContent from @snapback-oss/sdk for full hash\n */\nexport function hashFileContent(content: string): string {\n\treturn hashContent(content).slice(0, 16);\n}\n\n/**\n * Compute full SHA-256 blob ID (matches storage.ts format)\n * Re-exported from @snapback-oss/sdk/utils/hash for convenience.\n *\n * @see {@link hashContent} from @snapback-oss/sdk\n */\nexport const computeBlobId = hashContent;\n\n/**\n * Get file hashes for comparison (using full blobId format)\n */\nexport function getFileHashes(filePaths: string[], workspaceRoot: string): FileHash[] {\n\tconst hashes: FileHash[] = [];\n\n\tfor (const filePath of filePaths) {\n\t\tconst fullPath = filePath.startsWith(\"/\") ? filePath : `${workspaceRoot}/${filePath}`;\n\t\tif (existsSync(fullPath)) {\n\t\t\tconst content = readFileSync(fullPath, \"utf8\");\n\t\t\thashes.push({\n\t\t\t\tpath: filePath,\n\t\t\t\thash: computeBlobId(content), // Use full hash to match blobId\n\t\t\t\tsize: content.length,\n\t\t\t});\n\t\t}\n\t}\n\n\treturn hashes;\n}\n\n/**\n * Check if ALL requested files are unchanged in a snapshot.\n *\n * Fixed logic:\n * - Compares by intersection (handles subset requests)\n * - Uses blobId directly from snapshot (no restore needed)\n * - Returns true only if ALL current files have matching blobId in snapshot\n */\nexport function filesMatchSnapshot(\n\tcurrentHashes: FileHash[],\n\tsnapshotFiles: Array<{ path: string; blobId?: string; hash?: string; content?: string }>,\n): boolean {\n\t// Build map of snapshot file paths to their blob IDs\n\tconst snapshotBlobMap = new Map<string, string>();\n\tfor (const file of snapshotFiles) {\n\t\t// Prefer blobId (from snapshot manifest), fall back to hash, then compute from content\n\t\tconst blobId = file.blobId || file.hash || (file.content ? computeBlobId(file.content) : \"\");\n\t\tif (blobId) {\n\t\t\tsnapshotBlobMap.set(file.path, blobId);\n\t\t}\n\t}\n\n\t// Check if ALL current files have matching blobId in snapshot\n\tfor (const current of currentHashes) {\n\t\tconst snapshotBlobId = snapshotBlobMap.get(current.path);\n\t\tif (!snapshotBlobId) {\n\t\t\t// File not in snapshot - not a match\n\t\t\treturn false;\n\t\t}\n\t\tif (snapshotBlobId !== current.hash) {\n\t\t\t// File changed since snapshot - not a match\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t// All requested files match their snapshot versions\n\treturn true;\n}\n\n/**\n * Check if files are unchanged across ANY recent snapshot.\n * More efficient than filesMatchSnapshot for checking against multiple snapshots.\n */\nexport function findMatchingSnapshot(\n\tcurrentHashes: FileHash[],\n\tsnapshots: Array<{\n\t\tid: string;\n\t\tcreatedAt: number;\n\t\tfiles: Array<{ path: string; blobId: string }>;\n\t}>,\n\tmaxSnapshotsToCheck = 5,\n): { matched: boolean; snapshotId?: string; createdAt?: number } {\n\t// Check most recent snapshots first\n\tfor (const snapshot of snapshots.slice(0, maxSnapshotsToCheck)) {\n\t\tif (filesMatchSnapshot(currentHashes, snapshot.files)) {\n\t\t\treturn { matched: true, snapshotId: snapshot.id, createdAt: snapshot.createdAt };\n\t\t}\n\t}\n\treturn { matched: false };\n}\n\n// ============================================================================\n// Learning Staleness\n// ============================================================================\n\nexport interface LearningMetadata {\n\tvalidUntil?: string; // ISO date\n\tarchitectureVersion?: string;\n\tdeprecated?: boolean;\n\tdeprecatedReason?: string;\n}\n\n/**\n * Check if a learning is stale\n */\nexport function isLearningStalel(learning: { timestamp?: string } & LearningMetadata, maxAgeDays = 90): boolean {\n\t// Explicitly deprecated\n\tif (learning.deprecated) {\n\t\treturn true;\n\t}\n\n\t// Past validity date\n\tif (learning.validUntil && new Date(learning.validUntil) < new Date()) {\n\t\treturn true;\n\t}\n\n\t// Too old (default 90 days)\n\tif (learning.timestamp) {\n\t\tconst age = Date.now() - new Date(learning.timestamp).getTime();\n\t\tconst ageDays = age / (1000 * 60 * 60 * 24);\n\t\tif (ageDays > maxAgeDays) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n/**\n * Filter learnings to exclude stale ones\n */\nexport function filterStaleLearnings<T extends { timestamp?: string } & LearningMetadata>(\n\tlearnings: T[],\n\tmaxAgeDays = 90,\n): { valid: T[]; stale: T[] } {\n\tconst valid: T[] = [];\n\tconst stale: T[] = [];\n\n\tfor (const learning of learnings) {\n\t\tif (isLearningStalel(learning, maxAgeDays)) {\n\t\t\tstale.push(learning);\n\t\t} else {\n\t\t\tvalid.push(learning);\n\t\t}\n\t}\n\n\treturn { valid, stale };\n}\n\n// ============================================================================\n// Session Completion Tracking\n// ============================================================================\n\nexport interface SessionChecklist {\n\ttasksStarted: string[];\n\ttasksCompleted: string[];\n\tpendingValidations: string[]; // files changed but not validated\n\tuncommittedChanges: boolean;\n\tcompletionPercentage: number;\n\tprompt?: string;\n}\n\n/**\n * Build session completion status\n */\nexport function buildSessionChecklist(session: {\n\tplannedFiles?: string[];\n\tmodifiedFiles?: string[];\n\tvalidatedFiles?: string[];\n\tsnapshotCount?: number;\n}): SessionChecklist {\n\tconst planned = session.plannedFiles || [];\n\tconst modified = session.modifiedFiles || [];\n\tconst validated = session.validatedFiles || [];\n\n\tconst pendingValidations = modified.filter((f) => !validated.includes(f));\n\tconst uncommittedChanges = modified.length > 0;\n\n\tconst totalTasks = planned.length || 1;\n\tconst completedTasks = validated.length;\n\tconst completionPercentage = Math.round((completedTasks / totalTasks) * 100);\n\n\tlet prompt: string | undefined;\n\tif (pendingValidations.length > 0) {\n\t\tprompt = ` ${pendingValidations.length} file(s) modified but not validated. Run check_patterns before committing.`;\n\t} else if (uncommittedChanges && (session.snapshotCount ?? 0) === 0) {\n\t\tprompt = \" Consider creating a snapshot before ending session.\";\n\t}\n\n\treturn {\n\t\ttasksStarted: planned,\n\t\ttasksCompleted: validated,\n\t\tpendingValidations,\n\t\tuncommittedChanges,\n\t\tcompletionPercentage,\n\t\tprompt,\n\t};\n}\n\n// ============================================================================\n// Cleanup Helpers\n// ============================================================================\n\nexport interface CleanupStats {\n\tfound: number;\n\tstale: number;\n\tdeleted: number;\n\tbytesReclaimed?: number;\n}\n\nexport interface CleanupResult {\n\tsnapshots: CleanupStats;\n\tlearnings: CleanupStats;\n\tsessions: CleanupStats;\n\tblobs: CleanupStats & { orphaned: number };\n\ttotalBytesReclaimed: number;\n}\n\n/**\n * Format bytes to human-readable string\n */\nexport function formatBytes(bytes: number): string {\n\tif (bytes === 0) return \"0 B\";\n\tconst units = [\"B\", \"KB\", \"MB\", \"GB\"];\n\tconst i = Math.floor(Math.log(bytes) / Math.log(1024));\n\tconst value = bytes / 1024 ** i;\n\treturn `${value.toFixed(1)} ${units[i]}`;\n}\n\n/**\n * Get current architecture version from .ctx or git\n * Used to detect stale learnings after architecture changes\n */\nexport function getArchitectureVersion(workspaceRoot: string): string | null {\n\tconst ctxPath = `${workspaceRoot}/.snapback/ctx/context.json`;\n\ttry {\n\t\tif (existsSync(ctxPath)) {\n\t\t\tconst ctx = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\treturn ctx.archVersion || ctx.updated_at || null;\n\t\t}\n\t} catch {\n\t\t// Ignore parse errors\n\t}\n\treturn null;\n}\n\n/**\n * Clean up stale learnings based on age and architecture version\n */\nexport function cleanupStaleLearnings(\n\tlearningsPath: string,\n\topts: { maxAgeDays?: number; archVersion?: string | null; dryRun?: boolean },\n): CleanupStats {\n\tif (!existsSync(learningsPath)) {\n\t\treturn { found: 0, stale: 0, deleted: 0 };\n\t}\n\n\ttry {\n\t\tconst content = readFileSync(learningsPath, \"utf8\");\n\t\tconst lines = content.split(\"\\n\").filter(Boolean);\n\t\tconst learnings = lines\n\t\t\t.map((line) => {\n\t\t\t\ttry {\n\t\t\t\t\treturn JSON.parse(line);\n\t\t\t\t} catch {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t})\n\t\t\t.filter(Boolean);\n\n\t\tconst { valid, stale } = filterStaleLearnings(learnings, opts.maxAgeDays || 90);\n\n\t\t// Also mark as stale if architecture version mismatch\n\t\tlet archStale: typeof learnings = [];\n\t\tif (opts.archVersion) {\n\t\t\tarchStale = valid.filter((l) => l.archVersion && l.archVersion !== opts.archVersion);\n\t\t}\n\n\t\tconst allStale = [...stale, ...archStale];\n\t\tconst remaining = valid.filter((l) => !archStale.includes(l));\n\n\t\tif (!opts.dryRun && allStale.length > 0) {\n\t\t\t// Write back only valid learnings\n\t\t\tconst newContent = remaining.map((l) => JSON.stringify(l)).join(\"\\n\") + \"\\n\";\n\t\t\twriteFileSync(learningsPath, newContent);\n\t\t}\n\n\t\treturn {\n\t\t\tfound: learnings.length,\n\t\t\tstale: allStale.length,\n\t\t\tdeleted: opts.dryRun ? 0 : allStale.length,\n\t\t};\n\t} catch {\n\t\treturn { found: 0, stale: 0, deleted: 0 };\n\t}\n}\n\n/**\n * Clean up archived sessions\n */\nexport function cleanupArchivedSessions(\n\tsessionArchiveDir: string,\n\topts: { maxAgeDays?: number; dryRun?: boolean },\n): CleanupStats {\n\tif (!existsSync(sessionArchiveDir)) {\n\t\treturn { found: 0, stale: 0, deleted: 0 };\n\t}\n\n\ttry {\n\t\tconst files = readdirSync(sessionArchiveDir).filter((f) => f.endsWith(\".json\"));\n\t\tconst cutoff = Date.now() - (opts.maxAgeDays || 30) * 24 * 60 * 60 * 1000;\n\t\tconst stale: string[] = [];\n\n\t\tfor (const file of files) {\n\t\t\tconst filePath = `${sessionArchiveDir}/${file}`;\n\t\t\ttry {\n\t\t\t\tconst session = JSON.parse(readFileSync(filePath, \"utf8\"));\n\t\t\t\tconst endedAt = new Date(session.endedAt || session.startedAt).getTime();\n\t\t\t\tif (endedAt < cutoff) {\n\t\t\t\t\tstale.push(filePath);\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Skip unparseable files\n\t\t\t}\n\t\t}\n\n\t\tif (!opts.dryRun) {\n\t\t\tfor (const filePath of stale) {\n\t\t\t\ttry {\n\t\t\t\t\tunlinkSync(filePath);\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore delete errors\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tfound: files.length,\n\t\t\tstale: stale.length,\n\t\t\tdeleted: opts.dryRun ? 0 : stale.length,\n\t\t};\n\t} catch {\n\t\treturn { found: 0, stale: 0, deleted: 0 };\n\t}\n}\n","/**\n * Composite Tool: review_work\n *\n * Comprehensive pre-commit review that combines:\n * - Pattern checking (7-layer validation)\n * - Change summary\n * - Learning suggestions\n * - Suggested commit message\n *\n * @see pair_programmer.md Section 2.4\n * @module facades/review-work\n */\n\nimport { execSync } from \"node:child_process\";\nimport { existsSync, readFileSync } from \"node:fs\";\nimport { basename, join } from \"node:path\";\nimport type { ToolHandler, ToolResult } from \"../registry.js\";\nimport {\n\tformatDuration,\n\tgetBaselineFileSet,\n\tgetCurrentTask,\n\tgetSessionState,\n\tpushObservation,\n} from \"../session/state.js\";\nimport { getIntelligence } from \"./intelligence.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface ReviewWorkInput {\n\t/** Skip pattern validation (default: false) */\n\tskipPatterns?: boolean;\n\t/** Include suggested commit message (default: true) */\n\tincludeCommitMessage?: boolean;\n\t/** Specific files to review (default: all changed files) */\n\tfiles?: string[];\n}\n\ninterface ValidationIssue {\n\tlayer: string;\n\tseverity: \"error\" | \"warning\" | \"info\";\n\tmessage: string;\n\tfile?: string;\n\tline?: number;\n}\n\ninterface ReviewWorkOutput {\n\ttaskId: string | null;\n\ttaskDescription: string | null;\n\tduration: string;\n\treadyToCommit: boolean;\n\tvalidation: {\n\t\tpassed: boolean;\n\t\tissues: ValidationIssue[];\n\t\tlayerSummary: Array<{\n\t\t\tlayer: string;\n\t\t\tpassed: boolean;\n\t\t\tissueCount: number;\n\t\t}>;\n\t};\n\tchanges: {\n\t\tfileCount: number;\n\t\tlinesAdded: number;\n\t\tlinesRemoved: number;\n\t\tfiles: Array<{\n\t\t\tfile: string;\n\t\t\tstatus: \"A\" | \"M\" | \"D\";\n\t\t\tlinesChanged: number;\n\t\t}>;\n\t};\n\tsuggestedCommitMessage?: string;\n\tsuggestedLearnings: Array<{\n\t\ttype: \"pattern\" | \"pitfall\" | \"efficiency\";\n\t\ttrigger: string;\n\t\taction: string;\n\t}>;\n\tnextActions: Array<{\n\t\ttool: string;\n\t\tpriority: number;\n\t\treason: string;\n\t}>;\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Get git diff stats with timeout and task-scoped filtering\n * @param workspaceRoot - Workspace root directory\n * @param baselineFiles - Files that existed before task started (to exclude)\n * @returns Object with files, linesAdded, linesRemoved\n */\nfunction getGitDiffStats(\n\tworkspaceRoot: string,\n\tbaselineFiles?: Set<string>,\n): {\n\tfiles: Array<{ file: string; status: \"A\" | \"M\" | \"D\"; linesChanged: number }>;\n\tlinesAdded: number;\n\tlinesRemoved: number;\n} {\n\tconst files: Array<{ file: string; status: \"A\" | \"M\" | \"D\"; linesChanged: number }> = [];\n\tlet linesAdded = 0;\n\tlet linesRemoved = 0;\n\n\ttry {\n\t\t// Get numstat for line counts with timeout\n\t\tconst numstat = execSync(\"git diff --numstat HEAD\", {\n\t\t\tcwd: workspaceRoot,\n\t\t\tencoding: \"utf8\",\n\t\t\ttimeout: 5000, // 5s timeout to prevent blocking\n\t\t});\n\n\t\tfor (const line of numstat.split(\"\\n\")) {\n\t\t\tif (!line.trim()) continue;\n\t\t\tconst [added, removed, file] = line.split(\"\\t\");\n\t\t\tif (file) {\n\t\t\t\t// Skip files that were in baseline (modified before task started)\n\t\t\t\tif (baselineFiles?.has(file)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst a = added === \"-\" ? 0 : Number.parseInt(added, 10);\n\t\t\t\tconst r = removed === \"-\" ? 0 : Number.parseInt(removed, 10);\n\t\t\t\tlinesAdded += a;\n\t\t\t\tlinesRemoved += r;\n\t\t\t\tfiles.push({\n\t\t\t\t\tfile,\n\t\t\t\t\tstatus: \"M\",\n\t\t\t\t\tlinesChanged: a + r,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Get status for new/deleted files with timeout\n\t\tconst status = execSync(\"git status --porcelain\", {\n\t\t\tcwd: workspaceRoot,\n\t\t\tencoding: \"utf8\",\n\t\t\ttimeout: 5000, // 5s timeout to prevent blocking\n\t\t});\n\n\t\tfor (const line of status.split(\"\\n\")) {\n\t\t\tif (!line.trim()) continue;\n\t\t\tconst statusCode = line.substring(0, 2);\n\t\t\tconst file = line.substring(3).trim();\n\n\t\t\t// Skip files that were in baseline (modified before task started)\n\t\t\tif (baselineFiles?.has(file)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst existing = files.find((f) => f.file === file);\n\t\t\tif (existing) {\n\t\t\t\tif (statusCode.includes(\"A\") || statusCode === \"??\") {\n\t\t\t\t\texisting.status = \"A\";\n\t\t\t\t} else if (statusCode.includes(\"D\")) {\n\t\t\t\t\texisting.status = \"D\";\n\t\t\t\t}\n\t\t\t} else if (statusCode === \"??\" || statusCode.includes(\"A\")) {\n\t\t\t\t// New untracked file\n\t\t\t\tfiles.push({ file, status: \"A\", linesChanged: 0 });\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// Git not available, timeout, or not a git repo\n\t}\n\n\treturn { files, linesAdded, linesRemoved };\n}\n\n/**\n * Generate commit message from changes\n */\nfunction generateCommitMessage(\n\ttaskDescription: string | null,\n\tfiles: Array<{ file: string; status: \"A\" | \"M\" | \"D\" }>,\n): string {\n\t// Determine type from files\n\tlet type = \"chore\";\n\tconst lowerDesc = (taskDescription || \"\").toLowerCase();\n\n\tif (lowerDesc.includes(\"fix\") || lowerDesc.includes(\"bug\")) {\n\t\ttype = \"fix\";\n\t} else if (lowerDesc.includes(\"add\") || lowerDesc.includes(\"implement\") || lowerDesc.includes(\"feature\")) {\n\t\ttype = \"feat\";\n\t} else if (lowerDesc.includes(\"test\")) {\n\t\ttype = \"test\";\n\t} else if (lowerDesc.includes(\"refactor\")) {\n\t\ttype = \"refactor\";\n\t} else if (lowerDesc.includes(\"doc\")) {\n\t\ttype = \"docs\";\n\t}\n\n\t// Determine scope from files\n\tlet scope = \"\";\n\tconst scopes = new Set<string>();\n\n\tfor (const { file } of files) {\n\t\tconst parts = file.split(\"/\");\n\t\tif (parts.length >= 2) {\n\t\t\t// apps/vscode -> vscode, packages/mcp -> mcp\n\t\t\tif (parts[0] === \"apps\" || parts[0] === \"packages\") {\n\t\t\t\tscopes.add(parts[1]);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (scopes.size === 1) {\n\t\tscope = Array.from(scopes)[0];\n\t} else if (scopes.size > 1) {\n\t\tscope = \"multiple\";\n\t}\n\n\t// Build message\n\tconst subject = taskDescription\n\t\t? taskDescription.replace(/^(add|fix|implement|update|refactor)\\s+/i, \"\").trim()\n\t\t: `update ${files.length} file(s)`;\n\n\tconst scopePart = scope ? `(${scope})` : \"\";\n\treturn `${type}${scopePart}: ${subject}`;\n}\n\n/**\n * Suggest learnings from the work done\n */\nfunction suggestLearnings(\n\tfiles: Array<{ file: string; status: string }>,\n\tissues: ValidationIssue[],\n): Array<{ type: \"pattern\" | \"pitfall\" | \"efficiency\"; trigger: string; action: string }> {\n\tconst suggestions: Array<{ type: \"pattern\" | \"pitfall\" | \"efficiency\"; trigger: string; action: string }> = [];\n\n\t// If there were validation issues, suggest a pitfall\n\tconst errorCount = issues.filter((i) => i.severity === \"error\").length;\n\tif (errorCount > 0) {\n\t\tsuggestions.push({\n\t\t\ttype: \"pitfall\",\n\t\t\ttrigger: `Working on ${files.map((f) => basename(f.file)).join(\", \")}`,\n\t\t\taction: `Check for ${issues[0]?.layer || \"validation\"} issues before committing`,\n\t\t});\n\t}\n\n\t// If working with many files, suggest breaking down\n\tif (files.length > 5) {\n\t\tsuggestions.push({\n\t\t\ttype: \"efficiency\",\n\t\t\ttrigger: \"Large multi-file change\",\n\t\t\taction: \"Consider breaking into smaller, focused commits\",\n\t\t});\n\t}\n\n\t// If touching test files, suggest pattern\n\tconst hasTests = files.some((f) => f.file.includes(\".test.\") || f.file.includes(\".spec.\"));\n\tif (hasTests) {\n\t\tsuggestions.push({\n\t\t\ttype: \"pattern\",\n\t\t\ttrigger: \"Adding/modifying tests\",\n\t\t\taction: \"Run tests locally before pushing to CI\",\n\t\t});\n\t}\n\n\treturn suggestions.slice(0, 3); // Max 3 suggestions\n}\n\n// =============================================================================\n// HANDLER\n// =============================================================================\n\nfunction result(text: string, isError = false): ToolResult {\n\treturn {\n\t\tcontent: [{ type: \"text\", text }],\n\t\tisError,\n\t};\n}\n\n/**\n * review_work - Comprehensive pre-commit review\n */\nexport const handleReviewWork: ToolHandler = async (args, context): Promise<ToolResult> => {\n\tconst { skipPatterns = false, includeCommitMessage = true, files: filterFiles } = args as ReviewWorkInput;\n\n\tconst workspaceRoot = context.workspaceRoot;\n\tconst state = getSessionState(workspaceRoot);\n\tconst task = getCurrentTask(workspaceRoot);\n\n\t// Get baseline files (files that were modified BEFORE task started)\n\t// This enables task-scoped filtering to only show changes made during this task\n\tconst baselineFiles = getBaselineFileSet(workspaceRoot);\n\n\t// Get change stats with task-scoped filtering\n\tlet { files, linesAdded, linesRemoved } = getGitDiffStats(workspaceRoot, baselineFiles);\n\n\t// Filter files if specified\n\tif (filterFiles && filterFiles.length > 0) {\n\t\tfiles = files.filter((f) => filterFiles.some((filter) => f.file.includes(filter) || filter.includes(f.file)));\n\t}\n\n\t// Run validation if not skipped\n\tconst issues: ValidationIssue[] = [];\n\tconst layerSummary: Array<{ layer: string; passed: boolean; issueCount: number }> = [];\n\tlet validationPassed = true;\n\n\tif (!skipPatterns && files.length > 0) {\n\t\ttry {\n\t\t\tconst intel = getIntelligence(workspaceRoot);\n\n\t\t\t// Validate each file\n\t\t\tfor (const { file, status } of files.slice(0, 10)) {\n\t\t\t\t// Limit to 10 files\n\t\t\t\tif (status === \"D\") continue; // Skip deleted files\n\n\t\t\t\tconst fullPath = join(workspaceRoot, file);\n\t\t\t\tif (!existsSync(fullPath)) continue;\n\n\t\t\t\ttry {\n\t\t\t\t\tconst code = readFileSync(fullPath, \"utf8\");\n\t\t\t\t\tconst result = await intel.checkPatterns(code, file);\n\n\t\t\t\t\tif (!result.overall.passed) {\n\t\t\t\t\t\tvalidationPassed = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tfor (const layer of result.layers) {\n\t\t\t\t\t\t// Aggregate by layer\n\t\t\t\t\t\tconst existing = layerSummary.find((l) => l.layer === layer.layer);\n\t\t\t\t\t\tif (existing) {\n\t\t\t\t\t\t\texisting.issueCount += layer.issues.length;\n\t\t\t\t\t\t\tif (!layer.passed) existing.passed = false;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlayerSummary.push({\n\t\t\t\t\t\t\t\tlayer: layer.layer,\n\t\t\t\t\t\t\t\tpassed: layer.passed,\n\t\t\t\t\t\t\t\tissueCount: layer.issues.length,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Add individual issues\n\t\t\t\t\t\tfor (const issue of layer.issues) {\n\t\t\t\t\t\t\tconst issueMessage =\n\t\t\t\t\t\t\t\ttypeof issue === \"string\"\n\t\t\t\t\t\t\t\t\t? issue\n\t\t\t\t\t\t\t\t\t: (issue as { message?: string }).message || String(issue);\n\t\t\t\t\t\t\tissues.push({\n\t\t\t\t\t\t\t\tlayer: layer.layer,\n\t\t\t\t\t\t\t\tseverity: \"error\",\n\t\t\t\t\t\t\t\tmessage: issueMessage,\n\t\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Individual file validation failed\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// Intelligence not available\n\t\t\tlayerSummary.push({\n\t\t\t\tlayer: \"validation\",\n\t\t\t\tpassed: true,\n\t\t\t\tissueCount: 0,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Generate commit message\n\tlet suggestedCommitMessage: string | undefined;\n\tif (includeCommitMessage) {\n\t\tsuggestedCommitMessage = generateCommitMessage(task?.description ?? null, files);\n\t}\n\n\t// Suggest learnings\n\tconst suggestedLearnings = suggestLearnings(files, issues);\n\n\t// Save suggested learnings to session for later acceptance\n\tif (suggestedLearnings.length > 0) {\n\t\tstate.pendingSuggestedLearnings = suggestedLearnings;\n\t}\n\n\t// Determine if ready to commit\n\tconst readyToCommit = validationPassed && files.length > 0;\n\n\t// Build next actions\n\tconst nextActions: Array<{ tool: string; priority: number; reason: string }> = [];\n\n\tif (!validationPassed) {\n\t\tnextActions.push({\n\t\t\ttool: \"validate\",\n\t\t\tpriority: 1,\n\t\t\treason: \"Fix validation issues before committing\",\n\t\t});\n\t}\n\n\tif (readyToCommit) {\n\t\tnextActions.push({\n\t\t\ttool: \"complete_task\",\n\t\t\tpriority: 1,\n\t\t\treason: \"Finalize task and optionally capture learnings\",\n\t\t});\n\t}\n\n\tif (suggestedLearnings.length > 0) {\n\t\tnextActions.push({\n\t\t\ttool: \"learn\",\n\t\t\tpriority: 3,\n\t\t\treason: `${suggestedLearnings.length} learning(s) suggested from this work`,\n\t\t});\n\t}\n\n\t// Push observation about review completion\n\tpushObservation(workspaceRoot, {\n\t\ttype: readyToCommit ? \"progress\" : \"warning\",\n\t\tmessage: readyToCommit\n\t\t\t? `Review complete: ${files.length} file(s) ready to commit`\n\t\t\t: `Review found ${issues.length} issue(s) to address`,\n\t\ttimestamp: Date.now(),\n\t});\n\n\t// Calculate duration\n\tconst duration = task ? formatDuration(Date.now() - task.startedAt) : \"No active task\";\n\n\tconst output: ReviewWorkOutput = {\n\t\ttaskId: task?.id ?? null,\n\t\ttaskDescription: task?.description ?? null,\n\t\tduration,\n\t\treadyToCommit,\n\t\tvalidation: {\n\t\t\tpassed: validationPassed,\n\t\t\tissues: issues.slice(0, 20), // Limit issues\n\t\t\tlayerSummary,\n\t\t},\n\t\tchanges: {\n\t\t\tfileCount: files.length,\n\t\t\tlinesAdded,\n\t\t\tlinesRemoved,\n\t\t\tfiles: files.slice(0, 20), // Limit files\n\t\t},\n\t\tsuggestedCommitMessage,\n\t\tsuggestedLearnings,\n\t\tnextActions,\n\t};\n\n\treturn result(\n\t\tJSON.stringify(\n\t\t\t{\n\t\t\t\t...output,\n\t\t\t\t_hint: readyToCommit\n\t\t\t\t\t? `Ready to commit! Suggested: ${suggestedCommitMessage}`\n\t\t\t\t\t: `${issues.length} issue(s) found. Fix them before committing.`,\n\t\t\t},\n\t\t\tnull,\n\t\t\t2,\n\t\t),\n\t);\n};\n","/**\n * Composite Tool: what_changed\n *\n * Tracks changes since task start, provides file diffs,\n * and surfaces AI attribution from the extension.\n *\n * @see pair_programmer.md Section 2.3\n * @module facades/what-changed\n */\n\nimport { execSync } from \"node:child_process\";\nimport { relative } from \"node:path\";\nimport { getSessionChangesViaDaemon } from \"../daemon/client-facade.js\";\nimport type { ToolHandler, ToolResult } from \"../registry.js\";\nimport { getSessionFileTracker } from \"../services/session-file-tracker.js\";\nimport { formatDuration, getBaselineFileSet, getCurrentTask } from \"../session/state.js\";\nimport { getIntelligence } from \"./intelligence.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface WhatChangedInput {\n\t/** Include full diffs (default: summary only) */\n\tincludeDiff?: boolean;\n\t/** Only show changes to these files */\n\tfilterFiles?: string[];\n\t/** Include AI attribution info (default: true) */\n\tincludeAIAttribution?: boolean;\n}\n\ninterface ChangeSummary {\n\tfile: string;\n\ttype: \"created\" | \"modified\" | \"deleted\";\n\tlinesChanged: number;\n\taiAttributed: boolean;\n\ttimestamp: number;\n}\n\ninterface WhatChangedOutput {\n\ttaskId: string | null;\n\ttaskDescription: string | null;\n\tduration: string;\n\tchanges: ChangeSummary[];\n\tstats: {\n\t\ttotalFiles: number;\n\t\ttotalLines: number;\n\t\taiAttributedFiles: number;\n\t\taiAttributedLines: number;\n\t};\n\tdiffs?: Array<{\n\t\tfile: string;\n\t\tdiff: string;\n\t}>;\n\triskAssessment: {\n\t\tlevel: \"low\" | \"medium\" | \"high\";\n\t\tfactors: string[];\n\t};\n\tnextActions: Array<{\n\t\ttool: string;\n\t\tpriority: number;\n\t\treason: string;\n\t}>;\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Get git diff for a file\n * @param file - File path relative to workspace\n * @param workspaceRoot - Workspace root directory\n * @returns Diff string or null if unavailable/timeout\n */\nfunction getFileDiff(file: string, workspaceRoot: string): string | null {\n\ttry {\n\t\tconst result = execSync(`git diff --no-color -- \"${file}\"`, {\n\t\t\tcwd: workspaceRoot,\n\t\t\tencoding: \"utf8\",\n\t\t\tmaxBuffer: 1024 * 1024, // 1MB\n\t\t\ttimeout: 5000, // 5s timeout to prevent blocking\n\t\t});\n\t\treturn result.trim() || null;\n\t} catch {\n\t\t// Git not available, timeout, or file not found\n\t\treturn null;\n\t}\n}\n\n/**\n * Get git status for staged/unstaged changes\n * @param workspaceRoot - Workspace root directory\n * @returns Map of file paths to change status\n */\nfunction getGitChanges(workspaceRoot: string): Map<string, \"A\" | \"M\" | \"D\"> {\n\tconst changes = new Map<string, \"A\" | \"M\" | \"D\">();\n\n\ttry {\n\t\t// Get both staged and unstaged with timeout\n\t\tconst result = execSync(\"git status --porcelain\", {\n\t\t\tcwd: workspaceRoot,\n\t\t\tencoding: \"utf8\",\n\t\t\ttimeout: 5000, // 5s timeout to prevent blocking\n\t\t});\n\n\t\tfor (const line of result.split(\"\\n\")) {\n\t\t\tif (!line.trim()) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst status = line.substring(0, 2);\n\t\t\tconst file = line.substring(3).trim();\n\n\t\t\tif (status.includes(\"A\") || status === \"??\") {\n\t\t\t\tchanges.set(file, \"A\");\n\t\t\t} else if (status.includes(\"D\")) {\n\t\t\t\tchanges.set(file, \"D\");\n\t\t\t} else if (status.includes(\"M\") || status.includes(\"U\")) {\n\t\t\t\tchanges.set(file, \"M\");\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// Git not available, timeout, or not a git repo\n\t}\n\n\treturn changes;\n}\n\n/**\n * Count lines changed in a diff\n */\nfunction countLinesChanged(diff: string): number {\n\tlet count = 0;\n\tfor (const line of diff.split(\"\\n\")) {\n\t\tif (line.startsWith(\"+\") && !line.startsWith(\"+++\")) {\n\t\t\tcount++;\n\t\t} else if (line.startsWith(\"-\") && !line.startsWith(\"---\")) {\n\t\t\tcount++;\n\t\t}\n\t}\n\treturn count;\n}\n\n/**\n * Assess risk based on changes\n */\nfunction assessChangeRisk(changes: ChangeSummary[]): { level: \"low\" | \"medium\" | \"high\"; factors: string[] } {\n\tconst factors: string[] = [];\n\n\t// Check for critical files\n\tconst criticalPatterns = [\"auth\", \"payment\", \"security\", \"config\", \"migration\", \"env\"];\n\tfor (const change of changes) {\n\t\tconst lowerFile = change.file.toLowerCase();\n\t\tfor (const pattern of criticalPatterns) {\n\t\t\tif (lowerFile.includes(pattern)) {\n\t\t\t\tfactors.push(`Critical file modified: ${change.file}`);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check AI attribution ratio\n\tconst aiFiles = changes.filter((c) => c.aiAttributed).length;\n\tconst aiRatio = changes.length > 0 ? aiFiles / changes.length : 0;\n\tif (aiRatio > 0.7 && changes.length >= 3) {\n\t\tfactors.push(`High AI-attribution ratio: ${Math.round(aiRatio * 100)}% of changes`);\n\t}\n\n\t// Check total lines\n\tconst totalLines = changes.reduce((sum, c) => sum + c.linesChanged, 0);\n\tif (totalLines > 500) {\n\t\tfactors.push(`Large change set: ${totalLines} lines`);\n\t}\n\n\t// Determine level\n\tlet level: \"low\" | \"medium\" | \"high\" = \"low\";\n\tif (factors.length >= 3) {\n\t\tlevel = \"high\";\n\t} else if (factors.length >= 1) {\n\t\tlevel = \"medium\";\n\t}\n\n\treturn { level, factors };\n}\n\n// =============================================================================\n// HANDLER\n// =============================================================================\n\nfunction result(text: string, isError = false): ToolResult {\n\treturn {\n\t\tcontent: [{ type: \"text\", text }],\n\t\tisError,\n\t};\n}\n\n/**\n * what_changed - Track changes since task start\n *\n * IMPORTANT: Only shows changes made AFTER the current task started.\n * Uses git baseline captured at task start to filter out pre-existing changes.\n *\n * DAEMON-FIRST ARCHITECTURE:\n * 1. Try to get changes from daemon for cross-surface coordination\n * 2. If daemon unavailable, fall back to local Intelligence + git\n */\nexport const handleWhatChanged: ToolHandler = async (args, context): Promise<ToolResult> => {\n\tconst { includeDiff = false, filterFiles, includeAIAttribution = true } = args as WhatChangedInput;\n\n\tconst workspaceRoot = context.workspaceRoot;\n\tconst task = getCurrentTask(workspaceRoot);\n\n\t// If no active task, return clear message instead of random git changes\n\tif (!task) {\n\t\treturn result(\n\t\t\tJSON.stringify(\n\t\t\t\t{\n\t\t\t\t\ttaskId: null,\n\t\t\t\t\ttaskDescription: null,\n\t\t\t\t\tduration: \"No active task\",\n\t\t\t\t\tchanges: [],\n\t\t\t\t\tstats: {\n\t\t\t\t\t\ttotalFiles: 0,\n\t\t\t\t\t\ttotalLines: 0,\n\t\t\t\t\t\taiAttributedFiles: 0,\n\t\t\t\t\t\taiAttributedLines: 0,\n\t\t\t\t\t},\n\t\t\t\t\triskAssessment: { level: \"low\", factors: [] },\n\t\t\t\t\tnextActions: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttool: \"begin_task\",\n\t\t\t\t\t\t\tpriority: 1,\n\t\t\t\t\t\t\treason: \"Start a task to begin tracking changes\",\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\t_hint: \"No active task. Use begin_task to start tracking changes.\",\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\t2,\n\t\t\t),\n\t\t);\n\t}\n\n\t// =========================================================================\n\t// DAEMON-FIRST: Try getting changes from daemon\n\t// =========================================================================\n\tconst daemonChanges = await getSessionChangesViaDaemon(workspaceRoot, {\n\t\tincludeDiff,\n\t\tfilterFiles,\n\t\tincludeAIAttribution,\n\t});\n\n\tif (daemonChanges) {\n\t\t// Daemon is available - use its response\n\t\t// This includes changes from Extension, CLI, and MCP across all surfaces\n\n\t\tconst duration = formatDuration(Date.now() - task.startedAt);\n\n\t\t// Convert daemon response to our output format\n\t\tconst changes: ChangeSummary[] = daemonChanges.files.map((f) => ({\n\t\t\tfile: f.path,\n\t\t\ttype: f.status,\n\t\t\tlinesChanged: f.linesChanged,\n\t\t\taiAttributed: f.aiAttributed ?? false,\n\t\t\ttimestamp: Date.now(), // Daemon doesn't track timestamps per-file\n\t\t}));\n\n\t\t// Get diffs if requested (still need to fetch locally)\n\t\tlet diffs: Array<{ file: string; diff: string }> | undefined;\n\t\tif (includeDiff) {\n\t\t\tdiffs = [];\n\t\t\tfor (const change of changes.slice(0, 10)) {\n\t\t\t\tif (change.type !== \"deleted\") {\n\t\t\t\t\tconst diff = getFileDiff(change.file, workspaceRoot);\n\t\t\t\t\tif (diff) {\n\t\t\t\t\t\tdiffs.push({\n\t\t\t\t\t\t\tfile: change.file,\n\t\t\t\t\t\t\tdiff: diff.length > 2000 ? `${diff.slice(0, 2000)}\\n...(truncated)` : diff,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Risk assessment from daemon\n\t\tconst riskAssessment = assessChangeRisk(changes);\n\n\t\t// Build next actions\n\t\tconst nextActions: Array<{ tool: string; priority: number; reason: string }> = [];\n\t\tif (daemonChanges.totalLinesChanged > 0) {\n\t\t\tnextActions.push({ tool: \"quick_check\", priority: 1, reason: \"Validate changes before proceeding\" });\n\t\t}\n\t\tif (riskAssessment.level === \"high\") {\n\t\t\tnextActions.push({\n\t\t\t\ttool: \"snapshot_create\",\n\t\t\t\tpriority: 1,\n\t\t\t\treason: \"Create safety snapshot for high-risk changes\",\n\t\t\t});\n\t\t}\n\t\tif (changes.length > 0) {\n\t\t\tnextActions.push({ tool: \"review_work\", priority: 2, reason: \"Review changes before committing\" });\n\t\t}\n\n\t\tconst output: WhatChangedOutput = {\n\t\t\ttaskId: task.id,\n\t\t\ttaskDescription: task.description,\n\t\t\tduration,\n\t\t\tchanges: includeAIAttribution ? changes : changes.map((c) => ({ ...c, aiAttributed: false })),\n\t\t\tstats: {\n\t\t\t\ttotalFiles: daemonChanges.files.length,\n\t\t\t\ttotalLines: daemonChanges.totalLinesChanged,\n\t\t\t\taiAttributedFiles: changes.filter((c) => c.aiAttributed).length,\n\t\t\t\taiAttributedLines: changes.filter((c) => c.aiAttributed).reduce((sum, c) => sum + c.linesChanged, 0),\n\t\t\t},\n\t\t\tdiffs,\n\t\t\triskAssessment,\n\t\t\tnextActions,\n\t\t};\n\n\t\treturn result(\n\t\t\tJSON.stringify(\n\t\t\t\t{\n\t\t\t\t\t...output,\n\t\t\t\t\t_hint:\n\t\t\t\t\t\tdaemonChanges.files.length === 0\n\t\t\t\t\t\t\t? \"No changes detected yet. Start making modifications!\"\n\t\t\t\t\t\t\t: riskAssessment.level === \"high\"\n\t\t\t\t\t\t\t\t? \"High-risk changes detected. Consider creating a snapshot.\"\n\t\t\t\t\t\t\t\t: `${daemonChanges.files.length} file(s) changed, ${daemonChanges.totalLinesChanged} line(s) modified`,\n\t\t\t\t\t_source: \"daemon\",\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\t2,\n\t\t\t),\n\t\t);\n\t}\n\n\t// =========================================================================\n\t// FALLBACK: Daemon unavailable, use local Intelligence + git + SessionFileTracker\n\t// =========================================================================\n\n\t// Get baseline file set (files that were modified BEFORE task started)\n\tconst baselineFiles = getBaselineFileSet(workspaceRoot);\n\n\t// Get changes from Intelligence's shared session (cross-surface: Extension, MCP, CLI)\n\t// This replaces the MCP-only state.changesSinceTaskStart\n\tconst intel = getIntelligence(workspaceRoot);\n\tconst intelligenceChanges = intel.getFileModifications(task.id, task.startedAt);\n\tconst gitChanges = getGitChanges(workspaceRoot);\n\n\t// Also get changes from SessionFileTracker (MCP-only mode fallback)\n\tconst sessionTracker = getSessionFileTracker(workspaceRoot);\n\tconst sessionChanges = sessionTracker.getChangedFiles();\n\n\t// Merge Intelligence and git changes\n\tconst changeMap = new Map<string, ChangeSummary>();\n\n\t// Add SessionFileTracker changes (MCP-only mode tracking)\n\tfor (const change of sessionChanges) {\n\t\tconst relativePath = change.file.startsWith(workspaceRoot) ? relative(workspaceRoot, change.file) : change.file;\n\t\tchangeMap.set(relativePath, {\n\t\t\tfile: relativePath,\n\t\t\ttype: change.type,\n\t\t\tlinesChanged: change.linesChanged,\n\t\t\taiAttributed: change.aiAttributed,\n\t\t\ttimestamp: change.timestamp,\n\t\t});\n\t}\n\n\t// Add Intelligence-tracked changes (shared across all surfaces) - these take priority\n\tfor (const change of intelligenceChanges) {\n\t\tconst relativePath = change.path.startsWith(workspaceRoot) ? relative(workspaceRoot, change.path) : change.path;\n\t\tchangeMap.set(relativePath, {\n\t\t\tfile: relativePath,\n\t\t\ttype: change.type === \"create\" ? \"created\" : change.type === \"delete\" ? \"deleted\" : \"modified\",\n\t\t\tlinesChanged: change.linesChanged,\n\t\t\taiAttributed: change.aiAttributed,\n\t\t\ttimestamp: change.timestamp,\n\t\t});\n\t}\n\n\t// Add git changes ONLY if not in baseline (i.e., changed AFTER task started)\n\tfor (const [file, status] of gitChanges) {\n\t\t// Skip files that were already modified before task started\n\t\tif (baselineFiles.has(file) && !changeMap.has(file)) {\n\t\t\tcontinue; // This file was modified before the task, skip it\n\t\t}\n\n\t\tif (!changeMap.has(file)) {\n\t\t\tconst type: \"created\" | \"modified\" | \"deleted\" =\n\t\t\t\tstatus === \"A\" ? \"created\" : status === \"D\" ? \"deleted\" : \"modified\";\n\n\t\t\tlet linesChanged = 0;\n\t\t\tif (type !== \"deleted\") {\n\t\t\t\tconst diff = getFileDiff(file, workspaceRoot);\n\t\t\t\tif (diff) {\n\t\t\t\t\tlinesChanged = countLinesChanged(diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tchangeMap.set(file, {\n\t\t\t\tfile,\n\t\t\t\ttype,\n\t\t\t\tlinesChanged,\n\t\t\t\taiAttributed: false, // Unknown without extension data\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t});\n\t\t}\n\t}\n\n\t// Convert to array and filter\n\tlet changes = Array.from(changeMap.values());\n\n\tif (filterFiles && filterFiles.length > 0) {\n\t\tchanges = changes.filter((c) => filterFiles.some((f) => c.file.includes(f) || f.includes(c.file)));\n\t}\n\n\t// Sort by timestamp (most recent first)\n\tchanges.sort((a, b) => b.timestamp - a.timestamp);\n\n\t// Calculate stats\n\tconst totalFiles = changes.length;\n\tconst totalLines = changes.reduce((sum, c) => sum + c.linesChanged, 0);\n\tconst aiAttributedFiles = changes.filter((c) => c.aiAttributed).length;\n\tconst aiAttributedLines = changes.filter((c) => c.aiAttributed).reduce((sum, c) => sum + c.linesChanged, 0);\n\n\t// Get diffs if requested\n\tlet diffs: Array<{ file: string; diff: string }> | undefined;\n\tif (includeDiff) {\n\t\tdiffs = [];\n\t\tfor (const change of changes.slice(0, 10)) {\n\t\t\t// Limit to 10 files\n\t\t\tif (change.type !== \"deleted\") {\n\t\t\t\tconst diff = getFileDiff(change.file, workspaceRoot);\n\t\t\t\tif (diff) {\n\t\t\t\t\tdiffs.push({\n\t\t\t\t\t\tfile: change.file,\n\t\t\t\t\t\tdiff: diff.length > 2000 ? `${diff.slice(0, 2000)}\\n...(truncated)` : diff,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Assess risk\n\tconst riskAssessment = assessChangeRisk(changes);\n\n\t// Build next actions\n\tconst nextActions: Array<{ tool: string; priority: number; reason: string }> = [];\n\n\tif (totalLines > 0) {\n\t\tnextActions.push({\n\t\t\ttool: \"quick_check\",\n\t\t\tpriority: 1,\n\t\t\treason: \"Validate changes before proceeding\",\n\t\t});\n\t}\n\n\tif (riskAssessment.level === \"high\") {\n\t\tnextActions.push({\n\t\t\ttool: \"snapshot_create\",\n\t\t\tpriority: 1,\n\t\t\treason: \"Create safety snapshot for high-risk changes\",\n\t\t});\n\t}\n\n\tif (changes.length > 0) {\n\t\tnextActions.push({\n\t\t\ttool: \"review_work\",\n\t\t\tpriority: 2,\n\t\t\treason: \"Review changes before committing\",\n\t\t});\n\t}\n\n\t// Calculate duration\n\tconst duration = task ? formatDuration(Date.now() - task.startedAt) : \"No active task\";\n\n\tconst output: WhatChangedOutput = {\n\t\ttaskId: task?.id ?? null,\n\t\ttaskDescription: task?.description ?? null,\n\t\tduration,\n\t\tchanges: includeAIAttribution ? changes : changes.map((c) => ({ ...c, aiAttributed: false })),\n\t\tstats: {\n\t\t\ttotalFiles,\n\t\t\ttotalLines,\n\t\t\taiAttributedFiles: includeAIAttribution ? aiAttributedFiles : 0,\n\t\t\taiAttributedLines: includeAIAttribution ? aiAttributedLines : 0,\n\t\t},\n\t\tdiffs,\n\t\triskAssessment,\n\t\tnextActions,\n\t};\n\n\treturn result(\n\t\tJSON.stringify(\n\t\t\t{\n\t\t\t\t...output,\n\t\t\t\t_hint:\n\t\t\t\t\ttotalFiles === 0\n\t\t\t\t\t\t? \"No changes detected yet. Start making modifications!\"\n\t\t\t\t\t\t: riskAssessment.level === \"high\"\n\t\t\t\t\t\t\t? \"High-risk changes detected. Consider creating a snapshot.\"\n\t\t\t\t\t\t\t: `${totalFiles} file(s) changed, ${totalLines} line(s) modified`,\n\t\t\t},\n\t\t\tnull,\n\t\t\t2,\n\t\t),\n\t);\n};\n","/**\n * Facade Tool Handlers\n *\n * Thin wrapper layer that implements the 11 consolidated facade tools.\n * Each facade routes to legacy handlers based on the 'op' or 'type' parameter.\n *\n * @module facades\n */\n\nimport { existsSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { dirname, join } from \"node:path\";\nimport { createStorage } from \"@snapback/engine\";\nimport { SnapshotSuggester, WorkspaceVitals } from \"@snapback/intelligence/vitals\";\nimport { DiffCalculator } from \"@snapback/sdk\";\nimport { applyAutomaticFix, diagnoseSnapshotFailure, formatDiagnosis, type SnapshotDiagnosis } from \"@snapback-oss/sdk\";\nimport { CommonErrors } from \"../errors.js\";\nimport type { ToolContext, ToolHandler, ToolResult } from \"../registry.js\";\nimport { invalidateRetrieverCache } from \"../services/hybrid-retrieval-service.js\";\n// Import composite tool handlers (pair programmer)\nimport { indexLearning, invalidateCache as invalidateKnowledgeCache } from \"../services/knowledge-ingestion-service.js\";\nimport { atomicWriteFileSync, validateFilePaths } from \"../validation.js\";\nimport { handleBeginTask } from \"./begin-task.js\";\nimport { handleCompleteTask } from \"./complete-task.js\";\nimport { getIntelligence } from \"./intelligence.js\";\nimport { generatePairingProtocol, getContextSummary } from \"./pairing-protocol.js\";\nimport { handleQuickCheck } from \"./quick-check.js\";\nimport {\n\tbuildSmartActions,\n\ttype CleanupResult,\n\ttype CoachingContext,\n\tcleanupArchivedSessions,\n\tcleanupStaleLearnings,\n\tcompressResponse,\n\tfindMatchingSnapshot,\n\tformatBytes,\n\tgenerateCoachingHint,\n\tgetArchitectureVersion,\n\tgetFileHashes,\n\tgetResponseConfig,\n} from \"./response-utils.js\";\nimport { handleReviewWork } from \"./review-work.js\";\nimport { handleWhatChanged } from \"./what-changed.js\";\n\n/**\n * Helper to create a tool result\n */\nfunction result(text: string, isError = false): ToolResult {\n\treturn {\n\t\tcontent: [{ type: \"text\", text }],\n\t\tisError,\n\t};\n}\n\n/**\n * Helper to create JSON result with optional compression and coaching\n */\nfunction jsonResult(\n\tdata: unknown,\n\toptions?: {\n\t\tcontext?: ToolContext;\n\t\tcoaching?: CoachingContext;\n\t\tcompress?: boolean;\n\t},\n): ToolResult {\n\tlet finalData = data as Record<string, unknown>;\n\n\t// Add coaching hint if context provided\n\tif (options?.coaching) {\n\t\tconst hint = generateCoachingHint(options.coaching);\n\t\tif (hint) {\n\t\t\tfinalData = { ...finalData, _hint: hint };\n\t\t}\n\t}\n\n\t// Compress if requested or if context tier requires it\n\tif (options?.compress !== false && options?.context) {\n\t\tconst config = getResponseConfig(options.context.tier || \"local\");\n\t\tfinalData = compressResponse(finalData, config);\n\t}\n\n\treturn result(JSON.stringify(finalData, null, 2));\n}\n\n/**\n * Helper to create JSON error result (sets isError: true)\n */\nfunction errorJsonResult(data: unknown): ToolResult {\n\treturn result(JSON.stringify(data, null, 2), true);\n}\n\n/**\n * Helper to safely list snapshots without creating directories\n * For readonly/remote mode, reads snapshots without triggering directory creation\n */\nfunction listSnapshotsReadonly(\n\tworkspaceRoot: string,\n): Array<{ id: string; createdAt: number; files: Array<{ path: string }> }> {\n\tconst snapshotDir = join(workspaceRoot, \".snapback\", \"snapshots\");\n\n\tif (!existsSync(snapshotDir)) {\n\t\treturn [];\n\t}\n\n\ttry {\n\t\tconst files = require(\"node:fs\")\n\t\t\t.readdirSync(snapshotDir)\n\t\t\t.filter((f: string) => f.endsWith(\".json\"));\n\n\t\treturn files\n\t\t\t.map((file: string) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst content = readFileSync(join(snapshotDir, file), \"utf8\");\n\t\t\t\t\tconst parsed = JSON.parse(content);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: parsed.id,\n\t\t\t\t\t\tcreatedAt: parsed.createdAt,\n\t\t\t\t\t\tfiles: parsed.files || [],\n\t\t\t\t\t};\n\t\t\t\t} catch {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t})\n\t\t\t.filter((m: unknown): m is { id: string; createdAt: number; files: Array<{ path: string }> } => m !== null)\n\t\t\t.sort((a: { createdAt: number }, b: { createdAt: number }) => b.createdAt - a.createdAt);\n\t} catch {\n\t\treturn [];\n\t}\n}\n\n/**\n * Detect if workspace path is local or remote\n * Remote workspaces (sent by client over network) won't have write permissions\n */\nfunction isLocalWorkspace(workspacePath: string): boolean {\n\t// Check if path looks like an absolute local path\n\t// Windows: C:\\path or local UNC paths\n\t// Unix/Mac: /path or ~/path\n\tif (workspacePath.startsWith(\"/\") || workspacePath.startsWith(\"~\") || /^[A-Za-z]:/.test(workspacePath)) {\n\t\t// Still might not be writable, but worth trying\n\t\treturn true;\n\t}\n\t// Relative paths or network paths are likely remote\n\treturn false;\n}\n\n/**\n * analyze - Risk and package analysis\n */\nexport const handleAnalyze: ToolHandler = async (args, _context) => {\n\tconst { type } = args as { type?: \"risk\" | \"package\" };\n\n\tif (type === \"risk\") {\n\t\tconst { changes, filePath } = args as { changes?: unknown[]; filePath?: string };\n\n\t\t// Basic risk analysis based on change patterns\n\t\tconst riskFactors: string[] = [];\n\t\tlet severity: \"low\" | \"medium\" | \"high\" = \"low\";\n\n\t\tif (changes && Array.isArray(changes)) {\n\t\t\tconst hasRemovals = changes.some((c: unknown) => (c as { removed?: boolean }).removed);\n\t\t\tconst hasAdditions = changes.some((c: unknown) => (c as { added?: boolean }).added);\n\n\t\t\tif (hasRemovals && hasAdditions) {\n\t\t\t\triskFactors.push(\"Mixed additions and removals\");\n\t\t\t\tseverity = \"medium\";\n\t\t\t}\n\t\t\tif (changes.length > 50) {\n\t\t\t\triskFactors.push(\"Large change set (50+ lines)\");\n\t\t\t\tseverity = \"high\";\n\t\t\t}\n\t\t}\n\n\t\tif (filePath) {\n\t\t\tif (filePath.includes(\"auth\") || filePath.includes(\"security\")) {\n\t\t\t\triskFactors.push(\"Security-sensitive file\");\n\t\t\t\tseverity = \"high\";\n\t\t\t}\n\t\t\tif (filePath.includes(\"config\") || filePath.includes(\".env\")) {\n\t\t\t\triskFactors.push(\"Configuration file\");\n\t\t\t\tseverity = \"medium\";\n\t\t\t}\n\t\t}\n\n\t\treturn jsonResult({\n\t\t\ttype: \"risk_assessment\",\n\t\t\tseverity,\n\t\t\triskFactors,\n\t\t\trecommendation: severity === \"high\" ? \"Create snapshot before proceeding\" : \"Proceed with caution\",\n\t\t\tnext_actions: [\n\t\t\t\tseverity === \"high\" ? { tool: \"snapshot_create\", priority: 1, reason: \"High risk detected\" } : null,\n\t\t\t\t{ tool: \"validate\", priority: 2, reason: \"Validate changes before commit\" },\n\t\t\t].filter(Boolean),\n\t\t});\n\t}\n\n\tif (type === \"package\") {\n\t\tconst { packageName, targetVersion } = args as { packageName?: string; targetVersion?: string };\n\n\t\tif (!packageName) {\n\t\t\treturn errorJsonResult(CommonErrors.missingParam(\"packageName\"));\n\t\t}\n\n\t\treturn jsonResult({\n\t\t\ttype: \"package_validation\",\n\t\t\tpackageName,\n\t\t\ttargetVersion: targetVersion || \"latest\",\n\t\t\trecommendation: \"proceed\",\n\t\t\twarnings: [],\n\t\t\tmessage: \"Package validation - check npm registry for peer dependencies\",\n\t\t\tnext_actions: [{ tool: \"snapshot_create\", priority: 1, reason: \"Before package changes\" }],\n\t\t});\n\t}\n\n\treturn errorJsonResult(CommonErrors.missingParam(\"type (risk | package)\"));\n};\n\n/**\n * prepare_workspace - Pre-flight workspace check\n * Uses real WorkspaceVitals from @snapback/intelligence\n */\nexport const handlePrepareWorkspace: ToolHandler = async (_args, context) => {\n\t// Use readonly mode for snapshot listing if needed\n\tconst snapshots =\n\t\tcontext.storageMode === \"readonly\" || context.storageMode === \"remote\"\n\t\t\t? listSnapshotsReadonly(context.workspaceRoot)\n\t\t\t: createStorage(context.workspaceRoot).listSnapshots();\n\n\t// Use real vitals from @snapback/intelligence\n\tconst vitals = WorkspaceVitals.for(context.workspaceRoot);\n\tconst currentVitals = vitals.current();\n\tconst guidance = vitals.getAgentGuidance();\n\tconst snapshotDecision = vitals.shouldSnapshot();\n\n\tconst lastSnapshot = snapshots[0];\n\tconst timeSinceLastSnapshot = lastSnapshot ? Math.floor((Date.now() - lastSnapshot.createdAt) / 60000) : null;\n\n\t// Protection score based on pressure (inverted - low pressure = high protection)\n\tconst protectionScore = Math.max(0, 100 - currentVitals.pressure.value);\n\n\treturn jsonResult({\n\t\tvitals: {\n\t\t\tpulse: currentVitals.pulse,\n\t\t\ttemperature: currentVitals.temperature,\n\t\t\tpressure: currentVitals.pressure,\n\t\t\toxygen: currentVitals.oxygen,\n\t\t\ttrajectory: currentVitals.trajectory,\n\t\t},\n\t\tprotectionScore,\n\t\tlastSnapshot: lastSnapshot\n\t\t\t? {\n\t\t\t\t\tid: lastSnapshot.id,\n\t\t\t\t\tcreatedAt: new Date(lastSnapshot.createdAt).toISOString(),\n\t\t\t\t\tfileCount: lastSnapshot.files.length,\n\t\t\t\t\tminutesAgo: timeSinceLastSnapshot,\n\t\t\t\t}\n\t\t\t: null,\n\t\ttotalSnapshots: snapshots.length,\n\t\trecommendation: {\n\t\t\tshould: snapshotDecision.should,\n\t\t\treason: snapshotDecision.reason,\n\t\t\turgency: snapshotDecision.urgency,\n\t\t},\n\t\tsafeOperations: guidance.safeOperations,\n\t\tblockedOperations: guidance.blockedOperations,\n\t\tsuggestion: guidance.suggestion,\n\t\tnext_actions: snapshotDecision.should\n\t\t\t? [{ tool: \"snapshot_create\", priority: 1, reason: snapshotDecision.reason }]\n\t\t\t: [],\n\t});\n};\n\n/**\n * snapshot_create - Create snapshot with auto-retry, diagnosis, and duplicate detection\n */\nexport const handleSnapshotCreate: ToolHandler = async (args, context) => {\n\tconst { files, reason, trigger } = args as {\n\t\tfiles?: string[];\n\t\treason?: string;\n\t\ttrigger?: string;\n\t};\n\n\tif (!files || files.length === 0) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"files\"));\n\t}\n\n\t// P0-004: Validate file paths for traversal attacks\n\tconst pathValidation = validateFilePaths(files, context.workspaceRoot);\n\tif (!pathValidation.valid) {\n\t\treturn errorJsonResult(CommonErrors.pathTraversalBlocked(pathValidation.invalidPath, pathValidation.error));\n\t}\n\n\t// Check if readonly mode - if so, reject write operations with helpful guidance\n\tif (context.storageMode === \"readonly\" || context.storageMode === \"remote\") {\n\t\treturn errorJsonResult({\n\t\t\tstatus: \"error\",\n\t\t\terror: \"E503_SNAPSHOT_SETUP_NEEDED\",\n\t\t\tmessage: \"Enable snapshots with quick local setup\",\n\t\t\taction: {\n\t\t\t\ttype: \"cli_install\",\n\t\t\t\tcommand: \"npm install -g @snapback/cli && snapback tools configure\",\n\t\t\t\tdescription: \"One command enables full snapshot capabilities\",\n\t\t\t\ttime_estimate: \"~30 seconds\",\n\t\t\t},\n\t\t\thelp_url: \"https://docs.snapback.dev/cli/setup\",\n\t\t\t_llm: {\n\t\t\t\tsuggest: \"I can enable snapshots for you with a quick CLI install. Want me to help?\",\n\t\t\t\tauto_offer: true,\n\t\t\t},\n\t\t});\n\t}\n\n\tconst storage = createStorage(context.workspaceRoot);\n\n\t// Enhancement #1: Duplicate snapshot prevention (fixed)\n\t// Check if ALL requested files are unchanged in ANY recent snapshot\n\t// Uses blobId comparison directly - no expensive restore() needed\n\tconst snapshots = storage.listSnapshots();\n\n\tif (snapshots.length > 0) {\n\t\tconst currentHashes = getFileHashes(files, context.workspaceRoot);\n\n\t\t// Check against recent snapshots (not just the most recent)\n\t\t// This handles: subset requests, different file orderings, recent snapshots\n\t\tconst match = findMatchingSnapshot(currentHashes, snapshots, 5);\n\n\t\tif (match.matched && match.snapshotId && match.createdAt) {\n\t\t\tconst minutesAgo = Math.floor((Date.now() - match.createdAt) / 60000);\n\t\t\treturn jsonResult(\n\t\t\t\t{\n\t\t\t\t\tstatus: \"skipped\",\n\t\t\t\t\treason: \"Files unchanged since last snapshot\",\n\t\t\t\t\tlastSnapshotId: match.snapshotId,\n\t\t\t\t\tlastSnapshotTime: new Date(match.createdAt).toISOString(),\n\t\t\t\t\tminutesAgo,\n\t\t\t\t\tfileCount: files.length,\n\t\t\t\t\tmessage: `Skipped: files match snapshot from ${minutesAgo} minute(s) ago`,\n\t\t\t\t\t_hint: \"No changes detected. Your previous snapshot already covers these files.\",\n\t\t\t\t\tnext_actions: buildSmartActions(\n\t\t\t\t\t\t[{ tool: \"prepare_workspace\", reason: \"Check workspace state\", priority: 2 }],\n\t\t\t\t\t\t{ hasUnsavedChanges: false },\n\t\t\t\t\t),\n\t\t\t\t},\n\t\t\t\t{ context, coaching: { lastAction: \"snapshot_skipped\" } },\n\t\t\t);\n\t\t}\n\t}\n\n\tconst maxRetries = 3;\n\tlet lastError: Error | null = null;\n\tlet diagnosis: SnapshotDiagnosis | null = null;\n\n\t// Retry loop with auto-fix\n\tfor (let attempt = 0; attempt <= maxRetries; attempt++) {\n\t\ttry {\n\t\t\t// Read file contents using sanitized paths\n\t\t\tconst fileContents = pathValidation.sanitizedPaths.map((fullPath, idx) => {\n\t\t\t\tif (!existsSync(fullPath)) {\n\t\t\t\t\tthrow new Error(`File not found: ${files[idx]}`);\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\tpath: files[idx],\n\t\t\t\t\tcontent: readFileSync(fullPath, \"utf8\"),\n\t\t\t\t};\n\t\t\t});\n\n\t\t\t// Create snapshot using engine\n\t\t\tconst snapshot = await storage.createSnapshot(fileContents, {\n\t\t\t\tdescription: reason,\n\t\t\t\ttrigger: (trigger as \"manual\" | \"auto\" | \"ai-detection\") || \"manual\",\n\t\t\t});\n\n\t\t\treturn jsonResult(\n\t\t\t\t{\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tsnapshotId: snapshot.id,\n\t\t\t\t\tfileCount: snapshot.files.length,\n\t\t\t\t\ttotalSize: snapshot.totalSize,\n\t\t\t\t\tcreatedAt: new Date(snapshot.createdAt).toISOString(),\n\t\t\t\t\tmessage: `Snapshot created with ${snapshot.files.length} file(s)`,\n\t\t\t\t\tattempts: attempt + 1,\n\t\t\t\t\tautoFixed: attempt > 0,\n\t\t\t\t\tnext_actions: buildSmartActions(\n\t\t\t\t\t\t[{ tool: \"snapshot_list\", reason: \"Verify snapshot\", priority: 2 }],\n\t\t\t\t\t\t{ hasUnsavedChanges: false, lastSnapshotMinutes: 0 },\n\t\t\t\t\t),\n\t\t\t\t},\n\t\t\t\t{ context, coaching: { lastAction: \"snapshot_create\", taskPhase: \"working\" } },\n\t\t\t);\n\t\t} catch (error) {\n\t\t\tlastError = error instanceof Error ? error : new Error(String(error));\n\n\t\t\t// Diagnose the failure\n\t\t\tdiagnosis = diagnoseSnapshotFailure(lastError, files, context.workspaceRoot);\n\n\t\t\t// If we can auto-fix and haven't exhausted retries, try fixing\n\t\t\tif (diagnosis.canAutoFix && attempt < maxRetries) {\n\t\t\t\tconst fixed = await applyAutomaticFix(diagnosis, {\n\t\t\t\t\tworkspaceRoot: context.workspaceRoot,\n\t\t\t\t\tfiles,\n\t\t\t\t});\n\n\t\t\t\tif (fixed) {\n\t\t\t\t\t// Auto-fix succeeded, retry\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Can't auto-fix or exhausted retries - return error with diagnosis\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// All retries failed - return detailed diagnosis\n\tif (lastError && diagnosis) {\n\t\tconst formattedDiagnosis = formatDiagnosis(diagnosis);\n\n\t\treturn errorJsonResult({\n\t\t\tstatus: \"error\",\n\t\t\terror: \"E106_SNAPSHOT_CREATION_FAILED\",\n\t\t\tmessage: lastError.message,\n\t\t\tdiagnosis: {\n\t\t\t\ttype: diagnosis.type,\n\t\t\t\tmessage: diagnosis.message,\n\t\t\t\tcause: diagnosis.cause,\n\t\t\t\tsuggestedFix: diagnosis.suggestedFix,\n\t\t\t\tuserAction: diagnosis.userAction,\n\t\t\t\tconfidence: diagnosis.confidence,\n\t\t\t\taffectedFiles: diagnosis.affectedFiles,\n\t\t\t},\n\t\t\tformatted: formattedDiagnosis,\n\t\t\tnext_actions: diagnosis.canAutoFix\n\t\t\t\t? [{ tool: \"snapshot_create\", priority: 1, reason: \"Retry with manual fix\" }]\n\t\t\t\t: [],\n\t\t});\n\t}\n\n\t// Fallback error (should never reach here)\n\treturn result(`Snapshot creation failed: ${lastError?.message || \"Unknown error\"}`, true);\n};\n\n/**\n * snapshot_list - List snapshots\n */\nexport const handleSnapshotList: ToolHandler = async (args, context) => {\n\tconst { limit = 20, since } = args as { limit?: number; since?: string };\n\n\tconst storage = createStorage(context.workspaceRoot);\n\tlet snapshots = storage.listSnapshots();\n\n\t// Filter by since if provided\n\tif (since) {\n\t\tconst sinceTime = new Date(since).getTime();\n\t\tsnapshots = snapshots.filter((s: { createdAt: number }) => s.createdAt >= sinceTime);\n\t}\n\n\t// Limit results\n\tsnapshots = snapshots.slice(0, limit);\n\n\treturn jsonResult({\n\t\tstatus: \"success\",\n\t\tcount: snapshots.length,\n\t\tsnapshots: snapshots.map(\n\t\t\t(s: {\n\t\t\t\tid: string;\n\t\t\t\tcreatedAt: number;\n\t\t\t\tfiles: Array<{ path: string; blobId: string; size: number }>;\n\t\t\t\ttotalSize: number;\n\t\t\t\tdescription?: string;\n\t\t\t\ttrigger?: string;\n\t\t\t}) => ({\n\t\t\t\tid: s.id,\n\t\t\t\tcreatedAt: new Date(s.createdAt).toISOString(),\n\t\t\t\tfileCount: s.files.length,\n\t\t\t\ttotalSize: s.totalSize,\n\t\t\t\tdescription: s.description,\n\t\t\t\ttrigger: s.trigger,\n\t\t\t\tfiles: s.files.map((f: { path: string }) => f.path),\n\t\t\t}),\n\t\t),\n\t\tnext_actions:\n\t\t\tsnapshots.length > 0\n\t\t\t\t? [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttool: \"snapshot_restore\",\n\t\t\t\t\t\t\tpriority: 2,\n\t\t\t\t\t\t\treason: \"Restore if needed\",\n\t\t\t\t\t\t\targs: { snapshotId: snapshots[0].id },\n\t\t\t\t\t\t},\n\t\t\t\t\t]\n\t\t\t\t: [{ tool: \"snapshot_create\", priority: 1, reason: \"No snapshots yet\" }],\n\t});\n};\n\n/**\n * snapshot_restore - Restore snapshot\n */\nexport const handleSnapshotRestore: ToolHandler = async (args, context) => {\n\tconst {\n\t\tsnapshotId,\n\t\tfiles: filterFiles,\n\t\tdryRun,\n\t} = args as {\n\t\tsnapshotId?: string;\n\t\tfiles?: string[];\n\t\tdryRun?: boolean;\n\t};\n\n\tif (!snapshotId) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"snapshotId\"));\n\t}\n\n\t// P0-004: Validate filter file paths if provided\n\tif (filterFiles && filterFiles.length > 0) {\n\t\tconst pathValidation = validateFilePaths(filterFiles, context.workspaceRoot);\n\t\tif (!pathValidation.valid) {\n\t\t\treturn errorJsonResult(CommonErrors.pathTraversalBlocked(pathValidation.invalidPath, pathValidation.error));\n\t\t}\n\t}\n\n\tconst storage = createStorage(context.workspaceRoot);\n\n\ttry {\n\t\t// Get snapshot to validate it exists\n\t\tconst snapshot = storage.getSnapshot(snapshotId);\n\t\tif (!snapshot) {\n\t\t\treturn errorJsonResult(CommonErrors.snapshotNotFound(snapshotId));\n\t\t}\n\n\t\t// Restore files from snapshot\n\t\tconst restoredFiles = await storage.restore(snapshotId);\n\n\t\t// Filter if specific files requested\n\t\tconst filesToRestore = filterFiles\n\t\t\t? restoredFiles.filter((f: { path: string }) => filterFiles.includes(f.path))\n\t\t\t: restoredFiles;\n\n\t\tif (dryRun) {\n\t\t\treturn jsonResult({\n\t\t\t\tstatus: \"dry_run\",\n\t\t\t\tsnapshotId,\n\t\t\t\twouldRestore: filesToRestore.map((f: { path: string; content: string }) => ({\n\t\t\t\t\tpath: f.path,\n\t\t\t\t\tsize: Buffer.byteLength(f.content, \"utf8\"),\n\t\t\t\t})),\n\t\t\t\tmessage: `Would restore ${filesToRestore.length} file(s)`,\n\t\t\t});\n\t\t}\n\n\t\t// P0-005: Create backup snapshot BEFORE overwriting files\n\t\tconst existingFiles: { path: string; content: string }[] = [];\n\t\tfor (const file of filesToRestore) {\n\t\t\tconst fullPath = join(context.workspaceRoot, file.path);\n\t\t\tif (existsSync(fullPath)) {\n\t\t\t\texistingFiles.push({\n\t\t\t\t\tpath: file.path,\n\t\t\t\t\tcontent: readFileSync(fullPath, \"utf8\"),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tlet backupSnapshotId: string | null = null;\n\t\tif (existingFiles.length > 0) {\n\t\t\tconst backupSnapshot = await storage.createSnapshot(existingFiles, {\n\t\t\t\tdescription: `Auto-backup before restore from ${snapshotId}`,\n\t\t\t\ttrigger: \"auto\",\n\t\t\t});\n\t\t\tbackupSnapshotId = backupSnapshot.id;\n\t\t}\n\n\t\t// Actually write files\n\t\tfor (const file of filesToRestore) {\n\t\t\tconst fullPath = join(context.workspaceRoot, file.path);\n\t\t\tconst dir = dirname(fullPath);\n\t\t\tif (!existsSync(dir)) {\n\t\t\t\tawait import(\"node:fs\").then((fs) => fs.mkdirSync(dir, { recursive: true }));\n\t\t\t}\n\t\t\twriteFileSync(fullPath, file.content, \"utf8\");\n\t\t}\n\n\t\treturn jsonResult({\n\t\t\tstatus: \"success\",\n\t\t\tsnapshotId,\n\t\t\tbackupSnapshotId,\n\t\t\trestoredFiles: filesToRestore.map((f: { path: string }) => f.path),\n\t\t\tmessage: `Restored ${filesToRestore.length} file(s) from snapshot${backupSnapshotId ? ` (backup: ${backupSnapshotId})` : \"\"}`,\n\t\t\tnext_actions: [{ tool: \"prepare_workspace\", priority: 1, reason: \"Verify workspace state\" }],\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Snapshot restore failed: ${message}`, true);\n\t}\n};\n\n/**\n * validate - Code validation\n * Supports \"quick\" (fast pattern checks) and \"comprehensive\" (full 7-layer pipeline)\n * Uses Intelligence facade for comprehensive validation\n */\nexport const handleValidate: ToolHandler = async (args, context) => {\n\tconst {\n\t\tmode = \"quick\",\n\t\tcode,\n\t\tfilePath,\n\t} = args as {\n\t\tmode?: \"quick\" | \"comprehensive\";\n\t\tcode?: string;\n\t\tfilePath?: string;\n\t};\n\n\tif (!code || !filePath) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"code, filePath\"));\n\t}\n\n\t// Comprehensive mode: use full 7-layer ValidationPipeline from Intelligence\n\tif (mode === \"comprehensive\") {\n\t\ttry {\n\t\t\tconst intel = getIntelligence(context.workspaceRoot);\n\t\t\tconst validation = await intel.checkPatterns(code, filePath);\n\n\t\t\treturn jsonResult({\n\t\t\t\tstatus: \"success\",\n\t\t\t\tmode: \"comprehensive\",\n\t\t\t\tfilePath,\n\t\t\t\tpassed: validation.overall.passed,\n\t\t\t\tconfidence: validation.overall.confidence,\n\t\t\t\ttotalIssues: validation.overall.totalIssues,\n\t\t\t\trecommendation: validation.recommendation,\n\t\t\t\tlayers: validation.layers.map((l) => ({\n\t\t\t\t\tname: l.layer,\n\t\t\t\t\tpassed: l.passed,\n\t\t\t\t\tissueCount: l.issues.length,\n\t\t\t\t\tissues: l.issues.map((i) => ({\n\t\t\t\t\t\tseverity: i.severity,\n\t\t\t\t\t\ttype: i.type,\n\t\t\t\t\t\tmessage: i.message,\n\t\t\t\t\t\tline: i.line,\n\t\t\t\t\t\tfix: i.fix,\n\t\t\t\t\t})),\n\t\t\t\t\tduration: l.duration,\n\t\t\t\t})),\n\t\t\t\tfocusPoints: validation.focusPoints,\n\t\t\t\tmessage: validation.overall.passed\n\t\t\t\t\t? \"All validation layers passed\"\n\t\t\t\t\t: `Found ${validation.overall.totalIssues} issue(s) across ${validation.layers.filter((l) => !l.passed).length} layer(s)`,\n\t\t\t\tnext_actions: validation.overall.passed\n\t\t\t\t\t? []\n\t\t\t\t\t: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttool: \"validate\",\n\t\t\t\t\t\t\t\tpriority: 1,\n\t\t\t\t\t\t\t\treason: \"Re-validate after fixes\",\n\t\t\t\t\t\t\t\targs: { mode: \"comprehensive\" },\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\treturn result(`Comprehensive validation failed: ${message}`, true);\n\t\t}\n\t}\n\n\t// Quick mode: fast pattern checks without full pipeline\n\tconst violations: Array<{\n\t\trule: string;\n\t\tseverity: \"critical\" | \"warning\" | \"info\";\n\t\tline?: number;\n\t\tmessage: string;\n\t}> = [];\n\n\t// Check for common issues with line detection\n\tconst lines = code.split(\"\\n\");\n\tlines.forEach((line, idx) => {\n\t\tconst lineNum = idx + 1;\n\t\tif (line.includes(\"console.log\")) {\n\t\t\tviolations.push({\n\t\t\t\trule: \"no-console\",\n\t\t\t\tseverity: \"warning\",\n\t\t\t\tline: lineNum,\n\t\t\t\tmessage: \"console.log found - consider removing for production\",\n\t\t\t});\n\t\t}\n\t\tif (/:\\s*any\\b/.test(line) || /as\\s+any\\b/.test(line)) {\n\t\t\tviolations.push({\n\t\t\t\trule: \"no-explicit-any\",\n\t\t\t\tseverity: \"warning\",\n\t\t\t\tline: lineNum,\n\t\t\t\tmessage: \"Explicit 'any' type found - consider more specific type\",\n\t\t\t});\n\t\t}\n\t\tif (/\\/\\/\\s*(TODO|FIXME|HACK|XXX)\\b/i.test(line)) {\n\t\t\tviolations.push({\n\t\t\t\trule: \"no-todo-comments\",\n\t\t\t\tseverity: \"info\",\n\t\t\t\tline: lineNum,\n\t\t\t\tmessage: \"TODO/FIXME comment found - consider addressing before commit\",\n\t\t\t});\n\t\t}\n\t\tif (/debugger\\b/.test(line)) {\n\t\t\tviolations.push({\n\t\t\t\trule: \"no-debugger\",\n\t\t\t\tseverity: \"critical\",\n\t\t\t\tline: lineNum,\n\t\t\t\tmessage: \"debugger statement found - must remove before production\",\n\t\t\t});\n\t\t}\n\t});\n\n\t// Check file-level patterns\n\tif (filePath.includes(\"auth\") || filePath.includes(\"security\")) {\n\t\tif (code.includes(\"eval(\") || code.includes(\"Function(\")) {\n\t\t\tviolations.push({\n\t\t\t\trule: \"no-eval-in-security\",\n\t\t\t\tseverity: \"critical\",\n\t\t\t\tmessage: \"eval/Function in security-sensitive file - potential code injection risk\",\n\t\t\t});\n\t\t}\n\t}\n\n\tconst criticalCount = violations.filter((v) => v.severity === \"critical\").length;\n\tconst warningCount = violations.filter((v) => v.severity === \"warning\").length;\n\tconst confidence =\n\t\tcriticalCount > 0\n\t\t\t? 30\n\t\t\t: warningCount > 2\n\t\t\t\t? 60\n\t\t\t\t: violations.length === 0\n\t\t\t\t\t? 100\n\t\t\t\t\t: Math.max(70, 100 - warningCount * 10);\n\n\tconst recommendation = confidence >= 95 ? \"auto_merge\" : confidence >= 70 ? \"quick_review\" : \"full_review\";\n\n\treturn jsonResult({\n\t\tstatus: \"success\",\n\t\tmode: \"quick\",\n\t\tfilePath,\n\t\tpassed: criticalCount === 0,\n\t\tconfidence,\n\t\ttotalIssues: violations.length,\n\t\tviolations,\n\t\trecommendation,\n\t\tmessage:\n\t\t\tviolations.length === 0\n\t\t\t\t? \"No violations found\"\n\t\t\t\t: `Found ${violations.length} issue(s): ${criticalCount} critical, ${warningCount} warnings`,\n\t\thint:\n\t\t\tcriticalCount > 0\n\t\t\t\t? \"Fix critical issues before committing\"\n\t\t\t\t: warningCount > 2\n\t\t\t\t\t? \"Consider running comprehensive validation\"\n\t\t\t\t\t: null,\n\t\tnext_actions:\n\t\t\tcriticalCount > 0 || warningCount > 2\n\t\t\t\t? [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttool: \"validate\",\n\t\t\t\t\t\t\tpriority: 1,\n\t\t\t\t\t\t\treason: \"Run comprehensive validation\",\n\t\t\t\t\t\t\targs: { mode: \"comprehensive\" },\n\t\t\t\t\t\t},\n\t\t\t\t\t]\n\t\t\t\t: [],\n\t});\n};\n\n/**\n * context - Context management\n * P1-004: Full implementation of all context operations\n */\nexport const handleContext: ToolHandler = async (args, context) => {\n\tconst { op, domain, name, value } = args as {\n\t\top?: string;\n\t\tdomain?: string;\n\t\tname?: string;\n\t\tvalue?: number;\n\t};\n\n\tif (!op) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"op\"));\n\t}\n\n\tconst ctxDir = join(context.workspaceRoot, \".snapback\", \"ctx\");\n\tconst ctxPath = join(ctxDir, \"context.json\");\n\tconst ctxFilePath = join(context.workspaceRoot, \".ctx\");\n\n\tswitch (op) {\n\t\tcase \"status\": {\n\t\t\tconst exists = existsSync(ctxPath);\n\t\t\tconst ctxFileExists = existsSync(ctxFilePath);\n\t\t\tlet contextData: Record<string, unknown> | null = null;\n\t\t\tif (exists) {\n\t\t\t\ttry {\n\t\t\t\t\tcontextData = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore parse errors\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn jsonResult({\n\t\t\t\top: \"status\",\n\t\t\t\tinitialized: exists,\n\t\t\t\tpath: ctxPath,\n\t\t\t\tctxFileExists,\n\t\t\t\tprojectPhase: contextData?.project_phase || \"unknown\",\n\t\t\t\tpriority: contextData?.priority || \"unknown\",\n\t\t\t\tmessage: exists ? \"Context initialized\" : \"Context not initialized - run op: init\",\n\t\t\t});\n\t\t}\n\t\tcase \"init\": {\n\t\t\t// Create context directory if needed\n\t\t\tif (!existsSync(ctxDir)) {\n\t\t\t\tawait import(\"node:fs\").then((fs) => fs.mkdirSync(ctxDir, { recursive: true }));\n\t\t\t}\n\n\t\t\t// Default context structure\n\t\t\tconst defaultContext = {\n\t\t\t\tproject_phase: \"development\",\n\t\t\t\tpriority: \"stability\",\n\t\t\t\tconstraints: {\n\t\t\t\t\textension: {\n\t\t\t\t\t\tbundle: { max: 150, unit: \"KB\", description: \"Max extension bundle size\" },\n\t\t\t\t\t},\n\t\t\t\t\tweb: {\n\t\t\t\t\t\tfcp: { max: 1500, unit: \"ms\", description: \"First Contentful Paint\" },\n\t\t\t\t\t\tlcp: { max: 2500, unit: \"ms\", description: \"Largest Contentful Paint\" },\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tblockers: [],\n\t\t\t\tlastScanned: new Date().toISOString(),\n\t\t\t\tstaleAfterDays: 7,\n\t\t\t\tcreated_at: new Date().toISOString(),\n\t\t\t\tupdated_at: new Date().toISOString(),\n\t\t\t};\n\n\t\t\t// P0-002: Use atomic write for crash safety\n\t\t\tconst writeResult = atomicWriteFileSync(ctxPath, JSON.stringify(defaultContext, null, 2));\n\t\t\tif (!writeResult.success) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"init\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: writeResult.error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn jsonResult({\n\t\t\t\top: \"init\",\n\t\t\t\tstatus: \"success\",\n\t\t\t\tpath: ctxPath,\n\t\t\t\tmessage: \"Context initialized with default configuration\",\n\t\t\t\tnext_actions: [\n\t\t\t\t\t{ tool: \"context\", priority: 1, reason: \"Check status\", args: { op: \"status\" } },\n\t\t\t\t\t{ tool: \"context\", priority: 2, reason: \"Build .ctx file\", args: { op: \"build\" } },\n\t\t\t\t],\n\t\t\t});\n\t\t}\n\t\tcase \"build\": {\n\t\t\t// Build .ctx file from context.json\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"build\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E204_CONTEXT_NOT_INITIALIZED\",\n\t\t\t\t\tmessage: \"Context not initialized - run op: init first\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst contextData = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\t\t// Build minified .ctx for LLM consumption\n\t\t\t\tconst ctxContent = JSON.stringify(contextData);\n\n\t\t\t\t// P0-002: Use atomic write for crash safety\n\t\t\t\tconst writeResult = atomicWriteFileSync(ctxFilePath, ctxContent);\n\t\t\t\tif (!writeResult.success) {\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"build\",\n\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\t\tmessage: writeResult.error,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"build\",\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tpath: ctxFilePath,\n\t\t\t\t\tsize: ctxContent.length,\n\t\t\t\t\tmessage: \".ctx file built successfully\",\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"build\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to build .ctx: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tcase \"validate\": {\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"validate\",\n\t\t\t\t\tvalid: false,\n\t\t\t\t\treason: \"Context not initialized\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst ctxFileExists = existsSync(ctxFilePath);\n\t\t\tif (!ctxFileExists) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"validate\",\n\t\t\t\t\tvalid: false,\n\t\t\t\t\treason: \".ctx file missing - run op: build\",\n\t\t\t\t\tnext_actions: [{ tool: \"context\", priority: 1, reason: \"Build .ctx\", args: { op: \"build\" } }],\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Check if .ctx is in sync with context.json\n\t\t\tconst contextJson = readFileSync(ctxPath, \"utf8\");\n\t\t\tconst ctxFile = readFileSync(ctxFilePath, \"utf8\");\n\t\t\tconst isSync = JSON.stringify(JSON.parse(contextJson)) === ctxFile;\n\n\t\t\treturn jsonResult({\n\t\t\t\top: \"validate\",\n\t\t\t\tvalid: isSync,\n\t\t\t\treason: isSync ? \"Context is in sync\" : \"Context is stale - run op: build\",\n\t\t\t\tnext_actions: isSync\n\t\t\t\t\t? []\n\t\t\t\t\t: [{ tool: \"context\", priority: 1, reason: \"Rebuild\", args: { op: \"build\" } }],\n\t\t\t});\n\t\t}\n\t\tcase \"constraint\": {\n\t\t\tif (!domain || !name) {\n\t\t\t\treturn errorJsonResult(CommonErrors.missingParam(\"domain, name\"));\n\t\t\t}\n\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"constraint\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E204_CONTEXT_NOT_INITIALIZED\",\n\t\t\t\t\tmessage: \"Context not initialized\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst contextData = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\t\tconst constraint = contextData?.constraints?.[domain]?.[name];\n\n\t\t\t\tif (!constraint) {\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"constraint\",\n\t\t\t\t\t\tdomain,\n\t\t\t\t\t\tname,\n\t\t\t\t\t\tfound: false,\n\t\t\t\t\t\tmessage: `Constraint ${domain}.${name} not found`,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"constraint\",\n\t\t\t\t\tdomain,\n\t\t\t\t\tname,\n\t\t\t\t\tfound: true,\n\t\t\t\t\tthreshold: constraint.max,\n\t\t\t\t\tunit: constraint.unit,\n\t\t\t\t\tdescription: constraint.description,\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"constraint\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to read constraint: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tcase \"check\": {\n\t\t\tif (!domain || !name || value === undefined) {\n\t\t\t\treturn errorJsonResult(CommonErrors.missingParam(\"domain, name, value\"));\n\t\t\t}\n\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"check\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E204_CONTEXT_NOT_INITIALIZED\",\n\t\t\t\t\tmessage: \"Context not initialized\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst contextData = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\t\tconst constraint = contextData?.constraints?.[domain]?.[name];\n\n\t\t\t\tif (!constraint) {\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"check\",\n\t\t\t\t\t\tdomain,\n\t\t\t\t\t\tname,\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\tpasses: true, // No constraint = passes\n\t\t\t\t\t\tmessage: `No constraint defined for ${domain}.${name}`,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst passes = value <= constraint.max;\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"check\",\n\t\t\t\t\tdomain,\n\t\t\t\t\tname,\n\t\t\t\t\tvalue,\n\t\t\t\t\tthreshold: constraint.max,\n\t\t\t\t\tunit: constraint.unit,\n\t\t\t\t\tpasses,\n\t\t\t\t\tmessage: passes\n\t\t\t\t\t\t? `Value ${value}${constraint.unit} is within constraint (max: ${constraint.max}${constraint.unit})`\n\t\t\t\t\t\t: `Value ${value}${constraint.unit} exceeds constraint (max: ${constraint.max}${constraint.unit})`,\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"check\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to check constraint: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tcase \"blockers\": {\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"blockers\",\n\t\t\t\t\tblockers: [],\n\t\t\t\t\tmessage: \"Context not initialized\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst contextData = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\t\tconst blockers = contextData?.blockers || [];\n\t\t\t\tconst lastScanned = contextData?.lastScanned;\n\t\t\t\tconst staleAfterDays = contextData?.staleAfterDays || 7;\n\n\t\t\t\t// Check staleness\n\t\t\t\tlet isStale = false;\n\t\t\t\tlet daysSinceScanned: number | null = null;\n\t\t\t\tlet stalenessWarning: string | null = null;\n\n\t\t\t\tif (lastScanned) {\n\t\t\t\t\tconst scanTime = new Date(lastScanned).getTime();\n\t\t\t\t\tdaysSinceScanned = Math.floor((Date.now() - scanTime) / (1000 * 60 * 60 * 24));\n\t\t\t\t\tisStale = daysSinceScanned > staleAfterDays;\n\n\t\t\t\t\tif (isStale) {\n\t\t\t\t\t\tstalenessWarning = `Data is ${daysSinceScanned} days stale - consider refreshing`;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// No lastScanned field means old format or never scanned\n\t\t\t\t\tstalenessWarning = \"No scan timestamp found - data may be stale\";\n\t\t\t\t}\n\n\t\t\t\tconst result: Record<string, unknown> = {\n\t\t\t\t\top: \"blockers\",\n\t\t\t\t\tblockers,\n\t\t\t\t\tcount: blockers.length,\n\t\t\t\t\tmessage: blockers.length > 0 ? `${blockers.length} blocker(s) found` : \"No blockers\",\n\t\t\t\t\tlastScanned,\n\t\t\t\t\tdaysSinceScanned,\n\t\t\t\t\tisStale,\n\t\t\t\t};\n\n\t\t\t\tif (stalenessWarning) {\n\t\t\t\t\tresult.warning = stalenessWarning;\n\t\t\t\t\tresult.next_actions = [\n\t\t\t\t\t\t{ tool: \"context\", priority: 1, reason: \"Refresh stale data\", args: { op: \"scan\" } },\n\t\t\t\t\t];\n\t\t\t\t}\n\n\t\t\t\treturn jsonResult(result);\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"blockers\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to read blockers: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tcase \"reset\": {\n\t\t\t// Quick Fix: Reset/cleanup stale context\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"reset\",\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tmessage: \"No context to reset\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\t// Remove stale context file\n\t\t\t\tawait import(\"node:fs\").then((fs) => fs.unlinkSync(ctxPath));\n\n\t\t\t\t// Also remove .ctx file if exists\n\t\t\t\tif (existsSync(ctxFilePath)) {\n\t\t\t\t\tawait import(\"node:fs\").then((fs) => fs.unlinkSync(ctxFilePath));\n\t\t\t\t}\n\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"reset\",\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tmessage: \"Context reset successfully - run op: init to recreate\",\n\t\t\t\t\tnext_actions: [{ tool: \"context\", priority: 1, reason: \"Recreate context\", args: { op: \"init\" } }],\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"reset\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to reset context: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tcase \"scan\": {\n\t\t\t// Best Fix: Real-time scanning of blockers\n\t\t\tif (!existsSync(ctxPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"scan\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E204_CONTEXT_NOT_INITIALIZED\",\n\t\t\t\t\tmessage: \"Context not initialized - run op: init first\",\n\t\t\t\t\tnext_actions: [\n\t\t\t\t\t\t{ tool: \"context\", priority: 1, reason: \"Initialize context\", args: { op: \"init\" } },\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\t// Read existing context\n\t\t\t\tconst contextData = JSON.parse(readFileSync(ctxPath, \"utf8\"));\n\t\t\t\tconst newBlockers: Array<{\n\t\t\t\t\tkey: string;\n\t\t\t\t\tlabel: string;\n\t\t\t\t\tcurrent: number | string;\n\t\t\t\t\ttarget: number | string;\n\t\t\t\t}> = [];\n\n\t\t\t\t// Scan for TypeScript errors\n\t\t\t\ttry {\n\t\t\t\t\tconst { execSync } = await import(\"node:child_process\");\n\t\t\t\t\tconst tscOutput = execSync(\"npx tsc --noEmit --pretty false 2>&1 || true\", {\n\t\t\t\t\t\tcwd: context.workspaceRoot,\n\t\t\t\t\t\tencoding: \"utf8\",\n\t\t\t\t\t\ttimeout: 30000,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Count TypeScript errors\n\t\t\t\t\tconst errorMatches = tscOutput.match(/error TS\\d+:/g);\n\t\t\t\t\tconst tsErrorCount = errorMatches ? errorMatches.length : 0;\n\n\t\t\t\t\tif (tsErrorCount > 0) {\n\t\t\t\t\t\tnewBlockers.push({\n\t\t\t\t\t\t\tkey: \"_ts\",\n\t\t\t\t\t\t\tlabel: \"typescript-errors\",\n\t\t\t\t\t\t\tcurrent: tsErrorCount,\n\t\t\t\t\t\t\ttarget: 0,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} catch (tsError) {\n\t\t\t\t\t// TypeScript check failed - non-blocking\n\t\t\t\t\tconsole.error(\"TypeScript scan failed:\", tsError);\n\t\t\t\t}\n\n\t\t\t\t// Scan for bundle size (if extension exists)\n\t\t\t\tconst extensionDistPath = join(context.workspaceRoot, \"apps\", \"vscode\", \"dist\");\n\t\t\t\tif (existsSync(extensionDistPath)) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst { readdirSync, statSync } = await import(\"node:fs\");\n\t\t\t\t\t\tlet totalSize = 0;\n\n\t\t\t\t\t\tconst calculateDirSize = (dir: string): void => {\n\t\t\t\t\t\t\tconst files = readdirSync(dir);\n\t\t\t\t\t\t\tfor (const file of files) {\n\t\t\t\t\t\t\t\tconst filePath = join(dir, file);\n\t\t\t\t\t\t\t\tconst stats = statSync(filePath);\n\t\t\t\t\t\t\t\tif (stats.isDirectory()) {\n\t\t\t\t\t\t\t\t\tcalculateDirSize(filePath);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\ttotalSize += stats.size;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tcalculateDirSize(extensionDistPath);\n\t\t\t\t\t\tconst sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);\n\t\t\t\t\t\tconst maxSizeMB = contextData.constraints?.extension?.bundle?.max || 150 / 1024; // Convert KB to MB if needed\n\n\t\t\t\t\t\tif (Number.parseFloat(sizeInMB) > maxSizeMB) {\n\t\t\t\t\t\t\tnewBlockers.push({\n\t\t\t\t\t\t\t\tkey: \"_eb\",\n\t\t\t\t\t\t\t\tlabel: \"bundle-size\",\n\t\t\t\t\t\t\t\tcurrent: `${sizeInMB}MB`,\n\t\t\t\t\t\t\t\ttarget: `${maxSizeMB}MB`,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (bundleError) {\n\t\t\t\t\t\t// Bundle scan failed - non-blocking\n\t\t\t\t\t\tconsole.error(\"Bundle size scan failed:\", bundleError);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Update context with new blockers and scan timestamp\n\t\t\t\tcontextData.blockers = newBlockers;\n\t\t\t\tcontextData.lastScanned = new Date().toISOString();\n\t\t\t\tcontextData.updated_at = new Date().toISOString();\n\n\t\t\t\t// Write updated context\n\t\t\t\tconst writeResult = atomicWriteFileSync(ctxPath, JSON.stringify(contextData, null, 2));\n\t\t\t\tif (!writeResult.success) {\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"scan\",\n\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\t\tmessage: writeResult.error,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"scan\",\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tscannedAt: contextData.lastScanned,\n\t\t\t\t\tblockers: newBlockers,\n\t\t\t\t\tblockersFound: newBlockers.length,\n\t\t\t\t\tmessage:\n\t\t\t\t\t\tnewBlockers.length > 0\n\t\t\t\t\t\t\t? `Found ${newBlockers.length} blocker(s) - ${newBlockers.map((b) => b.label).join(\", \")}`\n\t\t\t\t\t\t\t: \"No blockers detected\",\n\t\t\t\t\tnext_actions:\n\t\t\t\t\t\tnewBlockers.length > 0\n\t\t\t\t\t\t\t? [{ tool: \"context\", priority: 2, reason: \"Review blockers\", args: { op: \"blockers\" } }]\n\t\t\t\t\t\t\t: [],\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"scan\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E404_CONTEXT_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Scan failed: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tdefault:\n\t\t\treturn jsonResult({\n\t\t\t\top,\n\t\t\t\tstatus: \"error\",\n\t\t\t\terror: \"E103_INVALID_PARAM_VALUE\",\n\t\t\t\tmessage: `Unknown context operation: ${op}`,\n\t\t\t\tvalidOps: [\"init\", \"build\", \"validate\", \"status\", \"constraint\", \"check\", \"blockers\", \"reset\", \"scan\"],\n\t\t\t});\n\t}\n};\n\n/**\n * session - Session management\n * P1-005: Full implementation of session operations\n */\nexport const handleSession: ToolHandler = async (args, context) => {\n\tconst { op, taskDescription, files, acceptLearnings } = args as {\n\t\top?: string;\n\t\ttaskDescription?: string;\n\t\tfiles?: string[];\n\t\tacceptLearnings?: number[];\n\t};\n\n\tif (!op) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"op\"));\n\t}\n\n\tconst sessionDir = join(context.workspaceRoot, \".snapback\", \"session\");\n\tconst sessionPath = join(sessionDir, \"current.json\");\n\tconst learningsPath = join(context.workspaceRoot, \".snapback\", \"learnings\", \"learnings.jsonl\");\n\n\tswitch (op) {\n\t\tcase \"start\": {\n\t\t\t// Create session directory if needed\n\t\t\tif (!existsSync(sessionDir)) {\n\t\t\t\tawait import(\"node:fs\").then((fs) => fs.mkdirSync(sessionDir, { recursive: true }));\n\t\t\t}\n\n\t\t\t// Check for existing session\n\t\t\tif (existsSync(sessionPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tconst existingSession = JSON.parse(readFileSync(sessionPath, \"utf8\"));\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"start\",\n\t\t\t\t\t\tstatus: \"already_active\",\n\t\t\t\t\t\tsession: existingSession,\n\t\t\t\t\t\tmessage: \"Session already active - end current session first\",\n\t\t\t\t\t\tnext_actions: [\n\t\t\t\t\t\t\t{ tool: \"session\", priority: 1, reason: \"End current session\", args: { op: \"end\" } },\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t} catch {\n\t\t\t\t\t// Continue to create new session if parse fails\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Create new session\n\t\t\tconst sessionId = `sess_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;\n\t\t\tconst session = {\n\t\t\t\tid: sessionId,\n\t\t\t\tstartedAt: new Date().toISOString(),\n\t\t\t\ttaskDescription: taskDescription || \"MCP session\",\n\t\t\t\tplannedFiles: files || [],\n\t\t\t\tsnapshotCount: 0,\n\t\t\t\tmodifiedFiles: [],\n\t\t\t\ttier: context.tier,\n\t\t\t};\n\n\t\t\t// P0-002: Use atomic write for crash safety\n\t\t\tconst writeResult = atomicWriteFileSync(sessionPath, JSON.stringify(session, null, 2));\n\t\t\tif (!writeResult.success) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"start\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E405_SESSION_OPERATION_FAILED\",\n\t\t\t\t\tmessage: writeResult.error,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// Get recommendations based on planned files\n\t\t\tconst recommendations: string[] = [];\n\t\t\tif (files && files.length > 0) {\n\t\t\t\tconst hasAuthFiles = files.some((f) => f.includes(\"auth\") || f.includes(\"security\"));\n\t\t\t\tconst hasConfigFiles = files.some((f) => f.includes(\"config\") || f.includes(\".env\"));\n\t\t\t\tif (hasAuthFiles) {\n\t\t\t\t\trecommendations.push(\"Create snapshot before modifying auth-related files\");\n\t\t\t\t}\n\t\t\t\tif (hasConfigFiles) {\n\t\t\t\t\trecommendations.push(\"Verify config changes with prepare_workspace after edits\");\n\t\t\t\t}\n\t\t\t\tif (files.length > 5) {\n\t\t\t\t\trecommendations.push(\"Consider breaking this into smaller focused sessions\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn jsonResult({\n\t\t\t\top: \"start\",\n\t\t\t\tstatus: \"success\",\n\t\t\t\tsession,\n\t\t\t\trecommendations,\n\t\t\t\tmessage: \"Session started\",\n\t\t\t\tnext_actions: [\n\t\t\t\t\t{ tool: \"prepare_workspace\", priority: 1, reason: \"Check workspace state before starting\" },\n\t\t\t\t],\n\t\t\t});\n\t\t}\n\t\tcase \"stats\": {\n\t\t\tif (existsSync(sessionPath)) {\n\t\t\t\ttry {\n\t\t\t\t\tconst session = JSON.parse(readFileSync(sessionPath, \"utf8\"));\n\t\t\t\t\tconst startTime = new Date(session.startedAt).getTime();\n\t\t\t\t\tconst duration = Math.floor((Date.now() - startTime) / 60000); // minutes\n\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"stats\",\n\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t...session,\n\t\t\t\t\t\t\tdurationMinutes: duration,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tmessage: \"Session active\",\n\t\t\t\t\t});\n\t\t\t\t} catch {\n\t\t\t\t\t// Fallthrough to no session\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn jsonResult({\n\t\t\t\top: \"stats\",\n\t\t\t\tsession: null,\n\t\t\t\tmessage: \"No active session\",\n\t\t\t\thint: \"Use op: start to begin a session\",\n\t\t\t});\n\t\t}\n\t\tcase \"recommendations\": {\n\t\t\tif (!existsSync(sessionPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"recommendations\",\n\t\t\t\t\trecommendations: [\"Start a session to get personalized recommendations\"],\n\t\t\t\t\tmessage: \"No active session\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst session = JSON.parse(readFileSync(sessionPath, \"utf8\"));\n\t\t\t\tconst recommendations: string[] = [];\n\n\t\t\t\t// Time-based recommendations\n\t\t\t\tconst startTime = new Date(session.startedAt).getTime();\n\t\t\t\tconst duration = (Date.now() - startTime) / 60000;\n\t\t\t\tif (duration > 60) {\n\t\t\t\t\trecommendations.push(\"Session running for over an hour - consider taking a break\");\n\t\t\t\t}\n\t\t\t\tif (session.snapshotCount === 0 && duration > 15) {\n\t\t\t\t\trecommendations.push(\"No snapshots created yet - consider creating a checkpoint\");\n\t\t\t\t}\n\n\t\t\t\t// Load learnings for personalized recommendations\n\t\t\t\tif (existsSync(learningsPath)) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst learnings = readFileSync(learningsPath, \"utf8\")\n\t\t\t\t\t\t\t.split(\"\\n\")\n\t\t\t\t\t\t\t.filter(Boolean)\n\t\t\t\t\t\t\t.map((line) => JSON.parse(line));\n\t\t\t\t\t\tconst recentLearnings = learnings.slice(-3);\n\t\t\t\t\t\tfor (const learning of recentLearnings) {\n\t\t\t\t\t\t\trecommendations.push(`Remember: ${learning.action}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Ignore learning parse errors\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"recommendations\",\n\t\t\t\t\tsessionId: session.id,\n\t\t\t\t\trecommendations: recommendations.length > 0 ? recommendations : [\"All clear! Keep coding.\"],\n\t\t\t\t\tmessage: `${recommendations.length} recommendation(s)`,\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"recommendations\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E405_SESSION_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to get recommendations: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tcase \"end\": {\n\t\t\tif (!existsSync(sessionPath)) {\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"end\",\n\t\t\t\t\tstatus: \"no_session\",\n\t\t\t\t\tmessage: \"No active session to end\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst session = JSON.parse(readFileSync(sessionPath, \"utf8\"));\n\t\t\t\tconst startTime = new Date(session.startedAt).getTime();\n\t\t\t\tconst duration = Math.floor((Date.now() - startTime) / 60000);\n\n\t\t\t\t// Archive session\n\t\t\t\tconst archiveDir = join(sessionDir, \"archive\");\n\t\t\t\tif (!existsSync(archiveDir)) {\n\t\t\t\t\tawait import(\"node:fs\").then((fs) => fs.mkdirSync(archiveDir, { recursive: true }));\n\t\t\t\t}\n\n\t\t\t\tconst archivedSession = {\n\t\t\t\t\t...session,\n\t\t\t\t\tendedAt: new Date().toISOString(),\n\t\t\t\t\tdurationMinutes: duration,\n\t\t\t\t};\n\n\t\t\t\tconst archivePath = join(archiveDir, `${session.id}.json`);\n\t\t\t\t// P0-002: Use atomic write for crash safety\n\t\t\t\tconst archiveWriteResult = atomicWriteFileSync(archivePath, JSON.stringify(archivedSession, null, 2));\n\t\t\t\tif (!archiveWriteResult.success) {\n\t\t\t\t\treturn jsonResult({\n\t\t\t\t\t\top: \"end\",\n\t\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\t\terror: \"E405_SESSION_OPERATION_FAILED\",\n\t\t\t\t\t\tmessage: archiveWriteResult.error,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Remove current session\n\t\t\t\tawait import(\"node:fs\").then((fs) => fs.unlinkSync(sessionPath));\n\n\t\t\t\t// Suggest learnings to accept\n\t\t\t\tconst suggestedLearnings = [\n\t\t\t\t\t{ index: 0, suggestion: \"What patterns did you discover?\" },\n\t\t\t\t\t{ index: 1, suggestion: \"Any pitfalls to avoid next time?\" },\n\t\t\t\t];\n\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"end\",\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tsummary: {\n\t\t\t\t\t\tsessionId: session.id,\n\t\t\t\t\t\tdurationMinutes: duration,\n\t\t\t\t\t\tsnapshotCount: session.snapshotCount,\n\t\t\t\t\t\tmodifiedFiles: session.modifiedFiles?.length || 0,\n\t\t\t\t\t},\n\t\t\t\t\tarchivePath,\n\t\t\t\t\tsuggestedLearnings: acceptLearnings ? [] : suggestedLearnings,\n\t\t\t\t\tmessage: `Session ended after ${duration} minutes`,\n\t\t\t\t\tnext_actions: [{ tool: \"learn\", priority: 1, reason: \"Record learnings from this session\" }],\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : String(error);\n\t\t\t\treturn jsonResult({\n\t\t\t\t\top: \"end\",\n\t\t\t\t\tstatus: \"error\",\n\t\t\t\t\terror: \"E405_SESSION_OPERATION_FAILED\",\n\t\t\t\t\tmessage: `Failed to end session: ${msg}`,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tdefault:\n\t\t\treturn jsonResult({\n\t\t\t\top,\n\t\t\t\tstatus: \"error\",\n\t\t\t\terror: \"E103_INVALID_PARAM_VALUE\",\n\t\t\t\tmessage: `Unknown session operation: ${op}`,\n\t\t\t\tvalidOps: [\"start\", \"stats\", \"recommendations\", \"end\"],\n\t\t\t});\n\t}\n};\n\n/**\n * learn - Record learnings\n */\nexport const handleLearn: ToolHandler = async (args, context) => {\n\tconst { type, trigger, action, source } = args as {\n\t\ttype?: string;\n\t\ttrigger?: string;\n\t\taction?: string;\n\t\tsource?: string;\n\t};\n\n\tif (!type || !trigger || !action) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"type, trigger, action\"));\n\t}\n\n\t// Generate unique learning ID: learn_{timestamp}_{random}\n\tconst timestamp = Date.now().toString(36);\n\tconst random = Math.random().toString(36).substring(2, 6);\n\tconst id = `learn_${timestamp}${random}`;\n\n\tconst learning = {\n\t\tid,\n\t\ttype,\n\t\ttrigger,\n\t\taction,\n\t\tsource: source || \"mcp\",\n\t\ttimestamp: new Date().toISOString(),\n\t};\n\n\t// Check if we can write to workspace (local mode) or if this is remote mode\n\tconst learningsPath = join(context.workspaceRoot, \".snapback\", \"learnings\", \"learnings.jsonl\");\n\tconst isRemoteMode = !isLocalWorkspace(context.workspaceRoot);\n\n\tif (isRemoteMode) {\n\t\t// Remote mode: Return learning data for client to store\n\t\t// The VS Code extension or CLI will write this locally\n\t\treturn jsonResult({\n\t\t\tid,\n\t\t\tstatus: \"success\",\n\t\t\tlearning,\n\t\t\tmessage: \"Learning captured (client-side storage required)\",\n\t\t\tremoteMode: true,\n\t\t\tinstruction: \"Store this learning locally in .snapback/learnings/learnings.jsonl\",\n\t\t});\n\t}\n\n\t// Local mode: Write to filesystem\n\ttry {\n\t\t// Ensure directory exists\n\t\tconst dir = dirname(learningsPath);\n\t\tif (!existsSync(dir)) {\n\t\t\tawait import(\"node:fs\").then((fs) => fs.mkdirSync(dir, { recursive: true }));\n\t\t}\n\n\t\t// Append to JSONL file\n\t\tconst line = `${JSON.stringify(learning)}\\n`;\n\t\tawait import(\"node:fs\").then((fs) => fs.appendFileSync(learningsPath, line));\n\n\t\t// Index into KnowledgeStore for hybrid retrieval (non-blocking)\n\t\tindexLearning(context.workspaceRoot, learning).catch((indexError) => {\n\t\t\tconsole.warn(\"[handleLearn] Failed to index learning:\", indexError);\n\t\t});\n\n\t\t// Invalidate retriever cache so next query picks up new learning\n\t\tinvalidateRetrieverCache(context.workspaceRoot);\n\t\tinvalidateKnowledgeCache(context.workspaceRoot);\n\n\t\treturn jsonResult({\n\t\t\tid,\n\t\t\tstatus: \"success\",\n\t\t\tlearning,\n\t\t\tmessage: \"Learning recorded\",\n\t\t\tstoragePath: learningsPath,\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\n\t\t// If write fails, fall back to returning data for client-side storage\n\t\tif (message.includes(\"EACCES\") || message.includes(\"EPERM\") || message.includes(\"permission\")) {\n\t\t\treturn jsonResult({\n\t\t\t\tid,\n\t\t\t\tstatus: \"success\",\n\t\t\t\tlearning,\n\t\t\t\tmessage: \"Learning captured (permission denied, client-side storage required)\",\n\t\t\t\tremoteMode: true,\n\t\t\t\tinstruction: \"Store this learning locally in .snapback/learnings/learnings.jsonl\",\n\t\t\t\twarning: \"Server cannot write to workspace directory\",\n\t\t\t});\n\t\t}\n\n\t\treturn result(`Failed to record learning: ${message}`, true);\n\t}\n};\n\n/**\n * acknowledge_risk - Acknowledge risk\n */\nexport const handleAcknowledgeRisk: ToolHandler = async (args, context) => {\n\tconst { files, reason } = args as { files?: string[]; reason?: string };\n\n\tif (!files || !reason) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"files, reason\"));\n\t}\n\n\tconst acknowledgment = {\n\t\tfiles,\n\t\treason,\n\t\tacknowledgedAt: new Date().toISOString(),\n\t\ttier: context.tier,\n\t};\n\n\t// Log to .snapback/audit/\n\tconst auditPath = join(context.workspaceRoot, \".snapback\", \"audit\", \"acknowledgments.jsonl\");\n\n\ttry {\n\t\tconst dir = dirname(auditPath);\n\t\tif (!existsSync(dir)) {\n\t\t\tawait import(\"node:fs\").then((fs) => fs.mkdirSync(dir, { recursive: true }));\n\t\t}\n\t\tconst line = `${JSON.stringify(acknowledgment)}\\n`;\n\t\tawait import(\"node:fs\").then((fs) => fs.appendFileSync(auditPath, line));\n\t} catch {\n\t\t// Non-fatal - continue even if audit fails\n\t}\n\n\treturn jsonResult({\n\t\tstatus: \"acknowledged\",\n\t\tacknowledged: true,\n\t\tfiles,\n\t\treason,\n\t\ttimestamp: acknowledgment.acknowledgedAt,\n\t\tmessage: \"Risk acknowledged - proceed with changes\",\n\t\tnext_actions: [\n\t\t\t{\n\t\t\t\ttool: \"snapshot_create\",\n\t\t\t\tpriority: 1,\n\t\t\t\treason: \"Create safety snapshot\",\n\t\t\t\targs: { files, reason: `Pre-risk: ${reason}` },\n\t\t\t},\n\t\t],\n\t});\n};\n\n/**\n * get_context - Get workspace context and learnings for a task\n * Uses Intelligence facade for semantic retrieval\n */\nexport const handleGetContext: ToolHandler = async (args, context) => {\n\tconst { task, files, keywords } = args as {\n\t\ttask?: string;\n\t\tfiles?: string[];\n\t\tkeywords?: string[];\n\t};\n\n\tif (!task) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"task\"));\n\t}\n\n\ttry {\n\t\tconst intel = getIntelligence(context.workspaceRoot);\n\n\t\t// Get context from Intelligence\n\t\tconst ctx = await intel.getContext({\n\t\t\ttask,\n\t\t\tfiles: files || [],\n\t\t\tkeywords: keywords || [],\n\t\t});\n\n\t\t// Get violations summary\n\t\tconst violations = intel.getViolationsSummary();\n\n\t\t// Get vitals snapshot\n\t\tconst vitals = intel.getVitalsSnapshot(context.workspaceRoot);\n\n\t\treturn jsonResult({\n\t\t\tworkspace: {\n\t\t\t\troot: context.workspaceRoot,\n\t\t\t\ttier: context.tier,\n\t\t\t},\n\t\t\tcontext: {\n\t\t\t\tpatterns: ctx.patterns,\n\t\t\t\thardRules: ctx.hardRules,\n\t\t\t\tcontextSections: ctx.contextSections,\n\t\t\t\thint: ctx.hint,\n\t\t\t},\n\t\t\trelevantLearnings: ctx.relevantLearnings.slice(0, 10).map((l) => ({\n\t\t\t\ttype: l.type,\n\t\t\t\ttrigger: l.trigger,\n\t\t\t\taction: l.action,\n\t\t\t})),\n\t\t\trecentViolations: ctx.recentViolations.slice(0, 5).map((v) => ({\n\t\t\t\ttype: v.type,\n\t\t\t\tfile: v.file,\n\t\t\t\tmessage: v.message,\n\t\t\t\tprevention: v.prevention,\n\t\t\t})),\n\t\t\tviolationsSummary: {\n\t\t\t\ttotal: violations.total,\n\t\t\t\treadyForPromotion: violations.readyForPromotion,\n\t\t\t\treadyForAutomation: violations.readyForAutomation,\n\t\t\t},\n\t\t\tvitals: vitals\n\t\t\t\t? {\n\t\t\t\t\t\tpulse: vitals.pulse.level,\n\t\t\t\t\t\tpressure: vitals.pressure.value,\n\t\t\t\t\t\ttrajectory: vitals.trajectory,\n\t\t\t\t\t}\n\t\t\t\t: null,\n\t\t\tnext_actions: [{ tool: \"check_patterns\", priority: 2, reason: \"Validate code before commit\" }],\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Failed to get context: ${message}`, true);\n\t}\n};\n\n/**\n * check_patterns - Validate code against patterns using 7-layer ValidationPipeline\n * Uses Intelligence facade for full validation\n */\nexport const handleCheckPatterns: ToolHandler = async (args, context) => {\n\tconst { code, filePath } = args as {\n\t\tcode?: string;\n\t\tfilePath?: string;\n\t};\n\n\tif (!code || !filePath) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"code, filePath\"));\n\t}\n\n\ttry {\n\t\tconst intel = getIntelligence(context.workspaceRoot);\n\n\t\t// Run full 7-layer validation\n\t\tconst validation = await intel.checkPatterns(code, filePath);\n\n\t\treturn jsonResult({\n\t\t\tpassed: validation.overall.passed,\n\t\t\tconfidence: validation.overall.confidence,\n\t\t\ttotalIssues: validation.overall.totalIssues,\n\t\t\trecommendation: validation.recommendation,\n\t\t\tlayers: validation.layers.map((l) => ({\n\t\t\t\tname: l.layer,\n\t\t\t\tpassed: l.passed,\n\t\t\t\tissueCount: l.issues.length,\n\t\t\t\tissues: l.issues.map((i) => ({\n\t\t\t\t\tseverity: i.severity,\n\t\t\t\t\ttype: i.type,\n\t\t\t\t\tmessage: i.message,\n\t\t\t\t\tline: i.line,\n\t\t\t\t\tfix: i.fix,\n\t\t\t\t})),\n\t\t\t\tduration: l.duration,\n\t\t\t})),\n\t\t\tfocusPoints: validation.focusPoints,\n\t\t\tnext_actions: validation.overall.passed\n\t\t\t\t? []\n\t\t\t\t: [{ tool: \"check_patterns\", priority: 1, reason: \"Re-validate after fixes\" }],\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Failed to check patterns: ${message}`, true);\n\t}\n};\n\n/**\n * report_violation - Report a constraint/pattern violation for learning\n * Uses Intelligence facade for violation tracking with auto-promotion\n */\nexport const handleReportViolation: ToolHandler = async (args, context) => {\n\tconst { type, file, whatHappened, whyItHappened, prevention } = args as {\n\t\ttype?: string;\n\t\tfile?: string;\n\t\twhatHappened?: string;\n\t\twhyItHappened?: string;\n\t\tprevention?: string;\n\t};\n\n\tif (!type || !file || !whatHappened || !whyItHappened || !prevention) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"type, file, whatHappened, whyItHappened, prevention\"));\n\t}\n\n\ttry {\n\t\tconst intel = getIntelligence(context.workspaceRoot);\n\n\t\t// Report violation to Intelligence\n\t\tconst status = await intel.reportViolation({\n\t\t\ttype,\n\t\t\tfile,\n\t\t\tmessage: whatHappened,\n\t\t\treason: whyItHappened,\n\t\t\tprevention,\n\t\t});\n\n\t\treturn jsonResult({\n\t\t\trecorded: true,\n\t\t\tviolationId: status.id,\n\t\t\ttype,\n\t\t\tfile,\n\t\t\toccurrences: status.count,\n\t\t\tpromoted: status.shouldPromote,\n\t\t\tpromotedTo: status.shouldPromote ? \"pattern\" : null,\n\t\t\tautomation: status.shouldAutomate ? \"pending\" : null,\n\t\t\tmessage: status.shouldPromote\n\t\t\t\t? `Violation promoted to pattern after ${status.count} occurrences`\n\t\t\t\t: `Violation recorded (${status.count}/3 for promotion)`,\n\t\t\tnext_actions: status.shouldPromote\n\t\t\t\t? [{ tool: \"get_context\", priority: 2, reason: \"New pattern available in context\" }]\n\t\t\t\t: [],\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Failed to report violation: ${message}`, true);\n\t}\n};\n\n/**\n * Calculate package relevance score for a learning\n * @param learningPackages - Packages associated with the learning\n * @param queryPackages - Packages to match against\n * @returns Score from 0-100 based on package overlap\n */\nfunction calculatePackageScore(learningPackages: string[] | undefined, queryPackages: string[]): number {\n\tif (!learningPackages || learningPackages.length === 0 || queryPackages.length === 0) {\n\t\treturn 0;\n\t}\n\n\tlet matches = 0;\n\tfor (const queryPkg of queryPackages) {\n\t\tconst queryLower = queryPkg.toLowerCase();\n\t\tfor (const learningPkg of learningPackages) {\n\t\t\tconst learningLower = learningPkg.toLowerCase();\n\t\t\t// Exact match or partial match (e.g., \"vscode\" matches \"@snapback/vscode\")\n\t\t\tif (\n\t\t\t\tlearningLower === queryLower ||\n\t\t\t\tlearningLower.includes(queryLower) ||\n\t\t\t\tqueryLower.includes(learningLower)\n\t\t\t) {\n\t\t\t\tmatches++;\n\t\t\t\tbreak; // Count each query package once\n\t\t\t}\n\t\t}\n\t}\n\n\t// Score based on percentage of query packages matched, plus bonus for multiple learning packages matched\n\tconst matchRatio = matches / queryPackages.length;\n\treturn Math.round(matchRatio * 100);\n}\n\n/**\n * get_learnings - Query past learnings by keywords with package-aware retrieval\n * Uses TieredLearningService for efficient token usage\n *\n * Supports:\n * - intent: Task intent for domain file selection (implement, debug, refactor, review, explore)\n * - includeCold: Whether to also search cold tier (default: true for explicit queries)\n * - packages: Array of package names to match against\n * - packageMode: \"boost\" (default) or \"filter\"\n *   - boost: All learnings returned, sorted by package relevance\n *   - filter: Only learnings matching packages are returned\n */\nexport const handleGetLearnings: ToolHandler = async (args, context) => {\n\tconst {\n\t\tkeywords,\n\t\tlimit = 10,\n\t\tintent = \"implement\",\n\t\tincludeCold = true,\n\t\tpackages,\n\t\tpackageMode = \"boost\",\n\t} = args as {\n\t\tkeywords?: string[];\n\t\tlimit?: number;\n\t\tintent?: \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\t\tincludeCold?: boolean;\n\t\tpackages?: string[];\n\t\tpackageMode?: \"boost\" | \"filter\";\n\t};\n\n\tif (!keywords || keywords.length === 0) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"keywords\"));\n\t}\n\n\ttry {\n\t\t// Use TieredLearningService for efficient loading (P0 token efficiency)\n\t\tconst { TieredLearningService } = await import(\"../services/tiered-learning-service.js\");\n\t\tconst tieredService = new TieredLearningService(context.workspaceRoot);\n\n\t\t// Load hot + warm tier based on intent\n\t\tconst tieredLearnings = await tieredService.loadTieredLearnings({\n\t\t\tintent,\n\t\t\tkeywords,\n\t\t\tmaxLearnings: limit * 2, // Get more initially for filtering\n\t\t});\n\n\t\t// Optionally also query cold tier for explicit searches\n\t\tlet coldLearnings: typeof tieredLearnings = [];\n\t\tif (includeCold) {\n\t\t\tcoldLearnings = await tieredService.queryColdTier(keywords, limit);\n\t\t}\n\n\t\t// Combine and deduplicate\n\t\tconst seen = new Set(tieredLearnings.map((l) => l.id));\n\t\tconst allLearnings = [...tieredLearnings, ...coldLearnings.filter((l) => !seen.has(l.id))];\n\n\t\t// Convert to expected format, preserving packages for scoring\n\t\tconst learnings = allLearnings.map((l) => ({\n\t\t\tid: l.id,\n\t\t\ttype: l.type,\n\t\t\ttrigger: Array.isArray(l.trigger) ? l.trigger.join(\", \") : l.trigger,\n\t\t\taction: l.action,\n\t\t\tsource: l.source,\n\t\t\ttimestamp: l.timestamp,\n\t\t\tloadedFrom: l.loadedFrom,\n\t\t\tpackages: (l as unknown as { packages?: string[] }).packages, // Preserve packages for scoring\n\t\t}));\n\n\t\t// Determine if we should apply package scoring\n\t\tconst shouldScorePackages = packages && packages.length > 0;\n\t\tconst effectiveMode = packageMode === \"filter\" ? \"filter\" : \"boost\";\n\n\t\t// Calculate package scores and optionally filter\n\t\ttype LearningWithScore = (typeof learnings)[number] & { packageScore?: number };\n\t\tlet scoredLearnings: LearningWithScore[] = learnings.map((l) => {\n\t\t\t// Cast to access packages field that may exist on the stored learning\n\t\t\tconst learningWithPkgs = l as typeof l & { packages?: string[] };\n\t\t\tconst score = shouldScorePackages ? calculatePackageScore(learningWithPkgs.packages, packages) : undefined;\n\t\t\treturn { ...l, packages: learningWithPkgs.packages, packageScore: score };\n\t\t});\n\n\t\t// Apply filter mode if specified\n\t\tif (shouldScorePackages && effectiveMode === \"filter\") {\n\t\t\tscoredLearnings = scoredLearnings.filter((l) => (l.packageScore ?? 0) > 0);\n\t\t}\n\n\t\t// Sort by package score (highest first) when packages are specified\n\t\tif (shouldScorePackages) {\n\t\t\tscoredLearnings.sort((a, b) => (b.packageScore ?? 0) - (a.packageScore ?? 0));\n\t\t}\n\n\t\tconst limited = scoredLearnings.slice(0, Math.min(limit, 50));\n\n\t\t// Build the response\n\t\tconst response: Record<string, unknown> = {\n\t\t\tquery: keywords,\n\t\t\tcount: limited.length,\n\t\t\ttotalMatches: scoredLearnings.length,\n\t\t\tlearnings: limited.map((l) => {\n\t\t\t\tconst base: Record<string, unknown> = {\n\t\t\t\t\tid: l.id,\n\t\t\t\t\ttype: l.type,\n\t\t\t\t\ttrigger: l.trigger,\n\t\t\t\t\taction: l.action,\n\t\t\t\t\tsource: l.source,\n\t\t\t\t\ttimestamp: l.timestamp,\n\t\t\t\t};\n\t\t\t\t// Only include packageScore when packages were specified\n\t\t\t\tif (shouldScorePackages) {\n\t\t\t\t\tbase.packageScore = l.packageScore ?? 0;\n\t\t\t\t}\n\t\t\t\treturn base;\n\t\t\t}),\n\t\t\tmessage:\n\t\t\t\tlimited.length > 0\n\t\t\t\t\t? `Found ${limited.length} learning(s) matching keywords`\n\t\t\t\t\t: \"No learnings found for these keywords\",\n\t\t\tnext_actions: limited.length === 0 ? [{ tool: \"learn\", priority: 2, reason: \"Record a new learning\" }] : [],\n\t\t};\n\n\t\t// Include packageContext when packages were specified\n\t\tif (shouldScorePackages) {\n\t\t\tresponse.packageContext = packages;\n\t\t}\n\n\t\treturn jsonResult(response);\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Failed to get learnings: ${message}`, true);\n\t}\n};\n\n/**\n * Tool definition for hierarchy\n */\ninterface ToolDefinition {\n\tname: string;\n\tstatus: \"implemented\" | \"planned\" | \"deprecated\";\n\tdescription: string;\n}\n\n/**\n * Tool hierarchy by category\n */\nconst TOOL_HIERARCHY: Record<string, ToolDefinition[]> = {\n\tentry_points: [\n\t\t{ name: \"begin_task\", status: \"implemented\", description: \"Start any task with context and optional snapshot\" },\n\t\t{ name: \"get_context\", status: \"implemented\", description: \"Get workspace context and learnings for a task\" },\n\t\t{\n\t\t\tname: \"prepare_workspace\",\n\t\t\tstatus: \"implemented\",\n\t\t\tdescription: \"Pre-flight workspace check before risky ops\",\n\t\t},\n\t],\n\tprotection: [\n\t\t{ name: \"snapshot_create\", status: \"implemented\", description: \"Create file snapshot\" },\n\t\t{ name: \"snapshot_list\", status: \"implemented\", description: \"List available snapshots\" },\n\t\t{ name: \"snapshot_restore\", status: \"implemented\", description: \"Restore from snapshot\" },\n\t\t{ name: \"suggest_snapshot\", status: \"implemented\", description: \"Get proactive snapshot recommendations\" },\n\t\t{ name: \"compare_snapshots\", status: \"implemented\", description: \"Compare snapshots or snapshot to current\" },\n\t\t{ name: \"acknowledge_risk\", status: \"implemented\", description: \"Acknowledge risk state before proceeding\" },\n\t],\n\tvalidation: [\n\t\t{ name: \"check_patterns\", status: \"implemented\", description: \"Validate code against 7-layer pipeline\" },\n\t\t{ name: \"validate\", status: \"implemented\", description: \"Quick or comprehensive code validation\" },\n\t\t{ name: \"quick_check\", status: \"implemented\", description: \"Fast parallel TypeScript, tests, lint check\" },\n\t],\n\tknowledge: [\n\t\t{ name: \"learn\", status: \"implemented\", description: \"Record learnings from sessions\" },\n\t\t{ name: \"get_learnings\", status: \"implemented\", description: \"Query past learnings with package awareness\" },\n\t\t{ name: \"report_violation\", status: \"implemented\", description: \"Report violations with auto-promotion\" },\n\t],\n\tdiscovery: [\n\t\t{ name: \"lookup_exports\", status: \"implemented\", description: \"Find valid import paths for packages\" },\n\t\t{ name: \"analyze\", status: \"implemented\", description: \"Risk and package analysis\" },\n\t],\n\tlifecycle: [\n\t\t{ name: \"complete_task\", status: \"implemented\", description: \"Finish task with summary and learnings\" },\n\t\t{ name: \"review_work\", status: \"implemented\", description: \"Pre-commit review of changes\" },\n\t\t{ name: \"what_changed\", status: \"implemented\", description: \"See changes since task start\" },\n\t],\n\tsession: [\n\t\t{ name: \"session\", status: \"implemented\", description: \"Session lifecycle management\" },\n\t\t{ name: \"context\", status: \"implemented\", description: \"Context management (init, build, validate)\" },\n\t],\n\tmaintenance: [\n\t\t{ name: \"cleanup\", status: \"implemented\", description: \"Reclaim space by removing stale data\" },\n\t\t{ name: \"meta\", status: \"implemented\", description: \"Tool metadata and hierarchy\" },\n\t],\n};\n\n/**\n * Recommended workflows\n */\nconst WORKFLOWS = [\n\t{\n\t\tname: \"start_development\",\n\t\tdescription: \"Begin a development task safely\",\n\t\tsteps: [\"begin_task\", \"implement changes\", \"quick_check\", \"check_patterns\", \"complete_task\"],\n\t},\n\t{\n\t\tname: \"recovery\",\n\t\tdescription: \"Recover from broken changes\",\n\t\tsteps: [\"snapshot_list\", \"compare_snapshots\", \"snapshot_restore\"],\n\t},\n\t{\n\t\tname: \"learning_loop\",\n\t\tdescription: \"Capture and retrieve knowledge\",\n\t\tsteps: [\"get_learnings\", \"work\", \"learn\", \"report_violation (if needed)\"],\n\t},\n];\n\n/**\n * meta - Tool metadata with hierarchy\n */\nexport const handleMeta: ToolHandler = async (_args, _context) => {\n\t// Flatten hierarchy into tools list for backward compatibility\n\tconst tools: ToolDefinition[] = [];\n\tfor (const category of Object.values(TOOL_HIERARCHY)) {\n\t\tfor (const tool of category) {\n\t\t\t// Avoid duplicates (a tool might appear in multiple categories conceptually)\n\t\t\tif (!tools.some((t) => t.name === tool.name)) {\n\t\t\t\ttools.push(tool);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn jsonResult({\n\t\tversion: \"0.1.0\",\n\t\tstatus: \"operational\",\n\t\t// Flat list for backward compatibility\n\t\ttools,\n\t\t// New hierarchical organization\n\t\thierarchy: TOOL_HIERARCHY,\n\t\t// Workflow recommendations\n\t\tworkflows: WORKFLOWS,\n\t\t// Summary statistics\n\t\tsummary: {\n\t\t\ttotalTools: tools.length,\n\t\t\tcategories: Object.keys(TOOL_HIERARCHY).length,\n\t\t\timplementedCount: tools.filter((t) => t.status === \"implemented\").length,\n\t\t},\n\t});\n};\n\n/**\n * cleanup - Reclaim space by removing stale data\n *\n * Cleans up:\n * - Old snapshots beyond retention policy\n * - Stale learnings (age or architecture mismatch)\n * - Archived sessions\n * - Orphaned blobs (not referenced by any snapshot)\n */\nexport const handleCleanup: ToolHandler = async (args, context) => {\n\tconst {\n\t\ttarget = \"all\",\n\t\tdryRun = true,\n\t\tmaxAge,\n\t\tkeepCount,\n\t} = args as {\n\t\ttarget?: \"snapshots\" | \"learnings\" | \"sessions\" | \"blobs\" | \"all\";\n\t\tdryRun?: boolean;\n\t\tmaxAge?: number;\n\t\tkeepCount?: number;\n\t};\n\n\tconst storage = createStorage(context.workspaceRoot);\n\tconst learningsPath = join(context.workspaceRoot, \".snapback\", \"learnings\", \"learnings.jsonl\");\n\tconst sessionArchiveDir = join(context.workspaceRoot, \".snapback\", \"session\", \"archive\");\n\n\tconst results: CleanupResult = {\n\t\tsnapshots: { found: 0, stale: 0, deleted: 0 },\n\t\tlearnings: { found: 0, stale: 0, deleted: 0 },\n\t\tsessions: { found: 0, stale: 0, deleted: 0 },\n\t\tblobs: { found: 0, stale: 0, deleted: 0, orphaned: 0 },\n\t\ttotalBytesReclaimed: 0,\n\t};\n\n\t// Clean snapshots\n\tif (target === \"snapshots\" || target === \"all\") {\n\t\tconst snapshotResult = storage.pruneSnapshots(maxAge || 30, keepCount || 10, dryRun);\n\t\tresults.snapshots = {\n\t\t\tfound: snapshotResult.totalSnapshots,\n\t\t\tstale: snapshotResult.staleSnapshots,\n\t\t\tdeleted: snapshotResult.deletedSnapshots,\n\t\t};\n\t}\n\n\t// Clean learnings\n\tif (target === \"learnings\" || target === \"all\") {\n\t\tconst archVersion = getArchitectureVersion(context.workspaceRoot);\n\t\tresults.learnings = cleanupStaleLearnings(learningsPath, {\n\t\t\tmaxAgeDays: maxAge || 90,\n\t\t\tarchVersion,\n\t\t\tdryRun,\n\t\t});\n\t}\n\n\t// Clean sessions\n\tif (target === \"sessions\" || target === \"all\") {\n\t\tresults.sessions = cleanupArchivedSessions(sessionArchiveDir, {\n\t\t\tmaxAgeDays: maxAge || 30,\n\t\t\tdryRun,\n\t\t});\n\t}\n\n\t// Clean blobs (must run after snapshots to know what's orphaned)\n\tif (target === \"blobs\" || target === \"all\") {\n\t\tconst blobResult = storage.garbageCollectBlobs(dryRun);\n\t\tresults.blobs = {\n\t\t\tfound: blobResult.totalBlobs,\n\t\t\tstale: blobResult.orphanedBlobs,\n\t\t\tdeleted: blobResult.deletedBlobs,\n\t\t\torphaned: blobResult.orphanedBlobs,\n\t\t\tbytesReclaimed: blobResult.bytesReclaimed,\n\t\t};\n\t\tresults.totalBytesReclaimed += blobResult.bytesReclaimed;\n\t}\n\n\tconst totalStale =\n\t\tresults.snapshots.stale + results.learnings.stale + results.sessions.stale + results.blobs.orphaned;\n\tconst totalDeleted =\n\t\tresults.snapshots.deleted + results.learnings.deleted + results.sessions.deleted + results.blobs.deleted;\n\n\treturn jsonResult(\n\t\t{\n\t\t\tstatus: \"success\",\n\t\t\tdryRun,\n\t\t\ttarget,\n\t\t\tresults,\n\t\t\tsummary: {\n\t\t\t\ttotalStale,\n\t\t\t\ttotalDeleted,\n\t\t\t\tbytesReclaimed: results.totalBytesReclaimed,\n\t\t\t\tbytesReclaimedFormatted: formatBytes(results.totalBytesReclaimed),\n\t\t\t},\n\t\t\tmessage: dryRun\n\t\t\t\t? `Would remove ${totalStale} stale item(s) and reclaim ${formatBytes(results.totalBytesReclaimed)}`\n\t\t\t\t: `Removed ${totalDeleted} item(s) and reclaimed ${formatBytes(results.totalBytesReclaimed)}`,\n\t\t\t_hint: dryRun\n\t\t\t\t? \"This was a dry run. Call with dryRun: false to execute cleanup.\"\n\t\t\t\t: \"Cleanup complete. Run prepare_workspace to verify workspace health.\",\n\t\t\tnext_actions: dryRun\n\t\t\t\t? totalStale > 0\n\t\t\t\t\t? [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttool: \"cleanup\",\n\t\t\t\t\t\t\t\tpriority: 1,\n\t\t\t\t\t\t\t\treason: \"Execute cleanup\",\n\t\t\t\t\t\t\t\targs: { target, dryRun: false },\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t]\n\t\t\t\t\t: []\n\t\t\t\t: [{ tool: \"prepare_workspace\", priority: 2, reason: \"Verify workspace health\" }],\n\t\t},\n\t\t{ context },\n\t);\n};\n\n/**\n * get_pairing_protocol - Get pairing protocol for AI agent system prompts\n */\nexport const handleGetPairingProtocol: ToolHandler = async (_args, context) => {\n\tconst protocol = generatePairingProtocol(context.workspaceRoot);\n\tconst contextSummary = getContextSummary(context.workspaceRoot);\n\n\treturn jsonResult({\n\t\tstatus: \"success\",\n\t\tversion: protocol.version,\n\t\tcurrentTask: protocol.currentTask,\n\t\trecentObservations: protocol.recentObservations,\n\t\triskAreas: protocol.riskAreas,\n\t\tsessionStats: protocol.sessionStats,\n\t\trecommendations: protocol.recommendations,\n\t\tquickReference: protocol.quickReference,\n\t\tprotocolText: protocol.protocolText,\n\t\tcontextSummary,\n\t\tmessage: contextSummary.hasActiveTask\n\t\t\t? `Active task: ${protocol.currentTask?.description}`\n\t\t\t: \"No active task - call begin_task to start\",\n\t});\n};\n\n/**\n * suggest_snapshot - Proactive snapshot suggestion using SnapshotSuggester\n * @see Archaeological Feedback Synthesis - P0: Proactive Snapshot Suggestion\n */\nexport const handleSuggestSnapshot: ToolHandler = async (args, context) => {\n\tconst { files } = args as { files?: string[] };\n\n\ttry {\n\t\t// Get current vitals\n\t\tconst vitals = WorkspaceVitals.for(context.workspaceRoot);\n\t\tconst currentVitals = vitals.current();\n\n\t\t// Use SnapshotSuggester for proactive recommendation\n\t\tconst suggester = new SnapshotSuggester();\n\t\t// Pass null for forecast - SnapshotSuggester handles this gracefully\n\t\tconst suggestion = suggester.suggestSnapshot(currentVitals, null);\n\n\t\t// Enhance with file-specific context if provided\n\t\tlet criticalFilesTouched = suggestion.metrics.criticalFilesTouched;\n\t\tif (files && files.length > 0) {\n\t\t\tconst sensitivePatterns = [\"auth\", \"payment\", \"config\", \"security\", \"database\", \".env\"];\n\t\t\tconst sensitiveTouched = files.filter((f) => sensitivePatterns.some((p) => f.toLowerCase().includes(p)));\n\t\t\tcriticalFilesTouched = Math.max(criticalFilesTouched, sensitiveTouched.length);\n\t\t}\n\n\t\t// Build actionable response\n\t\tconst nextActions =\n\t\t\tsuggestion.recommendation === \"now\"\n\t\t\t\t? [{ tool: \"snapshot_create\", priority: 1, reason: suggestion.reason, args: { files } }]\n\t\t\t\t: suggestion.recommendation === \"soon\"\n\t\t\t\t\t? [{ tool: \"snapshot_create\", priority: 2, reason: suggestion.reason, args: { files } }]\n\t\t\t\t\t: [];\n\n\t\treturn jsonResult({\n\t\t\tstatus: \"success\",\n\t\t\turgency: suggestion.urgency,\n\t\t\trecommendation: suggestion.recommendation,\n\t\t\treason: suggestion.reason,\n\t\t\tmetrics: {\n\t\t\t\tpressureRate: suggestion.metrics.pressureRate,\n\t\t\t\taiActivityBurst: suggestion.metrics.aiActivityBurst,\n\t\t\t\tcriticalFilesTouched,\n\t\t\t\ttrajectoryConfidence: suggestion.metrics.trajectoryConfidence,\n\t\t\t},\n\t\t\tvitals: {\n\t\t\t\tpulse: currentVitals.pulse,\n\t\t\t\ttemperature: currentVitals.temperature,\n\t\t\t\tpressure: currentVitals.pressure,\n\t\t\t\ttrajectory: currentVitals.trajectory,\n\t\t\t},\n\t\t\tmessage:\n\t\t\t\tsuggestion.recommendation === \"now\"\n\t\t\t\t\t? ` Snapshot recommended NOW: ${suggestion.reason}`\n\t\t\t\t\t: suggestion.recommendation === \"soon\"\n\t\t\t\t\t\t? ` Snapshot recommended soon: ${suggestion.reason}`\n\t\t\t\t\t\t: ` Continue working: ${suggestion.reason}`,\n\t\t\tnext_actions: nextActions,\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Snapshot suggestion failed: ${message}`, true);\n\t}\n};\n\n/**\n * compare_snapshots - Compare two snapshots or snapshot to current state\n * @see Archaeological Feedback Synthesis - P1: Snapshot Comparison Tool\n */\nexport const handleCompareSnapshots: ToolHandler = async (args, context) => {\n\tconst {\n\t\tsnapshotId,\n\t\ttargetId,\n\t\tfiles: filterFiles,\n\t} = args as {\n\t\tsnapshotId?: string;\n\t\ttargetId?: string;\n\t\tfiles?: string[];\n\t};\n\n\tif (!snapshotId) {\n\t\treturn errorJsonResult(CommonErrors.missingParam(\"snapshotId\"));\n\t}\n\n\ttry {\n\t\tconst storage = createStorage(context.workspaceRoot);\n\t\tconst diffCalculator = new DiffCalculator();\n\n\t\t// Get source snapshot\n\t\tconst sourceSnapshot = storage.getSnapshot(snapshotId);\n\t\tif (!sourceSnapshot) {\n\t\t\treturn errorJsonResult(CommonErrors.snapshotNotFound(snapshotId));\n\t\t}\n\n\t\t// Restore source snapshot content\n\t\tconst sourceFiles = await storage.restore(snapshotId);\n\t\tconst sourceFileMap: Map<string, string> = new Map(\n\t\t\tsourceFiles.map((f: { path: string; content: string }) => [f.path, f.content]),\n\t\t);\n\n\t\t// Get target content (another snapshot or current filesystem)\n\t\tlet targetFileMap: Map<string, string>;\n\t\tlet targetLabel: string;\n\n\t\tif (targetId) {\n\t\t\t// Compare to another snapshot\n\t\t\tconst targetSnapshot = storage.getSnapshot(targetId);\n\t\t\tif (!targetSnapshot) {\n\t\t\t\treturn errorJsonResult(CommonErrors.snapshotNotFound(targetId));\n\t\t\t}\n\t\t\tconst targetFiles = await storage.restore(targetId);\n\t\t\ttargetFileMap = new Map(targetFiles.map((f: { path: string; content: string }) => [f.path, f.content]));\n\t\t\ttargetLabel = `snapshot ${targetId}`;\n\t\t} else {\n\t\t\t// Compare to current filesystem\n\t\t\ttargetFileMap = new Map();\n\t\t\tfor (const [path] of sourceFileMap) {\n\t\t\t\tconst fullPath = join(context.workspaceRoot, path as string);\n\t\t\t\tif (existsSync(fullPath)) {\n\t\t\t\t\ttargetFileMap.set(path as string, readFileSync(fullPath, \"utf8\"));\n\t\t\t\t}\n\t\t\t}\n\t\t\ttargetLabel = \"current filesystem\";\n\t\t}\n\n\t\t// Determine files to compare\n\t\tconst allPaths = new Set([...sourceFileMap.keys(), ...targetFileMap.keys()]);\n\t\tlet pathsToCompare: string[] = Array.from(allPaths);\n\n\t\tif (filterFiles && filterFiles.length > 0) {\n\t\t\tpathsToCompare = pathsToCompare.filter((p) => filterFiles.includes(p));\n\t\t}\n\n\t\t// Calculate diffs\n\t\tconst diffs = pathsToCompare.map((path) => {\n\t\t\tconst sourceContent = sourceFileMap.get(path) ?? null;\n\t\t\tconst targetContent = targetFileMap.get(path) ?? null;\n\t\t\treturn diffCalculator.calculateFileDiff(\n\t\t\t\tpath,\n\t\t\t\tsourceContent as string | null,\n\t\t\t\ttargetContent as string | null,\n\t\t\t);\n\t\t});\n\n\t\tconst preview = diffCalculator.generateDiffPreview(diffs);\n\n\t\treturn jsonResult({\n\t\t\tstatus: \"success\",\n\t\t\tsourceSnapshot: snapshotId,\n\t\t\ttarget: targetId ?? \"current\",\n\t\t\tstats: {\n\t\t\t\ttotalFiles: preview.totalFiles,\n\t\t\t\tfilesCreated: preview.filesCreated,\n\t\t\t\tfilesModified: preview.filesModified,\n\t\t\t\tfilesDeleted: preview.filesDeleted,\n\t\t\t\tlinesAdded: preview.totalLinesAdded,\n\t\t\t\tlinesRemoved: preview.totalLinesRemoved,\n\t\t\t},\n\t\t\tfiles: diffs.map((d) => ({\n\t\t\t\tpath: d.path,\n\t\t\t\toperation: d.operation,\n\t\t\t\tlinesAdded: d.linesAdded,\n\t\t\t\tlinesRemoved: d.linesRemoved,\n\t\t\t\tpreview: d.preview,\n\t\t\t})),\n\t\t\tmessage: `Compared snapshot ${snapshotId} to ${targetLabel}: ${preview.filesModified} modified, +${preview.totalLinesAdded}/-${preview.totalLinesRemoved} lines`,\n\t\t\tnext_actions:\n\t\t\t\tpreview.filesModified > 0\n\t\t\t\t\t? [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttool: \"snapshot_restore\",\n\t\t\t\t\t\t\t\tpriority: 2,\n\t\t\t\t\t\t\t\treason: \"Restore if changes unwanted\",\n\t\t\t\t\t\t\t\targs: { snapshotId },\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t]\n\t\t\t\t\t: [],\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn result(`Snapshot comparison failed: ${message}`, true);\n\t}\n};\n\n// =============================================================================\n// LOOKUP EXPORTS HANDLER\n// =============================================================================\n\ninterface ExportMatch {\n\t/** Full import path */\n\tpath: string;\n\t/** List of exports from this path */\n\texports: string[];\n\t/** Whether this path has TypeScript types */\n\thasTypes: boolean;\n\t/** Description of the export if available */\n\tdescription?: string;\n}\n\n/**\n * lookup_exports - Resolve valid import paths for a package\n *\n * Helps AI agents find correct import paths by:\n * 1. Looking up package.json exports map\n * 2. Scanning source files for actual exports\n * 3. Filtering based on partial path query\n *\n * @param query - Partial import path (e.g., \"@snapback/core/an\")\n * @returns List of matching export paths with their exports\n */\nexport const handleLookupExports: ToolHandler = async (args, context) => {\n\tconst input = args as { query?: string };\n\tconst query = input.query;\n\n\tif (!query) {\n\t\treturn result(\n\t\t\tJSON.stringify({\n\t\t\t\terror: \"E102_MISSING_PARAM\",\n\t\t\t\tmessage: \"Required parameter 'query' is missing\",\n\t\t\t}),\n\t\t\ttrue,\n\t\t);\n\t}\n\n\tconst workspaceRoot = context.workspaceRoot;\n\tconst matches: ExportMatch[] = [];\n\n\ttry {\n\t\t// Parse the query to extract package name\n\t\tconst { packageName } = parseImportPath(query);\n\n\t\t// Find the package location\n\t\tconst packageDir = findPackageDir(workspaceRoot, packageName);\n\n\t\tif (!packageDir) {\n\t\t\treturn jsonResult({\n\t\t\t\tstatus: \"success\",\n\t\t\t\tquery,\n\t\t\t\tmatches: [],\n\t\t\t\tmessage: `Package not found: ${packageName}`,\n\t\t\t});\n\t\t}\n\n\t\t// Read package.json exports\n\t\tconst packageJsonPath = join(packageDir, \"package.json\");\n\t\tif (!existsSync(packageJsonPath)) {\n\t\t\treturn jsonResult({\n\t\t\t\tstatus: \"success\",\n\t\t\t\tquery,\n\t\t\t\tmatches: [],\n\t\t\t\tmessage: `No package.json found in ${packageDir}`,\n\t\t\t});\n\t\t}\n\n\t\tconst packageJson = JSON.parse(readFileSync(packageJsonPath, \"utf8\"));\n\t\tconst exportsMap = packageJson.exports || { \".\": packageJson.main || \"./index.js\" };\n\n\t\t// Normalize exports to always be an object\n\t\tconst normalizedExports: Record<string, string> =\n\t\t\ttypeof exportsMap === \"string\" ? { \".\": exportsMap } : exportsMap;\n\n\t\t// Filter exports based on subpath query\n\t\tfor (const [exportPath, exportTarget] of Object.entries(normalizedExports)) {\n\t\t\t// Skip conditional exports (objects with \"import\", \"require\" keys)\n\t\t\tif (typeof exportTarget !== \"string\") {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst fullPath = exportPath === \".\" ? packageName : `${packageName}${exportPath.slice(1)}`;\n\n\t\t\t// Check if this export matches the query\n\t\t\tif (fullPath.startsWith(query) || query === packageName) {\n\t\t\t\t// Try to extract actual exports from source file\n\t\t\t\tconst exports = extractExportsFromFile(packageDir, exportTarget);\n\n\t\t\t\tmatches.push({\n\t\t\t\t\tpath: fullPath,\n\t\t\t\t\texports,\n\t\t\t\t\thasTypes: exports.some((e) => e.startsWith(\"type \")),\n\t\t\t\t\tdescription: getExportDescription(exportPath),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Sort matches by relevance (exact match first, then alphabetically)\n\t\tmatches.sort((a, b) => {\n\t\t\tif (a.path === query) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tif (b.path === query) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\treturn a.path.localeCompare(b.path);\n\t\t});\n\n\t\treturn jsonResult({\n\t\t\tstatus: \"success\",\n\t\t\tquery,\n\t\t\tpackageName,\n\t\t\tpackageDir,\n\t\t\tmatches,\n\t\t\tmessage:\n\t\t\t\tmatches.length > 0\n\t\t\t\t\t? `Found ${matches.length} export path(s) matching \"${query}\"`\n\t\t\t\t\t: `No exports found matching \"${query}\"`,\n\t\t});\n\t} catch (error) {\n\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\treturn jsonResult({\n\t\t\tstatus: \"success\",\n\t\t\tquery,\n\t\t\tmatches: [],\n\t\t\tmessage: `Error looking up exports: ${message}`,\n\t\t});\n\t}\n};\n\n/**\n * Parse an import path into package name and subpath\n */\nfunction parseImportPath(path: string): { packageName: string; subpath: string } {\n\t// Handle scoped packages (@org/pkg)\n\tif (path.startsWith(\"@\")) {\n\t\tconst parts = path.split(\"/\");\n\t\tif (parts.length >= 2) {\n\t\t\treturn {\n\t\t\t\tpackageName: `${parts[0]}/${parts[1]}`,\n\t\t\t\tsubpath: parts.slice(2).join(\"/\"),\n\t\t\t};\n\t\t}\n\t\treturn { packageName: path, subpath: \"\" };\n\t}\n\n\t// Handle regular packages\n\tconst parts = path.split(\"/\");\n\treturn {\n\t\tpackageName: parts[0],\n\t\tsubpath: parts.slice(1).join(\"/\"),\n\t};\n}\n\n/**\n * Find the package directory (node_modules or local packages)\n */\nfunction findPackageDir(workspaceRoot: string, packageName: string): string | null {\n\t// Check node_modules first\n\tconst nodeModulesPath = join(workspaceRoot, \"node_modules\", ...packageName.split(\"/\"));\n\tif (existsSync(nodeModulesPath)) {\n\t\treturn nodeModulesPath;\n\t}\n\n\t// Check local packages directory (for monorepos)\n\tconst localPackagesPath = join(workspaceRoot, \"packages\");\n\tif (existsSync(localPackagesPath)) {\n\t\t// For @snapback/core, look in packages/core\n\t\tconst localName = packageName.startsWith(\"@\") ? packageName.split(\"/\")[1] : packageName;\n\t\tconst localPath = join(localPackagesPath, localName);\n\t\tif (existsSync(localPath)) {\n\t\t\treturn localPath;\n\t\t}\n\t}\n\n\treturn null;\n}\n\n/**\n * Extract exports from a source file\n */\nfunction extractExportsFromFile(packageDir: string, exportTarget: string): string[] {\n\tconst exports: string[] = [];\n\n\t// Resolve the target path\n\tlet targetPath = join(packageDir, exportTarget);\n\n\t// Try with different extensions\n\tconst extensions = [\"\", \".ts\", \".tsx\", \".js\", \".jsx\", \".mjs\"];\n\tlet resolvedPath: string | null = null;\n\n\tfor (const ext of extensions) {\n\t\tconst tryPath = targetPath + ext;\n\t\tif (existsSync(tryPath)) {\n\t\t\tresolvedPath = tryPath;\n\t\t\tbreak;\n\t\t}\n\t\t// Also try index file\n\t\tconst indexPath = join(targetPath, `index${ext}`);\n\t\tif (existsSync(indexPath)) {\n\t\t\tresolvedPath = indexPath;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// Also check src directory for source files\n\tif (!resolvedPath) {\n\t\tconst srcTarget = exportTarget.replace(\"./dist/\", \"./src/\").replace(\".js\", \".ts\");\n\t\ttargetPath = join(packageDir, srcTarget);\n\t\tfor (const ext of extensions) {\n\t\t\tconst tryPath = targetPath + ext;\n\t\t\tif (existsSync(tryPath)) {\n\t\t\t\tresolvedPath = tryPath;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst indexPath = join(targetPath, `index${ext}`);\n\t\t\tif (existsSync(indexPath)) {\n\t\t\t\tresolvedPath = indexPath;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!resolvedPath) {\n\t\treturn exports;\n\t}\n\n\ttry {\n\t\tconst content = readFileSync(resolvedPath, \"utf8\");\n\n\t\t// Simple regex-based export extraction\n\t\t// Match: export { name } from\n\t\t// Match: export const name\n\t\t// Match: export function name\n\t\t// Match: export class name\n\t\t// Match: export type name\n\t\t// Match: export interface name\n\n\t\tconst exportPatterns = [\n\t\t\t/export\\s+\\{\\s*([^}]+)\\s*\\}/g, // export { foo, bar }\n\t\t\t/export\\s+(?:const|let|var)\\s+(\\w+)/g, // export const foo\n\t\t\t/export\\s+function\\s+(\\w+)/g, // export function foo\n\t\t\t/export\\s+class\\s+(\\w+)/g, // export class Foo\n\t\t\t/export\\s+type\\s+(\\w+)/g, // export type Foo\n\t\t\t/export\\s+interface\\s+(\\w+)/g, // export interface Foo\n\t\t];\n\n\t\tfor (const pattern of exportPatterns) {\n\t\t\tlet match: RegExpExecArray | null;\n\t\t\twhile ((match = pattern.exec(content)) !== null) {\n\t\t\t\tconst captured = match[1];\n\t\t\t\t// Handle destructured exports like { foo, bar as baz }\n\t\t\t\tconst names = captured.split(\",\").map((n) =>\n\t\t\t\t\tn\n\t\t\t\t\t\t.trim()\n\t\t\t\t\t\t.split(/\\s+as\\s+/)[0]\n\t\t\t\t\t\t.trim(),\n\t\t\t\t);\n\t\t\t\tfor (const name of names) {\n\t\t\t\t\tif (name && !exports.includes(name)) {\n\t\t\t\t\t\t// Check if it's a type export\n\t\t\t\t\t\tif (pattern.source.includes(\"type\") || pattern.source.includes(\"interface\")) {\n\t\t\t\t\t\t\texports.push(`type ${name}`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\texports.push(name);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// Ignore read errors\n\t}\n\n\treturn exports;\n}\n\n/**\n * Get a description for an export path\n */\nfunction getExportDescription(exportPath: string): string {\n\tconst pathDescriptions: Record<string, string> = {\n\t\t\".\": \"Main entry point\",\n\t\t\"./analysis\": \"Code analysis utilities\",\n\t\t\"./signals\": \"Signal/event system\",\n\t\t\"./types\": \"TypeScript type definitions\",\n\t\t\"./utils\": \"Utility functions\",\n\t\t\"./core\": \"Core functionality\",\n\t};\n\n\treturn pathDescriptions[exportPath] || \"\";\n}\n\n/**\n * Map facade names to handlers\n */\nexport const facadeHandlers: Record<string, ToolHandler> = {\n\tanalyze: handleAnalyze,\n\tprepare_workspace: handlePrepareWorkspace,\n\tsnapshot_create: handleSnapshotCreate,\n\tsnapshot_list: handleSnapshotList,\n\tsnapshot_restore: handleSnapshotRestore,\n\tvalidate: handleValidate,\n\tcontext: handleContext,\n\tsession: handleSession,\n\tlearn: handleLearn,\n\tacknowledge_risk: handleAcknowledgeRisk,\n\tget_context: handleGetContext,\n\tcheck_patterns: handleCheckPatterns,\n\treport_violation: handleReportViolation,\n\tget_learnings: handleGetLearnings,\n\tmeta: handleMeta,\n\tcleanup: handleCleanup,\n\t// Pair programmer composite tools\n\tbegin_task: handleBeginTask,\n\tquick_check: handleQuickCheck,\n\twhat_changed: handleWhatChanged,\n\treview_work: handleReviewWork,\n\tcomplete_task: handleCompleteTask,\n\tget_pairing_protocol: handleGetPairingProtocol,\n\t// Archaeological feedback enhancements (P0/P1)\n\tsuggest_snapshot: handleSuggestSnapshot,\n\tcompare_snapshots: handleCompareSnapshots,\n\tlookup_exports: handleLookupExports,\n};\n","/**\n * Unified Check Tool\n *\n * Validation with modes. Replaces:\n * - quick_check\n * - check_patterns\n * - validate\n *\n * @see stress_test_remediation.md\n * @module tools/consolidated/check\n */\n\nimport { spawn } from \"node:child_process\";\nimport { existsSync, readFileSync, statSync } from \"node:fs\";\nimport { basename, join } from \"node:path\";\nimport { createChangeImpactAnalyzer, type PerformanceImpact } from \"@snapback/core\";\nimport { formatWireLabeled, INTERNAL_SEPARATOR, messages, type WireFormatOptions } from \"../../branding/index.js\";\nimport { handleCheckPatterns, handleValidate } from \"../../facades/handlers.js\";\nimport { handleQuickCheck } from \"../../facades/quick-check.js\";\nimport type { SnapBackTool, ToolHandler, ToolResult } from \"../../registry.js\";\nimport { getSessionFileTracker } from \"../../services/session-file-tracker.js\";\nimport { createTieredLearningService } from \"../../services/tiered-learning-service.js\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Check tool parameters\n */\nexport interface CheckParams {\n\t/** Full-word mode: quick, full, patterns, build, impact, circular, docs, learnings, architecture, trace */\n\tmode?:\n\t\t| \"quick\"\n\t\t| \"full\"\n\t\t| \"patterns\"\n\t\t| \"build\"\n\t\t| \"impact\"\n\t\t| \"circular\"\n\t\t| \"docs\"\n\t\t| \"learnings\"\n\t\t| \"architecture\"\n\t\t| \"trace\";\n\t/** @deprecated Legacy mode (use 'mode' instead) */\n\tm?: \"q\" | \"f\" | \"p\" | \"b\" | \"i\" | \"c\" | \"d\" | \"l\" | \"a\" | \"t\";\n\t/** Files to check */\n\tfiles?: string | string[];\n\t/** @deprecated Legacy files param (use 'files' instead) */\n\tf?: string | string[];\n\t/** Code to validate (for patterns/validate mode) */\n\tcode?: string;\n\t/** Run tests */\n\ttests?: boolean;\n\t/** Use compact positional wire format instead of labeled (default: false = labeled) */\n\tcompact?: boolean;\n}\n\n// =============================================================================\n// Handler\n// =============================================================================\n\n/**\n * Mode mapping from legacy single-letter to full-word\n */\nconst MODE_MAP: Record<string, CheckParams[\"mode\"]> = {\n\tq: \"quick\",\n\tf: \"full\",\n\tp: \"patterns\",\n\tb: \"build\",\n\ti: \"impact\",\n\tc: \"circular\",\n\td: \"docs\",\n\tl: \"learnings\",\n\ta: \"architecture\",\n\tt: \"trace\",\n};\n\n/**\n * Normalize parameters for backward compatibility\n */\nfunction normalizeCheckParams(params: CheckParams): {\n\tmode: NonNullable<CheckParams[\"mode\"]>;\n\tfiles: string[];\n\tcompact: boolean;\n} {\n\t// Mode: prefer full-word, fall back to legacy single-letter\n\tlet mode: NonNullable<CheckParams[\"mode\"]> = \"quick\";\n\tif (params.mode) {\n\t\tmode = params.mode;\n\t} else if (params.m) {\n\t\tmode = MODE_MAP[params.m] || \"quick\";\n\t}\n\n\t// Files: prefer 'files', fall back to 'f'\n\tconst rawFiles = params.files ?? params.f;\n\tconst files = rawFiles ? (Array.isArray(rawFiles) ? rawFiles : [rawFiles]) : [];\n\n\treturn {\n\t\tmode,\n\t\tfiles,\n\t\tcompact: params.compact ?? false,\n\t};\n}\n\n/**\n * Handle check tool\n */\nexport const handleCheck: ToolHandler = async (args, context) => {\n\tconst params = args as unknown as CheckParams;\n\tconst { mode, files, compact } = normalizeCheckParams(params);\n\n\t// Track validated files for what_changed (MCP-only mode)\n\tif (files.length > 0 && mode !== \"learnings\") {\n\t\tconst tracker = getSessionFileTracker(context.workspaceRoot);\n\t\ttracker.trackFiles(files, \"validated\");\n\t}\n\n\tconst options: WireFormatOptions = { compact };\n\n\tswitch (mode) {\n\t\tcase \"quick\": {\n\t\t\t// Quick mode - parallel validation\n\t\t\tconst result = await handleQuickCheck(\n\t\t\t\t{\n\t\t\t\t\tfiles,\n\t\t\t\t\trunTests: params.tests || false,\n\t\t\t\t\tskipTypeScript: false,\n\t\t\t\t\tskipTests: !params.tests,\n\t\t\t\t\tskipLint: false,\n\t\t\t\t},\n\t\t\t\tcontext,\n\t\t\t);\n\n\t\t\treturn formatCheckResult(result, \"quick\", options);\n\t\t}\n\n\t\tcase \"full\": {\n\t\t\t// Full/comprehensive mode\n\t\t\tconst result = await handleValidate(\n\t\t\t\t{\n\t\t\t\t\tmode: \"comprehensive\",\n\t\t\t\t\tcode: params.code || \"\",\n\t\t\t\t\tfilePath: files[0] || \"\",\n\t\t\t\t},\n\t\t\t\tcontext,\n\t\t\t);\n\n\t\t\treturn formatCheckResult(result, \"full\", options);\n\t\t}\n\n\t\tcase \"patterns\": {\n\t\t\t// Patterns mode - 7-layer pipeline\n\t\t\tconst result = await handleCheckPatterns(\n\t\t\t\t{\n\t\t\t\t\tcode: params.code || \"\",\n\t\t\t\t\tfilePath: files[0] || \"\",\n\t\t\t\t},\n\t\t\t\tcontext,\n\t\t\t);\n\n\t\t\treturn formatCheckResult(result, \"patterns\", options);\n\t\t}\n\n\t\tcase \"build\": {\n\t\t\t// Build mode - actually run build command\n\t\t\tconst result = await handleBuildCheck(context);\n\t\t\treturn formatCheckResult(result, \"build\", options);\n\t\t}\n\n\t\tcase \"impact\": {\n\t\t\t// Impact mode - analyze bundle size impact of file removals\n\t\t\tconst result = await handleImpactAnalysis(files, context);\n\t\t\treturn formatCheckResult(result, \"impact\", options);\n\t\t}\n\n\t\tcase \"circular\": {\n\t\t\t// Circular dependency mode - uses madge\n\t\t\tconst result = await handleCircularCheck(files, context);\n\t\t\treturn formatCheckResult(result, \"circular\", options);\n\t\t}\n\n\t\tcase \"docs\": {\n\t\t\t// Doc freshness mode - check for stale documentation\n\t\t\tconst result = await handleDocFreshnessCheck(context);\n\t\t\treturn formatCheckResult(result, \"docs\", options);\n\t\t}\n\n\t\tcase \"learnings\": {\n\t\t\t// Learning maintenance mode - regenerate hot tier, show stats\n\t\t\tconst result = await handleLearningsMaintenance(context);\n\t\t\treturn formatCheckResult(result, \"learnings\", options);\n\t\t}\n\n\t\tcase \"architecture\": {\n\t\t\t// Architecture mode - validate import rules and layer dependencies\n\t\t\tconst result = await handleArchitectureCheck(context);\n\t\t\treturn formatCheckResult(result, \"architecture\", options);\n\t\t}\n\n\t\tcase \"trace\": {\n\t\t\t// Trace mode - deep dependency analysis with confidence scoring\n\t\t\tconst result = await handleTraceAnalysis(files, context);\n\t\t\treturn formatTraceResult(result, options);\n\t\t}\n\n\t\tdefault:\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: `!|Invalid mode \"${mode}\". Use: quick, full, patterns, build, impact, circular, docs, learnings, architecture`,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t}\n};\n\n/**\n * Handle build verification mode\n */\nasync function handleBuildCheck(context: { workspaceRoot: string }): Promise<ToolResult> {\n\treturn new Promise((resolve) => {\n\t\tconst proc = spawn(\"pnpm\", [\"build\"], {\n\t\t\tcwd: context.workspaceRoot,\n\t\t\tshell: true,\n\t\t\tstdio: [\"pipe\", \"pipe\", \"pipe\"],\n\t\t});\n\n\t\tlet stderr = \"\";\n\n\t\tproc.stderr?.on(\"data\", (data) => {\n\t\t\tstderr += data.toString();\n\t\t});\n\n\t\tproc.on(\"close\", (code) => {\n\t\t\tconst passed = code === 0;\n\t\t\tconst errors = passed ? [] : [\"Build failed\"];\n\t\t\tconst warnings: string[] = [];\n\n\t\t\t// Parse stderr for error messages\n\t\t\tif (!passed && stderr) {\n\t\t\t\tconst lines = stderr.split(\"\\n\").filter((l) => l.includes(\"error\") || l.includes(\"Error\"));\n\t\t\t\terrors.push(...lines.slice(0, 3));\n\t\t\t}\n\n\t\t\tresolve({\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\t\tpassed,\n\t\t\t\t\t\t\terrors,\n\t\t\t\t\t\t\twarnings,\n\t\t\t\t\t\t\tmessage: passed ? \"Build succeeded\" : \"Build failed\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: !passed,\n\t\t\t});\n\t\t});\n\n\t\tproc.on(\"error\", (err) => {\n\t\t\tresolve({\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\t\terrors: [err.message],\n\t\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\t\tmessage: \"Build command failed to execute\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t});\n\t\t});\n\t});\n}\n\n/**\n * Handle impact analysis mode\n * Uses ChangeImpactAnalyzer for comprehensive impact prediction\n */\nasync function handleImpactAnalysis(files: string[], context: { workspaceRoot: string }): Promise<ToolResult> {\n\tif (files.length === 0) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [\"No files specified for impact analysis\"],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n\n\ttry {\n\t\t// Create analyzer and read file contents\n\t\tconst analyzer = createChangeImpactAnalyzer(context.workspaceRoot);\n\t\tconst contents = new Map<string, string>();\n\n\t\t// Gather file contents and size info\n\t\tlet totalBytes = 0;\n\t\tconst analyzedFiles: Array<{ file: string; sizeKB: number }> = [];\n\n\t\tfor (const file of files) {\n\t\t\tconst fullPath = join(context.workspaceRoot, file);\n\t\t\tif (existsSync(fullPath)) {\n\t\t\t\tconst stats = statSync(fullPath);\n\t\t\t\tconst sizeKB = Math.round((stats.size / 1024) * 100) / 100;\n\t\t\t\ttotalBytes += stats.size;\n\n\t\t\t\ttry {\n\t\t\t\t\tconst content = readFileSync(fullPath, \"utf-8\");\n\t\t\t\t\tcontents.set(fullPath, content);\n\t\t\t\t\tanalyzedFiles.push({ file: basename(file), sizeKB });\n\t\t\t\t} catch {\n\t\t\t\t\t// Skip unreadable files\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Run full impact analysis\n\t\tconst absolutePaths = files.map((f) => join(context.workspaceRoot, f)).filter((f) => contents.has(f));\n\t\tconst impact = await analyzer.getFullImpact(absolutePaths, contents);\n\n\t\tconst totalKB = Math.round((totalBytes / 1024) * 100) / 100;\n\n\t\t// Determine severity based on impact score\n\t\tconst passed = impact.impactScore < 0.5;\n\t\tconst warnings: string[] = [];\n\t\tconst errors: string[] = [];\n\n\t\tif (impact.breakingChanges.length > 0) {\n\t\t\terrors.push(`${impact.breakingChanges.length} breaking change(s) detected`);\n\t\t}\n\t\tif (impact.affectedTests.length > 10) {\n\t\t\twarnings.push(`${impact.affectedTests.length} tests potentially affected`);\n\t\t}\n\t\tif (impact.performanceImpacts.some((p: PerformanceImpact) => p.risk === \"high\")) {\n\t\t\twarnings.push(\"High-risk performance changes detected\");\n\t\t}\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed,\n\t\t\t\t\t\tanalysis: {\n\t\t\t\t\t\t\tfilesAnalyzed: impact.filesAnalyzed,\n\t\t\t\t\t\t\ttotalKB,\n\t\t\t\t\t\t\timpactScore: Math.round(impact.impactScore * 100) / 100,\n\t\t\t\t\t\t\taffectedTests: impact.affectedTests.length,\n\t\t\t\t\t\t\tbreakingChanges: impact.breakingChanges.length,\n\t\t\t\t\t\t\tperformanceImpacts: impact.performanceImpacts.filter(\n\t\t\t\t\t\t\t\t(p: PerformanceImpact) => p.risk !== \"low\",\n\t\t\t\t\t\t\t).length,\n\t\t\t\t\t\t\tdependentFiles: impact.dependentFiles.length,\n\t\t\t\t\t\t\trecommendations: impact.recommendations.slice(0, 3),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tmessage: `Impact: ${Math.round(impact.impactScore * 100)}% risk | ${impact.affectedTests.length} tests | ${impact.breakingChanges.length} breaking`,\n\t\t\t\t\t\twarnings,\n\t\t\t\t\t\terrors,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: !passed,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [error instanceof Error ? error.message : String(error)],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: \"Impact analysis failed\",\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n}\n\n/**\n * Handle circular dependency check mode\n * Uses madge (already installed) to detect circular imports\n */\nasync function handleCircularCheck(targetDirs: string[], context: { workspaceRoot: string }): Promise<ToolResult> {\n\ttry {\n\t\t// Dynamic import madge directly to avoid cross-package import issues\n\t\tconst madgeModule = await import(\"madge\");\n\t\tconst madge = madgeModule.default || madgeModule;\n\n\t\t// If specific directories provided, check those; otherwise check all packages\n\t\tconst dirsToCheck =\n\t\t\ttargetDirs.length > 0\n\t\t\t\t? targetDirs.map((d) => join(context.workspaceRoot, d))\n\t\t\t\t: [\n\t\t\t\t\t\tjoin(context.workspaceRoot, \"packages/core/src\"),\n\t\t\t\t\t\tjoin(context.workspaceRoot, \"packages/intelligence/src\"),\n\t\t\t\t\t\tjoin(context.workspaceRoot, \"packages/mcp/src\"),\n\t\t\t\t\t\tjoin(context.workspaceRoot, \"apps/web/src\"),\n\t\t\t\t\t\tjoin(context.workspaceRoot, \"apps/vscode/src\"),\n\t\t\t\t\t];\n\n\t\t// Run madge on each directory and collect results\n\t\tconst allCycles: Array<{ package: string; cycle: string[] }> = [];\n\t\tconst affectedPackages: string[] = [];\n\n\t\tfor (const dir of dirsToCheck) {\n\t\t\tif (!existsSync(dir)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst result = await madge(dir, {\n\t\t\t\t\tfileExtensions: [\"ts\", \"tsx\", \"js\", \"jsx\"],\n\t\t\t\t\texcludeRegExp: [/node_modules/, /dist/, /\\.next/, /\\.test\\./, /\\.spec\\./, /__tests__/, /__mocks__/],\n\t\t\t\t\tdetectiveOptions: { ts: { skipTypeImports: true } },\n\t\t\t\t});\n\n\t\t\t\tconst cycles = result.circular() as string[][];\n\t\t\t\tif (cycles.length > 0) {\n\t\t\t\t\taffectedPackages.push(basename(dir));\n\t\t\t\t\tfor (const cycle of cycles) {\n\t\t\t\t\t\tallCycles.push({ package: basename(dir), cycle });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Skip directories that fail to parse\n\t\t\t}\n\t\t}\n\n\t\tconst passed = allCycles.length === 0;\n\t\tconst errors = allCycles.slice(0, 5).map((c: { package: string; cycle: string[] }) => ({\n\t\t\tfile: c.package,\n\t\t\tmessage: c.cycle.join(\" -> \"),\n\t\t}));\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed,\n\t\t\t\t\t\ttotalCycles: allCycles.length,\n\t\t\t\t\t\taffectedPackages,\n\t\t\t\t\t\terrors: passed ? [] : errors,\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: passed\n\t\t\t\t\t\t\t? \"No circular dependencies\"\n\t\t\t\t\t\t\t: `${allCycles.length} cycles in ${affectedPackages.length} package(s)`,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: !passed,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [{ message: error instanceof Error ? error.message : String(error) }],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: \"Circular dependency check failed\",\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n}\n\ninterface StaleDocInfo {\n\tpath: string;\n\thoursStale: number;\n\tnewerSourceFiles: string[];\n\tseverity: \"warning\" | \"error\";\n}\n\n/**\n * Handle documentation freshness check mode\n * Detects stale markdown files relative to source changes\n */\nasync function handleDocFreshnessCheck(context: { workspaceRoot: string }): Promise<ToolResult> {\n\ttry {\n\t\tconst { glob } = await import(\"glob\");\n\t\tconst { stat } = await import(\"node:fs/promises\");\n\t\tconst { dirname, relative } = await import(\"node:path\");\n\n\t\tconst staleHours = 72; // 3 days\n\t\tconst now = Date.now();\n\t\tconst staleThreshold = now - staleHours * 60 * 60 * 1000;\n\n\t\t// Find doc and source files\n\t\tconst docFiles = await glob([\"**/*.md\", \"**/CLAUDE.md\", \"**/*-audit.md\", \"**/*ROADMAP*.md\"], {\n\t\t\tcwd: context.workspaceRoot,\n\t\t\tabsolute: true,\n\t\t\tignore: [\"**/node_modules/**\", \"**/dist/**\", \"**/.next/**\"],\n\t\t});\n\n\t\tconst sourceFiles = await glob([\"**/*.ts\", \"**/*.tsx\"], {\n\t\t\tcwd: context.workspaceRoot,\n\t\t\tabsolute: true,\n\t\t\tignore: [\"**/node_modules/**\", \"**/dist/**\", \"**/.next/**\"],\n\t\t});\n\n\t\t// Get mtimes\n\t\tconst getMtime = async (file: string): Promise<number> => {\n\t\t\ttry {\n\t\t\t\tconst stats = await stat(file);\n\t\t\t\treturn stats.mtimeMs;\n\t\t\t} catch {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t};\n\n\t\tconst docMtimes = new Map<string, number>();\n\t\tconst srcMtimes = new Map<string, number>();\n\n\t\tawait Promise.all([\n\t\t\t...docFiles.map(async (f) => docMtimes.set(f, await getMtime(f))),\n\t\t\t...sourceFiles.map(async (f) => srcMtimes.set(f, await getMtime(f))),\n\t\t]);\n\n\t\t// Find stale docs\n\t\tconst staleDocs: StaleDocInfo[] = [];\n\n\t\tfor (const [docPath, docMtime] of docMtimes) {\n\t\t\tconst hoursStale = Math.round((now - docMtime) / (60 * 60 * 1000));\n\t\t\tconst docDir = dirname(docPath);\n\n\t\t\t// Find newer source files in same directory tree\n\t\t\tconst newerSourceFiles: string[] = [];\n\t\t\tfor (const [srcPath, srcMtime] of srcMtimes) {\n\t\t\t\tif (srcPath.startsWith(docDir) && srcMtime > docMtime) {\n\t\t\t\t\tnewerSourceFiles.push(relative(context.workspaceRoot, srcPath));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst isStale = docMtime < staleThreshold || newerSourceFiles.length > 0;\n\n\t\t\tif (isStale) {\n\t\t\t\tstaleDocs.push({\n\t\t\t\t\tpath: relative(context.workspaceRoot, docPath),\n\t\t\t\t\thoursStale,\n\t\t\t\t\tnewerSourceFiles: newerSourceFiles.slice(0, 5),\n\t\t\t\t\tseverity: hoursStale > staleHours * 2 ? \"error\" : \"warning\",\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Sort by staleness\n\t\tstaleDocs.sort((a, b) => b.hoursStale - a.hoursStale);\n\n\t\tconst freshDocs = docMtimes.size - staleDocs.length;\n\t\tconst freshnessValue = docMtimes.size > 0 ? Math.round((freshDocs / docMtimes.size) * 100) : 100;\n\t\tconst passed = staleDocs.length === 0;\n\n\t\tconst errors = staleDocs.slice(0, 5).map((doc: StaleDocInfo) => ({\n\t\t\tfile: doc.path,\n\t\t\tmessage: `${doc.hoursStale}h stale${doc.newerSourceFiles.length > 0 ? ` (${doc.newerSourceFiles.length} newer src)` : \"\"}`,\n\t\t}));\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed,\n\t\t\t\t\t\tfreshness: freshnessValue,\n\t\t\t\t\t\tstaleCount: staleDocs.length,\n\t\t\t\t\t\ttotalDocs: docMtimes.size,\n\t\t\t\t\t\terrors: passed ? [] : errors,\n\t\t\t\t\t\twarnings:\n\t\t\t\t\t\t\tstaleDocs.filter((d: StaleDocInfo) => d.severity === \"warning\").length > 0\n\t\t\t\t\t\t\t\t? [\"Some docs approaching stale\"]\n\t\t\t\t\t\t\t\t: [],\n\t\t\t\t\t\tmessage: passed\n\t\t\t\t\t\t\t? `All ${docMtimes.size} docs fresh`\n\t\t\t\t\t\t\t: `${staleDocs.length}/${docMtimes.size} docs stale (${freshnessValue}% fresh)`,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: !passed,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [{ message: error instanceof Error ? error.message : String(error) }],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: \"Doc freshness check failed\",\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n}\n\n/**\n * Handle learning maintenance mode\n * Regenerates hot tier based on usage patterns and shows statistics\n */\nasync function handleLearningsMaintenance(context: { workspaceRoot: string }): Promise<ToolResult> {\n\ttry {\n\t\tconst service = createTieredLearningService(context.workspaceRoot);\n\n\t\t// Get usage stats before regeneration\n\t\tconst stats = service.getUsageStats();\n\t\tconst totalTracked = Object.keys(stats).length;\n\n\t\t// Regenerate hot tier\n\t\tconst result = await service.regenerateHotTier();\n\n\t\t// Calculate top learnings by usage\n\t\tconst topLearnings = Object.entries(stats)\n\t\t\t.map(([id, data]) => ({ id, ...data }))\n\t\t\t.sort((a, b) => b.appliedCount * 3 + b.accessCount - (a.appliedCount * 3 + a.accessCount))\n\t\t\t.slice(0, 5);\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: true,\n\t\t\t\t\t\tregeneration: {\n\t\t\t\t\t\t\tpreserved: result.preserved,\n\t\t\t\t\t\t\tpromoted: result.promoted,\n\t\t\t\t\t\t\tdemoted: result.demoted,\n\t\t\t\t\t\t\ttotalHot: result.totalHot,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tstats: {\n\t\t\t\t\t\t\ttotalTracked,\n\t\t\t\t\t\t\ttopLearnings: topLearnings.map((l) => ({\n\t\t\t\t\t\t\t\tid: l.id.slice(0, 30),\n\t\t\t\t\t\t\t\taccessed: l.accessCount,\n\t\t\t\t\t\t\t\tapplied: l.appliedCount,\n\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t},\n\t\t\t\t\t\terrors: [],\n\t\t\t\t\t\twarnings:\n\t\t\t\t\t\t\tresult.promoted === 0 && totalTracked > 0 ? [\"No learnings met promotion threshold\"] : [],\n\t\t\t\t\t\tmessage: `Hot tier: ${result.totalHot} learnings (${result.preserved} critical, ${result.promoted} promoted)`,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [{ message: error instanceof Error ? error.message : String(error) }],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: \"Learning maintenance failed\",\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n}\n\n/**\n * Handle architecture validation mode\n * Validates layer dependencies and import rules using SDK arch module\n */\nasync function handleArchitectureCheck(context: { workspaceRoot: string }): Promise<ToolResult> {\n\ttry {\n\t\t// Dynamic import to avoid circular dependencies\n\t\tconst { runArchCheck, SNAPBACK_LAYER_RULES } = await import(\"@snapback/sdk\");\n\n\t\tconst result = await runArchCheck({\n\t\t\tworkspaceRoot: context.workspaceRoot,\n\t\t\tglobalExclude: [\"node_modules\", \"dist\", \".next\", \"__tests__\", \"__mocks__\"],\n\t\t});\n\n\t\tconst errorViolations = result.violations.filter((v) => v.severity === \"error\");\n\t\tconst warningViolations = result.violations.filter((v) => v.severity === \"warning\");\n\n\t\tconst passed = errorViolations.length === 0;\n\n\t\t// Format violations for wire format\n\t\tconst errors = errorViolations.slice(0, 5).map((v) => ({\n\t\t\tfile: v.sourceFile,\n\t\t\tmessage: `[${v.ruleId}] ${v.importPath || v.ruleDescription}`.slice(0, 60),\n\t\t}));\n\n\t\tconst warnings = warningViolations.slice(0, 3).map((v) => ({\n\t\t\tfile: v.sourceFile,\n\t\t\tmessage: `[${v.ruleId}] ${v.importPath || v.ruleDescription}`.slice(0, 60),\n\t\t}));\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed,\n\t\t\t\t\t\trulesChecked: result.rulesChecked,\n\t\t\t\t\t\trulesPassed: result.rulesPassed,\n\t\t\t\t\t\tviolations: result.violations.length,\n\t\t\t\t\t\terrors: passed ? [] : errors,\n\t\t\t\t\t\twarnings,\n\t\t\t\t\t\tdurationMs: result.durationMs,\n\t\t\t\t\t\tmessage: passed\n\t\t\t\t\t\t\t? `Architecture OK: ${result.rulesChecked} rules passed`\n\t\t\t\t\t\t\t: `${errorViolations.length} violations in ${result.rulesChecked} rules`,\n\t\t\t\t\t\tdetails: {\n\t\t\t\t\t\t\tlayerRules: SNAPBACK_LAYER_RULES.length,\n\t\t\t\t\t\t\terrorCount: errorViolations.length,\n\t\t\t\t\t\t\twarningCount: warningViolations.length,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: !passed,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [{ message: error instanceof Error ? error.message : String(error) }],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: \"Architecture check failed\",\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n}\n\n/**\n * Handle trace analysis mode - deep dependency analysis with confidence scoring\n * Uses DependencyGraphService for token-efficient context\n */\nasync function handleTraceAnalysis(files: string[], context: { workspaceRoot: string }): Promise<ToolResult> {\n\tif (files.length === 0) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [\"No files specified for trace analysis\"],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n\n\ttry {\n\t\t// Use existing DependencyGraphService\n\t\tconst { getDependencyGraphService } = await import(\"../../services/dependency-graph-service.js\");\n\t\tconst depService = getDependencyGraphService(context.workspaceRoot);\n\n\t\t// Get full dependency context\n\t\tconst absoluteFiles = files.map((f) => (f.startsWith(\"/\") ? f : join(context.workspaceRoot, f)));\n\t\tconst depContext = await depService.getContextForFiles(absoluteFiles);\n\n\t\t// Build trace analysis\n\t\tconst dataFlow = [];\n\t\tlet totalImports = 0;\n\t\tlet totalImportedBy = 0;\n\n\t\tfor (const file of absoluteFiles) {\n\t\t\tconst ctx = depContext.planned[file];\n\t\t\tif (ctx) {\n\t\t\t\ttotalImports += ctx.imports.length;\n\t\t\t\ttotalImportedBy += ctx.importedBy.length;\n\n\t\t\t\tdataFlow.push({\n\t\t\t\t\tfile: basename(file),\n\t\t\t\t\timports: ctx.imports.length,\n\t\t\t\t\timportedBy: ctx.importedBy.length,\n\t\t\t\t\tdepth: ctx.depth,\n\t\t\t\t\tisOrphan: ctx.isOrphan,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Calculate confidence based on coverage\n\t\tconst filesWithContext = dataFlow.length;\n\t\tconst confidence = files.length > 0 ? Math.round((filesWithContext / files.length) * 100) / 100 : 0;\n\n\t\t// Identify constraints\n\t\tconst constraints = [];\n\t\tfor (const item of dataFlow) {\n\t\t\tif (item.isOrphan) {\n\t\t\t\tconstraints.push(`${item.file}: Orphan file (no importers)`);\n\t\t\t}\n\t\t\tif (item.depth > 5) {\n\t\t\t\tconstraints.push(`${item.file}: Deep dependency (depth ${item.depth})`);\n\t\t\t}\n\t\t}\n\n\t\tconst passed = constraints.length === 0;\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed,\n\t\t\t\t\t\tconfidence,\n\t\t\t\t\t\tfilesAnalyzed: filesWithContext,\n\t\t\t\t\t\tdataFlow,\n\t\t\t\t\t\tconstraints,\n\t\t\t\t\t\tcircular: depContext.circular.map((c) => ({\n\t\t\t\t\t\t\tcycle: c.cycle,\n\t\t\t\t\t\t\tseverity: c.severity,\n\t\t\t\t\t\t})),\n\t\t\t\t\t\tsuggestions: depContext.suggestions.slice(0, 5),\n\t\t\t\t\t\terrors: passed ? [] : constraints,\n\t\t\t\t\t\twarnings: depContext.circular.length > 0 ? [\"Circular dependencies detected\"] : [],\n\t\t\t\t\t\tmessage: `Traced ${filesWithContext} files | Confidence: ${Math.round(confidence * 100)}% | ${totalImports} imports, ${totalImportedBy} importers`,\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: !passed,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\tpassed: false,\n\t\t\t\t\t\terrors: [error instanceof Error ? error.message : String(error)],\n\t\t\t\t\t\twarnings: [],\n\t\t\t\t\t\tmessage: \"Trace analysis failed\",\n\t\t\t\t\t}),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: true,\n\t\t};\n\t}\n}\n\n/**\n * Format trace result with wire format\n */\nfunction formatTraceResult(\n\tresult: { content: Array<{ type: string; text: string }>; isError?: boolean },\n\toptions: WireFormatOptions = {},\n): { content: Array<{ type: \"text\"; text: string }>; isError?: boolean } {\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tconst data = JSON.parse(content);\n\n\t\tconst errors = data.errors?.length || 0;\n\t\tconst passed = errors === 0;\n\n\t\t// Build wire format\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"C\",\n\t\t\t{\n\t\t\t\tmode: \"trace\",\n\t\t\t\tstatus: passed ? \"\" : \"\",\n\t\t\t\tconfidence: `${Math.round((data.confidence || 0) * 100)}%`,\n\t\t\t\tfiles: `${data.filesAnalyzed || 0}F`,\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\n\t\t// Human-readable message with analysis details\n\t\tconst humanMessage = `${messages.validation.passed()}\\n\\nDependency Analysis:\\n${\n\t\t\tdata.dataFlow\n\t\t\t\t?.map(\n\t\t\t\t\t(d: { file: string; imports: number; importedBy: number }) =>\n\t\t\t\t\t\t`  ${d.file}: ${d.imports} imports, ${d.importedBy} importers`,\n\t\t\t\t)\n\t\t\t\t.join(\"\\n\") || \"No data\"\n\t\t}${data.suggestions?.length > 0 ? `\\n\\nSuggested files: ${data.suggestions.join(\", \")}` : \"\"}`;\n\n\t\treturn {\n\t\t\tcontent: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${humanMessage}` }],\n\t\t\tisError: result.isError,\n\t\t};\n\t} catch {\n\t\treturn result as { content: Array<{ type: \"text\"; text: string }>; isError?: boolean };\n\t}\n}\n\n/**\n * Format check result as wire format with branding\n * Supports labeled (default) and compact modes\n */\nfunction formatCheckResult(\n\tresult: { content: Array<{ type: string; text: string }>; isError?: boolean },\n\tmode: string,\n\toptions: WireFormatOptions = {},\n): { content: Array<{ type: \"text\"; text: string }>; isError?: boolean } {\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tconst data = JSON.parse(content);\n\n\t\tconst errors = data.errors?.length || 0;\n\t\tconst warnings = data.warnings?.length || 0;\n\t\tconst passed = errors === 0;\n\n\t\t// Build wire format with labeled fields (default) or compact (positional)\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"C\",\n\t\t\t{\n\t\t\t\tmode,\n\t\t\t\tstatus: passed ? \"\" : \"\",\n\t\t\t\terr: `${errors}E`,\n\t\t\t\twarn: `${warnings}W`,\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\n\t\t// Add issue details if failed\n\t\tlet issueDetails = \"\";\n\t\tif (!passed && data.errors) {\n\t\t\tconst issues = data.errors.slice(0, 3).map((e: { message?: string; file?: string }) => {\n\t\t\t\tconst file = e.file ? basename(e.file) : \"\";\n\t\t\t\tconst msg = (e.message || \"error\").slice(0, 30);\n\t\t\t\treturn file ? `${file}:${msg}` : msg;\n\t\t\t});\n\t\t\tissueDetails = `|issues:${issues.join(\",\")}`;\n\t\t}\n\n\t\t// Add human-readable branded message\n\t\tconst humanMessage = passed ? messages.validation.passed() : messages.validation.issues(errors, warnings);\n\n\t\treturn { content: [{ type: \"text\", text: `${wire}${issueDetails}${INTERNAL_SEPARATOR}${humanMessage}` }] };\n\t} catch {\n\t\treturn result as { content: Array<{ type: \"text\"; text: string }>; isError?: boolean };\n\t}\n}\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const checkTool: SnapBackTool = {\n\tname: \"check\",\n\tdescription: ` SnapBack Check - Your validation partner for confident code delivery.\n\n**When to use:** Call me before commits, after refactoring, or when you sense something might break.\n\n**Modes** (choose what fits your current need):\n\n**quick** (default) - The pre-commit friend\n   Parallel TypeScript + lint validation\n   ~2-5 seconds, catches 90% of issues\n   Use: Before git commit, after file edits\n\n**full** - The comprehensive audit\n   7-layer validation: syntaxtypestestsarchitecturesecuritydepsperformance\n   Confidence score + prioritized findings\n   Use: Before merge, after major refactoring\n\n**patterns** - The learning validator\n   Checks code against workspace-specific patterns\n   Catches violations from past mistakes\n   Use: Validating code snippets, checking new approaches\n\n**build** - The deployment checkpoint\n   Actually runs pnpm build\n   Verifies production-readiness\n   Use: Pre-deployment, after dependency changes\n\n**impact** - The bundle optimizer\n   Shows bundle size delta if files removed\n   ROI calculation for dead code removal\n   Use: Considering file deletion, optimization planning\n\n**circular** - The architecture guardian\n   Detects circular dependencies (via madge)\n   Prevents import spaghetti\n   Use: After restructuring, when imports feel tangled\n\n**docs** - The freshness checker\n   Finds stale documentation\n   Compares code changes vs doc updates\n   Use: Before releases, periodic maintenance\n\n**learnings** - The knowledge keeper\n   Shows learning tier stats + hot tier promotion\n   Maintains pattern database health\n   Use: Periodic cleanup, understanding what patterns are active\n\n**architecture** - The layer enforcer\n   Validates import rules (no platformcore, etc.)\n   Ensures clean architecture boundaries\n   Use: After adding new packages, refactoring layers\n\n**trace** - The deep investigator\n   Full dependency graph with confidence scoring\n   Finds hidden dependencies and coupling\n   Use: Debugging weird behaviors, planning extractions\n\n**Behavioral Flow**\n\n1. **Discover**  Categorize files by language/framework/intent\n2. **Scan**  Apply mode-specific analysis (parallel where possible)\n3. **Evaluate**  Score issues by severity (critical/high/medium/low)\n4. **Recommend**  Generate actionable fixes with examples\n5. **Report**  Structured wire format + human-friendly summary\n\n**Tool Coordination Matrix**\n\n| Mode | External Tools | Intelligence APIs | Output |\n|------|----------------|-------------------|--------|\n| quick | tsc, biome | ValidationPipeline | Problems + wire |\n| full | tsc, biome, vitest | 7-layer pipeline | Detailed report |\n| patterns | - | Pattern matcher | Violation list |\n| build | pnpm build | - | Build log |\n| impact | - | ChangeImpactAnalyzer | Bundle delta |\n| circular | madge | - | Dependency graph |\n| docs | - | Doc analyzer | Staleness report |\n| learnings | - | TieredLearningService | Stats + hot tier |\n| architecture | - | Layer validator | Import violations |\n| trace | - | DependencyTracer | Confidence-scored graph |\n\n**Wire Format** (labeled by default, compact opt-in)\n\nQuick success:\n  |C|mode:quick|status:|err:0E|warn:0W|ts:|lint:|tests:\n\nFull with issues:\n  |C|mode:full|status:|err:3E|warn:1W|issues:auth.ts:missingerrorhandling\n\nImpact analysis:\n  |C|mode:impact|status:|files:2|bundle:-45KB|roi:high\n\n**Examples**\n\nPre-commit quick check:\n  check({ mode: \"quick\", files: [\"src/auth.ts\", \"src/api.ts\"] })\n   Runs in parallel, shows TypeScript + lint errors immediately\n\nComprehensive before merge:\n  check({ mode: \"full\", files: [\"src/\"], tests: true })\n   Full 7-layer validation with test execution, confidence score\n\nValidate a refactor idea:\n  check({ mode: \"patterns\", code: \"export const config = { apiKey: process.env.KEY }\" })\n   Checks against learned patterns (e.g., \"no env vars in exports\")\n\nFind circular deps after restructure:\n  check({ mode: \"circular\", files: [\"packages/core\"] })\n   Shows cycle paths: coreutilstypescore\n\nBundle impact of removing unused code:\n  check({ mode: \"impact\", files: [\"src/unused-util.ts\", \"src/old-helper.ts\"] })\n   Calculates: -45KB bundle size, affects 2 imports\n\nArchitecture enforcement:\n  check({ mode: \"architecture\" })\n   Validates: packages/platform should not import packages/core\n\n**Boundaries**\n\nWill:\n- Run local validation tools (no network required)\n- Analyze code patterns and architectural constraints\n- Generate severity-rated findings with fix suggestions\n- Check circular dependencies and documentation staleness\n- Calculate bundle impact and dependency traces\n- Maintain learning tier health and promotion\n\nWill Not:\n- Auto-fix issues (that's a separate concern)\n- Download or install dependencies\n- Require internet connection\n- Modify files or configuration without consent\n- Execute untrusted code during validation\n- Share findings outside workspace\n\n**Pro Tips for LLMs**\n\n Start with quick before any commit\n Use full after major refactoring or before merges\n Run patterns when validating code snippets or new approaches\n Check circular after package restructuring\n Use impact before deleting files to see bundle savings\n Run architecture periodically to enforce clean boundaries\n Check learnings mode weekly to see pattern promotion\n\n**Fallback:** Human summary after --- contains same info in natural language.`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\tmode: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\n\t\t\t\t\t\"quick\",\n\t\t\t\t\t\"full\",\n\t\t\t\t\t\"patterns\",\n\t\t\t\t\t\"build\",\n\t\t\t\t\t\"impact\",\n\t\t\t\t\t\"circular\",\n\t\t\t\t\t\"docs\",\n\t\t\t\t\t\"learnings\",\n\t\t\t\t\t\"architecture\",\n\t\t\t\t\t\"trace\",\n\t\t\t\t],\n\t\t\t\tdescription:\n\t\t\t\t\t\"Analysis mode: quick (default), full, patterns, build, impact, circular, docs, learnings, architecture, trace\",\n\t\t\t},\n\t\t\tm: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"q\", \"f\", \"p\", \"b\", \"i\", \"c\", \"d\", \"l\", \"a\", \"t\"],\n\t\t\t\tdescription: \"Legacy: use 'mode' instead\",\n\t\t\t},\n\t\t\tfiles: {\n\t\t\t\toneOf: [{ type: \"string\" }, { type: \"array\", items: { type: \"string\" } }],\n\t\t\t\tdescription: \"File(s) to check\",\n\t\t\t},\n\t\t\tf: {\n\t\t\t\toneOf: [{ type: \"string\" }, { type: \"array\", items: { type: \"string\" } }],\n\t\t\t\tdescription: \"Legacy: use 'files' instead\",\n\t\t\t},\n\t\t\tcode: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Code string to validate (for patterns mode)\",\n\t\t\t},\n\t\t\ttests: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdescription: \"Also run tests (quick mode only)\",\n\t\t\t},\n\t\t\tcompact: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefault: false,\n\t\t\t\tdescription: \"Use compact positional wire format instead of labeled (default: labeled)\",\n\t\t\t},\n\t\t},\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack Check\",\n\t\treadOnlyHint: true,\n\t\tidempotentHint: true,\n\t},\n\ttier: \"free\",\n};\n","/**\n * Unified Snap Tool\n *\n * Universal entry point that replaces:\n * - begin_task (mode: \"s\" = start)\n * - get_context (mode: \"x\" = context)\n * - quick_check (mode: \"c\" = check)\n * - prepare_workspace (mode: \"s\" with prepare behavior)\n * - get_learnings (included in start/context)\n *\n * Token-efficient design:\n * - Single tool reduces discovery overhead\n * - Compact wire format (~100 tokens vs ~1300)\n * - Mode-based dispatch minimizes parameters\n *\n * @see stress_test_remediation.md Section \"Tool 1: snap\"\n * @module tools/consolidated/snap\n */\n\nimport { basename } from \"node:path\";\nimport { compress, INTERNAL_SEPARATOR, messages } from \"../../branding/index.js\";\nimport { handleBeginTask } from \"../../facades/begin-task.js\";\nimport { handleQuickCheck } from \"../../facades/quick-check.js\";\nimport type { SnapBackTool, ToolContext, ToolHandler, ToolResult } from \"../../registry.js\";\nimport { getSessionFileTracker } from \"../../services/session-file-tracker.js\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Snap tool parameters\n *\n * Supports both full-word modes (recommended) and legacy single-letter modes\n */\nexport interface SnapParams {\n\t/** Mode: start|check|context (full-word) or s|c|x (legacy) */\n\tmode?: \"start\" | \"check\" | \"context\";\n\t/** @deprecated Use 'mode' instead. Legacy mode: s=start, c=check, x=context */\n\tm?: \"s\" | \"c\" | \"x\";\n\t/** Task description (mode: start) */\n\ttask?: string;\n\t/** @deprecated Use 'task' instead */\n\tt?: string;\n\t/** Files to work on (mode: start, check) */\n\tfiles?: string[];\n\t/** @deprecated Use 'files' instead */\n\tf?: string[];\n\t/** Keywords for learning retrieval (mode: start, context) */\n\tkeywords?: string[];\n\t/** @deprecated Use 'keywords' instead */\n\tk?: string[];\n\t/** Enable thorough 7-layer validation (mode: check) */\n\tthorough?: boolean;\n\t/** Intent: implement, debug, refactor, review, explore */\n\tintent?: \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\t/** @deprecated Use 'intent' instead */\n\ti?: \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\t/** Use compact positional wire format instead of labeled (default: false) */\n\tcompact?: boolean;\n\t/** Goal for task completion validation */\n\tgoal?: {\n\t\tmetric: \"bundle\" | \"performance\" | \"coverage\";\n\t\ttarget: number;\n\t\tunit: string;\n\t};\n}\n\n/**\n * Auto-detect intent from task description and files\n * Inspired by SuperClaude's trigger conditions for automatic context loading\n */\nfunction detectIntent(task: string, files: string[]): SnapParams[\"intent\"] {\n\tconst taskLower = task.toLowerCase();\n\n\t// Debug triggers\n\tif (/\\b(fix|bug|debug|error|crash|leak|broken|issue)\\b/.test(taskLower)) {\n\t\treturn \"debug\";\n\t}\n\n\t// Refactor triggers\n\tif (/\\b(refactor|restructure|reorganize|clean|simplify|optimize)\\b/.test(taskLower)) {\n\t\treturn \"refactor\";\n\t}\n\n\t// Review triggers (test files or explicit review mentions)\n\tif (files.some((f) => /test|spec/.test(f)) || /\\b(review|audit|check|validate)\\b/.test(taskLower)) {\n\t\treturn \"review\";\n\t}\n\n\t// Explore triggers\n\tif (/\\b(explore|investigate|research|understand|analyze)\\b/.test(taskLower)) {\n\t\treturn \"explore\";\n\t}\n\n\t// Default to implement\n\treturn \"implement\";\n}\n\n/**\n * Normalize params to use full-word versions (backward compatible)\n */\nfunction normalizeParams(params: SnapParams): {\n\tmode: \"start\" | \"check\" | \"context\";\n\ttask: string;\n\tfiles: string[];\n\tkeywords: string[];\n\tintent: \"implement\" | \"debug\" | \"refactor\" | \"review\" | \"explore\";\n\tthorough: boolean;\n\tcompact: boolean;\n\tgoal?: { metric: \"bundle\" | \"performance\" | \"coverage\"; target: number; unit: string };\n} {\n\t// Map legacy single-letter modes to full words\n\tconst modeMap: Record<string, \"start\" | \"check\" | \"context\"> = {\n\t\ts: \"start\",\n\t\tc: \"check\",\n\t\tx: \"context\",\n\t\tstart: \"start\",\n\t\tcheck: \"check\",\n\t\tcontext: \"context\",\n\t};\n\n\tconst rawMode = params.mode || params.m || \"start\";\n\tconst mode = modeMap[rawMode] || \"start\";\n\n\t// Auto-detect intent if not explicitly provided\n\tconst explicitIntent = params.intent || params.i;\n\tconst intent = (explicitIntent || detectIntent(params.task || params.t || \"\", params.files || params.f || [])) as\n\t\t| \"implement\"\n\t\t| \"debug\"\n\t\t| \"refactor\"\n\t\t| \"review\"\n\t\t| \"explore\";\n\n\treturn {\n\t\tmode,\n\t\ttask: params.task || params.t || \"development task\",\n\t\tfiles: params.files || params.f || [],\n\t\tkeywords: params.keywords || params.k || [],\n\t\tintent,\n\t\tthorough: params.thorough || false,\n\t\tcompact: params.compact || false,\n\t\tgoal: params.goal,\n\t};\n}\n\n/**\n * Compact response format for token efficiency\n */\ninterface CompactResponse {\n\t/** Response type: S=Start, C=Check, X=Context */\n\ttype: \"S\" | \"C\" | \"X\";\n\t/** Task ID (for start) */\n\tid?: string;\n\t/** Snapshot ID (for restore/diff) */\n\tsnapshotId?: string;\n\t/** Risk level: L/M/H */\n\trisk?: \"L\" | \"M\" | \"H\";\n\t/** Protection score 0-100 */\n\tprotection?: number;\n\t/** Dirty file count */\n\tdirty?: number;\n\t/** Top learnings (truncated) */\n\tlearnings?: string[];\n\t/** Hotspots with violations */\n\thotspots?: string[];\n\t/** Snapshot status: created/reused/skipped */\n\tsnapshot?: \"created\" | \"reused\" | \"skipped\";\n\t/** Check result: OK/ERR */\n\tstatus?: \"OK\" | \"ERR\";\n\t/** Error count */\n\terrors?: number;\n\t/** Warning count */\n\twarnings?: number;\n\t/** Issues (for check mode) */\n\tissues?: string[];\n\t/** Checked indicators: typescript|lint|tests */\n\tchecked?: {\n\t\ttypescript: boolean;\n\t\tlint: boolean;\n\t\ttests: boolean | \"skipped\";\n\t};\n}\n\n// =============================================================================\n// Wire Format Helpers\n// =============================================================================\n\n/**\n * Format compact response with  SnapBack branding\n *\n * Default: Labeled format for LLM comprehension\n *   |S|id:task_1|snap:snap_a|risk:M|prot:85|dirty:2|status:created|learn:jwtvalidation\n *\n * Compact: Positional format for token efficiency (opt-in)\n *   |S|task_1|snap_a|M|85|2|created|jwtvalidation\n */\nfunction formatWireResponse(response: CompactResponse, compact = false): string {\n\tconst prefix = \"\";\n\n\tif (compact) {\n\t\t// Legacy compact format for backward compatibility\n\t\treturn formatWireCompact(response);\n\t}\n\n\t// Labeled format (default for LLM comprehension)\n\tswitch (response.type) {\n\t\tcase \"S\": {\n\t\t\tconst learningsStr =\n\t\t\t\tresponse.learnings\n\t\t\t\t\t?.slice(0, 3)\n\t\t\t\t\t.map((l) => compress(l, 40))\n\t\t\t\t\t.join(\",\") || \"\";\n\t\t\tconst hotspotsStr = response.hotspots?.slice(0, 2).join(\",\") || \"\";\n\t\t\tconst fields = [\n\t\t\t\t`id:${response.id || \"?\"}`,\n\t\t\t\t`snap:${response.snapshotId || \"none\"}`,\n\t\t\t\t`risk:${response.risk || \"L\"}`,\n\t\t\t\t`prot:${response.protection ?? 100}`,\n\t\t\t\t`dirty:${response.dirty ?? 0}`,\n\t\t\t\t`status:${response.snapshot || \"skipped\"}`,\n\t\t\t];\n\t\t\tif (learningsStr) {\n\t\t\t\tfields.push(`learn:${learningsStr}`);\n\t\t\t}\n\t\t\tif (hotspotsStr) {\n\t\t\t\tfields.push(`hotspots:${hotspotsStr}`);\n\t\t\t}\n\t\t\treturn [prefix, \"S\", ...fields].join(\"|\");\n\t\t}\n\n\t\tcase \"C\": {\n\t\t\tconst tsStatus = response.checked?.typescript ? \"\" : \"\";\n\t\t\tconst lintStatus = response.checked?.lint ? \"\" : \"\";\n\t\t\tconst testsStatus =\n\t\t\t\tresponse.checked?.tests === true ? \"\" : response.checked?.tests === \"skipped\" ? \"\" : \"\";\n\t\t\tconst issuesStr =\n\t\t\t\tresponse.issues\n\t\t\t\t\t?.slice(0, 3)\n\t\t\t\t\t.map((i) => compress(i, 40))\n\t\t\t\t\t.join(\",\") || \"\";\n\t\t\tconst fields = [\n\t\t\t\t`status:${response.status === \"OK\" ? \"\" : \"\"}`,\n\t\t\t\t`err:${response.errors ?? 0}E`,\n\t\t\t\t`warn:${response.warnings ?? 0}W`,\n\t\t\t\t`ts:${tsStatus}`,\n\t\t\t\t`lint:${lintStatus}`,\n\t\t\t\t`tests:${testsStatus}`,\n\t\t\t];\n\t\t\tif (issuesStr) {\n\t\t\t\tfields.push(`issues:${issuesStr}`);\n\t\t\t}\n\t\t\treturn [prefix, \"C\", ...fields].join(\"|\");\n\t\t}\n\n\t\tcase \"X\": {\n\t\t\tconst learningsStr =\n\t\t\t\tresponse.learnings\n\t\t\t\t\t?.slice(0, 3)\n\t\t\t\t\t.map((l) => compress(l, 40))\n\t\t\t\t\t.join(\",\") || \"\";\n\t\t\tconst fields = [\n\t\t\t\t`risk:${response.risk || \"L\"}`,\n\t\t\t\t`prot:${response.protection ?? 100}`,\n\t\t\t\t`dirty:${response.dirty ?? 0}`,\n\t\t\t];\n\t\t\tif (learningsStr) {\n\t\t\t\tfields.push(`learn:${learningsStr}`);\n\t\t\t}\n\t\t\treturn [prefix, \"X\", ...fields].join(\"|\");\n\t\t}\n\n\t\tdefault:\n\t\t\treturn `${prefix}|!|code:INVALID_TYPE|reason:Unknownresponsetype`;\n\t}\n}\n\n/**\n * Legacy compact wire format (positional fields)\n */\nfunction formatWireCompact(response: CompactResponse): string {\n\tconst parts: string[] = [\"\", response.type];\n\n\tswitch (response.type) {\n\t\tcase \"S\":\n\t\t\tparts.push(\n\t\t\t\tresponse.id || \"?\",\n\t\t\t\tresponse.snapshotId || \"none\",\n\t\t\t\tresponse.risk || \"L\",\n\t\t\t\tString(response.protection ?? 100),\n\t\t\t\tString(response.dirty ?? 0),\n\t\t\t\tresponse.snapshot || \"skipped\",\n\t\t\t);\n\t\t\tif (response.learnings?.length) {\n\t\t\t\tparts.push(...response.learnings.slice(0, 3).map((l) => compress(l, 40)));\n\t\t\t}\n\t\t\tif (response.hotspots?.length) {\n\t\t\t\tparts.push(...response.hotspots.slice(0, 2));\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase \"C\": {\n\t\t\tconst indicators: string[] = [];\n\t\t\tif (response.checked) {\n\t\t\t\tif (response.checked.typescript) {\n\t\t\t\t\tindicators.push(\"ts\");\n\t\t\t\t}\n\t\t\t\tif (response.checked.lint) {\n\t\t\t\t\tindicators.push(\"lint\");\n\t\t\t\t}\n\t\t\t\tif (response.checked.tests === true) {\n\t\t\t\t\tindicators.push(\"tests\");\n\t\t\t\t} else if (response.checked.tests === \"skipped\") {\n\t\t\t\t\tindicators.push(\"tests\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tparts.push(\n\t\t\t\tresponse.status || \"OK\",\n\t\t\t\t`${response.errors ?? 0}E`,\n\t\t\t\t`${response.warnings ?? 0}W`,\n\t\t\t\tindicators.join(\"|\") || \"none\",\n\t\t\t);\n\t\t\tif (response.issues?.length) {\n\t\t\t\tparts.push(...response.issues.slice(0, 3).map((i) => compress(i, 40)));\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase \"X\":\n\t\t\tparts.push(response.risk || \"L\", String(response.protection ?? 100), String(response.dirty ?? 0));\n\t\t\tif (response.learnings?.length) {\n\t\t\t\tparts.push(...response.learnings.slice(0, 3).map((l) => compress(l, 40)));\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn parts.join(\"|\");\n}\n\n// =============================================================================\n// Mode Handlers\n// =============================================================================\n\n/**\n * Handle start mode - replaces begin_task\n */\nasync function handleStart(normalized: ReturnType<typeof normalizeParams>, context: ToolContext): Promise<ToolResult> {\n\tconst beginArgs: Record<string, unknown> = {\n\t\ttask: normalized.task,\n\t\tfiles: normalized.files,\n\t\tkeywords: normalized.keywords,\n\t\tintent: normalized.intent,\n\t\tcompact: true, // Always compact for consolidated tool\n\t\tgoal: normalized.goal, // Pass through goal for tracking\n\t};\n\n\t// Initialize session file tracker for MCP-only mode\n\t// This ensures what_changed works even without daemon/extension\n\tconst tracker = getSessionFileTracker(context.workspaceRoot);\n\tconst taskId = `task_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;\n\ttracker.startTask(taskId, normalized.files);\n\n\tconst result = await handleBeginTask(beginArgs, context);\n\n\t// Record Pioneer action for first snapshot (Gap 2 - Pioneer Integration)\n\t// This uses idempotency to prevent duplicate point awards\n\tif (context.user?.id && context.services?.pioneer) {\n\t\ttry {\n\t\t\tconst content = result.content[0]?.text || \"\";\n\t\t\tconst data = content.startsWith(\"{\") ? JSON.parse(content) : null;\n\t\t\tconst snapshotId = data?.snapshot?.id || data?.snapshotId;\n\n\t\t\tif (snapshotId) {\n\t\t\t\t// Use userId + action type for first_snapshot idempotency\n\t\t\t\tconst idempotencyKey = `${context.user.id}_first_snapshot`;\n\t\t\t\tawait context.services.pioneer.recordAction(\n\t\t\t\t\tcontext.user.id,\n\t\t\t\t\t\"first_snapshot\",\n\t\t\t\t\t{ snapshotId, filesAffected: normalized.files?.length || 0 },\n\t\t\t\t\tidempotencyKey,\n\t\t\t\t);\n\t\t\t}\n\t\t} catch {\n\t\t\t// Pioneer recording is non-critical, don't fail the snapshot\n\t\t}\n\t}\n\n\t// Parse result and reformat as wire\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\t// If already compact from begin_task, just return it (for backward compat)\n\t\tif (content.startsWith(\"\") || content.includes(\"|\")) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Otherwise parse JSON and format with labeled wire\n\t\tconst data = JSON.parse(content);\n\t\tconst snapshotStatus = data.snapshot?.created ? \"created\" : data.snapshot?.id ? \"reused\" : \"skipped\";\n\t\tconst wire = formatWireResponse(\n\t\t\t{\n\t\t\t\ttype: \"S\",\n\t\t\t\tid: data.taskId,\n\t\t\t\tsnapshotId: data.snapshot?.id || \"none\",\n\t\t\t\trisk: (data.risk?.[0] || \"l\").toUpperCase() as \"L\" | \"M\" | \"H\",\n\t\t\t\tprotection: data.protection || data.protectionScore || 100,\n\t\t\t\tdirty: data.dirtyFiles || 0,\n\t\t\t\tsnapshot: snapshotStatus,\n\t\t\t\tlearnings: data.learnings?.map((l: { action: string }) => l.action) || [],\n\t\t\t\thotspots:\n\t\t\t\t\tdata.hotspots?.map(\n\t\t\t\t\t\t(h: { file: string; violations: number }) => `${basename(h.file)}:${h.violations}v`,\n\t\t\t\t\t) || [],\n\t\t\t},\n\t\t\tnormalized.compact,\n\t\t);\n\n\t\t// Add human-readable branded message\n\t\tconst humanMessage =\n\t\t\tsnapshotStatus === \"created\"\n\t\t\t\t? messages.snapshot.created(normalized.task)\n\t\t\t\t: snapshotStatus === \"reused\"\n\t\t\t\t\t? messages.snapshot.reused()\n\t\t\t\t\t: messages.session.taskStarted(normalized.task);\n\n\t\treturn { content: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${humanMessage}` }] };\n\t} catch {\n\t\t// If parsing fails, return original\n\t\treturn result;\n\t}\n}\n\n/**\n * Handle check mode - replaces quick_check\n */\nasync function handleCheckMode(\n\tnormalized: ReturnType<typeof normalizeParams>,\n\tcontext: ToolContext,\n): Promise<ToolResult> {\n\tconst checkArgs: Record<string, unknown> = {\n\t\tfiles: normalized.files,\n\t\trunTests: false,\n\t\tskipTypeScript: false,\n\t\tskipTests: true,\n\t\tskipLint: false,\n\t};\n\n\tconst result = await handleQuickCheck(checkArgs, context);\n\n\t// Record Pioneer action for first check (Gap 2 - Pioneer Integration)\n\tif (context.user?.id && context.services?.pioneer) {\n\t\ttry {\n\t\t\tconst idempotencyKey = `${context.user.id}_first_check`;\n\t\t\tawait context.services.pioneer.recordAction(\n\t\t\t\tcontext.user.id,\n\t\t\t\t\"first_check\",\n\t\t\t\t{ filesAffected: normalized.files?.length || 0 },\n\t\t\t\tidempotencyKey,\n\t\t\t);\n\t\t} catch {\n\t\t\t// Pioneer recording is non-critical\n\t\t}\n\t}\n\n\t// Parse and format the result\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tconst data = JSON.parse(content);\n\n\t\tconst errorCount = data.errors?.length || 0;\n\t\tconst warningCount = data.warnings?.length || 0;\n\t\tconst passed = data.passed || errorCount === 0;\n\n\t\tconst wire = formatWireResponse(\n\t\t\t{\n\t\t\t\ttype: \"C\",\n\t\t\t\tstatus: passed ? \"OK\" : \"ERR\",\n\t\t\t\terrors: errorCount,\n\t\t\t\twarnings: warningCount,\n\t\t\t\tchecked: {\n\t\t\t\t\ttypescript: !normalized.thorough || data.typescript !== false,\n\t\t\t\t\tlint: !normalized.thorough || data.lint !== false,\n\t\t\t\t\ttests: normalized.thorough ? data.tests || false : \"skipped\",\n\t\t\t\t},\n\t\t\t\tissues: [\n\t\t\t\t\t...(data.errors || [])\n\t\t\t\t\t\t.slice(0, 2)\n\t\t\t\t\t\t.map((e: { message: string; file: string }) => `${basename(e.file)}:${e.message}`),\n\t\t\t\t\t...(data.warnings || [])\n\t\t\t\t\t\t.slice(0, 1)\n\t\t\t\t\t\t.map((w: { message: string; file: string }) => `${basename(w.file)}:${w.message}`),\n\t\t\t\t],\n\t\t\t},\n\t\t\tnormalized.compact,\n\t\t);\n\n\t\t// Add human-readable branded message\n\t\tconst humanMessage = passed\n\t\t\t? messages.validation.passed()\n\t\t\t: messages.validation.issues(errorCount, warningCount);\n\n\t\treturn { content: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${humanMessage}` }] };\n\t} catch {\n\t\treturn result;\n\t}\n}\n\n/**\n * Handle context mode - get workspace context without starting task\n * Enhanced to include bundle size measurement when available\n */\nasync function handleContext(\n\tnormalized: ReturnType<typeof normalizeParams>,\n\tcontext: ToolContext,\n): Promise<ToolResult> {\n\t// Use begin_task with lightweight context-only mode\n\tconst beginArgs: Record<string, unknown> = {\n\t\ttask: \"get context\",\n\t\tfiles: normalized.files,\n\t\tkeywords: normalized.keywords,\n\t\tskipSnapshot: true,\n\t\tcompact: true,\n\t};\n\n\tconst result = await handleBeginTask(beginArgs, context);\n\n\t// Parse and reformat as context response\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tif (content.startsWith(\"\") || content.includes(\"|\")) {\n\t\t\t// Replace S| with X| for context mode\n\t\t\treturn { content: [{ type: \"text\", text: content.replace(/^[S]/, \"X\") }] };\n\t\t}\n\n\t\tconst data = JSON.parse(content);\n\t\tconst wire = formatWireResponse(\n\t\t\t{\n\t\t\t\ttype: \"X\",\n\t\t\t\trisk: (data.risk?.[0] || \"l\").toUpperCase() as \"L\" | \"M\" | \"H\",\n\t\t\t\tprotection: data.protection || data.protectionScore || 100,\n\t\t\t\tdirty: data.dirtyFiles || 0,\n\t\t\t\tlearnings: data.learnings?.map((l: { action: string }) => l.action) || [],\n\t\t\t},\n\t\t\tnormalized.compact,\n\t\t);\n\n\t\t// Try to measure bundle size if in extension/bundle context\n\t\tconst bundleInfo = await measureBundleSize(context.workspaceRoot);\n\t\tconst bundleMsg = bundleInfo ? `\\nBundle: ${bundleInfo.sizeKB}KB (${bundleInfo.status})` : \"\";\n\n\t\treturn { content: [{ type: \"text\", text: wire + bundleMsg }] };\n\t} catch {\n\t\treturn result;\n\t}\n}\n\n/**\n * Measure bundle size if esbuild metafile or dist directory exists\n */\nasync function measureBundleSize(workspaceRoot: string): Promise<{ sizeKB: number; status: string } | null> {\n\tconst { existsSync, readdirSync, statSync } = await import(\"node:fs\");\n\tconst { join } = await import(\"node:path\");\n\n\t// Check common dist output paths\n\tconst distPaths = [\"dist/extension.js\", \"dist/main.js\", \"dist/index.js\", \"dist/bundle.js\"];\n\n\tfor (const distPath of distPaths) {\n\t\tconst fullPath = join(workspaceRoot, distPath);\n\t\tif (existsSync(fullPath)) {\n\t\t\tconst stats = statSync(fullPath);\n\t\t\tconst sizeKB = Math.round((stats.size / 1024) * 100) / 100;\n\n\t\t\t// Check against common limits\n\t\t\tlet status = \"ok\";\n\t\t\tif (sizeKB > 2000) {\n\t\t\t\tstatus = \"over 2MB\";\n\t\t\t} else if (sizeKB > 1000) {\n\t\t\t\tstatus = \"over 1MB\";\n\t\t\t}\n\n\t\t\treturn { sizeKB, status };\n\t\t}\n\t}\n\n\t// Fallback: sum all files in dist/\n\tconst distDir = join(workspaceRoot, \"dist\");\n\tif (existsSync(distDir)) {\n\t\ttry {\n\t\t\tconst files = readdirSync(distDir, { withFileTypes: true });\n\t\t\tlet totalBytes = 0;\n\t\t\tfor (const file of files) {\n\t\t\t\tif (file.isFile() && file.name.endsWith(\".js\")) {\n\t\t\t\t\tconst filePath = join(distDir, file.name);\n\t\t\t\t\tconst stats = statSync(filePath);\n\t\t\t\t\ttotalBytes += stats.size;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (totalBytes > 0) {\n\t\t\t\tconst sizeKB = Math.round((totalBytes / 1024) * 100) / 100;\n\t\t\t\tlet status = \"ok\";\n\t\t\t\tif (sizeKB > 2000) {\n\t\t\t\t\tstatus = \"over 2MB\";\n\t\t\t\t} else if (sizeKB > 1000) {\n\t\t\t\t\tstatus = \"over 1MB\";\n\t\t\t\t}\n\t\t\t\treturn { sizeKB, status };\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore errors\n\t\t}\n\t}\n\n\treturn null;\n}\n\n// =============================================================================\n// Main Handler\n// =============================================================================\n\n/**\n * Unified snap handler\n *\n * Supports both full-word modes (recommended) and legacy single-letter modes:\n * - mode: \"start\" | \"check\" | \"context\" (full-word, recommended)\n * - m: \"s\" | \"c\" | \"x\" (legacy, backward compatible)\n */\nexport const handleSnap: ToolHandler = async (args, context) => {\n\tconst params = args as unknown as SnapParams;\n\tconst normalized = normalizeParams(params);\n\n\tswitch (normalized.mode) {\n\t\tcase \"start\":\n\t\t\treturn handleStart(normalized, context);\n\t\tcase \"check\":\n\t\t\treturn handleCheckMode(normalized, context);\n\t\tcase \"context\":\n\t\t\treturn handleContext(normalized, context);\n\t\tdefault:\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: \"|!|code:INVALID_MODE|reason:Usestart,check,orcontext\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t}\n};\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const snapTool: SnapBackTool = {\n\tname: \"snap\",\n\tdescription: ` SnapBack: Universal entry point for all tasks.\n\n**REQUIRED** before implementation. Provides:\n-  Context + learnings loaded automatically\n-  Risk assessment and protection status\n-  Snapshot creation for safe rollback\n\n**Modes** (full-word recommended, single-letter for backward compatibility):\n- mode:\"start\" (or m:\"s\") - Start task (FIRST call for any new work)\n- mode:\"check\" (or m:\"c\") - Check code (validate before commit)\n- mode:\"context\" (or m:\"x\") - Get context (quick status check)\n\n**Behavioral Flow (mode: start)**\n1. **Assess**  Workspace vitals (pulse, pressure, trajectory)\n2. **Retrieve**  Load hot tier + intent-matched learnings\n3. **Analyze**  Identify risk hotspots and pattern violations\n4. **Guide**  Provide context-aware recommendations\n5. **Prepare**  Create snapshot, establish task baseline\n\nKey behaviors:\n- Intent-based learning selection (debuganti-patterns, refactorarchitecture)\n- Automatic snapshot creation with dirty file detection\n- Violation history analysis for hotspot identification\n- Protection level assessment across modified files\n\n**Wire Response** (labeled by default, compact opt-in):\n- Labeled: |S|id:task_1|snap:snap_a|risk:M|prot:85|dirty:2|status:created|learn:jwtvalidation\n- Compact: |S|task_1|snap_a|M|85|2|created|jwtvalidation\n\n**Field meanings:**\n- id: Task identifier for subsequent calls\n- snap: Snapshot ID for rollback\n- risk: L=Low, M=Medium, H=High\n- prot: Protection coverage 0-100%\n- dirty: Uncommitted file count\n- status: created|reused|skipped\n- learn: Relevant learnings (compressed)\n\n**Examples**\n\nStart implementation:\n  snap({ mode: \"start\", task: \"Add JWT auth\", files: [\"src/auth.ts\"], intent: \"implement\" })\n   Loads architecture-patterns + hot tier, creates snapshot\n\nDebug with anti-patterns:\n  snap({ mode: \"start\", task: \"Fix memory leak\", intent: \"debug\" })\n   Loads anti-patterns + recent violations\n\nQuick context lookup:\n  snap({ mode: \"context\", keywords: [\"auth\", \"jwt\"] })\n   Returns learnings without snapshot\n\n**Boundaries**\n\nWill:\n- Create local snapshots of workspace state\n- Load relevant learnings from .snapback/ directory\n- Provide risk assessment based on file protection levels\n- Track file modifications during task lifetime\n\nWill Not:\n- Execute arbitrary shell commands\n- Modify files without explicit tool calls\n- Access network resources (fully local)\n- Share data outside workspace directory\n\n**Fallback:** Human summary after --- contains same info in natural language.`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\tmode: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"start\", \"check\", \"context\"],\n\t\t\t\tdescription: \"Mode (full-word, recommended): start=begin task, check=validate code, context=get status\",\n\t\t\t},\n\t\t\tm: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"s\", \"c\", \"x\"],\n\t\t\t\tdescription: \"Legacy mode: s=start, c=check, x=context (use 'mode' instead)\",\n\t\t\t},\n\t\t\ttask: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Task title or goal (mode: start). Example: 'fix auth bug'\",\n\t\t\t},\n\t\t\tt: { type: \"string\", description: \"Legacy: use 'task' instead\" },\n\t\t\tfiles: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Primary files involved (mode: start, check)\",\n\t\t\t},\n\t\t\tf: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Legacy: use 'files' instead\",\n\t\t\t},\n\t\t\tkeywords: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Keywords for pattern matching (mode: start, context)\",\n\t\t\t},\n\t\t\tk: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Legacy: use 'keywords' instead\",\n\t\t\t},\n\t\t\tthorough: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdescription: \"Enable thorough 7-layer validation (mode: check)\",\n\t\t\t},\n\t\t\tintent: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"implement\", \"debug\", \"refactor\", \"review\", \"explore\"],\n\t\t\t\tdescription: \"Task intent for context loading optimization\",\n\t\t\t},\n\t\t\ti: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"implement\", \"debug\", \"refactor\", \"review\", \"explore\"],\n\t\t\t\tdescription: \"Legacy: use 'intent' instead\",\n\t\t\t},\n\t\t\tcompact: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefault: false,\n\t\t\t\tdescription: \"Use compact positional wire format instead of labeled (default: false = labeled)\",\n\t\t\t},\n\t\t\tgoal: {\n\t\t\t\ttype: \"object\",\n\t\t\t\tproperties: {\n\t\t\t\t\tmetric: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\tenum: [\"bundle\", \"performance\", \"coverage\"],\n\t\t\t\t\t\tdescription: \"Metric to track\",\n\t\t\t\t\t},\n\t\t\t\t\ttarget: {\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tdescription: \"Target value\",\n\t\t\t\t\t},\n\t\t\t\t\tunit: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\tdescription: \"Unit (KB, ms, %)\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tdescription: \"Goal for task completion validation (mode: start)\",\n\t\t\t},\n\t\t},\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack\",\n\t\treadOnlyHint: false,\n\t\tidempotentHint: false,\n\t},\n\ttier: \"free\",\n};\n","/**\n * Snap End Tool\n *\n * Completes a task with learning capture. Replaces:\n * - complete_task\n * - review_work\n * - what_changed\n * - learn (when capturing at end)\n *\n * ENHANCED: Now includes:\n * -  SnapBack branding for visual distinctiveness\n * - User-facing token efficiency stats\n * - Mistakes prevented metrics\n * - Internal improvement tracking for agent learning\n *\n * @see stress_test_remediation.md Section \"Tool 2: snap.end\"\n * @module tools/consolidated/snap-end\n */\n\nimport { formatWireLabeled, INTERNAL_SEPARATOR, messages, type WireFormatOptions } from \"../../branding/index.js\";\nimport { handleCompleteTask } from \"../../facades/complete-task.js\";\nimport type { SnapBackTool, ToolHandler } from \"../../registry.js\";\nimport { createTieredLearningService, HOT_TIER_PROMOTION_THRESHOLD } from \"../../services/tiered-learning-service.js\";\nimport { getSessionState } from \"../../session/state.js\";\n\n/** Compress string for wire format */\nconst compressStr = (s: string, max: number): string => {\n\tconst clean = s.replace(/\\s+/g, \"\");\n\treturn clean.length > max ? `${clean.slice(0, max - 1)}` : clean;\n};\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Snap.end parameters\n */\nexport interface SnapEndParams {\n\t/** Success: 1=ok, 0=failed */\n\tok?: 0 | 1;\n\t/** Quick learnings as strings */\n\tlearnings?: string[];\n\t/** @deprecated Legacy learnings param (use 'learnings' instead) */\n\tl?: string[];\n\t/**\n\t * Agent-reported efficiency metrics\n\t * The LLM knows what it did - trust its assessment\n\t */\n\tefficiency?: {\n\t\t/** Agent's estimate of tokens saved, e.g. \"~12K\" or \"15000\" */\n\t\tsaved?: string;\n\t\t/** What mistakes SnapBack helped prevent, e.g. \"2 - wrong layer, missed pattern\" */\n\t\tprevented?: string;\n\t\t/** What loaded context helped most, e.g. \"auth patterns, layer constraints\" */\n\t\thelped?: string;\n\t};\n\t/**\n\t * LLM Self-Assessment Survey (Internal - NOT user-facing questions)\n\t *\n\t * This captures YOUR experience as the LLM using SnapBack this session.\n\t * Uses clear, full-word keys for better LLM comprehension.\n\t */\n\tsurvey?: {\n\t\t/** Patterns applied from loaded context */\n\t\tpatterns_used?: number;\n\t\t/** Pitfalls avoided due to warnings */\n\t\tpitfalls_avoided?: number;\n\t\t/** Helpfulness rating 1-5 */\n\t\thelpfulness?: number;\n\t\t/** Count of unhelpful suggestions */\n\t\tunhelpful_count?: number;\n\t};\n\t/** Outcome: completed, abandoned, blocked */\n\toutcome?: \"completed\" | \"abandoned\" | \"blocked\";\n\t/** Notes about completion */\n\tnotes?: string;\n\t/** Use compact positional wire format instead of labeled (default: false = labeled) */\n\tcompact?: boolean;\n}\n\n/**\n * Session efficiency metrics for user-facing stats\n * Simplified: Trust agent-reported values instead of calculating\n */\ninterface EfficiencyMetrics {\n\t/** Agent-reported tokens saved (e.g. \"~12K\") */\n\tsaved: string;\n\t/** Agent-reported mistakes prevented (e.g. \"2 - wrong layer\") */\n\tprevented: string;\n\t/** What context helped most */\n\thelped: string;\n\t/** New learnings captured this session */\n\tnewLearnings: number;\n}\n\n/**\n * Internal improvement opportunity for agent learning\n */\ninterface ImprovementOpportunity {\n\t/** What could be done better */\n\tsuggestion: string;\n\t/** When this applies */\n\ttrigger: string;\n\t/** Priority: low/medium/high */\n\tpriority: \"low\" | \"medium\" | \"high\";\n}\n\n// =============================================================================\n// Efficiency Metrics (Agent-Reported)\n// =============================================================================\n\n/**\n * Extract efficiency metrics from agent-reported values\n * Trust the LLM - it knows what it did and what helped\n */\nfunction getEfficiencyMetrics(params: SnapEndParams, learningsCount: number): EfficiencyMetrics {\n\tconst eff = params.efficiency || {};\n\treturn {\n\t\tsaved: eff.saved || \"not reported\",\n\t\tprevented: eff.prevented || \"none reported\",\n\t\thelped: eff.helped || \"general context\",\n\t\tnewLearnings: learningsCount,\n\t};\n}\n\n/**\n * Identify improvement opportunities for the agent\n * These are internal learnings to improve future sessions\n */\nfunction identifyImprovements(data: Record<string, unknown>, params: SnapEndParams): ImprovementOpportunity[] {\n\tconst improvements: ImprovementOpportunity[] = [];\n\n\t// Check if agent skipped validation before risky edits\n\tconst filesModified = (data.filesModified as number) || 0;\n\tconst validationRuns = (data.validationRuns as number) || 0;\n\tif (filesModified > 3 && validationRuns === 0) {\n\t\timprovements.push({\n\t\t\tsuggestion: \"Run snap m:c periodically during large edits\",\n\t\t\ttrigger: \"Editing 3+ files without validation\",\n\t\t\tpriority: \"medium\",\n\t\t});\n\t}\n\n\t// Check if task failed - opportunity to learn\n\tif (params.ok === 0 || params.outcome === \"abandoned\" || params.outcome === \"blocked\") {\n\t\timprovements.push({\n\t\t\tsuggestion: \"Capture specific blocker as pitfall learning\",\n\t\t\ttrigger: \"Task did not complete successfully\",\n\t\t\tpriority: \"high\",\n\t\t});\n\t}\n\n\t// Check if no learnings were captured\n\tif (!params.l || params.l.length === 0) {\n\t\timprovements.push({\n\t\t\tsuggestion: \"Capture at least one learning per session\",\n\t\t\ttrigger: \"Session ended without learnings\",\n\t\t\tpriority: \"low\",\n\t\t});\n\t}\n\n\treturn improvements;\n}\n\n/**\n * Format efficiency stats for user display\n * Uses agent-reported values - no magic number calculations\n */\nfunction formatUserStats(metrics: EfficiencyMetrics): string {\n\tconst parts: string[] = [];\n\n\t// Token savings (agent-reported)\n\tif (metrics.saved !== \"not reported\") {\n\t\tparts.push(` ${metrics.saved} tokens saved`);\n\t}\n\n\t// Mistakes prevented (agent-reported)\n\tif (metrics.prevented !== \"none reported\") {\n\t\tparts.push(` ${metrics.prevented}`);\n\t}\n\n\t// What helped\n\tif (metrics.helped !== \"general context\") {\n\t\tparts.push(` Helped: ${metrics.helped}`);\n\t}\n\n\t// New learnings\n\tif (metrics.newLearnings > 0) {\n\t\tparts.push(` ${metrics.newLearnings} new learnings`);\n\t}\n\n\treturn parts.length > 0 ? parts.join(\" | \") : \"Session completed\";\n}\n\n/**\n * Format improvements for agent consumption (internal)\n */\nfunction formatImprovements(improvements: ImprovementOpportunity[]): string {\n\tif (improvements.length === 0) {\n\t\treturn \"\";\n\t}\n\n\tconst lines = improvements.map((i) => `[${i.priority.toUpperCase()}] ${i.suggestion} (when: ${i.trigger})`);\n\treturn `\\n[IMPROVE] ${lines.join(\" | \")}`;\n}\n\n// =============================================================================\n// Handler\n// =============================================================================\n\n/**\n * Handle snap_end\n *\n * Enhanced to provide:\n * 1.  SnapBack branded output for visual distinctiveness\n * 2. User-facing efficiency stats (tokens saved, mistakes prevented)\n * 3. Internal improvement tracking for agent learning loop\n */\nexport const handleSnapEnd: ToolHandler = async (args, context) => {\n\tconst params = args as unknown as SnapEndParams;\n\tconst options: WireFormatOptions = { compact: params.compact ?? false };\n\n\t// Normalize learnings (prefer 'learnings', fall back to legacy 'l')\n\tconst learningStrings = params.learnings ?? params.l ?? [];\n\n\t// Check if task has a goal that needs validation\n\tconst goalCheck = await checkTaskGoal(context.workspaceRoot);\n\tif (goalCheck && !goalCheck.met) {\n\t\t// Goal not met - return warning but don't block completion\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"E\",\n\t\t\t{\n\t\t\t\tstatus: \"GOAL_NOT_MET\",\n\t\t\t\tmetric: goalCheck.metric,\n\t\t\t\tcurrent: `${goalCheck.current}${goalCheck.unit}`,\n\t\t\t\ttarget: `${goalCheck.target}${goalCheck.unit}`,\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: `${wire}\\n\\n Goal not achieved: ${goalCheck.metric} is ${goalCheck.current}${goalCheck.unit}, target was ${goalCheck.target}${goalCheck.unit}. Task marked incomplete.`,\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: false, // Warning, not error\n\t\t};\n\t}\n\n\t// Convert quick learnings to customLearning format if provided\n\tconst customLearnings = learningStrings.map((learning) => ({\n\t\ttype: \"pattern\" as const,\n\t\ttrigger: \"Task completion\",\n\t\taction: learning,\n\t}));\n\n\t// P1-3: Track learnings as applied for auto-promotion\n\t// This enables the 3x  hot tier promotion system\n\tconst learningService = createTieredLearningService(context.workspaceRoot);\n\tlet promotionResult: { promoted: number; totalHot: number } | undefined;\n\tlet surveyAttributionCount = 0;\n\n\t// FEEDBACK LOOP: Use survey data to attribute applied learnings\n\t// Closes the loop: shown learnings (start)  survey feedback (end)  trackApplied()\n\tif (params.survey) {\n\t\tconst sessionState = getSessionState(context.workspaceRoot);\n\t\tconst shownLearnings = sessionState.currentTask?.shownLearnings;\n\n\t\t// Gate on helpfulness - if LLM rated SnapBack unhelpful, don't boost learnings\n\t\tconst helpfulness = params.survey.helpfulness ?? 3;\n\t\tif (shownLearnings && helpfulness >= 3) {\n\t\t\t// Attribute patterns: first N patterns shown = first N applied\n\t\t\tconst patternsUsed = params.survey.patterns_used ?? 0;\n\t\t\tfor (let i = 0; i < Math.min(patternsUsed, shownLearnings.patterns.length); i++) {\n\t\t\t\tlearningService.trackApplied(shownLearnings.patterns[i]);\n\t\t\t\tsurveyAttributionCount++;\n\t\t\t}\n\n\t\t\t// Attribute pitfalls: first N pitfalls shown = first N avoided\n\t\t\tconst pitfallsAvoided = params.survey.pitfalls_avoided ?? 0;\n\t\t\tfor (let i = 0; i < Math.min(pitfallsAvoided, shownLearnings.pitfalls.length); i++) {\n\t\t\t\tlearningService.trackApplied(shownLearnings.pitfalls[i]);\n\t\t\t\tsurveyAttributionCount++;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (customLearnings.length > 0) {\n\t\t// Generate IDs for the learnings we're capturing\n\t\tfor (const learning of customLearnings) {\n\t\t\tconst learningId = `snap-end-${learning.action.slice(0, 30).replace(/\\s+/g, \"-\").toLowerCase()}`;\n\t\t\tlearningService.trackApplied(learningId);\n\t\t}\n\n\t\t// Check if we should trigger auto-regeneration\n\t\t// (when a learning hits the threshold, regenerate hot tier)\n\t\tconst stats = learningService.getUsageStats();\n\t\tconst hasReachedThreshold = Object.values(stats).some(\n\t\t\t(s) => s.appliedCount >= HOT_TIER_PROMOTION_THRESHOLD.minAccessCount,\n\t\t);\n\n\t\tif (hasReachedThreshold) {\n\t\t\ttry {\n\t\t\t\tpromotionResult = await learningService.regenerateHotTier();\n\t\t\t} catch {\n\t\t\t\t// Best effort - don't fail snap_end if promotion fails\n\t\t\t}\n\t\t}\n\t}\n\n\t// Map to complete_task parameters\n\tconst completeArgs: Record<string, unknown> = {\n\t\toutcome: params.outcome || (params.ok === 0 ? \"abandoned\" : \"completed\"),\n\t\tcreateSnapshot: true,\n\t\tnotes: params.notes,\n\t};\n\n\t// Add first custom learning if present\n\tif (customLearnings.length > 0) {\n\t\tcompleteArgs.customLearning = customLearnings[0];\n\t}\n\n\tconst result = await handleCompleteTask(completeArgs, context);\n\n\t// Parse and format as  SnapBack branded wire response\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tconst data = JSON.parse(content) as Record<string, unknown>;\n\n\t\t// Get efficiency metrics from agent-reported values\n\t\tconst metrics = getEfficiencyMetrics(params, customLearnings.length);\n\n\t\t// Identify improvements for agent learning\n\t\tconst improvements = identifyImprovements(data, params);\n\n\t\t// Build wire format with  SnapBack branding (labeled by default)\n\t\tconst success = data.success !== false;\n\t\tconst wireFields: Record<string, string | number | undefined> = {\n\t\t\tstatus: success ? \"OK\" : \"FAIL\",\n\t\t\tlearn: `${data.learningsGenerated || customLearnings.length}L`,\n\t\t\tfiles: `${data.filesModified || 0}F`,\n\t\t\tlines: `+${data.linesAdded || 0}-${data.linesRemoved || 0}`,\n\t\t};\n\n\t\t// Add learnings summary using compressStr\n\t\tif (learningStrings.length > 0) {\n\t\t\twireFields.summary = learningStrings\n\t\t\t\t.slice(0, 2)\n\t\t\t\t.map((l) => compressStr(l, 30))\n\t\t\t\t.join(\",\");\n\t\t}\n\n\t\t// Add survey data with clear keys if provided\n\t\tif (params.survey) {\n\t\t\tconst surveyJson = JSON.stringify({\n\t\t\t\tpatterns_used: params.survey.patterns_used ?? 0,\n\t\t\t\tpitfalls_avoided: params.survey.pitfalls_avoided ?? 0,\n\t\t\t\thelpfulness: params.survey.helpfulness ?? 0,\n\t\t\t\tunhelpful_count: params.survey.unhelpful_count ?? 0,\n\t\t\t});\n\t\t\twireFields.survey = surveyJson;\n\t\t}\n\n\t\tconst wire = formatWireLabeled(\"E\", wireFields, options);\n\n\t\t// Build full response with user stats and internal improvements\n\t\tconst userStats = formatUserStats(metrics);\n\t\tconst improvementNotes = formatImprovements(improvements);\n\n\t\t// Add promotion info if any learnings were promoted\n\t\tconst promotionInfo =\n\t\t\tpromotionResult && promotionResult.promoted > 0\n\t\t\t\t? ` |  ${promotionResult.promoted} learning(s) promoted to hot tier`\n\t\t\t\t: \"\";\n\n\t\t// Add feedback loop attribution info\n\t\tconst feedbackInfo =\n\t\t\tsurveyAttributionCount > 0 ? ` |  ${surveyAttributionCount} learning(s) marked as applied` : \"\";\n\n\t\t// Add human-readable branded message\n\t\tconst humanMessage = success\n\t\t\t? messages.session.complete(1, (data.filesModified as number) || 0)\n\t\t\t: messages.error.generic(params.outcome === \"blocked\" ? \"task blocked\" : \"task incomplete\");\n\n\t\t// Combined output: wire format (agent-only) + separator + human-readable content\n\t\tconst fullResponse = `${wire}${improvementNotes}${INTERNAL_SEPARATOR}${humanMessage}\\n${userStats}${promotionInfo}${feedbackInfo}`;\n\n\t\treturn { content: [{ type: \"text\", text: fullResponse }] };\n\t} catch {\n\t\treturn result;\n\t}\n};\n\n/**\n * Check if task goal was met (if goal was set)\n */\nasync function checkTaskGoal(\n\tworkspaceRoot: string,\n): Promise<{ met: boolean; metric: string; current: number; target: number; unit: string } | null> {\n\tconst { existsSync, readFileSync } = await import(\"node:fs\");\n\tconst { join } = await import(\"node:path\");\n\n\t// Check if task has a goal stored in session state\n\tconst sessionPath = join(workspaceRoot, \".snapback\", \"session\", \"state.json\");\n\tif (!existsSync(sessionPath)) {\n\t\treturn null;\n\t}\n\n\ttry {\n\t\tconst sessionData = JSON.parse(readFileSync(sessionPath, \"utf-8\"));\n\t\tconst goal = sessionData.currentTask?.goal;\n\t\tif (!goal) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst { metric, target, unit } = goal;\n\t\tlet current = 0;\n\n\t\t// Measure current value based on metric\n\t\tif (metric === \"bundle\") {\n\t\t\t// Measure bundle size\n\t\t\tconst distPaths = [\"dist/extension.js\", \"dist/main.js\", \"dist/index.js\", \"dist/bundle.js\"];\n\n\t\t\tfor (const distPath of distPaths) {\n\t\t\t\tconst fullPath = join(workspaceRoot, distPath);\n\t\t\t\tif (existsSync(fullPath)) {\n\t\t\t\t\tconst { statSync } = await import(\"node:fs\");\n\t\t\t\t\tconst stats = statSync(fullPath);\n\t\t\t\t\tcurrent = Math.round(stats.size / 1024); // KB\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// Add other metric types (performance, coverage) as needed\n\n\t\tconst met = current <= target;\n\t\treturn { met, metric, current, target, unit };\n\t} catch {\n\t\treturn null;\n\t}\n}\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const snapEndTool: SnapBackTool = {\n\tname: \"snap_end\",\n\tdescription: ` SnapBack End - Your session completion partner.\n\n**REQUIRED** at task completion. Call me to close the loop - I'll never ask the user questions.\n\n**When to use**: Task done (succeeded, failed, or blocked). Always call - even if abandoned.\n\n**What happens**:\n1. **Captures learnings** you provide (promotes patterns)\n2. **Records efficiency** metrics (your self-assessment)\n3. **Tracks file changes** (what got modified)\n4. **Updates telemetry** (improves SnapBack for everyone)\n5. **Shows summary** (user-friendly stats)\n\n**Efficiency Metrics** (your honest self-assessment):\n- \"saved\": Token estimate (e.g., \"~15K\")\n- \"prevented\": What mistakes you avoided (e.g., \"2 - wrong layer, missing validation\")\n- \"helped\": What context helped most (e.g., \"auth patterns, architecture rules\")\n\n**Survey Field** ( INTERNAL - fill silently):\nThis is YOUR self-assessment as the LLM. Rate:\n- helpfulness: 1-5 (was SnapBack useful?)\n- patterns_used: How many patterns you applied\n- pitfalls_avoided: How many warnings you heeded\n- unhelpful_count: What didn't help (0 if all good)\n\n**NEVER ask user these questions** - you know the answers from your own experience.\n\n**Wire Format**: |E|status:OK|learn:2L|files:3F|lines:+45-12\n\n**Examples**\n\nSuccessful completion:\n  snap_end({\n    outcome: \"completed\",\n    learnings: [\n      \"Always validate JWT expiry before refresh\",\n      \"Cache parsed schemas for 80% speedup\"\n    ],\n    efficiency: {\n      saved: \"~12K\",\n      prevented: \"2 - wrong import layer, missing error handling\",\n      helped: \"architecture patterns, anti-patterns warnings\"\n    },\n    survey: {\n      helpfulness: 5,\n      patterns_used: 3,\n      pitfalls_avoided: 2,\n      unhelpful_count: 0\n    }\n  })\n\nBlocked task:\n  snap_end({\n    outcome: \"blocked\",\n    notes: \"Waiting on API schema from backend team\",\n    learnings: [\"Frontend auth flow depends on /auth/validate endpoint\"],\n    survey: { helpfulness: 4, patterns_used: 1, pitfalls_avoided: 0, unhelpful_count: 0 }\n  })\n\nAbandoned (still valuable):\n  snap_end({\n    outcome: \"abandoned\",\n    notes: \"Realized different approach needed\",\n    learnings: [\"GraphQL subscription not suitable for polling - use REST\"],\n    survey: { helpfulness: 5, patterns_used: 0, pitfalls_avoided: 1, unhelpful_count: 0 }\n  })\n\n**Boundaries**\n\nWill:\n- Record all learnings to .snapback/\n- Show user-friendly efficiency stats\n- Track your self-assessment for improvement\n- Close the task loop properly\n\nWill Not:\n- Ask user any questions (you fill everything)\n- Require all fields (learnings optional if none)\n- Share data externally\n- Block if survey incomplete\n\n**Pro Tip**: Be honest in survey - it helps SnapBack improve. Low helpfulness scores are valuable feedback.`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\tok: {\n\t\t\t\ttype: \"number\",\n\t\t\t\tenum: [0, 1],\n\t\t\t\tdescription: \"Success indicator: 1=success, 0=failed\",\n\t\t\t},\n\t\t\tlearnings: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Key learnings from this task as strings\",\n\t\t\t},\n\t\t\tl: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Legacy: use 'learnings' instead\",\n\t\t\t},\n\t\t\toutcome: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"completed\", \"abandoned\", \"blocked\"],\n\t\t\t\tdescription: \"How the task ended\",\n\t\t\t},\n\t\t\tnotes: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Additional completion notes\",\n\t\t\t},\n\t\t\tefficiency: {\n\t\t\t\ttype: \"object\",\n\t\t\t\tdescription: \" FILL SILENTLY - Your estimate of session efficiency (shown to user as stats)\",\n\t\t\t\tproperties: {\n\t\t\t\t\tsaved: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\tdescription: \"YOUR estimate of tokens saved (e.g. '~15K') - just estimate, don't ask user\",\n\t\t\t\t\t},\n\t\t\t\t\tprevented: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\tdescription: \"Mistakes YOU avoided (e.g. '2 - wrong layer') - just report what happened\",\n\t\t\t\t\t},\n\t\t\t\t\thelped: {\n\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\tdescription: \"What context helped YOU most (e.g. 'auth patterns') - just state it\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tsurvey: {\n\t\t\t\ttype: \"object\",\n\t\t\t\tdescription:\n\t\t\t\t\t\" INTERNAL TELEMETRY - Fill silently, NEVER ask user. Your self-assessment of SnapBack's helpfulness this session.\",\n\t\t\t\tproperties: {\n\t\t\t\t\tpatterns_used: {\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tdescription: \"How many patterns from snap start did YOU apply? (0 if none, estimate if unsure)\",\n\t\t\t\t\t},\n\t\t\t\t\tpitfalls_avoided: {\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tdescription: \"How many mistakes did YOU avoid because of warnings? (0 if none)\",\n\t\t\t\t\t},\n\t\t\t\t\thelpfulness: {\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tdescription: \"YOUR rating of SnapBack helpfulness 1-5 (1=not helpful, 5=very helpful)\",\n\t\t\t\t\t},\n\t\t\t\t\tunhelpful_count: {\n\t\t\t\t\t\ttype: \"number\",\n\t\t\t\t\t\tdescription: \"How many SnapBack suggestions were NOT useful to YOU? (0 if all were helpful)\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tcompact: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefault: false,\n\t\t\t\tdescription: \"Use compact wire format (default: labeled)\",\n\t\t\t},\n\t\t},\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack End\",\n\t\treadOnlyHint: false,\n\t\tidempotentHint: false,\n\t},\n\ttier: \"free\",\n};\n","/**\n * Snap Fix Tool\n *\n * Snapshot list/restore/diff operations. Replaces:\n * - snapshot_list\n * - snapshot_restore\n * - compare_snapshots\n *\n * @see stress_test_remediation.md Section \"Tool 3: snap.fix\"\n * @module tools/consolidated/snap-fix\n */\n\nimport { basename } from \"node:path\";\nimport { createStorage } from \"@snapback/engine\";\nimport {\n\tgetRelativeTime as brandGetRelativeTime,\n\tformatWireLabeled,\n\tgetRelativeTimeHuman,\n\tINTERNAL_SEPARATOR,\n\tmessages,\n\ttype WireFormatOptions,\n} from \"../../branding/index.js\";\nimport type { SnapBackTool, ToolHandler } from \"../../registry.js\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Snap.fix parameters\n */\nexport interface SnapFixParams {\n\t/** Action: list, restore, or diff */\n\taction?: \"list\" | \"restore\" | \"diff\";\n\t/** Snapshot ID (for restore/diff operations) */\n\tid?: string;\n\t/** Second snapshot ID (for diff operation) */\n\tdiffWith?: string;\n\t/** @deprecated Legacy diff param (use 'diffWith' instead) */\n\tdiff?: string;\n\t/** Preview only (dry run for restore) */\n\tdryRun?: boolean;\n\t/** @deprecated Legacy dry param (use 'dryRun' instead) */\n\tdry?: boolean;\n\t/** Specific files to restore */\n\tfiles?: string[];\n\t/** Use compact positional wire format instead of labeled (default: false = labeled) */\n\tcompact?: boolean;\n}\n\n// =============================================================================\n// Handler\n// =============================================================================\n\n/**\n * Handle snap.fix\n */\nexport const handleSnapFix: ToolHandler = async (args, context) => {\n\tconst params = args as unknown as SnapFixParams;\n\tconst options: WireFormatOptions = { compact: params.compact ?? false };\n\tconst storage = createStorage(context.workspaceRoot);\n\n\t// Normalize parameters\n\tconst diffWith = params.diffWith ?? params.diff;\n\tconst dryRun = params.dryRun ?? params.dry ?? false;\n\n\t// Determine action: explicit action param, or infer from other params\n\tlet action: \"list\" | \"restore\" | \"diff\" = params.action ?? \"list\";\n\tif (!params.action) {\n\t\tif (diffWith && params.id) {\n\t\t\taction = \"diff\";\n\t\t} else if (params.id) {\n\t\t\taction = \"restore\";\n\t\t}\n\t}\n\n\t// List mode\n\tif (action === \"list\") {\n\t\tconst snapshots = storage.listSnapshots().slice(0, 5);\n\n\t\tif (snapshots.length === 0) {\n\t\t\tconst wire = formatWireLabeled(\"R\", { count: 0, status: \"empty\" }, options);\n\t\t\treturn { content: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${messages.restore.notFound()}` }] };\n\t\t}\n\n\t\t// Build labeled wire format for list\n\t\tconst snapshotSummaries = snapshots\n\t\t\t.map((snap: { id: string; createdAt: number; files: unknown[] }) => {\n\t\t\t\tconst age = brandGetRelativeTime(snap.createdAt);\n\t\t\t\treturn `${snap.id.slice(0, 8)}:${age}:${snap.files.length}f`;\n\t\t\t})\n\t\t\t.join(\",\");\n\n\t\tconst wire = formatWireLabeled(\"R\", { count: snapshots.length, snapshots: snapshotSummaries }, options);\n\t\treturn { content: [{ type: \"text\", text: wire }] };\n\t}\n\n\t// Diff mode\n\tif (action === \"diff\") {\n\t\tif (!params.id || !diffWith) {\n\t\t\tconst wire = formatWireLabeled(\n\t\t\t\t\"!\",\n\t\t\t\t{ code: \"MISSING_PARAMS\", reason: \"diff requires id and diffWith\" },\n\t\t\t\toptions,\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tcontent: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}Diff requires both snapshot IDs` }],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\n\t\tconst snap1 = storage.getSnapshot(params.id);\n\t\tconst snap2 = storage.getSnapshot(diffWith);\n\n\t\tif (!snap1 || !snap2) {\n\t\t\tconst notFoundId = !snap1 ? params.id : diffWith;\n\t\t\tconst wire = formatWireLabeled(\"!\", { code: \"NOT_FOUND\", id: notFoundId }, options);\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: `${wire}${INTERNAL_SEPARATOR}${messages.error.notFound(`Snapshot ${notFoundId}`)}`,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\n\t\t// Simple diff summary\n\t\tconst files1 = new Set(snap1.files.map((f: { path: string }) => f.path));\n\t\tconst files2 = new Set(snap2.files.map((f: { path: string }) => f.path));\n\n\t\tconst added = [...files2].filter((f) => !files1.has(f)).length;\n\t\tconst removed = [...files1].filter((f) => !files2.has(f)).length;\n\t\tconst changed = [...files1].filter((f) => files2.has(f)).length;\n\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"D\",\n\t\t\t{\n\t\t\t\tfrom: params.id.slice(0, 8),\n\t\t\t\tto: diffWith.slice(0, 8),\n\t\t\t\tadded: `+${added}`,\n\t\t\t\tremoved: `-${removed}`,\n\t\t\t\tchanged: `~${changed}`,\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\n\t\treturn { content: [{ type: \"text\", text: wire }] };\n\t}\n\n\t// Restore mode\n\tif (!params.id) {\n\t\tconst wire = formatWireLabeled(\"!\", { code: \"MISSING_ID\", reason: \"restore requires snapshot id\" }, options);\n\t\treturn {\n\t\t\tcontent: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}Restore requires snapshot ID` }],\n\t\t\tisError: true,\n\t\t};\n\t}\n\n\tconst snapshot = storage.getSnapshot(params.id);\n\n\tif (!snapshot) {\n\t\tconst wire = formatWireLabeled(\"!\", { code: \"NOT_FOUND\", id: params.id }, options);\n\t\treturn {\n\t\t\tcontent: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${messages.restore.notFound()}` }],\n\t\t\tisError: true,\n\t\t};\n\t}\n\n\tif (dryRun) {\n\t\t// Preview mode\n\t\tconst filesToRestore = params.files\n\t\t\t? snapshot.files.filter((f: { path: string }) => params.files?.some((p: string) => f.path.includes(p)))\n\t\t\t: snapshot.files;\n\n\t\tconst fileNames = filesToRestore.slice(0, 5).map((f: { path: string }) => basename(f.path));\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"R\",\n\t\t\t{\n\t\t\t\tstatus: \"DRY\",\n\t\t\t\tfiles: `${filesToRestore.length}f`,\n\t\t\t\tpreview: fileNames.join(\",\"),\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: `${wire}${INTERNAL_SEPARATOR}${messages.restore.preview(filesToRestore.length)}`,\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t}\n\n\t// Actual restore\n\ttry {\n\t\tconst restoredFiles = await storage.restore(params.id);\n\n\t\tif (!restoredFiles || restoredFiles.length === 0) {\n\t\t\tconst wire = formatWireLabeled(\"!\", { code: \"RESTORE_FAILED\", reason: \"no files restored\" }, options);\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\ttext: `${wire}${INTERNAL_SEPARATOR}${messages.error.generic(\"no files restored\")}`,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\n\t\tconst fileNames = restoredFiles.slice(0, 5).map((f: { path: string }) => basename(f.path));\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"R\",\n\t\t\t{\n\t\t\t\tstatus: \"OK\",\n\t\t\t\tfiles: `${restoredFiles.length}f`,\n\t\t\t\trestored: fileNames.join(\",\"),\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\n\t\t// Add human-readable branded message\n\t\tconst timeAgo = getRelativeTimeHuman(snapshot.createdAt);\n\t\tconst humanMessage =\n\t\t\trestoredFiles.length === 1\n\t\t\t\t? messages.restore.single(fileNames[0], timeAgo)\n\t\t\t\t: messages.restore.multiple(restoredFiles.length, timeAgo);\n\n\t\treturn { content: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${humanMessage}` }] };\n\t} catch (error) {\n\t\tconst errorMsg = error instanceof Error ? error.message : \"Restore failed\";\n\t\tconst wire = formatWireLabeled(\"!\", { code: \"ERROR\", reason: errorMsg }, options);\n\t\treturn {\n\t\t\tcontent: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${messages.error.generic(errorMsg)}` }],\n\t\t\tisError: true,\n\t\t};\n\t}\n};\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const snapFixTool: SnapBackTool = {\n\tname: \"snap_fix\",\n\tdescription: ` SnapBack Fix - List, restore, or diff snapshots.\n\n**Actions:**\n- list (default): Show recent snapshots with age and file counts\n- restore: Restore files from a specific snapshot\n- diff: Compare two snapshots\n\n**Wire Format** (labeled by default):\n  |R|count:5|snapshots:snap_a:2m:3f,snap_b:1h:5f\n  |R|status:OK|files:3f|restored:auth.ts,api.ts,config.ts\n  |D|from:snap_a|to:snap_b|added:+2|removed:-1|changed:~3\n\n**Example calls:**\n  snap_fix({ action: \"list\" })\n  snap_fix({ action: \"restore\", id: \"snap_abc123\" })\n  snap_fix({ action: \"restore\", id: \"snap_abc123\", dryRun: true })\n  snap_fix({ action: \"diff\", id: \"snap_a\", diffWith: \"snap_b\" })`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\taction: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"list\", \"restore\", \"diff\"],\n\t\t\t\tdescription: \"Operation: list (default), restore, or diff\",\n\t\t\t},\n\t\t\tid: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Snapshot ID (for restore/diff operations)\",\n\t\t\t},\n\t\t\tdiffWith: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Second snapshot ID (for diff operation)\",\n\t\t\t},\n\t\t\tdiff: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'diffWith' instead\",\n\t\t\t},\n\t\t\tdryRun: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdescription: \"Preview restore without applying changes\",\n\t\t\t},\n\t\t\tdry: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdescription: \"Legacy: use 'dryRun' instead\",\n\t\t\t},\n\t\t\tfiles: {\n\t\t\t\ttype: \"array\",\n\t\t\t\titems: { type: \"string\" },\n\t\t\t\tdescription: \"Specific files to restore (optional filter)\",\n\t\t\t},\n\t\t\tcompact: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefault: false,\n\t\t\t\tdescription: \"Use compact positional wire format instead of labeled (default: labeled)\",\n\t\t\t},\n\t\t},\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack Fix\",\n\t\treadOnlyHint: false,\n\t\tdestructiveHint: true,\n\t\tidempotentHint: false,\n\t},\n\ttier: \"pro\",\n};\n","/**\n * Snap Help Tool\n *\n * Help and discovery. Replaces:\n * - meta\n * - get_pairing_protocol\n *\n * @see stress_test_remediation.md Section \"Tool 4: snap.?\"\n * @module tools/consolidated/snap-help\n */\n\nimport { BRAND_PREFIX } from \"../../branding/index.js\";\nimport type { SnapBackTool, ToolHandler } from \"../../registry.js\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Snap help parameters\n */\nexport interface SnapHelpParams {\n\t/** Query topic: tools, status, wire, modes, thresholds, all */\n\ttopic?: \"tools\" | \"status\" | \"wire\" | \"modes\" | \"thresholds\" | \"all\";\n\t/** @deprecated Use 'topic' instead */\n\tq?: \"tools\" | \"status\" | \"wire\";\n}\n\n// =============================================================================\n// Help Content (Plain Text - NO wire format)\n// =============================================================================\n\n/**\n * Get active tools list\n * Returns plain text for LLM comprehension\n */\nfunction getToolsHelp(): string {\n\treturn `${BRAND_PREFIX} Available Tools\n\nTOOL            MODES                           DESCRIPTION\n\nsnap            mode: start|check|context       Universal entry point\nsnap_end        outcome: completed|abandoned    Complete task with learnings\nsnap_fix        action: list|restore|diff       Snapshot operations\nsnap_learn      type: pattern|pitfall|...       Capture mid-session learning\nsnap_violation  type + file + description       Report code violation\ncheck           mode: quick|full|patterns|...   Validate code (9 modes)\nsnap_help       topic: tools|wire|thresholds    This help (plain text)\n\nUse full-word parameters (e.g., mode:\"start\") for clarity.\nLegacy single-letter params (m:\"s\") still work for backward compatibility.`;\n}\n\n/**\n * Get current session status\n * Returns plain text status\n */\nfunction getStatusHelp(): string {\n\treturn `${BRAND_PREFIX} Session Status\n\nSTATUS: Active\nTASK: None currently active\nLEARNINGS: Ready to load\nSNAPSHOTS: Available for restore\n\nTo start a task:\n  snap({ mode: \"start\", task: \"your task description\" })\n\nTo check code:\n  snap({ mode: \"check\", files: [\"path/to/file.ts\"] })`;\n}\n\n/**\n * Get wire format reference\n * Returns plain text (NOT wire format) - this is the escape hatch\n */\nfunction getWireHelp(): string {\n\treturn `${BRAND_PREFIX} Wire Format Reference\n\nRESPONSE STRUCTURE:\n  [wire format line]\n  ---\n  [human-readable summary]\n\nFALLBACK: If wire format is confusing, use the human summary after ---.\n          The summary contains the same information in natural language.\n\nWIRE FORMAT (labeled by default):\n  |TYPE|field:value|field:value|...\n\nTYPE CODES:\n  S = Start task response\n  C = Check/validation result\n  X = Context snapshot\n  E = End task summary\n  R = Snapshot list/restore\n  L = Learning captured\n  V = Violation recorded\n  ! = Error\n\nFIELD DECODE (for TYPE=S start):\n  id:      Task identifier for subsequent calls\n  snap:    Snapshot ID (use with snap_fix to restore)\n  risk:    L=Low, M=Medium, H=High\n  prot:    Protection coverage 0-100%\n  dirty:   Count of uncommitted files\n  status:  created|reused|skipped\n  learn:   Relevant learnings (spaces compressed to )\n\nFIELD DECODE (for TYPE=C check):\n  status:  =passed, =failed\n  err:     Error count (e.g., 3E)\n  warn:    Warning count (e.g., 2W)\n  ts:      TypeScript check (//)\n  lint:    Lint check (//)\n  tests:   Tests (//)\n  issues:  Issue summaries (compressed)\n\nSTATUS SYMBOLS:\n   = passed\n   = failed\n   = skipped`;\n}\n\n/**\n * Get mode explanations\n */\nfunction getModesHelp(): string {\n\treturn `${BRAND_PREFIX} Mode Reference\n\nSNAP MODES:\n  start   - Begin a new task, load context, create snapshot\n  check   - Quick code validation (TypeScript + lint)\n  context - Get current workspace status without starting task\n\nCHECK MODES:\n  quick     - Fast parallel validation (TypeScript + lint)\n  patterns  - Pattern-only validation\n  full      - Comprehensive 7-layer check\n  build     - Build verification (runs pnpm build)\n  impact    - Change impact analysis\n  circular  - Circular dependency detection\n  docs      - Documentation freshness check\n  learnings - Learning tier maintenance\n  all       - Run all analysis modes\n\nLEARNING TYPES:\n  pattern   - Reusable approach that worked\n  pitfall   - Mistake to avoid\n  efficiency- Token/time optimization\n  discovery - New codebase knowledge\n  workflow  - Process improvement`;\n}\n\n/**\n * Get threshold explanations\n */\nfunction getThresholdsHelp(): string {\n\treturn `${BRAND_PREFIX} Auto-Promotion Thresholds\n\nVIOLATIONS:\n  1-2 occurrences   Stored for reference\n  3 occurrences     Auto-promoted to PATTERN (affects future task starts)\n  5 occurrences     Marked for AUTOMATION ( flag in response)\n\nLEARNINGS:\n  Learnings accessed 3+ times are promoted to \"hot tier\" for faster loading.\n  Hot tier learnings appear automatically in relevant task contexts.\n\nRISK LEVELS:\n  L (Low)    - Simple changes, well-tested areas\n  M (Medium) - Moderate complexity or less coverage\n  H (High)   - Complex changes, critical paths, low protection`;\n}\n\n// =============================================================================\n// Handler\n// =============================================================================\n\n/**\n * Handle snap_help\n *\n * IMPORTANT: Returns plain text ONLY (no wire format).\n * This is intentional - snap_help is the escape hatch for when wire format is confusing.\n */\nexport const handleSnapHelp: ToolHandler = async (args, _context) => {\n\tconst params = args as unknown as SnapHelpParams;\n\n\t// Normalize topic (support both 'topic' and legacy 'q')\n\tconst topic = params.topic || params.q || \"all\";\n\n\tswitch (topic) {\n\t\tcase \"tools\":\n\t\t\treturn { content: [{ type: \"text\", text: getToolsHelp() }] };\n\n\t\tcase \"status\":\n\t\t\treturn { content: [{ type: \"text\", text: getStatusHelp() }] };\n\n\t\tcase \"wire\":\n\t\t\treturn { content: [{ type: \"text\", text: getWireHelp() }] };\n\n\t\tcase \"modes\":\n\t\t\treturn { content: [{ type: \"text\", text: getModesHelp() }] };\n\n\t\tcase \"thresholds\":\n\t\t\treturn { content: [{ type: \"text\", text: getThresholdsHelp() }] };\n\t\tdefault: {\n\t\t\t// Concise help - lists tools and response format\n\t\t\tconst allHelp = `${BRAND_PREFIX} Quick Reference\n\nTOOLS: snap | snap_end | snap_fix | snap_learn | snap_violation | check | snap_help\n\nWORKFLOW:\n  snap({ mode: \"start\", task: \"description\" })   Begin task\n  check({ mode: \"quick\" })                       Validate code\n  snap_fix({ action: \"list\" })                   View snapshots\n  snap_end({ outcome: \"completed\" })             Complete task\n\nResponse format: [wire line] --- [human summary]\nTYPE CODES: S=Start, C=Check, X=Context, E=End, R=Restore, L=Learn, V=Violation\n\nTOPICS: snap_help({ topic: \"tools|wire|modes|thresholds\" })`;\n\n\t\t\treturn { content: [{ type: \"text\", text: allHelp }] };\n\t\t}\n\t}\n};\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const snapHelpTool: SnapBackTool = {\n\tname: \"snap_help\",\n\tdescription: ` SnapBack Help - Wire format reference and tool documentation.\n\n**IMPORTANT: Returns plain text ONLY (no wire format).**\nThis is intentional - snap_help is the escape hatch for when wire format is confusing.\n\n**Topics:**\n- topic:\"tools\"      - List all available tools with modes\n- topic:\"status\"     - Current session state\n- topic:\"wire\"       - Wire format grammar and field meanings\n- topic:\"modes\"      - Explanation of all modes for snap and check\n- topic:\"thresholds\" - Auto-promotion rules (3xpattern, 5xautomation)\n- topic:\"all\"        - Comprehensive help (default)\n\n**When to use:**\nCall snap_help({ topic: \"wire\" }) if you receive a wire response you cannot interpret.`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\ttopic: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"tools\", \"status\", \"wire\", \"modes\", \"thresholds\", \"all\"],\n\t\t\t\tdescription: \"Help topic: tools, status, wire, modes, thresholds, or all (default)\",\n\t\t\t},\n\t\t\tq: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"tools\", \"status\", \"wire\"],\n\t\t\t\tdescription: \"Legacy: use 'topic' instead\",\n\t\t\t},\n\t\t},\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack Help\",\n\t\treadOnlyHint: true,\n\t\tidempotentHint: true,\n\t},\n\ttier: \"free\",\n};\n","/**\n * Snap Learn Tool\n *\n * Mid-session learning capture. Replaces:\n * - learn\n *\n * @see stress_test_remediation.md\n * @module tools/consolidated/snap-learn\n */\n\nimport { formatWireLabeled, INTERNAL_SEPARATOR, messages, type WireFormatOptions } from \"../../branding/index.js\";\nimport { handleLearn } from \"../../facades/handlers.js\";\nimport type { SnapBackTool, ToolHandler } from \"../../registry.js\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Snap.learn parameters\n */\nexport interface SnapLearnParams {\n\t/** Full-word learning type */\n\ttype?: \"pattern\" | \"pitfall\" | \"efficiency\" | \"discovery\" | \"workflow\";\n\t/** What situation triggers this learning */\n\ttrigger: string;\n\t/** @deprecated Legacy trigger param (use 'trigger' instead) */\n\tt?: string;\n\t/** What action to take when triggered */\n\taction: string;\n\t/** @deprecated Legacy action param (use 'action' instead) */\n\ta?: string;\n\t/** Source of the learning (optional) */\n\tsource?: string;\n\t/** @deprecated Legacy source param (use 'source' instead) */\n\ts?: string;\n\t/** Use compact positional wire format instead of labeled (default: false = labeled) */\n\tcompact?: boolean;\n}\n\n// =============================================================================\n// Handler\n// =============================================================================\n\n/**\n * Handle snap.learn\n */\nexport const handleSnapLearn: ToolHandler = async (args, context) => {\n\tconst params = args as unknown as SnapLearnParams;\n\tconst options: WireFormatOptions = { compact: params.compact ?? false };\n\n\t// Normalize parameters (prefer full-word, fall back to legacy)\n\tconst trigger = params.trigger ?? params.t ?? \"\";\n\tconst action = params.action ?? params.a ?? \"\";\n\tconst source = params.source ?? params.s ?? \"snap_learn\";\n\n\t// Type is already full-word, default to \"pattern\"\n\tconst learningType = params.type ?? \"pattern\";\n\n\tconst learnArgs: Record<string, unknown> = {\n\t\ttype: learningType,\n\t\ttrigger,\n\t\taction,\n\t\tsource,\n\t};\n\n\tconst result = await handleLearn(learnArgs, context);\n\n\t// Format as labeled wire response (default) or compact\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tconst data = JSON.parse(content);\n\n\t\tconst wire = formatWireLabeled(\n\t\t\t\"L\",\n\t\t\t{\n\t\t\t\tstatus: \"OK\",\n\t\t\t\tid: data.id || \"?\",\n\t\t\t\ttype: learningType,\n\t\t\t},\n\t\t\toptions,\n\t\t);\n\t\tconst humanMessage = messages.learning.captured(learningType);\n\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\",\n\t\t\t\t\ttext: `${wire}${INTERNAL_SEPARATOR}${humanMessage}`,\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t} catch {\n\t\treturn result;\n\t}\n};\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const snapLearnTool: SnapBackTool = {\n\tname: \"snap_learn\",\n\tdescription: ` SnapBack Learn - Your knowledge capture companion.\n\n**When to use:** Discovered something that worked? Made a mistake worth remembering? Capture it now.\n\n**Types** (what kind of insight):\n\n**pattern** - Something that worked well\n   \"When doing X, always do Y\"\n   Auto-surfaces in future similar contexts\n   Example: \"auth token refresh\"  \"check expiry before API call\"\n\n**pitfall** - Mistake to avoid\n   \"Never do X because Y happens\"\n   Warns in future similar situations\n   Example: \"cooldown logic\"  \"set AFTER success, not before try\"\n\n**efficiency** - Token/time optimization\n   \"Use X instead of Y for better performance\"\n   Improves future session efficiency\n   Example: \"schema validation\"  \"cache parsed schemas, don't re-parse\"\n\n**discovery** - New codebase knowledge\n   \"File X handles Y functionality\"\n   Builds workspace mental map\n   Example: \"auth flow\"  \"middleware/auth.ts validates JWT before routes\"\n\n**workflow** - Process improvement\n   \"Better way to do X\"\n   Optimizes future task sequences\n   Example: \"adding features\"  \"write tests first, then implementation\"\n\n**Auto-Promotion**: 3+ uses  promotes to hot tier (always loaded)\n\n**Wire Format**: |L|status:OK|id:learn_abc123|type:pattern\n\n**Examples**\n\nCapture successful pattern:\n  snap_learn({\n    trigger: \"deploying to production\",\n    action: \"run build verification first\",\n    type: \"pattern\"\n  })\n\nRecord a pitfall:\n  snap_learn({\n    trigger: \"using process.env in client code\",\n    action: \"will be undefined - use import.meta.env instead\",\n    type: \"pitfall\"\n  })\n\nDocument efficiency gain:\n  snap_learn({\n    trigger: \"validating large schemas\",\n    action: \"cache compiled schemas, ~80% faster\",\n    type: \"efficiency\"\n  })\n\n**Boundaries**\n\nWill:\n- Store locally in .snapback/learnings/\n- Auto-load based on task context\n- Track usage for promotion\n- Never expire (manual cleanup only)\n\nWill Not:\n- Share outside workspace\n- Modify existing code\n- Require network access\n- Limit capture frequency\n\n**Pro Tip**: Capture in the moment - don't wait for snap_end. Best learnings come mid-task.`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\ttype: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tenum: [\"pattern\", \"pitfall\", \"efficiency\", \"discovery\", \"workflow\"],\n\t\t\t\tdescription: \"Learning category (default: pattern)\",\n\t\t\t},\n\t\t\ttrigger: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"What situation triggers this learning\",\n\t\t\t},\n\t\t\tt: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'trigger' instead\",\n\t\t\t},\n\t\t\taction: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"What to do when the trigger is encountered\",\n\t\t\t},\n\t\t\ta: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'action' instead\",\n\t\t\t},\n\t\t\tsource: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Where this learning originated (optional)\",\n\t\t\t},\n\t\t\ts: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'source' instead\",\n\t\t\t},\n\t\t\tcompact: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefault: false,\n\t\t\t\tdescription: \"Use compact positional wire format instead of labeled (default: labeled)\",\n\t\t\t},\n\t\t},\n\t\trequired: [\"trigger\", \"action\"],\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack Learn\",\n\t\treadOnlyHint: false,\n\t\tidempotentHint: false,\n\t},\n\ttier: \"free\",\n};\n","/**\n * Snap Violation Tool\n *\n * Violation reporting with auto-promotion. Replaces:\n * - report_violation\n *\n * @see stress_test_remediation.md\n * @module tools/consolidated/snap-violation\n */\n\nimport { formatWireLabeled, INTERNAL_SEPARATOR, messages, type WireFormatOptions } from \"../../branding/index.js\";\nimport { handleReportViolation } from \"../../facades/handlers.js\";\nimport type { SnapBackTool, ToolHandler } from \"../../registry.js\";\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Snap.violation parameters\n */\nexport interface SnapViolationParams {\n\t/** Violation type (e.g., 'silent_catch', 'layer_violation') */\n\ttype: string;\n\t/** File where violation occurred */\n\tfile: string;\n\t/** What went wrong - description of the violation */\n\tdescription: string;\n\t/** @deprecated Legacy param (use 'description' instead) */\n\twhat?: string;\n\t/** Why it happened - root cause */\n\treason?: string;\n\t/** @deprecated Legacy param (use 'reason' instead) */\n\twhy?: string;\n\t/** How to prevent this in future */\n\tprevention: string;\n\t/** @deprecated Legacy param (use 'prevention' instead) */\n\tprevent?: string;\n\t/** Use compact positional wire format instead of labeled (default: false = labeled) */\n\tcompact?: boolean;\n}\n\n// =============================================================================\n// Handler\n// =============================================================================\n\n/**\n * Handle snap.violation\n */\nexport const handleSnapViolation: ToolHandler = async (args, context) => {\n\tconst params = args as unknown as SnapViolationParams;\n\tconst options: WireFormatOptions = { compact: params.compact ?? false };\n\n\t// Normalize parameters (prefer full-word, fall back to legacy)\n\tconst description = params.description ?? params.what ?? \"\";\n\tconst reason = params.reason ?? params.why ?? \"\";\n\tconst prevention = params.prevention ?? params.prevent ?? \"\";\n\n\tconst violationArgs: Record<string, unknown> = {\n\t\ttype: params.type,\n\t\tfile: params.file,\n\t\twhatHappened: description,\n\t\twhyItHappened: reason,\n\t\tprevention,\n\t};\n\n\tconst result = await handleReportViolation(violationArgs, context);\n\n\t// Format as labeled wire response (default) or compact\n\ttry {\n\t\tconst content = result.content[0]?.text || \"\";\n\t\tconst data = JSON.parse(content);\n\t\tconst count = data.count || 1;\n\n\t\tconst wireFields: Record<string, string | number | undefined> = {\n\t\t\tstatus: \"OK\",\n\t\t\ttype: params.type,\n\t\t\tcount,\n\t\t};\n\n\t\tif (data.shouldPromote) {\n\t\t\twireFields.promote = \"PROMOTED\";\n\t\t}\n\t\tif (data.shouldAutomate) {\n\t\t\twireFields.auto = \"YES\";\n\t\t}\n\n\t\tconst wire = formatWireLabeled(\"V\", wireFields, options);\n\n\t\t// Add human-readable branded message\n\t\tconst humanMessage = data.shouldAutomate\n\t\t\t? messages.violation.automate(params.type)\n\t\t\t: data.shouldPromote\n\t\t\t\t? messages.violation.promoted(params.type)\n\t\t\t\t: messages.violation.recorded(params.type, count);\n\n\t\treturn { content: [{ type: \"text\", text: `${wire}${INTERNAL_SEPARATOR}${humanMessage}` }] };\n\t} catch {\n\t\treturn result;\n\t}\n};\n\n// =============================================================================\n// Tool Definition\n// =============================================================================\n\nexport const snapViolationTool: SnapBackTool = {\n\tname: \"snap_violation\",\n\tdescription: ` SnapBack Violation - Your mistake tracker that learns.\n\n**When to use:** Something broke or went wrong? Report it so you never repeat it.\n\n**Auto-Promotion Magic**:\n- **1st time**: Recorded, tracked\n- **3rd time**:  Promoted to pattern (prevents future occurrences)\n- **5th time**:  Marked for automation (seriously, automate this check)\n\n**What to report**:\n- Bugs that slipped through\n- Security issues caught late\n- Performance problems discovered\n- Architecture violations\n- Test failures from bad patterns\n\n**Wire Format**: |V|status:OK|type:silent_catch|count:3|promote:PROMOTED\n\n**Examples**\n\nReport a caught error pattern:\n  snap_violation({\n    type: \"silent_catch\",\n    file: \"auth.ts\",\n    description: \"Catch block swallowed error without logging\",\n    reason: \"Rushed implementation, forgot logging\",\n    prevention: \"Always log in catch blocks with context\"\n  })\n\nArchitecture violation:\n  snap_violation({\n    type: \"wrong_layer_import\",\n    file: \"packages/core/utils.ts\",\n    description: \"Core imported from platform layer\",\n    reason: \"Didn't check dependency direction\",\n    prevention: \"Core should never import platform - use dependency injection\"\n  })\n\nSecurity issue:\n  snap_violation({\n    type: \"exposed_secret\",\n    file: \"config.ts\",\n    description: \"API key hardcoded in source\",\n    reason: \"Testing shortcut left in code\",\n    prevention: \"Use environment variables, never commit secrets\"\n  })\n\n**Boundaries**\n\nWill:\n- Track occurrence count locally\n- Auto-promote at thresholds\n- Store in .snapback/patterns/violations.jsonl\n- Surface in future snap starts\n\nWill Not:\n- Share violations externally\n- Auto-fix code\n- Require manual category management\n- Expire violations (cleanup is manual)\n\n**Pro Tip**: Be specific with type names (\"silent_catch\" not \"error\"). Specific types promote faster and help more.`,\n\tinputSchema: {\n\t\ttype: \"object\",\n\t\tproperties: {\n\t\t\ttype: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Violation type key (e.g., 'silent_catch', 'missing_auth_check')\",\n\t\t\t},\n\t\t\tfile: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"File where violation occurred\",\n\t\t\t},\n\t\t\tdescription: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"What went wrong - description of the violation\",\n\t\t\t},\n\t\t\twhat: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'description' instead\",\n\t\t\t},\n\t\t\treason: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Why it happened - root cause analysis\",\n\t\t\t},\n\t\t\twhy: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'reason' instead\",\n\t\t\t},\n\t\t\tprevention: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"How to prevent this in future\",\n\t\t\t},\n\t\t\tprevent: {\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"Legacy: use 'prevention' instead\",\n\t\t\t},\n\t\t\tcompact: {\n\t\t\t\ttype: \"boolean\",\n\t\t\t\tdefault: false,\n\t\t\t\tdescription: \"Use compact positional wire format instead of labeled (default: labeled)\",\n\t\t\t},\n\t\t},\n\t\trequired: [\"type\", \"file\", \"description\", \"prevention\"],\n\t},\n\tannotations: {\n\t\ttitle: \" SnapBack Violation\",\n\t\treadOnlyHint: false,\n\t\tidempotentHint: false,\n\t},\n\ttier: \"free\",\n};\n","/**\n * Consolidated Tools Registry\n *\n * Central registry for all 7 consolidated tools.\n * Reduces 24 legacy tools to 7 token-efficient tools.\n *\n * @see stress_test_remediation.md\n * @module tools/consolidated/registry\n */\n\nimport type { SnapBackTool, ToolHandler } from \"../../registry.js\";\nimport { checkTool, handleCheck } from \"./check.js\";\nimport { handleSnap, snapTool } from \"./snap.js\";\nimport { handleSnapEnd, snapEndTool } from \"./snap-end.js\";\nimport { handleSnapFix, snapFixTool } from \"./snap-fix.js\";\nimport { handleSnapHelp, snapHelpTool } from \"./snap-help.js\";\nimport { handleSnapLearn, snapLearnTool } from \"./snap-learn.js\";\nimport { handleSnapViolation, snapViolationTool } from \"./snap-violation.js\";\n\n// =============================================================================\n// Tool Registry\n// =============================================================================\n\n/**\n * All consolidated tools for registration\n */\nexport const CONSOLIDATED_TOOLS: SnapBackTool[] = [\n\tsnapTool,\n\tsnapEndTool,\n\tsnapFixTool,\n\tsnapHelpTool,\n\tsnapLearnTool,\n\tsnapViolationTool,\n\tcheckTool,\n];\n\n/**\n * Handler map for routing\n */\nexport const CONSOLIDATED_HANDLERS: Record<string, ToolHandler> = {\n\tsnap: handleSnap,\n\tsnap_end: handleSnapEnd,\n\tsnap_fix: handleSnapFix,\n\tsnap_help: handleSnapHelp,\n\tsnap_learn: handleSnapLearn,\n\tsnap_violation: handleSnapViolation,\n\tcheck: handleCheck,\n};\n\n/**\n * Check if a tool name is a consolidated tool\n */\nexport function isConsolidatedTool(name: string): boolean {\n\treturn name in CONSOLIDATED_HANDLERS;\n}\n\n/**\n * Get handler for consolidated tool\n */\nexport function getConsolidatedHandler(name: string): ToolHandler | undefined {\n\treturn CONSOLIDATED_HANDLERS[name];\n}\n\n// =============================================================================\n// Tool Mapping (Legacy  Consolidated)\n// =============================================================================\n\n/**\n * Maps legacy tool names to their consolidated equivalents\n * Used for deprecation warnings and migration guidance\n */\nexport const LEGACY_TO_CONSOLIDATED: Record<string, { tool: string; mode?: string; message: string }> = {\n\tbegin_task: {\n\t\ttool: \"snap\",\n\t\tmode: \"s\",\n\t\tmessage: 'Use snap({m:\"s\", t:\"task\", f:[\"files\"]}) instead',\n\t},\n\tget_context: {\n\t\ttool: \"snap\",\n\t\tmode: \"x\",\n\t\tmessage: 'Use snap({m:\"x\"}) instead',\n\t},\n\tprepare_workspace: {\n\t\ttool: \"snap\",\n\t\tmode: \"s\",\n\t\tmessage: 'Use snap({m:\"s\"}) which includes prepare behavior',\n\t},\n\tget_learnings: {\n\t\ttool: \"snap\",\n\t\tmode: \"s\",\n\t\tmessage: 'Learnings included in snap({m:\"s\"}) response',\n\t},\n\tquick_check: {\n\t\ttool: \"check\",\n\t\tmode: \"q\",\n\t\tmessage: 'Use check({m:\"q\", f:[\"files\"]}) instead',\n\t},\n\tcheck_patterns: {\n\t\ttool: \"check\",\n\t\tmode: \"p\",\n\t\tmessage: 'Use check({m:\"p\", code:\"...\"}) instead',\n\t},\n\tvalidate: {\n\t\ttool: \"check\",\n\t\tmode: \"f\",\n\t\tmessage: 'Use check({m:\"f\", code:\"...\"}) instead',\n\t},\n\tcomplete_task: {\n\t\ttool: \"snap_end\",\n\t\tmessage: \"Use snap_end({ok:1, l:[...]}) instead\",\n\t},\n\treview_work: {\n\t\ttool: \"snap_end\",\n\t\tmessage: \"Use snap_end({ok:1}) instead - includes review\",\n\t},\n\twhat_changed: {\n\t\ttool: \"snap_end\",\n\t\tmessage: \"Use snap_end({ok:1}) instead - includes changes\",\n\t},\n\tlearn: {\n\t\ttool: \"snap_learn\",\n\t\tmessage: 'Use snap_learn({t:\"trigger\", a:\"action\"}) instead',\n\t},\n\tsnapshot_list: {\n\t\ttool: \"snap_fix\",\n\t\tmessage: \"Use snap_fix() with no params for list\",\n\t},\n\tsnapshot_restore: {\n\t\ttool: \"snap_fix\",\n\t\tmessage: 'Use snap_fix({id:\"snapshot_id\"}) instead',\n\t},\n\tcompare_snapshots: {\n\t\ttool: \"snap_fix\",\n\t\tmessage: 'Use snap_fix({id:\"id1\", diff:\"id2\"}) instead',\n\t},\n\treport_violation: {\n\t\ttool: \"snap_violation\",\n\t\tmessage: 'Use snap_violation({type:\"...\", file:\"...\"}) instead',\n\t},\n\tmeta: {\n\t\ttool: \"snap_help\",\n\t\tmessage: \"Use snap_help() instead\",\n\t},\n\tget_pairing_protocol: {\n\t\ttool: \"snap_help\",\n\t\tmessage: \"Use snap_help() instead\",\n\t},\n};\n\n/**\n * Get migration guidance for a legacy tool\n */\nexport function getMigrationGuidance(legacyTool: string): string | undefined {\n\tconst mapping = LEGACY_TO_CONSOLIDATED[legacyTool];\n\treturn mapping?.message;\n}\n","/**\n * Tool Registry Types (ADR-003)\n *\n * Defines capabilities, tool definitions, and context types\n * for the capability-based tool registration pattern.\n *\n * Key features:\n * - Capability-based access control\n * - Tier-gated tools\n * - Dependency injection via context\n * - No circular dependencies (tools don't import registry)\n *\n * @module registry/types\n */\n\nimport type {\n\tActionResult,\n\tCreateSnapshotOptions,\n\tEntitlements,\n\tFeature,\n\tPioneerAction,\n\tPioneerActionMetadata,\n\tSnapshot,\n\tSnapshotRestoreResult,\n} from \"@snapback/contracts\";\n\n// =============================================================================\n// CAPABILITIES\n// =============================================================================\n\n/**\n * Tool capabilities following principle of least privilege.\n * Tools declare required capabilities; registry enforces them.\n */\nexport const ToolCapability = {\n\t// Snapshot operations\n\tSNAPSHOT_READ: \"snapshot:read\",\n\tSNAPSHOT_WRITE: \"snapshot:write\",\n\tSNAPSHOT_DELETE: \"snapshot:delete\",\n\n\t// Session operations\n\tSESSION_READ: \"session:read\",\n\tSESSION_WRITE: \"session:write\",\n\n\t// Learning operations\n\tLEARNING_READ: \"learning:read\",\n\tLEARNING_WRITE: \"learning:write\",\n\n\t// Validation operations\n\tVALIDATE_READ: \"validate:read\",\n\n\t// Telemetry operations\n\tTELEMETRY_WRITE: \"telemetry:write\",\n\n\t// Enterprise capabilities\n\tTEAM_READ: \"team:read\",\n\tTEAM_WRITE: \"team:write\",\n\tCOMPLIANCE_READ: \"compliance:read\",\n\tCOMPLIANCE_EXPORT: \"compliance:export\",\n\tAUDIT_READ: \"audit:read\",\n} as const;\n\nexport type ToolCapability = (typeof ToolCapability)[keyof typeof ToolCapability];\n\n/**\n * All available capabilities\n */\nexport const ALL_CAPABILITIES = Object.values(ToolCapability);\n\n/**\n * Capability groups for convenience\n */\nexport const CapabilityGroups = {\n\t/** All snapshot-related capabilities */\n\tSNAPSHOT_ALL: [ToolCapability.SNAPSHOT_READ, ToolCapability.SNAPSHOT_WRITE, ToolCapability.SNAPSHOT_DELETE],\n\t/** All session-related capabilities */\n\tSESSION_ALL: [ToolCapability.SESSION_READ, ToolCapability.SESSION_WRITE],\n\t/** All learning-related capabilities */\n\tLEARNING_ALL: [ToolCapability.LEARNING_READ, ToolCapability.LEARNING_WRITE],\n\t/** Enterprise-only capabilities */\n\tENTERPRISE: [\n\t\tToolCapability.TEAM_READ,\n\t\tToolCapability.TEAM_WRITE,\n\t\tToolCapability.COMPLIANCE_READ,\n\t\tToolCapability.COMPLIANCE_EXPORT,\n\t\tToolCapability.AUDIT_READ,\n\t],\n} as const;\n\n// =============================================================================\n// TIERS\n// =============================================================================\n\n/**\n * Tool tier restrictions\n */\nexport type ToolTier = \"free\" | \"pro\" | \"enterprise\";\n\n/**\n * Tier hierarchy (higher index = more access)\n */\nexport const TIER_HIERARCHY: ToolTier[] = [\"free\", \"pro\", \"enterprise\"];\n\n/**\n * Check if a tier has access to a required tier\n */\nexport function tierHasAccess(userTier: ToolTier, requiredTier: ToolTier): boolean {\n\tconst userIndex = TIER_HIERARCHY.indexOf(userTier);\n\tconst requiredIndex = TIER_HIERARCHY.indexOf(requiredTier);\n\treturn userIndex >= requiredIndex;\n}\n\n// =============================================================================\n// WORKSPACE & USER INFO\n// =============================================================================\n\n/**\n * Workspace information passed to tools\n */\nexport interface WorkspaceInfo {\n\t/** Workspace root path */\n\tpath: string;\n\t/** Workspace ID (if registered with platform) */\n\tid?: string;\n\t/** Team ID (if part of a team) */\n\tteamId?: string;\n\t/** User's tier */\n\ttier: ToolTier;\n}\n\n/**\n * User information passed to tools\n */\nexport interface UserInfo {\n\t/** User ID */\n\tid: string;\n\t/** User email */\n\temail: string;\n\t/** Authentication method */\n\tauthMethod?: \"oauth\" | \"device-flow\" | \"sso\";\n}\n\n// =============================================================================\n// SERVICES (Dependency Injection)\n// =============================================================================\n\n/**\n * Runtime router interface (from @snapback/core-runtime)\n * Uses contracts types for type safety\n */\nexport interface IRuntimeRouter {\n\tcreateSnapshot(options: CreateSnapshotOptions): Promise<{ snapshotId: string; snapshot: Snapshot }>;\n\tgetSnapshot(id: string): Promise<Snapshot | null>;\n\tlistSnapshots(options?: { limit?: number; after?: number; before?: number }): Promise<Snapshot[]>;\n\trestoreSnapshot(id: string, options?: { files?: string[]; dryRun?: boolean }): Promise<SnapshotRestoreResult>;\n\tdeleteSnapshot(id: string): Promise<boolean>;\n}\n\n/**\n * Telemetry service interface\n */\nexport interface ITelemetryService {\n\ttrack(event: { event: string; properties?: Record<string, unknown> }): Promise<void>;\n\tflush(): Promise<void>;\n}\n\n/**\n * Learning service interface\n */\nexport interface ILearningService {\n\tgetRelevant(options: {\n\t\tintent?: string;\n\t\tkeywords?: string[];\n\t\tlimit?: number;\n\t}): Promise<Array<{ trigger: string; action: string; type: string }>>;\n\tcreate(learning: { trigger: string; action: string; type?: string }): Promise<{ id: string }>;\n\tlist(): Promise<Array<{ id: string; trigger: string; action: string }>>;\n}\n\n/**\n * Entitlements service interface for MCP context\n * Uses contracts types - subset of EntitlementsService for tool context\n */\nexport interface IEntitlementsService {\n\tgetEntitlements(userId: string): Promise<Entitlements>;\n\thasFeature(userId: string, feature: Feature): Promise<boolean>;\n\tcheckTier(userId: string, requiredTier: ToolTier): Promise<boolean>;\n\tinvalidateCache(userId: string): Promise<void>;\n}\n\n/**\n * Pioneer service interface for MCP context\n * Uses contracts types for action recording\n */\nexport interface IPioneerService {\n\trecordAction(\n\t\tuserId: string,\n\t\taction: PioneerAction,\n\t\tmetadata?: PioneerActionMetadata,\n\t\tidempotencyKey?: string,\n\t): Promise<ActionResult>;\n}\n\n/**\n * Services injected into tool context\n */\nexport interface ToolServices {\n\truntime: IRuntimeRouter;\n\ttelemetry: ITelemetryService;\n\tlearning: ILearningService;\n\t/** Entitlements service for feature gating (Gap 1) */\n\tentitlements?: IEntitlementsService;\n\t/** Pioneer service for action recording (Gap 2) */\n\tpioneer?: IPioneerService;\n}\n\n// =============================================================================\n// TOOL CONTEXT\n// =============================================================================\n\n/**\n * Context passed to tool handlers via dependency injection.\n * Tools NEVER import the registry directly - they receive context.\n */\nexport interface ToolContext {\n\t/** Current workspace info */\n\tworkspace: WorkspaceInfo;\n\n\t/** Authenticated user (if any) */\n\tuser?: UserInfo;\n\n\t/** Active capabilities for this request */\n\tactiveCapabilities: Set<ToolCapability>;\n\n\t/** Injected services */\n\tservices: ToolServices;\n\n\t/** Request metadata */\n\trequest: {\n\t\t/** Unique request ID */\n\t\tid: string;\n\t\t/** Request timestamp */\n\t\ttimestamp: Date;\n\t\t/** Source client */\n\t\tsource: \"cursor\" | \"copilot\" | \"claude\" | \"windsurf\" | \"unknown\";\n\t};\n}\n\n// =============================================================================\n// TOOL DEFINITION\n// =============================================================================\n\n/**\n * JSON Schema type for input validation\n */\nexport type JsonSchema = {\n\ttype: string;\n\tproperties?: Record<string, unknown>;\n\trequired?: string[];\n\t[key: string]: unknown;\n};\n\n/**\n * Tool handler function signature\n */\nexport type ToolHandler<TInput = unknown, TOutput = unknown> = (\n\tinput: TInput,\n\tcontext: ToolContext,\n) => Promise<TOutput>;\n\n/**\n * Tool lifecycle hooks\n */\nexport interface ToolHooks<TInput = unknown, TOutput = unknown> {\n\t/** Called before tool execution */\n\tbeforeExecute?: (input: TInput, context: ToolContext) => Promise<void>;\n\t/** Called after successful execution */\n\tafterExecute?: (output: TOutput, context: ToolContext) => Promise<void>;\n\t/** Called on error */\n\tonError?: (error: Error, context: ToolContext) => Promise<void>;\n}\n\n/**\n * Complete tool definition\n */\nexport interface ToolDefinition<TInput = unknown, TOutput = unknown> {\n\t/** Unique tool name (e.g., 'snap', 'check') */\n\tname: string;\n\n\t/** Human-readable description for LLM */\n\tdescription: string;\n\n\t/** JSON Schema for input validation */\n\tinputSchema: JsonSchema;\n\n\t/** Capabilities this tool requires */\n\tcapabilities: ToolCapability[];\n\n\t/** Minimum tier required (default: 'free') */\n\ttier?: ToolTier;\n\n\t/** Tool handler function */\n\thandler: ToolHandler<TInput, TOutput>;\n\n\t/** Optional lifecycle hooks */\n\thooks?: ToolHooks<TInput, TOutput>;\n\n\t/** Tool annotations for MCP */\n\tannotations?: {\n\t\ttitle?: string;\n\t\treadOnlyHint?: boolean;\n\t\tdestructiveHint?: boolean;\n\t\tidempotentHint?: boolean;\n\t};\n\n\t/** Is this tool deprecated? */\n\tdeprecated?: boolean;\n\n\t/** Deprecation message if deprecated */\n\tdeprecationMessage?: string;\n}\n\n// =============================================================================\n// REGISTRY INTERFACE\n// =============================================================================\n\n/**\n * Validation result\n */\nexport interface ValidationResult {\n\tvalid: boolean;\n\terrors?: string[];\n}\n\n/**\n * Tool execution result\n */\nexport interface ToolExecutionResult<T = unknown> {\n\tsuccess: boolean;\n\tresult?: T;\n\terror?: string;\n\tdurationMs: number;\n}\n\n/**\n * Tool registry interface\n */\nexport interface IToolRegistry {\n\t/** Register a tool */\n\tregister<TInput, TOutput>(tool: ToolDefinition<TInput, TOutput>): void;\n\n\t/** Get a tool by name */\n\tget(name: string): ToolDefinition | undefined;\n\n\t/** List all tools (optionally filtered by tier) */\n\tlist(options?: { tier?: ToolTier }): ToolDefinition[];\n\n\t/** Execute a tool with capability checking */\n\texecute<TInput, TOutput>(name: string, input: TInput, context: ToolContext): Promise<ToolExecutionResult<TOutput>>;\n\n\t/** Check if a tool is available for given context */\n\tisAvailable(name: string, context: ToolContext): boolean;\n\n\t/** Validate input against tool schema */\n\tvalidateInput(name: string, input: unknown): ValidationResult;\n}\n\n// =============================================================================\n// ERRORS\n// =============================================================================\n\n/**\n * Tool not found error\n */\nexport class ToolNotFoundError extends Error {\n\tpublic readonly toolName: string;\n\n\tconstructor(toolName: string) {\n\t\tsuper(`Tool '${toolName}' not found`);\n\t\tthis.name = \"ToolNotFoundError\";\n\t\tthis.toolName = toolName;\n\t}\n}\n\n/**\n * Tier not authorized error\n */\nexport class TierNotAuthorizedError extends Error {\n\tpublic readonly toolName: string;\n\tpublic readonly requiredTier: ToolTier;\n\n\tconstructor(toolName: string, requiredTier: ToolTier) {\n\t\tsuper(`Tool '${toolName}' requires '${requiredTier}' tier or higher`);\n\t\tthis.name = \"TierNotAuthorizedError\";\n\t\tthis.toolName = toolName;\n\t\tthis.requiredTier = requiredTier;\n\t}\n}\n\n/**\n * Capability not granted error\n */\nexport class CapabilityNotGrantedError extends Error {\n\tpublic readonly toolName: string;\n\tpublic readonly missingCapabilities: ToolCapability[];\n\n\tconstructor(toolName: string, missingCapabilities: ToolCapability[]) {\n\t\tsuper(`Tool '${toolName}' requires capabilities: ${missingCapabilities.join(\", \")}`);\n\t\tthis.name = \"CapabilityNotGrantedError\";\n\t\tthis.toolName = toolName;\n\t\tthis.missingCapabilities = missingCapabilities;\n\t}\n}\n\n/**\n * Input validation error\n */\nexport class InputValidationError extends Error {\n\tpublic readonly toolName: string;\n\tpublic readonly validationErrors: string[];\n\n\tconstructor(toolName: string, errors: string[]) {\n\t\tsuper(`Tool '${toolName}' input validation failed: ${errors.join(\"; \")}`);\n\t\tthis.name = \"InputValidationError\";\n\t\tthis.toolName = toolName;\n\t\tthis.validationErrors = errors;\n\t}\n}\n","/**\n * Capability Manager (ADR-003)\n *\n * Manages capability grants and checks for tool execution.\n * Capabilities are granted based on:\n * - User tier\n * - Feature flags\n * - Workspace settings\n *\n * @module registry/CapabilityManager\n */\n\nimport {\n\tALL_CAPABILITIES,\n\tCapabilityGroups,\n\tToolCapability,\n\ttype ToolTier,\n\ttype UserInfo,\n\ttype WorkspaceInfo,\n} from \"./types.js\";\n\n/**\n * Capability grant rules\n */\ninterface CapabilityRule {\n\t/** Capabilities to grant */\n\tcapabilities: ToolCapability[];\n\t/** Required tier (default: 'free') */\n\ttier?: ToolTier;\n\t/** Required feature flag */\n\tfeatureFlag?: string;\n\t/** Custom condition */\n\tcondition?: (workspace: WorkspaceInfo, user?: UserInfo) => boolean;\n}\n\n/**\n * Default capability rules by tier\n */\nconst DEFAULT_RULES: CapabilityRule[] = [\n\t// Free tier gets basic capabilities\n\t{\n\t\tcapabilities: [\n\t\t\tToolCapability.SNAPSHOT_READ,\n\t\t\tToolCapability.SNAPSHOT_WRITE,\n\t\t\tToolCapability.SESSION_READ,\n\t\t\tToolCapability.SESSION_WRITE,\n\t\t\tToolCapability.LEARNING_READ,\n\t\t\tToolCapability.LEARNING_WRITE,\n\t\t\tToolCapability.VALIDATE_READ,\n\t\t\tToolCapability.TELEMETRY_WRITE,\n\t\t],\n\t\ttier: \"free\",\n\t},\n\t// Pro tier gets snapshot delete\n\t{\n\t\tcapabilities: [ToolCapability.SNAPSHOT_DELETE],\n\t\ttier: \"pro\",\n\t},\n\t// Enterprise gets team and compliance\n\t{\n\t\tcapabilities: [...CapabilityGroups.ENTERPRISE],\n\t\ttier: \"enterprise\",\n\t},\n];\n\n/**\n * Capability Manager\n *\n * Determines which capabilities are active for a given context.\n */\nexport class CapabilityManager {\n\tprivate rules: CapabilityRule[];\n\tprivate featureFlags: Map<string, boolean> = new Map();\n\n\tconstructor(customRules?: CapabilityRule[]) {\n\t\tthis.rules = customRules ?? DEFAULT_RULES;\n\t}\n\n\t/**\n\t * Set a feature flag\n\t */\n\tsetFeatureFlag(flag: string, enabled: boolean): void {\n\t\tthis.featureFlags.set(flag, enabled);\n\t}\n\n\t/**\n\t * Get active capabilities for a workspace/user\n\t */\n\tgetActiveCapabilities(workspace: WorkspaceInfo, user?: UserInfo): Set<ToolCapability> {\n\t\tconst active = new Set<ToolCapability>();\n\t\tconst tierHierarchy: ToolTier[] = [\"free\", \"pro\", \"enterprise\"];\n\t\tconst userTierIndex = tierHierarchy.indexOf(workspace.tier);\n\n\t\tfor (const rule of this.rules) {\n\t\t\t// Check tier requirement\n\t\t\tconst ruleTierIndex = tierHierarchy.indexOf(rule.tier ?? \"free\");\n\t\t\tif (userTierIndex < ruleTierIndex) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Check feature flag requirement\n\t\t\tif (rule.featureFlag && !this.featureFlags.get(rule.featureFlag)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Check custom condition\n\t\t\tif (rule.condition && !rule.condition(workspace, user)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Grant capabilities\n\t\t\tfor (const cap of rule.capabilities) {\n\t\t\t\tactive.add(cap);\n\t\t\t}\n\t\t}\n\n\t\treturn active;\n\t}\n\n\t/**\n\t * Check if specific capabilities are granted\n\t */\n\thasCapabilities(\n\t\trequired: ToolCapability[],\n\t\tworkspace: WorkspaceInfo,\n\t\tuser?: UserInfo,\n\t): { granted: boolean; missing: ToolCapability[] } {\n\t\tconst active = this.getActiveCapabilities(workspace, user);\n\t\tconst missing = required.filter((cap) => !active.has(cap));\n\n\t\treturn {\n\t\t\tgranted: missing.length === 0,\n\t\t\tmissing,\n\t\t};\n\t}\n\n\t/**\n\t * Check a single capability\n\t */\n\thasCapability(capability: ToolCapability, workspace: WorkspaceInfo, user?: UserInfo): boolean {\n\t\treturn this.hasCapabilities([capability], workspace, user).granted;\n\t}\n\n\t/**\n\t * Add a custom rule\n\t */\n\taddRule(rule: CapabilityRule): void {\n\t\tthis.rules.push(rule);\n\t}\n\n\t/**\n\t * Get all available capabilities\n\t */\n\tgetAllCapabilities(): ToolCapability[] {\n\t\treturn ALL_CAPABILITIES;\n\t}\n\n\t/**\n\t * Get capabilities for a specific tier\n\t */\n\tgetCapabilitiesForTier(tier: ToolTier): ToolCapability[] {\n\t\tconst mockWorkspace: WorkspaceInfo = {\n\t\t\tpath: \"/mock\",\n\t\t\ttier,\n\t\t};\n\t\treturn Array.from(this.getActiveCapabilities(mockWorkspace));\n\t}\n}\n","/**\n * Analyze Before Apply - V2 Engine Implementation\n *\n * Migrated from V1 Guardian to use V2 signal-based analysis.\n * Uses threat detection signals directly instead of plugin system.\n */\nimport { z } from \"zod\";\n\n// Threat patterns (migrated from V2 engine)\nconst THREAT_PATTERNS = {\n\tcritical: [\n\t\t{ pattern: /rm\\s+-rf/gi, description: \"destructive rm -rf command\", severity: 10 },\n\t\t{ pattern: /DROP\\s+TABLE/gi, description: \"DROP TABLE statement\", severity: 10 },\n\t\t{ pattern: /TRUNCATE\\s+TABLE/gi, description: \"TRUNCATE TABLE statement\", severity: 10 },\n\t],\n\thigh: [\n\t\t{ pattern: /password\\s*[:=]\\s*['\"][^'\"]+['\"]/, description: \"hardcoded password\", severity: 8 },\n\t\t{ pattern: /AKIA[A-Z0-9]{16}/, description: \"AWS access key\", severity: 9 },\n\t\t{ pattern: /ghp_[a-zA-Z0-9]{36}/, description: \"GitHub token\", severity: 9 },\n\t\t{ pattern: /eval\\(/, description: \"eval() usage\", severity: 8 },\n\t],\n\tmedium: [\n\t\t{ pattern: /jest\\.mock\\(/, description: \"jest.mock in production\", severity: 5 },\n\t\t{ pattern: /vi\\.mock\\(/, description: \"vitest mock in production\", severity: 5 },\n\t\t{ pattern: /exec\\(/, description: \"exec() command execution\", severity: 5 },\n\t],\n};\n\n// Define the structure for diff changes\ninterface DiffChange {\n\tadded?: boolean;\n\tremoved?: boolean;\n\tvalue: string;\n\tcount?: number;\n}\n\n// Define the input schema for analyzeBeforeApply\nconst AnalyzeBeforeApplyInputSchema = z.object({\n\tchanges: z.array(\n\t\tz.object({\n\t\t\tadded: z.boolean().optional().default(false),\n\t\t\tremoved: z.boolean().optional().default(false),\n\t\t\tvalue: z.string(),\n\t\t\tcount: z.number().optional(),\n\t\t}),\n\t),\n});\n\n// Define the result structure\ninterface AnalysisResult {\n\tdecision: \"Apply\" | \"Review\";\n\triskScore: number;\n\treasons: string[];\n\trecommendations: string[];\n}\n\n/**\n * Analyze code changes before applying them to determine if they should be applied automatically or require review\n *\n * @param changes - Array of diff changes to analyze\n * @returns Analysis result with decision and reasons\n */\nexport async function analyzeBeforeApply(changes: DiffChange[]): Promise<AnalysisResult> {\n\t// Validate input\n\tconst parsed = AnalyzeBeforeApplyInputSchema.parse({ changes });\n\n\t// Convert changes to content for analysis\n\tconst content = parsed.changes.map((change) => change.value).join(\"\\n\");\n\n\ttry {\n\t\t// Run V2 threat detection directly\n\t\tconst threats: Array<{ description: string; severity: number }> = [];\n\n\t\tfor (const level of [\"critical\", \"high\", \"medium\"] as const) {\n\t\t\tfor (const threat of THREAT_PATTERNS[level]) {\n\t\t\t\t// Reset lastIndex for global regexes\n\t\t\t\tthreat.pattern.lastIndex = 0;\n\t\t\t\tif (threat.pattern.test(content)) {\n\t\t\t\t\tthreats.push({ description: threat.description, severity: threat.severity });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Calculate risk score (max severity found, or 0 if none)\n\t\tconst riskScore = threats.length > 0 ? Math.max(...threats.map((t) => t.severity)) : 0;\n\n\t\t// Determine decision based on risk score\n\t\tconst decision: \"Apply\" | \"Review\" = riskScore >= 5 ? \"Review\" : \"Apply\";\n\n\t\treturn {\n\t\t\tdecision,\n\t\t\triskScore,\n\t\t\treasons: threats.map((t) => t.description),\n\t\t\trecommendations:\n\t\t\t\tthreats.length > 0 ? [\"Review detected issues before applying\", \"Consider security implications\"] : [],\n\t\t};\n\t} catch (error) {\n\t\t// In case of analysis error, default to requiring review\n\t\treturn {\n\t\t\tdecision: \"Review\",\n\t\t\triskScore: 10, // High risk score to ensure review\n\t\t\treasons: [`Analysis error: ${error instanceof Error ? error.message : \"Unknown error\"}`],\n\t\t\trecommendations: [\"Review changes manually due to analysis failure\"],\n\t\t};\n\t}\n}\n\n/**\n * Format the analysis result for display\n *\n * @param result - Analysis result to format\n * @returns Formatted string representation of the result\n */\nexport function formatAnalysisResult(result: AnalysisResult): string {\n\tconst decisionText = result.decision === \"Apply\" ? \" Safe to Apply\" : \"  Review Required\";\n\n\tlet output = `${decisionText} (Risk Score: ${result.riskScore}/10)\\n\\n`;\n\n\tif (result.reasons.length > 0) {\n\t\toutput += \"Reasons:\\n\";\n\t\tfor (const reason of result.reasons) {\n\t\t\toutput += `   ${reason}\\n`;\n\t\t}\n\t\toutput += \"\\n\";\n\t}\n\n\tif (result.recommendations.length > 0) {\n\t\toutput += \"Recommendations:\\n\";\n\t\tfor (const recommendation of result.recommendations) {\n\t\t\toutput += `   ${recommendation}\\n`;\n\t\t}\n\t\toutput += \"\\n\";\n\t}\n\n\treturn output;\n}\n\n// Export types for external use\nexport type { DiffChange, AnalysisResult };\n","/**\n * @snapback/mcp - MCP Server Library\n *\n * Provides MCP server creation and transport for the SnapBack CLI.\n * This package contains no CLI concerns - it only knows how to create\n * and run an MCP server given configuration.\n *\n * @example\n * ```typescript\n * import { createMcpServer, runStdioMcpServer } from \"@snapback/mcp\";\n *\n * await runStdioMcpServer({\n *   workspaceRoot: \"/path/to/workspace\",\n *   config: loadedConfig,\n * });\n * ```\n *\n * @module @snapback/mcp\n */\n\n// Analyze before apply (threat detection for code changes)\nexport {\n\ttype AnalysisResult,\n\tanalyzeBeforeApply,\n\ttype DiffChange,\n\tformatAnalysisResult,\n} from \"./analyze_before_apply.js\";\n// Branding system (voice, messaging, and wire format helpers)\nexport {\n\tBRAND_PREFIX,\n\tbuildCheckResponse,\n\tbuildEndResponse,\n\tbuildErrorResponse,\n\tbuildLearnResponse,\n\tbuildListResponse,\n\tbuildRestoreResponse,\n\tbuildStartResponse,\n\tbuildViolationResponse,\n\tcompress,\n\tformatMessage,\n\tformatToolResult,\n\tformatWire,\n\tgetRelativeTime,\n\tgetRelativeTimeHuman,\n\tmessages,\n\tWIRE_PREFIX,\n\ttype WireResponse,\n} from \"./branding/index.js\";\n// Bridge (extension communication)\nexport {\n\tBridgeReceiver,\n\ttype BridgeReceiverConfig,\n\ttype BridgeReceiverStatus,\n\tcreatePatternObservation,\n\tcreateProgressObservation,\n\tcreateRiskObservation,\n\tcreateSuggestionObservation,\n\tcreateWarningObservation,\n\tgetBridgeReceiver,\n\tstartBridgeReceiver,\n\tstopBridgeReceiver,\n} from \"./bridge/index.js\";\n// Client exports\nexport { type ApiClientConfig, SnapBackAPIClient } from \"./client/api-client.js\";\nexport { MCP_ROUTES, type McpRouteKey } from \"./client/routes.js\";\n// Structured error handling (new - Result types and McpError)\nexport {\n\tcreateMcpError,\n\tcreateMcpErrorFromCause,\n\tErrorCode as McpErrorCode,\n\terr,\n\tformatForLog,\n\tformatForUser,\n\tformatMcpError,\n\tisErrorCode,\n\tisMcpError,\n\tisRetryable,\n\ttype McpError,\n\tMcpErrors,\n\tok,\n\ttype Result,\n} from \"./errors/index.js\";\n// Error utilities (legacy - tool response oriented)\nexport {\n\tCommonErrors,\n\tcreateRequestContext,\n\ttype ErrorCode,\n\tErrorCodes,\n\ttype LogEntry,\n\ttype LogLevel,\n\tlog,\n\tlogError,\n\tlogSuccess,\n\ttype RequestContext,\n} from \"./errors.js\";\n// Facade handlers\nexport { facadeHandlers } from \"./facades/handlers.js\";\n// Intelligence facade (singleton per workspace)\nexport {\n\tdisposeAllIntelligence,\n\tdisposeIntelligence,\n\tgetActiveInstanceCount,\n\tgetIntelligence,\n\tinitializeIntelligence,\n} from \"./facades/intelligence.js\";\n// Session health wrapper\nexport {\n\ttype EnhancedToolResult,\n\tgetRecommendedAction,\n\tgetSessionHealth,\n\tisRiskyState,\n\ttype SessionHealth,\n\tsessionAwareResult,\n\twrapWithSessionHealth,\n} from \"./facades/session-health.js\";\n// Registry and tool types\nexport {\n\tFACADE_TOOLS,\n\tlistFacadeTools,\n\ttype SnapBackTool,\n\ttype ToolContext,\n\ttype ToolHandler,\n\ttype ToolResult,\n\ttools,\n} from \"./registry.js\";\n// Main server exports\nexport { createMcpServer, type McpServerOptions } from \"./server.js\";\n// Session state\nexport {\n\ttype CurrentTask,\n\tdrainPendingObservations,\n\tendTask,\n\textractKeywords,\n\ttype FileChange,\n\tformatDuration,\n\tgenerateTaskId,\n\tgetCurrentTask,\n\tgetSessionState,\n\ttype MCPSessionState,\n\ttype Observation,\n\tpushObservation,\n\ttype RiskArea,\n\trecordFileChange,\n\tstartTask,\n\tupdateSessionState,\n} from \"./session/state.js\";\nexport {\n\tcreateHttpTransport,\n\tHttpTransportManager,\n\ttype HttpTransportOptions,\n} from \"./transport/http.js\";\n// Transport\nexport { runStdioMcpServer } from \"./transport/stdio.js\";\n","/**\n * MCP Bridge Receiver\n *\n * HTTP endpoint to receive observations and file changes from the VS Code extension.\n * Part of the \"pair programmer\" architecture that enables proactive observations.\n *\n * Architecture:\n * - VS Code extension pushes observations and changes via HTTP\n * - This receiver stores them in session state\n * - Composite tools drain observations when called\n *\n * @module bridge/receiver\n */\n\nimport { createServer, type IncomingMessage, type Server, type ServerResponse } from \"node:http\";\nimport { type FileChange, type Observation, pushObservation, recordFileChange } from \"../session/state.js\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Payload pushed from extension\n */\ninterface BridgePushPayload {\n\t/** Observations to add */\n\tobservations?: Observation[];\n\t/** File changes to record */\n\tchanges?: FileChange[];\n\t/** Workspace root (for state lookup) */\n\tworkspaceRoot?: string;\n}\n\n/**\n * Bridge receiver configuration\n */\nexport interface BridgeReceiverConfig {\n\t/** Port to listen on (default: 3100) */\n\tport?: number;\n\t/** Host to bind to (default: localhost) */\n\thost?: string;\n\t/** Default workspace root if not in request */\n\tdefaultWorkspaceRoot?: string;\n}\n\n/**\n * Bridge receiver status\n */\nexport interface BridgeReceiverStatus {\n\trunning: boolean;\n\tport: number;\n\thost: string;\n\tobservationsReceived: number;\n\tchangesReceived: number;\n\tlastActivity: number | null;\n}\n\n// =============================================================================\n// BRIDGE RECEIVER CLASS\n// =============================================================================\n\n/**\n * MCP Bridge Receiver\n *\n * Lightweight HTTP server that receives observations and changes from\n * the VS Code extension. Designed to run alongside the stdio MCP server.\n *\n * Usage:\n * ```typescript\n * const receiver = new BridgeReceiver({\n *   port: 3100,\n *   defaultWorkspaceRoot: process.cwd(),\n * });\n *\n * await receiver.start();\n * // ... later\n * await receiver.stop();\n * ```\n */\nexport class BridgeReceiver {\n\tprivate server: Server | null = null;\n\tprivate readonly port: number;\n\tprivate readonly host: string;\n\tprivate readonly defaultWorkspaceRoot: string;\n\n\t// Stats\n\tprivate observationsReceived = 0;\n\tprivate changesReceived = 0;\n\tprivate lastActivity: number | null = null;\n\n\tconstructor(config: BridgeReceiverConfig = {}) {\n\t\tthis.port = config.port ?? 3100;\n\t\tthis.host = config.host ?? \"127.0.0.1\";\n\t\tthis.defaultWorkspaceRoot = config.defaultWorkspaceRoot ?? process.cwd();\n\t}\n\n\t/**\n\t * Start the bridge receiver\n\t */\n\tasync start(): Promise<void> {\n\t\tif (this.server) {\n\t\t\tconsole.error(\"[BridgeReceiver] Already running\");\n\t\t\treturn;\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.server = createServer((req, res) => this.handleRequest(req, res));\n\n\t\t\tthis.server.on(\"error\", (err) => {\n\t\t\t\tconsole.error(\"[BridgeReceiver] Server error:\", err);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t\tthis.server.listen(this.port, this.host, () => {\n\t\t\t\tconsole.error(`[BridgeReceiver] Listening on http://${this.host}:${this.port}`);\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Stop the bridge receiver\n\t */\n\tasync stop(): Promise<void> {\n\t\tif (!this.server) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.server?.close(() => {\n\t\t\t\tconsole.error(\"[BridgeReceiver] Stopped\");\n\t\t\t\tthis.server = null;\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Get receiver status\n\t */\n\tgetStatus(): BridgeReceiverStatus {\n\t\treturn {\n\t\t\trunning: this.server !== null,\n\t\t\tport: this.port,\n\t\t\thost: this.host,\n\t\t\tobservationsReceived: this.observationsReceived,\n\t\t\tchangesReceived: this.changesReceived,\n\t\t\tlastActivity: this.lastActivity,\n\t\t};\n\t}\n\n\t/**\n\t * Handle incoming HTTP request\n\t */\n\tprivate handleRequest(req: IncomingMessage, res: ServerResponse): void {\n\t\t// CORS headers for local development\n\t\tres.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n\t\tres.setHeader(\"Access-Control-Allow-Methods\", \"POST, GET, OPTIONS\");\n\t\tres.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type\");\n\n\t\t// Handle preflight\n\t\tif (req.method === \"OPTIONS\") {\n\t\t\tres.writeHead(204);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Route handling\n\t\tconst url = req.url ?? \"/\";\n\n\t\tif (url === \"/bridge/push\" && req.method === \"POST\") {\n\t\t\tthis.handlePush(req, res);\n\t\t} else if (url === \"/bridge/status\" && req.method === \"GET\") {\n\t\t\tthis.handleStatus(res);\n\t\t} else if (url === \"/bridge/health\" && req.method === \"GET\") {\n\t\t\tthis.handleHealth(res);\n\t\t} else {\n\t\t\tthis.sendJson(res, 404, { error: \"Not found\" });\n\t\t}\n\t}\n\n\t/**\n\t * Handle /bridge/push - receive observations and changes\n\t */\n\tprivate handlePush(req: IncomingMessage, res: ServerResponse): void {\n\t\tlet body = \"\";\n\n\t\treq.on(\"data\", (chunk) => {\n\t\t\tbody += chunk;\n\t\t\t// Limit body size to 1MB\n\t\t\tif (body.length > 1024 * 1024) {\n\t\t\t\tthis.sendJson(res, 413, { error: \"Payload too large\" });\n\t\t\t\treq.destroy();\n\t\t\t}\n\t\t});\n\n\t\treq.on(\"end\", () => {\n\t\t\ttry {\n\t\t\t\tconst payload = JSON.parse(body) as BridgePushPayload;\n\t\t\t\tthis.processPush(payload);\n\n\t\t\t\tthis.lastActivity = Date.now();\n\n\t\t\t\tthis.sendJson(res, 200, {\n\t\t\t\t\treceived: true,\n\t\t\t\t\tobservationsCount: payload.observations?.length ?? 0,\n\t\t\t\t\tchangesCount: payload.changes?.length ?? 0,\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst message = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\tthis.sendJson(res, 400, { error: `Invalid payload: ${message}` });\n\t\t\t}\n\t\t});\n\n\t\treq.on(\"error\", (err) => {\n\t\t\tconsole.error(\"[BridgeReceiver] Request error:\", err);\n\t\t\tthis.sendJson(res, 500, { error: \"Request error\" });\n\t\t});\n\t}\n\n\t/**\n\t * Process push payload\n\t */\n\tprivate processPush(payload: BridgePushPayload): void {\n\t\tconst workspaceRoot = payload.workspaceRoot ?? this.defaultWorkspaceRoot;\n\n\t\t// Process observations\n\t\tif (payload.observations && payload.observations.length > 0) {\n\t\t\tfor (const observation of payload.observations) {\n\t\t\t\tpushObservation(workspaceRoot, observation);\n\t\t\t\tthis.observationsReceived++;\n\t\t\t}\n\t\t}\n\n\t\t// Process changes (only if task is active, handled by recordFileChange)\n\t\tif (payload.changes && payload.changes.length > 0) {\n\t\t\tfor (const change of payload.changes) {\n\t\t\t\trecordFileChange(workspaceRoot, change);\n\t\t\t\tthis.changesReceived++;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Handle /bridge/status - return bridge status\n\t */\n\tprivate handleStatus(res: ServerResponse): void {\n\t\tconst status = this.getStatus();\n\t\tthis.sendJson(res, 200, status);\n\t}\n\n\t/**\n\t * Handle /bridge/health - health check endpoint\n\t */\n\tprivate handleHealth(res: ServerResponse): void {\n\t\tthis.sendJson(res, 200, {\n\t\t\thealthy: true,\n\t\t\ttimestamp: Date.now(),\n\t\t});\n\t}\n\n\t/**\n\t * Send JSON response\n\t */\n\tprivate sendJson(res: ServerResponse, status: number, data: unknown): void {\n\t\tres.writeHead(status, { \"Content-Type\": \"application/json\" });\n\t\tres.end(JSON.stringify(data));\n\t}\n}\n\n// =============================================================================\n// SINGLETON INSTANCE\n// =============================================================================\n\nlet bridgeReceiver: BridgeReceiver | null = null;\n\n/**\n * Get or create the bridge receiver singleton\n */\nexport function getBridgeReceiver(config?: BridgeReceiverConfig): BridgeReceiver {\n\tif (!bridgeReceiver) {\n\t\tbridgeReceiver = new BridgeReceiver(config);\n\t}\n\treturn bridgeReceiver;\n}\n\n/**\n * Start the bridge receiver (singleton)\n */\nexport async function startBridgeReceiver(config?: BridgeReceiverConfig): Promise<BridgeReceiver> {\n\tconst receiver = getBridgeReceiver(config);\n\tawait receiver.start();\n\treturn receiver;\n}\n\n/**\n * Stop the bridge receiver (singleton)\n */\nexport async function stopBridgeReceiver(): Promise<void> {\n\tif (bridgeReceiver) {\n\t\tawait bridgeReceiver.stop();\n\t\tbridgeReceiver = null;\n\t}\n}\n\n// =============================================================================\n// OBSERVATION HELPERS\n// =============================================================================\n\n/**\n * Create a risk observation\n */\nexport function createRiskObservation(file: string, reason: string): Observation {\n\treturn {\n\t\ttype: \"risk\",\n\t\tmessage: `High-risk file modified: ${file} (${reason})`,\n\t\ttimestamp: Date.now(),\n\t\tcontext: { file, riskLevel: \"high\" },\n\t};\n}\n\n/**\n * Create a pattern observation\n */\nexport function createPatternObservation(patternName: string, message: string, file?: string): Observation {\n\treturn {\n\t\ttype: \"pattern\",\n\t\tmessage,\n\t\ttimestamp: Date.now(),\n\t\tcontext: { patternName, file },\n\t};\n}\n\n/**\n * Create a warning observation\n */\nexport function createWarningObservation(message: string, context?: Record<string, unknown>): Observation {\n\treturn {\n\t\ttype: \"warning\",\n\t\tmessage,\n\t\ttimestamp: Date.now(),\n\t\tcontext,\n\t};\n}\n\n/**\n * Create a suggestion observation\n */\nexport function createSuggestionObservation(message: string, context?: Record<string, unknown>): Observation {\n\treturn {\n\t\ttype: \"suggestion\",\n\t\tmessage,\n\t\ttimestamp: Date.now(),\n\t\tcontext,\n\t};\n}\n\n/**\n * Create a progress observation\n */\nexport function createProgressObservation(message: string): Observation {\n\treturn {\n\t\ttype: \"progress\",\n\t\tmessage,\n\t\ttimestamp: Date.now(),\n\t};\n}\n","/**\n * MCP API Routes Registry\n *\n * Explicit route mapping to prevent path guessing errors.\n * All API endpoints are defined here with their HTTP methods.\n *\n * CONSOLIDATION NOTE (2026-01-08):\n * Snapshot routes now use oRPC endpoints at /api/snapshots/* instead of\n * the deprecated /v1/snapshots/* routes. The old Hono routes used an\n * in-memory Map that lost data on restart.\n *\n * @module client/routes\n */\n\nexport const MCP_ROUTES = {\n\t// Session lifecycle\n\t\"mcp.startSession\": { method: \"POST\", path: \"/v1/mcp/session/start\" },\n\t\"mcp.endSession\": { method: \"POST\", path: \"/v1/mcp/session/end\" },\n\t\"mcp.getSessionStats\": { method: \"GET\", path: \"/v1/mcp/session/stats\" },\n\n\t// Recommendations & Learning\n\t\"mcp.getRecommendations\": { method: \"POST\", path: \"/v1/mcp/recommendations\" },\n\t\"mcp.recordLearning\": { method: \"POST\", path: \"/v1/mcp/learning/record\" },\n\t\"mcp.recordActivity\": { method: \"POST\", path: \"/v1/mcp/activity/record\" },\n\n\t// Analysis (API-backed)\n\t\"mcp.analyzeRisk\": { method: \"POST\", path: \"/v1/analysis/risk\" },\n\t\"mcp.validatePackage\": { method: \"POST\", path: \"/v1/analysis/package\" },\n\n\t// Snapshots (Pro tier) - NOW USING oRPC ENDPOINTS\n\t// These route to the proper oRPC snapshotsRouter with database persistence\n\t\"mcp.createSnapshot\": { method: \"POST\", path: \"/api/snapshots/create\" },\n\t\"mcp.listSnapshots\": { method: \"GET\", path: \"/api/snapshots/list\" },\n\t\"mcp.restoreSnapshot\": { method: \"POST\", path: \"/api/snapshots/restore\" },\n\n\t// Tool execution (generic endpoint)\n\t\"mcp.execute\": { method: \"POST\", path: \"/v1/mcp/execute\" },\n} as const;\n\nexport type McpRouteKey = keyof typeof MCP_ROUTES;\n","/**\n * SnapBack API Client\n *\n * HTTP client for SnapBack backend API with:\n * - Explicit route registry (no path guessing)\n * - Circuit breaker for resilience\n * - Retry with exponential backoff\n * - Proper Content-Type handling\n *\n * @module client/api-client\n */\n\nimport ky, { HTTPError, type KyInstance } from \"ky\";\nimport CircuitBreaker from \"opossum\";\nimport { MCP_ROUTES, type McpRouteKey } from \"./routes.js\";\n\nexport interface ApiClientConfig {\n\tbaseUrl: string;\n\tapiKey: string;\n\ttimeout?: number;\n\tfetch?: typeof globalThis.fetch; // For testing\n}\n\nexport class SnapBackAPIClient {\n\tprivate client: KyInstance;\n\tprivate circuitBreaker: CircuitBreaker<[string, RequestInit?], unknown>;\n\tprivate timeoutMs: number;\n\n\tconstructor(config: ApiClientConfig) {\n\t\tthis.timeoutMs = config.timeout ?? 30_000;\n\n\t\tthis.client = ky.create({\n\t\t\tprefixUrl: config.baseUrl,\n\t\t\ttimeout: this.timeoutMs,\n\t\t\tretry: { limit: 0 }, // We handle retries ourselves\n\t\t\thooks: {\n\t\t\t\tbeforeRequest: [\n\t\t\t\t\t(request) => {\n\t\t\t\t\t\trequest.headers.set(\"Authorization\", `Bearer ${config.apiKey}`);\n\t\t\t\t\t\t// Always set Accept header\n\t\t\t\t\t\trequest.headers.set(\"Accept\", \"application/json\");\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\t...(config.fetch && { fetch: config.fetch }),\n\t\t});\n\n\t\t// Configure circuit breaker\n\t\tthis.circuitBreaker = new CircuitBreaker(\n\t\t\t(endpoint: string, options?: RequestInit) => this.doFetch(endpoint, options),\n\t\t\t{\n\t\t\t\ttimeout: this.timeoutMs,\n\t\t\t\terrorThresholdPercentage: 50,\n\t\t\t\tresetTimeout: 30_000,\n\t\t\t\tvolumeThreshold: 5,\n\t\t\t},\n\t\t);\n\n\t\t// Log state changes\n\t\tthis.circuitBreaker.on(\"open\", () => console.warn(\"[SnapBack API] Circuit breaker opened\"));\n\t\tthis.circuitBreaker.on(\"halfOpen\", () => console.warn(\"[SnapBack API] Circuit breaker half-open\"));\n\t\tthis.circuitBreaker.on(\"close\", () => console.info(\"[SnapBack API] Circuit breaker closed\"));\n\t}\n\n\t/**\n\t * Type-safe request using route registry\n\t */\n\tasync call<T = unknown>(route: McpRouteKey, params?: Record<string, unknown>): Promise<T> {\n\t\tconst { method, path } = MCP_ROUTES[route];\n\n\t\tconst options: RequestInit = { method };\n\n\t\tif (params && method !== \"GET\") {\n\t\t\toptions.body = JSON.stringify(params);\n\t\t\toptions.headers = {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t};\n\t\t}\n\n\t\treturn this.fetchWithRetry<T>(path, options);\n\t}\n\n\t/**\n\t * Legacy request method - maps old names to routes\n\t * @deprecated Use call() with route keys instead\n\t */\n\tasync request<T = unknown>(method: string, params?: Record<string, unknown>): Promise<T> {\n\t\t// Check if it's a known route\n\t\tif (method in MCP_ROUTES) {\n\t\t\treturn this.call<T>(method as McpRouteKey, params);\n\t\t}\n\n\t\t// Fallback to generic execute endpoint\n\t\treturn this.call<T>(\"mcp.execute\", { tool: method, args: params });\n\t}\n\n\tprivate async fetchWithRetry<T>(endpoint: string, options: RequestInit, maxAttempts = 3): Promise<T> {\n\t\tlet lastError: Error | undefined;\n\n\t\tfor (let attempt = 1; attempt <= maxAttempts; attempt++) {\n\t\t\ttry {\n\t\t\t\treturn (await this.circuitBreaker.fire(endpoint, options)) as T;\n\t\t\t} catch (error) {\n\t\t\t\tlastError = error instanceof Error ? error : new Error(String(error));\n\t\t\t\tif (attempt < maxAttempts) {\n\t\t\t\t\tawait this.delay(100 * 2 ** (attempt - 1));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthrow lastError ?? new Error(\"Request failed\");\n\t}\n\n\tprivate async doFetch(endpoint: string, options?: RequestInit): Promise<unknown> {\n\t\tconst url = endpoint.startsWith(\"/\") ? endpoint.slice(1) : endpoint;\n\t\ttry {\n\t\t\tconst response = await this.client(url, options);\n\t\t\treturn response.json();\n\t\t} catch (error) {\n\t\t\tif (error instanceof HTTPError) {\n\t\t\t\tconst status = error.response?.status || 500;\n\t\t\t\tconst statusText = error.response?.statusText || \"Unknown Error\";\n\t\t\t\tthrow new Error(`API error: ${status} ${statusText}`);\n\t\t\t}\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate delay(ms: number): Promise<void> {\n\t\treturn new Promise((resolve) => setTimeout(resolve, ms));\n\t}\n\n\t/**\n\t * Get circuit breaker state for monitoring\n\t */\n\tgetCircuitState(): \"closed\" | \"open\" | \"half-open\" {\n\t\tif (this.circuitBreaker.opened) {\n\t\t\treturn \"open\";\n\t\t}\n\t\tif (this.circuitBreaker.halfOpen) {\n\t\t\treturn \"half-open\";\n\t\t}\n\t\treturn \"closed\";\n\t}\n}\n","/**\n * SessionHealth Wrapper\n *\n * Provides session health context for MCP tool responses.\n * Wraps tool results with workspace vitals and session state.\n *\n * @module facades/session-health\n */\n\nimport { createStorage } from \"@snapback/engine\";\nimport { PRESSURE_THRESHOLDS, WorkspaceVitals } from \"@snapback/intelligence/vitals\";\nimport type { ToolContext, ToolResult } from \"../registry.js\";\nimport { getIntelligence } from \"./intelligence.js\";\n\n/**\n * Session health snapshot included in enhanced responses\n */\nexport interface SessionHealth {\n\tworkspaceId: string;\n\thealthScore: number;\n\ttrajectory: \"improving\" | \"stable\" | \"degrading\" | \"critical\";\n\tactiveWarnings: string[];\n\trecentViolations: number;\n\tlastSnapshot: {\n\t\tid: string;\n\t\tcreatedAt: string;\n\t\tminutesAgo: number;\n\t} | null;\n\tsuggestions: string[];\n}\n\n/**\n * Enhanced tool result with session health\n */\nexport interface EnhancedToolResult {\n\tdata: unknown;\n\tsession: SessionHealth;\n}\n\n/**\n * Get current session health for a workspace\n *\n * @param context - Tool context with workspace info\n * @returns Session health snapshot\n */\nexport async function getSessionHealth(context: ToolContext): Promise<SessionHealth> {\n\tconst intel = getIntelligence(context.workspaceRoot);\n\tconst violations = intel.getViolationsSummary();\n\n\t// Get vitals from WorkspaceVitals\n\tconst vitals = WorkspaceVitals.for(context.workspaceRoot);\n\tconst currentVitals = vitals.current();\n\tconst guidance = vitals.getAgentGuidance();\n\n\t// Get snapshot info\n\tconst storage = createStorage(context.workspaceRoot);\n\tconst snapshots = storage.listSnapshots();\n\tconst lastSnapshot = snapshots[0];\n\n\t// Calculate health score (inverse of pressure, clamped 0-100)\n\tconst healthScore = Math.max(0, Math.min(100, 100 - currentVitals.pressure.value));\n\n\t// Build warnings list\n\tconst activeWarnings: string[] = [];\n\n\tif (currentVitals.pressure.value >= PRESSURE_THRESHOLDS.high) {\n\t\tactiveWarnings.push(\"High pressure - consider creating a snapshot\");\n\t}\n\tif (currentVitals.temperature.level === \"hot\") {\n\t\tactiveWarnings.push(\"High AI change density detected\");\n\t}\n\tif (currentVitals.pressure.criticalFilesTouched.length > 0) {\n\t\tactiveWarnings.push(`Critical files touched: ${currentVitals.pressure.criticalFilesTouched.join(\", \")}`);\n\t}\n\tif (violations.total > 0) {\n\t\tactiveWarnings.push(`${violations.total} recent violation(s) recorded`);\n\t}\n\n\t// Build suggestions\n\tconst suggestions: string[] = [];\n\tif (guidance.suggestion) {\n\t\tsuggestions.push(guidance.suggestion);\n\t}\n\tif (violations.readyForPromotion.length > 0) {\n\t\tsuggestions.push(`${violations.readyForPromotion.length} violation(s) ready for pattern promotion`);\n\t}\n\n\treturn {\n\t\tworkspaceId: context.workspaceRoot,\n\t\thealthScore,\n\t\ttrajectory: currentVitals.trajectory as \"stable\" | \"critical\" | \"improving\" | \"degrading\",\n\t\tactiveWarnings,\n\t\trecentViolations: violations.total,\n\t\tlastSnapshot: lastSnapshot\n\t\t\t? {\n\t\t\t\t\tid: lastSnapshot.id,\n\t\t\t\t\tcreatedAt: new Date(lastSnapshot.createdAt).toISOString(),\n\t\t\t\t\tminutesAgo: Math.floor((Date.now() - lastSnapshot.createdAt) / 60000),\n\t\t\t\t}\n\t\t\t: null,\n\t\tsuggestions,\n\t};\n}\n\n/**\n * Wrap a tool result with session health\n *\n * @param data - The original tool result data\n * @param context - Tool context\n * @returns Enhanced result with session health\n */\nexport async function wrapWithSessionHealth<T>(data: T, context: ToolContext): Promise<EnhancedToolResult> {\n\tconst session = await getSessionHealth(context);\n\treturn { data, session };\n}\n\n/**\n * Create a ToolResult with embedded session health\n *\n * This is the primary function for handlers to use when they want\n * session-aware responses.\n *\n * @param data - The tool response data\n * @param context - Tool context\n * @returns ToolResult with session health embedded in JSON\n */\nexport async function sessionAwareResult<T>(data: T, context: ToolContext): Promise<ToolResult> {\n\tconst enhanced = await wrapWithSessionHealth(data, context);\n\treturn {\n\t\tcontent: [{ type: \"text\", text: JSON.stringify(enhanced, null, 2) }],\n\t\tisError: false,\n\t};\n}\n\n/**\n * Check if session health indicates risky state\n *\n * @param health - Session health snapshot\n * @returns true if workspace is in a risky state\n */\nexport function isRiskyState(health: SessionHealth): boolean {\n\treturn (\n\t\thealth.healthScore < 50 ||\n\t\thealth.trajectory === \"critical\" ||\n\t\thealth.trajectory === \"degrading\" ||\n\t\thealth.activeWarnings.length > 2\n\t);\n}\n\n/**\n * Recommended action with priority\n */\nexport interface RecommendedAction {\n\ttool: string;\n\treason: string;\n\tpriority: \"critical\" | \"high\" | \"medium\" | \"low\";\n}\n\n/**\n * Get recommended next actions based on session health\n *\n * Returns up to 3 prioritized recommendations from the full tool suite.\n * Balances snapshot creation with other valuable tools like:\n * - get_context: Task planning and pattern awareness\n * - check_patterns: Pre-commit validation\n * - get_learnings: Historical knowledge retrieval\n * - report_violation: Learning from mistakes\n * - validate: Code quality checks\n * - prepare_workspace: Pre-flight checks\n *\n * @param health - Session health snapshot\n * @param taskContext - Optional task description for context-aware recommendations\n * @returns Prioritized list of recommended tools (max 3)\n */\nexport function getRecommendedActions(\n\thealth: SessionHealth,\n\ttaskContext?: { isNewTask?: boolean; hasCodeChanges?: boolean; fileCount?: number },\n): RecommendedAction[] {\n\tconst recommendations: RecommendedAction[] = [];\n\n\t// CRITICAL: Only recommend snapshot for truly critical situations\n\tif (health.healthScore < 30 || health.trajectory === \"critical\") {\n\t\trecommendations.push({\n\t\t\ttool: \"snapshot_create\",\n\t\t\treason: \"Critical health score - create safety snapshot before proceeding\",\n\t\t\tpriority: \"critical\",\n\t\t});\n\t}\n\n\t// HIGH: Context and learning tools for informed decisions\n\tif (taskContext?.isNewTask) {\n\t\trecommendations.push({\n\t\t\ttool: \"get_context\",\n\t\t\treason: \"Starting new task - gather patterns, constraints, and relevant learnings\",\n\t\t\tpriority: \"high\",\n\t\t});\n\t}\n\n\tif (health.recentViolations > 3) {\n\t\trecommendations.push({\n\t\t\ttool: \"get_learnings\",\n\t\t\treason: `${health.recentViolations} recent violations - review past patterns to avoid repeating mistakes`,\n\t\t\tpriority: \"high\",\n\t\t});\n\t}\n\n\t// MEDIUM: Pre-commit validation and workspace prep\n\tif (taskContext?.hasCodeChanges) {\n\t\trecommendations.push({\n\t\t\ttool: \"check_patterns\",\n\t\t\treason: \"Code changes detected - validate against architectural patterns before commit\",\n\t\t\tpriority: \"medium\",\n\t\t});\n\t}\n\n\tif ((taskContext?.fileCount ?? 0) > 3 && !health.lastSnapshot) {\n\t\trecommendations.push({\n\t\t\ttool: \"prepare_workspace\",\n\t\t\treason: \"Multi-file changes planned with no snapshot - run pre-flight check\",\n\t\t\tpriority: \"medium\",\n\t\t});\n\t}\n\n\t// LOW: Maintenance and optimization\n\tif (health.lastSnapshot && health.lastSnapshot.minutesAgo > 120 && health.trajectory === \"degrading\") {\n\t\trecommendations.push({\n\t\t\ttool: \"snapshot_create\",\n\t\t\treason: \"Last snapshot over 2 hours ago and trajectory is degrading\",\n\t\t\tpriority: \"low\",\n\t\t});\n\t}\n\n\tif (health.suggestions.length > 0) {\n\t\trecommendations.push({\n\t\t\ttool: \"report_violation\",\n\t\t\treason: \"Active suggestions available - consider recording learnings for pattern promotion\",\n\t\t\tpriority: \"low\",\n\t\t});\n\t}\n\n\t// Sort by priority and return top 3\n\tconst priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\n\treturn recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]).slice(0, 3);\n}\n\n/**\n * Get recommended next action based on session health (legacy single-action API)\n *\n * @param health - Session health snapshot\n * @returns Recommended tool to call next (highest priority only)\n * @deprecated Use getRecommendedActions() for full tool suite recommendations\n */\nexport function getRecommendedAction(health: SessionHealth): { tool: string; reason: string } | null {\n\tconst actions = getRecommendedActions(health);\n\treturn actions.length > 0 ? { tool: actions[0].tool, reason: actions[0].reason } : null;\n}\n","/**\n * Tool Registry\n *\n * Central registry for MCP tool handlers.\n * Tool definitions are in tools/consolidated/registry.ts (7 consolidated tools)\n *\n * @module registry\n */\n\nimport type { Tool as MCPTool } from \"@modelcontextprotocol/sdk/types.js\";\nimport { CONSOLIDATED_TOOLS } from \"./tools/consolidated/registry.js\";\n\n/**\n * Extended tool definition with annotations\n */\nexport interface SnapBackTool extends MCPTool {\n\tannotations?: {\n\t\ttitle?: string;\n\t\treadOnlyHint?: boolean;\n\t\tdestructiveHint?: boolean;\n\t\tidempotentHint?: boolean;\n\t};\n\ttier?: \"free\" | \"pro\";\n\tdeprecated?: boolean;\n}\n\n/**\n * Tool handler function type\n */\nexport type ToolHandler = (args: Record<string, unknown>, context: ToolContext) => Promise<ToolResult>;\n\n/**\n * Context passed to tool handlers\n */\nexport interface ToolContext {\n\tworkspaceRoot: string;\n\ttier: \"free\" | \"pro\" | \"enterprise\";\n\tstorageMode?: \"local\" | \"remote\" | \"readonly\";\n\tuserId?: string;\n\tsessionId?: string;\n\t/** Authenticated user info (for Pioneer tracking) */\n\tuser?: {\n\t\tid: string;\n\t\temail: string;\n\t};\n\t/** Services for integration (Gap 1 & 2) */\n\tservices?: {\n\t\t/** Pioneer service for action recording */\n\t\tpioneer?: {\n\t\t\trecordAction(\n\t\t\t\tuserId: string,\n\t\t\t\taction: string,\n\t\t\t\tmetadata?: Record<string, unknown>,\n\t\t\t\tidempotencyKey?: string,\n\t\t\t): Promise<{ success: boolean; pointsAwarded: number }>;\n\t\t};\n\t\t/** Entitlements service for feature gating */\n\t\tentitlements?: {\n\t\t\thasFeature(userId: string, feature: string): Promise<boolean>;\n\t\t\tcheckTier(userId: string, requiredTier: string): Promise<boolean>;\n\t\t};\n\t};\n}\n\n/**\n * Standard tool result\n */\nexport interface ToolResult {\n\tcontent: Array<{ type: \"text\"; text: string }>;\n\tisError?: boolean;\n}\n\n/**\n * Handler registry - maps tool names to handler functions\n */\nconst handlerRegistry: Map<string, ToolHandler> = new Map();\n\n/**\n * Register a tool handler\n */\nexport function registerHandler(toolName: string, handler: ToolHandler): void {\n\thandlerRegistry.set(toolName, handler);\n}\n\n/**\n * Get handler for a tool\n */\nexport function getHandler(toolName: string): ToolHandler | undefined {\n\treturn handlerRegistry.get(toolName);\n}\n\n/**\n * Get all tools (consolidated)\n * @deprecated Use CONSOLIDATED_TOOLS directly from tools/consolidated/registry.js\n */\nexport function listFacadeTools(): SnapBackTool[] {\n\treturn CONSOLIDATED_TOOLS;\n}\n\n/**\n * Legacy FACADE_TOOLS export for backward compatibility\n * @deprecated Import CONSOLIDATED_TOOLS from tools/consolidated/registry.js instead\n */\nexport const FACADE_TOOLS = CONSOLIDATED_TOOLS;\n\n/**\n * Export for convenience\n */\nexport const tools = CONSOLIDATED_TOOLS;\n","/**\n * MCP Server Factory\n *\n * Creates and configures the MCP server with all tools registered.\n * This is the main entry point for server creation.\n *\n * @module server\n */\n\nimport { Server } from \"@modelcontextprotocol/sdk/server/index.js\";\nimport { CallToolRequestSchema, ListToolsRequestSchema } from \"@modelcontextprotocol/sdk/types.js\";\nimport type { SnapBackAPIClient } from \"./client/api-client.js\";\nimport { CommonErrors, createRequestContext, log, logError, logSuccess } from \"./errors.js\";\nimport { getIntelligence } from \"./facades/intelligence.js\";\nimport type { ToolRegistry } from \"./registry/ToolRegistry.js\";\nimport type { ToolContext as NewToolContext } from \"./registry/types.js\";\nimport { getHandler, registerHandler, type ToolContext, type ToolResult } from \"./registry.js\";\nimport { initializeHybridRetrieval } from \"./services/hybrid-retrieval-service.js\";\nimport { McpEventTracker } from \"./telemetry/mcp-event-tracker.js\";\nimport {\n\tCONSOLIDATED_HANDLERS,\n\tCONSOLIDATED_TOOLS,\n\tgetMigrationGuidance,\n\tisConsolidatedTool,\n} from \"./tools/consolidated/registry.js\";\nimport { getToolSchema, validateInput } from \"./validation.js\";\n\n/**\n * SessionHealth summary added to all tool responses\n * Provides workspace vitals visibility to AI agents\n */\ninterface SessionHealth {\n\tpulse: string; // \"resting\" | \"elevated\" | \"racing\" | \"critical\"\n\tpressure: number; // 0-100\n\ttrajectory: string; // \"stable\" | \"escalating\" | \"critical\" | \"recovering\"\n\tsnapshotRecommended: boolean;\n\thint?: string;\n}\n\n/**\n * Enhance a tool result with SessionHealth data\n * Appends vitals information to the response for AI agent visibility\n */\nfunction enhanceWithSessionHealth(result: ToolResult, workspaceRoot: string): ToolResult {\n\t// Skip enhancement for error results or meta queries\n\tif (result.isError) {\n\t\treturn result;\n\t}\n\n\ttry {\n\t\tconst intel = getIntelligence(workspaceRoot);\n\t\tconst vitals = intel.getVitalsSnapshot(workspaceRoot);\n\n\t\tif (!vitals) {\n\t\t\treturn result;\n\t\t}\n\n\t\t// Build compact session health summary\n\t\tconst sessionHealth: SessionHealth = {\n\t\t\tpulse: vitals.pulse.level,\n\t\t\tpressure: vitals.pressure.value,\n\t\t\ttrajectory: vitals.trajectory,\n\t\t\tsnapshotRecommended: vitals.pressure.value > 60 || vitals.trajectory === \"escalating\",\n\t\t};\n\n\t\t// Add hint for elevated states\n\t\tif (vitals.trajectory === \"critical\" || vitals.pressure.value > 80) {\n\t\t\tsessionHealth.hint = \"Consider creating a snapshot before continuing\";\n\t\t} else if (vitals.pulse.level === \"racing\") {\n\t\t\tsessionHealth.hint = \"High change velocity detected - take care with modifications\";\n\t\t}\n\n\t\t// Parse existing result and add _sessionHealth\n\t\tconst originalText = result.content[0]?.text;\n\t\tif (originalText) {\n\t\t\ttry {\n\t\t\t\tconst parsed = JSON.parse(originalText);\n\t\t\t\tconst enhanced = {\n\t\t\t\t\t...parsed,\n\t\t\t\t\t_sessionHealth: sessionHealth,\n\t\t\t\t};\n\t\t\t\treturn {\n\t\t\t\t\tcontent: [{ type: \"text\", text: JSON.stringify(enhanced, null, 2) }],\n\t\t\t\t\tisError: false,\n\t\t\t\t};\n\t\t\t} catch {\n\t\t\t\t// If not JSON, append as separate block\n\t\t\t\treturn {\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t...result.content,\n\t\t\t\t\t\t{ type: \"text\", text: `\\n_sessionHealth: ${JSON.stringify(sessionHealth)}` },\n\t\t\t\t\t],\n\t\t\t\t\tisError: false,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t} catch {\n\t\t// If vitals retrieval fails, return original result\n\t\treturn result;\n\t}\n}\n\n/**\n * Options for creating an MCP server\n */\nexport interface McpServerOptions {\n\t/** Absolute path to workspace root */\n\tworkspaceRoot: string;\n\t/** User tier for gating features */\n\ttier: \"free\" | \"pro\" | \"enterprise\";\n\t/**\n\t * Storage mode - determines filesystem write permissions\n\t *\n\t * - \"local\": Full read/write access (for local CLI usage)\n\t * - \"remote\": Read-only access (for remote/hosted MCP servers)\n\t * - \"readonly\": Read-only access (default, prevents filesystem writes)\n\t *\n\t * Remote/hosted MCP servers should NEVER attempt filesystem writes.\n\t * Defaults to \"readonly\" to prevent permission errors.\n\t */\n\tstorageMode?: \"local\" | \"remote\" | \"readonly\";\n\t/** Optional API client for backend operations */\n\tapiClient?: SnapBackAPIClient;\n\t/** Optional auth context */\n\tauth?: {\n\t\tapiKey?: string;\n\t\tuserId?: string;\n\t};\n\t/** Optional telemetry sink */\n\ttelemetry?: {\n\t\tlog: (event: string, data: Record<string, unknown>) => void;\n\t};\n}\n\n/**\n * Create an MCP server with all tools registered\n *\n * @param options - Server configuration options\n * @returns Configured MCP Server instance\n *\n * @example\n * ```typescript\n * const server = createMcpServer({\n *   workspaceRoot: \"/path/to/workspace\",\n *   tier: \"pro\",\n * });\n * ```\n */\nexport function createMcpServer(options: McpServerOptions): Server {\n\tconst { workspaceRoot, tier } = options;\n\n\tconst server = new Server(\n\t\t{\n\t\t\tname: \"snapback-mcp\",\n\t\t\tversion: \"1.0.0\",\n\t\t},\n\t\t{\n\t\t\tcapabilities: {\n\t\t\t\ttools: {},\n\t\t\t\tresources: {},\n\t\t\t\t// Advertise server capabilities to LLM\n\t\t\t\texperimental: {\n\t\t\t\t\tserverInfo: {\n\t\t\t\t\t\tstorageMode: options.storageMode || \"readonly\",\n\t\t\t\t\t\twriteCapable: (options.storageMode || \"readonly\") === \"local\",\n\t\t\t\t\t\tcliAvailable: true,\n\t\t\t\t\t\tcliSetupCommand: \"npm install -g @snapback/cli && snapback tools configure\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t);\n\n\t// Create handler context\n\tconst context: ToolContext = {\n\t\tworkspaceRoot,\n\t\ttier,\n\t\tstorageMode: options.storageMode || \"readonly\",\n\t\tuserId: options.auth?.userId,\n\t};\n\n\t// Initialize MCP event tracker for telemetry (if telemetry sink provided)\n\tconst eventTracker = new McpEventTracker(options.telemetry ?? null);\n\n\t// Register consolidated handlers (7 tools)\n\tfor (const [name, handler] of Object.entries(CONSOLIDATED_HANDLERS)) {\n\t\tregisterHandler(name, handler);\n\t}\n\tconsole.error(`[SnapBack MCP] Server created for workspace: ${workspaceRoot}`);\n\tconsole.error(`[SnapBack MCP] Tier: ${tier}`);\n\tconsole.error(`[SnapBack MCP] ${CONSOLIDATED_TOOLS.length} consolidated tools registered`);\n\n\t// Initialize hybrid retrieval (non-blocking background task)\n\t// Preloads embeddings model and indexes existing learnings for faster first query\n\tinitializeHybridRetrieval(workspaceRoot).catch((error) => {\n\t\tconsole.error(\"[SnapBack MCP] Hybrid retrieval initialization failed:\", error);\n\t});\n\n\t// Handle ListTools - return consolidated tools\n\tserver.setRequestHandler(ListToolsRequestSchema, async () => {\n\t\t// Filter by tier if needed\n\t\tconst availableTools = CONSOLIDATED_TOOLS.filter((tool) => {\n\t\t\tif (tool.tier === \"pro\" && tier === \"free\") {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t});\n\n\t\treturn {\n\t\t\ttools: availableTools.map((tool) => ({\n\t\t\t\tname: tool.name,\n\t\t\t\tdescription: tool.description,\n\t\t\t\tinputSchema: tool.inputSchema,\n\t\t\t\tannotations: tool.annotations,\n\t\t\t})),\n\t\t};\n\t});\n\n\t// Handle CallTool - route to appropriate handler\n\tserver.setRequestHandler(CallToolRequestSchema, async (request) => {\n\t\tconst { name, arguments: args } = request.params;\n\t\tconst startTime = Date.now();\n\n\t\t// P1-003: Create request context for structured logging\n\t\tconst reqCtx = createRequestContext(name, { userId: context.userId, tier: context.tier });\n\t\tlog(\"info\", reqCtx, \"Tool call started\", { args: Object.keys(args || {}) });\n\n\t\t// Check for legacy tool usage and provide migration guidance\n\t\tif (!isConsolidatedTool(name)) {\n\t\t\tconst guidance = getMigrationGuidance(name);\n\t\t\tif (guidance) {\n\t\t\t\tlog(\"warn\", reqCtx, \"Legacy tool called\", { guidance });\n\t\t\t\treturn {\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\t\t\terror: \"E601_DEPRECATED_TOOL\",\n\t\t\t\t\t\t\t\tmessage: `Tool '${name}' is deprecated. ${guidance}`,\n\t\t\t\t\t\t\t\tmigration: guidance,\n\t\t\t\t\t\t\t\tavailableTools: CONSOLIDATED_TOOLS.map((t) => t.name),\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tisError: true,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// P0-002: Tier gating BEFORE handler execution\n\t\tconst toolDef = CONSOLIDATED_TOOLS.find((t) => t.name === name);\n\t\tif (toolDef?.tier === \"pro\" && tier === \"free\") {\n\t\t\tlogError(reqCtx, \"E301_TIER_GATE_BLOCKED\", \"Tool requires pro tier\");\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\ttext: JSON.stringify(CommonErrors.tierGateBlocked(name, \"pro\", tier)),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\n\t\t// P0-003: Input validation with Zod schemas\n\t\tconst schema = getToolSchema(name);\n\t\tif (schema) {\n\t\t\tconst validation = validateInput(schema, args || {});\n\t\t\tif (!validation.valid) {\n\t\t\t\tlogError(reqCtx, \"E104_VALIDATION_FAILED\", validation.error);\n\n\t\t\t\t// Generate LLM-friendly guidance based on tool and error\n\t\t\t\tlet guidance = \"\";\n\t\t\t\tif (name === \"snap\" && validation.error.includes(\"mode\")) {\n\t\t\t\t\tguidance =\n\t\t\t\t\t\t\"\\n\\n TIP: The 'snap' tool accepts EITHER:\\n\" +\n\t\t\t\t\t\t'  - mode: \"start\" | \"check\" | \"context\" (full-word, recommended)\\n' +\n\t\t\t\t\t\t'  - m: \"s\" | \"c\" | \"x\" (legacy single-letter)\\n\\n' +\n\t\t\t\t\t\t'Example: snap({ mode: \"start\", task: \"fix bug\" })';\n\t\t\t\t} else if (name === \"snap_learn\" && validation.error.includes(\"trigger\")) {\n\t\t\t\t\tguidance =\n\t\t\t\t\t\t\"\\n\\n TIP: The 'snap_learn' tool requires BOTH:\\n\" +\n\t\t\t\t\t\t'  - trigger: \"when X happens\" (or legacy: t)\\n' +\n\t\t\t\t\t\t'  - action: \"do Y\" (or legacy: a)\\n\\n' +\n\t\t\t\t\t\t'Example: snap_learn({ trigger: \"auth token refresh\", action: \"check expiry before API call\" })';\n\t\t\t\t} else if (name === \"snap_violation\" && validation.error.includes(\"description\")) {\n\t\t\t\t\tguidance =\n\t\t\t\t\t\t\"\\n\\n TIP: The 'snap_violation' tool requires:\\n\" +\n\t\t\t\t\t\t\"  - type: \\\"violation_key\\\" (e.g., 'silent_catch')\\n\" +\n\t\t\t\t\t\t'  - file: \"path/to/file\"\\n' +\n\t\t\t\t\t\t'  - description: \"what went wrong\" (or legacy: what)\\n' +\n\t\t\t\t\t\t'  - prevention: \"how to avoid\" (or legacy: prevent)\\n\\n' +\n\t\t\t\t\t\t'Example: snap_violation({ type: \"silent_catch\", file: \"auth.ts\", description: \"Caught error without logging\", prevention: \"Always log in catch blocks\" })';\n\t\t\t\t} else if (name === \"check\" && validation.error.includes(\"mode\")) {\n\t\t\t\t\tguidance =\n\t\t\t\t\t\t\"\\n\\n TIP: The 'check' tool accepts EITHER:\\n\" +\n\t\t\t\t\t\t'  - mode: \"quick\" | \"full\" | \"patterns\" | \"build\" | \"impact\" | \"circular\" | \"docs\" | \"learnings\" | \"architecture\" (recommended)\\n' +\n\t\t\t\t\t\t'  - m: \"q\" | \"f\" | \"p\" | \"b\" | \"i\" | \"c\" | \"d\" | \"l\" | \"a\" (legacy)\\n\\n' +\n\t\t\t\t\t\t'Example: check({ mode: \"quick\", files: [\"src/auth.ts\"] })';\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\t\t\terror: \"E104_VALIDATION_FAILED\",\n\t\t\t\t\t\t\t\tmessage: validation.error + guidance,\n\t\t\t\t\t\t\t\ttool: name,\n\t\t\t\t\t\t\t\tissues: validation.issues,\n\t\t\t\t\t\t\t\thint: \"Check the tool's inputSchema for required parameters and accepted values\",\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tisError: true,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Get handler\n\t\tconst handler = getHandler(name);\n\t\tif (!handler) {\n\t\t\tlogError(reqCtx, \"E501_UNKNOWN_TOOL\", `Unknown tool: ${name}`);\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\t\terror: \"E501_UNKNOWN_TOOL\",\n\t\t\t\t\t\t\tmessage: `Unknown tool: ${name}`,\n\t\t\t\t\t\t\tsuggestion: \"Use meta to list available tools\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\t// Call handler with args and context\n\t\t\tconst result = await handler(args || {}, context);\n\t\t\tlogSuccess(reqCtx, \"Tool call completed\", { isError: result.isError });\n\n\t\t\t// Track mcp_tool_called event (fire-and-forget)\n\t\t\teventTracker.trackToolCalled({\n\t\t\t\ttool_name: name,\n\t\t\t\tclient_type: \"cli\", // MCP server typically invoked via CLI/stdio\n\t\t\t\tparameters: args || {},\n\t\t\t\texecution_time_ms: Date.now() - startTime,\n\t\t\t\twas_successful: !result.isError,\n\t\t\t});\n\n\t\t\t// Enhance successful responses with SessionHealth (skip for 'meta' tool)\n\t\t\tconst enhanced = name === \"meta\" ? result : enhanceWithSessionHealth(result, workspaceRoot);\n\n\t\t\treturn {\n\t\t\t\tcontent: enhanced.content.map((c) => ({ type: \"text\" as const, text: c.text })),\n\t\t\t\tisError: enhanced.isError,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\tlogError(reqCtx, \"E502_HANDLER_ERROR\", message);\n\n\t\t\t// Track failed tool call\n\t\t\teventTracker.trackToolCalled({\n\t\t\t\ttool_name: name,\n\t\t\t\tclient_type: \"cli\",\n\t\t\t\tparameters: args || {},\n\t\t\t\texecution_time_ms: Date.now() - startTime,\n\t\t\t\twas_successful: false,\n\t\t\t\terror_code: error instanceof Error ? error.name : \"UNKNOWN_ERROR\",\n\t\t\t});\n\n\t\t\t// P0-004: Enhanced error handling with remediation guidance\n\t\t\t// Detect EACCES permission errors and provide context-aware remediation\n\t\t\tif (message.includes(\"EACCES\") && message.includes(\"permission denied\")) {\n\t\t\t\t// Extract path and operation from error message\n\t\t\t\tconst pathMatch = message.match(/'([^']+)'/);\n\t\t\t\tconst operationMatch = message.match(/permission denied,\\s*([a-z]+)\\s/);\n\n\t\t\t\tconst path = pathMatch ? pathMatch[1] : \"unknown path\";\n\t\t\t\tconst operation = operationMatch ? operationMatch[1] : \"write\";\n\n\t\t\t\treturn {\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\t\ttext: JSON.stringify(CommonErrors.permissionDenied(path, operation)),\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tisError: true,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// Default error response for other errors\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\ttext: JSON.stringify(CommonErrors.handlerError(name, message)),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\t});\n\n\treturn server;\n}\n\n// =============================================================================\n// Server with ToolRegistry (ADR-003)\n// =============================================================================\n\n/**\n * Options for creating an MCP server with ToolRegistry\n * Extends McpServerOptions with optional registry for dependency injection\n */\nexport interface McpServerWithRegistryOptions extends McpServerOptions {\n\t/** Optional ToolRegistry instance for dependency injection */\n\tregistry?: ToolRegistry;\n}\n\n/**\n * Create an MCP server with optional ToolRegistry support (ADR-003)\n *\n * This is a transitional factory that supports both:\n * - Legacy mode: Uses the old handler registry (when registry is not provided)\n * - New mode: Uses ToolRegistry with capability-based authorization\n *\n * @param options - Server configuration options with optional registry\n * @returns Configured MCP Server instance\n *\n * @example Using new ToolRegistry pattern:\n * ```typescript\n * const registry = createToolRegistry();\n * // Register adapted legacy tools\n * const adaptedTools = adaptLegacyTools(toolPairs);\n * adaptedTools.forEach(tool => registry.register(tool));\n *\n * const server = createMcpServerWithRegistry({\n *   workspaceRoot: \"/path/to/workspace\",\n *   tier: \"pro\",\n *   registry,\n * });\n * ```\n */\nexport function createMcpServerWithRegistry(options: McpServerWithRegistryOptions): Server {\n\tconst { registry } = options;\n\n\t// If no registry provided, use legacy path\n\tif (!registry) {\n\t\treturn createMcpServer(options);\n\t}\n\n\t// Use new ToolRegistry-based server\n\treturn createRegistryBasedServer(options, registry);\n}\n\n/**\n * Internal: Create a server using the new ToolRegistry pattern\n */\nfunction createRegistryBasedServer(options: McpServerOptions, registry: ToolRegistry): Server {\n\tconst { workspaceRoot, tier } = options;\n\n\tconst server = new Server(\n\t\t{\n\t\t\tname: \"snapback-mcp\",\n\t\t\tversion: \"1.0.0\",\n\t\t},\n\t\t{\n\t\t\tcapabilities: {\n\t\t\t\ttools: {},\n\t\t\t\tresources: {},\n\t\t\t\texperimental: {\n\t\t\t\t\tserverInfo: {\n\t\t\t\t\t\tstorageMode: options.storageMode || \"readonly\",\n\t\t\t\t\t\twriteCapable: (options.storageMode || \"readonly\") === \"local\",\n\t\t\t\t\t\tcliAvailable: true,\n\t\t\t\t\t\tcliSetupCommand: \"npm install -g @snapback/cli && snapback tools configure\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t);\n\n\t// Create new-style context (adapts to legacy when executing)\n\tconst baseContext: Partial<NewToolContext> = {\n\t\tworkspace: {\n\t\t\tpath: workspaceRoot,\n\t\t\ttier,\n\t\t},\n\t\tuser: options.auth?.userId ? { id: options.auth.userId, email: \"\" } : undefined,\n\t\trequest: {\n\t\t\tid: \"unknown\",\n\t\t\ttimestamp: new Date(),\n\t\t\tsource: \"unknown\",\n\t\t},\n\t};\n\n\t// Initialize MCP event tracker\n\tconst eventTracker = new McpEventTracker(options.telemetry ?? null);\n\n\tconsole.error(`[SnapBack MCP] Registry-based server created for: ${workspaceRoot}`);\n\tconsole.error(`[SnapBack MCP] Tier: ${tier}`);\n\tconsole.error(`[SnapBack MCP] ${registry.getToolNames().length} tools in registry`);\n\n\t// Handle ListTools - use registry.list()\n\tserver.setRequestHandler(ListToolsRequestSchema, async () => {\n\t\tconst tools = registry.list({ tier });\n\n\t\treturn {\n\t\t\ttools: tools.map((tool) => ({\n\t\t\t\tname: tool.name,\n\t\t\t\tdescription: tool.description,\n\t\t\t\tinputSchema: tool.inputSchema,\n\t\t\t\tannotations: tool.annotations,\n\t\t\t})),\n\t\t};\n\t});\n\n\t// Handle CallTool - use registry.execute()\n\tserver.setRequestHandler(CallToolRequestSchema, async (request) => {\n\t\tconst { name, arguments: args } = request.params;\n\t\tconst startTime = Date.now();\n\n\t\t// Build execution context with capabilities\n\t\tconst { CapabilityManager } = await import(\"./registry/CapabilityManager.js\");\n\t\tconst capManager = new CapabilityManager();\n\t\tconst activeCapabilities = capManager.getActiveCapabilities({ path: workspaceRoot, tier });\n\n\t\tconst context: NewToolContext = {\n\t\t\t...baseContext,\n\t\t\tactiveCapabilities,\n\t\t\t// Placeholder services - will be injected by RuntimeRouter in Phase 2\n\t\t\tservices: {} as NewToolContext[\"services\"],\n\t\t\trequest: {\n\t\t\t\tid: `req-${Date.now()}`,\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tsource: \"unknown\",\n\t\t\t},\n\t\t} as NewToolContext;\n\n\t\t// Execute via registry\n\t\tconst result = await registry.execute(name, args || {}, context);\n\n\t\t// Track telemetry\n\t\teventTracker.trackToolCalled({\n\t\t\ttool_name: name,\n\t\t\tclient_type: \"cli\",\n\t\t\tparameters: args || {},\n\t\t\texecution_time_ms: Date.now() - startTime,\n\t\t\twas_successful: result.success,\n\t\t\terror_code: result.error,\n\t\t});\n\n\t\t// Convert registry result to MCP format\n\t\tif (!result.success) {\n\t\t\treturn {\n\t\t\t\tcontent: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\t\ttext: JSON.stringify({\n\t\t\t\t\t\t\terror: result.error,\n\t\t\t\t\t\t\ttool: name,\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tisError: true,\n\t\t\t};\n\t\t}\n\n\t\t// Handle ToolResult format (legacy handlers return this)\n\t\tconst toolResult = result.result as ToolResult | undefined;\n\t\tif (toolResult?.content) {\n\t\t\treturn {\n\t\t\t\tcontent: toolResult.content.map((c) => ({ type: \"text\" as const, text: c.text })),\n\t\t\t\tisError: toolResult.isError,\n\t\t\t};\n\t\t}\n\n\t\t// Handle generic result\n\t\treturn {\n\t\t\tcontent: [\n\t\t\t\t{\n\t\t\t\t\ttype: \"text\" as const,\n\t\t\t\t\ttext: JSON.stringify(result.result),\n\t\t\t\t},\n\t\t\t],\n\t\t\tisError: false,\n\t\t};\n\t});\n\n\treturn server;\n}\n","/**\n * MCP Event Tracker\n *\n * Tracks MCP tool usage telemetry for product analytics.\n * Events: mcp_tool_called, mcp_context_provided, mcp_agent_self_check\n *\n * Schema Reference: packages/infrastructure/src/metrics/core/events.ts\n * Pattern Reference: apps/vscode/src/telemetry/core-event-tracker.ts\n *\n * Design Decisions:\n * - Opt-in via McpServerOptions.telemetry\n * - Fire-and-forget pattern to avoid blocking tool execution\n * - Parameter sanitization to protect sensitive data\n * - Client type detection for cross-platform analytics\n *\n * @package packages/mcp\n */\n\n/**\n * Properties for mcp_tool_called event\n */\nexport interface McpToolCalledProps {\n\t/** Name of the tool called */\n\ttool_name: string;\n\t/** Client type (vscode, jetbrains, cli, api) */\n\tclient_type: \"vscode\" | \"jetbrains\" | \"cli\" | \"api\";\n\t/** Sanitized parameters (no secrets, paths redacted) */\n\tparameters: Record<string, unknown>;\n\t/** Execution time in milliseconds */\n\texecution_time_ms: number;\n\t/** Whether the tool call succeeded */\n\twas_successful: boolean;\n\t/** Error code if failed */\n\terror_code?: string;\n}\n\n/**\n * Properties for mcp_context_provided event\n */\nexport interface McpContextProvidedProps {\n\t/** Type of context provided (snapshot, session, file, pattern) */\n\tcontext_type: string;\n\t/** Size in bytes (approximate) */\n\tsize_bytes: number;\n\t/** Time to gather context in milliseconds */\n\tgather_time_ms: number;\n\t/** Number of items in context */\n\titem_count: number;\n}\n\n/**\n * Properties for mcp_agent_self_check event\n */\nexport interface McpAgentSelfCheckProps {\n\t/** Check type (patterns, violations, coverage) */\n\tcheck_type: string;\n\t/** Number of issues found */\n\tissues_found: number;\n\t/** Highest severity of issues */\n\thighest_severity: \"info\" | \"low\" | \"medium\" | \"high\" | \"critical\";\n\t/** Time to run check in milliseconds */\n\tcheck_time_ms: number;\n}\n\n/**\n * Telemetry sink interface\n */\nexport interface TelemetrySink {\n\tlog: (event: string, data: Record<string, unknown>) => void;\n}\n\n/**\n * Event names for MCP telemetry\n */\nexport const MCP_EVENTS = {\n\tTOOL_CALLED: \"mcp_tool_called\",\n\tCONTEXT_PROVIDED: \"mcp_context_provided\",\n\tAGENT_SELF_CHECK: \"mcp_agent_self_check\",\n} as const;\n\n/**\n * Parameter keys to redact for privacy\n */\nconst SENSITIVE_KEYS = new Set([\n\t\"path\",\n\t\"filePath\",\n\t\"file_path\",\n\t\"code\",\n\t\"content\",\n\t\"secret\",\n\t\"token\",\n\t\"password\",\n\t\"key\",\n\t\"apiKey\",\n\t\"api_key\",\n]);\n\n/**\n * Sanitize parameters for telemetry\n * Removes or redacts sensitive information\n */\nfunction sanitizeParams(params: Record<string, unknown>): Record<string, unknown> {\n\tconst sanitized: Record<string, unknown> = {};\n\n\tfor (const [key, value] of Object.entries(params)) {\n\t\tif (SENSITIVE_KEYS.has(key.toLowerCase())) {\n\t\t\t// Redact sensitive values but keep key for analytics\n\t\t\tsanitized[key] = \"[redacted]\";\n\t\t} else if (typeof value === \"string\" && value.length > 100) {\n\t\t\t// Truncate long strings\n\t\t\tsanitized[key] = `${value.slice(0, 50)}...[truncated]`;\n\t\t} else if (Array.isArray(value)) {\n\t\t\t// For arrays, just record count\n\t\t\tsanitized[key] = `[array:${value.length}]`;\n\t\t} else if (typeof value === \"object\" && value !== null) {\n\t\t\t// For nested objects, record structure\n\t\t\tsanitized[key] = `[object:${Object.keys(value).length} keys]`;\n\t\t} else {\n\t\t\tsanitized[key] = value;\n\t\t}\n\t}\n\n\treturn sanitized;\n}\n\n/**\n * MCP Event Tracker class\n * Handles MCP-specific telemetry events\n */\nexport class McpEventTracker {\n\tconstructor(private telemetry: TelemetrySink | null) {}\n\n\t/**\n\t * Track tool call event\n\t *\n\t * Called after each tool execution in server.ts\n\t *\n\t * @param props - Tool call properties\n\t */\n\ttrackToolCalled(props: McpToolCalledProps): void {\n\t\tif (!this.telemetry) return;\n\n\t\tthis.telemetry.log(MCP_EVENTS.TOOL_CALLED, {\n\t\t\t...props,\n\t\t\tparameters: sanitizeParams(props.parameters),\n\t\t\ttimestamp: Date.now(),\n\t\t});\n\t}\n\n\t/**\n\t * Track context provided event\n\t *\n\t * Called when context is gathered for AI agents\n\t *\n\t * @param props - Context provided properties\n\t */\n\ttrackContextProvided(props: McpContextProvidedProps): void {\n\t\tif (!this.telemetry) return;\n\n\t\tthis.telemetry.log(MCP_EVENTS.CONTEXT_PROVIDED, {\n\t\t\t...props,\n\t\t\ttimestamp: Date.now(),\n\t\t});\n\t}\n\n\t/**\n\t * Track agent self-check event\n\t *\n\t * Called when agent runs validation checks\n\t *\n\t * @param props - Self-check properties\n\t */\n\ttrackAgentSelfCheck(props: McpAgentSelfCheckProps): void {\n\t\tif (!this.telemetry) return;\n\n\t\tthis.telemetry.log(MCP_EVENTS.AGENT_SELF_CHECK, {\n\t\t\t...props,\n\t\t\ttimestamp: Date.now(),\n\t\t});\n\t}\n}\n\n// Singleton instance\nlet mcpEventTrackerInstance: McpEventTracker | null = null;\n\n/**\n * Initialize the MCP event tracker\n *\n * @param telemetry - Telemetry sink for sending events\n */\nexport function initializeMcpEventTracker(telemetry: TelemetrySink | null): void {\n\tmcpEventTrackerInstance = new McpEventTracker(telemetry);\n}\n\n/**\n * Get the MCP event tracker singleton\n *\n * @returns McpEventTracker instance or null if not initialized\n */\nexport function getMcpEventTracker(): McpEventTracker | null {\n\treturn mcpEventTrackerInstance;\n}\n\n/**\n * Create a tool call tracking helper for use in server.ts\n *\n * Returns a function that wraps tool execution with timing and tracking\n */\nexport function createToolCallTracker(telemetry: TelemetrySink | null, clientType: McpToolCalledProps[\"client_type\"]) {\n\tconst tracker = new McpEventTracker(telemetry);\n\n\treturn async function trackToolCall<T>(\n\t\ttoolName: string,\n\t\tparams: Record<string, unknown>,\n\t\texecutor: () => Promise<T>,\n\t): Promise<T> {\n\t\tconst startTime = Date.now();\n\t\tlet wasSuccessful = true;\n\t\tlet errorCode: string | undefined;\n\n\t\ttry {\n\t\t\tconst result = await executor();\n\t\t\treturn result;\n\t\t} catch (error) {\n\t\t\twasSuccessful = false;\n\t\t\terrorCode = error instanceof Error ? error.name : \"UNKNOWN_ERROR\";\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\ttracker.trackToolCalled({\n\t\t\t\ttool_name: toolName,\n\t\t\t\tclient_type: clientType,\n\t\t\t\tparameters: params,\n\t\t\t\texecution_time_ms: Date.now() - startTime,\n\t\t\t\twas_successful: wasSuccessful,\n\t\t\t\t...(errorCode && { error_code: errorCode }),\n\t\t\t});\n\t\t}\n\t};\n}\n","/**\n * Registry Adapter (ADR-003 Migration)\n *\n * Bridges the OLD registry types (SnapBackTool, ToolHandler, ToolContext)\n * to the NEW registry types (ToolDefinition, ToolHandler, ToolContext).\n *\n * This allows gradual migration without breaking existing code.\n *\n * @module registry/adapter\n */\n\nimport type {\n\tToolContext as LegacyToolContext,\n\tToolHandler as LegacyToolHandler,\n\tSnapBackTool,\n\tToolResult,\n} from \"../registry.js\";\n\nimport {\n\ttype ToolContext as NewToolContext,\n\ttype ToolHandler as NewToolHandler,\n\tToolCapability,\n\ttype ToolDefinition,\n\ttype ToolTier,\n} from \"./types.js\";\n\n// =============================================================================\n// CAPABILITY INFERENCE\n// =============================================================================\n\n/**\n * Capability mapping for each consolidated tool\n */\nconst TOOL_CAPABILITY_MAP: Record<string, ToolCapability[]> = {\n\t// snap: Start task, create snapshot, read learnings\n\tsnap: [ToolCapability.SNAPSHOT_WRITE, ToolCapability.SESSION_WRITE, ToolCapability.LEARNING_READ],\n\t// snap_end: End session, write telemetry\n\tsnap_end: [ToolCapability.SESSION_WRITE, ToolCapability.TELEMETRY_WRITE],\n\t// snap_learn: Create learnings\n\tsnap_learn: [ToolCapability.LEARNING_WRITE],\n\t// snap_violation: Record violations (also a form of learning)\n\tsnap_violation: [ToolCapability.LEARNING_WRITE],\n\t// snap_fix: Apply fixes, may create snapshots\n\tsnap_fix: [ToolCapability.SNAPSHOT_WRITE],\n\t// snap_help: Read-only, informational - no special capabilities\n\tsnap_help: [],\n\t// check: Validation, read operations\n\tcheck: [ToolCapability.VALIDATE_READ],\n};\n\n/**\n * Infer capabilities from tool name\n *\n * @param toolName - Name of the tool\n * @returns Array of capabilities the tool requires\n */\nexport function inferCapabilities(toolName: string): ToolCapability[] {\n\treturn TOOL_CAPABILITY_MAP[toolName] ?? [];\n}\n\n// =============================================================================\n// CONTEXT ADAPTERS\n// =============================================================================\n\n/**\n * Create a legacy context from a new context\n *\n * Extracts fields from NewToolContext to create LegacyToolContext\n * for backward compatibility with existing handlers.\n *\n * @param newContext - New-style ToolContext\n * @returns Legacy-style ToolContext\n */\nexport function createLegacyContextFromNew(newContext: NewToolContext): LegacyToolContext {\n\treturn {\n\t\tworkspaceRoot: newContext.workspace.path,\n\t\ttier: newContext.workspace.tier,\n\t\tstorageMode: \"local\", // Default to local for legacy compatibility\n\t\tuserId: newContext.user?.id,\n\t\tsessionId: undefined, // Not available in new context structure\n\t};\n}\n\n// =============================================================================\n// HANDLER ADAPTER\n// =============================================================================\n\n/**\n * Adapt a legacy handler to the new handler signature\n *\n * Wraps a LegacyToolHandler to work with NewToolContext.\n * The legacy handler receives a converted context.\n *\n * @param legacyHandler - Original handler from old registry\n * @returns New-style handler compatible with ToolRegistry\n */\nexport function adaptLegacyHandler(legacyHandler: LegacyToolHandler): NewToolHandler {\n\treturn async (input: unknown, context: NewToolContext): Promise<ToolResult> => {\n\t\t// Convert new context to legacy context\n\t\tconst legacyContext = createLegacyContextFromNew(context);\n\n\t\t// Call the legacy handler with adapted context\n\t\tconst result = await legacyHandler(input as Record<string, unknown>, legacyContext);\n\n\t\t// Return result unchanged (ToolResult is compatible)\n\t\treturn result;\n\t};\n}\n\n// =============================================================================\n// TOOL ADAPTER\n// =============================================================================\n\n/**\n * Adapt a legacy SnapBackTool to a new ToolDefinition\n *\n * Converts the old tool format to the new format, including:\n * - Inferring capabilities from tool name\n * - Mapping tier (with default to \"free\")\n * - Wrapping handler for context adaptation\n * - Preserving annotations and deprecated flag\n *\n * @param legacyTool - SnapBackTool from old registry\n * @param handler - Legacy handler function\n * @returns ToolDefinition compatible with new ToolRegistry\n */\nexport function adaptLegacyTool(legacyTool: SnapBackTool, handler: LegacyToolHandler): ToolDefinition {\n\t// Map legacy tier to new tier (legacy only has \"free\" | \"pro\")\n\tconst mapTier = (legacyTier?: \"free\" | \"pro\"): ToolTier => {\n\t\tif (legacyTier === \"pro\") return \"pro\";\n\t\treturn \"free\";\n\t};\n\n\treturn {\n\t\tname: legacyTool.name,\n\t\tdescription: legacyTool.description ?? `Tool: ${legacyTool.name}`,\n\t\tinputSchema: legacyTool.inputSchema,\n\t\tcapabilities: inferCapabilities(legacyTool.name),\n\t\ttier: mapTier(legacyTool.tier),\n\t\thandler: adaptLegacyHandler(handler),\n\t\tannotations: legacyTool.annotations,\n\t\tdeprecated: legacyTool.deprecated,\n\t};\n}\n\n// =============================================================================\n// BATCH ADAPTER\n// =============================================================================\n\n/**\n * Adapt multiple legacy tools at once\n *\n * @param tools - Array of [SnapBackTool, LegacyToolHandler] pairs\n * @returns Array of ToolDefinitions\n */\nexport function adaptLegacyTools(tools: Array<[SnapBackTool, LegacyToolHandler]>): ToolDefinition[] {\n\treturn tools.map(([tool, handler]) => adaptLegacyTool(tool, handler));\n}\n\n// =============================================================================\n// CONVENIENCE: Pre-adapted Consolidated Tools\n// =============================================================================\n\n/**\n * Get all consolidated tools adapted to ToolDefinition format\n *\n * This is a convenience function that imports the consolidated tools\n * and adapts them for use with the new ToolRegistry.\n *\n * @returns Promise resolving to array of adapted ToolDefinitions\n *\n * @example\n * ```typescript\n * import { createToolRegistry } from './registry';\n * import { getAdaptedConsolidatedTools } from './registry/adapter';\n *\n * const registry = createToolRegistry();\n * const tools = await getAdaptedConsolidatedTools();\n * tools.forEach(tool => registry.register(tool));\n * ```\n */\nexport async function getAdaptedConsolidatedTools(): Promise<ToolDefinition[]> {\n\t// Dynamic import to avoid circular dependencies\n\tconst { CONSOLIDATED_TOOLS, CONSOLIDATED_HANDLERS } = await import(\"../tools/consolidated/registry.js\");\n\n\tconst toolPairs = CONSOLIDATED_TOOLS.map((tool) => [\n\t\ttool as SnapBackTool,\n\t\tCONSOLIDATED_HANDLERS[tool.name] as LegacyToolHandler,\n\t]) as Array<[SnapBackTool, LegacyToolHandler]>;\n\n\treturn adaptLegacyTools(toolPairs);\n}\n","/**\n * Tool Registry (ADR-003)\n *\n * Central registry for MCP tools with capability-based authorization.\n *\n * Key features:\n * - Tools register themselves with capabilities\n * - Registry enforces tier and capability requirements\n * - No circular dependencies (tools don't import registry)\n * - Lifecycle hooks (beforeExecute, afterExecute, onError)\n *\n * @module registry/ToolRegistry\n */\n\nimport { CapabilityManager } from \"./CapabilityManager.js\";\nimport {\n\tCapabilityNotGrantedError,\n\tInputValidationError,\n\ttype IToolRegistry,\n\tTIER_HIERARCHY,\n\tTierNotAuthorizedError,\n\ttype ToolCapability,\n\ttype ToolContext,\n\ttype ToolDefinition,\n\ttype ToolExecutionResult,\n\tToolNotFoundError,\n\ttype ToolTier,\n\ttype ValidationResult,\n} from \"./types.js\";\n\n/**\n * JSON Schema validator (simplified)\n * In production, use a library like ajv\n */\nfunction validateJsonSchema(\n\tschema: { type: string; properties?: Record<string, unknown>; required?: string[] },\n\tinput: unknown,\n): ValidationResult {\n\tconst errors: string[] = [];\n\n\tif (schema.type === \"object\") {\n\t\tif (typeof input !== \"object\" || input === null) {\n\t\t\treturn { valid: false, errors: [\"Input must be an object\"] };\n\t\t}\n\n\t\tconst inputObj = input as Record<string, unknown>;\n\n\t\t// Check required fields\n\t\tif (schema.required) {\n\t\t\tfor (const field of schema.required) {\n\t\t\t\tif (!(field in inputObj)) {\n\t\t\t\t\terrors.push(`Missing required field: ${field}`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn { valid: errors.length === 0, errors: errors.length > 0 ? errors : undefined };\n}\n\n/**\n * Tool Registry Implementation\n *\n * Manages tool registration, capability checking, and execution.\n */\nexport class ToolRegistry implements IToolRegistry {\n\tprivate tools = new Map<string, ToolDefinition>();\n\tprivate capabilityManager: CapabilityManager;\n\n\tconstructor(capabilityManager?: CapabilityManager) {\n\t\tthis.capabilityManager = capabilityManager ?? new CapabilityManager();\n\t}\n\n\t/**\n\t * Register a tool\n\t */\n\tregister<TInput, TOutput>(tool: ToolDefinition<TInput, TOutput>): void {\n\t\t// Validate tool definition\n\t\tthis.validateToolDefinition(tool as ToolDefinition);\n\n\t\t// Check for duplicate registration\n\t\tif (this.tools.has(tool.name)) {\n\t\t\tthrow new Error(`Tool '${tool.name}' is already registered`);\n\t\t}\n\n\t\t// Cast to base type for storage (type safety enforced at call site)\n\t\tthis.tools.set(tool.name, tool as unknown as ToolDefinition);\n\t\tconsole.log(` Registered tool: ${tool.name} (tier: ${tool.tier ?? \"free\"})`);\n\t}\n\n\t/**\n\t * Get a tool by name\n\t */\n\tget(name: string): ToolDefinition | undefined {\n\t\treturn this.tools.get(name);\n\t}\n\n\t/**\n\t * List all tools (optionally filtered by tier)\n\t */\n\tlist(options?: { tier?: ToolTier }): ToolDefinition[] {\n\t\tconst allTools = Array.from(this.tools.values());\n\n\t\tif (!options?.tier) {\n\t\t\treturn allTools;\n\t\t}\n\n\t\t// Filter by tier (include lower tiers)\n\t\tconst maxTierIndex = TIER_HIERARCHY.indexOf(options.tier);\n\n\t\treturn allTools.filter((tool) => {\n\t\t\tconst toolTierIndex = TIER_HIERARCHY.indexOf(tool.tier ?? \"free\");\n\t\t\treturn toolTierIndex <= maxTierIndex;\n\t\t});\n\t}\n\n\t/**\n\t * Execute a tool with capability checking\n\t */\n\tasync execute<TInput, TOutput>(\n\t\tname: string,\n\t\tinput: TInput,\n\t\tcontext: ToolContext,\n\t): Promise<ToolExecutionResult<TOutput>> {\n\t\tconst startTime = Date.now();\n\t\tconst tool = this.tools.get(name);\n\n\t\tif (!tool) {\n\t\t\tthrow new ToolNotFoundError(name);\n\t\t}\n\n\t\t// Check tier authorization\n\t\tif (!this.isTierAuthorized(tool, context)) {\n\t\t\tthrow new TierNotAuthorizedError(name, tool.tier ?? \"free\");\n\t\t}\n\n\t\t// Check capabilities\n\t\tconst missingCapabilities = this.getMissingCapabilities(tool, context);\n\t\tif (missingCapabilities.length > 0) {\n\t\t\tthrow new CapabilityNotGrantedError(name, missingCapabilities);\n\t\t}\n\n\t\t// Validate input\n\t\tconst validationResult = this.validateInput(name, input);\n\t\tif (!validationResult.valid) {\n\t\t\tthrow new InputValidationError(name, validationResult.errors ?? []);\n\t\t}\n\n\t\t// Execute with hooks\n\t\ttry {\n\t\t\t// Before hook\n\t\t\tif (tool.hooks?.beforeExecute) {\n\t\t\t\tawait tool.hooks.beforeExecute(input, context);\n\t\t\t}\n\n\t\t\t// Main execution\n\t\t\tconst output = await tool.handler(input, context);\n\n\t\t\t// After hook\n\t\t\tif (tool.hooks?.afterExecute) {\n\t\t\t\tawait tool.hooks.afterExecute(output, context);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\tresult: output as TOutput,\n\t\t\t\tdurationMs: Date.now() - startTime,\n\t\t\t};\n\t\t} catch (error) {\n\t\t\t// Error hook\n\t\t\tif (tool.hooks?.onError) {\n\t\t\t\tawait tool.hooks.onError(error as Error, context);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\tdurationMs: Date.now() - startTime,\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Check if a tool is available for given context\n\t */\n\tisAvailable(name: string, context: ToolContext): boolean {\n\t\tconst tool = this.tools.get(name);\n\t\tif (!tool) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.isTierAuthorized(tool, context) && this.getMissingCapabilities(tool, context).length === 0;\n\t}\n\n\t/**\n\t * Validate input against tool schema\n\t */\n\tvalidateInput(name: string, input: unknown): ValidationResult {\n\t\tconst tool = this.tools.get(name);\n\t\tif (!tool) {\n\t\t\treturn { valid: false, errors: [`Tool '${name}' not found`] };\n\t\t}\n\n\t\treturn validateJsonSchema(tool.inputSchema, input);\n\t}\n\n\t/**\n\t * Get the capability manager\n\t */\n\tgetCapabilityManager(): CapabilityManager {\n\t\treturn this.capabilityManager;\n\t}\n\n\t/**\n\t * Get all registered tool names\n\t */\n\tgetToolNames(): string[] {\n\t\treturn Array.from(this.tools.keys());\n\t}\n\n\t/**\n\t * Check if tool is registered\n\t */\n\thas(name: string): boolean {\n\t\treturn this.tools.has(name);\n\t}\n\n\t/**\n\t * Unregister a tool (mainly for testing)\n\t */\n\tunregister(name: string): boolean {\n\t\treturn this.tools.delete(name);\n\t}\n\n\t/**\n\t * Clear all registered tools (mainly for testing)\n\t */\n\tclear(): void {\n\t\tthis.tools.clear();\n\t}\n\n\t// ==========================================================================\n\t// Private Methods\n\t// ==========================================================================\n\n\tprivate isTierAuthorized(tool: ToolDefinition, context: ToolContext): boolean {\n\t\tconst requiredTierIndex = TIER_HIERARCHY.indexOf(tool.tier ?? \"free\");\n\t\tconst userTierIndex = TIER_HIERARCHY.indexOf(context.workspace.tier);\n\t\treturn userTierIndex >= requiredTierIndex;\n\t}\n\n\tprivate getMissingCapabilities(tool: ToolDefinition, context: ToolContext): ToolCapability[] {\n\t\treturn tool.capabilities.filter((cap) => !context.activeCapabilities.has(cap));\n\t}\n\n\tprivate validateToolDefinition(tool: ToolDefinition): void {\n\t\tif (!tool.name || typeof tool.name !== \"string\") {\n\t\t\tthrow new Error(\"Tool must have a valid name\");\n\t\t}\n\t\tif (!tool.handler || typeof tool.handler !== \"function\") {\n\t\t\tthrow new Error(`Tool '${tool.name}' must have a handler function`);\n\t\t}\n\t\tif (!Array.isArray(tool.capabilities)) {\n\t\t\tthrow new Error(`Tool '${tool.name}' must declare capabilities array`);\n\t\t}\n\t\tif (!tool.inputSchema || typeof tool.inputSchema !== \"object\") {\n\t\t\tthrow new Error(`Tool '${tool.name}' must have an inputSchema`);\n\t\t}\n\t}\n}\n\n/**\n * Create a tool registry with default configuration\n */\nexport function createToolRegistry(capabilityManager?: CapabilityManager): ToolRegistry {\n\treturn new ToolRegistry(capabilityManager);\n}\n","/**\n * Streamable HTTP Transport for MCP Server\n *\n * Implements the MCP 2025-03-26 Streamable HTTP transport specification.\n * This transport enables remote MCP server deployment with proper session management.\n *\n * @module transport/http\n */\n\nimport { randomUUID } from \"node:crypto\";\nimport type { IncomingMessage, ServerResponse } from \"node:http\";\nimport { StreamableHTTPServerTransport } from \"@modelcontextprotocol/sdk/server/streamableHttp.js\";\nimport { isInitializeRequest } from \"@modelcontextprotocol/sdk/types.js\";\nimport { getAdaptedConsolidatedTools } from \"../registry/adapter.js\";\nimport { createToolRegistry, type ToolRegistry } from \"../registry/ToolRegistry.js\";\nimport { createMcpServerWithRegistry, type McpServerOptions } from \"../server.js\";\n\n/**\n * Options for HTTP transport\n */\nexport interface HttpTransportOptions extends McpServerOptions {\n\t/** Enable JSON-only response mode (no SSE streaming) */\n\tenableJsonResponse?: boolean;\n\t/** Session timeout in milliseconds (default: 30 minutes) */\n\tsessionTimeoutMs?: number;\n\t/** Maximum concurrent sessions (default: 1000) */\n\tmaxSessions?: number;\n}\n\n/**\n * Session store for managing MCP transports\n */\ninterface SessionEntry {\n\ttransport: StreamableHTTPServerTransport;\n\tcreatedAt: number;\n\tlastAccessedAt: number;\n}\n\n/**\n * HTTP Transport Manager\n *\n * Manages StreamableHTTPServerTransport instances for multiple concurrent sessions.\n * Handles session lifecycle, cleanup, and request routing.\n *\n * Uses ToolRegistry (ADR-003) for capability-based tool management.\n */\nexport class HttpTransportManager {\n\tprivate sessions: Map<string, SessionEntry> = new Map();\n\tprivate options: HttpTransportOptions;\n\tprivate cleanupInterval: NodeJS.Timeout | null = null;\n\tprivate registry: ToolRegistry | null = null;\n\tprivate registryInitialized = false;\n\n\tconstructor(options: HttpTransportOptions) {\n\t\tthis.options = {\n\t\t\tsessionTimeoutMs: 30 * 60 * 1000, // 30 minutes default\n\t\t\tmaxSessions: 1000,\n\t\t\tenableJsonResponse: true, // Default to JSON for simpler client handling\n\t\t\t...options,\n\t\t};\n\n\t\t// Start session cleanup interval\n\t\tthis.cleanupInterval = setInterval(() => this.cleanupStaleSessions(), 60000);\n\t}\n\n\t/**\n\t * Initialize the shared ToolRegistry (ADR-003)\n\t * Called lazily on first request to avoid blocking constructor\n\t */\n\tprivate async ensureRegistryInitialized(): Promise<ToolRegistry> {\n\t\tif (this.registryInitialized && this.registry) {\n\t\t\treturn this.registry;\n\t\t}\n\n\t\tthis.registry = createToolRegistry();\n\t\tconst adaptedTools = await getAdaptedConsolidatedTools();\n\t\tfor (const tool of adaptedTools) {\n\t\t\tthis.registry.register(tool);\n\t\t}\n\t\tthis.registryInitialized = true;\n\t\tconsole.error(`[SnapBack MCP HTTP] ToolRegistry initialized with ${adaptedTools.length} tools`);\n\t\treturn this.registry;\n\t}\n\n\t/**\n\t * Handle incoming HTTP request\n\t * Routes to appropriate transport based on session ID\n\t */\n\tasync handleRequest(req: IncomingMessage, res: ServerResponse, body: unknown): Promise<void> {\n\t\tconst sessionId = req.headers[\"mcp-session-id\"] as string | undefined;\n\n\t\t// Handle based on HTTP method\n\t\tswitch (req.method) {\n\t\t\tcase \"POST\":\n\t\t\t\tawait this.handlePost(req, res, body, sessionId);\n\t\t\t\tbreak;\n\t\t\tcase \"GET\":\n\t\t\t\tawait this.handleGet(req, res, sessionId);\n\t\t\t\tbreak;\n\t\t\tcase \"DELETE\":\n\t\t\t\tawait this.handleDelete(req, res, sessionId);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tres.writeHead(405, { \"Content-Type\": \"application/json\" });\n\t\t\t\tres.end(JSON.stringify({ error: \"Method not allowed\" }));\n\t\t}\n\t}\n\n\t/**\n\t * Handle POST requests (client-to-server messages)\n\t */\n\tprivate async handlePost(\n\t\treq: IncomingMessage,\n\t\tres: ServerResponse,\n\t\tbody: unknown,\n\t\tsessionId: string | undefined,\n\t): Promise<void> {\n\t\tlet transport: StreamableHTTPServerTransport;\n\n\t\tif (sessionId && this.sessions.has(sessionId)) {\n\t\t\t// Reuse existing session\n\t\t\tconst entry = this.sessions.get(sessionId)!;\n\t\t\tentry.lastAccessedAt = Date.now();\n\t\t\ttransport = entry.transport;\n\t\t} else if (!sessionId && isInitializeRequest(body)) {\n\t\t\t// New session initialization\n\t\t\tif (this.sessions.size >= (this.options.maxSessions || 1000)) {\n\t\t\t\tres.writeHead(503, { \"Content-Type\": \"application/json\" });\n\t\t\t\tres.end(\n\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\tjsonrpc: \"2.0\",\n\t\t\t\t\t\terror: { code: -32000, message: \"Server at capacity\" },\n\t\t\t\t\t\tid: null,\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttransport = new StreamableHTTPServerTransport({\n\t\t\t\tsessionIdGenerator: () => randomUUID(),\n\t\t\t\tenableJsonResponse: this.options.enableJsonResponse,\n\t\t\t\tonsessioninitialized: (id) => {\n\t\t\t\t\tthis.sessions.set(id, {\n\t\t\t\t\t\ttransport,\n\t\t\t\t\t\tcreatedAt: Date.now(),\n\t\t\t\t\t\tlastAccessedAt: Date.now(),\n\t\t\t\t\t});\n\t\t\t\t\tconsole.error(`[SnapBack MCP HTTP] Session initialized: ${id}`);\n\t\t\t\t},\n\t\t\t});\n\n\t\t\ttransport.onclose = () => {\n\t\t\t\tif (transport.sessionId) {\n\t\t\t\t\tthis.sessions.delete(transport.sessionId);\n\t\t\t\t\tconsole.error(`[SnapBack MCP HTTP] Session closed: ${transport.sessionId}`);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// ADR-003: Create and connect MCP server with shared ToolRegistry\n\t\t\tconst registry = await this.ensureRegistryInitialized();\n\t\t\tconst server = createMcpServerWithRegistry({ ...this.options, registry });\n\t\t\tawait server.connect(transport);\n\t\t} else {\n\t\t\t// Invalid request - no session and not an initialize request\n\t\t\tres.writeHead(400, { \"Content-Type\": \"application/json\" });\n\t\t\tres.end(\n\t\t\t\tJSON.stringify({\n\t\t\t\t\tjsonrpc: \"2.0\",\n\t\t\t\t\terror: {\n\t\t\t\t\t\tcode: -32000,\n\t\t\t\t\t\tmessage: sessionId ? \"Session not found or expired\" : \"Bad Request: Not an initialize request\",\n\t\t\t\t\t},\n\t\t\t\t\tid: null,\n\t\t\t\t}),\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tawait transport.handleRequest(req, res, body);\n\t}\n\n\t/**\n\t * Handle GET requests (server-to-client SSE stream)\n\t */\n\tprivate async handleGet(req: IncomingMessage, res: ServerResponse, sessionId: string | undefined): Promise<void> {\n\t\tif (!sessionId || !this.sessions.has(sessionId)) {\n\t\t\tres.writeHead(400, { \"Content-Type\": \"application/json\" });\n\t\t\tres.end(JSON.stringify({ error: \"Invalid or missing session\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tconst entry = this.sessions.get(sessionId)!;\n\t\tentry.lastAccessedAt = Date.now();\n\t\tawait entry.transport.handleRequest(req, res);\n\t}\n\n\t/**\n\t * Handle DELETE requests (session termination)\n\t */\n\tprivate async handleDelete(\n\t\treq: IncomingMessage,\n\t\tres: ServerResponse,\n\t\tsessionId: string | undefined,\n\t): Promise<void> {\n\t\tif (!sessionId || !this.sessions.has(sessionId)) {\n\t\t\tres.writeHead(400, { \"Content-Type\": \"application/json\" });\n\t\t\tres.end(JSON.stringify({ error: \"Invalid or missing session\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tconst entry = this.sessions.get(sessionId)!;\n\t\tawait entry.transport.handleRequest(req, res);\n\t\tthis.sessions.delete(sessionId);\n\t}\n\n\t/**\n\t * Clean up stale sessions\n\t */\n\tprivate cleanupStaleSessions(): void {\n\t\tconst now = Date.now();\n\t\tconst timeout = this.options.sessionTimeoutMs || 30 * 60 * 1000;\n\n\t\tfor (const [sessionId, entry] of this.sessions) {\n\t\t\tif (now - entry.lastAccessedAt > timeout) {\n\t\t\t\tentry.transport.close();\n\t\t\t\tthis.sessions.delete(sessionId);\n\t\t\t\tconsole.error(`[SnapBack MCP HTTP] Session timed out: ${sessionId}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Get active session count\n\t */\n\tgetSessionCount(): number {\n\t\treturn this.sessions.size;\n\t}\n\n\t/**\n\t * Close all sessions and cleanup\n\t */\n\tasync close(): Promise<void> {\n\t\tif (this.cleanupInterval) {\n\t\t\tclearInterval(this.cleanupInterval);\n\t\t\tthis.cleanupInterval = null;\n\t\t}\n\n\t\tfor (const [sessionId, entry] of this.sessions) {\n\t\t\tawait entry.transport.close();\n\t\t\tconsole.error(`[SnapBack MCP HTTP] Closed session: ${sessionId}`);\n\t\t}\n\t\tthis.sessions.clear();\n\t}\n}\n\n/**\n * Create HTTP transport manager\n *\n * @param options - Server and transport configuration\n * @returns Configured HttpTransportManager instance\n *\n * @example\n * ```typescript\n * const manager = createHttpTransport({\n *   workspaceRoot: \"/path/to/workspace\",\n *   tier: \"pro\",\n * });\n *\n * // In Express route handler:\n * app.all('/mcp', async (req, res) => {\n *   await manager.handleRequest(req, res, req.body);\n * });\n * ```\n */\nexport function createHttpTransport(options: HttpTransportOptions): HttpTransportManager {\n\treturn new HttpTransportManager(options);\n}\n","/**\n * Stdio Transport for MCP Server\n *\n * Runs the MCP server over stdio for integration with\n * Cursor, Claude Desktop, and other MCP clients.\n *\n * @module transport/stdio\n */\n\nimport { StdioServerTransport } from \"@modelcontextprotocol/sdk/server/stdio.js\";\nimport { getAdaptedConsolidatedTools } from \"../registry/adapter.js\";\nimport { createToolRegistry } from \"../registry/ToolRegistry.js\";\nimport { createMcpServerWithRegistry, type McpServerOptions } from \"../server.js\";\n\n/**\n * Run MCP server with stdio transport\n *\n * This is the main entry point for CLI integration.\n * The server will communicate over stdin/stdout using\n * the MCP protocol.\n *\n * Uses ToolRegistry (ADR-003) for capability-based tool management.\n *\n * @param options - Server configuration options\n *\n * @example\n * ```typescript\n * // In CLI command handler:\n * await runStdioMcpServer({\n *   workspaceRoot: process.cwd(),\n *   tier: \"pro\",\n * });\n * ```\n */\nexport async function runStdioMcpServer(options: McpServerOptions): Promise<void> {\n\t// ADR-003: Create ToolRegistry and register adapted tools\n\tconst registry = createToolRegistry();\n\tconst adaptedTools = await getAdaptedConsolidatedTools();\n\tfor (const tool of adaptedTools) {\n\t\tregistry.register(tool);\n\t}\n\n\t// Create server with registry (ADR-003)\n\tconst server = createMcpServerWithRegistry({ ...options, registry });\n\tconst transport = new StdioServerTransport();\n\n\t// Connect server to transport\n\tawait server.connect(transport);\n\n\tconsole.error(\"[SnapBack MCP] Server running on stdio transport\");\n\n\t// Handle graceful shutdown\n\tprocess.on(\"SIGINT\", async () => {\n\t\tconsole.error(\"[SnapBack MCP] Shutting down...\");\n\t\tawait server.close();\n\t\tprocess.exit(0);\n\t});\n\n\tprocess.on(\"SIGTERM\", async () => {\n\t\tconsole.error(\"[SnapBack MCP] Shutting down...\");\n\t\tawait server.close();\n\t\tprocess.exit(0);\n\t});\n}\n","/**\n * Workspace Path Validation & Security Middleware\n *\n * Validates and secures workspace paths to prevent:\n * - Path escapes\n * - Invalid repository directories\n * - Unsafe symlink resolution\n *\n * @module middleware/workspace\n */\n\nimport { existsSync, lstatSync } from \"node:fs\";\nimport { normalize, resolve } from \"node:path\";\n\nexport interface WorkspaceValidationResult {\n\tvalid: boolean;\n\troot: string;\n\terror?: string;\n}\n\n/**\n * Validate a workspace path according to security criteria\n *\n * Checks for:\n * 1. At least one marker: .git/, package.json, or .snapback/\n * 2. Path does not escape via symlinks\n * 3. Path is absolute and normalized\n *\n * @param workspacePath - Path to validate (relative or absolute)\n * @returns Validation result with normalized root path or error\n */\nexport function validateWorkspacePath(workspacePath: string): WorkspaceValidationResult {\n\ttry {\n\t\t// Normalize and resolve to absolute path\n\t\tconst normalizedPath = normalize(workspacePath);\n\t\tconst absolutePath = resolve(normalizedPath);\n\n\t\t// Check for path escape attempts\n\t\tif (!absolutePath.startsWith(process.cwd()) && !absolutePath.startsWith(\"/\")) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\troot: \"\",\n\t\t\t\terror: \"Invalid workspace path\",\n\t\t\t};\n\t\t}\n\n\t\t// Check for valid workspace markers\n\t\tconst hasGit = existsSync(resolve(absolutePath, \".git\"));\n\t\tconst hasPackageJson = existsSync(resolve(absolutePath, \"package.json\"));\n\t\tconst hasSnapback = existsSync(resolve(absolutePath, \".snapback\"));\n\n\t\tif (!hasGit && !hasPackageJson && !hasSnapback) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\troot: absolutePath,\n\t\t\t\terror: \"Workspace must contain at least one marker: .git, package.json, or .snapback\",\n\t\t\t};\n\t\t}\n\n\t\t// Check for symlink issues\n\t\ttry {\n\t\t\tconst stat = lstatSync(absolutePath);\n\t\t\tif (stat.isSymbolicLink()) {\n\t\t\t\treturn {\n\t\t\t\t\tvalid: false,\n\t\t\t\t\troot: absolutePath,\n\t\t\t\t\terror: \"Workspace path cannot be a symbolic link\",\n\t\t\t\t};\n\t\t\t}\n\t\t} catch {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\troot: absolutePath,\n\t\t\t\terror: \"Cannot access workspace path\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tvalid: true,\n\t\t\troot: absolutePath,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tvalid: false,\n\t\t\troot: \"\",\n\t\t\terror: error instanceof Error ? error.message : \"Unknown error validating workspace\",\n\t\t};\n\t}\n}\n\n/**\n * Find repository root by traversing upward\n *\n * Looks for .git, package.json, or .snapback markers.\n * Stops at filesystem root.\n *\n * @param startPath - Path to start search from (defaults to cwd)\n * @returns Root path or null if not found\n */\nexport function findWorkspaceRoot(startPath: string = process.cwd()): string | null {\n\tlet currentPath = resolve(startPath);\n\n\t// Prevent infinite loops\n\tconst maxIterations = 50;\n\tlet iterations = 0;\n\n\twhile (iterations < maxIterations) {\n\t\titerations++;\n\n\t\tif (hasWorkspaceMarker(currentPath)) {\n\t\t\treturn currentPath;\n\t\t}\n\n\t\tconst parent = resolve(currentPath, \"..\");\n\t\tif (parent === currentPath) {\n\t\t\t// Reached filesystem root\n\t\t\tbreak;\n\t\t}\n\n\t\tcurrentPath = parent;\n\t}\n\n\treturn null;\n}\n\n/**\n * Check if a directory has workspace markers\n *\n * @param dirPath - Directory to check\n * @returns True if at least one marker exists\n */\nfunction hasWorkspaceMarker(dirPath: string): boolean {\n\ttry {\n\t\tconst hasGit = existsSync(resolve(dirPath, \".git\"));\n\t\tconst hasPackageJson = existsSync(resolve(dirPath, \"package.json\"));\n\t\tconst hasSnapback = existsSync(resolve(dirPath, \".snapback\"));\n\n\t\treturn hasGit || hasPackageJson || hasSnapback;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/**\n * Resolve workspace root with fallback chain:\n * 1. Explicit path (if provided and valid)\n * 2. Traversal upward from cwd\n * 3. cwd itself (if has markers)\n *\n * @param explicitPath - Optional explicit workspace path\n * @returns Validation result\n */\nexport function resolveWorkspaceRoot(explicitPath?: string): WorkspaceValidationResult {\n\t// Try explicit path first\n\tif (explicitPath) {\n\t\tconst validation = validateWorkspacePath(explicitPath);\n\t\tif (validation.valid) {\n\t\t\treturn validation;\n\t\t}\n\t}\n\n\t// Try finding root by traversal\n\tconst found = findWorkspaceRoot();\n\tif (found) {\n\t\treturn validateWorkspacePath(found);\n\t}\n\n\t// Try cwd as fallback\n\treturn validateWorkspacePath(process.cwd());\n}\n","/**\n * SnapBack CLI MCP Command\n *\n * Implements `snap mcp --stdio` for launching the MCP server from the CLI.\n * This command is invoked by Cursor, Claude Desktop, and other MCP clients.\n *\n * Usage:\n *   snap mcp --stdio [--workspace <path>]\n *\n * @module commands/mcp\n */\n\nimport { type McpServerOptions, runStdioMcpServer } from \"@snapback/mcp\";\nimport { resolveWorkspaceRoot } from \"@snapback/mcp/middleware\";\nimport { createCommand } from \"commander\";\n\n/**\n * Resolve tier from environment or CLI flag\n * Priority: CLI flag > SNAPBACK_TIER env > default\n */\n/**\n * Resolve user tier from multiple sources with priority:\n * 1. Explicit CLI flag (--tier)\n * 2. SNAPBACK_TIER environment variable\n * 3. SNAPBACK_API_KEY presence (implies pro)\n * 4. SNAPBACK_WORKSPACE_ID (would require async DB lookup - not implemented here)\n * 5. Default to free\n *\n * Note: For local CLI, we don't have access to the workspace_links database,\n * so workspace ID-based tier resolution is handled by the remote MCP server.\n * The CLI infers tier from API key presence or explicit configuration.\n */\nfunction resolveTier(cliTier?: string): \"free\" | \"pro\" | \"enterprise\" {\n\t// Priority 1: CLI flag takes precedence\n\tif (cliTier && [\"free\", \"pro\", \"enterprise\"].includes(cliTier)) {\n\t\treturn cliTier as \"free\" | \"pro\" | \"enterprise\";\n\t}\n\n\t// Priority 2: Check environment variable\n\tconst envTier = process.env.SNAPBACK_TIER;\n\tif (envTier && [\"free\", \"pro\", \"enterprise\"].includes(envTier)) {\n\t\treturn envTier as \"free\" | \"pro\" | \"enterprise\";\n\t}\n\n\t// Priority 3: API key presence implies pro tier\n\tif (process.env.SNAPBACK_API_KEY) {\n\t\treturn \"pro\";\n\t}\n\n\t// Priority 4: Default to free (workspace ID resolution happens server-side)\n\treturn \"free\";\n}\n\nexport function createMcpCommand() {\n\tconst cmd = createCommand(\"mcp\");\n\n\tcmd.description(\"Run MCP server for Cursor/Claude integration\")\n\t\t.option(\"--stdio\", \"Use stdio transport (default)\")\n\t\t.option(\"--workspace <path>\", \"Workspace root path (auto-resolved if not provided)\")\n\t\t.option(\n\t\t\t\"--tier <tier>\",\n\t\t\t\"Override user tier (free|pro|enterprise). Auto-detected from SNAPBACK_API_KEY or SNAPBACK_TIER env var. Defaults to free.\",\n\t\t)\n\t\t.action(async (options) => {\n\t\t\ttry {\n\t\t\t\t// Resolve workspace root with validation\n\t\t\t\tconst workspaceValidation = resolveWorkspaceRoot(options.workspace);\n\n\t\t\t\tif (!workspaceValidation.valid) {\n\t\t\t\t\tconsole.error(`[SnapBack MCP] Workspace validation failed: ${workspaceValidation.error}`);\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\t// Resolve tier from CLI flag, env var, or default\n\t\t\t\tconst tier = resolveTier(options.tier);\n\n\t\t\t\t// Build server options\n\t\t\t\tconst serverOptions: McpServerOptions = {\n\t\t\t\t\tworkspaceRoot: workspaceValidation.root,\n\t\t\t\t\ttier,\n\t\t\t\t\t// CLI invocation is always local with write permissions\n\t\t\t\t\tstorageMode: \"local\",\n\t\t\t\t};\n\n\t\t\t\t// Launch MCP server with stdio transport\n\t\t\t\tawait runStdioMcpServer(serverOptions);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"[SnapBack MCP] Server error:\", error);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn cmd;\n}\n\n/**\n * Export for CLI integration\n */\nexport const mcpCommand = createMcpCommand();\n","/**\n * Tools Command\n *\n * Implements snap tools configure - Auto-setup MCP for Cursor/Claude.\n * Refactored to use shared @snapback/mcp-config package.\n *\n * @see implementation_plan.md Section 1.2\n * @see mcp_companionship.md Part 3 for CLI specification\n */\n\nimport { existsSync } from \"node:fs\";\nimport { join } from \"node:path\";\nimport { confirm, password } from \"@inquirer/prompts\";\nimport {\n\ttype AIClientConfig,\n\tdetectAIClients,\n\tgetSnapbackMCPConfig,\n\trepairClientConfig,\n\ttype ValidationResult,\n\tvalidateClientConfig,\n\twriteClientConfig,\n} from \"@snapback/mcp-config\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport ora from \"ora\";\n\nimport { getCredentials, isLoggedIn } from \"../services/snapback-dir\";\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the tools command with subcommands\n */\nexport function createToolsCommand(): Command {\n\tconst tools = new Command(\"tools\").description(\"Configure AI tools\");\n\n\ttools\n\t\t.command(\"configure\")\n\t\t.description(\"Auto-setup MCP for Cursor, Claude, or other AI tools\")\n\t\t.option(\"--cursor\", \"Configure for Cursor only\")\n\t\t.option(\"--claude\", \"Configure for Claude Desktop only\")\n\t\t.option(\"--windsurf\", \"Configure for Windsurf only\")\n\t\t.option(\"--continue\", \"Configure for Continue only\")\n\t\t.option(\"--vscode\", \"Configure for VS Code only\")\n\t\t.option(\"--zed\", \"Configure for Zed only\")\n\t\t.option(\"--cline\", \"Configure for Cline only\")\n\t\t.option(\"--gemini\", \"Configure for Gemini/Antigravity only\")\n\t\t.option(\"--aider\", \"Configure for Aider only\")\n\t\t.option(\"--roo-code\", \"Configure for Roo Code only\")\n\t\t.option(\"--qoder\", \"Configure for Qoder only\")\n\t\t.option(\"--list\", \"List available tools\")\n\t\t.option(\"--dry-run\", \"Show what would be configured without writing\")\n\t\t.option(\"--force\", \"Reconfigure even if already set up\")\n\t\t.option(\"-y, --yes\", \"Skip confirmation prompts (for CI/scripts)\")\n\t\t.option(\"--api-key <key>\", \"API key for Pro features\")\n\t\t.option(\"--dev\", \"Use local development mode (direct node execution with inferred workspace)\")\n\t\t.option(\"--workspace <path>\", \"Override workspace root path\")\n\n\t\t.action(async (options) => {\n\t\t\ttry {\n\t\t\t\tif (options.list) {\n\t\t\t\t\tawait listTools();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Determine which tools to configure\n\t\t\t\tconst toolsToConfig: string[] = [];\n\n\t\t\t\tif (options.cursor) {\n\t\t\t\t\ttoolsToConfig.push(\"cursor\");\n\t\t\t\t}\n\t\t\t\tif (options.claude) {\n\t\t\t\t\ttoolsToConfig.push(\"claude\");\n\t\t\t\t}\n\t\t\t\tif (options.windsurf) {\n\t\t\t\t\ttoolsToConfig.push(\"windsurf\");\n\t\t\t\t}\n\t\t\t\tif (options.continue) {\n\t\t\t\t\ttoolsToConfig.push(\"continue\");\n\t\t\t\t}\n\t\t\t\tif (options.vscode) {\n\t\t\t\t\ttoolsToConfig.push(\"vscode\");\n\t\t\t\t}\n\t\t\t\tif (options.zed) {\n\t\t\t\t\ttoolsToConfig.push(\"zed\");\n\t\t\t\t}\n\t\t\t\tif (options.cline) {\n\t\t\t\t\ttoolsToConfig.push(\"cline\");\n\t\t\t\t}\n\t\t\t\tif (options.gemini) {\n\t\t\t\t\ttoolsToConfig.push(\"gemini\");\n\t\t\t\t}\n\t\t\t\tif (options.aider) {\n\t\t\t\t\ttoolsToConfig.push(\"aider\");\n\t\t\t\t}\n\t\t\t\tif (options[\"roo-code\"] || options.rooCode) {\n\t\t\t\t\ttoolsToConfig.push(\"roo-code\");\n\t\t\t\t}\n\t\t\t\tif (options.qoder) {\n\t\t\t\t\ttoolsToConfig.push(\"qoder\");\n\t\t\t\t}\n\n\t\t\t\t// If no specific tool, auto-detect\n\t\t\t\tif (toolsToConfig.length === 0) {\n\t\t\t\t\tawait autoConfigureTools(\n\t\t\t\t\t\toptions.dryRun,\n\t\t\t\t\t\toptions.force,\n\t\t\t\t\t\toptions.yes,\n\t\t\t\t\t\toptions.apiKey,\n\t\t\t\t\t\toptions.dev,\n\t\t\t\t\t\toptions.workspace,\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tfor (const tool of toolsToConfig) {\n\t\t\t\t\t\tawait configureTool(\n\t\t\t\t\t\t\ttool,\n\t\t\t\t\t\t\toptions.dryRun,\n\t\t\t\t\t\t\toptions.yes,\n\t\t\t\t\t\t\toptions.apiKey,\n\t\t\t\t\t\t\toptions.dev,\n\t\t\t\t\t\t\toptions.workspace,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Configuration failed:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\ttools\n\t\t.command(\"status\")\n\t\t.description(\"Check MCP configuration status\")\n\t\t.option(\"--verbose\", \"Show detailed validation information\")\n\t\t.action(async (options) => {\n\t\t\tawait checkToolsStatus(options.verbose);\n\t\t});\n\n\ttools\n\t\t.command(\"validate\")\n\t\t.description(\"Validate MCP configurations for all detected AI tools\")\n\t\t.option(\"--verbose\", \"Show detailed validation issues\")\n\t\t.action(async (options) => {\n\t\t\tawait validateTools(options.verbose);\n\t\t});\n\n\ttools\n\t\t.command(\"repair\")\n\t\t.description(\"Repair broken MCP configurations\")\n\t\t.option(\"-y, --yes\", \"Skip confirmation prompts\")\n\t\t.option(\"--workspace <path>\", \"Override workspace root path\")\n\t\t.option(\"--api-key <key>\", \"API key for Pro features\")\n\t\t.action(async (options) => {\n\t\t\tawait repairTools(options.yes, options.workspace, options.apiKey);\n\t\t});\n\n\treturn tools;\n}\n\n// =============================================================================\n// TOOL CONFIGURATION\n// =============================================================================\n\n/**\n * List available tools and their detection status\n */\nasync function listTools(): Promise<void> {\n\tconst detection = detectAIClients();\n\n\tconsole.log(chalk.cyan(\"\\nAvailable AI Tools:\"));\n\tconsole.log();\n\n\tfor (const client of detection.clients) {\n\t\tconst status = client.exists\n\t\t\t? client.hasSnapback\n\t\t\t\t? chalk.green(\" Configured\")\n\t\t\t\t: chalk.yellow(\" Needs setup\")\n\t\t\t: chalk.gray(\"Not installed\");\n\n\t\tconsole.log(`  ${client.displayName.padEnd(20)} ${status}`);\n\t\tconsole.log(chalk.gray(`    Config: ${client.configPath}`));\n\t}\n\n\tconsole.log();\n\tconsole.log(chalk.gray(\"Use --cursor, --claude, --windsurf, or --continue to configure a specific tool\"));\n}\n\n/**\n * Auto-configure all detected tools\n */\nasync function autoConfigureTools(\n\tdryRun: boolean,\n\tforce: boolean,\n\tskipPrompts = false,\n\tprovidedApiKey?: string,\n\tdevMode = false,\n\tworkspaceOverride?: string,\n): Promise<void> {\n\tconst detection = detectAIClients();\n\n\tif (detection.detected.length === 0) {\n\t\tconsole.log(chalk.yellow(\"\\nNo AI tools detected\"));\n\t\tconsole.log(chalk.gray(\"Install one of these to use SnapBack MCP:\"));\n\t\tconsole.log(chalk.gray(\"   Claude Desktop - https://claude.ai/download\"));\n\t\tconsole.log(chalk.gray(\"   Cursor - https://cursor.sh\"));\n\t\tconsole.log(chalk.gray(\"   Windsurf - https://codeium.com/windsurf\"));\n\t\tconsole.log(chalk.gray(\"   Continue - https://continue.dev\"));\n\t\treturn;\n\t}\n\n\t// Determine what needs configuration\n\tconst needsSetup = force ? detection.detected : detection.needsSetup;\n\n\tif (needsSetup.length === 0) {\n\t\tconsole.log(chalk.green(\"\\n All detected AI tools already have SnapBack configured!\"));\n\t\tconsole.log(chalk.gray(\"Use --force to reconfigure.\"));\n\t\tshowNextSteps();\n\t\treturn;\n\t}\n\n\tconsole.log(chalk.cyan(`\\nDetected ${detection.detected.length} AI tool(s):`));\n\tfor (const client of detection.detected) {\n\t\tconst status = client.hasSnapback ? chalk.green(\"(configured)\") : chalk.yellow(\"(needs setup)\");\n\t\tconsole.log(`   ${client.displayName} ${status}`);\n\t}\n\tconsole.log();\n\n\t// Interactive confirmation (unless --yes flag is set)\n\tif (!skipPrompts) {\n\t\tconst clientNames = needsSetup.map((c) => c.displayName).join(\", \");\n\t\tconst proceed = await confirm({\n\t\t\tmessage: `Configure SnapBack for ${clientNames}?`,\n\t\t\tdefault: true,\n\t\t});\n\n\t\tif (!proceed) {\n\t\t\tconsole.log(\"\\nSetup cancelled.\");\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Get API key (from flag, env, login, or prompt)\n\tconst apiKey = await resolveApiKey(providedApiKey, skipPrompts);\n\n\t// Configure each tool that needs setup\n\tfor (const client of needsSetup) {\n\t\tawait configureClient(client, dryRun, apiKey, devMode, workspaceOverride);\n\t}\n\n\tshowNextSteps();\n}\n\n/**\n * Configure a specific tool by name\n */\nasync function configureTool(\n\ttoolName: string,\n\tdryRun: boolean,\n\tskipPrompts = false,\n\tprovidedApiKey?: string,\n\tdevMode = false,\n\tworkspaceOverride?: string,\n): Promise<void> {\n\tconst detection = detectAIClients();\n\tconst client = detection.clients.find((c) => c.name === toolName);\n\n\tif (!client) {\n\t\tconsole.error(chalk.red(`Unknown tool: ${toolName}`));\n\t\tconsole.log(chalk.gray(\"Available tools: cursor, claude, windsurf, continue\"));\n\t\treturn;\n\t}\n\n\tif (!client.exists) {\n\t\tconsole.log(chalk.yellow(`${client.displayName} is not installed`));\n\t\tconsole.log(chalk.gray(`Expected config at: ${client.configPath}`));\n\t\treturn;\n\t}\n\n\t// Get API key (from flag, env, login, or prompt)\n\tconst apiKey = await resolveApiKey(providedApiKey, skipPrompts);\n\n\tawait configureClient(client, dryRun, apiKey, devMode, workspaceOverride);\n\tshowNextSteps();\n}\n\n/**\n * Configure a specific AI client\n */\nasync function configureClient(\n\tclient: AIClientConfig,\n\tdryRun: boolean,\n\tapiKey?: string,\n\tdevMode = false,\n\tworkspaceOverride?: string,\n): Promise<void> {\n\tconst spinner = ora(`Configuring ${client.displayName}...`).start();\n\n\ttry {\n\t\t// Resolve workspace root for dev mode\n\t\tlet workspaceRoot: string | undefined;\n\t\tlet localCliPath: string | undefined;\n\n\t\tif (devMode) {\n\t\t\t// Infer workspace from cwd or find repo root\n\t\t\tworkspaceRoot = workspaceOverride || findWorkspaceRoot(process.cwd());\n\t\t\t// Find CLI dist path relative to workspace\n\t\t\tlocalCliPath = findCliDistPath(workspaceRoot);\n\n\t\t\tif (!localCliPath) {\n\t\t\t\tspinner.fail(\"Could not find CLI dist. Run 'pnpm build' first.\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tspinner.text = `Configuring ${client.displayName} (dev mode)...`;\n\t\t}\n\n\t\t// Pre-flight validation: Check existing config for issues\n\t\tif (client.hasSnapback) {\n\t\t\tspinner.text = `Validating existing config for ${client.displayName}...`;\n\t\t\tconst validation = validateClientConfig(client);\n\n\t\t\tif (!validation.valid) {\n\t\t\t\tconst errors = validation.issues.filter((i) => i.severity === \"error\");\n\t\t\t\tif (errors.length > 0) {\n\t\t\t\t\tspinner.warn(\"Existing config has issues, will be replaced\");\n\t\t\t\t\tfor (const issue of errors) {\n\t\t\t\t\t\tconsole.log(chalk.yellow(`   ${issue.message}`));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Build MCP config\n\t\tconst mcpConfig = getSnapbackMCPConfig({\n\t\t\tapiKey,\n\t\t\tuseLocalDev: devMode,\n\t\t\tlocalCliPath,\n\t\t\tworkspaceRoot,\n\t\t});\n\n\t\tif (dryRun) {\n\t\t\tspinner.info(`Would configure ${client.displayName}`);\n\t\t\tconsole.log(chalk.gray(`  Path: ${client.configPath}`));\n\t\t\tif (devMode) {\n\t\t\t\tconsole.log(chalk.gray(`  Workspace: ${workspaceRoot}`));\n\t\t\t\tconsole.log(chalk.gray(`  CLI Path: ${localCliPath}`));\n\t\t\t}\n\t\t\tconsole.log(chalk.gray(\"  Config:\"));\n\t\t\tconsole.log(JSON.stringify(mcpConfig, null, 2));\n\t\t\treturn;\n\t\t}\n\n\t\t// Write config using shared module\n\t\tconst result = writeClientConfig(client, mcpConfig);\n\n\t\tif (result.success) {\n\t\t\t// Post-write validation to ensure config was written correctly\n\t\t\tconst postValidation = validateClientConfig({ ...client, hasSnapback: true });\n\t\t\tif (postValidation.valid) {\n\t\t\t\tspinner.succeed(`Configured ${client.displayName}${devMode ? \" (dev mode)\" : \"\"}`);\n\t\t\t} else {\n\t\t\t\tconst warnings = postValidation.issues.filter((i) => i.severity === \"warning\");\n\t\t\t\tif (warnings.length > 0) {\n\t\t\t\t\tspinner.succeed(`Configured ${client.displayName} (with warnings)`);\n\t\t\t\t\tfor (const warning of warnings) {\n\t\t\t\t\t\tconsole.log(chalk.yellow(`   ${warning.message}`));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tspinner.succeed(`Configured ${client.displayName}${devMode ? \" (dev mode)\" : \"\"}`);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsole.log(chalk.gray(`  Config: ${client.configPath}`));\n\t\t\tif (devMode) {\n\t\t\t\tconsole.log(chalk.gray(`  Workspace: ${workspaceRoot}`));\n\t\t\t}\n\t\t\tif (result.backup) {\n\t\t\t\tconsole.log(chalk.gray(`  Backup: ${result.backup}`));\n\t\t\t}\n\t\t} else {\n\t\t\tspinner.fail(`Failed to configure ${client.displayName}`);\n\t\t\tconsole.error(chalk.red(`  Error: ${result.error}`));\n\t\t}\n\t} catch (error) {\n\t\tspinner.fail(`Failed to configure ${client.displayName}`);\n\t\tthrow error;\n\t}\n}\n\n/**\n * Find the workspace root by looking for markers (.git, package.json, .snapback)\n */\nfunction findWorkspaceRoot(startDir: string): string {\n\tlet dir = startDir;\n\tconst root = \"/\";\n\n\twhile (dir !== root) {\n\t\t// Check for workspace markers\n\t\tif (\n\t\t\texistsSync(join(dir, \".git\")) ||\n\t\t\texistsSync(join(dir, \"package.json\")) ||\n\t\t\texistsSync(join(dir, \".snapback\"))\n\t\t) {\n\t\t\treturn dir;\n\t\t}\n\t\tdir = join(dir, \"..\");\n\t}\n\n\t// Fallback to cwd\n\treturn startDir;\n}\n\n/**\n * Find the CLI dist path relative to workspace\n */\nfunction findCliDistPath(workspaceRoot: string): string | undefined {\n\tconst possiblePaths = [\n\t\tjoin(workspaceRoot, \"apps\", \"cli\", \"dist\", \"index.js\"),\n\t\tjoin(workspaceRoot, \"dist\", \"index.js\"),\n\t];\n\n\tfor (const path of possiblePaths) {\n\t\tif (existsSync(path)) {\n\t\t\treturn path;\n\t\t}\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Resolve API key from multiple sources\n * Priority: --api-key flag > SNAPBACK_API_KEY env > logged in credentials > interactive prompt\n */\nasync function resolveApiKey(providedApiKey?: string, skipPrompts = false): Promise<string | undefined> {\n\t// 1. Check provided flag\n\tif (providedApiKey) {\n\t\treturn providedApiKey;\n\t}\n\n\t// 2. Check environment variable\n\tconst envKey = process.env.SNAPBACK_API_KEY;\n\tif (envKey) {\n\t\treturn envKey;\n\t}\n\n\t// 3. Check logged in credentials\n\tif (await isLoggedIn()) {\n\t\tconst credentials = await getCredentials();\n\t\tif (credentials?.accessToken) {\n\t\t\treturn credentials.accessToken;\n\t\t}\n\t}\n\n\t// 4. Interactive prompt (unless --yes flag is set)\n\tif (!skipPrompts) {\n\t\tconst wantApiKey = await confirm({\n\t\t\tmessage: \"Do you have a SnapBack API key for Pro features?\",\n\t\t\tdefault: false,\n\t\t});\n\n\t\tif (wantApiKey) {\n\t\t\tconst key = await password({\n\t\t\t\tmessage: \"Enter your API key:\",\n\t\t\t\tmask: \"*\",\n\t\t\t});\n\t\t\treturn key || undefined;\n\t\t}\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Check status of all tool configurations\n */\nasync function checkToolsStatus(verbose = false): Promise<void> {\n\tconst detection = detectAIClients();\n\n\tconsole.log(chalk.cyan(\"\\nMCP Configuration Status:\"));\n\tconsole.log();\n\n\tlet hasIssues = false;\n\n\tfor (const client of detection.clients) {\n\t\tlet icon: string;\n\t\tlet status: string;\n\n\t\tif (!client.exists) {\n\t\t\ticon = chalk.gray(\"\");\n\t\t\tstatus = chalk.gray(\"Not installed\");\n\t\t} else if (client.hasSnapback) {\n\t\t\t// Deep validation for configured clients\n\t\t\tconst validation = validateClientConfig(client);\n\t\t\tif (validation.valid) {\n\t\t\t\ticon = chalk.green(\"\");\n\t\t\t\tstatus = chalk.green(\"Configured\");\n\t\t\t} else {\n\t\t\t\tconst errors = validation.issues.filter((i) => i.severity === \"error\");\n\t\t\t\tconst warnings = validation.issues.filter((i) => i.severity === \"warning\");\n\t\t\t\tif (errors.length > 0) {\n\t\t\t\t\ticon = chalk.red(\"\");\n\t\t\t\t\tstatus = chalk.red(`Invalid (${errors.length} error(s))`);\n\t\t\t\t\thasIssues = true;\n\t\t\t\t} else if (warnings.length > 0) {\n\t\t\t\t\ticon = chalk.yellow(\"\");\n\t\t\t\t\tstatus = chalk.yellow(`Configured (${warnings.length} warning(s))`);\n\t\t\t\t} else {\n\t\t\t\t\ticon = chalk.green(\"\");\n\t\t\t\t\tstatus = chalk.green(\"Configured\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Show validation details in verbose mode (reuse validation from above)\n\t\t\tif (verbose && validation.issues.length > 0) {\n\t\t\t\tconsole.log(`${icon} ${client.displayName.padEnd(20)} ${status}`);\n\t\t\t\tfor (const issue of validation.issues) {\n\t\t\t\t\tconst issueIcon =\n\t\t\t\t\t\tissue.severity === \"error\"\n\t\t\t\t\t\t\t? chalk.red(\"\")\n\t\t\t\t\t\t\t: issue.severity === \"warning\"\n\t\t\t\t\t\t\t\t? chalk.yellow(\"\")\n\t\t\t\t\t\t\t\t: chalk.blue(\"\");\n\t\t\t\t\tconsole.log(`    ${issueIcon} ${issue.message}`);\n\t\t\t\t\tif (issue.fix) {\n\t\t\t\t\t\tconsole.log(chalk.gray(`      Fix: ${issue.fix}`));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t} else {\n\t\t\ticon = chalk.yellow(\"\");\n\t\t\tstatus = chalk.yellow(\"Detected but not configured\");\n\t\t}\n\n\t\tconsole.log(`${icon} ${client.displayName.padEnd(20)} ${status}`);\n\t}\n\n\tconsole.log();\n\n\tif (hasIssues) {\n\t\tconsole.log(chalk.red(\"Some configurations have issues.\"));\n\t\tconsole.log(chalk.gray(\"Run: snap tools repair\"));\n\t} else if (detection.needsSetup.length > 0) {\n\t\tconsole.log(chalk.yellow(`${detection.needsSetup.length} tool(s) need configuration.`));\n\t\tconsole.log(chalk.gray(\"Run: snap tools configure\"));\n\t} else if (detection.detected.length > 0) {\n\t\tconsole.log(chalk.green(\"All detected AI tools are configured!\"));\n\t} else {\n\t\tconsole.log(chalk.gray(\"Install Claude Desktop or Cursor to get started.\"));\n\t}\n}\n\n/**\n * Validate all detected AI tool configurations\n */\nasync function validateTools(verbose = false): Promise<void> {\n\tconst detection = detectAIClients();\n\tconst configured = detection.detected.filter((c) => c.hasSnapback);\n\n\tif (configured.length === 0) {\n\t\tconsole.log(chalk.yellow(\"\\nNo AI tools with SnapBack configured.\"));\n\t\tconsole.log(chalk.gray(\"Run: snap tools configure\"));\n\t\treturn;\n\t}\n\n\tconsole.log(chalk.cyan(\"\\nValidating MCP Configurations:\"));\n\tconsole.log();\n\n\tlet totalErrors = 0;\n\tlet totalWarnings = 0;\n\n\tfor (const client of configured) {\n\t\tconst validation = validateClientConfig(client);\n\t\tconst errors = validation.issues.filter((i) => i.severity === \"error\");\n\t\tconst warnings = validation.issues.filter((i) => i.severity === \"warning\");\n\t\tconst infos = validation.issues.filter((i) => i.severity === \"info\");\n\n\t\ttotalErrors += errors.length;\n\t\ttotalWarnings += warnings.length;\n\n\t\tif (validation.valid && errors.length === 0 && warnings.length === 0) {\n\t\t\tconsole.log(`${chalk.green(\"\")} ${client.displayName}: ${chalk.green(\"Valid\")}`);\n\t\t} else if (errors.length > 0) {\n\t\t\tconsole.log(`${chalk.red(\"\")} ${client.displayName}: ${chalk.red(\"Invalid\")}`);\n\t\t} else {\n\t\t\tconsole.log(`${chalk.yellow(\"\")} ${client.displayName}: ${chalk.yellow(\"Valid with warnings\")}`);\n\t\t}\n\n\t\tif (verbose || errors.length > 0) {\n\t\t\tfor (const issue of [...errors, ...warnings, ...(verbose ? infos : [])]) {\n\t\t\t\tconst icon =\n\t\t\t\t\tissue.severity === \"error\"\n\t\t\t\t\t\t? chalk.red(\"  \")\n\t\t\t\t\t\t: issue.severity === \"warning\"\n\t\t\t\t\t\t\t? chalk.yellow(\"  \")\n\t\t\t\t\t\t\t: chalk.blue(\"  \");\n\t\t\t\tconsole.log(`${icon} ${issue.message}`);\n\t\t\t\tif (issue.fix) {\n\t\t\t\t\tconsole.log(chalk.gray(`    Fix: ${issue.fix}`));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tconsole.log();\n\n\tif (totalErrors > 0) {\n\t\tconsole.log(chalk.red(`Found ${totalErrors} error(s) and ${totalWarnings} warning(s).`));\n\t\tconsole.log(chalk.gray(\"Run: snap tools repair\"));\n\t\tprocess.exit(1);\n\t} else if (totalWarnings > 0) {\n\t\tconsole.log(chalk.yellow(`Found ${totalWarnings} warning(s). Configurations are functional.`));\n\t} else {\n\t\tconsole.log(chalk.green(\"All configurations are valid!\"));\n\t}\n}\n\n/**\n * Repair broken MCP configurations\n */\nasync function repairTools(skipPrompts = false, workspaceOverride?: string, providedApiKey?: string): Promise<void> {\n\tconst detection = detectAIClients();\n\tconst configured = detection.detected.filter((c) => c.hasSnapback);\n\n\tif (configured.length === 0) {\n\t\tconsole.log(chalk.yellow(\"\\nNo AI tools with SnapBack configured.\"));\n\t\tconsole.log(chalk.gray(\"Run: snap tools configure\"));\n\t\treturn;\n\t}\n\n\t// Find clients with issues\n\tconst clientsWithIssues: Array<{ client: AIClientConfig; validation: ValidationResult }> = [];\n\n\tfor (const client of configured) {\n\t\tconst validation = validateClientConfig(client);\n\t\tif (!validation.valid || validation.issues.some((i) => i.severity === \"error\" || i.severity === \"warning\")) {\n\t\t\tclientsWithIssues.push({ client, validation });\n\t\t}\n\t}\n\n\tif (clientsWithIssues.length === 0) {\n\t\tconsole.log(chalk.green(\"\\nAll configurations are healthy! No repairs needed.\"));\n\t\treturn;\n\t}\n\n\tconsole.log(chalk.cyan(\"\\nMCP Configuration Repair:\"));\n\tconsole.log();\n\n\t// Show what needs repair\n\tfor (const { client, validation } of clientsWithIssues) {\n\t\tconst errors = validation.issues.filter((i) => i.severity === \"error\");\n\t\tconst warnings = validation.issues.filter((i) => i.severity === \"warning\");\n\n\t\tconsole.log(`${chalk.yellow(\"\")} ${client.displayName}:`);\n\t\tfor (const issue of [...errors, ...warnings]) {\n\t\t\tconst icon = issue.severity === \"error\" ? chalk.red(\"  \") : chalk.yellow(\"  \");\n\t\t\tconsole.log(`${icon} ${issue.message}`);\n\t\t}\n\t}\n\n\tconsole.log();\n\n\t// Confirm repair\n\tif (!skipPrompts) {\n\t\tconst proceed = await confirm({\n\t\t\tmessage: `Repair ${clientsWithIssues.length} configuration(s)?`,\n\t\t\tdefault: true,\n\t\t});\n\n\t\tif (!proceed) {\n\t\t\tconsole.log(\"\\nRepair cancelled.\");\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Get API key for repair\n\tconst apiKey = await resolveApiKey(providedApiKey, skipPrompts);\n\n\t// Perform repairs\n\tconst spinner = ora(\"Repairing configurations...\").start();\n\n\tlet repaired = 0;\n\tlet failed = 0;\n\n\tfor (const { client } of clientsWithIssues) {\n\t\tspinner.text = `Repairing ${client.displayName}...`;\n\n\t\tconst result = repairClientConfig(client, {\n\t\t\tapiKey,\n\t\t\tworkspaceRoot: workspaceOverride || findWorkspaceRoot(process.cwd()),\n\t\t\tforce: true,\n\t\t});\n\n\t\tif (result.success) {\n\t\t\trepaired++;\n\t\t} else {\n\t\t\tfailed++;\n\t\t\tspinner.warn(`Failed to repair ${client.displayName}: ${result.error}`);\n\t\t}\n\t}\n\n\tspinner.stop();\n\n\tconsole.log();\n\tif (repaired > 0) {\n\t\tconsole.log(chalk.green(` Repaired ${repaired} configuration(s).`));\n\t}\n\tif (failed > 0) {\n\t\tconsole.log(chalk.red(` Failed to repair ${failed} configuration(s).`));\n\t\tconsole.log(chalk.gray(\"Try: snap tools configure --force\"));\n\t}\n\n\tif (repaired > 0) {\n\t\tconsole.log();\n\t\tconsole.log(chalk.bold(\"Next: Restart your AI assistant to apply changes.\"));\n\t}\n}\n\n/**\n * Show next steps after configuration\n */\nfunction showNextSteps(): void {\n\tconsole.log();\n\tconsole.log(chalk.bold(\"Next Steps:\"));\n\tconsole.log();\n\tconsole.log(\"  1. Restart your AI assistant (Claude Desktop, Cursor, etc.)\");\n\tconsole.log('  2. Ask your AI: \"What does SnapBack know about this project?\"');\n\tconsole.log('  3. Before risky changes, ask: \"Create a SnapBack checkpoint\"');\n\tconsole.log();\n\n\tconsole.log(chalk.dim(\"Available tools your AI can now use:\"));\n\tconsole.log(chalk.dim(\"   snapback.get_context      - Understand your codebase\"));\n\tconsole.log(chalk.dim(\"   snapback.analyze_risk     - Assess change risks\"));\n\tconsole.log(chalk.dim(\"   snapback.create_checkpoint - Create safety snapshots (Pro)\"));\n\tconsole.log(chalk.dim(\"   snapback.restore_checkpoint - Recover from mistakes (Pro)\"));\n\tconsole.log();\n\n\tconsole.log(chalk.blue(\"Get an API key: https://console.snapback.dev/settings/api-keys\"));\n\tconsole.log();\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { listTools, autoConfigureTools, configureTool, checkToolsStatus, validateTools, repairTools };\n","/**\n * SnapBack Daemon Protocol\n *\n * JSON-RPC 2.0 protocol for communication between CLI/Extension and daemon.\n * Uses Unix sockets (Linux/macOS) or named pipes (Windows).\n *\n * @module daemon/protocol\n */\n\n// =============================================================================\n// JSON-RPC 2.0 BASE TYPES\n// =============================================================================\n\n/**\n * JSON-RPC 2.0 Request\n */\nexport interface DaemonRequest {\n\tjsonrpc: \"2.0\";\n\tid: string;\n\tmethod: DaemonMethod;\n\tparams: Record<string, unknown>;\n}\n\n/**\n * JSON-RPC 2.0 Response\n */\nexport interface DaemonResponse {\n\tjsonrpc: \"2.0\";\n\tid: string;\n\tresult?: unknown;\n\terror?: DaemonError;\n}\n\n/**\n * JSON-RPC 2.0 Notification (no response expected)\n */\nexport interface DaemonNotification {\n\tjsonrpc: \"2.0\";\n\tmethod: \"notification\";\n\tparams: DaemonEvent;\n}\n\n/**\n * JSON-RPC 2.0 Error\n */\nexport interface DaemonError {\n\tcode: number;\n\tmessage: string;\n\tdata?: unknown;\n}\n\n// =============================================================================\n// ERROR CODES\n// =============================================================================\n\nexport const ErrorCodes = {\n\t// JSON-RPC standard errors\n\tPARSE_ERROR: -32700,\n\tINVALID_REQUEST: -32600,\n\tMETHOD_NOT_FOUND: -32601,\n\tINVALID_PARAMS: -32602,\n\tINTERNAL_ERROR: -32603,\n\n\t// SnapBack-specific errors\n\tDAEMON_NOT_RUNNING: -32000,\n\tWORKSPACE_NOT_FOUND: -32001,\n\tSNAPSHOT_FAILED: -32002,\n\tVALIDATION_FAILED: -32003,\n\tPERMISSION_DENIED: -32004,\n\tTIMEOUT: -32005,\n} as const;\n\n// =============================================================================\n// DAEMON METHODS\n// =============================================================================\n\nexport type DaemonMethod =\n\t// Lifecycle\n\t| \"daemon.ping\"\n\t| \"daemon.status\"\n\t| \"daemon.shutdown\"\n\t| \"daemon.reload\"\n\n\t// Session\n\t| \"session.begin\"\n\t| \"session.end\"\n\t| \"session.status\"\n\t| \"session.review\"\n\t| \"session.changes\"\n\n\t// Snapshots\n\t| \"snapshot.create\"\n\t| \"snapshot.restore\"\n\t| \"snapshot.list\"\n\t| \"snapshot.delete\"\n\n\t// Learnings\n\t| \"learning.add\"\n\t| \"learning.search\"\n\t| \"learning.list\"\n\n\t// Context\n\t| \"context.get\"\n\t| \"context.validate\"\n\t| \"context.check_patterns\"\n\n\t// Validation\n\t| \"validate.quick\"\n\t| \"validate.comprehensive\"\n\n\t// Violations\n\t| \"violation.report\"\n\t| \"violation.list\"\n\n\t// File watching (proactive)\n\t| \"watch.subscribe\"\n\t| \"watch.unsubscribe\"\n\t| \"watch.file_changed\"\n\n\t// MCP coordination (cross-surface events)\n\t| \"snapshot.created\" // Notification from MCP that it created a snapshot\n\t| \"file.modified\"; // Notification from MCP that it modified a file\n\n// =============================================================================\n// METHOD PARAMETERS\n// =============================================================================\n\nexport type PingParams = Record<string, never>;\n\nexport type StatusParams = Record<string, never>;\n\nexport type ShutdownParams = Record<string, never>;\n\nexport interface BeginSessionParams {\n\tworkspace: string;\n\ttask: string;\n\tfiles?: string[];\n\tkeywords?: string[];\n}\n\nexport interface EndSessionParams {\n\tworkspace: string;\n\toutcome?: \"completed\" | \"abandoned\" | \"blocked\";\n\tnotes?: string;\n\tcreateSnapshot?: boolean;\n\tacceptLearnings?: number[];\n}\n\nexport interface SessionStatusParams {\n\tworkspace: string;\n}\n\nexport interface SessionReviewParams {\n\tworkspace: string;\n\tfiles?: string[];\n\tincludeCommitMessage?: boolean;\n\tskipPatterns?: boolean;\n}\n\nexport interface SessionChangesParams {\n\tworkspace: string;\n\tincludeDiff?: boolean;\n\tfilterFiles?: string[];\n\tincludeAIAttribution?: boolean;\n}\n\nexport interface CreateSnapshotParams {\n\tworkspace: string;\n\tfiles: string[];\n\treason?: string;\n\ttrigger?: \"manual\" | \"mcp\" | \"ai_assist\" | \"session_end\";\n}\n\nexport interface RestoreSnapshotParams {\n\tworkspace: string;\n\tsnapshotId: string;\n\tfiles?: string[];\n\tdryRun?: boolean;\n}\n\nexport interface ListSnapshotsParams {\n\tworkspace: string;\n\tlimit?: number;\n\tsince?: string;\n}\n\nexport interface DeleteSnapshotParams {\n\tworkspace: string;\n\tsnapshotId: string;\n}\n\nexport interface AddLearningParams {\n\tworkspace: string;\n\ttype: \"pattern\" | \"pitfall\" | \"efficiency\" | \"discovery\" | \"workflow\";\n\ttrigger: string;\n\taction: string;\n\tsource?: string;\n}\n\nexport interface SearchLearningsParams {\n\tworkspace: string;\n\tkeywords: string[];\n\tlimit?: number;\n}\n\nexport interface ListLearningsParams {\n\tworkspace: string;\n\tlimit?: number;\n}\n\nexport interface GetContextParams {\n\tworkspace: string;\n\ttask: string;\n\tfiles?: string[];\n\tkeywords?: string[];\n}\n\nexport interface ValidateContextParams {\n\tworkspace: string;\n}\n\nexport interface CheckPatternsParams {\n\tworkspace: string;\n\tcode: string;\n\tfilePath: string;\n}\n\nexport interface QuickValidateParams {\n\tworkspace: string;\n\tfile?: string;\n\tfiles?: string[];\n\trunTests?: boolean;\n\tskipTypeScript?: boolean;\n\tskipTests?: boolean;\n\tskipLint?: boolean;\n}\n\nexport interface ComprehensiveValidateParams {\n\tworkspace: string;\n\tcode: string;\n\tfilePath: string;\n}\n\nexport interface ReportViolationParams {\n\tworkspace: string;\n\ttype: string;\n\tfile: string;\n\twhatHappened: string;\n\twhyItHappened: string;\n\tprevention: string;\n}\n\nexport interface ListViolationsParams {\n\tworkspace: string;\n}\n\nexport interface WatchSubscribeParams {\n\tworkspace: string;\n\tpatterns?: string[];\n}\n\nexport interface WatchUnsubscribeParams {\n\tworkspace: string;\n}\n\nexport interface FileChangedParams {\n\tworkspace: string;\n\tfile: string;\n\ttimestamp: number;\n}\n\n// =============================================================================\n// MCP COORDINATION PARAMETERS (Cross-surface events)\n// =============================================================================\n\nexport interface SnapshotCreatedParams {\n\tworkspace: string;\n\tid: string;\n\tfilePath?: string;\n\ttrigger?: \"manual\" | \"auto\" | \"ai-detection\";\n\tsource?: \"mcp\" | \"cli\" | \"extension\";\n}\n\nexport interface SnapshotCreatedResult {\n\tacknowledged: boolean;\n}\n\nexport interface FileModifiedParams {\n\tworkspace: string;\n\tpath: string;\n\tlinesChanged?: number;\n\taiAttributed?: boolean;\n}\n\nexport interface FileModifiedResult {\n\tacknowledged: boolean;\n}\n\n// =============================================================================\n// METHOD RESPONSES\n// =============================================================================\n\nexport interface PingResult {\n\tpong: true;\n\tuptime: number;\n\tversion: string;\n}\n\nexport interface StatusResult {\n\tpid: number;\n\tversion: string;\n\tuptime: number;\n\tstartedAt: string;\n\tworkspaces: number;\n\tconnections: number;\n\tmemoryUsage: {\n\t\theapUsed: number;\n\t\theapTotal: number;\n\t\trss: number;\n\t};\n\tidleTimeout: number;\n\tlastActivity: number;\n}\n\nexport interface ShutdownResult {\n\tshutting_down: true;\n}\n\nexport interface BeginSessionResult {\n\ttaskId: string;\n\tsnapshot?: {\n\t\tcreated: boolean;\n\t\tsnapshotId?: string;\n\t\treason: string;\n\t};\n\tpatterns: unknown[];\n\tconstraints: unknown[];\n\tlearnings: unknown[];\n\triskAssessment: {\n\t\toverallRisk: \"low\" | \"medium\" | \"high\";\n\t\triskAreas: string[];\n\t\trecommendations: string[];\n\t};\n\tnextActions: Array<{\n\t\ttool: string;\n\t\tpriority: number;\n\t\treason: string;\n\t}>;\n}\n\nexport interface EndSessionResult {\n\tsummary: {\n\t\tfilesModified: number;\n\t\tlinesChanged: number;\n\t\tduration: number;\n\t};\n\tsnapshot?: {\n\t\tcreated: boolean;\n\t\tsnapshotId?: string;\n\t};\n\tlearningsAccepted: number;\n}\n\nexport interface SessionStatusResult {\n\tactive: boolean;\n\ttaskId?: string;\n\ttask?: string;\n\tstartedAt?: string;\n\tfilesModified: number;\n\tsnapshotCount: number;\n}\n\nexport interface SessionReviewResult {\n\treadyToCommit: boolean;\n\tvalidation: {\n\t\tpassed: boolean;\n\t\tissues: unknown[];\n\t};\n\tchanges: {\n\t\tfilesModified: number;\n\t\tlinesChanged: number;\n\t};\n\tsuggestedCommitMessage?: string;\n\tsuggestedLearnings: unknown[];\n}\n\nexport interface SessionChangesResult {\n\tfiles: Array<{\n\t\tpath: string;\n\t\tstatus: \"created\" | \"modified\" | \"deleted\";\n\t\tlinesChanged: number;\n\t\taiAttributed?: boolean;\n\t}>;\n\ttotalLinesChanged: number;\n\triskAssessment: {\n\t\toverallRisk: \"low\" | \"medium\" | \"high\";\n\t};\n}\n\nexport interface CreateSnapshotResult {\n\tsnapshotId: string;\n\tfileCount: number;\n\ttotalSize: number;\n\tcreatedAt: string;\n\tdeduplicated: boolean;\n}\n\nexport interface RestoreSnapshotResult {\n\trestored: boolean;\n\tfilesRestored: number;\n\tdryRun: boolean;\n\tchanges?: Array<{\n\t\tfile: string;\n\t\taction: \"restore\" | \"create\" | \"skip\";\n\t}>;\n}\n\nexport interface ListSnapshotsResult {\n\tsnapshots: Array<{\n\t\tid: string;\n\t\treason?: string;\n\t\tfileCount: number;\n\t\ttotalSize: number;\n\t\tcreatedAt: string;\n\t\ttrigger: string;\n\t}>;\n\ttotal: number;\n}\n\nexport interface AddLearningResult {\n\tlearningId: string;\n\tmessage: string;\n}\n\nexport interface SearchLearningsResult {\n\tlearnings: unknown[];\n\tcount: number;\n}\n\nexport interface GetContextResult {\n\tpatterns: unknown[];\n\tconstraints: unknown[];\n\tlearnings: unknown[];\n\tobservations: unknown[];\n\triskAssessment: {\n\t\toverallRisk: \"low\" | \"medium\" | \"high\";\n\t\triskAreas: string[];\n\t\trecommendations: string[];\n\t};\n}\n\nexport interface CheckPatternsResult {\n\tpassed: boolean;\n\tviolations: unknown[];\n\tsuggestions: string[];\n}\n\nexport interface QuickValidateResult {\n\tpassed: boolean;\n\ttypescript?: {\n\t\tpassed: boolean;\n\t\terrors: number;\n\t};\n\ttests?: {\n\t\tdiscovered: number;\n\t\tpassed?: number;\n\t\tfailed?: number;\n\t};\n\tlint?: {\n\t\tpassed: boolean;\n\t\terrors: number;\n\t\twarnings: number;\n\t};\n}\n\nexport interface ReportViolationResult {\n\tviolationId: string;\n\tcount: number;\n\tpromoted: boolean;\n\tpromotedTo?: \"pattern\" | \"automation\";\n}\n\n// =============================================================================\n// DAEMON EVENTS (Push Notifications)\n// =============================================================================\n\nexport type DaemonEventType =\n\t| \"snapshot.created\"\n\t| \"snapshot.restored\"\n\t| \"risk.detected\"\n\t| \"session.started\"\n\t| \"session.ended\"\n\t| \"learning.matched\"\n\t| \"validation.failed\"\n\t| \"daemon.shutting_down\";\n\nexport interface DaemonEvent {\n\ttype: DaemonEventType;\n\ttimestamp: number;\n\tworkspace?: string;\n\tdata: unknown;\n}\n\nexport interface RiskDetectedEvent {\n\ttype: \"risk.detected\";\n\ttimestamp: number;\n\tworkspace: string;\n\tdata: {\n\t\tfile: string;\n\t\triskLevel: \"low\" | \"medium\" | \"high\";\n\t\treason: string;\n\t\tsuggestion: string;\n\t};\n}\n\nexport interface SnapshotCreatedEvent {\n\ttype: \"snapshot.created\";\n\ttimestamp: number;\n\tworkspace: string;\n\tdata: {\n\t\tsnapshotId: string;\n\t\tfileCount: number;\n\t\treason?: string;\n\t};\n}\n\nexport interface SessionSavedEvent {\n\ttype: \"session.ended\";\n\ttimestamp: number;\n\tworkspace: string;\n\tdata: {\n\t\trestoredFromDisaster?: boolean;\n\t\tlinesRecovered?: number;\n\t\ttimeAgo?: string;\n\t};\n}\n\n// =============================================================================\n// WORKSPACE CONTEXT\n// =============================================================================\n\nexport interface WorkspaceContext {\n\tid: string;\n\troot: string;\n\tinitialized: boolean;\n\tsessionActive: boolean;\n\tcurrentTaskId?: string;\n\t/** Timestamp when session was started (for duration calculation) */\n\tsessionStartedAt?: number;\n\tsnapshotCount: number;\n\tlastActivity: number;\n\tsubscribers: Set<string>;\n}\n\n// =============================================================================\n// DAEMON STATE\n// =============================================================================\n\nexport interface DaemonState {\n\tpid: number;\n\tversion: string;\n\tstartedAt: number;\n\tlastActivity: number;\n\tworkspaces: Map<string, WorkspaceContext>;\n\tconnectionCount: number;\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Create a successful response\n */\nexport function createResponse(id: string, result: unknown): DaemonResponse {\n\treturn {\n\t\tjsonrpc: \"2.0\",\n\t\tid,\n\t\tresult,\n\t};\n}\n\n/**\n * Create an error response\n */\nexport function createErrorResponse(id: string, code: number, message: string, data?: unknown): DaemonResponse {\n\treturn {\n\t\tjsonrpc: \"2.0\",\n\t\tid,\n\t\terror: { code, message, data },\n\t};\n}\n\n/**\n * Create a notification (no id, no response expected)\n */\nexport function createNotification(event: DaemonEvent): DaemonNotification {\n\treturn {\n\t\tjsonrpc: \"2.0\",\n\t\tmethod: \"notification\",\n\t\tparams: event,\n\t};\n}\n\n/**\n * Parse a request from a line of text\n */\nexport function parseRequest(line: string): DaemonRequest {\n\tconst parsed = JSON.parse(line);\n\tif (parsed.jsonrpc !== \"2.0\" || !parsed.id || !parsed.method) {\n\t\tthrow new Error(\"Invalid JSON-RPC 2.0 request\");\n\t}\n\treturn parsed as DaemonRequest;\n}\n\n/**\n * Serialize a response to a line of text\n */\nexport function serializeResponse(response: DaemonResponse | DaemonNotification): string {\n\treturn `${JSON.stringify(response)}\\n`;\n}\n","/**\n * SnapBack Daemon Error Types\n *\n * Custom error classes for daemon operations with proper error codes\n * and context information for debugging.\n *\n * @module daemon/errors\n */\n\nimport { ErrorCodes } from \"./protocol.js\";\n\n// =============================================================================\n// BASE DAEMON ERROR\n// =============================================================================\n\n/**\n * Base error class for all daemon errors\n */\nexport class DaemonError extends Error {\n\tconstructor(\n\t\tpublic readonly code: number,\n\t\tmessage: string,\n\t\tpublic readonly context?: Record<string, unknown>,\n\t) {\n\t\tsuper(message);\n\t\tthis.name = \"DaemonError\";\n\t\tError.captureStackTrace?.(this, this.constructor);\n\t}\n\n\t/**\n\t * Convert to JSON-RPC error format\n\t */\n\ttoJsonRpcError(): { code: number; message: string; data?: unknown } {\n\t\treturn {\n\t\t\tcode: this.code,\n\t\t\tmessage: this.message,\n\t\t\tdata: this.context,\n\t\t};\n\t}\n}\n\n// =============================================================================\n// SPECIFIC ERROR TYPES\n// =============================================================================\n\n/**\n * Parse error - Invalid JSON\n */\nexport class ParseError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.PARSE_ERROR, message, context);\n\t\tthis.name = \"ParseError\";\n\t}\n}\n\n/**\n * Invalid request - Not a valid JSON-RPC request\n */\nexport class InvalidRequestError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.INVALID_REQUEST, message, context);\n\t\tthis.name = \"InvalidRequestError\";\n\t}\n}\n\n/**\n * Method not found\n */\nexport class MethodNotFoundError extends DaemonError {\n\tconstructor(method: string) {\n\t\tsuper(ErrorCodes.METHOD_NOT_FOUND, `Unknown method: ${method}`, { method });\n\t\tthis.name = \"MethodNotFoundError\";\n\t}\n}\n\n/**\n * Invalid params\n */\nexport class InvalidParamsError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.INVALID_PARAMS, message, context);\n\t\tthis.name = \"InvalidParamsError\";\n\t}\n}\n\n/**\n * Internal error\n */\nexport class InternalError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.INTERNAL_ERROR, message, context);\n\t\tthis.name = \"InternalError\";\n\t}\n}\n\n/**\n * Daemon not running\n */\nexport class DaemonNotRunningError extends DaemonError {\n\tconstructor() {\n\t\tsuper(ErrorCodes.DAEMON_NOT_RUNNING, \"Daemon is not running\");\n\t\tthis.name = \"DaemonNotRunningError\";\n\t}\n}\n\n/**\n * Workspace not found\n */\nexport class WorkspaceNotFoundError extends DaemonError {\n\tconstructor(workspace: string) {\n\t\tsuper(ErrorCodes.WORKSPACE_NOT_FOUND, `Workspace not found: ${workspace}`, { workspace });\n\t\tthis.name = \"WorkspaceNotFoundError\";\n\t}\n}\n\n/**\n * Snapshot operation failed\n */\nexport class SnapshotError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.SNAPSHOT_FAILED, message, context);\n\t\tthis.name = \"SnapshotError\";\n\t}\n}\n\n/**\n * Validation failed\n */\nexport class ValidationError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.VALIDATION_FAILED, message, context);\n\t\tthis.name = \"ValidationError\";\n\t}\n}\n\n/**\n * Permission denied\n */\nexport class PermissionDeniedError extends DaemonError {\n\tconstructor(message: string, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.PERMISSION_DENIED, message, context);\n\t\tthis.name = \"PermissionDeniedError\";\n\t}\n}\n\n/**\n * Request timeout\n */\nexport class TimeoutError extends DaemonError {\n\tconstructor(operation: string, timeoutMs: number) {\n\t\tsuper(ErrorCodes.TIMEOUT, `Operation timed out after ${timeoutMs}ms: ${operation}`, {\n\t\t\toperation,\n\t\t\ttimeoutMs,\n\t\t});\n\t\tthis.name = \"TimeoutError\";\n\t}\n}\n\n/**\n * Path traversal attack detected\n */\nexport class PathTraversalError extends DaemonError {\n\tconstructor(path: string) {\n\t\tsuper(ErrorCodes.PERMISSION_DENIED, `Path traversal detected: ${path}`, { path });\n\t\tthis.name = \"PathTraversalError\";\n\t}\n}\n\n/**\n * Request too large\n */\nexport class RequestTooLargeError extends DaemonError {\n\tconstructor(size: number, maxSize: number) {\n\t\tsuper(ErrorCodes.INVALID_REQUEST, `Request too large: ${size} bytes (max: ${maxSize})`, {\n\t\t\tsize,\n\t\t\tmaxSize,\n\t\t});\n\t\tthis.name = \"RequestTooLargeError\";\n\t}\n}\n\n/**\n * Not implemented\n */\nexport class NotImplementedError extends DaemonError {\n\tconstructor(feature: string) {\n\t\tsuper(ErrorCodes.INTERNAL_ERROR, `Not implemented: ${feature}`, { feature });\n\t\tthis.name = \"NotImplementedError\";\n\t}\n}\n\n/**\n * Connection error (transient)\n */\nexport class ConnectionError extends DaemonError {\n\tpublic readonly isTransient: boolean;\n\n\tconstructor(message: string, isTransient = true, context?: Record<string, unknown>) {\n\t\tsuper(ErrorCodes.DAEMON_NOT_RUNNING, message, context);\n\t\tthis.name = \"ConnectionError\";\n\t\tthis.isTransient = isTransient;\n\t}\n}\n\n// =============================================================================\n// ERROR UTILITIES\n// =============================================================================\n\n/**\n * Check if an error is a DaemonError\n */\nexport function isDaemonError(error: unknown): error is DaemonError {\n\treturn error instanceof DaemonError;\n}\n\n/**\n * Convert any error to a DaemonError\n */\nexport function toDaemonError(error: unknown): DaemonError {\n\tif (isDaemonError(error)) {\n\t\treturn error;\n\t}\n\n\tif (error instanceof Error) {\n\t\treturn new InternalError(error.message, { originalError: error.name, stack: error.stack });\n\t}\n\n\treturn new InternalError(String(error));\n}\n\n/**\n * Check if an error is transient (can be retried)\n */\nexport function isTransientError(error: unknown): boolean {\n\tif (error instanceof ConnectionError) {\n\t\treturn error.isTransient;\n\t}\n\tif (error instanceof TimeoutError) {\n\t\treturn true;\n\t}\n\treturn false;\n}\n","/**\n * SnapBack Daemon Client\n *\n * Client for communicating with the SnapBack daemon.\n * Features:\n * - Lazy connection (connects on first request)\n * - Auto-start daemon if not running\n * - Exponential backoff reconnection\n * - Request/response correlation with retry logic\n * - Timeout handling with configurable limits\n * - Connection health monitoring\n * - Cross-platform support (Unix sockets / Windows named pipes)\n *\n * @module daemon/client\n */\n\nimport type { ChildProcess } from \"node:child_process\";\nimport { spawn } from \"node:child_process\";\nimport { EventEmitter } from \"node:events\";\nimport { existsSync, readFileSync } from \"node:fs\";\nimport { connect, type Socket } from \"node:net\";\nimport { platform } from \"node:os\";\n\nimport { ConnectionError, DaemonError, TimeoutError } from \"./errors.js\";\nimport type {\n\tBeginSessionResult,\n\tCreateSnapshotResult,\n\tDaemonMethod,\n\tDaemonNotification,\n\tDaemonResponse,\n\tPingResult,\n\tStatusResult,\n} from \"./protocol.js\";\n\n// =============================================================================\n// PLATFORM DETECTION\n// =============================================================================\n\nconst IS_WINDOWS = platform() === \"win32\";\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\n/** Default request timeout in milliseconds */\nconst DEFAULT_REQUEST_TIMEOUT_MS = 30_000;\n\n/** Maximum reconnection attempts before giving up */\nconst MAX_RECONNECT_ATTEMPTS = 5;\n\n/** Base delay for exponential backoff (milliseconds) */\nconst RECONNECT_BASE_DELAY_MS = 100;\n\n/** Maximum delay between reconnection attempts (milliseconds) */\nconst RECONNECT_MAX_DELAY_MS = 5_000;\n\n/** Number of retries for transient failures */\nconst DEFAULT_REQUEST_RETRIES = 2;\n\n/** Delay before daemon process is considered started */\nconst DAEMON_START_WAIT_MS = 1_000;\n\n/** Maximum time to wait for daemon to start */\nconst DAEMON_START_TIMEOUT_MS = 10_000;\n\n/** Health check interval in milliseconds */\nconst HEALTH_CHECK_INTERVAL_MS = 30_000;\n\n// =============================================================================\n// CLIENT CONFIGURATION\n// =============================================================================\n\nexport interface DaemonClientConfig {\n\t/** Path to Unix socket or Windows named pipe */\n\tsocketPath: string;\n\t/** Path to PID file */\n\tpidPath: string;\n\t/** Path to daemon executable (for auto-start) */\n\tdaemonPath?: string;\n\t/** Whether to auto-start daemon if not running (default: true) */\n\tautoStart?: boolean;\n\t/** Request timeout in milliseconds (default: 30000) */\n\trequestTimeout?: number;\n\t/** Maximum reconnection attempts (default: 5) */\n\tmaxReconnectAttempts?: number;\n\t/** Number of retries for failed requests (default: 2) */\n\trequestRetries?: number;\n\t/** Enable connection health monitoring (default: true) */\n\tenableHealthCheck?: boolean;\n\t/** Health check interval in milliseconds (default: 30000) */\n\thealthCheckInterval?: number;\n}\n\n// =============================================================================\n// CLIENT EVENTS\n// =============================================================================\n\nexport interface DaemonClientEvents {\n\tconnected: [];\n\tdisconnected: [];\n\treconnecting: [attempt: number, maxAttempts: number];\n\treconnected: [];\n\terror: [error: Error];\n\tnotification: [notification: DaemonNotification];\n\thealthCheck: [healthy: boolean, latencyMs: number];\n}\n\n// =============================================================================\n// CONNECTION STATE\n// =============================================================================\n\nenum ConnectionState {\n\tDisconnected = \"disconnected\",\n\tConnecting = \"connecting\",\n\tConnected = \"connected\",\n\tReconnecting = \"reconnecting\",\n}\n\n// =============================================================================\n// PENDING REQUEST TRACKING\n// =============================================================================\n\ninterface PendingRequest {\n\tresolve: (value: unknown) => void;\n\treject: (err: Error) => void;\n\tmethod: string;\n\tparams: Record<string, unknown>;\n\tstartTime: number;\n\tretries: number;\n\ttimeoutId: NodeJS.Timeout;\n}\n\n// =============================================================================\n// DAEMON CLIENT CLASS\n// =============================================================================\n\nexport class DaemonClient extends EventEmitter<DaemonClientEvents> {\n\tprivate socket: Socket | null = null;\n\tprivate requestId = 0;\n\tprivate pending = new Map<string, PendingRequest>();\n\tprivate buffer = \"\";\n\tprivate connectionState = ConnectionState.Disconnected;\n\tprivate reconnectAttempts = 0;\n\tprivate healthCheckTimer: NodeJS.Timeout | null = null;\n\tprivate daemonProcess: ChildProcess | null = null;\n\n\tconstructor(private readonly config: DaemonClientConfig) {\n\t\tsuper();\n\t}\n\n\t// =========================================================================\n\t// PUBLIC API - CONNECTION MANAGEMENT\n\t// =========================================================================\n\n\t/**\n\t * Connect to the daemon\n\t *\n\t * If auto-start is enabled and daemon is not running, will attempt to start it.\n\t * Uses exponential backoff for connection retries.\n\t */\n\tasync connect(): Promise<void> {\n\t\tif (this.connectionState === ConnectionState.Connected) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.connectionState === ConnectionState.Connecting) {\n\t\t\t// Wait for existing connection attempt\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst onConnected = () => {\n\t\t\t\t\tthis.off(\"error\", onError);\n\t\t\t\t\tresolve();\n\t\t\t\t};\n\t\t\t\tconst onError = (err: Error) => {\n\t\t\t\t\tthis.off(\"connected\", onConnected);\n\t\t\t\t\treject(err);\n\t\t\t\t};\n\t\t\t\tthis.once(\"connected\", onConnected);\n\t\t\t\tthis.once(\"error\", onError);\n\t\t\t});\n\t\t}\n\n\t\tthis.connectionState = ConnectionState.Connecting;\n\n\t\ttry {\n\t\t\t// Check if daemon is running, optionally auto-start\n\t\t\tconst running = await this.ensureDaemonRunning();\n\t\t\tif (!running) {\n\t\t\t\tthrow new ConnectionError(\"Failed to connect: daemon is not running\");\n\t\t\t}\n\n\t\t\tawait this.establishConnection();\n\n\t\t\t// Start health check if enabled\n\t\t\tif (this.config.enableHealthCheck !== false) {\n\t\t\t\tthis.startHealthCheck();\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\t/**\n\t * Disconnect from the daemon gracefully\n\t *\n\t * Cancels all pending requests and closes the socket connection.\n\t */\n\tasync disconnect(): Promise<void> {\n\t\tthis.stopHealthCheck();\n\n\t\t// Cancel all pending requests\n\t\tfor (const [id, pending] of this.pending) {\n\t\t\tclearTimeout(pending.timeoutId);\n\t\t\tpending.reject(new ConnectionError(\"Client disconnected\"));\n\t\t\tthis.pending.delete(id);\n\t\t}\n\n\t\tif (!this.socket) {\n\t\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\t\treturn;\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tconst socket = this.socket;\n\t\t\tif (socket) {\n\t\t\t\tconst cleanup = () => {\n\t\t\t\t\tthis.socket = null;\n\t\t\t\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\t\t\t\tthis.buffer = \"\";\n\t\t\t\t\tresolve();\n\t\t\t\t};\n\n\t\t\t\tsocket.once(\"close\", cleanup);\n\t\t\t\tsocket.end();\n\n\t\t\t\t// Force close after timeout\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tif (this.socket === socket) {\n\t\t\t\t\t\tsocket.destroy();\n\t\t\t\t\t\tcleanup();\n\t\t\t\t\t}\n\t\t\t\t}, 1000);\n\t\t\t} else {\n\t\t\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Check if connected to daemon\n\t */\n\tisConnected(): boolean {\n\t\treturn this.connectionState === ConnectionState.Connected;\n\t}\n\n\t/**\n\t * Get the current connection state\n\t */\n\tgetConnectionState(): ConnectionState {\n\t\treturn this.connectionState;\n\t}\n\n\t// =========================================================================\n\t// PUBLIC API - REQUEST METHODS\n\t// =========================================================================\n\n\t/**\n\t * Send a request to the daemon\n\t *\n\t * Automatically connects if not already connected.\n\t * Implements retry logic for transient failures.\n\t */\n\tasync request<T = unknown>(method: DaemonMethod | string, params: Record<string, unknown> = {}): Promise<T> {\n\t\t// Ensure connected\n\t\tif (this.connectionState !== ConnectionState.Connected) {\n\t\t\tawait this.connect();\n\t\t}\n\n\t\tconst maxRetries = this.config.requestRetries ?? DEFAULT_REQUEST_RETRIES;\n\t\treturn this.executeRequest<T>(method, params, maxRetries);\n\t}\n\n\t// =========================================================================\n\t// CONVENIENCE METHODS\n\t// =========================================================================\n\n\t/**\n\t * Ping the daemon to check if it's responsive\n\t */\n\tasync ping(): Promise<PingResult> {\n\t\treturn this.request<PingResult>(\"daemon.ping\", {});\n\t}\n\n\t/**\n\t * Get daemon status including memory usage and connection count\n\t */\n\tasync status(): Promise<StatusResult> {\n\t\treturn this.request<StatusResult>(\"daemon.status\", {});\n\t}\n\n\t/**\n\t * Begin a task session for the given workspace\n\t */\n\tasync beginTask(\n\t\tworkspace: string,\n\t\ttask: string,\n\t\tfiles?: string[],\n\t\tkeywords?: string[],\n\t): Promise<BeginSessionResult> {\n\t\treturn this.request<BeginSessionResult>(\"session.begin\", {\n\t\t\tworkspace,\n\t\t\ttask,\n\t\t\tfiles,\n\t\t\tkeywords,\n\t\t});\n\t}\n\n\t/**\n\t * End the current task session\n\t */\n\tasync endTask(\n\t\tworkspace: string,\n\t\toutcome?: \"completed\" | \"abandoned\" | \"blocked\",\n\t): Promise<{\n\t\tsummary: { filesModified: number; linesChanged: number; duration: number };\n\t\tsnapshot: { created: boolean };\n\t\tlearningsAccepted: number;\n\t}> {\n\t\treturn this.request(\"session.end\", {\n\t\t\tworkspace,\n\t\t\toutcome,\n\t\t});\n\t}\n\n\t/**\n\t * Get session status for a workspace\n\t */\n\tasync sessionStatus(workspace: string): Promise<{\n\t\tactive: boolean;\n\t\ttaskId?: string;\n\t\ttask?: string;\n\t\tstartedAt?: string;\n\t\tfilesModified: number;\n\t\tsnapshotCount: number;\n\t}> {\n\t\treturn this.request(\"session.status\", { workspace });\n\t}\n\n\t/**\n\t * Create a snapshot of the specified files\n\t */\n\tasync createSnapshot(workspace: string, files: string[], reason?: string): Promise<CreateSnapshotResult> {\n\t\treturn this.request<CreateSnapshotResult>(\"snapshot.create\", {\n\t\t\tworkspace,\n\t\t\tfiles,\n\t\t\treason,\n\t\t});\n\t}\n\n\t/**\n\t * Restore files from a snapshot\n\t */\n\tasync restoreSnapshot(\n\t\tworkspace: string,\n\t\tsnapshotId: string,\n\t\toptions?: { files?: string[]; dryRun?: boolean },\n\t): Promise<{\n\t\trestored: boolean;\n\t\tfilesRestored: number;\n\t\tdryRun: boolean;\n\t\tchanges: Array<{ file: string; action: string }>;\n\t}> {\n\t\treturn this.request(\"snapshot.restore\", {\n\t\t\tworkspace,\n\t\t\tsnapshotId,\n\t\t\tfiles: options?.files,\n\t\t\tdryRun: options?.dryRun,\n\t\t});\n\t}\n\n\t/**\n\t * List snapshots for a workspace\n\t */\n\tasync listSnapshots(\n\t\tworkspace: string,\n\t\tlimit?: number,\n\t): Promise<{\n\t\tsnapshots: Array<{\n\t\t\tid: string;\n\t\t\tcreatedAt: string;\n\t\t\tfileCount: number;\n\t\t\treason?: string;\n\t\t}>;\n\t\ttotal: number;\n\t}> {\n\t\treturn this.request(\"snapshot.list\", {\n\t\t\tworkspace,\n\t\t\tlimit,\n\t\t});\n\t}\n\n\t/**\n\t * Get context for a task (patterns, constraints, learnings)\n\t */\n\tasync getContext(\n\t\tworkspace: string,\n\t\ttask: string,\n\t\tfiles?: string[],\n\t\tkeywords?: string[],\n\t): Promise<{\n\t\tpatterns: unknown[];\n\t\tconstraints: unknown[];\n\t\tlearnings: unknown[];\n\t\tobservations: unknown[];\n\t\triskAssessment: {\n\t\t\toverallRisk: string;\n\t\t\triskAreas: unknown[];\n\t\t\trecommendations: unknown[];\n\t\t};\n\t}> {\n\t\treturn this.request(\"context.get\", {\n\t\t\tworkspace,\n\t\t\ttask,\n\t\t\tfiles,\n\t\t\tkeywords,\n\t\t});\n\t}\n\n\t/**\n\t * Add a learning to the knowledge base\n\t */\n\tasync addLearning(\n\t\tworkspace: string,\n\t\ttype: \"pattern\" | \"pitfall\" | \"efficiency\" | \"discovery\" | \"workflow\",\n\t\ttrigger: string,\n\t\taction: string,\n\t): Promise<{ learningId: string; message: string }> {\n\t\treturn this.request(\"learning.add\", {\n\t\t\tworkspace,\n\t\t\ttype,\n\t\t\ttrigger,\n\t\t\taction,\n\t\t});\n\t}\n\n\t/**\n\t * Search learnings by keywords\n\t */\n\tasync searchLearnings(\n\t\tworkspace: string,\n\t\tkeywords: string[],\n\t): Promise<{\n\t\tlearnings: unknown[];\n\t\tcount: number;\n\t}> {\n\t\treturn this.request(\"learning.search\", {\n\t\t\tworkspace,\n\t\t\tkeywords,\n\t\t});\n\t}\n\n\t/**\n\t * Run quick validation on files\n\t */\n\tasync quickCheck(\n\t\tworkspace: string,\n\t\toptions?: { file?: string; files?: string[] },\n\t): Promise<{\n\t\tpassed: boolean;\n\t\ttypescript: { passed: boolean; errors: number };\n\t\ttests: { discovered: number };\n\t\tlint: { passed: boolean; errors: number; warnings: number };\n\t}> {\n\t\treturn this.request(\"validate.quick\", {\n\t\t\tworkspace,\n\t\t\tfile: options?.file,\n\t\t\tfiles: options?.files,\n\t\t});\n\t}\n\n\t/**\n\t * Request the daemon to reload its configuration\n\t */\n\tasync reload(): Promise<{ reloaded: true }> {\n\t\treturn this.request(\"daemon.reload\", {});\n\t}\n\n\t/**\n\t * Request the daemon to shutdown gracefully\n\t */\n\tasync shutdown(): Promise<void> {\n\t\ttry {\n\t\t\tawait this.request(\"daemon.shutdown\", {});\n\t\t} catch {\n\t\t\t// Ignore errors - daemon may close connection before responding\n\t\t}\n\t\tawait this.disconnect();\n\t}\n\n\t// =========================================================================\n\t// PRIVATE - CONNECTION MANAGEMENT\n\t// =========================================================================\n\n\t/**\n\t * Ensure the daemon is running, starting it if necessary\n\t */\n\tprivate async ensureDaemonRunning(): Promise<boolean> {\n\t\tif (await this.isDaemonRunning()) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (this.config.autoStart === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.startDaemon();\n\t}\n\n\t/**\n\t * Check if the daemon process is running\n\t */\n\tprivate async isDaemonRunning(): Promise<boolean> {\n\t\ttry {\n\t\t\tif (!existsSync(this.config.pidPath)) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst pidContent = readFileSync(this.config.pidPath, \"utf-8\").trim();\n\t\t\tconst pid = Number.parseInt(pidContent, 10);\n\n\t\t\tif (Number.isNaN(pid) || pid <= 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Check if process exists by sending signal 0\n\t\t\t// This doesn't actually send a signal, just checks if process exists\n\t\t\tprocess.kill(pid, 0);\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Start the daemon process\n\t */\n\tprivate async startDaemon(): Promise<boolean> {\n\t\tconst daemonPath = this.config.daemonPath;\n\t\tif (!daemonPath) {\n\t\t\tthrow new ConnectionError(\"Cannot auto-start daemon: daemonPath not configured\");\n\t\t}\n\n\t\tif (!existsSync(daemonPath)) {\n\t\t\tthrow new ConnectionError(`Daemon executable not found: ${daemonPath}`);\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst startTime = Date.now();\n\n\t\t\t// Spawn daemon as detached process\n\t\t\tconst args = [\"--socket\", this.config.socketPath, \"--pid\", this.config.pidPath];\n\n\t\t\tthis.daemonProcess = spawn(daemonPath, args, {\n\t\t\t\tdetached: true,\n\t\t\t\tstdio: \"ignore\",\n\t\t\t\t// On Windows, use shell to handle .cmd/.bat files\n\t\t\t\tshell: IS_WINDOWS,\n\t\t\t});\n\n\t\t\t// Unref to allow parent to exit independently\n\t\t\tthis.daemonProcess.unref();\n\n\t\t\tthis.daemonProcess.on(\"error\", (err) => {\n\t\t\t\tthis.daemonProcess = null;\n\t\t\t\treject(new ConnectionError(`Failed to start daemon: ${err.message}`));\n\t\t\t});\n\n\t\t\t// Poll for daemon to be ready\n\t\t\tconst checkDaemon = async () => {\n\t\t\t\tconst elapsed = Date.now() - startTime;\n\n\t\t\t\tif (elapsed > DAEMON_START_TIMEOUT_MS) {\n\t\t\t\t\treject(new ConnectionError(\"Daemon start timeout\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (await this.isDaemonRunning()) {\n\t\t\t\t\t// Give daemon a moment to set up socket\n\t\t\t\t\tsetTimeout(() => resolve(true), DAEMON_START_WAIT_MS);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Check again after delay\n\t\t\t\tsetTimeout(checkDaemon, 200);\n\t\t\t};\n\n\t\t\t// Start checking after initial delay\n\t\t\tsetTimeout(checkDaemon, DAEMON_START_WAIT_MS);\n\t\t});\n\t}\n\n\t/**\n\t * Establish socket connection to daemon\n\t */\n\tprivate async establishConnection(): Promise<void> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst socket = connect(this.config.socketPath);\n\t\t\tlet settled = false;\n\n\t\t\tconst handleError = (err: Error) => {\n\t\t\t\tif (settled) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsettled = true;\n\t\t\t\tthis.socket = null;\n\t\t\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\t\t\treject(new ConnectionError(`Connection failed: ${err.message}`));\n\t\t\t};\n\n\t\t\tconst handleConnect = () => {\n\t\t\t\tif (settled) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsettled = true;\n\n\t\t\t\tthis.socket = socket;\n\t\t\t\tthis.connectionState = ConnectionState.Connected;\n\t\t\t\tthis.reconnectAttempts = 0;\n\n\t\t\t\t// Set up persistent event handlers\n\t\t\t\tsocket.off(\"error\", handleError);\n\t\t\t\tsocket.on(\"error\", this.handleSocketError.bind(this));\n\t\t\t\tsocket.on(\"close\", this.handleSocketClose.bind(this));\n\t\t\t\tsocket.on(\"data\", this.handleSocketData.bind(this));\n\n\t\t\t\tthis.emit(\"connected\");\n\t\t\t\tresolve();\n\t\t\t};\n\n\t\t\t// Set up connection timeout\n\t\t\tconst timeoutId = setTimeout(() => {\n\t\t\t\tif (!settled) {\n\t\t\t\t\tsettled = true;\n\t\t\t\t\tsocket.destroy();\n\t\t\t\t\treject(new TimeoutError(\"connect\", 5000));\n\t\t\t\t}\n\t\t\t}, 5000);\n\n\t\t\tsocket.once(\"error\", handleError);\n\t\t\tsocket.once(\"connect\", () => {\n\t\t\t\tclearTimeout(timeoutId);\n\t\t\t\thandleConnect();\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Handle socket error event\n\t */\n\tprivate handleSocketError(err: Error): void {\n\t\tthis.emit(\"error\", err);\n\n\t\t// Reject all pending requests\n\t\tfor (const [id, pending] of this.pending) {\n\t\t\tclearTimeout(pending.timeoutId);\n\t\t\tpending.reject(new ConnectionError(`Socket error: ${err.message}`));\n\t\t\tthis.pending.delete(id);\n\t\t}\n\t}\n\n\t/**\n\t * Handle socket close event\n\t */\n\tprivate handleSocketClose(): void {\n\t\tconst wasConnected = this.connectionState === ConnectionState.Connected;\n\t\tthis.socket = null;\n\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\tthis.buffer = \"\";\n\n\t\tif (wasConnected) {\n\t\t\tthis.emit(\"disconnected\");\n\t\t\tthis.attemptReconnect();\n\t\t}\n\t}\n\n\t/**\n\t * Attempt to reconnect with exponential backoff\n\t */\n\tprivate async attemptReconnect(): Promise<void> {\n\t\tconst maxAttempts = this.config.maxReconnectAttempts ?? MAX_RECONNECT_ATTEMPTS;\n\n\t\tif (this.reconnectAttempts >= maxAttempts) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.connectionState = ConnectionState.Reconnecting;\n\t\tthis.reconnectAttempts++;\n\n\t\tthis.emit(\"reconnecting\", this.reconnectAttempts, maxAttempts);\n\n\t\t// Calculate delay with exponential backoff and jitter\n\t\tconst baseDelay = RECONNECT_BASE_DELAY_MS * 2 ** (this.reconnectAttempts - 1);\n\t\tconst jitter = Math.random() * 0.3 * baseDelay;\n\t\tconst delay = Math.min(baseDelay + jitter, RECONNECT_MAX_DELAY_MS);\n\n\t\tawait this.sleep(delay);\n\n\t\ttry {\n\t\t\tconst running = await this.ensureDaemonRunning();\n\t\t\tif (!running) {\n\t\t\t\tthrow new ConnectionError(\"Daemon not running\");\n\t\t\t}\n\n\t\t\tawait this.establishConnection();\n\t\t\tthis.emit(\"reconnected\");\n\t\t} catch {\n\t\t\t// Try again if we haven't exceeded max attempts\n\t\t\tif (this.reconnectAttempts < maxAttempts) {\n\t\t\t\tthis.attemptReconnect();\n\t\t\t} else {\n\t\t\t\tthis.connectionState = ConnectionState.Disconnected;\n\t\t\t}\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// PRIVATE - DATA HANDLING\n\t// =========================================================================\n\n\t/**\n\t * Handle incoming data from socket\n\t */\n\tprivate handleSocketData(data: Buffer): void {\n\t\tthis.buffer += data.toString();\n\n\t\t// Parse newline-delimited JSON-RPC\n\t\tconst lines = this.buffer.split(\"\\n\");\n\t\tthis.buffer = lines.pop() || \"\";\n\n\t\tfor (const line of lines) {\n\t\t\tif (!line.trim()) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst message = JSON.parse(line) as DaemonResponse | DaemonNotification;\n\n\t\t\t\t// Check if this is a notification (has method but no id)\n\t\t\t\tif (\"method\" in message && message.method === \"notification\") {\n\t\t\t\t\tthis.emit(\"notification\", message as DaemonNotification);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Handle response\n\t\t\t\tconst response = message as DaemonResponse;\n\t\t\t\tconst pending = this.pending.get(response.id);\n\n\t\t\t\tif (pending) {\n\t\t\t\t\tthis.pending.delete(response.id);\n\t\t\t\t\tclearTimeout(pending.timeoutId);\n\n\t\t\t\t\tif (response.error) {\n\t\t\t\t\t\tconst error = new DaemonError(\n\t\t\t\t\t\t\tresponse.error.code,\n\t\t\t\t\t\t\tresponse.error.message,\n\t\t\t\t\t\t\tresponse.error.data as Record<string, unknown> | undefined,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tpending.reject(error);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tpending.resolve(response.result);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\tthis.emit(\"error\", new Error(`Failed to parse response: ${line.substring(0, 100)}`));\n\t\t\t}\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// PRIVATE - REQUEST EXECUTION\n\t// =========================================================================\n\n\t/**\n\t * Execute a request with retry logic\n\t */\n\tprivate async executeRequest<T>(\n\t\tmethod: string,\n\t\tparams: Record<string, unknown>,\n\t\tretriesRemaining: number,\n\t): Promise<T> {\n\t\tconst id = String(++this.requestId);\n\t\tconst timeout = this.config.requestTimeout ?? DEFAULT_REQUEST_TIMEOUT_MS;\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\t// Set up timeout\n\t\t\tconst timeoutId = setTimeout(() => {\n\t\t\t\tconst pending = this.pending.get(id);\n\t\t\t\tif (pending) {\n\t\t\t\t\tthis.pending.delete(id);\n\n\t\t\t\t\t// Retry on timeout if retries remaining\n\t\t\t\t\tif (retriesRemaining > 0) {\n\t\t\t\t\t\tthis.executeRequest<T>(method, params, retriesRemaining - 1)\n\t\t\t\t\t\t\t.then(resolve)\n\t\t\t\t\t\t\t.catch(reject);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(new TimeoutError(method, timeout));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}, timeout);\n\n\t\t\t// Store pending request\n\t\t\tthis.pending.set(id, {\n\t\t\t\tresolve: (value) => resolve(value as T),\n\t\t\t\treject,\n\t\t\t\tmethod,\n\t\t\t\tparams,\n\t\t\t\tstartTime: Date.now(),\n\t\t\t\tretries: retriesRemaining,\n\t\t\t\ttimeoutId,\n\t\t\t});\n\n\t\t\t// Send request\n\t\t\tconst request = JSON.stringify({\n\t\t\t\tjsonrpc: \"2.0\",\n\t\t\t\tid,\n\t\t\t\tmethod,\n\t\t\t\tparams,\n\t\t\t});\n\n\t\t\tif (!this.socket) {\n\t\t\t\tthis.pending.delete(id);\n\t\t\t\tclearTimeout(timeoutId);\n\t\t\t\treject(new ConnectionError(\"Not connected\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst success = this.socket.write(`${request}\\n`);\n\t\t\tif (!success) {\n\t\t\t\t// Buffer is full, wait for drain\n\t\t\t\tthis.socket.once(\"drain\", () => {\n\t\t\t\t\t// Request already sent, just wait for response\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\t// =========================================================================\n\t// PRIVATE - HEALTH MONITORING\n\t// =========================================================================\n\n\t/**\n\t * Start periodic health checks\n\t */\n\tprivate startHealthCheck(): void {\n\t\tthis.stopHealthCheck();\n\n\t\tconst interval = this.config.healthCheckInterval ?? HEALTH_CHECK_INTERVAL_MS;\n\n\t\tthis.healthCheckTimer = setInterval(async () => {\n\t\t\tif (this.connectionState !== ConnectionState.Connected) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst startTime = Date.now();\n\t\t\ttry {\n\t\t\t\tawait this.ping();\n\t\t\t\tconst latencyMs = Date.now() - startTime;\n\t\t\t\tthis.emit(\"healthCheck\", true, latencyMs);\n\t\t\t} catch {\n\t\t\t\tthis.emit(\"healthCheck\", false, -1);\n\t\t\t}\n\t\t}, interval);\n\t}\n\n\t/**\n\t * Stop periodic health checks\n\t */\n\tprivate stopHealthCheck(): void {\n\t\tif (this.healthCheckTimer) {\n\t\t\tclearInterval(this.healthCheckTimer);\n\t\t\tthis.healthCheckTimer = null;\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// PRIVATE - UTILITIES\n\t// =========================================================================\n\n\t/**\n\t * Sleep for the specified duration\n\t */\n\tprivate sleep(ms: number): Promise<void> {\n\t\treturn new Promise((resolve) => setTimeout(resolve, ms));\n\t}\n}\n\n// =============================================================================\n// FACTORY FUNCTION\n// =============================================================================\n\n/**\n * Create a new daemon client with the given configuration\n */\nexport function createDaemonClient(config: DaemonClientConfig): DaemonClient {\n\treturn new DaemonClient(config);\n}\n","/**\n * LocalEngineAdapter (ADR-001)\n *\n * Implements ILocalEngine interface by wrapping underlying storage implementations.\n * This adapter enables RuntimeRouter to work with various storage backends.\n *\n * @module adapters/local-engine-adapter\n */\n\nimport { createHash } from \"node:crypto\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport type { FileState, Snapshot, SnapshotRestoreResult } from \"@snapback/contracts\";\nimport type {\n\tCreateSnapshotResult,\n\tILocalEngine,\n\tLocalCreateSnapshotOptions,\n\tLocalRestoreOptions,\n} from \"../interfaces\";\n\n// =============================================================================\n// File System Interface (for testability)\n// =============================================================================\n\n/**\n * File system interface for testability.\n * Default implementation uses node:fs.\n */\nexport interface IFileSystem {\n\treadFile(path: string, encoding: \"utf-8\"): Promise<string>;\n\twriteFile(path: string, content: string, encoding: \"utf-8\"): Promise<void>;\n\tmkdir(path: string, options: { recursive: boolean }): Promise<void>;\n}\n\n/**\n * Default file system implementation using node:fs\n */\nconst defaultFileSystem: IFileSystem = {\n\treadFile: (filePath, encoding) => fs.readFile(filePath, encoding),\n\twriteFile: (filePath, content, encoding) => fs.writeFile(filePath, content, encoding),\n\tmkdir: (dirPath, options) => fs.mkdir(dirPath, options).then(() => {}),\n};\n\n// =============================================================================\n// Storage Interface (mimics StorageBroker-like API)\n// =============================================================================\n\n/**\n * Minimal storage interface that LocalEngineAdapter wraps.\n * Implementations include StorageBroker (OSS SDK) and similar backends.\n */\nexport interface ISnapshotStorage {\n\tinitialize(): Promise<void>;\n\tisInitialized(): boolean;\n\tcreateSnapshot(\n\t\tname: string,\n\t\tfiles: Map<string, string>,\n\t\tmetadata?: Record<string, unknown>,\n\t): Promise<{ id: string; name: string; fileCount: number; timestamp: number }>;\n\tgetSnapshot(id: string): Promise<{\n\t\tid: string;\n\t\tname: string;\n\t\tfiles: Map<string, string>;\n\t\ttimestamp: number;\n\t\tmetadata: string;\n\t} | null>;\n\tlistSnapshots(\n\t\tlimit?: number,\n\t\toffset?: number,\n\t): Promise<Array<{ id: string; name: string; timestamp: number; metadata: string }>>;\n\tdeleteSnapshot(id: string): Promise<void>;\n\tclose(): Promise<void>;\n}\n\n// =============================================================================\n// LocalEngineAdapter Implementation\n// =============================================================================\n\n/**\n * Adapter implementing ILocalEngine that wraps an ISnapshotStorage backend.\n *\n * Features:\n * - Full ILocalEngine interface compliance\n * - Workspace path awareness for file operations\n * - Restore with dry-run and selective file support\n * - Cleanup with age/count/protection filters\n */\nexport class LocalEngineAdapter implements ILocalEngine {\n\tprivate readonly storage: ISnapshotStorage;\n\tprivate workspacePath: string | null = null;\n\tprivate disposed = false;\n\tprivate fileSystem: IFileSystem;\n\n\tconstructor(storage: ISnapshotStorage, fileSystem?: IFileSystem) {\n\t\tthis.storage = storage;\n\t\tthis.fileSystem = fileSystem ?? defaultFileSystem;\n\t}\n\n\t/**\n\t * Get the configured workspace path\n\t */\n\tgetWorkspacePath(): string | null {\n\t\treturn this.workspacePath;\n\t}\n\n\t// =========================================================================\n\t// Lifecycle Methods\n\t// =========================================================================\n\n\tasync initialize(workspacePath: string): Promise<void> {\n\t\tthis.workspacePath = workspacePath;\n\t\tawait this.storage.initialize();\n\t}\n\n\tisInitialized(): boolean {\n\t\treturn this.storage.isInitialized();\n\t}\n\n\tasync dispose(): Promise<void> {\n\t\tif (this.disposed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.disposed = true;\n\t\tawait this.storage.close();\n\t}\n\n\t// =========================================================================\n\t// Snapshot CRUD Operations\n\t// =========================================================================\n\n\tasync createSnapshot(options: LocalCreateSnapshotOptions): Promise<CreateSnapshotResult> {\n\t\tthis.assertInitialized();\n\n\t\tconst startTime = Date.now();\n\n\t\t// Gather files to snapshot\n\t\tconst files = await this.gatherFiles(options.files);\n\n\t\t// Build snapshot name\n\t\tconst name = options.description || `Snapshot at ${new Date().toLocaleTimeString()}`;\n\n\t\t// Build metadata\n\t\tconst metadata: Record<string, unknown> = {\n\t\t\ttask: options.task,\n\t\t\ttrigger: options.trigger,\n\t\t\tsessionId: options.sessionId,\n\t\t};\n\n\t\t// Create via storage backend\n\t\tconst result = await this.storage.createSnapshot(name, files, metadata);\n\n\t\t// Calculate total size\n\t\tlet totalSize = 0;\n\t\tfor (const content of files.values()) {\n\t\t\ttotalSize += Buffer.byteLength(content, \"utf-8\");\n\t\t}\n\n\t\tconst durationMs = Date.now() - startTime;\n\n\t\t// Build result with Snapshot object\n\t\tconst snapshot: Snapshot = {\n\t\t\tid: result.id,\n\t\t\ttimestamp: result.timestamp,\n\t\t\tversion: \"1.0\",\n\t\t\tmeta: { name: result.name, ...metadata },\n\t\t\tfiles: Array.from(files.keys()),\n\t\t};\n\n\t\treturn {\n\t\t\tsnapshot,\n\t\t\tsnapshotId: result.id,\n\t\t\tfileCount: result.fileCount,\n\t\t\ttotalSize,\n\t\t\tdurationMs,\n\t\t\tdeduplicated: false, // Deduplication is storage-level concern\n\t\t};\n\t}\n\n\tasync getSnapshot(id: string): Promise<Snapshot | null> {\n\t\tthis.assertInitialized();\n\n\t\tconst stored = await this.storage.getSnapshot(id);\n\t\tif (!stored) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst metadata = this.parseMetadata(stored.metadata);\n\n\t\treturn {\n\t\t\tid: stored.id,\n\t\t\ttimestamp: stored.timestamp,\n\t\t\tversion: \"1.0\",\n\t\t\tmeta: { name: stored.name, ...metadata },\n\t\t\tfiles: Array.from(stored.files.keys()),\n\t\t};\n\t}\n\n\tasync listSnapshots(options?: {\n\t\tlimit?: number;\n\t\tafter?: number;\n\t\tbefore?: number;\n\t\tsessionId?: string;\n\t}): Promise<Snapshot[]> {\n\t\tthis.assertInitialized();\n\n\t\tconst stored = await this.storage.listSnapshots(options?.limit ?? 100, 0);\n\n\t\tlet snapshots: Snapshot[] = stored.map((s) => {\n\t\t\tconst metadata = this.parseMetadata(s.metadata);\n\t\t\treturn {\n\t\t\t\tid: s.id,\n\t\t\t\ttimestamp: s.timestamp,\n\t\t\t\tversion: \"1.0\",\n\t\t\t\tmeta: { name: s.name, ...metadata },\n\t\t\t};\n\t\t});\n\n\t\t// Apply timestamp filters\n\t\tif (options?.after) {\n\t\t\tconst after = options.after;\n\t\t\tsnapshots = snapshots.filter((s) => s.timestamp > after);\n\t\t}\n\t\tif (options?.before) {\n\t\t\tconst before = options.before;\n\t\t\tsnapshots = snapshots.filter((s) => s.timestamp < before);\n\t\t}\n\n\t\t// Filter by sessionId\n\t\tif (options?.sessionId) {\n\t\t\tsnapshots = snapshots.filter((s) => {\n\t\t\t\tconst meta = s.meta as Record<string, unknown>;\n\t\t\t\treturn meta?.sessionId === options.sessionId;\n\t\t\t});\n\t\t}\n\n\t\treturn snapshots;\n\t}\n\n\tasync deleteSnapshot(id: string): Promise<boolean> {\n\t\tthis.assertInitialized();\n\n\t\tconst existing = await this.storage.getSnapshot(id);\n\t\tif (!existing) {\n\t\t\treturn false;\n\t\t}\n\n\t\tawait this.storage.deleteSnapshot(id);\n\t\treturn true;\n\t}\n\n\t// =========================================================================\n\t// Restore Operations\n\t// =========================================================================\n\n\tasync restoreSnapshot(id: string, options?: LocalRestoreOptions): Promise<SnapshotRestoreResult> {\n\t\tthis.assertInitialized();\n\n\t\tconst stored = await this.storage.getSnapshot(id);\n\t\tif (!stored) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\trestoredFiles: [],\n\t\t\t\terrors: [`Snapshot not found: ${id}`],\n\t\t\t};\n\t\t}\n\n\t\t// Determine which files to restore\n\t\tlet filesToRestore: Map<string, string>;\n\t\tif (options?.files && options.files.length > 0) {\n\t\t\tfilesToRestore = new Map();\n\t\t\tfor (const file of options.files) {\n\t\t\t\tconst content = stored.files.get(file);\n\t\t\t\tif (content !== undefined) {\n\t\t\t\t\tfilesToRestore.set(file, content);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfilesToRestore = stored.files;\n\t\t}\n\n\t\tconst restoredFiles: string[] = [];\n\t\tconst errors: string[] = [];\n\n\t\t// Create backup if requested\n\t\tif (options?.backupCurrent && !options?.dryRun) {\n\t\t\tconst currentFiles = await this.gatherFiles(Array.from(filesToRestore.keys()));\n\t\t\tawait this.storage.createSnapshot(`Pre-restore backup for ${id}`, currentFiles, {\n\t\t\t\tbackup: true,\n\t\t\t\ttargetRestoreId: id,\n\t\t\t});\n\t\t}\n\n\t\t// Restore files (or simulate in dry run)\n\t\tfor (const [filePath, content] of filesToRestore) {\n\t\t\tif (!options?.dryRun) {\n\t\t\t\ttry {\n\t\t\t\t\tawait this.writeFile(filePath, content);\n\t\t\t\t\trestoredFiles.push(filePath);\n\t\t\t\t} catch (err) {\n\t\t\t\t\terrors.push(`Failed to restore ${filePath}: ${err instanceof Error ? err.message : String(err)}`);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Dry run - just record what would be restored\n\t\t\t\trestoredFiles.push(filePath);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: errors.length === 0,\n\t\t\trestoredFiles,\n\t\t\terrors: errors.length > 0 ? errors : undefined,\n\t\t};\n\t}\n\n\t// =========================================================================\n\t// File Content Operations\n\t// =========================================================================\n\n\tasync getFileContent(snapshotId: string, filePath: string): Promise<string | null> {\n\t\tthis.assertInitialized();\n\n\t\tconst stored = await this.storage.getSnapshot(snapshotId);\n\t\tif (!stored) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn stored.files.get(filePath) ?? null;\n\t}\n\n\tasync getFileStates(snapshotId: string): Promise<FileState[]> {\n\t\tthis.assertInitialized();\n\n\t\tconst stored = await this.storage.getSnapshot(snapshotId);\n\t\tif (!stored) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst states: FileState[] = [];\n\t\tfor (const [filePath, content] of stored.files) {\n\t\t\tstates.push({\n\t\t\t\tpath: filePath,\n\t\t\t\tcontent,\n\t\t\t\thash: this.computeHash(content),\n\t\t\t\tsize: Buffer.byteLength(content, \"utf-8\"),\n\t\t\t});\n\t\t}\n\n\t\treturn states;\n\t}\n\n\t// =========================================================================\n\t// Storage Stats & Cleanup\n\t// =========================================================================\n\n\tasync getStorageStats(): Promise<{\n\t\ttotalSnapshots: number;\n\t\ttotalSize: number;\n\t\toldestSnapshot: number | null;\n\t\tnewestSnapshot: number | null;\n\t}> {\n\t\tthis.assertInitialized();\n\n\t\tconst snapshots = await this.storage.listSnapshots(1000, 0);\n\n\t\tif (snapshots.length === 0) {\n\t\t\treturn {\n\t\t\t\ttotalSnapshots: 0,\n\t\t\t\ttotalSize: 0,\n\t\t\t\toldestSnapshot: null,\n\t\t\t\tnewestSnapshot: null,\n\t\t\t};\n\t\t}\n\n\t\tconst timestamps = snapshots.map((s) => s.timestamp);\n\n\t\treturn {\n\t\t\ttotalSnapshots: snapshots.length,\n\t\t\ttotalSize: 0, // Would need to sum file sizes from each snapshot\n\t\t\toldestSnapshot: Math.min(...timestamps),\n\t\t\tnewestSnapshot: Math.max(...timestamps),\n\t\t};\n\t}\n\n\tasync cleanup(options: { maxAge?: number; maxCount?: number; keepProtected?: boolean }): Promise<number> {\n\t\tthis.assertInitialized();\n\n\t\tconst snapshots = await this.storage.listSnapshots(1000, 0);\n\t\tconst now = Date.now();\n\t\tlet cleaned = 0;\n\n\t\t// Sort by timestamp (oldest first for maxAge, newest first for maxCount)\n\t\tconst sortedSnapshots = [...snapshots].sort((a, b) => a.timestamp - b.timestamp);\n\n\t\tconst toDelete: string[] = [];\n\n\t\t// Apply maxAge filter\n\t\tif (options.maxAge !== undefined) {\n\t\t\tfor (const snap of sortedSnapshots) {\n\t\t\t\tconst age = now - snap.timestamp;\n\t\t\t\tif (age > options.maxAge) {\n\t\t\t\t\tconst metadata = this.parseMetadata(snap.metadata);\n\t\t\t\t\tif (options.keepProtected && metadata.protected) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\ttoDelete.push(snap.id);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Apply maxCount filter (keep newest maxCount)\n\t\tif (options.maxCount !== undefined) {\n\t\t\tconst sortedByNewest = [...snapshots].sort((a, b) => b.timestamp - a.timestamp);\n\t\t\tconst toKeep = new Set(sortedByNewest.slice(0, options.maxCount).map((s) => s.id));\n\n\t\t\tfor (const snap of sortedSnapshots) {\n\t\t\t\tif (!toKeep.has(snap.id) && !toDelete.includes(snap.id)) {\n\t\t\t\t\tconst metadata = this.parseMetadata(snap.metadata);\n\t\t\t\t\tif (options.keepProtected && metadata.protected) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\ttoDelete.push(snap.id);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Delete marked snapshots\n\t\tfor (const id of toDelete) {\n\t\t\tawait this.storage.deleteSnapshot(id);\n\t\t\tcleaned++;\n\t\t}\n\n\t\treturn cleaned;\n\t}\n\n\t// =========================================================================\n\t// Private Helpers\n\t// =========================================================================\n\n\tprivate assertInitialized(): void {\n\t\tif (!this.storage.isInitialized()) {\n\t\t\tthrow new Error(\"LocalEngineAdapter is not initialized. Call initialize() first.\");\n\t\t}\n\t}\n\n\tprivate async gatherFiles(filePaths?: string[]): Promise<Map<string, string>> {\n\t\tconst files = new Map<string, string>();\n\n\t\tif (!filePaths || filePaths.length === 0 || !this.workspacePath) {\n\t\t\treturn files;\n\t\t}\n\n\t\tfor (const relativePath of filePaths) {\n\t\t\ttry {\n\t\t\t\tconst fullPath = path.join(this.workspacePath, relativePath);\n\t\t\t\tconst content = await this.fileSystem.readFile(fullPath, \"utf-8\");\n\t\t\t\tfiles.set(relativePath, content);\n\t\t\t} catch {\n\t\t\t\t// File might not exist, skip it\n\t\t\t}\n\t\t}\n\n\t\treturn files;\n\t}\n\n\tprivate async writeFile(relativePath: string, content: string): Promise<void> {\n\t\tif (!this.workspacePath) {\n\t\t\tthrow new Error(\"Workspace path not set\");\n\t\t}\n\n\t\tconst fullPath = path.join(this.workspacePath, relativePath);\n\t\tconst dir = path.dirname(fullPath);\n\n\t\tawait this.fileSystem.mkdir(dir, { recursive: true });\n\t\tawait this.fileSystem.writeFile(fullPath, content, \"utf-8\");\n\t}\n\n\tprivate computeHash(content: string): string {\n\t\treturn createHash(\"sha256\").update(content).digest(\"hex\");\n\t}\n\n\tprivate parseMetadata(metadataJson: string): Record<string, unknown> {\n\t\ttry {\n\t\t\treturn JSON.parse(metadataJson) as Record<string, unknown>;\n\t\t} catch {\n\t\t\treturn {};\n\t\t}\n\t}\n}\n\n// =============================================================================\n// Factory Function\n// =============================================================================\n\n/**\n * Simple in-memory storage for testing and basic use cases.\n */\nclass InMemoryStorage implements ISnapshotStorage {\n\tprivate snapshots = new Map<\n\t\tstring,\n\t\t{\n\t\t\tid: string;\n\t\t\tname: string;\n\t\t\tfiles: Map<string, string>;\n\t\t\ttimestamp: number;\n\t\t\tmetadata: string;\n\t\t}\n\t>();\n\tprivate initialized = false;\n\n\tasync initialize(): Promise<void> {\n\t\tthis.initialized = true;\n\t}\n\n\tisInitialized(): boolean {\n\t\treturn this.initialized;\n\t}\n\n\tasync createSnapshot(\n\t\tname: string,\n\t\tfiles: Map<string, string>,\n\t\tmetadata?: Record<string, unknown>,\n\t): Promise<{ id: string; name: string; fileCount: number; timestamp: number }> {\n\t\tconst id = `snap-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\n\t\tconst timestamp = Date.now();\n\n\t\tthis.snapshots.set(id, {\n\t\t\tid,\n\t\t\tname,\n\t\t\tfiles: new Map(files),\n\t\t\ttimestamp,\n\t\t\tmetadata: JSON.stringify(metadata ?? {}),\n\t\t});\n\n\t\treturn { id, name, fileCount: files.size, timestamp };\n\t}\n\n\tasync getSnapshot(id: string): Promise<{\n\t\tid: string;\n\t\tname: string;\n\t\tfiles: Map<string, string>;\n\t\ttimestamp: number;\n\t\tmetadata: string;\n\t} | null> {\n\t\treturn this.snapshots.get(id) ?? null;\n\t}\n\n\tasync listSnapshots(): Promise<\n\t\tArray<{\n\t\t\tid: string;\n\t\t\tname: string;\n\t\t\ttimestamp: number;\n\t\t\tmetadata: string;\n\t\t}>\n\t> {\n\t\treturn Array.from(this.snapshots.values()).map((s) => ({\n\t\t\tid: s.id,\n\t\t\tname: s.name,\n\t\t\ttimestamp: s.timestamp,\n\t\t\tmetadata: s.metadata,\n\t\t}));\n\t}\n\n\tasync deleteSnapshot(id: string): Promise<void> {\n\t\tthis.snapshots.delete(id);\n\t}\n\n\tasync close(): Promise<void> {\n\t\tthis.snapshots.clear();\n\t\tthis.initialized = false;\n\t}\n}\n\n/**\n * Creates a LocalEngine instance with default in-memory storage.\n * For production use, provide a StorageBroker-based storage.\n *\n * @param workspacePath - Root path for the workspace\n * @param storage - Optional custom storage backend\n * @returns Initialized ILocalEngine instance\n */\nexport async function createLocalEngine(\n\tworkspacePath: string,\n\tstorage?: ISnapshotStorage,\n): Promise<ILocalEngine & { getWorkspacePath(): string | null }> {\n\tconst backend = storage ?? new InMemoryStorage();\n\tconst adapter = new LocalEngineAdapter(backend);\n\tawait adapter.initialize(workspacePath);\n\treturn adapter;\n}\n","/**\n * Runtime Context (ADR-001)\n *\n * Manages runtime context for routing decisions.\n * The context determines which runtime (local vs platform) to use.\n *\n * Enhanced with entitlements system integration (Gap 1)\n *\n * @module context\n */\n\nimport type { Entitlements, Feature } from \"@snapback/contracts/entitlements\";\nimport type { Tier } from \"@snapback/contracts/tiers\";\n\n// Re-export Tier type for backward compatibility\nexport type { Tier } from \"@snapback/contracts/tiers\";\n\n/**\n * Connectivity state\n */\nexport type Connectivity = \"online\" | \"offline\" | \"degraded\";\n\n/**\n * Authentication state\n */\nexport type AuthState = \"authenticated\" | \"anonymous\" | \"enterprise-sso\";\n\n/**\n * Runtime context used for routing decisions\n * Enhanced with entitlements system integration\n */\nexport interface RuntimeContext {\n\t/** Current connectivity state */\n\tconnectivity: Connectivity;\n\n\t/** Authentication state */\n\tauthState: AuthState;\n\n\t/** User/workspace tier */\n\ttier: Tier;\n\n\t/** Privacy mode (always use local engine) */\n\tprivacyMode: boolean;\n\n\t/** Feature flags */\n\tfeatureFlags: Record<string, boolean>;\n\n\t/** Workspace information */\n\tworkspace: {\n\t\t/** Workspace root path */\n\t\tpath: string;\n\t\t/** Workspace ID (if registered) */\n\t\tid?: string;\n\t\t/** Team ID (if in a team) */\n\t\tteamId?: string;\n\t};\n\n\t/** User information (if authenticated) */\n\tuser?: {\n\t\tid: string;\n\t\temail: string;\n\t};\n\n\t/**\n\t * Get complete entitlements for the current user\n\t * Lazy-loads from platform API with caching\n\t */\n\tgetEntitlements?: () => Promise<Entitlements>;\n\n\t/**\n\t * Check if user has access to a specific feature\n\t * @param feature - Feature to check\n\t * @returns True if user has access to the feature\n\t */\n\thasFeature?: (feature: Feature) => Promise<boolean>;\n\n\t/**\n\t * Verify user meets minimum tier requirement\n\t * @param requiredTier - Minimum tier required\n\t * @returns True if user's tier meets or exceeds requirement\n\t */\n\tcheckTier?: (requiredTier: Tier) => Promise<boolean>;\n}\n\n/**\n * Get current working directory safely\n * Lazy evaluation avoids issues with module load order\n */\nfunction getDefaultWorkspacePath(): string {\n\ttry {\n\t\treturn process.cwd();\n\t} catch {\n\t\treturn \"/\";\n\t}\n}\n\n/**\n * Default runtime context for offline/anonymous usage\n * Note: workspace.path is set lazily via createRuntimeContext()\n */\nexport const DEFAULT_CONTEXT: RuntimeContext = {\n\tconnectivity: \"online\",\n\tauthState: \"anonymous\",\n\ttier: \"free\",\n\tprivacyMode: false,\n\tfeatureFlags: {},\n\tworkspace: {\n\t\tpath: \"\", // Set lazily - use createRuntimeContext() to get proper path\n\t},\n};\n\n/**\n * Create a runtime context with overrides\n */\nexport function createRuntimeContext(overrides: Partial<RuntimeContext> = {}): RuntimeContext {\n\treturn {\n\t\t...DEFAULT_CONTEXT,\n\t\t...overrides,\n\t\tworkspace: {\n\t\t\t...DEFAULT_CONTEXT.workspace,\n\t\t\t...overrides.workspace,\n\t\t\t// Use lazy path resolution - only call process.cwd() when actually needed\n\t\t\tpath: overrides.workspace?.path || getDefaultWorkspacePath(),\n\t\t},\n\t\tfeatureFlags: {\n\t\t\t...DEFAULT_CONTEXT.featureFlags,\n\t\t\t...overrides.featureFlags,\n\t\t},\n\t};\n}\n\n/**\n * Context detection utilities\n */\nexport const ContextDetection = {\n\t/**\n\t * Detect connectivity state\n\t * In browser: uses navigator.onLine\n\t * In Node: assumes online (would need network check)\n\t */\n\tdetectConnectivity(): Connectivity {\n\t\tif (typeof navigator !== \"undefined\") {\n\t\t\treturn navigator.onLine ? \"online\" : \"offline\";\n\t\t}\n\t\t// In Node.js, assume online (actual check would need network request)\n\t\treturn \"online\";\n\t},\n\n\t/**\n\t * Check if team features should be enabled\n\t */\n\tshouldUseTeamFeatures(context: RuntimeContext): boolean {\n\t\treturn (\n\t\t\tcontext.tier === \"enterprise\" &&\n\t\t\tcontext.authState === \"authenticated\" &&\n\t\t\tcontext.connectivity === \"online\" &&\n\t\t\t!context.privacyMode &&\n\t\t\tcontext.featureFlags.teamSync === true\n\t\t);\n\t},\n\n\t/**\n\t * Check if platform sync should be enabled\n\t */\n\tshouldUsePlatformSync(context: RuntimeContext): boolean {\n\t\treturn (\n\t\t\tcontext.connectivity === \"online\" &&\n\t\t\tcontext.authState === \"authenticated\" &&\n\t\t\t!context.privacyMode &&\n\t\t\t(context.tier === \"pro\" || context.tier === \"enterprise\")\n\t\t);\n\t},\n\n\t/**\n\t * Check if local engine should be used exclusively\n\t */\n\tshouldUseLocalOnly(context: RuntimeContext): boolean {\n\t\treturn (\n\t\t\tcontext.privacyMode ||\n\t\t\tcontext.connectivity === \"offline\" ||\n\t\t\tcontext.authState === \"anonymous\" ||\n\t\t\tcontext.tier === \"free\"\n\t\t);\n\t},\n};\n\n/**\n * Runtime context change event\n */\nexport interface ContextChangeEvent {\n\ttype: \"context_changed\";\n\tprevious: RuntimeContext;\n\tcurrent: RuntimeContext;\n\tchangedFields: (keyof RuntimeContext)[];\n}\n\n/**\n * Context change listener\n */\nexport type ContextChangeListener = (event: ContextChangeEvent) => void;\n\n/**\n * Observable runtime context manager\n */\nexport class RuntimeContextManager {\n\tprivate context: RuntimeContext;\n\tprivate listeners: Set<ContextChangeListener> = new Set();\n\n\tconstructor(initialContext: RuntimeContext = DEFAULT_CONTEXT) {\n\t\tthis.context = { ...initialContext };\n\t}\n\n\t/**\n\t * Get current context\n\t */\n\tgetContext(): RuntimeContext {\n\t\treturn { ...this.context };\n\t}\n\n\t/**\n\t * Update context\n\t */\n\tupdateContext(updates: Partial<RuntimeContext>): void {\n\t\tconst previous = { ...this.context };\n\t\tconst changedFields: (keyof RuntimeContext)[] = [];\n\n\t\t// Detect changed fields\n\t\tfor (const key of Object.keys(updates) as (keyof RuntimeContext)[]) {\n\t\t\tif (JSON.stringify(this.context[key]) !== JSON.stringify(updates[key])) {\n\t\t\t\tchangedFields.push(key);\n\t\t\t}\n\t\t}\n\n\t\tif (changedFields.length === 0) {\n\t\t\treturn; // No changes\n\t\t}\n\n\t\t// Apply updates\n\t\tthis.context = createRuntimeContext({\n\t\t\t...this.context,\n\t\t\t...updates,\n\t\t});\n\n\t\t// Notify listeners\n\t\tconst event: ContextChangeEvent = {\n\t\t\ttype: \"context_changed\",\n\t\t\tprevious,\n\t\t\tcurrent: { ...this.context },\n\t\t\tchangedFields,\n\t\t};\n\n\t\tfor (const listener of Array.from(this.listeners)) {\n\t\t\ttry {\n\t\t\t\tlistener(event);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"Context change listener error:\", error);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Subscribe to context changes\n\t */\n\tsubscribe(listener: ContextChangeListener): () => void {\n\t\tthis.listeners.add(listener);\n\t\treturn () => this.listeners.delete(listener);\n\t}\n\n\t/**\n\t * Set connectivity state\n\t */\n\tsetConnectivity(connectivity: Connectivity): void {\n\t\tthis.updateContext({ connectivity });\n\t}\n\n\t/**\n\t * Set privacy mode\n\t */\n\tsetPrivacyMode(enabled: boolean): void {\n\t\tthis.updateContext({ privacyMode: enabled });\n\t}\n\n\t/**\n\t * Set feature flag\n\t */\n\tsetFeatureFlag(flag: string, enabled: boolean): void {\n\t\tthis.updateContext({\n\t\t\tfeatureFlags: {\n\t\t\t\t...this.context.featureFlags,\n\t\t\t\t[flag]: enabled,\n\t\t\t},\n\t\t});\n\t}\n}\n","/**\n * Runtime Router (ADR-001)\n *\n * Routes snapshot operations between local engine and platform runtime\n * based on connectivity, authentication, tier, and feature flags.\n *\n * Decision hierarchy:\n * 1. Privacy mode  Local engine (always)\n * 2. Offline  Local engine + sync queue\n * 3. Enterprise + team features  Platform runtime\n * 4. Default  Local engine (fastest, privacy-preserving)\n *\n * @module router\n */\n\nimport type { Snapshot, SnapshotRestoreResult } from \"@snapback/contracts\";\nimport type { RuntimeContext } from \"./context.js\";\nimport { ContextDetection } from \"./context.js\";\nimport type {\n\tCreateSnapshotResult,\n\tILocalEngine,\n\tIPlatformRuntime,\n\tLocalCreateSnapshotOptions,\n\tLocalRestoreOptions,\n} from \"./interfaces/index.js\";\n\n/**\n * Sync queue item for offline operations\n */\ninterface SyncQueueItem {\n\tid: string;\n\toperation: \"create\" | \"update\" | \"delete\";\n\tsnapshotId: string;\n\tdata?: unknown;\n\ttimestamp: number;\n\tretryCount: number;\n}\n\n/**\n * Sync queue for offline-to-online synchronization\n */\nexport class SyncQueue {\n\tprivate queue: SyncQueueItem[] = [];\n\tprivate maxRetries = 3;\n\n\t/**\n\t * Add operation to sync queue\n\t */\n\tenqueue(operation: SyncQueueItem[\"operation\"], snapshotId: string, data?: unknown): void {\n\t\tconst item: SyncQueueItem = {\n\t\t\tid: `sync-${Date.now()}-${Math.random().toString(36).slice(2)}`,\n\t\t\toperation,\n\t\t\tsnapshotId,\n\t\t\tdata,\n\t\t\ttimestamp: Date.now(),\n\t\t\tretryCount: 0,\n\t\t};\n\t\tthis.queue.push(item);\n\t}\n\n\t/**\n\t * Get all pending items\n\t */\n\tgetPending(): SyncQueueItem[] {\n\t\treturn [...this.queue];\n\t}\n\n\t/**\n\t * Remove processed item\n\t */\n\tremove(id: string): void {\n\t\tthis.queue = this.queue.filter((item) => item.id !== id);\n\t}\n\n\t/**\n\t * Mark item as retried\n\t */\n\tretry(id: string): boolean {\n\t\tconst item = this.queue.find((i) => i.id === id);\n\t\tif (!item) {\n\t\t\treturn false;\n\t\t}\n\n\t\titem.retryCount++;\n\t\tif (item.retryCount > this.maxRetries) {\n\t\t\tthis.remove(id);\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Get queue size\n\t */\n\tsize(): number {\n\t\treturn this.queue.length;\n\t}\n\n\t/**\n\t * Clear the queue\n\t */\n\tclear(): void {\n\t\tthis.queue = [];\n\t}\n}\n\n/**\n * Router configuration\n */\nexport interface RouterConfig {\n\t/** Enable sync queue for offline operations */\n\tenableSyncQueue?: boolean;\n\t/** Auto-sync when coming online */\n\tautoSync?: boolean;\n\t/** Sync interval in ms (default: 30000) */\n\tsyncInterval?: number;\n}\n\n/**\n * Runtime Router\n *\n * Routes operations between local engine and platform runtime\n * based on context and configuration.\n */\nexport class RuntimeRouter {\n\tprivate syncQueue: SyncQueue;\n\tprivate syncTimer?: ReturnType<typeof setInterval>;\n\n\tconstructor(\n\t\tprivate localEngine: ILocalEngine,\n\t\tprivate platformRuntime: IPlatformRuntime | null,\n\t\tprivate context: RuntimeContext,\n\t\tprivate config: RouterConfig = {},\n\t) {\n\t\tthis.syncQueue = new SyncQueue();\n\n\t\t// Set up auto-sync if enabled\n\t\tif (config.autoSync && config.syncInterval) {\n\t\t\tthis.startAutoSync(config.syncInterval);\n\t\t}\n\t}\n\n\t/**\n\t * Update the runtime context\n\t */\n\tupdateContext(context: RuntimeContext): void {\n\t\tconst wasOffline = this.context.connectivity === \"offline\";\n\t\tthis.context = context;\n\n\t\t// Trigger sync when coming online\n\t\tif (wasOffline && context.connectivity === \"online\" && this.config.enableSyncQueue) {\n\t\t\tthis.processSyncQueue().catch(console.error);\n\t\t}\n\t}\n\n\t/**\n\t * Get current context\n\t */\n\tgetContext(): RuntimeContext {\n\t\treturn { ...this.context };\n\t}\n\n\t// ==========================================================================\n\t// ROUTING LOGIC\n\t// ==========================================================================\n\n\t/**\n\t * Determine which runtime to use for an operation\n\t */\n\tprivate shouldUsePlatform(): boolean {\n\t\t// Privacy mode always uses local\n\t\tif (this.context.privacyMode) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// No platform runtime available\n\t\tif (!this.platformRuntime) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Offline uses local\n\t\tif (this.context.connectivity === \"offline\") {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Check if team features are enabled\n\t\treturn ContextDetection.shouldUseTeamFeatures(this.context);\n\t}\n\n\t// ==========================================================================\n\t// SNAPSHOT OPERATIONS\n\t// ==========================================================================\n\n\t/**\n\t * Create a snapshot\n\t * Routes to appropriate runtime based on context\n\t */\n\tasync createSnapshot(options: LocalCreateSnapshotOptions): Promise<CreateSnapshotResult> {\n\t\t// Always create locally first for speed and reliability\n\t\tconst result = await this.localEngine.createSnapshot(options);\n\n\t\t// If using platform, also sync to platform\n\t\tif (this.shouldUsePlatform() && this.platformRuntime) {\n\t\t\ttry {\n\t\t\t\tawait this.platformRuntime.syncSnapshot(result.snapshot);\n\t\t\t} catch (error) {\n\t\t\t\t// Queue for later sync if platform fails\n\t\t\t\tif (this.config.enableSyncQueue) {\n\t\t\t\t\tthis.syncQueue.enqueue(\"create\", result.snapshotId, result.snapshot);\n\t\t\t\t}\n\t\t\t\tconsole.warn(\"Platform sync failed, queued for later:\", error);\n\t\t\t}\n\t\t} else if (this.context.connectivity === \"offline\" && this.config.enableSyncQueue) {\n\t\t\t// Queue for sync when back online\n\t\t\tthis.syncQueue.enqueue(\"create\", result.snapshotId, result.snapshot);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Get a snapshot by ID\n\t */\n\tasync getSnapshot(id: string): Promise<Snapshot | null> {\n\t\t// Try local first\n\t\tconst localSnapshot = await this.localEngine.getSnapshot(id);\n\t\tif (localSnapshot) {\n\t\t\treturn localSnapshot;\n\t\t}\n\n\t\t// Try platform if available\n\t\tif (this.shouldUsePlatform() && this.platformRuntime) {\n\t\t\tconst platformSnapshot = await this.platformRuntime.getSnapshot(id);\n\t\t\treturn platformSnapshot;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * List snapshots\n\t */\n\tasync listSnapshots(options?: {\n\t\tlimit?: number;\n\t\tafter?: number;\n\t\tbefore?: number;\n\t\tsessionId?: string;\n\t}): Promise<Snapshot[]> {\n\t\t// Get local snapshots\n\t\tconst localSnapshots = await this.localEngine.listSnapshots(options);\n\n\t\t// If using platform, merge with platform snapshots\n\t\tif (this.shouldUsePlatform() && this.platformRuntime) {\n\t\t\tconst platformSnapshots = await this.platformRuntime.listSnapshots(options);\n\n\t\t\t// Merge and dedupe by ID, preferring platform versions\n\t\t\tconst snapshotMap = new Map<string, Snapshot>();\n\n\t\t\tfor (const snapshot of localSnapshots) {\n\t\t\t\tsnapshotMap.set(snapshot.id, snapshot);\n\t\t\t}\n\n\t\t\tfor (const snapshot of platformSnapshots) {\n\t\t\t\tsnapshotMap.set(snapshot.id, snapshot);\n\t\t\t}\n\n\t\t\t// Sort by timestamp descending\n\t\t\treturn Array.from(snapshotMap.values()).sort((a, b) => b.timestamp - a.timestamp);\n\t\t}\n\n\t\treturn localSnapshots;\n\t}\n\n\t/**\n\t * Restore a snapshot\n\t */\n\tasync restoreSnapshot(id: string, options?: LocalRestoreOptions): Promise<SnapshotRestoreResult> {\n\t\t// Always restore locally\n\t\treturn this.localEngine.restoreSnapshot(id, options);\n\t}\n\n\t/**\n\t * Delete a snapshot\n\t */\n\tasync deleteSnapshot(id: string): Promise<boolean> {\n\t\t// Delete locally\n\t\tconst localDeleted = await this.localEngine.deleteSnapshot(id);\n\n\t\t// Delete from platform if available\n\t\tif (this.shouldUsePlatform() && this.platformRuntime) {\n\t\t\ttry {\n\t\t\t\tawait this.platformRuntime.deleteSnapshot(id);\n\t\t\t} catch (error) {\n\t\t\t\tif (this.config.enableSyncQueue) {\n\t\t\t\t\tthis.syncQueue.enqueue(\"delete\", id);\n\t\t\t\t}\n\t\t\t\tconsole.warn(\"Platform delete failed, queued for later:\", error);\n\t\t\t}\n\t\t} else if (this.context.connectivity === \"offline\" && this.config.enableSyncQueue) {\n\t\t\tthis.syncQueue.enqueue(\"delete\", id);\n\t\t}\n\n\t\treturn localDeleted;\n\t}\n\n\t// ==========================================================================\n\t// SYNC OPERATIONS\n\t// ==========================================================================\n\n\t/**\n\t * Process the sync queue\n\t */\n\tasync processSyncQueue(): Promise<{ processed: number; failed: number }> {\n\t\tif (!this.platformRuntime || this.context.connectivity !== \"online\") {\n\t\t\treturn { processed: 0, failed: 0 };\n\t\t}\n\n\t\tconst pending = this.syncQueue.getPending();\n\t\tlet processed = 0;\n\t\tlet failed = 0;\n\n\t\tfor (const item of pending) {\n\t\t\ttry {\n\t\t\t\tswitch (item.operation) {\n\t\t\t\t\tcase \"create\":\n\t\t\t\t\t\tif (item.data) {\n\t\t\t\t\t\t\tawait this.platformRuntime.syncSnapshot(item.data as Snapshot);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"delete\":\n\t\t\t\t\t\tawait this.platformRuntime.deleteSnapshot(item.snapshotId);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tthis.syncQueue.remove(item.id);\n\t\t\t\tprocessed++;\n\t\t\t} catch (error) {\n\t\t\t\tconst shouldRetry = this.syncQueue.retry(item.id);\n\t\t\t\tif (!shouldRetry) {\n\t\t\t\t\tfailed++;\n\t\t\t\t}\n\t\t\t\tconsole.warn(`Sync operation failed (${item.operation}):`, error);\n\t\t\t}\n\t\t}\n\n\t\treturn { processed, failed };\n\t}\n\n\t/**\n\t * Get sync queue status\n\t */\n\tgetSyncQueueStatus(): { pending: number; items: SyncQueueItem[] } {\n\t\treturn {\n\t\t\tpending: this.syncQueue.size(),\n\t\t\titems: this.syncQueue.getPending(),\n\t\t};\n\t}\n\n\t/**\n\t * Start auto-sync timer\n\t */\n\tprivate startAutoSync(intervalMs: number): void {\n\t\tthis.syncTimer = setInterval(() => {\n\t\t\tif (this.context.connectivity === \"online\") {\n\t\t\t\tthis.processSyncQueue().catch(console.error);\n\t\t\t}\n\t\t}, intervalMs);\n\t}\n\n\t/**\n\t * Stop auto-sync timer\n\t */\n\tstopAutoSync(): void {\n\t\tif (this.syncTimer) {\n\t\t\tclearInterval(this.syncTimer);\n\t\t\tthis.syncTimer = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Dispose of resources\n\t */\n\tasync dispose(): Promise<void> {\n\t\tthis.stopAutoSync();\n\t\tawait this.localEngine.dispose();\n\t\tif (this.platformRuntime) {\n\t\t\tawait this.platformRuntime.dispose();\n\t\t}\n\t}\n}\n\n/**\n * Create a runtime router with default configuration\n */\nexport function createRuntimeRouter(\n\tlocalEngine: ILocalEngine,\n\tplatformRuntime: IPlatformRuntime | null,\n\tcontext: RuntimeContext,\n\tconfig?: RouterConfig,\n): RuntimeRouter {\n\treturn new RuntimeRouter(localEngine, platformRuntime, context, {\n\t\tenableSyncQueue: true,\n\t\tautoSync: true,\n\t\tsyncInterval: 30000,\n\t\t...config,\n\t});\n}\n","/**\n * Workspace API Client (Gap 6 - Workspace Resolution)\n *\n * Provides server-side workspace operations for the 5-layer workspace resolution system.\n * This client communicates with the platform API to perform workspace management.\n *\n * @module workspace-api-client\n */\n\nimport type { WorkspaceBinding, WorkspacePermissions } from \"@snapback/contracts/workspace/workspace-resolution\";\n\n/**\n * Workspace API client interface\n * Used by WorkspaceResolverImpl for server_suggestion layer\n */\nexport interface WorkspaceApiClient {\n\t/**\n\t * Suggest a workspace for a repository based on server-side heuristics\n\t * Uses repository identity (remote URL, name) to find matching workspaces\n\t */\n\tsuggestWorkspace(repoPath: string, userId: string): Promise<WorkspaceBinding | null>;\n\n\t/**\n\t * Get workspace by ID with full details\n\t */\n\tgetWorkspaceById(workspaceId: string, userId: string): Promise<WorkspaceBinding | null>;\n\n\t/**\n\t * List all workspaces for a user\n\t */\n\tlistWorkspaces(userId: string): Promise<WorkspaceBinding[]>;\n\n\t/**\n\t * Create a new workspace\n\t */\n\tcreateWorkspace(params: CreateWorkspaceParams): Promise<WorkspaceBinding>;\n\n\t/**\n\t * Update workspace settings\n\t */\n\tupdateWorkspace(workspaceId: string, updates: UpdateWorkspaceParams): Promise<WorkspaceBinding | null>;\n\n\t/**\n\t * Delete a workspace\n\t */\n\tdeleteWorkspace(workspaceId: string, userId: string): Promise<boolean>;\n}\n\nexport interface CreateWorkspaceParams {\n\tuserId: string;\n\tname: string;\n\trepoPath?: string;\n\torganizationId?: string;\n}\n\nexport interface UpdateWorkspaceParams {\n\tname?: string;\n\tpermissions?: Partial<WorkspacePermissions>;\n}\n\n/**\n * HTTP-based workspace API client implementation\n * Communicates with the platform API server\n */\nexport class HttpWorkspaceApiClient implements WorkspaceApiClient {\n\tprivate baseUrl: string;\n\tprivate apiKey?: string;\n\tprivate workspaceId?: string;\n\n\tconstructor(config: {\n\t\tbaseUrl: string;\n\t\tapiKey?: string;\n\t\tworkspaceId?: string;\n\t}) {\n\t\tthis.baseUrl = config.baseUrl.replace(/\\/$/, \"\"); // Remove trailing slash\n\t\tthis.apiKey = config.apiKey;\n\t\tthis.workspaceId = config.workspaceId;\n\t}\n\n\t/**\n\t * Suggest a workspace for a repository based on server-side heuristics\n\t */\n\tasync suggestWorkspace(repoPath: string, userId: string): Promise<WorkspaceBinding | null> {\n\t\ttry {\n\t\t\tconst response = await this.fetch(\"/api/v1/workspaces/suggest\", {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\tbody: JSON.stringify({ repoPath, userId }),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tif (response.status === 404) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tthrow new Error(`API error: ${response.status}`);\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\t\t\treturn this.mapToWorkspaceBinding(data);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[WorkspaceApiClient] suggestWorkspace failed:\", error);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Get workspace by ID with full details\n\t */\n\tasync getWorkspaceById(workspaceId: string, userId: string): Promise<WorkspaceBinding | null> {\n\t\ttry {\n\t\t\tconst response = await this.fetch(`/api/v1/workspaces/${workspaceId}?userId=${encodeURIComponent(userId)}`);\n\n\t\t\tif (!response.ok) {\n\t\t\t\tif (response.status === 404) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tthrow new Error(`API error: ${response.status}`);\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\t\t\treturn this.mapToWorkspaceBinding(data);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[WorkspaceApiClient] getWorkspaceById failed:\", error);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * List all workspaces for a user\n\t */\n\tasync listWorkspaces(userId: string): Promise<WorkspaceBinding[]> {\n\t\ttry {\n\t\t\tconst response = await this.fetch(`/api/v1/workspaces?userId=${encodeURIComponent(userId)}`);\n\n\t\t\tif (!response.ok) {\n\t\t\t\tthrow new Error(`API error: ${response.status}`);\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\t\t\treturn (data.workspaces || []).map((ws: Record<string, unknown>) => this.mapToWorkspaceBinding(ws));\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[WorkspaceApiClient] listWorkspaces failed:\", error);\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Create a new workspace\n\t */\n\tasync createWorkspace(params: CreateWorkspaceParams): Promise<WorkspaceBinding> {\n\t\tconst response = await this.fetch(\"/api/v1/workspaces\", {\n\t\t\tmethod: \"POST\",\n\t\t\tbody: JSON.stringify(params),\n\t\t});\n\n\t\tif (!response.ok) {\n\t\t\tconst error = await response.json().catch(() => ({}));\n\t\t\tthrow new Error(error.message || `Failed to create workspace: ${response.status}`);\n\t\t}\n\n\t\tconst data = await response.json();\n\t\treturn this.mapToWorkspaceBinding(data);\n\t}\n\n\t/**\n\t * Update workspace settings\n\t */\n\tasync updateWorkspace(workspaceId: string, updates: UpdateWorkspaceParams): Promise<WorkspaceBinding | null> {\n\t\ttry {\n\t\t\tconst response = await this.fetch(`/api/v1/workspaces/${workspaceId}`, {\n\t\t\t\tmethod: \"PATCH\",\n\t\t\t\tbody: JSON.stringify(updates),\n\t\t\t});\n\n\t\t\tif (!response.ok) {\n\t\t\t\tif (response.status === 404) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tthrow new Error(`API error: ${response.status}`);\n\t\t\t}\n\n\t\t\tconst data = await response.json();\n\t\t\treturn this.mapToWorkspaceBinding(data);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[WorkspaceApiClient] updateWorkspace failed:\", error);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/**\n\t * Delete a workspace\n\t */\n\tasync deleteWorkspace(workspaceId: string, userId: string): Promise<boolean> {\n\t\ttry {\n\t\t\tconst response = await this.fetch(\n\t\t\t\t`/api/v1/workspaces/${workspaceId}?userId=${encodeURIComponent(userId)}`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"DELETE\",\n\t\t\t\t},\n\t\t\t);\n\n\t\t\treturn response.ok;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[WorkspaceApiClient] deleteWorkspace failed:\", error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Internal fetch wrapper with authentication\n\t */\n\tprivate async fetch(path: string, init?: RequestInit): Promise<Response> {\n\t\tconst headers: Record<string, string> = {\n\t\t\t\"Content-Type\": \"application/json\",\n\t\t};\n\n\t\t// Add authentication\n\t\tif (this.apiKey) {\n\t\t\theaders.Authorization = `Bearer ${this.apiKey}`;\n\t\t}\n\t\tif (this.workspaceId) {\n\t\t\theaders[\"X-Workspace-Id\"] = this.workspaceId;\n\t\t}\n\n\t\treturn fetch(`${this.baseUrl}${path}`, {\n\t\t\t...init,\n\t\t\theaders: {\n\t\t\t\t...headers,\n\t\t\t\t...init?.headers,\n\t\t\t},\n\t\t});\n\t}\n\n\t/**\n\t * Map API response to WorkspaceBinding\n\t */\n\tprivate mapToWorkspaceBinding(data: Record<string, unknown>): WorkspaceBinding {\n\t\treturn {\n\t\t\tworkspaceId: (data.workspaceId as string) || (data.workspace_id as string) || \"\",\n\t\t\tworkspaceName:\n\t\t\t\t(data.workspaceName as string) || (data.display_name as string) || (data.name as string) || \"Workspace\",\n\t\t\trepoPath: (data.repoPath as string) || (data.repo_path as string) || undefined,\n\t\t\torganizationId: (data.organizationId as string) || (data.organization_id as string) || undefined,\n\t\t\tuserId: (data.userId as string) || (data.user_id as string) || \"\",\n\t\t\tpermissions: {\n\t\t\t\tread: true,\n\t\t\t\twrite: (data.tier as string) !== \"free\",\n\t\t\t\tmanage: (data.tier as string) === \"enterprise\",\n\t\t\t\tinvite: (data.tier as string) === \"enterprise\",\n\t\t\t},\n\t\t\tresolvedFrom: \"server_suggestion\",\n\t\t};\n\t}\n}\n\n/**\n * Create a workspace API client instance\n */\nexport function createWorkspaceApiClient(config: {\n\tbaseUrl?: string;\n\tapiKey?: string;\n\tworkspaceId?: string;\n}): WorkspaceApiClient {\n\treturn new HttpWorkspaceApiClient({\n\t\tbaseUrl: config.baseUrl || process.env.SNAPBACK_API_URL || \"https://api.snapback.dev\",\n\t\tapiKey: config.apiKey,\n\t\tworkspaceId: config.workspaceId,\n\t});\n}\n","import * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport type {\n\tResolutionLayer,\n\tWorkspaceBinding,\n\tWorkspaceConfig,\n\tWorkspaceResolver,\n} from \"@snapback/contracts/workspace/workspace-resolution\";\nimport { createDefaultWorkspace, generateCacheKey } from \"@snapback/contracts/workspace/workspace-resolution\";\nimport type { WorkspaceApiClient } from \"./workspace-api-client\";\n\n/**\n * Stored workspace configuration file schema\n * This extends WorkspaceConfig with required fields for file-based storage\n */\ninterface StoredWorkspaceConfig {\n\t/** Required workspace identifier */\n\tworkspaceId: string;\n\t/** Optional workspace name */\n\tworkspaceName?: string;\n\t/** Workspace configuration settings */\n\tconfig?: WorkspaceConfig;\n}\n\n/**\n * 5-Layer Workspace Resolution Service\n *\n * Resolution hierarchy (priority order):\n * 1. repo_config - .snapback/config.json (team-wide, checked in)\n * 2. local_override - .snapback/local.json (user-specific, gitignored)\n * 3. instance_cache - device-local database (fastest lookup)\n * 4. server_suggestion - API-based heuristic using repo identity\n * 5. default_workspace - auto-created personal workspace\n *\n * Cache Strategy:\n * - TTL: 5 minutes\n * - Invalidation triggers: config_file_changed, workspace_binding_changed\n */\nexport class WorkspaceResolverImpl implements WorkspaceResolver {\n\tprivate cache: Map<string, { binding: WorkspaceBinding; timestamp: number }> = new Map();\n\n\tprivate readonly CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\tprivate readonly CONFIG_FILENAME = \".snapback/config.json\";\n\tprivate readonly LOCAL_FILENAME = \".snapback/local.json\";\n\n\tconstructor(private serverApiClient?: WorkspaceApiClient) {}\n\n\t/**\n\t * Resolve workspace for a repository using 5-layer hierarchy\n\t */\n\tasync resolve(repoPath: string, userId: string): Promise<WorkspaceBinding> {\n\t\tconst cacheKey = generateCacheKey(repoPath, userId);\n\n\t\t// Check cache first\n\t\tconst cached = this.cache.get(cacheKey);\n\t\tif (cached && Date.now() - cached.timestamp < this.CACHE_TTL_MS) {\n\t\t\treturn cached.binding;\n\t\t}\n\n\t\t// Layer 1: Check repo_config (.snapback/config.json)\n\t\tconst repoConfig = await this.readRepoConfig(repoPath);\n\t\tif (repoConfig?.workspaceId) {\n\t\t\tconst binding = await this.createBindingFromConfig(repoConfig, repoPath, userId, \"repo_config\");\n\t\t\tif (binding) {\n\t\t\t\tthis.cacheBinding(cacheKey, binding);\n\t\t\t\treturn binding;\n\t\t\t}\n\t\t}\n\n\t\t// Layer 2: Check local_override (.snapback/local.json)\n\t\tconst localConfig = await this.readLocalConfig(repoPath);\n\t\tif (localConfig?.workspaceId) {\n\t\t\tconst binding = await this.createBindingFromConfig(localConfig, repoPath, userId, \"local_override\");\n\t\t\tif (binding) {\n\t\t\t\tthis.cacheBinding(cacheKey, binding);\n\t\t\t\treturn binding;\n\t\t\t}\n\t\t}\n\n\t\t// Layer 3: Check instance_cache (already checked at start)\n\t\t// This is handled by the cache check above\n\n\t\t// Layer 4: Query server_suggestion (if API client available)\n\t\tif (this.serverApiClient) {\n\t\t\tconst suggestion = await this.serverApiClient.suggestWorkspace(repoPath, userId);\n\t\t\tif (suggestion) {\n\t\t\t\tthis.cacheBinding(cacheKey, suggestion);\n\t\t\t\treturn suggestion;\n\t\t\t}\n\t\t}\n\n\t\t// Layer 5: Fall back to default_workspace\n\t\tconst defaultBinding = createDefaultWorkspace(userId, repoPath);\n\t\tthis.cacheBinding(cacheKey, defaultBinding);\n\t\treturn defaultBinding;\n\t}\n\n\t/**\n\t * Resolve workspace by ID directly\n\t */\n\tasync resolveById(workspaceId: string, userId: string): Promise<WorkspaceBinding | null> {\n\t\t// Check cache for any matching workspace ID\n\t\tfor (const [_key, value] of this.cache.entries()) {\n\t\t\tif (value.binding.workspaceId === workspaceId && Date.now() - value.timestamp < this.CACHE_TTL_MS) {\n\t\t\t\treturn value.binding;\n\t\t\t}\n\t\t}\n\n\t\t// If server API available, query by ID\n\t\tif (this.serverApiClient) {\n\t\t\ttry {\n\t\t\t\tconst binding = await this.serverApiClient.getWorkspaceById(workspaceId, userId);\n\t\t\t\tif (binding) {\n\t\t\t\t\t// Cache the result\n\t\t\t\t\tconst cacheKey = generateCacheKey(binding.repoPath || workspaceId, userId);\n\t\t\t\t\tthis.cacheBinding(cacheKey, binding);\n\t\t\t\t\treturn binding;\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"[WorkspaceResolver] Failed to resolve workspace by ID:\", error);\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * Bind a repository to a specific workspace at a given layer\n\t */\n\tasync bind(repoPath: string, workspaceId: string, userId: string, layer: ResolutionLayer): Promise<boolean> {\n\t\ttry {\n\t\t\tconst storedConfig: StoredWorkspaceConfig = {\n\t\t\t\tworkspaceId,\n\t\t\t\tworkspaceName: undefined, // Will be resolved on next lookup\n\t\t\t};\n\n\t\t\tif (layer === \"repo_config\") {\n\t\t\t\tawait this.writeRepoConfig(repoPath, storedConfig);\n\t\t\t} else if (layer === \"local_override\") {\n\t\t\t\tawait this.writeLocalConfig(repoPath, storedConfig);\n\t\t\t} else if (layer === \"instance_cache\") {\n\t\t\t\t// Just update cache, no file write\n\t\t\t\tconst binding: WorkspaceBinding = {\n\t\t\t\t\tworkspaceId,\n\t\t\t\t\tworkspaceName: storedConfig.workspaceName || \"Workspace\",\n\t\t\t\t\trepoPath,\n\t\t\t\t\tuserId,\n\t\t\t\t\tpermissions: {\n\t\t\t\t\t\tread: true,\n\t\t\t\t\t\twrite: true,\n\t\t\t\t\t\tmanage: false,\n\t\t\t\t\t\tinvite: false,\n\t\t\t\t\t},\n\t\t\t\t\tresolvedFrom: \"instance_cache\",\n\t\t\t\t};\n\t\t\t\tconst cacheKey = generateCacheKey(repoPath, userId);\n\t\t\t\tthis.cacheBinding(cacheKey, binding);\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Cannot bind at layer ${layer} - only repo_config, local_override, and instance_cache are writable`,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Invalidate cache for this repo\n\t\t\tawait this.invalidateCache(repoPath);\n\n\t\t\treturn true;\n\t\t} catch (error) {\n\t\t\tconsole.error(`[WorkspaceResolver] Failed to bind workspace at layer ${layer}:`, error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Unbind a repository (remove workspace binding)\n\t */\n\tasync unbind(repoPath: string, _userId: string): Promise<boolean> {\n\t\ttry {\n\t\t\t// Remove local override file if it exists\n\t\t\tconst localPath = path.join(repoPath, this.LOCAL_FILENAME);\n\t\t\ttry {\n\t\t\t\tawait fs.unlink(localPath);\n\t\t\t} catch {\n\t\t\t\t// Ignore if file doesn't exist\n\t\t\t}\n\n\t\t\t// Invalidate cache\n\t\t\tawait this.invalidateCache(repoPath);\n\n\t\t\treturn true;\n\t\t} catch (error) {\n\t\t\tconsole.error(\"[WorkspaceResolver] Failed to unbind workspace:\", error);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * List all workspaces for a user\n\t */\n\tasync listWorkspaces(userId: string): Promise<WorkspaceBinding[]> {\n\t\tconst workspaces: WorkspaceBinding[] = [];\n\n\t\t// Get unique workspaces from cache\n\t\tconst seen = new Set<string>();\n\t\tfor (const [_key, value] of this.cache.entries()) {\n\t\t\tif (value.binding.userId === userId && !seen.has(value.binding.workspaceId)) {\n\t\t\t\tworkspaces.push(value.binding);\n\t\t\t\tseen.add(value.binding.workspaceId);\n\t\t\t}\n\t\t}\n\n\t\t// If server API available, get comprehensive list\n\t\tif (this.serverApiClient) {\n\t\t\ttry {\n\t\t\t\tconst serverWorkspaces = await this.serverApiClient.listWorkspaces(userId);\n\t\t\t\t// Merge with cached workspaces, preferring server data\n\t\t\t\tfor (const ws of serverWorkspaces) {\n\t\t\t\t\tif (!seen.has(ws.workspaceId)) {\n\t\t\t\t\t\tworkspaces.push(ws);\n\t\t\t\t\t\tseen.add(ws.workspaceId);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\"[WorkspaceResolver] Failed to list workspaces from server:\", error);\n\t\t\t\t// Return cached workspaces on error\n\t\t\t}\n\t\t}\n\n\t\treturn workspaces;\n\t}\n\n\t/**\n\t * Invalidate cache for a specific repository\n\t */\n\tasync invalidateCache(repoPath: string): Promise<void> {\n\t\t// Remove all cache entries for this repo\n\t\tconst keysToDelete: string[] = [];\n\t\tfor (const [key, _value] of this.cache.entries()) {\n\t\t\tif (key.startsWith(`${repoPath}:`)) {\n\t\t\t\tkeysToDelete.push(key);\n\t\t\t}\n\t\t}\n\t\tfor (const key of keysToDelete) {\n\t\t\tthis.cache.delete(key);\n\t\t}\n\t}\n\n\t// Private helper methods\n\n\tprivate async readRepoConfig(repoPath: string): Promise<StoredWorkspaceConfig | null> {\n\t\tconst configPath = path.join(repoPath, this.CONFIG_FILENAME);\n\t\treturn this.readConfigFile(configPath);\n\t}\n\n\tprivate async readLocalConfig(repoPath: string): Promise<StoredWorkspaceConfig | null> {\n\t\tconst configPath = path.join(repoPath, this.LOCAL_FILENAME);\n\t\treturn this.readConfigFile(configPath);\n\t}\n\n\tprivate async readConfigFile(filePath: string): Promise<StoredWorkspaceConfig | null> {\n\t\ttry {\n\t\t\tconst content = await fs.readFile(filePath, \"utf-8\");\n\t\t\tconst config = JSON.parse(content) as StoredWorkspaceConfig;\n\t\t\treturn config;\n\t\t} catch {\n\t\t\t// File doesn't exist or invalid JSON\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tprivate async writeRepoConfig(repoPath: string, config: StoredWorkspaceConfig): Promise<void> {\n\t\tconst configPath = path.join(repoPath, this.CONFIG_FILENAME);\n\t\tawait this.writeConfigFile(configPath, config);\n\t}\n\n\tprivate async writeLocalConfig(repoPath: string, config: StoredWorkspaceConfig): Promise<void> {\n\t\tconst configPath = path.join(repoPath, this.LOCAL_FILENAME);\n\t\tawait this.writeConfigFile(configPath, config);\n\t}\n\n\tprivate async writeConfigFile(filePath: string, config: StoredWorkspaceConfig): Promise<void> {\n\t\t// Ensure directory exists\n\t\tconst dir = path.dirname(filePath);\n\t\tawait fs.mkdir(dir, { recursive: true });\n\n\t\t// Write config\n\t\tconst content = JSON.stringify(config, null, 2);\n\t\tawait fs.writeFile(filePath, content, \"utf-8\");\n\t}\n\n\tprivate async createBindingFromConfig(\n\t\tconfig: StoredWorkspaceConfig,\n\t\trepoPath: string,\n\t\tuserId: string,\n\t\tlayer: ResolutionLayer,\n\t): Promise<WorkspaceBinding | null> {\n\t\t// If server API available and online, query for full workspace details\n\t\tif (this.serverApiClient) {\n\t\t\ttry {\n\t\t\t\tconst serverBinding = await this.serverApiClient.getWorkspaceById(config.workspaceId, userId);\n\t\t\t\tif (serverBinding) {\n\t\t\t\t\t// Return server binding but override resolvedFrom with actual layer\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...serverBinding,\n\t\t\t\t\t\trepoPath,\n\t\t\t\t\t\tresolvedFrom: layer,\n\t\t\t\t\t\tconfig: config.config,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Server unavailable, fall through to local binding\n\t\t\t}\n\t\t}\n\n\t\t// Create a basic binding from config (offline fallback)\n\t\treturn {\n\t\t\tworkspaceId: config.workspaceId,\n\t\t\tworkspaceName: config.workspaceName || \"Workspace\",\n\t\t\trepoPath,\n\t\t\tuserId,\n\t\t\tpermissions: {\n\t\t\t\tread: true,\n\t\t\t\twrite: true,\n\t\t\t\tmanage: false,\n\t\t\t\tinvite: false,\n\t\t\t},\n\t\t\tresolvedFrom: layer,\n\t\t\tconfig: config.config,\n\t\t};\n\t}\n\n\tprivate cacheBinding(cacheKey: string, binding: WorkspaceBinding): void {\n\t\tthis.cache.set(cacheKey, {\n\t\t\tbinding,\n\t\t\ttimestamp: Date.now(),\n\t\t});\n\t}\n}\n","/**\n * SnapBack Daemon Constants\n *\n * Centralized constants for daemon configuration, limits, and timeouts.\n *\n * @module daemon/constants\n */\n\n// =============================================================================\n// TIMEOUTS\n// =============================================================================\n\n/**\n * Default idle timeout in milliseconds (15 minutes)\n * Daemon will shutdown after this period of inactivity\n */\nexport const DEFAULT_IDLE_TIMEOUT_MS = 15 * 60 * 1000;\n\n/**\n * Default request timeout in milliseconds (30 seconds)\n */\nexport const DEFAULT_REQUEST_TIMEOUT_MS = 30 * 1000;\n\n/**\n * Operation timeout for individual handlers (10 seconds)\n */\nexport const OPERATION_TIMEOUT_MS = 10 * 1000;\n\n/**\n * Daemon startup wait timeout (5 seconds)\n */\nexport const DAEMON_STARTUP_TIMEOUT_MS = 5 * 1000;\n\n/**\n * Daemon startup check interval (100ms)\n */\nexport const DAEMON_STARTUP_CHECK_INTERVAL_MS = 100;\n\n/**\n * Reconnection base delay (100ms)\n */\nexport const RECONNECT_BASE_DELAY_MS = 100;\n\n/**\n * Maximum reconnection delay (10 seconds)\n */\nexport const RECONNECT_MAX_DELAY_MS = 10 * 1000;\n\n/**\n * Maximum reconnection attempts\n */\nexport const RECONNECT_MAX_ATTEMPTS = 5;\n\n// =============================================================================\n// LIMITS\n// =============================================================================\n\n/**\n * Maximum connections allowed\n */\nexport const MAX_CONNECTIONS = 10;\n\n/**\n * Maximum buffer size per connection (1MB)\n */\nexport const MAX_BUFFER_SIZE = 1024 * 1024;\n\n/**\n * Maximum pending requests per client\n */\nexport const MAX_PENDING_REQUESTS = 100;\n\n/**\n * Maximum log file size before rotation (10MB)\n */\nexport const MAX_LOG_SIZE = 10 * 1024 * 1024;\n\n/**\n * Maximum path length for validation\n */\nexport const MAX_PATH_LENGTH = 4096;\n\n// =============================================================================\n// FILE NAMES\n// =============================================================================\n\n/**\n * Daemon directory name\n */\nexport const DAEMON_DIR = \"daemon\";\n\n/**\n * Socket file name\n */\nexport const SOCKET_NAME = \"daemon.sock\";\n\n/**\n * PID file name\n */\nexport const PID_FILE = \"daemon.pid\";\n\n/**\n * Lock file name\n */\nexport const LOCK_FILE = \"daemon.lock\";\n\n/**\n * Log file name\n */\nexport const LOG_FILE = \"daemon.log\";\n\n/**\n * State file name\n */\nexport const STATE_FILE = \"state.json\";\n\n// =============================================================================\n// SOCKET PERMISSIONS\n// =============================================================================\n\n/**\n * Unix socket permissions (owner read/write only)\n */\nexport const SOCKET_PERMISSIONS = 0o600;\n\n/**\n * PID file permissions (owner read/write only)\n */\nexport const PID_FILE_PERMISSIONS = 0o600;\n\n// =============================================================================\n// PROTOCOL\n// =============================================================================\n\n/**\n * JSON-RPC version\n */\nexport const JSONRPC_VERSION = \"2.0\";\n\n/**\n * Message delimiter\n */\nexport const MESSAGE_DELIMITER = \"\\n\";\n\n/**\n * Windows named pipe prefix\n */\nexport const WINDOWS_PIPE_PREFIX = \"\\\\\\\\.\\\\pipe\\\\\";\n\n/**\n * Windows named pipe name\n */\nexport const WINDOWS_PIPE_NAME = \"snapback-daemon\";\n\n// =============================================================================\n// HEALTH CHECK\n// =============================================================================\n\n/**\n * Default health check port\n */\nexport const DEFAULT_HEALTH_PORT = 3847;\n\n// =============================================================================\n// VERSION\n// =============================================================================\n\n/**\n * Daemon protocol version\n */\nexport const DAEMON_VERSION = \"1.0.0\";\n","/**\n * SnapBack Path Validator\n *\n * Comprehensive path validation to prevent path traversal attacks.\n * Based on the more restrictive VS Code PathValidator implementation.\n *\n * Security features:\n * - Path traversal detection (../)\n * - Windows UNC path detection\n * - Windows alternate data streams detection\n * - URL-encoded traversal detection\n * - Null byte injection detection\n * - Symlink validation (optional)\n * - Separator-aware boundary checking\n *\n * @module daemon/path-validator\n */\n\nimport { lstat } from \"node:fs/promises\";\nimport { isAbsolute, normalize, relative, resolve, sep } from \"node:path\";\nimport { MAX_PATH_LENGTH } from \"./constants.js\";\nimport { PathTraversalError, ValidationError } from \"./errors.js\";\n\n// =============================================================================\n// VALIDATION OPTIONS\n// =============================================================================\n\nexport interface PathValidationOptions {\n\t/** Whether to allow absolute paths (default: false) */\n\tallowAbsolute?: boolean;\n\t/** Whether to check for symlinks (default: false, can be slow) */\n\tcheckSymlinks?: boolean;\n\t/** Maximum allowed path length (default: MAX_PATH_LENGTH) */\n\tmaxLength?: number;\n\t/** Custom base directory for relative path resolution */\n\tbaseDir?: string;\n}\n\n// =============================================================================\n// DANGEROUS PATTERNS\n// =============================================================================\n\n/**\n * Patterns that indicate path traversal attempts\n */\nconst TRAVERSAL_PATTERNS = [\n\t// Direct traversal\n\t/\\.\\./,\n\t// URL-encoded traversal\n\t/%2e%2e/i,\n\t/%252e%252e/i,\n\t// Unicode traversal\n\t/\\u002e\\u002e/,\n\t// Backslash variants (Windows)\n\t/\\.\\.[\\\\/]/,\n\t/[\\\\/]\\.\\./,\n];\n\n/**\n * Windows-specific dangerous patterns\n */\nconst WINDOWS_DANGEROUS_PATTERNS = [\n\t// UNC paths\n\t/^\\\\\\\\[^\\\\]+\\\\/,\n\t/^\\/\\/[^/]+\\//,\n\t// Alternate data streams\n\t/:/g,\n\t// Device paths\n\t/^(?:CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])(?:\\.|$)/i,\n];\n\n/**\n * Characters that should never appear in paths\n */\nconst DANGEROUS_CHARS = [\n\t\"\\0\", // Null byte\n\t\"\\x00\", // Null byte (hex)\n\t\"\\n\", // Newline (could break log parsing)\n\t\"\\r\", // Carriage return\n];\n\n// =============================================================================\n// PATH VALIDATOR CLASS\n// =============================================================================\n\nexport class PathValidator {\n\tprivate readonly options: Required<PathValidationOptions>;\n\n\tconstructor(options: PathValidationOptions = {}) {\n\t\tthis.options = {\n\t\t\tallowAbsolute: options.allowAbsolute ?? false,\n\t\t\tcheckSymlinks: options.checkSymlinks ?? false,\n\t\t\tmaxLength: options.maxLength ?? MAX_PATH_LENGTH,\n\t\t\tbaseDir: options.baseDir ?? process.cwd(),\n\t\t};\n\t}\n\n\t/**\n\t * Validate a path within a workspace\n\t *\n\t * @param workspace - The workspace root directory (must be absolute)\n\t * @param filePath - The file path to validate (can be relative or absolute)\n\t * @throws PathTraversalError if path escapes workspace\n\t * @throws ValidationError if path is invalid\n\t */\n\tvalidatePath(workspace: string, filePath: string): void {\n\t\t// Basic validation\n\t\tthis.validateBasic(filePath);\n\n\t\t// Resolve the workspace (must be absolute)\n\t\tconst resolvedWorkspace = resolve(workspace);\n\n\t\t// Resolve the file path relative to workspace\n\t\tconst resolvedFile = isAbsolute(filePath) ? resolve(filePath) : resolve(resolvedWorkspace, filePath);\n\n\t\t// Check that resolved path is within workspace\n\t\tconst relativePath = relative(resolvedWorkspace, resolvedFile);\n\n\t\t// If relative path starts with .. or is absolute, it escapes workspace\n\t\tif (relativePath.startsWith(\"..\") || isAbsolute(relativePath)) {\n\t\t\tthrow new PathTraversalError(filePath);\n\t\t}\n\n\t\t// Normalize and check again (handles edge cases)\n\t\tconst normalizedRelative = normalize(relativePath);\n\t\tif (normalizedRelative.startsWith(\"..\")) {\n\t\t\tthrow new PathTraversalError(filePath);\n\t\t}\n\t}\n\n\t/**\n\t * Validate basic path properties without workspace context\n\t *\n\t * @param filePath - The file path to validate\n\t * @throws ValidationError if path is invalid\n\t */\n\tvalidateBasic(filePath: string): void {\n\t\t// Check for null/undefined\n\t\tif (filePath == null) {\n\t\t\tthrow new ValidationError(\"Path is required\");\n\t\t}\n\n\t\t// Check type\n\t\tif (typeof filePath !== \"string\") {\n\t\t\tthrow new ValidationError(\"Path must be a string\");\n\t\t}\n\n\t\t// Check for empty path\n\t\tif (filePath.trim() === \"\") {\n\t\t\tthrow new ValidationError(\"Path cannot be empty\");\n\t\t}\n\n\t\t// Check length\n\t\tif (filePath.length > this.options.maxLength) {\n\t\t\tthrow new ValidationError(`Path too long: ${filePath.length} chars (max: ${this.options.maxLength})`);\n\t\t}\n\n\t\t// Check for dangerous characters\n\t\tfor (const char of DANGEROUS_CHARS) {\n\t\t\tif (filePath.includes(char)) {\n\t\t\t\tthrow new ValidationError(`Path contains dangerous character: ${JSON.stringify(char)}`);\n\t\t\t}\n\t\t}\n\n\t\t// Check for traversal patterns\n\t\tfor (const pattern of TRAVERSAL_PATTERNS) {\n\t\t\tif (pattern.test(filePath)) {\n\t\t\t\tthrow new PathTraversalError(filePath);\n\t\t\t}\n\t\t}\n\n\t\t// Check for Windows-specific dangerous patterns\n\t\tif (process.platform === \"win32\") {\n\t\t\tfor (const pattern of WINDOWS_DANGEROUS_PATTERNS) {\n\t\t\t\tif (pattern.test(filePath)) {\n\t\t\t\t\tthrow new ValidationError(`Path contains dangerous Windows pattern: ${filePath}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// On Unix, still check for Windows UNC paths (could be used in attack)\n\t\t\tif (filePath.startsWith(\"\\\\\\\\\") || filePath.includes(\":\")) {\n\t\t\t\tthrow new ValidationError(`Path contains Windows-style characters: ${filePath}`);\n\t\t\t}\n\t\t}\n\n\t\t// Check for absolute paths if not allowed\n\t\tif (!this.options.allowAbsolute && isAbsolute(filePath)) {\n\t\t\tthrow new ValidationError(`Absolute paths not allowed: ${filePath}`);\n\t\t}\n\t}\n\n\t/**\n\t * Validate a path and check for symlinks (async)\n\t *\n\t * @param workspace - The workspace root directory\n\t * @param filePath - The file path to validate\n\t * @throws PathTraversalError if path escapes workspace (including via symlink)\n\t */\n\tasync validatePathWithSymlinkCheck(workspace: string, filePath: string): Promise<void> {\n\t\t// First do basic validation\n\t\tthis.validatePath(workspace, filePath);\n\n\t\t// Then check for symlinks if enabled\n\t\tif (this.options.checkSymlinks) {\n\t\t\tconst resolvedWorkspace = resolve(workspace);\n\t\t\tconst resolvedFile = isAbsolute(filePath) ? resolve(filePath) : resolve(resolvedWorkspace, filePath);\n\n\t\t\ttry {\n\t\t\t\tconst stats = await lstat(resolvedFile);\n\t\t\t\tif (stats.isSymbolicLink()) {\n\t\t\t\t\t// For symlinks, we need to check the real path\n\t\t\t\t\tconst { realpath } = await import(\"node:fs/promises\");\n\t\t\t\t\tconst realPath = await realpath(resolvedFile);\n\t\t\t\t\tconst realRelative = relative(resolvedWorkspace, realPath);\n\n\t\t\t\t\tif (realRelative.startsWith(\"..\") || isAbsolute(realRelative)) {\n\t\t\t\t\t\tthrow new PathTraversalError(`Symlink escapes workspace: ${filePath} -> ${realPath}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\t// File doesn't exist yet, that's OK for some operations\n\t\t\t\tif ((err as NodeJS.ErrnoException).code !== \"ENOENT\") {\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Validate multiple paths\n\t *\n\t * @param workspace - The workspace root directory\n\t * @param filePaths - Array of file paths to validate\n\t * @throws PathTraversalError if any path escapes workspace\n\t */\n\tvalidatePaths(workspace: string, filePaths: string[]): void {\n\t\tfor (const filePath of filePaths) {\n\t\t\tthis.validatePath(workspace, filePath);\n\t\t}\n\t}\n\n\t/**\n\t * Sanitize a path by removing dangerous components\n\t * Note: This is a best-effort sanitization, validation should still be used\n\t *\n\t * @param filePath - The file path to sanitize\n\t * @returns Sanitized path\n\t */\n\tsanitizePath(filePath: string): string {\n\t\tlet sanitized = filePath;\n\n\t\t// Remove null bytes\n\t\tsanitized = sanitized.replace(/\\0/g, \"\");\n\n\t\t// Remove URL encoding of ..\n\t\tsanitized = sanitized.replace(/%2e%2e/gi, \"\");\n\t\tsanitized = sanitized.replace(/%252e%252e/gi, \"\");\n\n\t\t// Normalize path separators\n\t\tsanitized = sanitized.replace(/\\\\/g, sep);\n\n\t\t// Normalize the path\n\t\tsanitized = normalize(sanitized);\n\n\t\t// Remove leading .. components\n\t\twhile (sanitized.startsWith(`..${sep}`) || sanitized === \"..\") {\n\t\t\tsanitized = sanitized.slice(3);\n\t\t}\n\n\t\treturn sanitized;\n\t}\n}\n\n// =============================================================================\n// CONVENIENCE FUNCTIONS\n// =============================================================================\n\n/**\n * Default validator instance\n */\nconst defaultValidator = new PathValidator();\n\n/**\n * Validate a path within a workspace\n *\n * @param workspace - The workspace root directory\n * @param filePath - The file path to validate\n * @throws PathTraversalError if path escapes workspace\n */\nexport function validatePath(workspace: string, filePath: string): void {\n\tdefaultValidator.validatePath(workspace, filePath);\n}\n\n/**\n * Validate multiple paths within a workspace\n *\n * @param workspace - The workspace root directory\n * @param filePaths - Array of file paths to validate\n * @throws PathTraversalError if any path escapes workspace\n */\nexport function validatePaths(workspace: string, filePaths: string[]): void {\n\tdefaultValidator.validatePaths(workspace, filePaths);\n}\n\n/**\n * Validate basic path properties\n *\n * @param filePath - The file path to validate\n * @throws ValidationError if path is invalid\n */\nexport function validateBasicPath(filePath: string): void {\n\tdefaultValidator.validateBasic(filePath);\n}\n\n/**\n * Sanitize a path by removing dangerous components\n *\n * @param filePath - The file path to sanitize\n * @returns Sanitized path\n */\nexport function sanitizePath(filePath: string): string {\n\treturn defaultValidator.sanitizePath(filePath);\n}\n","/**\n * SnapBack Daemon Server\n *\n * Long-running process that handles CLI/Extension requests via IPC.\n * Features:\n * - Lazy start (spawned on first request)\n * - Idle shutdown (after 15 min of inactivity)\n * - Workspace-aware (multiple workspace contexts)\n * - Crash resilient (persists critical state)\n * - Signal handling (SIGTERM, SIGINT, SIGHUP on Unix)\n * - Socket permission enforcement (Unix) / Named pipe security (Windows)\n * - Path validation for security\n * - Backpressure handling\n * - Structured logging with correlation IDs\n *\n * @module daemon/server\n */\n\nimport { EventEmitter } from \"node:events\";\nimport { chmodSync, existsSync, mkdirSync, unlinkSync, writeFileSync } from \"node:fs\";\nimport { mkdir, readFile, writeFile } from \"node:fs/promises\";\nimport { createServer as createHttpServer, type Server as HttpServer } from \"node:http\";\nimport { createServer, type Server, type Socket } from \"node:net\";\nimport { platform } from \"node:os\";\nimport { dirname, join, relative } from \"node:path\";\nimport { createRuntimeContext, type ISnapshotStorage, LocalEngineAdapter, RuntimeRouter } from \"@snapback/core-runtime\";\nimport { Intelligence } from \"@snapback/intelligence\";\nimport { LocalStorage, SnapshotManager } from \"@snapback/sdk\";\n\nimport {\n\tDEFAULT_HEALTH_PORT,\n\tDEFAULT_IDLE_TIMEOUT_MS,\n\tMAX_BUFFER_SIZE,\n\tMAX_CONNECTIONS,\n\tOPERATION_TIMEOUT_MS,\n\tSOCKET_PERMISSIONS,\n\tSTATE_FILE,\n} from \"./constants.js\";\nimport {\n\tDaemonError,\n\tInvalidParamsError,\n\tMethodNotFoundError,\n\tParseError,\n\tRequestTooLargeError,\n\tTimeoutError,\n\ttoDaemonError,\n\tWorkspaceNotFoundError,\n} from \"./errors.js\";\nimport { disposeFileWatcherService, type FileChangeEvent, getFileWatcherService } from \"./file-watcher.js\";\nimport { type DaemonLogger, generateRequestId, initLogger } from \"./logger.js\";\nimport { validatePath, validatePaths } from \"./path-validator.js\";\nimport { acquireLock, getDaemonDir, getLogPath, releaseLock } from \"./platform.js\";\nimport type { DaemonMethod, DaemonRequest, DaemonResponse, WorkspaceContext } from \"./protocol.js\";\nimport {\n\tcreateErrorResponse,\n\tcreateNotification,\n\tcreateResponse,\n\tErrorCodes,\n\tparseRequest,\n\tserializeResponse,\n} from \"./protocol.js\";\n\n// =============================================================================\n// PLATFORM DETECTION\n// =============================================================================\n\nconst IS_WINDOWS = platform() === \"win32\";\n\n// =============================================================================\n// INTELLIGENCE SINGLETON\n// =============================================================================\n\n/**\n * Intelligence instances per workspace (singleton pattern for cross-surface coordination)\n */\nconst intelligenceInstances = new Map<string, Intelligence>();\n\n/**\n * Get or create Intelligence instance for a workspace\n */\nfunction getIntelligence(workspaceRoot: string): Intelligence {\n\tif (!intelligenceInstances.has(workspaceRoot)) {\n\t\tconst intel = new Intelligence({\n\t\t\trootDir: workspaceRoot,\n\t\t\tenableSemanticSearch: false,\n\t\t\tenableLearningLoop: true,\n\t\t\tpatternsDir: \".snapback/patterns\",\n\t\t\tlearningsDir: \".snapback/learnings\",\n\t\t\tconstraintsFile: \".snapback/constraints.json\",\n\t\t\t// Session persistence for cross-surface coordination (Extension, MCP, CLI, Daemon)\n\t\t\tsessionPersistence: {\n\t\t\t\tpath: join(workspaceRoot, \".snapback/session/sessions.jsonl\"),\n\t\t\t\tautosave: true,\n\t\t\t},\n\t\t});\n\t\tintelligenceInstances.set(workspaceRoot, intel);\n\t}\n\treturn intelligenceInstances.get(workspaceRoot)!;\n}\n\n// =============================================================================\n// RUNTIME ROUTER SINGLETON (ADR-001 Core Runtime Architecture)\n// =============================================================================\n\n/**\n * RuntimeRouter instances per workspace (singleton pattern for ADR-001 compliance)\n * Per ADR-001: Use RuntimeRouter for connectivity-aware routing between local and platform.\n * Daemon operates in local-first mode with privacy by default.\n */\nexport const runtimeRouterInstances = new Map<string, RuntimeRouter>();\n\n/**\n * Get or create RuntimeRouter instance for a workspace.\n * Per ADR-001: Routes snapshot operations through RuntimeRouter instead of direct storage access.\n *\n * @param workspaceRoot - Absolute path to workspace root\n * @returns RuntimeRouter instance configured for local-first operation\n */\nexport function getRuntimeRouter(workspaceRoot: string): RuntimeRouter {\n\tif (!runtimeRouterInstances.has(workspaceRoot)) {\n\t\t// Create storage adapter (SQLite-based, same as SnapshotManager)\n\t\tconst dbPath = join(workspaceRoot, \".snapback\", \"snapshots.db\");\n\t\tconst storage = new LocalStorage(dbPath);\n\n\t\t// Wrap storage with LocalEngineAdapter (ADR-001 ILocalEngine interface)\n\t\tconst localEngine = new LocalEngineAdapter(storage as unknown as ISnapshotStorage);\n\n\t\t// Create runtime context for daemon (local-first, privacy by default)\n\t\tconst context = createRuntimeContext({\n\t\t\tconnectivity: \"offline\", // Daemon assumes local-first operation\n\t\t\tauthState: \"anonymous\", // No platform auth in daemon\n\t\t\ttier: \"free\",\n\t\t\tprivacyMode: true, // Privacy by default for local operations\n\t\t\tfeatureFlags: {},\n\t\t\tworkspace: {\n\t\t\t\tpath: workspaceRoot,\n\t\t\t},\n\t\t});\n\n\t\t// Create RuntimeRouter with local engine only (no platform runtime for daemon)\n\t\tconst router = new RuntimeRouter(\n\t\t\tlocalEngine,\n\t\t\tnull, // No platform runtime - daemon is local-only\n\t\t\tcontext,\n\t\t\t{\n\t\t\t\tenableSyncQueue: false, // No sync queue for local-only daemon\n\t\t\t},\n\t\t);\n\n\t\truntimeRouterInstances.set(workspaceRoot, router);\n\t}\n\n\treturn runtimeRouterInstances.get(workspaceRoot)!;\n}\n\n/**\n * Dispose all RuntimeRouter instances.\n * Should be called during daemon shutdown for proper resource cleanup.\n */\nexport async function disposeRuntimeRouters(): Promise<void> {\n\tconst disposePromises = Array.from(runtimeRouterInstances.values()).map((router) => router.dispose());\n\n\tawait Promise.all(disposePromises);\n\truntimeRouterInstances.clear();\n}\n\n// =============================================================================\n// SNAPSHOT MANAGER SINGLETON (ARCHITECTURE_REFACTOR_SPEC.md Phase 2)\n// =============================================================================\n\n/**\n * SnapshotManager instances per workspace (singleton pattern for SDK integration)\n * Per ARCHITECTURE_REFACTOR_SPEC.md Phase 2: Import OSS SDK\n */\nconst snapshotManagerInstances = new Map<string, SnapshotManager>();\nconst storageInstances = new Map<string, LocalStorage>();\n\n/**\n * Get or create SnapshotManager instance for a workspace.\n * Per ARCHITECTURE_REFACTOR_SPEC.md Phase 2: Wire CLI daemon handlers to use SDK packages.\n */\nfunction getSnapshotManager(workspaceRoot: string): SnapshotManager {\n\tif (!snapshotManagerInstances.has(workspaceRoot)) {\n\t\t// Create storage adapter (SQLite-based)\n\t\tconst dbPath = join(workspaceRoot, \".snapback\", \"snapshots.db\");\n\t\tconst storage = new LocalStorage(dbPath);\n\t\tstorageInstances.set(workspaceRoot, storage);\n\n\t\t// Create SnapshotManager with deduplication enabled\n\t\tconst manager = new SnapshotManager(storage, {\n\t\t\tenableDeduplication: true,\n\t\t\tnamingStrategy: \"semantic\",\n\t\t\tautoProtect: false,\n\t\t});\n\t\tsnapshotManagerInstances.set(workspaceRoot, manager);\n\t}\n\treturn snapshotManagerInstances.get(workspaceRoot)!;\n}\n\n// =============================================================================\n// CONFIGURATION\n// =============================================================================\n\nexport interface DaemonConfig {\n\t/** Path to Unix socket or Windows named pipe */\n\tsocketPath: string;\n\t/** Path to PID file */\n\tpidPath: string;\n\t/** Path to lock file (optional, defaults to global lock path) */\n\tlockPath?: string;\n\t/** Idle timeout in milliseconds before shutdown */\n\tidleTimeoutMs: number;\n\t/** Maximum concurrent connections */\n\tmaxConnections: number;\n\t/** Daemon version */\n\tversion: string;\n\t/** Enable health check HTTP endpoint */\n\tenableHealthCheck?: boolean;\n\t/** Health check port (default: 3847) */\n\thealthPort?: number;\n}\n\n// =============================================================================\n// PERSISTED STATE\n// =============================================================================\n\ninterface PersistedState {\n\tworkspaces: Array<{\n\t\tkey: string;\n\t\tid: string;\n\t\troot: string;\n\t\tsessionActive: boolean;\n\t\tcurrentTaskId?: string;\n\t\tsnapshotCount: number;\n\t\tlastActivity: number;\n\t}>;\n\tlastPersisted: number;\n\tversion: string;\n}\n\n// =============================================================================\n// CONNECTION CONTEXT\n// =============================================================================\n\ninterface ConnectionContext {\n\tsocket: Socket;\n\tbuffer: string;\n\tworkspace?: string;\n\tpaused: boolean;\n}\n\n// =============================================================================\n// DAEMON SERVER CLASS\n// =============================================================================\n\nexport class SnapBackDaemon extends EventEmitter {\n\tprivate server: Server | null = null;\n\tprivate healthServer: HttpServer | null = null;\n\tprivate connections = new Map<Socket, ConnectionContext>();\n\tprivate workspaces = new Map<string, WorkspaceContext>();\n\tprivate idleTimer: NodeJS.Timeout | null = null;\n\tprivate startTime = 0;\n\tprivate lastActivity = 0;\n\tprivate _isRunning = false;\n\tprivate _isShuttingDown = false;\n\tprivate logger: DaemonLogger;\n\tprivate lockAcquired = false;\n\tprivate signalHandlersRegistered = false;\n\n\tconstructor(private config: DaemonConfig) {\n\t\tsuper();\n\t\t// Initialize logger\n\t\tthis.logger = initLogger(getLogPath(), { minLevel: \"info\" });\n\t}\n\n\t// =========================================================================\n\t// LIFECYCLE\n\t// =========================================================================\n\n\t/**\n\t * Start the daemon server\n\t */\n\tasync start(): Promise<void> {\n\t\tif (this._isRunning) {\n\t\t\tthrow new Error(\"Daemon already running\");\n\t\t}\n\n\t\tthis.logger.info(\"Daemon starting\", { version: this.config.version, platform: platform() });\n\n\t\t// Acquire lock to prevent race conditions\n\t\tconst locked = await acquireLock(this.config.lockPath);\n\t\tif (!locked) {\n\t\t\tthrow new Error(\"Another daemon is starting. Please wait or check for stale lock file.\");\n\t\t}\n\t\tthis.lockAcquired = true;\n\n\t\ttry {\n\t\t\tthis.startTime = Date.now();\n\t\t\tthis.lastActivity = Date.now();\n\n\t\t\t// Ensure daemon directory exists\n\t\t\tconst dir = dirname(this.config.pidPath);\n\t\t\tif (!existsSync(dir)) {\n\t\t\t\tmkdirSync(dir, { recursive: true });\n\t\t\t}\n\n\t\t\t// Write PID file\n\t\t\twriteFileSync(this.config.pidPath, String(process.pid));\n\n\t\t\t// Clean up stale socket (Unix only - Windows named pipes don't have file residue)\n\t\t\tif (!IS_WINDOWS && existsSync(this.config.socketPath)) {\n\t\t\t\tunlinkSync(this.config.socketPath);\n\t\t\t}\n\n\t\t\t// Create and start server\n\t\t\tconst server = createServer(this.handleConnection.bind(this));\n\t\t\tthis.server = server;\n\n\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\tserver.listen(this.config.socketPath, () => {\n\t\t\t\t\t// Set socket permissions (Unix only)\n\t\t\t\t\t// Windows named pipes have different security model (ACLs)\n\t\t\t\t\tif (!IS_WINDOWS) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tchmodSync(this.config.socketPath, SOCKET_PERMISSIONS);\n\t\t\t\t\t\t\tthis.logger.debug(\"Socket permissions set\", { mode: SOCKET_PERMISSIONS.toString(8) });\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tthis.logger.warn(\"Failed to set socket permissions\", { error: String(err) });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._isRunning = true;\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t\tserver.on(\"error\", reject);\n\t\t\t});\n\n\t\t\t// Start health check endpoint if enabled\n\t\t\tif (this.config.enableHealthCheck) {\n\t\t\t\tawait this.startHealthEndpoint(this.config.healthPort ?? DEFAULT_HEALTH_PORT);\n\t\t\t}\n\n\t\t\t// Register signal handlers\n\t\t\tthis.registerSignalHandlers();\n\n\t\t\t// Start idle timer\n\t\t\tthis.resetIdleTimer();\n\n\t\t\t// Restore persisted state\n\t\t\tawait this.restoreState();\n\n\t\t\t// Initialize file watcher service and wire up events\n\t\t\tthis.initFileWatcherEvents();\n\n\t\t\tthis.logger.info(\"Daemon started\", {\n\t\t\t\tpid: process.pid,\n\t\t\t\tsocket: this.config.socketPath,\n\t\t\t\tversion: this.config.version,\n\t\t\t});\n\n\t\t\t// Emit started event\n\t\t\tthis.emit(\"started\");\n\t\t} catch (err) {\n\t\t\t// Clean up on failure\n\t\t\tawait releaseLock(this.config.lockPath);\n\t\t\tthis.lockAcquired = false;\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\t/**\n\t * Shutdown the daemon gracefully\n\t */\n\tasync shutdown(): Promise<void> {\n\t\tif (!this._isRunning || this._isShuttingDown) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._isShuttingDown = true;\n\t\tthis.logger.info(\"Daemon shutting down\");\n\t\tthis.emit(\"shutting_down\");\n\n\t\t// Persist state for crash recovery\n\t\tawait this.persistState();\n\n\t\t// Stop accepting new connections\n\t\tif (this.server) {\n\t\t\tthis.server.close();\n\t\t\tthis.server = null;\n\t\t}\n\n\t\t// Stop health check endpoint\n\t\tif (this.healthServer) {\n\t\t\tthis.healthServer.close();\n\t\t\tthis.healthServer = null;\n\t\t}\n\n\t\t// Clear idle timer\n\t\tif (this.idleTimer) {\n\t\t\tclearTimeout(this.idleTimer);\n\t\t\tthis.idleTimer = null;\n\t\t}\n\n\t\t// Close all connections gracefully\n\t\tfor (const [socket, _ctx] of this.connections) {\n\t\t\t// Send shutdown notification\n\t\t\tconst notification = createNotification({\n\t\t\t\ttype: \"daemon.shutting_down\",\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tdata: {},\n\t\t\t});\n\t\t\ttry {\n\t\t\t\tsocket.write(serializeResponse(notification));\n\t\t\t} catch {\n\t\t\t\t// Ignore write errors during shutdown\n\t\t\t}\n\t\t\tsocket.destroy();\n\t\t}\n\t\tthis.connections.clear();\n\n\t\t// Close all file watchers\n\t\tawait disposeFileWatcherService();\n\n\t\t// Cleanup files (Unix only for socket - Windows named pipes auto-cleanup)\n\t\ttry {\n\t\t\tif (existsSync(this.config.pidPath)) {\n\t\t\t\tunlinkSync(this.config.pidPath);\n\t\t\t}\n\t\t\tif (!IS_WINDOWS && existsSync(this.config.socketPath)) {\n\t\t\t\tunlinkSync(this.config.socketPath);\n\t\t\t}\n\t\t} catch {\n\t\t\t// Ignore cleanup errors\n\t\t}\n\n\t\t// Release lock\n\t\tif (this.lockAcquired) {\n\t\t\tawait releaseLock(this.config.lockPath);\n\t\t\tthis.lockAcquired = false;\n\t\t}\n\n\t\tthis._isRunning = false;\n\t\tthis._isShuttingDown = false;\n\n\t\tthis.logger.info(\"Daemon shutdown complete\");\n\t\tthis.emit(\"shutdown\");\n\t}\n\n\t/**\n\t * Check if the daemon is running\n\t */\n\tisRunning(): boolean {\n\t\treturn this._isRunning;\n\t}\n\n\t// =========================================================================\n\t// SIGNAL HANDLERS\n\t// =========================================================================\n\n\t/**\n\t * Register signal handlers for graceful shutdown\n\t *\n\t * Note: Signal handling differs between platforms:\n\t * - Unix: SIGTERM, SIGINT, SIGHUP all supported\n\t * - Windows: Only SIGINT (Ctrl+C) reliably works; SIGTERM is emulated\n\t */\n\tprivate registerSignalHandlers(): void {\n\t\tif (this.signalHandlersRegistered) {\n\t\t\treturn;\n\t\t}\n\t\tthis.signalHandlersRegistered = true;\n\n\t\tconst shutdown = () => {\n\t\t\tthis.logger.info(\"Received shutdown signal\");\n\t\t\tthis.shutdown().catch((err) => {\n\t\t\t\tthis.logger.error(\"Shutdown error\", { error: String(err) });\n\t\t\t\tprocess.exit(1);\n\t\t\t});\n\t\t};\n\n\t\t// Graceful shutdown on SIGTERM (container/process manager)\n\t\t// On Windows, SIGTERM is sent by process.kill() but not by external signals\n\t\tprocess.on(\"SIGTERM\", shutdown);\n\n\t\t// Graceful shutdown on SIGINT (Ctrl+C) - works on all platforms\n\t\tprocess.on(\"SIGINT\", shutdown);\n\n\t\t// Reload configuration on SIGHUP (Unix only)\n\t\t// SIGHUP doesn't exist on Windows\n\t\tif (!IS_WINDOWS) {\n\t\t\tprocess.on(\"SIGHUP\", () => {\n\t\t\t\tthis.logger.info(\"Received reload signal\");\n\t\t\t\tthis.emit(\"reload\");\n\t\t\t});\n\t\t}\n\n\t\t// Handle Windows-specific shutdown events\n\t\tif (IS_WINDOWS) {\n\t\t\t// SIGBREAK is the Windows equivalent of SIGHUP, triggered by Ctrl+Break\n\t\t\t// This is the most reliable signal for graceful shutdown on Windows\n\t\t\tprocess.on(\"SIGBREAK\", shutdown);\n\n\t\t\t// Windows sends 'exit' event on console close\n\t\t\t// Only synchronous operations are allowed in exit handlers\n\t\t\tprocess.on(\"exit\", () => {\n\t\t\t\t// Synchronous cleanup only - async operations won't complete\n\t\t\t\tif (this._isRunning && !this._isShuttingDown) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (existsSync(this.config.pidPath)) {\n\t\t\t\t\t\t\tunlinkSync(this.config.pidPath);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Ignore cleanup errors during forced exit\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Handle uncaught exceptions\n\t\tprocess.on(\"uncaughtException\", (err) => {\n\t\t\tthis.logger.error(\"Uncaught exception\", { error: String(err), stack: err.stack });\n\t\t\tthis.shutdown()\n\t\t\t\t.catch(() => {})\n\t\t\t\t.finally(() => process.exit(1));\n\t\t});\n\n\t\t// Handle unhandled rejections\n\t\tprocess.on(\"unhandledRejection\", (reason) => {\n\t\t\tthis.logger.error(\"Unhandled rejection\", { reason: String(reason) });\n\t\t});\n\t}\n\n\t// =========================================================================\n\t// STATE PERSISTENCE\n\t// =========================================================================\n\n\t/**\n\t * Persist state for crash recovery\n\t */\n\tprivate async persistState(): Promise<void> {\n\t\tconst state: PersistedState = {\n\t\t\tworkspaces: Array.from(this.workspaces.entries()).map(([key, ctx]) => ({\n\t\t\t\tkey,\n\t\t\t\tid: ctx.id,\n\t\t\t\troot: ctx.root,\n\t\t\t\tsessionActive: ctx.sessionActive,\n\t\t\t\tcurrentTaskId: ctx.currentTaskId,\n\t\t\t\tsnapshotCount: ctx.snapshotCount,\n\t\t\t\tlastActivity: ctx.lastActivity,\n\t\t\t})),\n\t\t\tlastPersisted: Date.now(),\n\t\t\tversion: this.config.version,\n\t\t};\n\n\t\tconst statePath = join(getDaemonDir(), STATE_FILE);\n\n\t\ttry {\n\t\t\tawait mkdir(dirname(statePath), { recursive: true });\n\t\t\tawait writeFile(statePath, JSON.stringify(state, null, 2), \"utf-8\");\n\t\t\tthis.logger.debug(\"State persisted\", { workspaces: state.workspaces.length });\n\t\t} catch (err) {\n\t\t\tthis.logger.warn(\"Failed to persist state\", { error: String(err) });\n\t\t}\n\t}\n\n\t/**\n\t * Restore state from crash recovery file\n\t */\n\tprivate async restoreState(): Promise<void> {\n\t\tconst statePath = join(getDaemonDir(), STATE_FILE);\n\n\t\ttry {\n\t\t\tconst content = await readFile(statePath, \"utf-8\");\n\t\t\tconst state: PersistedState = JSON.parse(content);\n\n\t\t\tfor (const ws of state.workspaces) {\n\t\t\t\tthis.workspaces.set(ws.key, {\n\t\t\t\t\tid: ws.id,\n\t\t\t\t\troot: ws.root,\n\t\t\t\t\tinitialized: true,\n\t\t\t\t\tsessionActive: ws.sessionActive,\n\t\t\t\t\tcurrentTaskId: ws.currentTaskId,\n\t\t\t\t\tsnapshotCount: ws.snapshotCount,\n\t\t\t\t\tlastActivity: ws.lastActivity,\n\t\t\t\t\tsubscribers: new Set(),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.logger.info(\"State restored\", { workspaces: state.workspaces.length });\n\t\t} catch (err) {\n\t\t\t// No state to restore, that's fine\n\t\t\tif ((err as NodeJS.ErrnoException).code !== \"ENOENT\") {\n\t\t\t\tthis.logger.debug(\"No state to restore\", { error: String(err) });\n\t\t\t}\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// HEALTH CHECK\n\t// =========================================================================\n\n\t/**\n\t * Start HTTP health check endpoint\n\t */\n\tprivate async startHealthEndpoint(port: number): Promise<void> {\n\t\tconst healthServer = createHttpServer((req, res) => {\n\t\t\tif (req.url === \"/health\" || req.url === \"/healthz\") {\n\t\t\t\tconst health = {\n\t\t\t\t\tstatus: this._isRunning ? \"healthy\" : \"unhealthy\",\n\t\t\t\t\tpid: process.pid,\n\t\t\t\t\tversion: this.config.version,\n\t\t\t\t\tuptime: Date.now() - this.startTime,\n\t\t\t\t\tconnections: this.connections.size,\n\t\t\t\t\tworkspaces: this.workspaces.size,\n\t\t\t\t\tmemoryUsage: process.memoryUsage(),\n\t\t\t\t};\n\t\t\t\tres.writeHead(200, { \"Content-Type\": \"application/json\" });\n\t\t\t\tres.end(JSON.stringify(health));\n\t\t\t} else if (req.url === \"/ready\") {\n\t\t\t\tres.writeHead(this._isRunning ? 200 : 503);\n\t\t\t\tres.end(this._isRunning ? \"ready\" : \"not ready\");\n\t\t\t} else {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end(\"Not found\");\n\t\t\t}\n\t\t});\n\t\tthis.healthServer = healthServer;\n\n\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\thealthServer.listen(port, \"127.0.0.1\", () => {\n\t\t\t\tthis.logger.info(\"Health endpoint started\", { port });\n\t\t\t\tresolve();\n\t\t\t});\n\t\t\thealthServer.on(\"error\", reject);\n\t\t});\n\t}\n\n\t// =========================================================================\n\t// CONNECTION HANDLING\n\t// =========================================================================\n\n\t/**\n\t * Handle new connection\n\t */\n\tprivate handleConnection(socket: Socket): void {\n\t\tconst requestId = generateRequestId();\n\n\t\t// Check max connections\n\t\tif (this.connections.size >= (this.config.maxConnections || MAX_CONNECTIONS)) {\n\t\t\tconst error = createErrorResponse(\n\t\t\t\t\"0\",\n\t\t\t\tErrorCodes.PERMISSION_DENIED,\n\t\t\t\t`Max connections (${this.config.maxConnections}) reached`,\n\t\t\t);\n\t\t\tsocket.write(serializeResponse(error));\n\t\t\tsocket.destroy();\n\t\t\tthis.logger.warn(\"Connection rejected: max connections reached\", { requestId });\n\t\t\treturn;\n\t\t}\n\n\t\t// Create connection context\n\t\tconst ctx: ConnectionContext = {\n\t\t\tsocket,\n\t\t\tbuffer: \"\",\n\t\t\tpaused: false,\n\t\t};\n\n\t\tthis.connections.set(socket, ctx);\n\t\tthis.updateActivity();\n\t\tthis.logger.debug(\"Connection established\", { requestId, connections: this.connections.size });\n\t\tthis.emit(\"connection\", socket);\n\n\t\tsocket.on(\"data\", async (data) => {\n\t\t\tconst connCtx = this.connections.get(socket);\n\t\t\tif (!connCtx) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Handle backpressure: pause while processing\n\t\t\tif (!connCtx.paused) {\n\t\t\t\tsocket.pause();\n\t\t\t\tconnCtx.paused = true;\n\t\t\t}\n\n\t\t\tconnCtx.buffer += data.toString();\n\n\t\t\t// Check buffer size limit\n\t\t\tif (connCtx.buffer.length > MAX_BUFFER_SIZE) {\n\t\t\t\tconst error = new RequestTooLargeError(connCtx.buffer.length, MAX_BUFFER_SIZE);\n\t\t\t\tconst response = createErrorResponse(\"0\", error.code, error.message);\n\t\t\t\tsocket.write(serializeResponse(response));\n\t\t\t\tsocket.destroy();\n\t\t\t\tthis.connections.delete(socket);\n\t\t\t\tthis.logger.warn(\"Connection closed: buffer overflow\", { requestId, size: connCtx.buffer.length });\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Parse newline-delimited JSON-RPC\n\t\t\tconst lines = connCtx.buffer.split(\"\\n\");\n\t\t\tconnCtx.buffer = lines.pop() || \"\";\n\n\t\t\tfor (const line of lines) {\n\t\t\t\tif (!line.trim()) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst lineRequestId = generateRequestId();\n\n\t\t\t\ttry {\n\t\t\t\t\tconst request = parseRequest(line);\n\t\t\t\t\tconst response = await this.handleRequest(request, lineRequestId);\n\n\t\t\t\t\t// Handle backpressure on write\n\t\t\t\t\tconst canContinue = socket.write(serializeResponse(response));\n\t\t\t\t\tif (!canContinue) {\n\t\t\t\t\t\tawait new Promise<void>((resolve) => socket.once(\"drain\", resolve));\n\t\t\t\t\t}\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconst daemonError = err instanceof DaemonError ? err : new ParseError(String(err));\n\t\t\t\t\tconst parseError = createErrorResponse(\"null\", daemonError.code, daemonError.message);\n\t\t\t\t\tsocket.write(serializeResponse(parseError));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Resume reading\n\t\t\tif (connCtx.paused) {\n\t\t\t\tsocket.resume();\n\t\t\t\tconnCtx.paused = false;\n\t\t\t}\n\t\t});\n\n\t\tsocket.on(\"close\", () => {\n\t\t\tthis.connections.delete(socket);\n\t\t\tthis.logger.debug(\"Connection closed\", { requestId, connections: this.connections.size });\n\t\t\tthis.emit(\"disconnection\", socket);\n\t\t});\n\n\t\tsocket.on(\"error\", (err) => {\n\t\t\tthis.logger.error(\"Socket error\", { requestId, error: String(err) });\n\t\t\tthis.emit(\"error\", err);\n\t\t\tsocket.destroy();\n\t\t\tthis.connections.delete(socket);\n\t\t});\n\t}\n\n\t/**\n\t * Handle a JSON-RPC request with timeout\n\t */\n\tprivate async handleRequest(request: DaemonRequest, requestId: string): Promise<DaemonResponse> {\n\t\tthis.updateActivity();\n\t\tconst startTime = Date.now();\n\n\t\tthis.logger.debug(\"Request received\", { requestId, method: request.method });\n\n\t\ttry {\n\t\t\t// Create timeout wrapper\n\t\t\tconst result = await this.withTimeout(\n\t\t\t\tthis.dispatch(request.method, request.params, requestId),\n\t\t\t\tOPERATION_TIMEOUT_MS,\n\t\t\t\trequest.method,\n\t\t\t);\n\n\t\t\tconst durationMs = Date.now() - startTime;\n\t\t\tthis.logger.debug(\"Request completed\", { requestId, method: request.method, durationMs });\n\n\t\t\treturn createResponse(request.id, result);\n\t\t} catch (err) {\n\t\t\tconst durationMs = Date.now() - startTime;\n\t\t\tconst daemonError = toDaemonError(err);\n\n\t\t\tthis.logger.error(\"Request failed\", {\n\t\t\t\trequestId,\n\t\t\t\tmethod: request.method,\n\t\t\t\tdurationMs,\n\t\t\t\terror: daemonError.message,\n\t\t\t\tcode: daemonError.code,\n\t\t\t});\n\n\t\t\treturn createErrorResponse(request.id, daemonError.code, daemonError.message, daemonError.context);\n\t\t}\n\t}\n\n\t/**\n\t * Wrap a promise with a timeout\n\t */\n\tprivate async withTimeout<T>(promise: Promise<T>, timeoutMs: number, operation: string): Promise<T> {\n\t\tlet timeoutId: NodeJS.Timeout | undefined;\n\n\t\tconst timeoutPromise = new Promise<never>((_, reject) => {\n\t\t\ttimeoutId = setTimeout(() => {\n\t\t\t\treject(new TimeoutError(operation, timeoutMs));\n\t\t\t}, timeoutMs);\n\t\t});\n\n\t\ttry {\n\t\t\treturn await Promise.race([promise, timeoutPromise]);\n\t\t} finally {\n\t\t\tif (timeoutId !== undefined) {\n\t\t\t\tclearTimeout(timeoutId);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Dispatch method to handler\n\t */\n\tprivate async dispatch(method: DaemonMethod, params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tswitch (method) {\n\t\t\tcase \"daemon.ping\":\n\t\t\t\treturn this.handlePing();\n\n\t\t\tcase \"daemon.status\":\n\t\t\t\treturn this.handleStatus();\n\n\t\t\tcase \"daemon.shutdown\":\n\t\t\t\t// Defer shutdown to allow response to be sent\n\t\t\t\tsetImmediate(() => this.shutdown());\n\t\t\t\treturn { shutting_down: true };\n\n\t\t\tcase \"daemon.reload\":\n\t\t\t\treturn this.handleReload();\n\n\t\t\tcase \"session.begin\":\n\t\t\t\treturn this.handleSessionBegin(params, requestId);\n\n\t\t\tcase \"session.end\":\n\t\t\t\treturn this.handleSessionEnd(params, requestId);\n\n\t\t\tcase \"session.status\":\n\t\t\t\treturn this.handleSessionStatus(params, requestId);\n\n\t\t\tcase \"session.changes\":\n\t\t\t\treturn this.handleSessionChanges(params, requestId);\n\n\t\t\tcase \"snapshot.create\":\n\t\t\t\treturn this.handleSnapshotCreate(params, requestId);\n\n\t\t\tcase \"snapshot.list\":\n\t\t\t\treturn this.handleSnapshotList(params, requestId);\n\n\t\t\tcase \"snapshot.restore\":\n\t\t\t\treturn this.handleSnapshotRestore(params, requestId);\n\n\t\t\tcase \"learning.add\":\n\t\t\t\treturn this.handleLearningAdd(params, requestId);\n\n\t\t\tcase \"learning.search\":\n\t\t\t\treturn this.handleLearningSearch(params, requestId);\n\n\t\t\tcase \"context.get\":\n\t\t\t\treturn this.handleContextGet(params, requestId);\n\n\t\t\tcase \"validate.quick\":\n\t\t\t\treturn this.handleValidateQuick(params, requestId);\n\n\t\t\tcase \"watch.subscribe\":\n\t\t\t\treturn this.handleWatchSubscribe(params, requestId);\n\n\t\t\tcase \"watch.unsubscribe\":\n\t\t\t\treturn this.handleWatchUnsubscribe(params, requestId);\n\n\t\t\t// MCP coordination methods\n\t\t\tcase \"snapshot.created\":\n\t\t\t\treturn this.handleSnapshotCreatedNotification(params, requestId);\n\n\t\t\tcase \"file.modified\":\n\t\t\t\treturn this.handleFileModifiedNotification(params, requestId);\n\n\t\t\tdefault:\n\t\t\t\tthrow new MethodNotFoundError(method);\n\t\t}\n\t}\n\n\t// =========================================================================\n\t// METHOD HANDLERS\n\t// =========================================================================\n\n\tprivate handlePing(): { pong: true; uptime: number; version: string } {\n\t\treturn {\n\t\t\tpong: true,\n\t\t\tuptime: Date.now() - this.startTime,\n\t\t\tversion: this.config.version,\n\t\t};\n\t}\n\n\tprivate handleStatus(): {\n\t\tpid: number;\n\t\tversion: string;\n\t\tuptime: number;\n\t\tstartedAt: string;\n\t\tworkspaces: number;\n\t\tconnections: number;\n\t\tmemoryUsage: { heapUsed: number; heapTotal: number; rss: number };\n\t\tidleTimeout: number;\n\t\tlastActivity: number;\n\t} {\n\t\tconst mem = process.memoryUsage();\n\t\treturn {\n\t\t\tpid: process.pid,\n\t\t\tversion: this.config.version,\n\t\t\tuptime: Date.now() - this.startTime,\n\t\t\tstartedAt: new Date(this.startTime).toISOString(),\n\t\t\tworkspaces: this.workspaces.size,\n\t\t\tconnections: this.connections.size,\n\t\t\tmemoryUsage: {\n\t\t\t\theapUsed: mem.heapUsed,\n\t\t\t\theapTotal: mem.heapTotal,\n\t\t\t\trss: mem.rss,\n\t\t\t},\n\t\t\tidleTimeout: this.config.idleTimeoutMs,\n\t\t\tlastActivity: this.lastActivity,\n\t\t};\n\t}\n\n\tprivate handleReload(): { reloaded: true } {\n\t\tthis.emit(\"reload\");\n\t\treturn { reloaded: true };\n\t}\n\n\tprivate async handleSessionBegin(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst { workspace, task, files, keywords } = params as {\n\t\t\tworkspace: string;\n\t\t\ttask: string;\n\t\t\tfiles?: string[];\n\t\t\tkeywords?: string[];\n\t\t};\n\n\t\t// Validate required params\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required and must be a string\");\n\t\t}\n\t\tif (!task || typeof task !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"task is required and must be a string\");\n\t\t}\n\n\t\t// Validate file paths if provided\n\t\tif (files && Array.isArray(files)) {\n\t\t\tvalidatePaths(workspace, files);\n\t\t}\n\n\t\t// Create or get workspace context\n\t\tlet ctx = this.workspaces.get(workspace);\n\t\tif (!ctx) {\n\t\t\tctx = {\n\t\t\t\tid: this.hashWorkspace(workspace),\n\t\t\t\troot: workspace,\n\t\t\t\tinitialized: true,\n\t\t\t\tsessionActive: false,\n\t\t\t\tsnapshotCount: 0,\n\t\t\t\tlastActivity: Date.now(),\n\t\t\t\tsubscribers: new Set(),\n\t\t\t};\n\t\t\tthis.workspaces.set(workspace, ctx);\n\t\t}\n\n\t\t// Start session\n\t\tconst taskId = `task_${Date.now().toString(36)}_${requestId}`;\n\t\tctx.sessionActive = true;\n\t\tctx.currentTaskId = taskId;\n\t\tctx.sessionStartedAt = Date.now();\n\t\tctx.lastActivity = Date.now();\n\n\t\t// Get Intelligence instance for cross-surface coordination\n\t\tconst intel = getIntelligence(workspace);\n\n\t\t// Start Intelligence session with same task ID (enables Extension, MCP, CLI to share state)\n\t\tintel.startSession(taskId, {\n\t\t\tworkspaceId: workspace,\n\t\t\ttags: keywords || [],\n\t\t});\n\n\t\t// Extract keywords from task if not provided\n\t\tconst effectiveKeywords =\n\t\t\tkeywords && keywords.length > 0\n\t\t\t\t? keywords\n\t\t\t\t: task\n\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t.split(/\\s+/)\n\t\t\t\t\t\t.filter((w) => w.length > 3);\n\n\t\t// Get context from Intelligence (patterns, constraints, learnings)\n\t\tlet patterns: Array<{ name: string; description: string }> = [];\n\t\tconst constraints: Array<{ domain: string; name: string; value: string | number; description: string }> = [];\n\t\tlet learnings: Array<{ type: string; trigger: string; action: string; relevanceScore: number }> = [];\n\n\t\ttry {\n\t\t\tconst contextResult = await intel.getContext({\n\t\t\t\ttask,\n\t\t\t\tkeywords: effectiveKeywords,\n\t\t\t});\n\n\t\t\t// Extract patterns from context\n\t\t\tif (contextResult.patterns) {\n\t\t\t\tconst patternLines = contextResult.patterns.split(\"\\n\").filter(Boolean);\n\t\t\t\tpatterns = patternLines.slice(0, 5).map((line) => ({\n\t\t\t\t\tname: line.substring(0, 50),\n\t\t\t\t\tdescription: line,\n\t\t\t\t}));\n\t\t\t}\n\n\t\t\t// Get learnings relevant to keywords\n\t\t\tconst learningsResult = intel.queryLearnings(effectiveKeywords);\n\t\t\tlearnings = learningsResult.slice(0, 5).map((l, index) => ({\n\t\t\t\ttype: l.type,\n\t\t\t\ttrigger: Array.isArray(l.trigger) ? l.trigger.join(\", \") : l.trigger,\n\t\t\t\taction: l.action,\n\t\t\t\t// Score based on position (earlier = more relevant)\n\t\t\t\trelevanceScore: (learningsResult.length - index) / learningsResult.length,\n\t\t\t}));\n\t\t} catch (err) {\n\t\t\tthis.logger.warn(\"Failed to get Intelligence context\", { requestId, error: String(err) });\n\t\t}\n\n\t\t// Get constraints from context file\n\t\ttry {\n\t\t\tconst ctxPath = join(workspace, \".snapback\", \"ctx\", \"context.json\");\n\t\t\tif (existsSync(ctxPath)) {\n\t\t\t\tconst ctxContent = JSON.parse(await readFile(ctxPath, \"utf8\"));\n\t\t\t\tif (ctxContent.constraints) {\n\t\t\t\t\tfor (const [domain, domainConstraints] of Object.entries(ctxContent.constraints)) {\n\t\t\t\t\t\tfor (const [name, constraint] of Object.entries(domainConstraints as Record<string, any>)) {\n\t\t\t\t\t\t\tconstraints.push({\n\t\t\t\t\t\t\t\tdomain,\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\tvalue: constraint.max || constraint.value,\n\t\t\t\t\t\t\t\tdescription: constraint.description || \"\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\tthis.logger.debug(\"No constraints file found\", { requestId, workspace });\n\t\t}\n\n\t\t// Assess risk based on files\n\t\tconst riskAreas: string[] = [];\n\t\tconst recommendations: string[] = [];\n\n\t\tif (files && files.length > 0) {\n\t\t\tfor (const file of files) {\n\t\t\t\tconst lowerPath = file.toLowerCase();\n\t\t\t\tif ((lowerPath.includes(\"auth\") || lowerPath.includes(\"login\")) && !riskAreas.includes(\"auth\")) {\n\t\t\t\t\triskAreas.push(\"auth\");\n\t\t\t\t\trecommendations.push(\"Test with both valid and invalid credentials\");\n\t\t\t\t}\n\t\t\t\tif ((lowerPath.includes(\"payment\") || lowerPath.includes(\"stripe\")) && !riskAreas.includes(\"payment\")) {\n\t\t\t\t\triskAreas.push(\"payment\");\n\t\t\t\t\trecommendations.push(\"Use test mode/sandbox for payment testing\");\n\t\t\t\t}\n\t\t\t\tif (\n\t\t\t\t\t(lowerPath.includes(\"database\") || lowerPath.includes(\"migration\")) &&\n\t\t\t\t\t!riskAreas.includes(\"database\")\n\t\t\t\t) {\n\t\t\t\t\triskAreas.push(\"database\");\n\t\t\t\t\trecommendations.push(\"Verify migrations can be rolled back\");\n\t\t\t\t}\n\t\t\t\tif ((lowerPath.includes(\"config\") || lowerPath.includes(\".env\")) && !riskAreas.includes(\"config\")) {\n\t\t\t\t\triskAreas.push(\"config\");\n\t\t\t\t\trecommendations.push(\"Ensure secrets are not committed\");\n\t\t\t\t}\n\t\t\t\tif (\n\t\t\t\t\t(lowerPath.includes(\"security\") || lowerPath.includes(\"crypto\")) &&\n\t\t\t\t\t!riskAreas.includes(\"security\")\n\t\t\t\t) {\n\t\t\t\t\triskAreas.push(\"security\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (files.length >= 5) {\n\t\t\t\trecommendations.push(\"Consider breaking into smaller focused changes\");\n\t\t\t}\n\t\t}\n\n\t\t// Determine overall risk\n\t\tconst criticalAreas = [\"auth\", \"payment\", \"security\"];\n\t\tconst hasCritical = riskAreas.some((a) => criticalAreas.includes(a));\n\t\tconst overallRisk: \"low\" | \"medium\" | \"high\" = hasCritical\n\t\t\t? \"high\"\n\t\t\t: riskAreas.length >= 2\n\t\t\t\t? \"medium\"\n\t\t\t\t: riskAreas.length > 0\n\t\t\t\t\t? \"medium\"\n\t\t\t\t\t: \"low\";\n\n\t\tthis.logger.info(\"Session started with Intelligence\", {\n\t\t\trequestId,\n\t\t\tworkspace,\n\t\t\ttaskId,\n\t\t\tpatternsCount: patterns.length,\n\t\t\tlearningsCount: learnings.length,\n\t\t\toverallRisk,\n\t\t});\n\n\t\treturn {\n\t\t\ttaskId,\n\t\t\tsnapshot: {\n\t\t\t\tcreated: false,\n\t\t\t\treason:\n\t\t\t\t\toverallRisk === \"high\"\n\t\t\t\t\t\t? \"Consider creating a safety snapshot\"\n\t\t\t\t\t\t: \"Auto-snapshot available on request\",\n\t\t\t},\n\t\t\tpatterns,\n\t\t\tconstraints,\n\t\t\tlearnings,\n\t\t\triskAssessment: {\n\t\t\t\toverallRisk,\n\t\t\t\triskAreas,\n\t\t\t\trecommendations,\n\t\t\t},\n\t\t\tnextActions: [\n\t\t\t\t...(overallRisk === \"high\"\n\t\t\t\t\t? [{ tool: \"snapshot_create\", priority: 1, reason: \"Create safety snapshot for high-risk changes\" }]\n\t\t\t\t\t: []),\n\t\t\t\t{ tool: \"quick_check\", priority: 2, reason: \"Validate changes\" },\n\t\t\t\t{ tool: \"review_work\", priority: 4, reason: \"Review before commit\" },\n\t\t\t],\n\t\t};\n\t}\n\n\tprivate async handleSessionEnd(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst { workspace, outcome } = params as {\n\t\t\tworkspace: string;\n\t\t\toutcome?: string;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (!ctx) {\n\t\t\tthrow new WorkspaceNotFoundError(workspace);\n\t\t}\n\n\t\tconst sessionStartedAt = ctx.sessionStartedAt || ctx.lastActivity;\n\t\tconst duration = Date.now() - sessionStartedAt;\n\t\tconst taskId = ctx.currentTaskId;\n\n\t\t// Get Intelligence instance for session data\n\t\tconst intel = getIntelligence(workspace);\n\n\t\t// Get file modifications from this session\n\t\tlet filesModified = 0;\n\t\tlet linesChanged = 0;\n\n\t\tif (taskId) {\n\t\t\ttry {\n\t\t\t\tconst modifications = intel.getFileModifications(taskId, sessionStartedAt);\n\t\t\t\tfilesModified = modifications.length;\n\t\t\t\tlinesChanged = modifications.reduce((sum, m) => sum + m.linesChanged, 0);\n\t\t\t} catch (err) {\n\t\t\t\tthis.logger.warn(\"Failed to get session modifications\", { requestId, error: String(err) });\n\t\t\t}\n\n\t\t\t// End Intelligence session\n\t\t\ttry {\n\t\t\t\tintel.endSession(taskId);\n\t\t\t} catch (err) {\n\t\t\t\tthis.logger.warn(\"Failed to end Intelligence session\", { requestId, error: String(err) });\n\t\t\t}\n\t\t}\n\n\t\t// Clear session state\n\t\tctx.sessionActive = false;\n\t\tctx.currentTaskId = undefined;\n\t\tctx.sessionStartedAt = undefined;\n\n\t\tthis.logger.info(\"Session ended with Intelligence\", {\n\t\t\trequestId,\n\t\t\tworkspace,\n\t\t\toutcome,\n\t\t\tduration,\n\t\t\tfilesModified,\n\t\t\tlinesChanged,\n\t\t});\n\n\t\treturn {\n\t\t\tsummary: {\n\t\t\t\tfilesModified,\n\t\t\t\tlinesChanged,\n\t\t\t\tduration,\n\t\t\t},\n\t\t\tsnapshot: { created: false },\n\t\t\tlearningsAccepted: 0,\n\t\t};\n\t}\n\n\tprivate async handleSessionStatus(params: Record<string, unknown>, _requestId: string): Promise<unknown> {\n\t\tconst { workspace } = params as { workspace: string };\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (!ctx) {\n\t\t\treturn {\n\t\t\t\tactive: false,\n\t\t\t\tfilesModified: 0,\n\t\t\t\tsnapshotCount: 0,\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tactive: ctx.sessionActive,\n\t\t\ttaskId: ctx.currentTaskId,\n\t\t\ttask: undefined,\n\t\t\tstartedAt: undefined,\n\t\t\tfilesModified: 0,\n\t\t\tsnapshotCount: ctx.snapshotCount,\n\t\t};\n\t}\n\n\tprivate async handleSessionChanges(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst {\n\t\t\tworkspace,\n\t\t\tincludeDiff: _includeDiff,\n\t\t\tfilterFiles,\n\t\t\tincludeAIAttribution = true,\n\t\t} = params as {\n\t\t\tworkspace: string;\n\t\t\tincludeDiff?: boolean;\n\t\t\tfilterFiles?: string[];\n\t\t\tincludeAIAttribution?: boolean;\n\t\t};\n\t\t// Note: _includeDiff is reserved for future diff functionality\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\t// Validate filter file paths if provided\n\t\tif (filterFiles && Array.isArray(filterFiles)) {\n\t\t\tvalidatePaths(workspace, filterFiles);\n\t\t}\n\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (!ctx || !ctx.sessionActive || !ctx.currentTaskId) {\n\t\t\t// No active session, return empty\n\t\t\treturn {\n\t\t\t\tfiles: [],\n\t\t\t\ttotalLinesChanged: 0,\n\t\t\t\triskAssessment: {\n\t\t\t\t\toverallRisk: \"low\" as const,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\t// Query Intelligence for file modifications (shared across Extension, MCP, CLI, Daemon)\n\t\ttry {\n\t\t\tconst intel = getIntelligence(workspace);\n\t\t\tconst modifications = intel.getFileModifications(ctx.currentTaskId, ctx.lastActivity);\n\n\t\t\t// Map modifications to daemon format\n\t\t\tlet files = modifications.map((mod) => {\n\t\t\t\tconst relativePath = mod.path.startsWith(workspace) ? relative(workspace, mod.path) : mod.path;\n\t\t\t\treturn {\n\t\t\t\t\tpath: relativePath,\n\t\t\t\t\tstatus: (mod.type === \"create\" ? \"created\" : mod.type === \"delete\" ? \"deleted\" : \"modified\") as\n\t\t\t\t\t\t| \"created\"\n\t\t\t\t\t\t| \"modified\"\n\t\t\t\t\t\t| \"deleted\",\n\t\t\t\t\tlinesChanged: mod.linesChanged,\n\t\t\t\t\taiAttributed: includeAIAttribution ? mod.aiAttributed : undefined,\n\t\t\t\t};\n\t\t\t});\n\n\t\t\t// Apply filter if provided\n\t\t\tif (filterFiles && filterFiles.length > 0) {\n\t\t\t\tfiles = files.filter((f) =>\n\t\t\t\t\tfilterFiles.some((filter) => f.path.includes(filter) || filter.includes(f.path)),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Calculate totals and risk\n\t\t\tconst totalLinesChanged = files.reduce((sum, f) => sum + f.linesChanged, 0);\n\t\t\tconst aiAttributedFiles = files.filter((f) => f.aiAttributed).length;\n\n\t\t\t// Assess risk based on changes\n\t\t\tlet overallRisk: \"low\" | \"medium\" | \"high\" = \"low\";\n\t\t\tconst criticalPatterns = [\"auth\", \"payment\", \"security\", \"config\", \"migration\", \"env\"];\n\t\t\tconst hasCriticalFiles = files.some((f) =>\n\t\t\t\tcriticalPatterns.some((pattern) => f.path.toLowerCase().includes(pattern)),\n\t\t\t);\n\t\t\tconst highAiRatio = files.length >= 3 && aiAttributedFiles / files.length > 0.7;\n\n\t\t\tif (hasCriticalFiles && highAiRatio) {\n\t\t\t\toverallRisk = \"high\";\n\t\t\t} else if (hasCriticalFiles || highAiRatio || totalLinesChanged > 500) {\n\t\t\t\toverallRisk = \"medium\";\n\t\t\t}\n\n\t\t\tthis.logger.debug(\"Session changes retrieved\", {\n\t\t\t\trequestId,\n\t\t\t\tworkspace,\n\t\t\t\tfileCount: files.length,\n\t\t\t\ttotalLinesChanged,\n\t\t\t\toverallRisk,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tfiles,\n\t\t\t\ttotalLinesChanged,\n\t\t\t\triskAssessment: {\n\t\t\t\t\toverallRisk,\n\t\t\t\t},\n\t\t\t};\n\t\t} catch (err) {\n\t\t\tthis.logger.warn(\"Failed to get session changes from Intelligence\", {\n\t\t\t\trequestId,\n\t\t\t\terror: String(err),\n\t\t\t});\n\n\t\t\t// Fall back to empty response\n\t\t\treturn {\n\t\t\t\tfiles: [],\n\t\t\t\ttotalLinesChanged: 0,\n\t\t\t\triskAssessment: {\n\t\t\t\t\toverallRisk: \"low\" as const,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate async handleSnapshotCreate(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst { workspace, files, reason } = params as {\n\t\t\tworkspace: string;\n\t\t\tfiles: string[];\n\t\t\treason?: string;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!files || !Array.isArray(files) || files.length === 0) {\n\t\t\tthrow new InvalidParamsError(\"files is required and must be a non-empty array\");\n\t\t}\n\n\t\t// Validate all file paths\n\t\tvalidatePaths(workspace, files);\n\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (ctx) {\n\t\t\tctx.snapshotCount++;\n\t\t}\n\n\t\t//  ARCHITECTURE_REFACTOR_SPEC.md Phase 2: Use SDK SnapshotManager\n\t\ttry {\n\t\t\tconst snapshotManager = getSnapshotManager(workspace);\n\n\t\t\t// Read file contents for snapshot\n\t\t\tconst fileInputs = await Promise.all(\n\t\t\t\tfiles.map(async (filePath) => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst fullPath = join(workspace, filePath);\n\t\t\t\t\t\tconst content = await readFile(fullPath, \"utf-8\");\n\t\t\t\t\t\treturn { path: filePath, content, action: \"modify\" as const };\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// File doesn't exist or can't be read - use empty content\n\t\t\t\t\t\treturn { path: filePath, content: \"\", action: \"add\" as const };\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\t// Create snapshot using SDK SnapshotManager\n\t\t\tconst snapshot = await snapshotManager.create(fileInputs, {\n\t\t\t\tdescription: reason,\n\t\t\t});\n\n\t\t\t// Calculate total size\n\t\t\tconst totalSize = fileInputs.reduce((sum, f) => sum + f.content.length, 0);\n\n\t\t\t// Broadcast snapshot created event\n\t\t\tthis.broadcastToWorkspace(workspace, {\n\t\t\t\ttype: \"snapshot.created\",\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tworkspace,\n\t\t\t\tdata: { snapshotId: snapshot.id, fileCount: files.length, reason },\n\t\t\t});\n\n\t\t\tthis.logger.info(\"Snapshot created via SDK\", {\n\t\t\t\trequestId,\n\t\t\t\tworkspace,\n\t\t\t\tsnapshotId: snapshot.id,\n\t\t\t\tfileCount: files.length,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsnapshotId: snapshot.id,\n\t\t\t\tfileCount: files.length,\n\t\t\t\ttotalSize,\n\t\t\t\tcreatedAt: new Date(snapshot.timestamp).toISOString(),\n\t\t\t\tdeduplicated: false,\n\t\t\t};\n\t\t} catch (err) {\n\t\t\t// Fallback to simple ID generation if SDK fails\n\t\t\tthis.logger.warn(\"SDK snapshot creation failed, using fallback\", {\n\t\t\t\trequestId,\n\t\t\t\terror: err instanceof Error ? err.message : String(err),\n\t\t\t});\n\n\t\t\tconst snapshotId = `snap_${Date.now().toString(36)}_${requestId}`;\n\n\t\t\t// Broadcast snapshot created event\n\t\t\tthis.broadcastToWorkspace(workspace, {\n\t\t\t\ttype: \"snapshot.created\",\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tworkspace,\n\t\t\t\tdata: { snapshotId, fileCount: files.length, reason },\n\t\t\t});\n\n\t\t\tthis.logger.info(\"Snapshot created (fallback)\", {\n\t\t\t\trequestId,\n\t\t\t\tworkspace,\n\t\t\t\tsnapshotId,\n\t\t\t\tfileCount: files.length,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsnapshotId,\n\t\t\t\tfileCount: files.length,\n\t\t\t\ttotalSize: 0,\n\t\t\t\tcreatedAt: new Date().toISOString(),\n\t\t\t\tdeduplicated: false,\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate async handleSnapshotList(params: Record<string, unknown>, _requestId: string): Promise<unknown> {\n\t\tconst { workspace, limit } = params as {\n\t\t\tworkspace: string;\n\t\t\tlimit?: number;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\t//  ARCHITECTURE_REFACTOR_SPEC.md Phase 2: Use SDK SnapshotManager\n\t\ttry {\n\t\t\tconst snapshotManager = getSnapshotManager(workspace);\n\t\t\tconst allSnapshots = await snapshotManager.list();\n\n\t\t\t// Apply limit if provided\n\t\t\tconst snapshots = limit ? allSnapshots.slice(0, limit) : allSnapshots;\n\n\t\t\treturn {\n\t\t\t\tsnapshots: snapshots.map((s) => ({\n\t\t\t\t\tid: s.id,\n\t\t\t\t\tcreatedAt: new Date(s.timestamp).toISOString(),\n\t\t\t\t\tfileCount: (s.files || []).length,\n\t\t\t\t\treason: s.meta?.name,\n\t\t\t\t\tprotected: s.meta?.protected || false,\n\t\t\t\t})),\n\t\t\t\ttotal: allSnapshots.length,\n\t\t\t};\n\t\t} catch (err) {\n\t\t\t// Fallback to empty list if SDK fails\n\t\t\tthis.logger.warn(\"SDK snapshot list failed\", {\n\t\t\t\terror: err instanceof Error ? err.message : String(err),\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tsnapshots: [],\n\t\t\t\ttotal: 0,\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate async handleSnapshotRestore(params: Record<string, unknown>, _requestId: string): Promise<unknown> {\n\t\tconst { workspace, snapshotId, files, dryRun } = params as {\n\t\t\tworkspace: string;\n\t\t\tsnapshotId: string;\n\t\t\tfiles?: string[];\n\t\t\tdryRun?: boolean;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!snapshotId || typeof snapshotId !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"snapshotId is required\");\n\t\t}\n\n\t\t// Validate file paths if provided\n\t\tif (files && Array.isArray(files)) {\n\t\t\tvalidatePaths(workspace, files);\n\t\t}\n\n\t\t//  ARCHITECTURE_REFACTOR_SPEC.md Phase 2: Use SDK SnapshotManager\n\t\ttry {\n\t\t\tconst snapshotManager = getSnapshotManager(workspace);\n\t\t\tconst result = await snapshotManager.restore(snapshotId, workspace, { dryRun });\n\n\t\t\treturn {\n\t\t\t\trestored: result.success && !dryRun,\n\t\t\t\tfilesRestored: result.restoredFiles.length,\n\t\t\t\tdryRun: !!dryRun,\n\t\t\t\tchanges: result.restoredFiles.map((f) => ({ file: f, action: \"restore\" })),\n\t\t\t\terrors: result.errors,\n\t\t\t};\n\t\t} catch (err) {\n\t\t\t// Fallback response if SDK fails\n\t\t\tthis.logger.warn(\"SDK snapshot restore failed\", {\n\t\t\t\terror: err instanceof Error ? err.message : String(err),\n\t\t\t});\n\t\t\treturn {\n\t\t\t\trestored: false,\n\t\t\t\tfilesRestored: 0,\n\t\t\t\tdryRun: !!dryRun,\n\t\t\t\tchanges: [],\n\t\t\t\terrors: [err instanceof Error ? err.message : String(err)],\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate async handleLearningAdd(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst { workspace, type, trigger, action, source } = params as {\n\t\t\tworkspace: string;\n\t\t\ttype: string;\n\t\t\ttrigger: string;\n\t\t\taction: string;\n\t\t\tsource?: string;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!type || typeof type !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"type is required\");\n\t\t}\n\t\tif (!trigger || typeof trigger !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"trigger is required\");\n\t\t}\n\t\tif (!action || typeof action !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"action is required\");\n\t\t}\n\n\t\tconst learningId = `learn_${Date.now().toString(36)}_${requestId}`;\n\n\t\t// Use Intelligence to persist the learning\n\t\ttry {\n\t\t\tconst intel = getIntelligence(workspace);\n\t\t\tawait intel.recordLearning({\n\t\t\t\ttype: type as \"pattern\" | \"pitfall\" | \"efficiency\" | \"discovery\" | \"workflow\",\n\t\t\t\ttrigger,\n\t\t\t\taction,\n\t\t\t\tsource: source || \"daemon\",\n\t\t\t});\n\n\t\t\tthis.logger.info(\"Learning added via Intelligence\", { requestId, workspace, learningId, type });\n\t\t} catch (err) {\n\t\t\tthis.logger.warn(\"Failed to add learning via Intelligence, falling back to local storage\", {\n\t\t\t\trequestId,\n\t\t\t\terror: String(err),\n\t\t\t});\n\n\t\t\t// Fallback: Write directly to JSONL file\n\t\t\ttry {\n\t\t\t\tconst learningsDir = join(workspace, \".snapback\", \"learnings\");\n\t\t\t\tif (!existsSync(learningsDir)) {\n\t\t\t\t\tmkdirSync(learningsDir, { recursive: true });\n\t\t\t\t}\n\t\t\t\tconst learningsPath = join(learningsDir, \"learnings.jsonl\");\n\t\t\t\tconst entry = {\n\t\t\t\t\ttype,\n\t\t\t\t\ttrigger,\n\t\t\t\t\taction,\n\t\t\t\t\tsource: source || \"daemon\",\n\t\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\t};\n\t\t\t\tawait writeFile(learningsPath, `${JSON.stringify(entry)}\\n`, { flag: \"a\" });\n\t\t\t} catch (writeErr) {\n\t\t\t\tthis.logger.error(\"Failed to write learning\", { requestId, error: String(writeErr) });\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tlearningId,\n\t\t\tmessage: \"Learning recorded\",\n\t\t};\n\t}\n\n\tprivate async handleLearningSearch(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst {\n\t\t\tworkspace,\n\t\t\tkeywords: keywordsParam,\n\t\t\tlimit,\n\t\t} = params as {\n\t\t\tworkspace: string;\n\t\t\tkeywords: string[];\n\t\t\tlimit?: number;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!keywordsParam || !Array.isArray(keywordsParam)) {\n\t\t\tthrow new InvalidParamsError(\"keywords is required and must be an array\");\n\t\t}\n\n\t\ttry {\n\t\t\tconst intel = getIntelligence(workspace);\n\t\t\tconst learningsResult = intel.queryLearnings(keywordsParam);\n\n\t\t\t// Apply limit if provided\n\t\t\tconst limitedLearnings = limit ? learningsResult.slice(0, limit) : learningsResult.slice(0, 10);\n\n\t\t\tconst learnings = limitedLearnings.map((l, index) => ({\n\t\t\t\ttype: l.type,\n\t\t\t\ttrigger: Array.isArray(l.trigger) ? l.trigger.join(\", \") : l.trigger,\n\t\t\t\taction: l.action,\n\t\t\t\tsource: l.source,\n\t\t\t\t// Score based on position (earlier = more relevant)\n\t\t\t\tscore: (limitedLearnings.length - index) / Math.max(limitedLearnings.length, 1),\n\t\t\t}));\n\n\t\t\tthis.logger.debug(\"Learning search completed\", {\n\t\t\t\trequestId,\n\t\t\t\tworkspace,\n\t\t\t\tkeywordCount: keywordsParam.length,\n\t\t\t\tresultsCount: learnings.length,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tlearnings,\n\t\t\t\tcount: learnings.length,\n\t\t\t};\n\t\t} catch (err) {\n\t\t\tthis.logger.warn(\"Failed to search learnings via Intelligence\", { requestId, error: String(err) });\n\n\t\t\t// Return empty results on error\n\t\t\treturn {\n\t\t\t\tlearnings: [],\n\t\t\t\tcount: 0,\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate async handleContextGet(params: Record<string, unknown>, requestId: string): Promise<unknown> {\n\t\tconst { workspace, task, files, keywords } = params as {\n\t\t\tworkspace: string;\n\t\t\ttask: string;\n\t\t\tfiles?: string[];\n\t\t\tkeywords?: string[];\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!task || typeof task !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"task is required\");\n\t\t}\n\n\t\t// Validate file paths if provided\n\t\tif (files && Array.isArray(files)) {\n\t\t\tvalidatePaths(workspace, files);\n\t\t}\n\n\t\t// Get Intelligence instance\n\t\tconst intel = getIntelligence(workspace);\n\n\t\t// Extract effective keywords\n\t\tconst effectiveKeywords =\n\t\t\tkeywords && keywords.length > 0\n\t\t\t\t? keywords\n\t\t\t\t: task\n\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t.split(/\\s+/)\n\t\t\t\t\t\t.filter((w) => w.length > 3);\n\n\t\t// Get context from Intelligence\n\t\tlet patterns: Array<{ name: string; description: string }> = [];\n\t\tconst constraints: Array<{ domain: string; name: string; value: string | number; description: string }> = [];\n\t\tlet learnings: Array<{ type: string; trigger: string; action: string; relevanceScore: number }> = [];\n\n\t\ttry {\n\t\t\tconst contextResult = await intel.getContext({\n\t\t\t\ttask,\n\t\t\t\tkeywords: effectiveKeywords,\n\t\t\t});\n\n\t\t\t// Extract patterns\n\t\t\tif (contextResult.patterns) {\n\t\t\t\tconst patternLines = contextResult.patterns.split(\"\\n\").filter(Boolean);\n\t\t\t\tpatterns = patternLines.slice(0, 5).map((line) => ({\n\t\t\t\t\tname: line.substring(0, 50),\n\t\t\t\t\tdescription: line,\n\t\t\t\t}));\n\t\t\t}\n\n\t\t\t// Get learnings\n\t\t\tconst learningsResult = intel.queryLearnings(effectiveKeywords);\n\t\t\tlearnings = learningsResult.slice(0, 5).map((l, index) => ({\n\t\t\t\ttype: l.type,\n\t\t\t\ttrigger: Array.isArray(l.trigger) ? l.trigger.join(\", \") : l.trigger,\n\t\t\t\taction: l.action,\n\t\t\t\t// Score based on position (earlier = more relevant)\n\t\t\t\trelevanceScore: (learningsResult.length - index) / Math.max(learningsResult.length, 1),\n\t\t\t}));\n\t\t} catch (err) {\n\t\t\tthis.logger.warn(\"Failed to get Intelligence context\", { requestId, error: String(err) });\n\t\t}\n\n\t\t// Get constraints from context file\n\t\ttry {\n\t\t\tconst ctxPath = join(workspace, \".snapback\", \"ctx\", \"context.json\");\n\t\t\tif (existsSync(ctxPath)) {\n\t\t\t\tconst ctxContent = JSON.parse(await readFile(ctxPath, \"utf8\"));\n\t\t\t\tif (ctxContent.constraints) {\n\t\t\t\t\tfor (const [domain, domainConstraints] of Object.entries(ctxContent.constraints)) {\n\t\t\t\t\t\tfor (const [name, constraint] of Object.entries(domainConstraints as Record<string, any>)) {\n\t\t\t\t\t\t\tconstraints.push({\n\t\t\t\t\t\t\t\tdomain,\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\tvalue: constraint.max || constraint.value,\n\t\t\t\t\t\t\t\tdescription: constraint.description || \"\",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch {\n\t\t\t// No constraints file\n\t\t}\n\n\t\t// Build risk assessment\n\t\tconst riskAreas: string[] = [];\n\t\tconst recommendations: string[] = [];\n\n\t\tif (files && files.length > 0) {\n\t\t\tfor (const file of files) {\n\t\t\t\tconst lowerPath = file.toLowerCase();\n\t\t\t\tif (lowerPath.includes(\"auth\") && !riskAreas.includes(\"auth\")) {\n\t\t\t\t\triskAreas.push(\"auth\");\n\t\t\t\t}\n\t\t\t\tif (lowerPath.includes(\"payment\") && !riskAreas.includes(\"payment\")) {\n\t\t\t\t\triskAreas.push(\"payment\");\n\t\t\t\t}\n\t\t\t\tif (lowerPath.includes(\"security\") && !riskAreas.includes(\"security\")) {\n\t\t\t\t\triskAreas.push(\"security\");\n\t\t\t\t}\n\t\t\t\tif (lowerPath.includes(\"config\") && !riskAreas.includes(\"config\")) {\n\t\t\t\t\triskAreas.push(\"config\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst criticalAreas = [\"auth\", \"payment\", \"security\"];\n\t\tconst hasCritical = riskAreas.some((a) => criticalAreas.includes(a));\n\t\tconst overallRisk = hasCritical ? \"high\" : riskAreas.length > 0 ? \"medium\" : \"low\";\n\n\t\treturn {\n\t\t\tpatterns,\n\t\t\tconstraints,\n\t\t\tlearnings,\n\t\t\tobservations: [],\n\t\t\triskAssessment: {\n\t\t\t\toverallRisk,\n\t\t\t\triskAreas,\n\t\t\t\trecommendations,\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate async handleValidateQuick(params: Record<string, unknown>, _requestId: string): Promise<unknown> {\n\t\tconst { workspace, file, files } = params as {\n\t\t\tworkspace: string;\n\t\t\tfile?: string;\n\t\t\tfiles?: string[];\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\t// Validate file paths\n\t\tif (file) {\n\t\t\tvalidatePath(workspace, file);\n\t\t}\n\t\tif (files && Array.isArray(files)) {\n\t\t\tvalidatePaths(workspace, files);\n\t\t}\n\n\t\treturn {\n\t\t\tpassed: true,\n\t\t\ttypescript: { passed: true, errors: 0 },\n\t\t\ttests: { discovered: 0 },\n\t\t\tlint: { passed: true, errors: 0, warnings: 0 },\n\t\t};\n\t}\n\n\t// =========================================================================\n\t// MCP COORDINATION METHODS\n\t// =========================================================================\n\n\t/**\n\t * Handle snapshot.created notification from MCP\n\t *\n\t * This is CRITICAL for cross-surface coordination:\n\t * When MCP tools create snapshots, the Extension's vitals system needs to know\n\t * so it can reset pressure and update the UI. Without this handler, MCP-created\n\t * snapshots don't reset the vitals pressure gauge.\n\t *\n\t * Flow: MCP  Daemon (this handler)  Broadcast to Extension subscribers\n\t */\n\tprivate async handleSnapshotCreatedNotification(\n\t\tparams: Record<string, unknown>,\n\t\trequestId: string,\n\t): Promise<{ acknowledged: boolean }> {\n\t\tconst { workspace, id, filePath, trigger, source } = params as {\n\t\t\tworkspace: string;\n\t\t\tid: string;\n\t\t\tfilePath?: string;\n\t\t\ttrigger?: string;\n\t\t\tsource?: string;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!id || typeof id !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"id (snapshot ID) is required\");\n\t\t}\n\n\t\tthis.logger.info(\"Snapshot created notification from MCP\", {\n\t\t\trequestId,\n\t\t\tworkspace,\n\t\t\tsnapshotId: id,\n\t\t\tfilePath,\n\t\t\ttrigger,\n\t\t\tsource,\n\t\t});\n\n\t\t// Update workspace snapshot count\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (ctx) {\n\t\t\tctx.snapshotCount++;\n\t\t\tctx.lastActivity = Date.now();\n\t\t}\n\n\t\t// Broadcast snapshot.created event to all subscribers of this workspace\n\t\t// This is what triggers the Extension's AutoDecisionIntegration to call vitals.onSnapshot()\n\t\tthis.broadcastToWorkspace(workspace, {\n\t\t\ttype: \"snapshot.created\",\n\t\t\ttimestamp: Date.now(),\n\t\t\tworkspace,\n\t\t\tdata: {\n\t\t\t\tsnapshotId: id,\n\t\t\t\tfilePath: filePath || \"unknown\",\n\t\t\t\ttrigger: trigger || \"mcp\",\n\t\t\t\tsource: source || \"mcp\",\n\t\t\t},\n\t\t});\n\n\t\treturn { acknowledged: true };\n\t}\n\n\t/**\n\t * Handle file.modified notification from MCP\n\t *\n\t * Records file modifications for AI attribution tracking.\n\t * Enables cross-surface coordination of file change detection.\n\t */\n\tprivate async handleFileModifiedNotification(\n\t\tparams: Record<string, unknown>,\n\t\trequestId: string,\n\t): Promise<{ acknowledged: boolean }> {\n\t\tconst {\n\t\t\tworkspace,\n\t\t\tpath: filePath,\n\t\t\tlinesChanged,\n\t\t\taiAttributed,\n\t\t} = params as {\n\t\t\tworkspace: string;\n\t\t\tpath: string;\n\t\t\tlinesChanged: number;\n\t\t\taiAttributed: boolean;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\t\tif (!filePath || typeof filePath !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"path is required\");\n\t\t}\n\n\t\t// Validate the file path\n\t\tvalidatePath(workspace, filePath);\n\n\t\tthis.logger.debug(\"File modified notification from MCP\", {\n\t\t\trequestId,\n\t\t\tworkspace,\n\t\t\tfilePath,\n\t\t\tlinesChanged,\n\t\t\taiAttributed,\n\t\t});\n\n\t\t// Record the modification in Intelligence for session tracking\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (ctx?.currentTaskId) {\n\t\t\ttry {\n\t\t\t\tconst intel = getIntelligence(workspace);\n\t\t\t\tintel.recordFileModification(ctx.currentTaskId, {\n\t\t\t\t\tpath: filePath,\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\ttype: \"update\",\n\t\t\t\t\tlinesChanged: linesChanged || 0,\n\t\t\t\t});\n\t\t\t} catch (err) {\n\t\t\t\tthis.logger.warn(\"Failed to record file modification\", { requestId, error: String(err) });\n\t\t\t}\n\t\t}\n\n\t\t// Broadcast file change event for risk detection\n\t\tthis.broadcastToWorkspace(workspace, {\n\t\t\ttype: \"risk.detected\",\n\t\t\ttimestamp: Date.now(),\n\t\t\tworkspace,\n\t\t\tdata: {\n\t\t\t\tfile: filePath,\n\t\t\t\tchangeType: \"modified\",\n\t\t\t\triskLevel: aiAttributed ? \"medium\" : \"low\",\n\t\t\t\treason: aiAttributed ? \"AI-attributed file modification\" : \"File modified\",\n\t\t\t},\n\t\t});\n\n\t\treturn { acknowledged: true };\n\t}\n\n\t// =========================================================================\n\t// HELPER METHODS\n\t// =========================================================================\n\n\t/**\n\t * Update last activity time and reset idle timer\n\t */\n\tprivate updateActivity(): void {\n\t\tthis.lastActivity = Date.now();\n\t\tthis.resetIdleTimer();\n\t}\n\n\t/**\n\t * Reset the idle timer\n\t */\n\tprivate resetIdleTimer(): void {\n\t\tif (this.idleTimer) {\n\t\t\tclearTimeout(this.idleTimer);\n\t\t}\n\n\t\tthis.idleTimer = setTimeout(() => {\n\t\t\tif (this.connections.size === 0) {\n\t\t\t\tthis.logger.info(\"Idle timeout reached, shutting down\");\n\t\t\t\tthis.emit(\"idle_timeout\");\n\t\t\t\tthis.shutdown();\n\t\t\t} else {\n\t\t\t\t// Still have connections, reset timer\n\t\t\t\tthis.resetIdleTimer();\n\t\t\t}\n\t\t}, this.config.idleTimeoutMs || DEFAULT_IDLE_TIMEOUT_MS);\n\t}\n\n\t// =========================================================================\n\t// FILE WATCHER METHODS\n\t// =========================================================================\n\n\t/**\n\t * Initialize file watcher event handlers\n\t */\n\tprivate initFileWatcherEvents(): void {\n\t\tconst fileWatcher = getFileWatcherService();\n\n\t\t// Wire up file change events to broadcast to subscribers\n\t\tfileWatcher.on(\"file_changed\", (event: FileChangeEvent) => {\n\t\t\tthis.logger.debug(\"File change detected\", {\n\t\t\t\tworkspace: event.workspace,\n\t\t\t\tfile: event.file,\n\t\t\t\ttype: event.type,\n\t\t\t\triskLevel: event.riskLevel,\n\t\t\t});\n\n\t\t\t// Broadcast to all subscribers of this workspace\n\t\t\tthis.broadcastToWorkspace(event.workspace, {\n\t\t\t\ttype: \"risk.detected\",\n\t\t\t\ttimestamp: event.timestamp,\n\t\t\t\tworkspace: event.workspace,\n\t\t\t\tdata: {\n\t\t\t\t\tfile: event.file,\n\t\t\t\t\tchangeType: event.type,\n\t\t\t\t\triskLevel: event.riskLevel,\n\t\t\t\t\treason: event.riskReason || \"File modified\",\n\t\t\t\t\tsuggestion:\n\t\t\t\t\t\tevent.riskLevel === \"high\"\n\t\t\t\t\t\t\t? \"Consider creating a snapshot before making more changes\"\n\t\t\t\t\t\t\t: event.riskLevel === \"medium\"\n\t\t\t\t\t\t\t\t? \"Monitor changes closely\"\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Update workspace activity\n\t\t\tconst workspaceCtx = this.workspaces.get(event.workspace);\n\t\t\tif (workspaceCtx) {\n\t\t\t\tworkspaceCtx.lastActivity = event.timestamp;\n\t\t\t}\n\t\t});\n\n\t\tfileWatcher.on(\"error\", (event: { workspace: string; error: string }) => {\n\t\t\tthis.logger.warn(\"File watcher error\", event);\n\t\t});\n\t}\n\n\t/**\n\t * Handle watch.subscribe\n\t */\n\tprivate async handleWatchSubscribe(\n\t\tparams: Record<string, unknown>,\n\t\trequestId: string,\n\t): Promise<{ subscribed: boolean; patterns: string[] }> {\n\t\tconst { workspace, patterns } = params as {\n\t\t\tworkspace: string;\n\t\t\tpatterns?: string[];\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\t// Validate workspace path\n\t\tvalidatePath(workspace, workspace);\n\n\t\tconst fileWatcher = getFileWatcherService();\n\n\t\t// Use requestId as subscriber ID for this connection\n\t\tconst result = await fileWatcher.subscribe(workspace, requestId, {\n\t\t\tpatterns,\n\t\t});\n\n\t\t// Track workspace subscription for this connection\n\t\t// Find the connection that made this request and update its context\n\t\tfor (const [_socket, ctx] of this.connections) {\n\t\t\t// If this is the requesting connection, update its workspace\n\t\t\tif (!ctx.workspace || ctx.workspace === workspace) {\n\t\t\t\tctx.workspace = workspace;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t// Ensure workspace context exists\n\t\tif (!this.workspaces.has(workspace)) {\n\t\t\tthis.workspaces.set(workspace, {\n\t\t\t\tid: this.hashWorkspace(workspace),\n\t\t\t\troot: workspace,\n\t\t\t\tinitialized: true,\n\t\t\t\tsessionActive: false,\n\t\t\t\tsnapshotCount: 0,\n\t\t\t\tlastActivity: Date.now(),\n\t\t\t\tsubscribers: new Set([requestId]),\n\t\t\t});\n\t\t} else {\n\t\t\tconst ctx = this.workspaces.get(workspace)!;\n\t\t\tctx.subscribers.add(requestId);\n\t\t}\n\n\t\tthis.logger.debug(\"Watch subscription added\", {\n\t\t\trequestId,\n\t\t\tworkspace,\n\t\t\tpatterns: result.patterns,\n\t\t});\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Handle watch.unsubscribe\n\t */\n\tprivate async handleWatchUnsubscribe(\n\t\tparams: Record<string, unknown>,\n\t\trequestId: string,\n\t): Promise<{ unsubscribed: boolean }> {\n\t\tconst { workspace } = params as {\n\t\t\tworkspace: string;\n\t\t};\n\n\t\tif (!workspace || typeof workspace !== \"string\") {\n\t\t\tthrow new InvalidParamsError(\"workspace is required\");\n\t\t}\n\n\t\tconst fileWatcher = getFileWatcherService();\n\n\t\tconst result = await fileWatcher.unsubscribe(workspace, requestId);\n\n\t\t// Update workspace subscribers\n\t\tconst ctx = this.workspaces.get(workspace);\n\t\tif (ctx) {\n\t\t\tctx.subscribers.delete(requestId);\n\t\t}\n\n\t\tthis.logger.debug(\"Watch subscription removed\", {\n\t\t\trequestId,\n\t\t\tworkspace,\n\t\t\tunsubscribed: result.unsubscribed,\n\t\t});\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * Broadcast event to all subscribers of a workspace\n\t *\n\t * Filters connections to only send to those subscribed to the given workspace.\n\t * Each connection context tracks which workspace(s) it is subscribed to.\n\t */\n\tprivate broadcastToWorkspace(workspace: string, event: unknown): void {\n\t\tconst notification = createNotification(event as any);\n\t\tfor (const [socket, ctx] of this.connections) {\n\t\t\t// Only send to connections subscribed to this workspace\n\t\t\tif (ctx.workspace === workspace) {\n\t\t\t\ttry {\n\t\t\t\t\tsocket.write(serializeResponse(notification));\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore write errors - connection may be closing\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Hash workspace path for identification\n\t */\n\tprivate hashWorkspace(path: string): string {\n\t\tlet hash = 0;\n\t\tconst normalized = path.toLowerCase().replace(/\\\\/g, \"/\");\n\t\tfor (let i = 0; i < normalized.length; i++) {\n\t\t\thash = (hash << 5) - hash + normalized.charCodeAt(i);\n\t\t\thash = hash & hash;\n\t\t}\n\t\treturn Math.abs(hash).toString(36);\n\t}\n}\n","/**\n * Alias Command\n *\n * Create custom shortcuts for frequently used commands.\n * Similar to: git alias, gh alias\n *\n * @module commands/alias\n */\n\nimport boxen from \"boxen\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface AliasConfig {\n\taliases: Record<string, AliasDefinition>;\n}\n\ninterface AliasDefinition {\n\tcommand: string;\n\tdescription?: string;\n\tcreatedAt: string;\n}\n\n// =============================================================================\n// ALIAS STORAGE\n// =============================================================================\n\nfunction getAliasPath(): string {\n\tconst homeDir = process.env.HOME || process.env.USERPROFILE || \"\";\n\treturn path.join(homeDir, \".snapback\", \"aliases.json\");\n}\n\nfunction loadAliases(): AliasConfig {\n\ttry {\n\t\tconst aliasPath = getAliasPath();\n\t\tif (fs.existsSync(aliasPath)) {\n\t\t\treturn JSON.parse(fs.readFileSync(aliasPath, \"utf-8\"));\n\t\t}\n\t} catch {\n\t\t// Ignore errors\n\t}\n\treturn { aliases: {} };\n}\n\nfunction saveAliases(config: AliasConfig): void {\n\tconst aliasPath = getAliasPath();\n\tconst dir = path.dirname(aliasPath);\n\tfs.mkdirSync(dir, { recursive: true });\n\tfs.writeFileSync(aliasPath, JSON.stringify(config, null, 2));\n}\n\n// =============================================================================\n// ALIAS OPERATIONS\n// =============================================================================\n\n/**\n * Set an alias\n */\nfunction setAlias(name: string, command: string, description?: string): void {\n\tconst config = loadAliases();\n\n\t// Validate alias name\n\tif (!/^[a-zA-Z][a-zA-Z0-9-_]*$/.test(name)) {\n\t\tconsole.log(\n\t\t\tchalk.red(\n\t\t\t\t\"Invalid alias name. Must start with a letter and contain only letters, numbers, hyphens, and underscores.\",\n\t\t\t),\n\t\t);\n\t\treturn;\n\t}\n\n\t// Check for reserved names\n\tconst reserved = [\"login\", \"logout\", \"init\", \"status\", \"doctor\", \"help\", \"alias\"];\n\tif (reserved.includes(name)) {\n\t\tconsole.log(chalk.red(`Cannot use \"${name}\" as an alias - it's a reserved command name.`));\n\t\treturn;\n\t}\n\n\tconst isUpdate = name in config.aliases;\n\n\tconfig.aliases[name] = {\n\t\tcommand,\n\t\tdescription,\n\t\tcreatedAt: new Date().toISOString(),\n\t};\n\n\tsaveAliases(config);\n\n\tif (isUpdate) {\n\t\tconsole.log(chalk.yellow(`Updated alias \"${name}\"`));\n\t} else {\n\t\tconsole.log(chalk.green(`Created alias \"${name}\"`));\n\t}\n\n\tconsole.log(chalk.gray(`  snap ${name}  snap ${command}`));\n}\n\n/**\n * Delete an alias\n */\nfunction deleteAlias(name: string): void {\n\tconst config = loadAliases();\n\n\tif (!(name in config.aliases)) {\n\t\tconsole.log(chalk.yellow(`Alias \"${name}\" not found`));\n\t\treturn;\n\t}\n\n\tdelete config.aliases[name];\n\tsaveAliases(config);\n\n\tconsole.log(chalk.green(`Deleted alias \"${name}\"`));\n}\n\n/**\n * List all aliases\n */\nfunction listAliases(): void {\n\tconst config = loadAliases();\n\tconst aliases = Object.entries(config.aliases);\n\n\tif (aliases.length === 0) {\n\t\tconsole.log(chalk.yellow(\"No aliases configured\"));\n\t\tconsole.log(chalk.gray(\"\\nCreate one with: snap alias set <name> <command>\"));\n\t\treturn;\n\t}\n\n\tconsole.log(chalk.cyan.bold(\"\\nConfigured Aliases:\\n\"));\n\n\tfor (const [name, def] of aliases) {\n\t\tconsole.log(`${chalk.cyan(name)}  ${chalk.white(def.command)}`);\n\t\tif (def.description) {\n\t\t\tconsole.log(chalk.gray(`  ${def.description}`));\n\t\t}\n\t}\n\n\tconsole.log();\n}\n\n/**\n * Expand an alias if it exists\n */\nexport function expandAlias(args: string[]): string[] {\n\tif (args.length === 0) return args;\n\n\tconst config = loadAliases();\n\tconst alias = config.aliases[args[0]];\n\n\tif (!alias) return args;\n\n\t// Parse the alias command and append any additional args\n\tconst aliasArgs = alias.command.split(/\\s+/);\n\treturn [...aliasArgs, ...args.slice(1)];\n}\n\n// =============================================================================\n// BUILT-IN ALIASES (suggestions)\n// =============================================================================\n\nconst SUGGESTED_ALIASES = [\n\t{ name: \"st\", command: \"status\", description: \"Quick status check\" },\n\t{ name: \"ss\", command: \"snapshot\", description: \"Create snapshot\" },\n\t{ name: \"sl\", command: \"list\", description: \"List snapshots\" },\n\t{ name: \"ctx\", command: \"context\", description: \"Get context for task\" },\n\t{ name: \"val\", command: \"validate\", description: \"Validate code\" },\n\t{ name: \"dr\", command: \"doctor\", description: \"Run diagnostics\" },\n];\n\nfunction showSuggestions(): void {\n\tconsole.log(chalk.cyan.bold(\"\\n Suggested Aliases:\\n\"));\n\n\tconst lines: string[] = [];\n\tfor (const { name, command, description } of SUGGESTED_ALIASES) {\n\t\tlines.push(`snap alias set ${name} \"${command}\"`);\n\t\tlines.push(chalk.gray(`  # ${description}`));\n\t}\n\n\tconsole.log(\n\t\tboxen(lines.join(\"\\n\"), {\n\t\t\tpadding: 1,\n\t\t\tborderColor: \"cyan\",\n\t\t\tborderStyle: \"round\",\n\t\t}),\n\t);\n}\n\n// =============================================================================\n// COMMAND EXPORT\n// =============================================================================\n\nexport function createAliasCommand(): Command {\n\tconst cmd = new Command(\"alias\").description(\"Create shortcuts for common commands\");\n\n\t// snap alias list\n\tcmd.command(\"list\")\n\t\t.description(\"List all configured aliases\")\n\t\t.action(() => {\n\t\t\tlistAliases();\n\t\t});\n\n\t// snap alias set <name> <command>\n\tcmd.command(\"set <name> <command>\")\n\t\t.description(\"Create or update an alias\")\n\t\t.option(\"-d, --description <desc>\", \"Add a description\")\n\t\t.action((name, command, options) => {\n\t\t\tsetAlias(name, command, options.description);\n\t\t});\n\n\t// snap alias delete <name>\n\tcmd.command(\"delete <name>\")\n\t\t.description(\"Delete an alias\")\n\t\t.action((name) => {\n\t\t\tdeleteAlias(name);\n\t\t});\n\n\t// snap alias suggest\n\tcmd.command(\"suggest\")\n\t\t.description(\"Show suggested aliases\")\n\t\t.action(() => {\n\t\t\tshowSuggestions();\n\t\t});\n\n\t// Default action: list aliases\n\tcmd.action(() => {\n\t\tlistAliases();\n\t});\n\n\treturn cmd;\n}\n","/**\n * Config Command\n *\n * Implements snap config get/set/path - Configuration management.\n * Manages both global (~/.snapback/) and local (.snapback/) config.\n *\n * @see cli_ui_imp.md Phase 5\n */\n\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\n\nimport {\n\ttype GlobalConfig,\n\tgetGlobalConfig,\n\tgetGlobalDir,\n\tgetWorkspaceConfig,\n\tgetWorkspaceDir,\n\tisSnapbackInitialized,\n\tsaveGlobalConfig,\n\tsaveWorkspaceConfig,\n\ttype WorkspaceConfig,\n} from \"../services/snapback-dir\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * All configurable keys\n */\ntype GlobalConfigKey = keyof GlobalConfig;\ntype WorkspaceConfigKey = keyof WorkspaceConfig;\ntype ConfigKey = GlobalConfigKey | WorkspaceConfigKey;\n\n/**\n * Config scope\n */\ntype ConfigScope = \"global\" | \"local\";\n\n// =============================================================================\n// CONFIG SCHEMA\n// =============================================================================\n\ninterface ConfigSchema {\n\tkey: string;\n\tscope: ConfigScope[];\n\ttype: \"string\" | \"boolean\" | \"number\";\n\tdescription: string;\n\tdefault?: string | boolean | number;\n}\n\nconst CONFIG_SCHEMA: ConfigSchema[] = [\n\t// Global config\n\t{\n\t\tkey: \"apiUrl\",\n\t\tscope: [\"global\"],\n\t\ttype: \"string\",\n\t\tdescription: \"SnapBack API URL\",\n\t\tdefault: \"https://api.snapback.dev\",\n\t},\n\t{\n\t\tkey: \"defaultWorkspace\",\n\t\tscope: [\"global\"],\n\t\ttype: \"string\",\n\t\tdescription: \"Default workspace path\",\n\t},\n\t{\n\t\tkey: \"analytics\",\n\t\tscope: [\"global\"],\n\t\ttype: \"boolean\",\n\t\tdescription: \"Enable anonymous usage analytics\",\n\t\tdefault: true,\n\t},\n\n\t// Workspace config\n\t{\n\t\tkey: \"protectionLevel\",\n\t\tscope: [\"local\"],\n\t\ttype: \"string\",\n\t\tdescription: \"Protection level (standard | strict)\",\n\t\tdefault: \"standard\",\n\t},\n\t{\n\t\tkey: \"syncEnabled\",\n\t\tscope: [\"local\"],\n\t\ttype: \"boolean\",\n\t\tdescription: \"Enable cloud sync\",\n\t\tdefault: true,\n\t},\n\t{\n\t\tkey: \"tier\",\n\t\tscope: [\"local\"],\n\t\ttype: \"string\",\n\t\tdescription: \"User tier (free | pro)\",\n\t\tdefault: \"free\",\n\t},\n];\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the config command\n */\nexport function createConfigCommand(): Command {\n\tconst config = new Command(\"config\").description(\"Manage SnapBack configuration\");\n\n\t// List all config\n\tconfig\n\t\t.command(\"list\")\n\t\t.description(\"List all configuration values\")\n\t\t.option(\"--global\", \"Show only global config\")\n\t\t.option(\"--local\", \"Show only local/workspace config\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.action(async (options) => {\n\t\t\ttry {\n\t\t\t\tawait listConfig(options);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Get a config value\n\tconfig\n\t\t.command(\"get <key>\")\n\t\t.description(\"Get a configuration value\")\n\t\t.option(\"--global\", \"Get from global config\")\n\t\t.option(\"--local\", \"Get from local/workspace config\")\n\t\t.action(async (key: string, options) => {\n\t\t\ttry {\n\t\t\t\tawait getConfigValue(key, options);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Set a config value\n\tconfig\n\t\t.command(\"set <key> <value>\")\n\t\t.description(\"Set a configuration value\")\n\t\t.option(\"--global\", \"Set in global config\")\n\t\t.option(\"--local\", \"Set in local/workspace config\")\n\t\t.action(async (key: string, value: string, options) => {\n\t\t\ttry {\n\t\t\t\tawait setConfigValue(key, value, options);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Unset a config value\n\tconfig\n\t\t.command(\"unset <key>\")\n\t\t.description(\"Remove a configuration value\")\n\t\t.option(\"--global\", \"Unset from global config\")\n\t\t.option(\"--local\", \"Unset from local/workspace config\")\n\t\t.action(async (key: string, options) => {\n\t\t\ttry {\n\t\t\t\tawait unsetConfigValue(key, options);\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\t// Show config file paths\n\tconfig\n\t\t.command(\"path\")\n\t\t.description(\"Show configuration file paths\")\n\t\t.action(async () => {\n\t\t\tawait showConfigPaths();\n\t\t});\n\n\t// Show available config keys\n\tconfig\n\t\t.command(\"keys\")\n\t\t.description(\"List all available configuration keys\")\n\t\t.action(() => {\n\t\t\tshowConfigKeys();\n\t\t});\n\n\treturn config;\n}\n\n// =============================================================================\n// IMPLEMENTATIONS\n// =============================================================================\n\n/**\n * List all configuration values\n */\nasync function listConfig(options: { global?: boolean; local?: boolean; json?: boolean }): Promise<void> {\n\tconst cwd = process.cwd();\n\tconst result: Record<string, unknown> = {};\n\n\t// Get global config\n\tif (!options.local) {\n\t\tconst globalConfig = await getGlobalConfig();\n\t\tif (options.json) {\n\t\t\tresult.global = globalConfig || {};\n\t\t} else {\n\t\t\tconsole.log(chalk.cyan.bold(\"Global Configuration\"));\n\t\t\tconsole.log(chalk.gray(`Path: ${getGlobalDir()}/config.json`));\n\t\t\tconsole.log();\n\n\t\t\tif (globalConfig) {\n\t\t\t\tfor (const [key, value] of Object.entries(globalConfig)) {\n\t\t\t\t\tconsole.log(`  ${chalk.cyan(key)}: ${formatValue(value)}`);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.log(chalk.gray(\"  (no global config set)\"));\n\t\t\t}\n\t\t\tconsole.log();\n\t\t}\n\t}\n\n\t// Get local config\n\tif (!options.global) {\n\t\tconst hasWorkspace = await isSnapbackInitialized(cwd);\n\n\t\tif (hasWorkspace) {\n\t\t\tconst workspaceConfig = await getWorkspaceConfig(cwd);\n\t\t\tif (options.json) {\n\t\t\t\tresult.local = workspaceConfig || {};\n\t\t\t} else {\n\t\t\t\tconsole.log(chalk.cyan.bold(\"Workspace Configuration\"));\n\t\t\t\tconsole.log(chalk.gray(`Path: ${getWorkspaceDir(cwd)}/config.json`));\n\t\t\t\tconsole.log();\n\n\t\t\t\tif (workspaceConfig) {\n\t\t\t\t\tfor (const [key, value] of Object.entries(workspaceConfig)) {\n\t\t\t\t\t\tconsole.log(`  ${chalk.cyan(key)}: ${formatValue(value)}`);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(chalk.gray(\"  (no workspace config set)\"));\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (!options.json) {\n\t\t\tconsole.log(chalk.yellow(\"Not in a SnapBack workspace\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t}\n\t}\n\n\tif (options.json) {\n\t\tconsole.log(JSON.stringify(result, null, 2));\n\t}\n}\n\n/**\n * Get a configuration value\n */\nasync function getConfigValue(key: string, options: { global?: boolean; local?: boolean }): Promise<void> {\n\tconst cwd = process.cwd();\n\tconst schema = CONFIG_SCHEMA.find((s) => s.key === key);\n\n\tif (!schema) {\n\t\tconsole.log(chalk.yellow(`Unknown config key: ${key}`));\n\t\tconsole.log(chalk.gray(\"Run 'snap config keys' to see available keys\"));\n\t\treturn;\n\t}\n\n\t// Determine scope\n\tconst scope = determineScope(options, schema);\n\n\tlet value: unknown;\n\n\tif (scope === \"global\") {\n\t\tconst config = await getGlobalConfig();\n\t\tvalue = config?.[key as GlobalConfigKey];\n\t} else {\n\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\tconsole.log(chalk.yellow(\"Not in a SnapBack workspace\"));\n\t\t\treturn;\n\t\t}\n\t\tconst config = await getWorkspaceConfig(cwd);\n\t\tvalue = config?.[key as WorkspaceConfigKey];\n\t}\n\n\tif (value === undefined) {\n\t\tif (schema.default !== undefined) {\n\t\t\tconsole.log(formatValue(schema.default), chalk.gray(\"(default)\"));\n\t\t} else {\n\t\t\tconsole.log(chalk.gray(\"(not set)\"));\n\t\t}\n\t} else {\n\t\tconsole.log(formatValue(value));\n\t}\n}\n\n/**\n * Set a configuration value\n */\nasync function setConfigValue(\n\tkey: string,\n\tvalue: string,\n\toptions: { global?: boolean; local?: boolean },\n): Promise<void> {\n\tconst cwd = process.cwd();\n\tconst schema = CONFIG_SCHEMA.find((s) => s.key === key);\n\n\tif (!schema) {\n\t\tconsole.log(chalk.yellow(`Unknown config key: ${key}`));\n\t\tconsole.log(chalk.gray(\"Run 'snap config keys' to see available keys\"));\n\t\treturn;\n\t}\n\n\t// Determine scope\n\tconst scope = determineScope(options, schema);\n\n\t// Parse value based on type\n\tconst parsedValue = parseValue(value, schema.type);\n\n\tif (scope === \"global\") {\n\t\tconst config = (await getGlobalConfig()) || {};\n\t\t(config as Record<string, unknown>)[key] = parsedValue;\n\t\tawait saveGlobalConfig(config);\n\t\tconsole.log(chalk.green(\"\"), `Set ${chalk.cyan(key)} = ${formatValue(parsedValue)} (global)`);\n\t} else {\n\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\tconsole.log(chalk.yellow(\"Not in a SnapBack workspace\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\treturn;\n\t\t}\n\n\t\tconst config = (await getWorkspaceConfig(cwd)) || {\n\t\t\tcreatedAt: new Date().toISOString(),\n\t\t\tupdatedAt: new Date().toISOString(),\n\t\t};\n\t\t(config as unknown as Record<string, unknown>)[key] = parsedValue;\n\t\tconfig.updatedAt = new Date().toISOString();\n\t\tawait saveWorkspaceConfig(config, cwd);\n\t\tconsole.log(chalk.green(\"\"), `Set ${chalk.cyan(key)} = ${formatValue(parsedValue)} (workspace)`);\n\t}\n}\n\n/**\n * Unset a configuration value\n */\nasync function unsetConfigValue(key: string, options: { global?: boolean; local?: boolean }): Promise<void> {\n\tconst cwd = process.cwd();\n\tconst schema = CONFIG_SCHEMA.find((s) => s.key === key);\n\n\tif (!schema) {\n\t\tconsole.log(chalk.yellow(`Unknown config key: ${key}`));\n\t\treturn;\n\t}\n\n\tconst scope = determineScope(options, schema);\n\n\tif (scope === \"global\") {\n\t\tconst config = await getGlobalConfig();\n\t\tif (config && key in config) {\n\t\t\tdelete (config as Record<string, unknown>)[key];\n\t\t\tawait saveGlobalConfig(config);\n\t\t\tconsole.log(chalk.green(\"\"), `Unset ${chalk.cyan(key)} (global)`);\n\t\t} else {\n\t\t\tconsole.log(chalk.gray(`${key} was not set`));\n\t\t}\n\t} else {\n\t\tif (!(await isSnapbackInitialized(cwd))) {\n\t\t\tconsole.log(chalk.yellow(\"Not in a SnapBack workspace\"));\n\t\t\treturn;\n\t\t}\n\n\t\tconst config = await getWorkspaceConfig(cwd);\n\t\tif (config && key in config) {\n\t\t\tdelete (config as unknown as Record<string, unknown>)[key];\n\t\t\tconfig.updatedAt = new Date().toISOString();\n\t\t\tawait saveWorkspaceConfig(config, cwd);\n\t\t\tconsole.log(chalk.green(\"\"), `Unset ${chalk.cyan(key)} (workspace)`);\n\t\t} else {\n\t\t\tconsole.log(chalk.gray(`${key} was not set`));\n\t\t}\n\t}\n}\n\n/**\n * Show configuration file paths\n */\nasync function showConfigPaths(): Promise<void> {\n\tconst cwd = process.cwd();\n\n\tconsole.log(chalk.cyan.bold(\"Configuration Paths\"));\n\tconsole.log();\n\n\tconsole.log(chalk.bold(\"Global:\"));\n\tconsole.log(`  ${chalk.cyan(\"Directory:\")}  ${getGlobalDir()}`);\n\tconsole.log(`  ${chalk.cyan(\"Config:\")}     ${getGlobalDir()}/config.json`);\n\tconsole.log(`  ${chalk.cyan(\"Credentials:\")} ${getGlobalDir()}/credentials.json`);\n\tconsole.log();\n\n\tconsole.log(chalk.bold(\"Workspace:\"));\n\tif (await isSnapbackInitialized(cwd)) {\n\t\tconsole.log(`  ${chalk.cyan(\"Directory:\")}  ${getWorkspaceDir(cwd)}`);\n\t\tconsole.log(`  ${chalk.cyan(\"Config:\")}     ${getWorkspaceDir(cwd)}/config.json`);\n\t\tconsole.log(`  ${chalk.cyan(\"Vitals:\")}     ${getWorkspaceDir(cwd)}/vitals.json`);\n\t\tconsole.log(`  ${chalk.cyan(\"Protected:\")}  ${getWorkspaceDir(cwd)}/protected.json`);\n\t} else {\n\t\tconsole.log(chalk.gray(\"  Not in a SnapBack workspace\"));\n\t}\n}\n\n/**\n * Show available config keys\n */\nfunction showConfigKeys(): void {\n\tconsole.log(chalk.cyan.bold(\"Available Configuration Keys\"));\n\tconsole.log();\n\n\tconsole.log(chalk.bold(\"Global (--global):\"));\n\tfor (const schema of CONFIG_SCHEMA.filter((s) => s.scope.includes(\"global\"))) {\n\t\tconsole.log(`  ${chalk.cyan(schema.key.padEnd(20))} ${chalk.gray(schema.description)}`);\n\t\tif (schema.default !== undefined) {\n\t\t\tconsole.log(`  ${\"\".padEnd(20)} ${chalk.gray(`Default: ${schema.default}`)}`);\n\t\t}\n\t}\n\tconsole.log();\n\n\tconsole.log(chalk.bold(\"Workspace (--local):\"));\n\tfor (const schema of CONFIG_SCHEMA.filter((s) => s.scope.includes(\"local\"))) {\n\t\tconsole.log(`  ${chalk.cyan(schema.key.padEnd(20))} ${chalk.gray(schema.description)}`);\n\t\tif (schema.default !== undefined) {\n\t\t\tconsole.log(`  ${\"\".padEnd(20)} ${chalk.gray(`Default: ${schema.default}`)}`);\n\t\t}\n\t}\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Determine config scope from options\n */\nfunction determineScope(options: { global?: boolean; local?: boolean }, schema: ConfigSchema): ConfigScope {\n\tif (options.global) return \"global\";\n\tif (options.local) return \"local\";\n\n\t// Use schema default\n\treturn schema.scope[0];\n}\n\n/**\n * Parse value based on type\n */\nfunction parseValue(value: string, type: ConfigSchema[\"type\"]): string | boolean | number {\n\tswitch (type) {\n\t\tcase \"boolean\":\n\t\t\treturn value === \"true\" || value === \"1\" || value === \"yes\";\n\t\tcase \"number\":\n\t\t\treturn Number(value);\n\t\tdefault:\n\t\t\treturn value;\n\t}\n}\n\n/**\n * Format value for display\n */\nfunction formatValue(value: unknown): string {\n\tif (typeof value === \"boolean\") {\n\t\treturn value ? chalk.green(\"true\") : chalk.red(\"false\");\n\t}\n\tif (typeof value === \"string\") {\n\t\treturn chalk.yellow(`\"${value}\"`);\n\t}\n\treturn String(value);\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { CONFIG_SCHEMA, type ConfigSchema, type ConfigScope };\n","/**\n * Doctor Command\n *\n * Implements snap doctor - Comprehensive diagnostic command.\n * Checks all aspects of SnapBack configuration and health.\n *\n * Diagnostics include:\n * - CLI installation and PATH\n * - Authentication status\n * - Workspace configuration\n * - MCP tool configurations\n * - Git integration\n * - Network connectivity\n *\n * @see cli_ui_imp.md Phase 6\n */\n\nimport { exec } from \"node:child_process\";\nimport { access, constants, readFile } from \"node:fs/promises\";\nimport { homedir } from \"node:os\";\nimport { join } from \"node:path\";\nimport { promisify } from \"node:util\";\nimport { detectAIClients, repairClientConfig, validateClientConfig } from \"@snapback/mcp-config\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport ora from \"ora\";\n\n// Reserved for potential future use in async diagnostics\nconst _execAsync = promisify(exec);\n\nimport {\n\tgetCredentials,\n\tgetGlobalDir,\n\tgetWorkspaceConfig,\n\tgetWorkspaceDir,\n\tisLoggedIn,\n\tisSnapbackInitialized,\n} from \"../services/snapback-dir\";\nimport { displayBox } from \"../utils/display\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface DiagnosticResult {\n\tname: string;\n\tstatus: \"ok\" | \"warning\" | \"error\" | \"info\";\n\tmessage: string;\n\tdetails?: string[];\n\tfix?: string;\n}\n\ninterface DiagnosticReport {\n\ttimestamp: string;\n\tcliVersion: string;\n\tnodeVersion: string;\n\tplatform: string;\n\tresults: DiagnosticResult[];\n\tsummary: {\n\t\ttotal: number;\n\t\tok: number;\n\t\twarnings: number;\n\t\terrors: number;\n\t};\n}\n\ninterface DoctorOptions {\n\tfix?: boolean;\n\tfixMcp?: boolean;\n\tjson?: boolean;\n\tverbose?: boolean;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the doctor command\n */\nexport function createDoctorCommand(): Command {\n\treturn new Command(\"doctor\")\n\t\t.description(\"Diagnose SnapBack configuration and health\")\n\t\t.option(\"--fix\", \"Attempt to auto-fix detected issues\")\n\t\t.option(\"--fix-mcp\", \"Auto-repair broken MCP configurations\")\n\t\t.option(\"--json\", \"Output as JSON\")\n\t\t.option(\"--verbose\", \"Show detailed information\")\n\t\t.action(async (options: DoctorOptions) => {\n\t\t\tconst spinner = ora(\"Running diagnostics...\").start();\n\n\t\t\ttry {\n\t\t\t\tconst report = await runDiagnostics(options);\n\n\t\t\t\tspinner.stop();\n\n\t\t\t\tif (options.json) {\n\t\t\t\t\tconsole.log(JSON.stringify(report, null, 2));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdisplayReport(report, options.verbose);\n\n\t\t\t\t// Auto-fix if requested\n\t\t\t\tif (options.fix && report.summary.errors + report.summary.warnings > 0) {\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tawait runAutoFixes(report.results);\n\t\t\t\t}\n\n\t\t\t\t// Auto-fix MCP configurations if requested\n\t\t\t\tif (options.fixMcp) {\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tawait runMcpAutoFix();\n\t\t\t\t}\n\n\t\t\t\t// Exit with appropriate code\n\t\t\t\tif (report.summary.errors > 0) {\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\t\t\t} catch (error: unknown) {\n\t\t\t\tspinner.fail(\"Diagnostics failed\");\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n}\n\n// =============================================================================\n// DIAGNOSTICS\n// =============================================================================\n\n/**\n * Run all diagnostics\n */\nasync function runDiagnostics(_options: DoctorOptions = {}): Promise<DiagnosticReport> {\n\tconst results: DiagnosticResult[] = [];\n\n\t// Get CLI version from package.json\n\tlet cliVersion = \"unknown\";\n\ttry {\n\t\tconst pkgPath = join(__dirname, \"../../package.json\");\n\t\tconst pkg = JSON.parse(await readFile(pkgPath, \"utf-8\"));\n\t\tcliVersion = pkg.version;\n\t} catch {\n\t\t// Fallback\n\t}\n\n\t// Run core checks (always)\n\tresults.push(await checkNodeVersion());\n\tresults.push(await checkCliInstallation());\n\tresults.push(await checkGlobalDirectory());\n\tresults.push(await checkAuthentication());\n\tresults.push(await checkWorkspace());\n\tresults.push(await checkMcpTools());\n\tresults.push(await checkGitIntegration());\n\tresults.push(await checkNetworkConnectivity());\n\n\t// Calculate summary\n\tconst summary = {\n\t\ttotal: results.length,\n\t\tok: results.filter((r) => r.status === \"ok\").length,\n\t\twarnings: results.filter((r) => r.status === \"warning\").length,\n\t\terrors: results.filter((r) => r.status === \"error\").length,\n\t};\n\n\treturn {\n\t\ttimestamp: new Date().toISOString(),\n\t\tcliVersion,\n\t\tnodeVersion: process.version,\n\t\tplatform: `${process.platform} ${process.arch}`,\n\t\tresults,\n\t\tsummary,\n\t};\n}\n\n/**\n * Check Node.js version\n */\nasync function checkNodeVersion(): Promise<DiagnosticResult> {\n\tconst version = process.version;\n\tconst major = Number.parseInt(version.slice(1).split(\".\")[0], 10);\n\n\tif (major >= 18) {\n\t\treturn {\n\t\t\tname: \"Node.js Version\",\n\t\t\tstatus: \"ok\",\n\t\t\tmessage: `Node.js ${version} (supported)`,\n\t\t};\n\t}\n\n\treturn {\n\t\tname: \"Node.js Version\",\n\t\tstatus: \"warning\",\n\t\tmessage: `Node.js ${version} (upgrade recommended)`,\n\t\tdetails: [\"SnapBack works best with Node.js 18+\"],\n\t\tfix: \"Upgrade to Node.js 18 or later\",\n\t};\n}\n\n/**\n * Check CLI installation\n */\nasync function checkCliInstallation(): Promise<DiagnosticResult> {\n\tconst npmPrefix = process.env.npm_config_prefix || join(homedir(), \".npm-global\");\n\tconst pathDirs = (process.env.PATH || \"\").split(\":\");\n\n\tconst snapInPath = pathDirs.some(\n\t\t(dir) => dir.includes(\"npm\") || dir.includes(\".npm-global\") || dir.includes(\"node_modules/.bin\"),\n\t);\n\n\tif (snapInPath) {\n\t\treturn {\n\t\t\tname: \"CLI Installation\",\n\t\t\tstatus: \"ok\",\n\t\t\tmessage: \"snap command is in PATH\",\n\t\t};\n\t}\n\n\treturn {\n\t\tname: \"CLI Installation\",\n\t\tstatus: \"warning\",\n\t\tmessage: \"npm global bin may not be in PATH\",\n\t\tdetails: [`npm prefix: ${npmPrefix}`, \"This could cause 'snap' command not found errors\"],\n\t\tfix: `Add \"${npmPrefix}/bin\" to your PATH`,\n\t};\n}\n\n/**\n * Check global directory\n */\nasync function checkGlobalDirectory(): Promise<DiagnosticResult> {\n\tconst globalDir = getGlobalDir();\n\n\ttry {\n\t\tawait access(globalDir, constants.F_OK);\n\t\treturn {\n\t\t\tname: \"Global Directory\",\n\t\t\tstatus: \"ok\",\n\t\t\tmessage: \"~/.snapback/ exists\",\n\t\t\tdetails: [globalDir],\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tname: \"Global Directory\",\n\t\t\tstatus: \"info\",\n\t\t\tmessage: \"~/.snapback/ not created yet\",\n\t\t\tdetails: [\"Will be created on first login\"],\n\t\t};\n\t}\n}\n\n/**\n * Check authentication status\n */\nasync function checkAuthentication(): Promise<DiagnosticResult> {\n\ttry {\n\t\tif (await isLoggedIn()) {\n\t\t\tconst creds = await getCredentials();\n\t\t\treturn {\n\t\t\t\tname: \"Authentication\",\n\t\t\t\tstatus: \"ok\",\n\t\t\t\tmessage: `Logged in as ${creds?.email}`,\n\t\t\t\tdetails: [`Tier: ${creds?.tier || \"free\"}`],\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tname: \"Authentication\",\n\t\t\tstatus: \"warning\",\n\t\t\tmessage: \"Not logged in\",\n\t\t\tdetails: [\"Some features require authentication\"],\n\t\t\tfix: \"Run: snap login\",\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tname: \"Authentication\",\n\t\t\tstatus: \"error\",\n\t\t\tmessage: \"Failed to check authentication\",\n\t\t};\n\t}\n}\n\n/**\n * Check workspace configuration\n */\nasync function checkWorkspace(): Promise<DiagnosticResult> {\n\tconst cwd = process.cwd();\n\n\ttry {\n\t\tif (await isSnapbackInitialized(cwd)) {\n\t\t\tawait getWorkspaceConfig(cwd);\n\t\t\treturn {\n\t\t\t\tname: \"Workspace\",\n\t\t\t\tstatus: \"ok\",\n\t\t\t\tmessage: \"SnapBack initialized in this workspace\",\n\t\t\t\tdetails: [`Directory: ${getWorkspaceDir(cwd)}`],\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tname: \"Workspace\",\n\t\t\tstatus: \"info\",\n\t\t\tmessage: \"Not a SnapBack workspace\",\n\t\t\tfix: \"Run: snap init\",\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tname: \"Workspace\",\n\t\t\tstatus: \"error\",\n\t\t\tmessage: \"Failed to check workspace\",\n\t\t};\n\t}\n}\n\n/**\n * Check MCP tool configurations with deep validation\n */\nasync function checkMcpTools(): Promise<DiagnosticResult> {\n\ttry {\n\t\tconst detection = detectAIClients();\n\n\t\tif (detection.detected.length === 0) {\n\t\t\treturn {\n\t\t\t\tname: \"AI Tools\",\n\t\t\t\tstatus: \"info\",\n\t\t\t\tmessage: \"No AI tools detected\",\n\t\t\t};\n\t\t}\n\n\t\tconst configured = detection.detected.filter((c) => c.hasSnapback);\n\t\tconst needsSetup = detection.needsSetup;\n\n\t\t// Deep validation for configured clients\n\t\tconst validationIssues: string[] = [];\n\t\tlet hasErrors = false;\n\t\tlet hasWarnings = false;\n\n\t\tfor (const client of configured) {\n\t\t\tconst validation = validateClientConfig(client);\n\t\t\tconst errors = validation.issues.filter((i) => i.severity === \"error\");\n\t\t\tconst warnings = validation.issues.filter((i) => i.severity === \"warning\");\n\n\t\t\tif (errors.length > 0) {\n\t\t\t\thasErrors = true;\n\t\t\t\tfor (const err of errors) {\n\t\t\t\t\tvalidationIssues.push(`${client.displayName}: ${err.message}`);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (warnings.length > 0) {\n\t\t\t\thasWarnings = true;\n\t\t\t\tfor (const warn of warnings) {\n\t\t\t\t\tvalidationIssues.push(`${client.displayName}: ${warn.message}`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Return based on validation results\n\t\tif (hasErrors) {\n\t\t\treturn {\n\t\t\t\tname: \"AI Tools\",\n\t\t\t\tstatus: \"error\",\n\t\t\t\tmessage: `${configured.length} tool(s) configured, but some have errors`,\n\t\t\t\tdetails: validationIssues,\n\t\t\t\tfix: \"Run: snap doctor --fix-mcp\",\n\t\t\t};\n\t\t}\n\n\t\tif (hasWarnings) {\n\t\t\treturn {\n\t\t\t\tname: \"AI Tools\",\n\t\t\t\tstatus: \"warning\",\n\t\t\t\tmessage: `${configured.length} tool(s) configured with warnings`,\n\t\t\t\tdetails: validationIssues,\n\t\t\t\tfix: \"Run: snap doctor --fix-mcp\",\n\t\t\t};\n\t\t}\n\n\t\tif (needsSetup.length > 0) {\n\t\t\treturn {\n\t\t\t\tname: \"AI Tools\",\n\t\t\t\tstatus: \"warning\",\n\t\t\t\tmessage: `${needsSetup.length} AI tool(s) need configuration`,\n\t\t\t\tdetails: needsSetup.map((c) => `${c.displayName} not configured`),\n\t\t\t\tfix: \"Run: snap tools configure\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tname: \"AI Tools\",\n\t\t\tstatus: \"ok\",\n\t\t\tmessage: `${configured.length} AI tool(s) configured and healthy`,\n\t\t\tdetails: configured.map((c) => c.displayName),\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tname: \"AI Tools\",\n\t\t\tstatus: \"error\",\n\t\t\tmessage: \"Failed to check AI tools\",\n\t\t};\n\t}\n}\n\n/**\n * Check Git integration\n */\nasync function checkGitIntegration(): Promise<DiagnosticResult> {\n\tconst cwd = process.cwd();\n\n\ttry {\n\t\tawait access(join(cwd, \".git\"), constants.F_OK);\n\n\t\ttry {\n\t\t\tconst hookPath = join(cwd, \".git/hooks/pre-commit\");\n\t\t\tconst hookContent = await readFile(hookPath, \"utf-8\");\n\n\t\t\tif (hookContent.includes(\"snap check\")) {\n\t\t\t\treturn {\n\t\t\t\t\tname: \"Git Integration\",\n\t\t\t\t\tstatus: \"ok\",\n\t\t\t\t\tmessage: \"Git repository with SnapBack hook\",\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tname: \"Git Integration\",\n\t\t\t\tstatus: \"info\",\n\t\t\t\tmessage: \"Git repository (hook not configured)\",\n\t\t\t\tfix: \"Consider adding 'snap check' to pre-commit hook\",\n\t\t\t};\n\t\t} catch {\n\t\t\treturn {\n\t\t\t\tname: \"Git Integration\",\n\t\t\t\tstatus: \"info\",\n\t\t\t\tmessage: \"Git repository (no pre-commit hook)\",\n\t\t\t};\n\t\t}\n\t} catch {\n\t\treturn {\n\t\t\tname: \"Git Integration\",\n\t\t\tstatus: \"info\",\n\t\t\tmessage: \"Not a Git repository\",\n\t\t};\n\t}\n}\n\n/**\n * Check network connectivity\n */\nasync function checkNetworkConnectivity(): Promise<DiagnosticResult> {\n\tconst apiUrl = process.env.SNAPBACK_API_URL || \"https://api.snapback.dev\";\n\n\ttry {\n\t\tconst response = await fetch(`${apiUrl}/health`).catch(() => null);\n\n\t\tif (response?.ok) {\n\t\t\treturn {\n\t\t\t\tname: \"Network\",\n\t\t\t\tstatus: \"ok\",\n\t\t\t\tmessage: \"Connected to SnapBack API\",\n\t\t\t};\n\t\t}\n\n\t\treturn {\n\t\t\tname: \"Network\",\n\t\t\tstatus: \"warning\",\n\t\t\tmessage: \"Cannot reach SnapBack API (offline mode available)\",\n\t\t};\n\t} catch {\n\t\treturn {\n\t\t\tname: \"Network\",\n\t\t\tstatus: \"warning\",\n\t\t\tmessage: \"Cannot reach SnapBack API\",\n\t\t};\n\t}\n}\n\n// =============================================================================\n// DISPLAY\n// =============================================================================\n\n/**\n * Display diagnostic report\n */\nfunction displayReport(report: DiagnosticReport, verbose?: boolean): void {\n\tconsole.log(`\\n${chalk.cyan.bold(\"SnapBack System Health Report\")}`);\n\tconsole.log(chalk.gray(`Generated: ${new Date(report.timestamp).toLocaleString()}\\n`));\n\n\tdisplayBox(\n\t\t[\n\t\t\t`${chalk.bold(\"CLI Version:\")}  ${report.cliVersion}`,\n\t\t\t`${chalk.bold(\"Node Version:\")} ${report.nodeVersion}`,\n\t\t\t`${chalk.bold(\"Platform:\")}     ${report.platform}`,\n\t\t].join(\"\\n\"),\n\t\t{ title: \"Environment\", padding: 1 },\n\t);\n\n\tconsole.log();\n\n\tfor (const result of report.results) {\n\t\tconst icon = getStatusIcon(result.status);\n\t\tconst color = getStatusColor(result.status);\n\n\t\tconsole.log(`${icon} ${chalk.bold(result.name)}: ${color(result.message)}`);\n\n\t\tif (verbose && result.details?.length) {\n\t\t\tfor (const detail of result.details) {\n\t\t\t\tconsole.log(chalk.gray(`   ${detail}`));\n\t\t\t}\n\t\t}\n\n\t\tif (result.fix) {\n\t\t\tconsole.log(chalk.cyan(`   Fix: ${result.fix}`));\n\t\t}\n\t}\n\n\tconsole.log(`\\n${chalk.gray(\"\".repeat(40))}`);\n\n\tconst { warnings, errors, total } = report.summary;\n\tif (errors > 0) {\n\t\tconsole.log(chalk.red.bold(`\\n Diagnostics failed: ${errors} error(s), ${warnings} warning(s)`));\n\t} else if (warnings > 0) {\n\t\tconsole.log(chalk.yellow.bold(`\\n Diagnostics found ${warnings} issue(s)`));\n\t} else {\n\t\tconsole.log(chalk.green.bold(`\\n All ${total} systems healthy!`));\n\t}\n}\n\n/**\n * Get status icon\n */\nfunction getStatusIcon(status: DiagnosticResult[\"status\"]): string {\n\tswitch (status) {\n\t\tcase \"ok\":\n\t\t\treturn chalk.green(\"\");\n\t\tcase \"warning\":\n\t\t\treturn chalk.yellow(\"\");\n\t\tcase \"error\":\n\t\t\treturn chalk.red(\"\");\n\t\tcase \"info\":\n\t\t\treturn chalk.blue(\"\");\n\t\tdefault:\n\t\t\treturn \" \";\n\t}\n}\n\n/**\n * Get status color function\n */\nfunction getStatusColor(status: DiagnosticResult[\"status\"]): (text: string) => string {\n\tswitch (status) {\n\t\tcase \"ok\":\n\t\t\treturn chalk.green;\n\t\tcase \"warning\":\n\t\t\treturn chalk.yellow;\n\t\tcase \"error\":\n\t\t\treturn chalk.red;\n\t\tcase \"info\":\n\t\t\treturn chalk.blue;\n\t\tdefault:\n\t\t\treturn chalk.white;\n\t}\n}\n\n// =============================================================================\n// AUTO-FIX\n// =============================================================================\n\n/**\n * Run auto-fixes for detected issues\n */\nasync function runAutoFixes(results: DiagnosticResult[]): Promise<void> {\n\tconst fixable = results.filter((r) => r.fix && (r.status === \"warning\" || r.status === \"error\"));\n\n\tif (fixable.length === 0) {\n\t\tconsole.log(chalk.gray(\"No auto-fixable issues found.\"));\n\t\treturn;\n\t}\n\n\tconsole.log(chalk.cyan(\"Attempting auto-fixes...\"));\n\tconsole.log();\n\n\tfor (const result of fixable) {\n\t\tconsole.log(chalk.gray(` ${result.name}: ${result.fix}`));\n\t}\n\n\tconsole.log();\n\tconsole.log(chalk.gray(\"Follow the instructions above to fix detected issues.\"));\n}\n\n/**\n * Auto-fix MCP configurations\n */\nasync function runMcpAutoFix(): Promise<void> {\n\tconst detection = detectAIClients();\n\tconst configured = detection.detected.filter((c) => c.hasSnapback);\n\n\tif (configured.length === 0) {\n\t\tconsole.log(chalk.yellow(\"No MCP configurations to repair.\"));\n\t\tconsole.log(chalk.gray(\"Run: snap tools configure\"));\n\t\treturn;\n\t}\n\n\t// Find clients with issues\n\tconst clientsWithIssues = configured.filter((client) => {\n\t\tconst validation = validateClientConfig(client);\n\t\treturn !validation.valid || validation.issues.some((i) => i.severity === \"error\" || i.severity === \"warning\");\n\t});\n\n\tif (clientsWithIssues.length === 0) {\n\t\tconsole.log(chalk.green(\"All MCP configurations are healthy!\"));\n\t\treturn;\n\t}\n\n\tconsole.log(chalk.cyan(\"Repairing MCP configurations...\"));\n\tconsole.log();\n\n\tlet repaired = 0;\n\tlet failed = 0;\n\n\tfor (const client of clientsWithIssues) {\n\t\tconst spinner = ora(`Repairing ${client.displayName}...`).start();\n\n\t\tconst result = repairClientConfig(client, {\n\t\t\tworkspaceRoot: process.cwd(),\n\t\t\tforce: true,\n\t\t});\n\n\t\tif (result.success) {\n\t\t\tspinner.succeed(`Repaired ${client.displayName}`);\n\t\t\trepaired++;\n\t\t} else {\n\t\t\tspinner.fail(`Failed to repair ${client.displayName}: ${result.error}`);\n\t\t\tfailed++;\n\t\t}\n\t}\n\n\tconsole.log();\n\tif (repaired > 0) {\n\t\tconsole.log(chalk.green(` Repaired ${repaired} configuration(s).`));\n\t\tconsole.log(chalk.bold(\"Restart your AI assistant to apply changes.\"));\n\t}\n\tif (failed > 0) {\n\t\tconsole.log(chalk.red(` Failed to repair ${failed} configuration(s).`));\n\t\tconsole.log(chalk.gray(\"Try: snap tools configure --force\"));\n\t}\n}\n\nexport { runDiagnostics, type DiagnosticReport, type DiagnosticResult };\n","/**\n * Undo Command\n *\n * Undo the most recent destructive operation.\n * Maintains history of operations for safety.\n *\n * @module commands/undo\n */\n\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport { getRecentOperations, undoLastOperation } from \"../utils/safe-ops\";\n\nexport function createUndoCommand(): Command {\n\tconst cmd = new Command(\"undo\")\n\t\t.description(\"Undo the last destructive operation\")\n\t\t.option(\"--list\", \"List recent undoable operations\")\n\t\t.action(async (options) => {\n\t\t\tif (options.list) {\n\t\t\t\tconst operations = getRecentOperations(10);\n\n\t\t\t\tif (operations.length === 0) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"No recent operations found\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan.bold(\"\\nRecent Operations:\\n\"));\n\n\t\t\t\tfor (let i = 0; i < operations.length; i++) {\n\t\t\t\t\tconst op = operations[i];\n\t\t\t\t\tconst status = op.canUndo ? chalk.green(\"\") : chalk.gray(\"\");\n\t\t\t\t\tconst time = new Date(op.timestamp).toLocaleString();\n\n\t\t\t\t\tconsole.log(`${status} ${chalk.white(op.description)}`);\n\t\t\t\t\tconsole.log(chalk.gray(`  ${time}  ${op.changes.length} changes`));\n\n\t\t\t\t\tif (i < operations.length - 1) {\n\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.gray(\"\\n = Can undo   = Cannot undo\\n\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait undoLastOperation();\n\t\t});\n\n\treturn cmd;\n}\n","/**\n * Upgrade Command\n *\n * Implements snap upgrade - Check for and install CLI updates.\n * Self-updates the CLI to the latest version.\n *\n * @see cli_ui_imp.md Phase 6\n */\n\nimport { exec } from \"node:child_process\";\nimport { readFile } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport { promisify } from \"node:util\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport ora from \"ora\";\n\nimport { displayBox } from \"../utils/display\";\n\nconst execAsync = promisify(exec);\n\n// =============================================================================\n// CONSTANTS\n// =============================================================================\n\nconst PACKAGE_NAME = \"@snapback/cli\";\nconst NPM_REGISTRY = \"https://registry.npmjs.org\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface VersionInfo {\n\tcurrent: string;\n\tlatest: string;\n\tupdateAvailable: boolean;\n}\n\n// =============================================================================\n// COMMAND DEFINITION\n// =============================================================================\n\n/**\n * Create the upgrade command\n */\nexport function createUpgradeCommand(): Command {\n\treturn new Command(\"upgrade\")\n\t\t.description(\"Check for and install CLI updates\")\n\t\t.option(\"--check\", \"Only check for updates, don't install\")\n\t\t.option(\"--force\", \"Force reinstall even if up to date\")\n\t\t.option(\"--canary\", \"Install latest canary/pre-release version\")\n\t\t.action(async (options) => {\n\t\t\ttry {\n\t\t\t\tconst spinner = ora(\"Checking for updates...\").start();\n\n\t\t\t\t// Get version info\n\t\t\t\tconst versionInfo = await getVersionInfo(options.canary);\n\n\t\t\t\tspinner.stop();\n\n\t\t\t\t// Display current status\n\t\t\t\tconsole.log(\n\t\t\t\t\tdisplayBox({\n\t\t\t\t\t\ttitle: \" SnapBack CLI\",\n\t\t\t\t\t\tcontent: `Current: v${versionInfo.current}\\nLatest:  v${versionInfo.latest}`,\n\t\t\t\t\t\ttype: versionInfo.updateAvailable ? \"warning\" : \"success\",\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t\tconsole.log();\n\n\t\t\t\tif (!versionInfo.updateAvailable && !options.force) {\n\t\t\t\t\tconsole.log(chalk.green(\"\"), \"You're on the latest version!\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (options.check) {\n\t\t\t\t\tif (versionInfo.updateAvailable) {\n\t\t\t\t\t\tconsole.log(chalk.yellow(\"\"), \"Update available!\");\n\t\t\t\t\t\tconsole.log(chalk.gray(`Run 'snap upgrade' to install v${versionInfo.latest}`));\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Proceed with upgrade\n\t\t\t\tif (versionInfo.updateAvailable) {\n\t\t\t\t\tconsole.log(chalk.cyan(\"\"), `Upgrading to v${versionInfo.latest}...`);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(chalk.cyan(\"\"), \"Reinstalling current version...\");\n\t\t\t\t}\n\n\t\t\t\tawait performUpgrade(options.canary);\n\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(chalk.green(\"\"), \"Upgrade complete!\");\n\t\t\t\tconsole.log(chalk.gray(\"Restart your terminal to use the new version.\"));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tconsole.error(chalk.red(\"Upgrade failed:\"), message);\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(chalk.gray(\"Manual upgrade:\"));\n\t\t\t\tconsole.log(chalk.gray(`  npm install -g ${PACKAGE_NAME}@latest`));\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n}\n\n// =============================================================================\n// VERSION CHECKING\n// =============================================================================\n\n/**\n * Get current and latest version info\n */\nasync function getVersionInfo(canary = false): Promise<VersionInfo> {\n\t// Get current version from package.json\n\tlet current = \"0.0.0\";\n\ttry {\n\t\tconst pkgPath = join(__dirname, \"../../package.json\");\n\t\tconst pkg = JSON.parse(await readFile(pkgPath, \"utf-8\"));\n\t\tcurrent = pkg.version;\n\t} catch {\n\t\t// Try alternative path\n\t\ttry {\n\t\t\tconst altPkgPath = join(__dirname, \"../../../package.json\");\n\t\t\tconst pkg = JSON.parse(await readFile(altPkgPath, \"utf-8\"));\n\t\t\tcurrent = pkg.version;\n\t\t} catch {\n\t\t\t// Fallback to npm view\n\t\t\ttry {\n\t\t\t\tconst { stdout } = await execAsync(`npm view ${PACKAGE_NAME} version`);\n\t\t\t\tcurrent = stdout.trim();\n\t\t\t} catch {\n\t\t\t\t// Keep default\n\t\t\t}\n\t\t}\n\t}\n\n\t// Get latest version from npm registry\n\tlet latest = current;\n\ttry {\n\t\tconst tag = canary ? \"canary\" : \"latest\";\n\t\tconst response = await fetch(`${NPM_REGISTRY}/${PACKAGE_NAME}/${tag}`);\n\n\t\tif (response.ok) {\n\t\t\tconst data = (await response.json()) as { version: string };\n\t\t\tlatest = data.version;\n\t\t} else {\n\t\t\t// Fallback to npm view\n\t\t\tconst { stdout } = await execAsync(`npm view ${PACKAGE_NAME}${canary ? \"@canary\" : \"\"} version`);\n\t\t\tlatest = stdout.trim();\n\t\t}\n\t} catch {\n\t\t// Keep current as latest (can't check)\n\t}\n\n\treturn {\n\t\tcurrent,\n\t\tlatest,\n\t\tupdateAvailable: compareVersions(latest, current) > 0,\n\t};\n}\n\n/**\n * Compare two semantic versions\n * Returns: 1 if a > b, -1 if a < b, 0 if equal\n */\nfunction compareVersions(a: string, b: string): number {\n\tconst partsA = a.replace(/^v/, \"\").split(\".\").map(Number);\n\tconst partsB = b.replace(/^v/, \"\").split(\".\").map(Number);\n\n\tfor (let i = 0; i < 3; i++) {\n\t\tconst partA = partsA[i] || 0;\n\t\tconst partB = partsB[i] || 0;\n\n\t\tif (partA > partB) return 1;\n\t\tif (partA < partB) return -1;\n\t}\n\n\treturn 0;\n}\n\n// =============================================================================\n// UPGRADE EXECUTION\n// =============================================================================\n\n/**\n * Perform the upgrade\n */\nasync function performUpgrade(canary = false): Promise<void> {\n\tconst spinner = ora(\"Installing update...\").start();\n\n\ttry {\n\t\t// Detect package manager\n\t\tconst packageManager = await detectPackageManager();\n\n\t\t// Build install command\n\t\tconst tag = canary ? \"canary\" : \"latest\";\n\t\tlet command: string;\n\n\t\tswitch (packageManager) {\n\t\t\tcase \"pnpm\":\n\t\t\t\tcommand = `pnpm add -g ${PACKAGE_NAME}@${tag}`;\n\t\t\t\tbreak;\n\t\t\tcase \"yarn\":\n\t\t\t\tcommand = `yarn global add ${PACKAGE_NAME}@${tag}`;\n\t\t\t\tbreak;\n\t\t\tcase \"bun\":\n\t\t\t\tcommand = `bun add -g ${PACKAGE_NAME}@${tag}`;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tcommand = `npm install -g ${PACKAGE_NAME}@${tag}`;\n\t\t}\n\n\t\tspinner.text = `Running: ${command}`;\n\n\t\tconst { stderr } = await execAsync(command);\n\n\t\t// Check for errors in stderr (npm sometimes outputs warnings there)\n\t\tif (stderr && stderr.includes(\"ERR!\")) {\n\t\t\tthrow new Error(stderr);\n\t\t}\n\n\t\tspinner.succeed(\"Update installed\");\n\t} catch (error) {\n\t\tspinner.fail(\"Installation failed\");\n\t\tthrow error;\n\t}\n}\n\n/**\n * Detect which package manager was used to install the CLI\n */\nasync function detectPackageManager(): Promise<\"npm\" | \"pnpm\" | \"yarn\" | \"bun\"> {\n\t// Check for pnpm\n\ttry {\n\t\tawait execAsync(\"pnpm --version\");\n\t\tconst { stdout } = await execAsync(\"pnpm list -g @snapback/cli 2>/dev/null || true\");\n\t\tif (stdout.includes(\"@snapback/cli\")) {\n\t\t\treturn \"pnpm\";\n\t\t}\n\t} catch {\n\t\t// Not pnpm\n\t}\n\n\t// Check for yarn\n\ttry {\n\t\tawait execAsync(\"yarn --version\");\n\t\tconst { stdout } = await execAsync(\"yarn global list 2>/dev/null || true\");\n\t\tif (stdout.includes(\"@snapback/cli\")) {\n\t\t\treturn \"yarn\";\n\t\t}\n\t} catch {\n\t\t// Not yarn\n\t}\n\n\t// Check for bun\n\ttry {\n\t\tawait execAsync(\"bun --version\");\n\t\treturn \"bun\"; // Assume bun if available\n\t} catch {\n\t\t// Not bun\n\t}\n\n\t// Default to npm\n\treturn \"npm\";\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { getVersionInfo, compareVersions, type VersionInfo };\n","/**\n * Terminal Hyperlinks Module\n *\n * Add clickable links to terminal output.\n * Supports terminals that implement the OSC 8 hyperlink escape sequence.\n *\n * @see https://gist.github.com/egmontkob/eb114294efbcd5adb1944c9f3cb5feda\n * @module ui/links\n */\n\nimport chalk from \"chalk\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface TerminalLinkOptions {\n\tfallback?: boolean;\n}\n\n// =============================================================================\n// TERMINAL DETECTION\n// =============================================================================\n\n/**\n * Check if terminal supports hyperlinks (OSC 8)\n */\nexport function supportsHyperlinks(): boolean {\n\t// Check environment variables\n\tconst forceHyperlinks = process.env.FORCE_HYPERLINK;\n\tif (forceHyperlinks === \"0\") return false;\n\tif (forceHyperlinks === \"1\") return true;\n\n\t// Check for known supported terminals\n\tconst { TERM_PROGRAM, VTE_VERSION, COLORTERM, CI } = process.env;\n\n\t// CI environments typically don't support hyperlinks\n\tif (CI) return false;\n\n\t// iTerm2 3.1+\n\tif (TERM_PROGRAM === \"iTerm.app\") return true;\n\n\t// VTE-based terminals (GNOME Terminal, Tilix, etc.) version 0.50+\n\tif (VTE_VERSION) {\n\t\tconst version = Number.parseInt(VTE_VERSION, 10);\n\t\tif (version >= 5000) return true;\n\t}\n\n\t// Windows Terminal\n\tif (process.env.WT_SESSION) return true;\n\n\t// VSCode integrated terminal\n\tif (TERM_PROGRAM === \"vscode\") return true;\n\n\t// Kitty\n\tif (process.env.KITTY_WINDOW_ID) return true;\n\n\t// Hyper\n\tif (COLORTERM === \"truecolor\" && TERM_PROGRAM === \"Hyper\") return true;\n\n\t// Alacritty\n\tif (TERM_PROGRAM === \"Alacritty\") return true;\n\n\t// WezTerm\n\tif (process.env.WEZTERM_PANE) return true;\n\n\treturn false;\n}\n\n// =============================================================================\n// HYPERLINK CREATION\n// =============================================================================\n\n/**\n * Create a clickable terminal hyperlink\n */\nexport function link(text: string, url: string, options: TerminalLinkOptions = {}): string {\n\tconst { fallback = true } = options;\n\n\tif (supportsHyperlinks()) {\n\t\t// OSC 8 hyperlink sequence: \\x1B]8;;URL\\x07TEXT\\x1B]8;;\\x07\n\t\treturn `\\u001B]8;;${url}\\u0007${text}\\u001B]8;;\\u0007`;\n\t}\n\n\tif (fallback) {\n\t\t// Fallback: show text with URL in parentheses\n\t\treturn `${text} (${chalk.gray(url)})`;\n\t}\n\n\treturn text;\n}\n\n/**\n * Create a file:// link that opens in editor\n */\nexport function fileLink(filePath: string, line?: number): string {\n\tconst displayPath = filePath.replace(process.cwd(), \".\");\n\tlet url = `file://${filePath}`;\n\n\tif (line !== undefined) {\n\t\turl += `:${line}`;\n\t}\n\n\treturn link(displayPath, url);\n}\n\n/**\n * Create a SnapBack documentation link\n */\nexport function docsLink(path: string, text?: string): string {\n\tconst url = `https://docs.snapback.dev/${path}`;\n\treturn link(text || path, url);\n}\n\n/**\n * Create a GitHub issue link\n */\nexport function issueLink(issueNumber: number): string {\n\tconst url = `https://github.com/snapback-dev/snapback/issues/${issueNumber}`;\n\treturn link(`#${issueNumber}`, url);\n}\n\n/**\n * Create a command link (for suggestion output)\n */\nexport function commandLink(command: string): string {\n\t// Some terminals support running commands via hyperlinks\n\t// For now, just style it distinctively\n\treturn chalk.cyan(`$ ${command}`);\n}\n\n// =============================================================================\n// STYLED OUTPUT HELPERS\n// =============================================================================\n\n/**\n * Output a row with a label and linked value\n */\nexport function labeledLink(label: string, text: string, url: string): string {\n\treturn `${chalk.gray(label)}: ${link(text, url)}`;\n}\n\n/**\n * Create a \"Learn more\" link\n */\nexport function learnMore(url: string): string {\n\treturn chalk.gray(`Learn more: ${link(url, url)}`);\n}\n\n/**\n * Create a \"Report issue\" link\n */\nexport function reportIssue(): string {\n\tconst url = \"https://github.com/snapback-dev/snapback/issues/new\";\n\treturn chalk.gray(`If this persists, ${link(\"report an issue\", url)}`);\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport const hyperlink = {\n\tcreate: link,\n\tfile: fileLink,\n\tdocs: docsLink,\n\tissue: issueLink,\n\tcommand: commandLink,\n\tlabeled: labeledLink,\n\tlearnMore,\n\treportIssue,\n\tsupportsHyperlinks,\n};\n","/**\n * CLI Branding & Logo\n *\n * ASCII art logo and branding utilities for the SnapBack CLI.\n * Used for first-time experience and welcome screens.\n *\n * @see cli_ui_imp.md for design spec\n * @module ui/logo\n */\n\nimport chalk from \"chalk\";\n\n// =============================================================================\n// ASCII LOGO\n// =============================================================================\n\n/**\n * SnapBack ASCII art logo (large)\n */\nexport const LOGO_LARGE = `\n            \n   \n      \n      \n            \n               `;\n\n/**\n * SnapBack ASCII art logo (compact)\n */\nexport const LOGO_COMPACT = `\n ____                   ____             _\n/ ___| _ __   __ _ _ __|  _ \\\\ __ _  ___| | __\n\\\\___ \\\\| '_ \\\\ / _\\` | '_ \\\\ |_) / _\\` |/ __| |/ /\n ___) | | | | (_| | |_) |  _ < (_| | (__|   <\n|____/|_| |_|\\\\__,_| .__/|_| \\\\_\\\\__,_|\\\\___|_|\\\\_\\\\\n                  |_|`;\n\n/**\n * Minimal logo for narrow terminals\n */\nexport const LOGO_MINIMAL = `\n \n  \n     `;\n\n// =============================================================================\n// BRANDING FUNCTIONS\n// =============================================================================\n\n/**\n * Get the appropriate logo based on terminal width\n */\nexport function getLogo(terminalWidth?: number): string {\n\tconst width = terminalWidth ?? process.stdout.columns ?? 80;\n\n\tif (width >= 72) {\n\t\treturn LOGO_LARGE;\n\t}\n\tif (width >= 50) {\n\t\treturn LOGO_COMPACT;\n\t}\n\treturn LOGO_MINIMAL;\n}\n\n/**\n * Display the branded header with logo and tagline\n */\nexport function displayBrandedHeader(\n\toptions: { version?: string; showTagline?: boolean; color?: boolean } = {},\n): string {\n\tconst { version, showTagline = true, color = true } = options;\n\n\tconst logo = getLogo();\n\tconst coloredLogo = color ? chalk.cyan(logo) : logo;\n\n\tconst lines: string[] = [coloredLogo];\n\n\tif (showTagline) {\n\t\tlines.push(\"\");\n\t\tlines.push(\n\t\t\tcolor\n\t\t\t\t? `    ${chalk.yellow(\"\")}  ${chalk.bold(\"Code Protection for AI-Native Development\")}`\n\t\t\t\t: \"      Code Protection for AI-Native Development\",\n\t\t);\n\t}\n\n\tif (version) {\n\t\tlines.push(color ? chalk.gray(`    v${version}`) : `    v${version}`);\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n\n/**\n * Display a welcome message for first-time users\n */\nexport function displayWelcomeMessage(): string {\n\tconst logo = displayBrandedHeader({ showTagline: true });\n\n\tconst message = `\n${logo}\n\n${chalk.bold(\"Welcome to SnapBack!\")}\n\nSnapBack protects your code from AI coding assistant mistakes.\nWhen things go wrong, restore in seconds.\n\n${chalk.cyan(\"Quick Start:\")}\n  ${chalk.gray(\"1.\")} ${chalk.cyan(\"snap login\")}      ${chalk.gray(\"Connect your account\")}\n  ${chalk.gray(\"2.\")} ${chalk.cyan(\"snap init\")}       ${chalk.gray(\"Initialize workspace\")}\n  ${chalk.gray(\"3.\")} ${chalk.cyan(\"snap tools configure\")} ${chalk.gray(\"Set up AI tools\")}\n\n${chalk.dim(\"Learn more: https://snapback.dev/docs\")}\n`;\n\n\treturn message;\n}\n\n/**\n * Display a compact status header\n */\nexport function displayStatusHeader(\n\toptions: { user?: string; tier?: \"free\" | \"pro\"; pioneerNumber?: number } = {},\n): string {\n\tconst { user, tier, pioneerNumber } = options;\n\n\tconst parts: string[] = [];\n\n\tif (user) {\n\t\tparts.push(chalk.cyan(`@${user}`));\n\t}\n\n\tif (pioneerNumber) {\n\t\tparts.push(chalk.yellow(`Pioneer #${pioneerNumber.toLocaleString()}`));\n\t}\n\n\tif (tier) {\n\t\tparts.push(tier === \"pro\" ? chalk.magenta(\"Pro \") : chalk.gray(\"Free\"));\n\t}\n\n\tif (parts.length === 0) {\n\t\treturn \"\";\n\t}\n\n\treturn parts.join(chalk.gray(\"  \"));\n}\n\n/**\n * Display a divider line\n */\nexport function displayDivider(width?: number, char = \"\"): string {\n\tconst w = width ?? Math.min(process.stdout.columns ?? 60, 60);\n\treturn chalk.gray(char.repeat(w));\n}\n\n/**\n * Display a section header\n */\nexport function displaySectionHeader(title: string): string {\n\treturn `\\n${chalk.cyan.bold(title)}\\n${displayDivider(title.length + 4)}`;\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { LOGO_LARGE as logoLarge, LOGO_COMPACT as logoCompact, LOGO_MINIMAL as logoMinimal };\n","/**\n * First-Run Wizard\n *\n * Interactive onboarding for new SnapBack users.\n * Inspired by: Vercel CLI, GitHub CLI, Stripe CLI\n *\n * Features:\n * - Branded welcome screen\n * - Guided authentication\n * - Workspace detection\n * - Smart defaults based on project type\n * - Progress indicators\n *\n * @module commands/wizard\n */\n\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport { hyperlink } from \"../ui/links\";\nimport { displayBrandedHeader } from \"../ui/logo\";\nimport { prompts, status } from \"../ui/prompts\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\ninterface WizardState {\n\tauthenticated: boolean;\n\tworkspaceRoot: string | null;\n\tprojectType: ProjectType | null;\n\tprotectionLevel: \"standard\" | \"strict\";\n\tmcpEnabled: boolean;\n\tanalyticsEnabled: boolean;\n\t// New fields for enhanced onboarding\n\tfilesProtected: boolean;\n\tgitHookInstalled: boolean;\n\tsnapshotCreated: boolean;\n}\n\ntype ProjectType = \"nodejs\" | \"typescript\" | \"python\" | \"rust\" | \"go\" | \"unknown\";\n\ninterface ProjectDetection {\n\ttype: ProjectType;\n\tconfidence: number;\n\tindicators: string[];\n}\n\n// =============================================================================\n// PROJECT DETECTION\n// =============================================================================\n\n/**\n * Detect project type from files in the current directory\n */\nfunction detectProjectType(cwd: string): ProjectDetection {\n\tconst indicators: string[] = [];\n\tlet type: ProjectType = \"unknown\";\n\tlet confidence = 0;\n\n\tconst files = fs.readdirSync(cwd).map((f) => f.toLowerCase());\n\n\t// TypeScript (check first since it may also have package.json)\n\tif (files.includes(\"tsconfig.json\")) {\n\t\ttype = \"typescript\";\n\t\tconfidence += 90;\n\t\tindicators.push(\"tsconfig.json found\");\n\t} else if (files.some((f) => f.endsWith(\".ts\") || f.endsWith(\".tsx\"))) {\n\t\ttype = \"typescript\";\n\t\tconfidence += 60;\n\t\tindicators.push(\".ts/.tsx files found\");\n\t}\n\n\t// Node.js\n\tif (files.includes(\"package.json\")) {\n\t\tif (type === \"unknown\") {\n\t\t\ttype = \"nodejs\";\n\t\t}\n\t\tconfidence += 30;\n\t\tindicators.push(\"package.json found\");\n\t}\n\n\t// Python\n\tif (files.includes(\"pyproject.toml\") || files.includes(\"requirements.txt\")) {\n\t\ttype = \"python\";\n\t\tconfidence = 80;\n\t\tindicators.push(\"Python project files found\");\n\t} else if (files.some((f) => f.endsWith(\".py\"))) {\n\t\tif (type === \"unknown\") {\n\t\t\ttype = \"python\";\n\t\t\tconfidence = 50;\n\t\t}\n\t\tindicators.push(\".py files found\");\n\t}\n\n\t// Rust\n\tif (files.includes(\"cargo.toml\")) {\n\t\ttype = \"rust\";\n\t\tconfidence = 95;\n\t\tindicators.push(\"Cargo.toml found\");\n\t}\n\n\t// Go\n\tif (files.includes(\"go.mod\")) {\n\t\ttype = \"go\";\n\t\tconfidence = 95;\n\t\tindicators.push(\"go.mod found\");\n\t}\n\n\treturn { type, confidence, indicators };\n}\n\n/**\n * Check if user is authenticated\n */\nasync function checkAuthentication(): Promise<boolean> {\n\tconst homeDir = process.env.HOME || process.env.USERPROFILE || \"\";\n\tconst tokenPath = path.join(homeDir, \".snapback\", \"token.json\");\n\n\ttry {\n\t\tif (fs.existsSync(tokenPath)) {\n\t\t\tconst data = JSON.parse(fs.readFileSync(tokenPath, \"utf-8\"));\n\t\t\treturn Boolean(data.token);\n\t\t}\n\t} catch {\n\t\t// Ignore errors\n\t}\n\n\treturn false;\n}\n\n/**\n * Check if workspace is initialized\n */\nfunction isWorkspaceInitialized(cwd: string): boolean {\n\tconst snapbackDir = path.join(cwd, \".snapback\");\n\treturn fs.existsSync(snapbackDir);\n}\n\n// =============================================================================\n// WIZARD STEPS\n// =============================================================================\n\n/**\n * Step 1: Welcome screen with branding\n */\nasync function welcomeStep(): Promise<void> {\n\tconsole.clear();\n\tconsole.log(displayBrandedHeader({ showTagline: true }));\n\n\tconsole.log(chalk.cyan.bold(\"\\n  Welcome to SnapBack! \\n\"));\n\tconsole.log(chalk.white(\"  The AI-native code protection tool that helps you\"));\n\tconsole.log(chalk.white(\"  work confidently with AI coding assistants.\\n\"));\n\n\tconsole.log(chalk.gray(\"  This wizard will help you:\"));\n\tconsole.log(chalk.gray(\"   Connect your account\"));\n\tconsole.log(chalk.gray(\"   Set up your workspace\"));\n\tconsole.log(chalk.gray(\"   Configure AI tool integration\\n\"));\n\n\tconst proceed = await prompts.confirm({\n\t\tmessage: \"Ready to get started?\",\n\t\tdefault: true,\n\t});\n\n\tif (!proceed) {\n\t\tconsole.log(chalk.gray(\"\\nNo problem! Run 'snap init' anytime to start over.\\n\"));\n\t\tprocess.exit(0);\n\t}\n}\n\n/**\n * Step 2: Authentication\n */\nasync function authenticationStep(state: WizardState): Promise<WizardState> {\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 1: Authentication\\n\"));\n\n\tif (state.authenticated) {\n\t\tstatus.success(\"Already authenticated\");\n\t\treturn state;\n\t}\n\n\tconsole.log(chalk.white(\"  SnapBack needs to connect to your account for:\"));\n\tconsole.log(chalk.gray(\"   Syncing snapshots across devices\"));\n\tconsole.log(chalk.gray(\"   Enabling team collaboration\"));\n\tconsole.log(chalk.gray(\"   Accessing premium features\\n\"));\n\n\tconst authMethod = await prompts.select({\n\t\tmessage: \"How would you like to authenticate?\",\n\t\toptions: [\n\t\t\t{ label: \"Browser login (recommended)\", value: \"browser\", hint: \"Opens snapback.dev\" },\n\t\t\t{ label: \"API key\", value: \"api-key\", hint: \"For CI/CD and automation\" },\n\t\t\t{ label: \"Skip for now\", value: \"skip\", hint: \"Limited functionality\" },\n\t\t],\n\t\tdefault: \"browser\",\n\t});\n\n\tif (authMethod === \"skip\") {\n\t\tstatus.warning(\"Skipping authentication - some features will be limited\");\n\t\treturn { ...state, authenticated: false };\n\t}\n\n\tif (authMethod === \"browser\") {\n\t\tconsole.log(chalk.gray(\"\\n  Opening browser for authentication...\"));\n\t\t// In real implementation: open browser and wait for callback\n\t\tconsole.log(\n\t\t\tchalk.cyan(\"   \" + hyperlink.create(\"Click here to authenticate\", \"https://snapback.dev/auth/cli\")),\n\t\t);\n\t\tconsole.log();\n\n\t\tconst confirmed = await prompts.confirm({\n\t\t\tmessage: \"Did you complete authentication in the browser?\",\n\t\t\tdefault: true,\n\t\t});\n\n\t\tif (confirmed) {\n\t\t\tstatus.success(\"Authenticated successfully!\");\n\t\t\treturn { ...state, authenticated: true };\n\t\t}\n\t}\n\n\tif (authMethod === \"api-key\") {\n\t\tconst apiKey = await prompts.input(\"Enter your API key\", {\n\t\t\tvalidate: (value) => {\n\t\t\t\tif (!value.startsWith(\"snap_\")) {\n\t\t\t\t\treturn \"API key should start with 'snap_'\";\n\t\t\t\t}\n\t\t\t\tif (value.length < 20) {\n\t\t\t\t\treturn \"API key seems too short\";\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t},\n\t\t});\n\n\t\tif (apiKey) {\n\t\t\tstatus.success(\"API key validated and stored\");\n\t\t\treturn { ...state, authenticated: true };\n\t\t}\n\t}\n\n\treturn { ...state, authenticated: false };\n}\n\n/**\n * Step 3: Workspace setup\n */\nasync function workspaceStep(state: WizardState): Promise<WizardState> {\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 2: Workspace Setup\\n\"));\n\n\tconst cwd = process.cwd();\n\n\t// Detect project type\n\tconst detection = detectProjectType(cwd);\n\tconst projectName = path.basename(cwd);\n\n\tif (detection.type !== \"unknown\") {\n\t\tconsole.log(chalk.white(`  Detected project: ${chalk.cyan(projectName)}`));\n\t\tconsole.log(chalk.gray(`  Type: ${detection.type} (${detection.confidence}% confidence)`));\n\t\tconsole.log(chalk.gray(`  Indicators: ${detection.indicators.join(\", \")}\\n`));\n\t} else {\n\t\tconsole.log(chalk.white(`  Project: ${chalk.cyan(projectName)}`));\n\t\tconsole.log(chalk.gray(\"  Type: Could not auto-detect\\n\"));\n\t}\n\n\t// Check if already initialized and if config is valid\n\tif (isWorkspaceInitialized(cwd)) {\n\t\tconst configPath = path.join(cwd, \".snapback\", \"config.json\");\n\t\tlet isConfigCorrupted = false;\n\n\t\tif (!fs.existsSync(configPath)) {\n\t\t\tisConfigCorrupted = true;\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tJSON.parse(fs.readFileSync(configPath, \"utf-8\"));\n\t\t\t} catch {\n\t\t\t\tisConfigCorrupted = true;\n\t\t\t}\n\t\t}\n\n\t\tif (isConfigCorrupted) {\n\t\t\tstatus.warning(\"Detected a corrupted SnapBack configuration\");\n\t\t\tconst repair = await prompts.confirm({\n\t\t\t\tmessage: \"Would you like to repair (re-initialize) the workspace?\",\n\t\t\t\tdefault: true,\n\t\t\t});\n\n\t\t\tif (repair) {\n\t\t\t\t// Proceed to re-initialization\n\t\t\t} else {\n\t\t\t\treturn {\n\t\t\t\t\t...state,\n\t\t\t\t\tworkspaceRoot: cwd,\n\t\t\t\t\tprojectType: detection.type,\n\t\t\t\t};\n\t\t\t}\n\t\t} else {\n\t\t\tstatus.success(\"Workspace already initialized and healthy\");\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tworkspaceRoot: cwd,\n\t\t\t\tprojectType: detection.type,\n\t\t\t};\n\t\t}\n\t}\n\n\tconst proceed = await prompts.confirm({\n\t\tmessage: `Initialize SnapBack in ${chalk.cyan(cwd)}?`,\n\t\tdefault: true,\n\t});\n\n\tif (!proceed) {\n\t\treturn { ...state, workspaceRoot: null, projectType: detection.type };\n\t}\n\n\t// Create .snapback directory\n\tconst snapbackDir = path.join(cwd, \".snapback\");\n\tif (!fs.existsSync(snapbackDir)) {\n\t\tfs.mkdirSync(snapbackDir, { recursive: true });\n\t}\n\n\t// Create initial config\n\tconst config = {\n\t\tversion: 1,\n\t\tprojectType: detection.type,\n\t\tprotectionLevel: \"standard\",\n\t\tcreatedAt: new Date().toISOString(),\n\t};\n\n\tfs.writeFileSync(path.join(snapbackDir, \"config.json\"), JSON.stringify(config, null, 2));\n\n\tstatus.success(\"Workspace initialized successfully\");\n\n\treturn {\n\t\t...state,\n\t\tworkspaceRoot: cwd,\n\t\tprojectType: detection.type,\n\t};\n}\n\n/**\n * Step 4: Protection level\n */\nasync function protectionStep(state: WizardState): Promise<WizardState> {\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 3: Protection Level\\n\"));\n\n\tconsole.log(chalk.white(\"  Choose how SnapBack should protect your code:\\n\"));\n\n\tconst level = await prompts.select<\"standard\" | \"strict\">({\n\t\tmessage: \"Protection level\",\n\t\toptions: [\n\t\t\t{\n\t\t\t\tlabel: \"Standard\",\n\t\t\t\tvalue: \"standard\",\n\t\t\t\thint: \"Auto-snapshot before AI edits, warnings on risky changes\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tlabel: \"Strict\",\n\t\t\t\tvalue: \"strict\",\n\t\t\t\thint: \"Confirmation required before AI edits, block high-risk changes\",\n\t\t\t},\n\t\t],\n\t\tdefault: \"standard\",\n\t});\n\n\tconst protectionLevel = level || \"standard\";\n\n\tconsole.log();\n\tif (protectionLevel === \"standard\") {\n\t\tstatus.info(\"Standard protection: AI edits proceed with auto-snapshots\");\n\t} else {\n\t\tstatus.info(\"Strict protection: You'll be prompted before risky AI edits\");\n\t}\n\n\treturn { ...state, protectionLevel };\n}\n\n/**\n * Step 5: AI tool integration\n */\nasync function mcpStep(state: WizardState): Promise<WizardState> {\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 4: AI Tool Integration\\n\"));\n\n\t// Import mcp-config for detection and configuration\n\tlet detectAIClients: typeof import(\"@snapback/mcp-config\").detectAIClients;\n\tlet getSnapbackMCPConfig: typeof import(\"@snapback/mcp-config\").getSnapbackMCPConfig;\n\tlet writeClientConfig: typeof import(\"@snapback/mcp-config\").writeClientConfig;\n\n\ttry {\n\t\tconst mcpConfig = await import(\"@snapback/mcp-config\");\n\t\tdetectAIClients = mcpConfig.detectAIClients;\n\t\tgetSnapbackMCPConfig = mcpConfig.getSnapbackMCPConfig;\n\t\twriteClientConfig = mcpConfig.writeClientConfig;\n\t} catch {\n\t\t// Fallback if mcp-config not available\n\t\tconsole.log(chalk.white(\"  SnapBack integrates with AI coding tools via MCP:\"));\n\t\tconsole.log(chalk.gray(\"   Cursor, Windsurf, Claude Desktop, VS Code, and more\"));\n\t\tconsole.log(chalk.gray(\"   Provides context about protected files\"));\n\t\tconsole.log(chalk.gray(\"   Enables smart validation of AI suggestions\\n\"));\n\n\t\tconst enableMcp = await prompts.confirm({\n\t\t\tmessage: \"Enable MCP integration for AI tools?\",\n\t\t\tdefault: true,\n\t\t});\n\n\t\tif (enableMcp) {\n\t\t\tstatus.success(\"MCP integration enabled\");\n\t\t\tconsole.log(chalk.gray(\"  Run 'snap tools configure' to set up specific tools\"));\n\t\t} else {\n\t\t\tstatus.info(\"MCP integration skipped - you can enable it later\");\n\t\t}\n\n\t\treturn { ...state, mcpEnabled: enableMcp };\n\t}\n\n\t// Auto-detect installed AI clients\n\tconst detection = detectAIClients({ cwd: state.workspaceRoot || process.cwd() });\n\n\tif (detection.detected.length === 0) {\n\t\tconsole.log(chalk.yellow(\"  No AI tools detected on your system.\"));\n\t\tconsole.log(chalk.gray(\"  Install one of these to use SnapBack MCP:\"));\n\t\tconsole.log(chalk.gray(\"   Claude Desktop - https://claude.ai/download\"));\n\t\tconsole.log(chalk.gray(\"   Cursor - https://cursor.sh\"));\n\t\tconsole.log(chalk.gray(\"   VS Code - https://code.visualstudio.com\"));\n\t\tconsole.log(chalk.gray(\"   Windsurf - https://codeium.com/windsurf\"));\n\t\treturn { ...state, mcpEnabled: false };\n\t}\n\n\t// Show detected tools\n\tconsole.log(chalk.white(`  Found ${detection.detected.length} AI tool(s):\\n`));\n\tfor (const client of detection.detected) {\n\t\tconst statusIcon = client.hasSnapback ? chalk.green(\"\") : chalk.yellow(\"\");\n\t\tconst statusText = client.hasSnapback ? chalk.gray(\"(configured)\") : chalk.yellow(\"(needs setup)\");\n\t\tconsole.log(`    ${statusIcon} ${client.displayName} ${statusText}`);\n\t}\n\tconsole.log();\n\n\t// Check if any need setup\n\tif (detection.needsSetup.length === 0) {\n\t\tstatus.success(\"All detected AI tools already have SnapBack configured!\");\n\t\treturn { ...state, mcpEnabled: true };\n\t}\n\n\t// Ask to configure\n\tconst clientNames = detection.needsSetup.map((c) => c.displayName).join(\", \");\n\tconst enableMcp = await prompts.confirm({\n\t\tmessage: `Configure SnapBack for ${clientNames}?`,\n\t\tdefault: true,\n\t});\n\n\tif (enableMcp) {\n\t\t// Actually configure each client\n\t\tconst mcpConfig = getSnapbackMCPConfig({\n\t\t\tworkspaceRoot: state.workspaceRoot || undefined,\n\t\t});\n\n\t\tfor (const client of detection.needsSetup) {\n\t\t\tprocess.stdout.write(chalk.gray(`    Configuring ${client.displayName}...`));\n\t\t\tconst result = writeClientConfig(client, mcpConfig);\n\t\t\tif (result.success) {\n\t\t\t\tconsole.log(chalk.green(\" \"));\n\t\t\t} else {\n\t\t\t\tconsole.log(chalk.red(`  ${result.error}`));\n\t\t\t}\n\t\t}\n\n\t\tconsole.log();\n\t\tstatus.success(\"MCP integration configured!\");\n\t\tconsole.log(chalk.gray(\"  Restart your AI tools to activate SnapBack.\"));\n\t} else {\n\t\tstatus.info(\"MCP integration skipped - run 'snap tools configure' later\");\n\t}\n\n\treturn { ...state, mcpEnabled: enableMcp };\n}\n\n/**\n * Step 6: File Protection\n */\nasync function fileProtectionStep(state: WizardState): Promise<WizardState> {\n\tif (!state.workspaceRoot) {\n\t\treturn { ...state, filesProtected: false };\n\t}\n\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 5: File Protection\\n\"));\n\n\tconsole.log(chalk.white(\"  Protect sensitive files from AI modifications:\"));\n\tconsole.log(chalk.gray(\"   Environment files (.env, .env.*)\"));\n\tconsole.log(chalk.gray(\"   Config files (tsconfig.json, package.json, etc.)\"));\n\tconsole.log(chalk.gray(\"   Lock files (package-lock.json, pnpm-lock.yaml)\\n\"));\n\n\tconst protect = await prompts.confirm({\n\t\tmessage: \"Protect common sensitive files?\",\n\t\tdefault: true,\n\t});\n\n\tif (!protect) {\n\t\tstatus.info(\"File protection skipped\");\n\t\treturn { ...state, filesProtected: false };\n\t}\n\n\ttry {\n\t\t// Import and use the protect functions\n\t\tconst { getProtectedFiles, saveProtectedFiles } = await import(\"../services/snapback-dir\");\n\n\t\tconst protectedFiles = await getProtectedFiles(state.workspaceRoot);\n\t\tlet added = 0;\n\n\t\t// Environment files\n\t\tconst envPatterns = [\".env\", \".env.*\", \"*.env\"];\n\t\tfor (const pattern of envPatterns) {\n\t\t\tif (!protectedFiles.some((f) => f.pattern === pattern)) {\n\t\t\t\tprotectedFiles.push({\n\t\t\t\t\tpattern,\n\t\t\t\t\taddedAt: new Date().toISOString(),\n\t\t\t\t\treason: \"Environment variables\",\n\t\t\t\t});\n\t\t\t\tadded++;\n\t\t\t}\n\t\t}\n\n\t\t// Config files\n\t\tconst configPatterns = [\n\t\t\t\"*.config.js\",\n\t\t\t\"*.config.ts\",\n\t\t\t\"*.config.mjs\",\n\t\t\t\"tsconfig.json\",\n\t\t\t\"package.json\",\n\t\t\t\"pnpm-lock.yaml\",\n\t\t\t\"yarn.lock\",\n\t\t\t\"package-lock.json\",\n\t\t];\n\t\tfor (const pattern of configPatterns) {\n\t\t\tif (!protectedFiles.some((f) => f.pattern === pattern)) {\n\t\t\t\tprotectedFiles.push({\n\t\t\t\t\tpattern,\n\t\t\t\t\taddedAt: new Date().toISOString(),\n\t\t\t\t\treason: \"Configuration file\",\n\t\t\t\t});\n\t\t\t\tadded++;\n\t\t\t}\n\t\t}\n\n\t\tawait saveProtectedFiles(protectedFiles, state.workspaceRoot);\n\n\t\tif (added > 0) {\n\t\t\tstatus.success(`Protected ${added} file patterns`);\n\t\t} else {\n\t\t\tstatus.info(\"Files already protected\");\n\t\t}\n\n\t\treturn { ...state, filesProtected: true };\n\t} catch (error) {\n\t\tstatus.warning(\"Could not set up file protection\");\n\t\tconsole.log(chalk.gray(\"  Run 'snap protect env' later to protect files\"));\n\t\treturn { ...state, filesProtected: false };\n\t}\n}\n\n/**\n * Step 7: Git Hook Setup\n */\nasync function gitHookStep(state: WizardState): Promise<WizardState> {\n\tif (!state.workspaceRoot) {\n\t\treturn { ...state, gitHookInstalled: false };\n\t}\n\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 6: Git Integration\\n\"));\n\n\t// Check if it's a git repo\n\tconst gitDir = path.join(state.workspaceRoot, \".git\");\n\tif (!fs.existsSync(gitDir)) {\n\t\tconsole.log(chalk.gray(\"  Not a Git repository - skipping hook setup\"));\n\t\treturn { ...state, gitHookInstalled: false };\n\t}\n\n\tconsole.log(chalk.white(\"  Add SnapBack validation to your Git workflow:\"));\n\tconsole.log(chalk.gray(\"   Auto-check before commits\"));\n\tconsole.log(chalk.gray(\"   Prevent committing protected file changes\"));\n\tconsole.log(chalk.gray(\"   Optional - won't block your workflow\\n\"));\n\n\tconst installHook = await prompts.confirm({\n\t\tmessage: \"Install pre-commit hook?\",\n\t\tdefault: true,\n\t});\n\n\tif (!installHook) {\n\t\tstatus.info(\"Git hook skipped\");\n\t\treturn { ...state, gitHookInstalled: false };\n\t}\n\n\ttry {\n\t\tconst hooksDir = path.join(gitDir, \"hooks\");\n\t\tconst hookPath = path.join(hooksDir, \"pre-commit\");\n\n\t\t// Create hooks directory if it doesn't exist\n\t\tif (!fs.existsSync(hooksDir)) {\n\t\t\tfs.mkdirSync(hooksDir, { recursive: true });\n\t\t}\n\n\t\t// Check if hook already exists\n\t\tlet existingContent = \"\";\n\t\tif (fs.existsSync(hookPath)) {\n\t\t\texistingContent = fs.readFileSync(hookPath, \"utf-8\");\n\t\t\tif (existingContent.includes(\"snap\")) {\n\t\t\t\tstatus.info(\"SnapBack hook already installed\");\n\t\t\t\treturn { ...state, gitHookInstalled: true };\n\t\t\t}\n\t\t}\n\n\t\t// Add SnapBack check to hook\n\t\tconst snapbackHook = `\n# SnapBack pre-commit check\nif command -v snap &> /dev/null; then\n  snap check --quiet || {\n    echo \"SnapBack: Protected files may have changed. Run 'snap status' for details.\"\n  }\nfi\n`;\n\n\t\tif (existingContent) {\n\t\t\t// Append to existing hook\n\t\t\tfs.writeFileSync(hookPath, existingContent + \"\\n\" + snapbackHook);\n\t\t} else {\n\t\t\t// Create new hook\n\t\t\tfs.writeFileSync(hookPath, \"#!/bin/sh\\n\" + snapbackHook);\n\t\t}\n\n\t\t// Make executable\n\t\tfs.chmodSync(hookPath, 0o755);\n\n\t\tstatus.success(\"Pre-commit hook installed\");\n\t\treturn { ...state, gitHookInstalled: true };\n\t} catch (error) {\n\t\tstatus.warning(\"Could not install Git hook\");\n\t\tconsole.log(chalk.gray(\"  You can add 'snap check' to your hooks manually\"));\n\t\treturn { ...state, gitHookInstalled: false };\n\t}\n}\n\n/**\n * Step 8: Initial Snapshot\n */\nasync function snapshotStep(state: WizardState): Promise<WizardState> {\n\tif (!state.workspaceRoot) {\n\t\treturn { ...state, snapshotCreated: false };\n\t}\n\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 7: Initial Snapshot\\n\"));\n\n\tconsole.log(chalk.white(\"  Create a safety snapshot of your protected files:\"));\n\tconsole.log(chalk.gray(\"   Captures current state of critical files\"));\n\tconsole.log(chalk.gray(\"   Enables easy rollback if AI makes mistakes\"));\n\tconsole.log(chalk.gray(\"   Takes just a few seconds\\n\"));\n\n\tconst createSnapshot = await prompts.confirm({\n\t\tmessage: \"Create initial snapshot?\",\n\t\tdefault: true,\n\t});\n\n\tif (!createSnapshot) {\n\t\tstatus.info(\"Initial snapshot skipped\");\n\t\tconsole.log(chalk.gray(\"  Run 'snap snapshot create' when ready\"));\n\t\treturn { ...state, snapshotCreated: false };\n\t}\n\n\ttry {\n\t\t// We'll create a simple marker for now - full snapshot creation would require the engine\n\t\tconst snapshotDir = path.join(state.workspaceRoot, \".snapback\", \"snapshots\");\n\t\tfs.mkdirSync(snapshotDir, { recursive: true });\n\n\t\tconst manifest = {\n\t\t\tid: `wizard-${Date.now()}`,\n\t\t\tcreatedAt: new Date().toISOString(),\n\t\t\tdescription: \"Initial setup snapshot\",\n\t\t\tsource: \"wizard\",\n\t\t};\n\n\t\tfs.writeFileSync(path.join(snapshotDir, \"initial-manifest.json\"), JSON.stringify(manifest, null, 2));\n\n\t\tstatus.success(\"Initial snapshot created\");\n\t\tconsole.log(chalk.gray(\"  Use 'snap snapshot list' to view snapshots\"));\n\t\treturn { ...state, snapshotCreated: true };\n\t} catch (error) {\n\t\tstatus.warning(\"Could not create snapshot\");\n\t\tconsole.log(chalk.gray(\"  Run 'snap snapshot create' to create manually\"));\n\t\treturn { ...state, snapshotCreated: false };\n\t}\n}\n\n/**\n * Step 9: Analytics opt-in\n */\nasync function analyticsStep(state: WizardState): Promise<WizardState> {\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Step 8: Usage Analytics\\n\"));\n\n\tconsole.log(chalk.white(\"  Help us improve SnapBack by sharing anonymous usage data:\"));\n\tconsole.log(chalk.gray(\"   Command usage frequency\"));\n\tconsole.log(chalk.gray(\"   Error reports\"));\n\tconsole.log(chalk.gray(\"   No code, file names, or personal data\\n\"));\n\n\tconst enableAnalytics = await prompts.confirm({\n\t\tmessage: \"Enable anonymous analytics?\",\n\t\tdefault: true,\n\t});\n\n\tif (enableAnalytics) {\n\t\tstatus.success(\"Analytics enabled - thank you!\");\n\t} else {\n\t\tstatus.info(\"Analytics disabled - no data will be collected\");\n\t}\n\n\treturn { ...state, analyticsEnabled: enableAnalytics };\n}\n\n/**\n * Final step: Summary and next steps\n */\nasync function summaryStep(state: WizardState): Promise<void> {\n\tconsole.log(\"\\n\" + chalk.green.bold(\"Setup Complete! \\n\"));\n\n\tconsole.log(chalk.white(\"Configuration Summary:\"));\n\tconsole.log(chalk.gray(\"\".repeat(40)));\n\n\t// Authentication\n\tif (state.authenticated) {\n\t\tconsole.log(chalk.green(\"   \") + \"Authenticated\");\n\t} else {\n\t\tconsole.log(chalk.yellow(\"  ! \") + \"Not authenticated (limited features)\");\n\t}\n\n\t// Workspace\n\tif (state.workspaceRoot) {\n\t\tconsole.log(chalk.green(\"   \") + `Workspace: ${path.basename(state.workspaceRoot)}`);\n\t} else {\n\t\tconsole.log(chalk.yellow(\"  ! \") + \"No workspace configured\");\n\t}\n\n\t// Project type\n\tif (state.projectType && state.projectType !== \"unknown\") {\n\t\tconsole.log(chalk.green(\"   \") + `Project type: ${state.projectType}`);\n\t}\n\n\t// Protection level\n\tconsole.log(chalk.green(\"   \") + `Protection: ${state.protectionLevel}`);\n\n\t// MCP\n\tif (state.mcpEnabled) {\n\t\tconsole.log(chalk.green(\"   \") + \"MCP integration enabled\");\n\t}\n\n\t// File protection\n\tif (state.filesProtected) {\n\t\tconsole.log(chalk.green(\"   \") + \"Critical files protected\");\n\t}\n\n\t// Git hook\n\tif (state.gitHookInstalled) {\n\t\tconsole.log(chalk.green(\"   \") + \"Pre-commit hook installed\");\n\t}\n\n\t// Initial snapshot\n\tif (state.snapshotCreated) {\n\t\tconsole.log(chalk.green(\"   \") + \"Initial snapshot created\");\n\t}\n\n\t// Analytics\n\tif (state.analyticsEnabled) {\n\t\tconsole.log(chalk.green(\"   \") + \"Anonymous analytics enabled\");\n\t}\n\n\tconsole.log(chalk.gray(\"\".repeat(40)));\n\n\t// Run quick doctor check\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Quick Health Check:\\n\"));\n\ttry {\n\t\tconst { detectAIClients } = await import(\"@snapback/mcp-config\");\n\t\tconst detection = detectAIClients({ cwd: state.workspaceRoot || process.cwd() });\n\t\tconst configured = detection.detected.filter((c) => c.hasSnapback);\n\t\tconst needsSetup = detection.needsSetup;\n\n\t\tif (configured.length > 0) {\n\t\t\tconsole.log(chalk.green(\"   \") + `${configured.length} AI tool(s) ready`);\n\t\t}\n\t\tif (needsSetup.length > 0) {\n\t\t\tconsole.log(chalk.yellow(\"  ! \") + `${needsSetup.length} tool(s) need MCP config`);\n\t\t}\n\t} catch {\n\t\t// Ignore if can't run doctor check\n\t}\n\n\t// Check for VS Code and suggest extension\n\ttry {\n\t\tconst { detectAIClients } = await import(\"@snapback/mcp-config\");\n\t\tconst detection = detectAIClients({ cwd: state.workspaceRoot || process.cwd() });\n\t\tconst hasVSCode = detection.clients.some((c) => c.name === \"vscode\" && c.exists);\n\n\t\tif (hasVSCode) {\n\t\t\tconsole.log();\n\t\t\tconsole.log(chalk.cyan(\"   VS Code detected!\"));\n\t\t\tconsole.log(chalk.gray(\"     Consider installing the SnapBack extension:\"));\n\t\t\tconsole.log(chalk.gray(\"     code --install-extension snapback.snapback-vscode\"));\n\t\t}\n\t} catch {\n\t\t// Ignore if check fails\n\t}\n\n\t// Next steps - smarter based on what's already done\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Next Steps:\\n\"));\n\n\tlet stepNum = 1;\n\n\tif (!state.snapshotCreated) {\n\t\tconsole.log(chalk.white(`  ${stepNum}. Create your first snapshot:`));\n\t\tconsole.log(chalk.cyan(\"     $ snap snapshot create\\n\"));\n\t\tstepNum++;\n\t}\n\n\tif (!state.filesProtected) {\n\t\tconsole.log(chalk.white(`  ${stepNum}. Protect important files:`));\n\t\tconsole.log(chalk.cyan(\"     $ snap protect src/core/\\n\"));\n\t\tstepNum++;\n\t}\n\n\tconsole.log(chalk.white(`  ${stepNum}. Check system health:`));\n\tconsole.log(chalk.cyan(\"     $ snap doctor\\n\"));\n\tstepNum++;\n\n\t// Upgrade prompt for free tier\n\tif (!state.authenticated) {\n\t\tconsole.log(chalk.gray(\"\".repeat(40)));\n\t\tconsole.log(\"\\n\" + chalk.yellow.bold(\"Upgrade to Pro:\\n\"));\n\t\tconsole.log(chalk.white(\"   Unlimited snapshots\"));\n\t\tconsole.log(chalk.white(\"   Team collaboration\"));\n\t\tconsole.log(chalk.white(\"   Priority support\"));\n\t\tconsole.log(\n\t\t\tchalk.cyan(\"   snap upgrade\") +\n\t\t\t\tchalk.gray(\" or visit \") +\n\t\t\t\thyperlink.create(\"snapback.dev/pro\", \"https://snapback.dev/pricing\"),\n\t\t);\n\t\tconsole.log();\n\t}\n\n\t// Documentation\n\tconsole.log(chalk.gray(\"  Documentation: \") + hyperlink.create(\"docs.snapback.dev\", \"https://docs.snapback.dev\"));\n\tconsole.log(chalk.gray(\"  Get help:      \") + chalk.cyan(\"snap --help\"));\n\tconsole.log();\n}\n\n/**\n * Step 9: Start First Session\n */\nasync function sessionStep(state: WizardState): Promise<void> {\n\tif (!state.workspaceRoot) return;\n\n\tconsole.log(\"\\n\" + chalk.cyan.bold(\"Final Step: Start Your First Session\\n\"));\n\n\tconsole.log(chalk.white(\"  Sessions help SnapBack track your current task:\"));\n\tconsole.log(chalk.gray(\"   Groups snapshots by objective\"));\n\tconsole.log(chalk.gray(\"   Automates snapshot descriptions\"));\n\tconsole.log(chalk.gray(\"   Provides better context for AI\\n\"));\n\n\tconst startSession = await prompts.confirm({\n\t\tmessage: \"Start a development session now?\",\n\t\tdefault: true,\n\t});\n\n\tif (startSession) {\n\t\tconst task = await prompts.input(\"What are you working on? (e.g. implementing user auth)\", {});\n\n\t\ttry {\n\t\t\tconst { generateId, saveCurrentSession } = await import(\"../services/snapback-dir\");\n\t\t\tconst newSession = {\n\t\t\t\tid: generateId(\"sess\"),\n\t\t\t\ttask: task || \"Initial session\",\n\t\t\t\tstartedAt: new Date().toISOString(),\n\t\t\t\tsnapshotCount: 0,\n\t\t\t};\n\n\t\t\tawait saveCurrentSession(newSession, state.workspaceRoot);\n\t\t\tstatus.success(\"Session started! You're ready to code.\");\n\t\t} catch (error) {\n\t\t\tstatus.warning(\"Could not start session\");\n\t\t}\n\t} else {\n\t\tstatus.info(\"Skipped session start - run 'snap session start' later\");\n\t}\n}\n\n// =============================================================================\n// MAIN WIZARD\n// =============================================================================\n\n/**\n * Run the interactive first-run wizard\n */\nasync function runWizard(options: { force?: boolean }): Promise<void> {\n\tconst { force } = options;\n\n\t// Check if already set up\n\tconst homeDir = process.env.HOME || process.env.USERPROFILE || \"\";\n\tconst configPath = path.join(homeDir, \".snapback\", \"wizard-complete\");\n\n\tif (!force && fs.existsSync(configPath)) {\n\t\tconsole.log(chalk.yellow(\"Setup wizard has already been completed.\"));\n\t\tconsole.log(chalk.gray(\"Run 'snap wizard --force' to run again.\\n\"));\n\n\t\tconst runAgain = await prompts.confirm({\n\t\t\tmessage: \"Run wizard again?\",\n\t\t\tdefault: false,\n\t\t});\n\n\t\tif (!runAgain) {\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Initialize state\n\tlet state: WizardState = {\n\t\tauthenticated: await checkAuthentication(),\n\t\tworkspaceRoot: null,\n\t\tprojectType: null,\n\t\tprotectionLevel: \"standard\",\n\t\tmcpEnabled: false,\n\t\tanalyticsEnabled: false,\n\t\tfilesProtected: false,\n\t\tgitHookInstalled: false,\n\t\tsnapshotCreated: false,\n\t};\n\n\t// Run wizard steps\n\ttry {\n\t\tawait welcomeStep();\n\t\tstate = await authenticationStep(state);\n\t\tstate = await workspaceStep(state);\n\t\tstate = await protectionStep(state);\n\t\tstate = await mcpStep(state);\n\t\tstate = await fileProtectionStep(state);\n\t\tstate = await gitHookStep(state);\n\t\tstate = await snapshotStep(state);\n\t\tstate = await analyticsStep(state);\n\t\tawait summaryStep(state);\n\t\tawait sessionStep(state);\n\n\t\t// Mark wizard as complete\n\t\tconst snapbackHome = path.join(homeDir, \".snapback\");\n\t\tfs.mkdirSync(snapbackHome, { recursive: true });\n\t\tfs.writeFileSync(configPath, new Date().toISOString());\n\t} catch (error) {\n\t\tif ((error as NodeJS.ErrnoException).code === \"ERR_USE_AFTER_CLOSE\") {\n\t\t\t// User pressed Ctrl+C\n\t\t\tconsole.log(chalk.gray(\"\\n\\nWizard cancelled. Run 'snap wizard' to continue.\\n\"));\n\t\t} else {\n\t\t\tthrow error;\n\t\t}\n\t}\n}\n\n// =============================================================================\n// COMMAND EXPORT\n// =============================================================================\n\nexport function createWizardCommand(): Command {\n\treturn new Command(\"wizard\")\n\t\t.description(\"Interactive setup wizard for new users\")\n\t\t.option(\"--force\", \"Run wizard even if already completed\")\n\t\t.action(async (options) => {\n\t\t\tawait runWizard(options);\n\t\t});\n}\n\n// Export runWizard for smart router usage\nexport { runWizard };\n","/**\n * CLI-UX-006: State Persistence\n *\n * Manages persistent state for Pioneer Program (points, achievements, streaks)\n * and user preferences across CLI sessions.\n *\n * @see ../resources/cli_ux_implementation/06-state-persistence.md\n */\n\nimport Conf from \"conf\";\n\n// =============================================================================\n// TYPE DEFINITIONS\n// =============================================================================\n// Spec Reference: ../resources/cli_ux_implementation/06-state-persistence.md\n\nexport interface PioneerStats {\n\tsnapshotsCreated: number;\n\trestoresPerformed: number;\n\trisksDetected: number;\n\tfilesAnalyzed: number;\n\thighRiskAverted: number;\n\tcurrentStreak: number;\n\tlongestStreak: number;\n\ttotalDaysActive: number;\n\tsharesGenerated: number;\n\tshareClicks: number;\n}\n\nexport interface UnlockedAchievement {\n\tid: string;\n\tunlockedAt: string;\n}\n\nexport interface PioneerState {\n\tpioneerNumber: number;\n\tlevel: \"bronze\" | \"silver\" | \"gold\" | \"platinum\";\n\ttotalPoints: number;\n\tunlockedAchievements: UnlockedAchievement[];\n\tstats: PioneerStats;\n\tcurrentStreak: number;\n\tlastActiveDate: string | null;\n\tcreatedAt: string;\n\tupdatedAt: string;\n}\n\nexport interface UserPreferences {\n\tverbosity: \"quiet\" | \"normal\" | \"verbose\";\n\tcolorScheme: \"auto\" | \"light\" | \"dark\" | \"none\";\n\tshowAchievements: boolean;\n\tshowProgress: boolean;\n\tdefaultSnapshot: {\n\t\tincludeNodeModules: boolean;\n\t\tincludeGitIgnored: boolean;\n\t};\n}\n\nexport interface SnapBackState {\n\tversion: number;\n\tpioneer: PioneerState;\n\tpreferences: UserPreferences;\n}\n\n// =============================================================================\n// DEFAULTS\n// =============================================================================\n\nconst DEFAULT_STATS: PioneerStats = {\n\tsnapshotsCreated: 0,\n\trestoresPerformed: 0,\n\trisksDetected: 0,\n\tfilesAnalyzed: 0,\n\thighRiskAverted: 0,\n\tcurrentStreak: 0,\n\tlongestStreak: 0,\n\ttotalDaysActive: 0,\n\tsharesGenerated: 0,\n\tshareClicks: 0,\n};\n\nconst DEFAULT_PREFERENCES: UserPreferences = {\n\tverbosity: \"normal\",\n\tcolorScheme: \"auto\",\n\tshowAchievements: true,\n\tshowProgress: true,\n\tdefaultSnapshot: {\n\t\tincludeNodeModules: false,\n\t\tincludeGitIgnored: false,\n\t},\n};\n\nfunction createDefaultPioneerState(): PioneerState {\n\treturn {\n\t\tpioneerNumber: generatePioneerNumber(),\n\t\tlevel: \"bronze\",\n\t\ttotalPoints: 0,\n\t\tunlockedAchievements: [],\n\t\tstats: { ...DEFAULT_STATS },\n\t\tcurrentStreak: 0,\n\t\tlastActiveDate: null,\n\t\tcreatedAt: new Date().toISOString(),\n\t\tupdatedAt: new Date().toISOString(),\n\t};\n}\n\nfunction generatePioneerNumber(): number {\n\tconst base = Date.now() % 10000;\n\tconst rand = Math.floor(Math.random() * 1000);\n\treturn base + rand;\n}\n\n// =============================================================================\n// SCHEMA FOR VALIDATION\n// =============================================================================\n\nconst SCHEMA = {\n\t// Schema validation handled by Conf library defaults\n} as const;\n\n// =============================================================================\n// STATE MANAGER CLASS\n// =============================================================================\n\nclass StateManager {\n\tprivate conf: Conf<SnapBackState>;\n\tprivate cache: SnapBackState | null = null;\n\n\tconstructor() {\n\t\tthis.conf = new Conf<SnapBackState>({\n\t\t\tprojectName: \"snapback\",\n\t\t\tprojectVersion: \"1.0.0\",\n\t\t\tschema: SCHEMA as any,\n\t\t\tdefaults: {\n\t\t\t\tversion: 1,\n\t\t\t\tpioneer: createDefaultPioneerState(),\n\t\t\t\tpreferences: DEFAULT_PREFERENCES,\n\t\t\t},\n\t\t\tmigrations: {\n\t\t\t\t// Future migrations go here\n\t\t\t},\n\t\t});\n\t}\n\n\t/**\n\t * Get Pioneer state\n\t */\n\tgetPioneerState(): PioneerState {\n\t\tif (!this.cache) {\n\t\t\tthis.cache = this.conf.store;\n\t\t}\n\t\treturn { ...this.cache.pioneer };\n\t}\n\n\t/**\n\t * Save Pioneer state\n\t */\n\tsavePioneerState(state: PioneerState): void {\n\t\tstate.updatedAt = new Date().toISOString();\n\t\tthis.conf.set(\"pioneer\", state);\n\t\tif (this.cache) {\n\t\t\tthis.cache.pioneer = state;\n\t\t}\n\t}\n\n\t/**\n\t * Get user preferences\n\t */\n\tgetPreferences(): UserPreferences {\n\t\treturn { ...this.conf.get(\"preferences\") };\n\t}\n\n\t/**\n\t * Update user preferences\n\t */\n\tsetPreferences(prefs: Partial<UserPreferences>): void {\n\t\tconst current = this.getPreferences();\n\t\tthis.conf.set(\"preferences\", { ...current, ...prefs });\n\t}\n\n\t/**\n\t * Reset all state (for testing/debugging)\n\t */\n\treset(): void {\n\t\tthis.conf.clear();\n\t\tthis.cache = null;\n\t}\n\n\t/**\n\t * Get storage file path (for debugging)\n\t */\n\tgetPath(): string {\n\t\treturn this.conf.path;\n\t}\n\n\t/**\n\t * Check if this is a fresh installation\n\t */\n\tisFirstRun(): boolean {\n\t\tconst pioneer = this.getPioneerState();\n\t\treturn (\n\t\t\tpioneer.stats.snapshotsCreated === 0 &&\n\t\t\tpioneer.stats.filesAnalyzed === 0 &&\n\t\t\tpioneer.unlockedAchievements.length === 0\n\t\t);\n\t}\n\n\t/**\n\t * Export state for backup\n\t */\n\texport(): SnapBackState {\n\t\treturn JSON.parse(JSON.stringify(this.conf.store));\n\t}\n\n\t/**\n\t * Import state from backup\n\t */\n\timport(state: SnapBackState): void {\n\t\tif (state.version !== this.conf.get(\"version\")) {\n\t\t\tthrow new Error(\"State version mismatch\");\n\t\t}\n\t\tthis.conf.store = state;\n\t\tthis.cache = null;\n\t}\n}\n\n// =============================================================================\n// SINGLETON EXPORT\n// =============================================================================\n\nexport const userState = new StateManager();\n\n// =============================================================================\n// UTILITY FUNCTIONS\n// =============================================================================\n\n/**\n * Get effective verbosity from preferences and CLI flags\n */\nexport function getEffectiveVerbosity(options: { quiet?: boolean; verbose?: boolean }): \"quiet\" | \"normal\" | \"verbose\" {\n\tif (options.quiet) {\n\t\treturn \"quiet\";\n\t}\n\tif (options.verbose) {\n\t\treturn \"verbose\";\n\t}\n\treturn userState.getPreferences().verbosity;\n}\n\n/**\n * Check if achievements should be displayed\n */\nexport function shouldShowAchievements(options: { quiet?: boolean }): boolean {\n\tif (options.quiet) {\n\t\treturn false;\n\t}\n\treturn userState.getPreferences().showAchievements;\n}\n\n/**\n * Check if progress should be displayed\n */\nexport function shouldShowProgress(options: { quiet?: boolean }): boolean {\n\tif (options.quiet) {\n\t\treturn false;\n\t}\n\treturn userState.getPreferences().showProgress;\n}\n","/**\n * Smart Errors Module\n *\n * World-class error handling with actionable suggestions.\n * Inspired by: Rust compiler, GitHub CLI, Vercel CLI\n *\n * Features:\n * - Colored error output with context\n * - Suggested fixes for common errors\n * - Command suggestions for typos\n * - Links to documentation\n * - Error codes for searchability\n *\n * @see https://bettercli.org/design/\n * @module ui/errors\n */\n\nimport boxen from \"boxen\";\nimport chalk from \"chalk\";\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport interface SmartError {\n\tcode: string;\n\ttitle: string;\n\tmessage: string;\n\tsuggestion?: string;\n\tcommand?: string;\n\tdocLink?: string;\n\tcontext?: Record<string, string>;\n}\n\nexport interface ErrorSuggestion {\n\tpattern: RegExp | string;\n\tsuggestion: string;\n\tcommand?: string;\n}\n\n// =============================================================================\n// ERROR CATALOG\n// =============================================================================\n\n/**\n * Known error patterns with helpful suggestions\n */\nexport const ERROR_SUGGESTIONS: ErrorSuggestion[] = [\n\t// Authentication errors\n\t{\n\t\tpattern: /not logged in|unauthorized|401/i,\n\t\tsuggestion: \"You need to authenticate first\",\n\t\tcommand: \"snap login\",\n\t},\n\t{\n\t\tpattern: /token expired|session expired/i,\n\t\tsuggestion: \"Your session has expired. Please log in again\",\n\t\tcommand: \"snap login\",\n\t},\n\t{\n\t\tpattern: /invalid.*api.*key/i,\n\t\tsuggestion: \"Your API key appears to be invalid. Get a new one at snapback.dev/settings\",\n\t\tcommand: \"snap login --api-key <your-key>\",\n\t},\n\n\t// Workspace errors\n\t{\n\t\tpattern: /not initialized|no.*\\.snapback/i,\n\t\tsuggestion: \"This workspace hasn't been set up for SnapBack yet\",\n\t\tcommand: \"snap init\",\n\t},\n\t{\n\t\tpattern: /already initialized/i,\n\t\tsuggestion: \"SnapBack is already configured here. Use --force to reinitialize\",\n\t\tcommand: \"snap init --force\",\n\t},\n\n\t// File errors\n\t{\n\t\tpattern: /ENOENT|file not found|no such file/i,\n\t\tsuggestion: \"The file or directory doesn't exist. Check the path and try again\",\n\t},\n\t{\n\t\tpattern: /EACCES|permission denied/i,\n\t\tsuggestion: \"You don't have permission to access this file. Check file permissions\",\n\t},\n\t{\n\t\tpattern: /EEXIST|already exists/i,\n\t\tsuggestion: \"A file with that name already exists. Use --force to overwrite\",\n\t},\n\n\t// Network errors\n\t{\n\t\tpattern: /ECONNREFUSED|connection refused/i,\n\t\tsuggestion: \"Cannot connect to the server. Check your internet connection\",\n\t\tcommand: \"snap doctor\",\n\t},\n\t{\n\t\tpattern: /ETIMEDOUT|timeout|timed out/i,\n\t\tsuggestion: \"The request timed out. The server may be slow or unreachable\",\n\t\tcommand: \"snap doctor\",\n\t},\n\t{\n\t\tpattern: /ENOTFOUND|DNS|network/i,\n\t\tsuggestion: \"Network error. Check your internet connection and try again\",\n\t\tcommand: \"snap doctor\",\n\t},\n\n\t// Git errors\n\t{\n\t\tpattern: /not a git repository/i,\n\t\tsuggestion: \"This directory is not a Git repository\",\n\t\tcommand: \"git init\",\n\t},\n\t{\n\t\tpattern: /git.*not.*installed|git.*not found/i,\n\t\tsuggestion: \"Git is required but not installed. Please install Git first\",\n\t},\n\n\t// Config errors\n\t{\n\t\tpattern: /invalid.*config|parse.*error.*json/i,\n\t\tsuggestion: \"The configuration file is malformed. Try resetting it\",\n\t\tcommand: \"snap config path\",\n\t},\n\n\t// MCP errors\n\t{\n\t\tpattern: /mcp.*not configured|no.*ai.*tools/i,\n\t\tsuggestion: \"No AI tools are configured for MCP integration\",\n\t\tcommand: \"snap tools configure\",\n\t},\n];\n\n// =============================================================================\n// COMMAND SUGGESTIONS (for typos)\n// =============================================================================\n\nconst KNOWN_COMMANDS = [\n\t\"login\",\n\t\"logout\",\n\t\"whoami\",\n\t\"init\",\n\t\"status\",\n\t\"fix\",\n\t\"protect\",\n\t\"session\",\n\t\"context\",\n\t\"validate\",\n\t\"stats\",\n\t\"learn\",\n\t\"patterns\",\n\t\"watch\",\n\t\"tools\",\n\t\"mcp\",\n\t\"config\",\n\t\"doctor\",\n\t\"upgrade\",\n\t\"analyze\",\n\t\"snapshot\",\n\t\"list\",\n\t\"check\",\n\t\"interactive\",\n\t\"help\",\n];\n\n/**\n * Calculate Levenshtein distance between two strings\n */\nfunction levenshteinDistance(a: string, b: string): number {\n\tconst matrix: number[][] = [];\n\n\tfor (let i = 0; i <= b.length; i++) {\n\t\tmatrix[i] = [i];\n\t}\n\tfor (let j = 0; j <= a.length; j++) {\n\t\tmatrix[0][j] = j;\n\t}\n\n\tfor (let i = 1; i <= b.length; i++) {\n\t\tfor (let j = 1; j <= a.length; j++) {\n\t\t\tif (b.charAt(i - 1) === a.charAt(j - 1)) {\n\t\t\t\tmatrix[i][j] = matrix[i - 1][j - 1];\n\t\t\t} else {\n\t\t\t\tmatrix[i][j] = Math.min(\n\t\t\t\t\tmatrix[i - 1][j - 1] + 1, // substitution\n\t\t\t\t\tmatrix[i][j - 1] + 1, // insertion\n\t\t\t\t\tmatrix[i - 1][j] + 1, // deletion\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn matrix[b.length][a.length];\n}\n\n/**\n * Find similar commands for typo suggestions\n */\nexport function findSimilarCommands(input: string, maxSuggestions = 3): string[] {\n\tconst inputLower = input.toLowerCase();\n\n\t// Calculate distances and filter\n\tconst suggestions = KNOWN_COMMANDS.map((cmd) => ({\n\t\tcommand: cmd,\n\t\tdistance: levenshteinDistance(inputLower, cmd),\n\t}))\n\t\t.filter((s) => s.distance <= 3) // Only suggest if within 3 edits\n\t\t.sort((a, b) => a.distance - b.distance)\n\t\t.slice(0, maxSuggestions)\n\t\t.map((s) => s.command);\n\n\treturn suggestions;\n}\n\n// =============================================================================\n// ERROR DISPLAY\n// =============================================================================\n\n/**\n * Display a smart error with suggestions\n */\nexport function displaySmartError(error: Error | SmartError | string): void {\n\tconst errorData = normalizeError(error);\n\n\t// Build error content\n\tconst lines: string[] = [];\n\n\t// Error code and title\n\tif (errorData.code) {\n\t\tlines.push(`${chalk.red.bold(`[${errorData.code}]`)} ${chalk.red.bold(errorData.title)}`);\n\t} else {\n\t\tlines.push(chalk.red.bold(errorData.title));\n\t}\n\n\tlines.push(\"\");\n\tlines.push(errorData.message);\n\n\t// Context information\n\tif (errorData.context && Object.keys(errorData.context).length > 0) {\n\t\tlines.push(\"\");\n\t\tfor (const [key, value] of Object.entries(errorData.context)) {\n\t\t\tlines.push(chalk.gray(`${key}: ${value}`));\n\t\t}\n\t}\n\n\t// Suggestion\n\tif (errorData.suggestion) {\n\t\tlines.push(\"\");\n\t\tlines.push(chalk.yellow(\" Suggestion:\"));\n\t\tlines.push(chalk.yellow(`   ${errorData.suggestion}`));\n\t}\n\n\t// Command to fix\n\tif (errorData.command) {\n\t\tlines.push(\"\");\n\t\tlines.push(chalk.cyan(\" Try running:\"));\n\t\tlines.push(chalk.cyan(`   $ ${errorData.command}`));\n\t}\n\n\t// Documentation link\n\tif (errorData.docLink) {\n\t\tlines.push(\"\");\n\t\tlines.push(chalk.gray(` More info: ${errorData.docLink}`));\n\t}\n\n\t// Display in box\n\tconsole.error(\n\t\tboxen(lines.join(\"\\n\"), {\n\t\t\tborderColor: \"red\",\n\t\t\tborderStyle: \"round\",\n\t\t\tpadding: 1,\n\t\t\tmargin: { top: 1, bottom: 1, left: 0, right: 0 },\n\t\t}),\n\t);\n}\n\n/**\n * Display unknown command error with suggestions\n */\nexport function displayUnknownCommandError(command: string): void {\n\tconst suggestions = findSimilarCommands(command);\n\n\tconst lines: string[] = [];\n\tlines.push(chalk.red.bold(`Unknown command: ${command}`));\n\tlines.push(\"\");\n\n\tif (suggestions.length > 0) {\n\t\tlines.push(chalk.yellow(\"Did you mean:\"));\n\t\tfor (const suggestion of suggestions) {\n\t\t\tlines.push(chalk.cyan(`  $ snap ${suggestion}`));\n\t\t}\n\t} else {\n\t\tlines.push(chalk.gray(\"Run 'snap --help' to see available commands\"));\n\t}\n\n\tconsole.error(\n\t\tboxen(lines.join(\"\\n\"), {\n\t\t\tborderColor: \"yellow\",\n\t\t\tborderStyle: \"round\",\n\t\t\tpadding: 1,\n\t\t}),\n\t);\n}\n\n/**\n * Normalize various error types to SmartError\n */\nfunction normalizeError(error: Error | SmartError | string): SmartError {\n\t// Already a SmartError\n\tif (typeof error === \"object\" && \"code\" in error && \"title\" in error) {\n\t\treturn error;\n\t}\n\n\t// String error\n\tif (typeof error === \"string\") {\n\t\treturn {\n\t\t\tcode: \"ERR_UNKNOWN\",\n\t\t\ttitle: \"Error\",\n\t\t\tmessage: error,\n\t\t\t...findErrorSuggestion(error),\n\t\t};\n\t}\n\n\t// Standard Error object\n\tconst message = error.message;\n\tconst suggestion = findErrorSuggestion(message);\n\n\treturn {\n\t\tcode: extractErrorCode(error) || \"ERR_UNKNOWN\",\n\t\ttitle: error.name || \"Error\",\n\t\tmessage,\n\t\t...suggestion,\n\t};\n}\n\n/**\n * Find a suggestion for an error message\n */\nfunction findErrorSuggestion(message: string): Partial<SmartError> {\n\tfor (const { pattern, suggestion, command } of ERROR_SUGGESTIONS) {\n\t\tconst regex = typeof pattern === \"string\" ? new RegExp(pattern, \"i\") : pattern;\n\t\tif (regex.test(message)) {\n\t\t\treturn { suggestion, command };\n\t\t}\n\t}\n\treturn {};\n}\n\n/**\n * Extract error code from error object\n */\nfunction extractErrorCode(error: Error & { code?: string }): string | undefined {\n\tif (error.code) return error.code;\n\n\t// Extract from error name\n\tif (error.name && error.name !== \"Error\") {\n\t\treturn error.name\n\t\t\t.toUpperCase()\n\t\t\t.replace(/ERROR$/, \"\")\n\t\t\t.replace(/\\s+/g, \"_\");\n\t}\n\n\treturn undefined;\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n/**\n * Create a SmartError with full context\n */\nexport function createSmartError(\n\tcode: string,\n\ttitle: string,\n\tmessage: string,\n\toptions?: {\n\t\tsuggestion?: string;\n\t\tcommand?: string;\n\t\tdocLink?: string;\n\t\tcontext?: Record<string, string>;\n\t},\n): SmartError {\n\treturn {\n\t\tcode,\n\t\ttitle,\n\t\tmessage,\n\t\t...options,\n\t};\n}\n\n/**\n * Wrap a function to display smart errors on failure\n */\nexport function withSmartErrors<T extends (...args: unknown[]) => Promise<unknown>>(\n\tfn: T,\n): (...args: Parameters<T>) => Promise<ReturnType<T>> {\n\treturn async (...args: Parameters<T>): Promise<ReturnType<T>> => {\n\t\ttry {\n\t\t\treturn (await fn(...args)) as ReturnType<T>;\n\t\t} catch (error) {\n\t\t\tdisplaySmartError(error instanceof Error ? error : String(error));\n\t\t\tprocess.exit(1);\n\t\t}\n\t};\n}\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { levenshteinDistance };\n","import { readdir, readFile } from \"node:fs/promises\";\nimport { join, relative, resolve } from \"node:path\";\nimport { checkbox, confirm, input, search } from \"@inquirer/prompts\";\nimport type { Snapshot, SnapshotStorage } from \"@snapback/contracts\";\nimport { createSnapshotStorage } from \"@snapback/contracts/types/snapshot\";\nimport { CLIEngineAdapter } from \"@snapback/engine/transports/cli\";\nimport chalk from \"chalk\";\nimport { Command } from \"commander\";\nimport ora from \"ora\";\n// New CLI commands\nimport {\n\t// Polish commands (Phase 6)\n\tcreateAliasCommand,\n\tcreateConfigCommand,\n\t// Intelligence (CLI-UX-005)\n\tcreateContextCommand,\n\tcreateDoctorCommand,\n\tcreateFixCommand,\n\t// Workspace management\n\tcreateInitCommand,\n\t// Learning\n\tcreateLearnCommand,\n\t// Auth\n\tcreateLoginCommand,\n\tcreateLogoutCommand,\n\tcreatePatternsCommand,\n\t// Protection\n\tcreateProtectCommand,\n\tcreateSessionCommand,\n\tcreateStatsCommand,\n\tcreateStatusCommand,\n\t// MCP\n\tcreateToolsCommand,\n\tcreateUndoCommand,\n\tcreateUpgradeCommand,\n\tcreateValidateCommand,\n\tcreateWatchCommand,\n\tcreateWhoamiCommand,\n\t// Interactive wizard\n\tcreateWizardCommand,\n\t// MCP Server\n\tmcpCommand,\n\trunWizard,\n} from \"./commands\";\n// CLI-UX-002: Git Client for staged files\nimport { GitClient, GitNotInstalledError, GitNotRepositoryError, isCodeFile } from \"./services/git-client\";\nimport { isLoggedIn, isSnapbackInitialized } from \"./services/snapback-dir\";\nimport { userState } from \"./services/state\";\n// Smart Errors UI\nimport { displayUnknownCommandError } from \"./ui/errors\";\n// CLI-UX-001, 003, 004: UX Utilities\nimport {\n\tcreateFileSummaryTable,\n\tcreateRiskSignalTable,\n\tcreateSnapshotTable,\n\tdisplayHighRiskWarning,\n\tdisplaySaveStory,\n\tdisplaySnapshotSuccess,\n\ttype FileRiskSummary,\n\tProgressTracker,\n} from \"./utils\";\n\n// V2 Engine adapter instance (replaces V1 Guardian)\nconst engineAdapter = new CLIEngineAdapter();\n\n// Helper function to recursively get all files\nasync function getAllFiles(dir: string, baseDir: string = dir): Promise<string[]> {\n\tconst files: string[] = [];\n\ttry {\n\t\tconst entries = await readdir(dir, { withFileTypes: true });\n\t\tfor (const entry of entries) {\n\t\t\tconst fullPath = join(dir, entry.name);\n\t\t\t// Skip node_modules, .git, and other common ignore patterns\n\t\t\tif (entry.name === \"node_modules\" || entry.name === \".git\" || entry.name.startsWith(\".\")) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (entry.isDirectory()) {\n\t\t\t\tfiles.push(...(await getAllFiles(fullPath, baseDir)));\n\t\t\t} else {\n\t\t\t\tfiles.push(relative(baseDir, fullPath));\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// Ignore permission errors\n\t}\n\treturn files;\n}\n\nexport function createCLI() {\n\tconst program = new Command();\n\tprogram.name(\"snapback\").description(\"AI-safe code snapshots and risk analysis\").alias(\"snap\");\n\n\t// =========================================================================\n\t// NEW COMMANDS - Customer MCP System\n\t// =======================================================================\n\n\t// Auth commands\n\tprogram.addCommand(createLoginCommand());\n\tprogram.addCommand(createLogoutCommand());\n\tprogram.addCommand(createWhoamiCommand());\n\n\t// Workspace management\n\tprogram.addCommand(createInitCommand());\n\tprogram.addCommand(createStatusCommand());\n\tprogram.addCommand(createFixCommand());\n\n\t// MCP tools configuration\n\tprogram.addCommand(createToolsCommand());\n\n\t// MCP server (--stdio)\n\tprogram.addCommand(mcpCommand);\n\n\t// Protection management\n\tprogram.addCommand(createProtectCommand());\n\n\t// Session management\n\tprogram.addCommand(createSessionCommand());\n\n\t// Intelligence (CLI-UX-005) - Brings internal MCP capabilities to customer CLI\n\tprogram.addCommand(createContextCommand());\n\tprogram.addCommand(createValidateCommand());\n\tprogram.addCommand(createStatsCommand());\n\n\t// Learning system\n\tprogram.addCommand(createLearnCommand());\n\tprogram.addCommand(createPatternsCommand());\n\n\t// Continuous watching\n\tprogram.addCommand(createWatchCommand());\n\n\t// =========================================================================\n\t// POLISH COMMANDS (Phase 6)\n\t// =========================================================================\n\n\t// Configuration management\n\tprogram.addCommand(createConfigCommand());\n\n\t// Diagnostics\n\tprogram.addCommand(createDoctorCommand());\n\n\t// Self-update\n\tprogram.addCommand(createUpgradeCommand());\n\n\t// Interactive wizard for first-time users\n\tprogram.addCommand(createWizardCommand());\n\n\t// Undo command for reverting operations\n\tprogram.addCommand(createUndoCommand());\n\n\t// Command aliases\n\tprogram.addCommand(createAliasCommand());\n\n\t// =========================================================================\n\t// ALIAS EXPANSION\n\t// =========================================================================\n\n\t// Hook into argument parsing to expand aliases\n\tprogram.hook(\"preAction\", (_thisCommand) => {\n\t\t// Note: alias expansion is handled at parse time\n\t\t// This hook is here for future expansion features\n\t});\n\n\t// =========================================================================\n\t// UNKNOWN COMMAND HANDLER (Smart Error Suggestions)\n\t// =========================================================================\n\n\tprogram.on(\"command:*\", (unknownCommand: string[]) => {\n\t\tconst cmd = unknownCommand[0];\n\t\tdisplayUnknownCommandError(cmd);\n\t\tprocess.exit(1);\n\t});\n\n\t// =========================================================================\n\t// EXISTING COMMANDS\n\t// =========================================================================\n\n\tprogram\n\t\t.command(\"analyze <file>\")\n\t\t.option(\"-i, --interactive\", \"Interactive mode with detailed analysis\")\n\t\t.option(\"-a, --ast\", \"Use AST-based analysis for deeper insights\")\n\t\t.action(async (file) => {\n\t\t\ttry {\n\t\t\t\tconst fullPath = resolve(process.cwd(), file);\n\t\t\t\tconst text = await readFile(fullPath, \"utf-8\");\n\n\t\t\t\tconst spinner = ora(\"Analyzing file...\").start();\n\n\t\t\t\t// Use V2 engine adapter for analysis\n\t\t\t\tconst result = await engineAdapter.analyze({\n\t\t\t\t\tfiles: [{ path: file, content: text }],\n\t\t\t\t\tformat: \"json\",\n\t\t\t\t});\n\n\t\t\t\tspinner.succeed(\"Analysis complete\");\n\n\t\t\t\t// Parse the JSON output if available\n\t\t\t\tlet riskData: {\n\t\t\t\t\triskScore: number;\n\t\t\t\t\triskLevel: string;\n\t\t\t\t\tsignals?: Array<{ signal: string; value: number }>;\n\t\t\t\t};\n\t\t\t\ttry {\n\t\t\t\t\triskData = JSON.parse(result.output);\n\t\t\t\t} catch {\n\t\t\t\t\triskData = { riskScore: result.riskScore, riskLevel: result.riskLevel };\n\t\t\t\t}\n\n\t\t\t\tconsole.log(chalk.cyan(\"Risk Level:\"), riskData.riskLevel.toUpperCase());\n\t\t\t\tconsole.log(chalk.cyan(\"Risk Score:\"), `${riskData.riskScore.toFixed(1)}/10`);\n\n\t\t\t\t// Display risk signals in formatted table (CLI-UX-003)\n\t\t\t\tif (riskData.signals && riskData.signals.length > 0) {\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(createRiskSignalTable(riskData.signals));\n\t\t\t\t}\n\n\t\t\t\t// Display boxed warning for high-risk files (CLI-UX-001)\n\t\t\t\tif (riskData.riskScore > 7) {\n\t\t\t\t\tconsole.log();\n\t\t\t\t\tconsole.log(displayHighRiskWarning(file, riskData.riskScore));\n\t\t\t\t} else if (riskData.riskScore > 4) {\n\t\t\t\t\tconsole.log(chalk.yellow(\"\\nRecommendation: Review changes before proceeding.\"));\n\t\t\t\t}\n\t\t\t} catch (error: any) {\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tprogram\n\t\t.command(\"snapshot\")\n\t\t.option(\"-m, --message <message>\", \"Add a message to the snapshot\")\n\t\t.option(\"-f, --files <files...>\", \"Specify files to include in snapshot\")\n\t\t.action(async (options) => {\n\t\t\tconst spinner = ora(\"Creating snapshot...\").start();\n\n\t\t\ttry {\n\t\t\t\tconst storage: SnapshotStorage = await createSnapshotStorage(process.cwd());\n\t\t\t\tconst snap = await storage.create({\n\t\t\t\t\tdescription: options.message,\n\t\t\t\t\tprotected: false,\n\t\t\t\t\t...(options.files && { files: options.files }),\n\t\t\t\t});\n\n\t\t\t\tspinner.succeed(\"Snapshot created\");\n\n\t\t\t\t// Display boxed success output (CLI-UX-001)\n\t\t\t\tconsole.log();\n\t\t\t\tconsole.log(displaySnapshotSuccess(snap.id, options.message, options.files?.length || 0));\n\t\t\t} catch (error: any) {\n\t\t\t\tspinner.fail(\"Failed to create snapshot\");\n\t\t\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\tprogram.command(\"list\").action(async () => {\n\t\tconst spinner = ora(\"Loading snapshots...\").start();\n\n\t\ttry {\n\t\t\tconst storage: SnapshotStorage = await createSnapshotStorage(process.cwd());\n\t\t\tconst snaps = await storage.list();\n\n\t\t\tspinner.succeed(\"Snapshots loaded\");\n\n\t\t\tif (snaps.length === 0) {\n\t\t\t\tconsole.log(chalk.yellow(\"No snapshots found\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Display snapshots in formatted table (CLI-UX-003)\n\t\t\tconsole.log();\n\t\t\tconsole.log(\n\t\t\t\tcreateSnapshotTable(\n\t\t\t\t\tsnaps.map((s: Snapshot) => ({\n\t\t\t\t\t\tid: s.id,\n\t\t\t\t\t\ttimestamp: new Date(s.timestamp),\n\t\t\t\t\t\tmessage: s.meta?.message,\n\t\t\t\t\t\tfileCount: s.files?.length,\n\t\t\t\t\t})),\n\t\t\t\t),\n\t\t\t);\n\t\t} catch (error: any) {\n\t\t\tspinner.fail(\"Failed to load snapshots\");\n\t\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t\t\tprocess.exit(1);\n\t\t}\n\t});\n\n\tprogram\n\t\t.command(\"interactive\")\n\t\t.description(\"Interactive mode with guided workflow\")\n\t\t.action(async () => {\n\t\t\tconsole.log(chalk.blue(\"Welcome to SnapBack Interactive Mode!\"));\n\n\t\t\tconst action = await search({\n\t\t\t\tmessage: \"What would you like to do?\",\n\t\t\t\tsource: async (term) => {\n\t\t\t\t\tconst choices = [\n\t\t\t\t\t\t{ name: \"Analyze a file\", value: \"analyze\" },\n\t\t\t\t\t\t{ name: \"Create a snapshot\", value: \"snapshot\" },\n\t\t\t\t\t\t{ name: \"List snapshots\", value: \"list\" },\n\t\t\t\t\t\t{ name: \"Exit\", value: \"exit\" },\n\t\t\t\t\t];\n\t\t\t\t\tif (!term) {\n\t\t\t\t\t\treturn choices;\n\t\t\t\t\t}\n\t\t\t\t\treturn choices.filter((c) => c.name.toLowerCase().includes(term.toLowerCase()));\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tswitch (action) {\n\t\t\t\tcase \"analyze\":\n\t\t\t\t\tawait interactiveAnalyze();\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"snapshot\":\n\t\t\t\t\tawait interactiveSnapshot();\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"list\":\n\t\t\t\t\tawait interactiveList();\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"exit\":\n\t\t\t\t\tconsole.log(chalk.blue(\"Goodbye!\"));\n\t\t\t\t\tprocess.exit(0);\n\t\t\t}\n\t\t});\n\n\tprogram\n\t\t.command(\"check\")\n\t\t.description(\"Pre-commit hook to check for risky AI changes\")\n\t\t.option(\"-s, --snapshot\", \"Create snapshot if risky changes detected\")\n\t\t.option(\"-q, --quiet\", \"Suppress output unless issues found\")\n\t\t.option(\"-a, --all\", \"Check all files, not just staged (legacy behavior)\")\n\t\t.action(async (options) => {\n\t\t\tconst cwd = process.cwd();\n\n\t\t\ttry {\n\t\t\t\t// CLI-UX-002: Use GitClient for staged files\n\t\t\t\tconst git = new GitClient({ cwd });\n\n\t\t\t\t// Validate git environment\n\t\t\t\tif (!(await git.isGitInstalled())) {\n\t\t\t\t\tthrow new GitNotInstalledError();\n\t\t\t\t}\n\n\t\t\t\tif (!(await git.isGitRepository())) {\n\t\t\t\t\tthrow new GitNotRepositoryError(cwd);\n\t\t\t\t}\n\n\t\t\t\t// Get files to check\n\t\t\t\tlet filesToCheck: string[];\n\n\t\t\t\tif (options.all) {\n\t\t\t\t\t// Legacy behavior: all files\n\t\t\t\t\tconst allFiles = await getAllFiles(cwd);\n\t\t\t\t\tfilesToCheck = allFiles.filter(isCodeFile);\n\t\t\t\t} else {\n\t\t\t\t\t// New behavior: staged files only (CLI-UX-002)\n\t\t\t\t\tconst stagedFiles = await git.getStagedFiles();\n\t\t\t\t\tfilesToCheck = stagedFiles\n\t\t\t\t\t\t.filter((f) => f.status !== \"deleted\")\n\t\t\t\t\t\t.filter((f) => isCodeFile(f.path))\n\t\t\t\t\t\t.map((f) => f.path);\n\t\t\t\t}\n\n\t\t\t\tif (filesToCheck.length === 0) {\n\t\t\t\t\tif (!options.quiet) {\n\t\t\t\t\t\tconsole.log(chalk.green(\"\\u2713 No staged code files to check\"));\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// CLI-UX-004: Use ProgressTracker for real-time feedback\n\t\t\t\tconst progress = new ProgressTracker({\n\t\t\t\t\ttotal: filesToCheck.length,\n\t\t\t\t\tlabel: \"Analyzing\",\n\t\t\t\t\tquiet: options.quiet,\n\t\t\t\t});\n\n\t\t\t\tprogress.start();\n\n\t\t\t\tconst fileResults: FileRiskSummary[] = [];\n\t\t\t\tlet hasRiskyChanges = false;\n\n\t\t\t\tfor (const file of filesToCheck) {\n\t\t\t\t\tprogress.update(file);\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Get content - staged version or working directory\n\t\t\t\t\t\tconst content = options.all\n\t\t\t\t\t\t\t? await readFile(resolve(cwd, file), \"utf-8\")\n\t\t\t\t\t\t\t: await git.getStagedContent(file);\n\n\t\t\t\t\t\tconst result = await engineAdapter.analyze({\n\t\t\t\t\t\t\tfiles: [{ path: file, content }],\n\t\t\t\t\t\t\tformat: \"json\",\n\t\t\t\t\t\t\tquiet: true,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tlet signals: Array<{ signal: string; value: number }> = [];\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst data = JSON.parse(result.output);\n\t\t\t\t\t\t\tsignals = data.signals || [];\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Output wasn't JSON\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst riskLevel = result.riskScore > 7 ? \"high\" : result.riskScore > 4 ? \"medium\" : \"low\";\n\n\t\t\t\t\t\tfileResults.push({\n\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t\triskScore: result.riskScore,\n\t\t\t\t\t\t\triskLevel,\n\t\t\t\t\t\t\ttopSignal: signals.filter((s) => s.value > 0)[0]?.signal,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (result.riskScore > 5) {\n\t\t\t\t\t\t\thasRiskyChanges = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Skip files that can't be analyzed (binary, permissions, etc.)\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Summary statistics\n\t\t\t\tconst highRisk = fileResults.filter((f) => f.riskScore > 7).length;\n\t\t\t\tconst mediumRisk = fileResults.filter((f) => f.riskScore > 4 && f.riskScore <= 7).length;\n\n\t\t\t\tif (hasRiskyChanges) {\n\t\t\t\t\tprogress.fail(\n\t\t\t\t\t\t`Found risks in ${highRisk + mediumRisk} files (${highRisk} high, ${mediumRisk} medium) - ${progress.getElapsed()}`,\n\t\t\t\t\t);\n\n\t\t\t\t\t// CLI-UX-003: Display results in formatted table\n\t\t\t\t\tif (!options.quiet && fileResults.length > 0) {\n\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t\tconsole.log(chalk.cyan(\"Analysis Results:\"));\n\t\t\t\t\t\tconsole.log(createFileSummaryTable(fileResults));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (options.snapshot) {\n\t\t\t\t\t\tconst snapshotSpinner = ora(\"Creating snapshot...\").start();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst storage: SnapshotStorage = await createSnapshotStorage(cwd);\n\t\t\t\t\t\t\tconst snap = await storage.create({\n\t\t\t\t\t\t\t\tdescription: \"Pre-commit snapshot for risky AI changes\",\n\t\t\t\t\t\t\t\tprotected: true,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tsnapshotSpinner.succeed(`Snapshot created: ${snap.id.substring(0, 8)}`);\n\n\t\t\t\t\t\t\t// CLI-UX-001: Display save story\n\t\t\t\t\t\t\tconst maxRiskScore = Math.max(...fileResults.map((f) => f.riskScore));\n\t\t\t\t\t\t\tconsole.log();\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\tdisplaySaveStory(\n\t\t\t\t\t\t\t\t\tmaxRiskScore,\n\t\t\t\t\t\t\t\t\tfileResults.map((f) => f.file),\n\t\t\t\t\t\t\t\t\tsnap.id,\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t} catch (error: any) {\n\t\t\t\t\t\t\tsnapshotSpinner.fail(\"Failed to create snapshot\");\n\t\t\t\t\t\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t\t\t\t\t\t\tprocess.exit(1);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (!options.quiet) {\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\tchalk.yellow(\n\t\t\t\t\t\t\t\t\"\\n\\ud83d\\udca1 Recommendation: Consider creating a snapshot before committing\",\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(chalk.gray(\"Run with --snapshot flag to automatically create a snapshot\"));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!options.quiet) {\n\t\t\t\t\t\tconsole.log(chalk.gray(\"\\nTo bypass this check, use: git commit --no-verify\"));\n\t\t\t\t\t}\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t} else {\n\t\t\t\t\tprogress.complete(\n\t\t\t\t\t\t`No risky changes detected in ${filesToCheck.length} files - ${progress.getElapsed()}`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} catch (error: any) {\n\t\t\t\tif (error instanceof GitNotInstalledError) {\n\t\t\t\t\tconsole.error(chalk.red(\"Error:\"), \"Git must be installed to use the check command\");\n\t\t\t\t\tconsole.log(chalk.gray(\"Install git: https://git-scm.com/downloads\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tif (error instanceof GitNotRepositoryError) {\n\t\t\t\t\tconsole.error(chalk.red(\"Error:\"), \"This command must be run inside a git repository\");\n\t\t\t\t\tconsole.log(chalk.gray(\"Initialize with: git init\"));\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\n\t\t\t\tif (!options.quiet) {\n\t\t\t\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t\t\t\t}\n\t\t\t\tprocess.exit(1);\n\t\t\t}\n\t\t});\n\n\treturn program;\n}\n\nasync function interactiveAnalyze() {\n\tconst cwd = process.cwd();\n\tconst allFiles = await getAllFiles(cwd);\n\n\tconst file = await search({\n\t\tmessage: \"Search for the file you want to analyze:\",\n\t\tsource: async (term) => {\n\t\t\tif (!term) {\n\t\t\t\treturn allFiles.slice(0, 10).map((f) => ({ value: f }));\n\t\t\t}\n\t\t\tconst filtered = allFiles.filter((f) => f.toLowerCase().includes(term.toLowerCase()));\n\t\t\treturn filtered.slice(0, 10).map((f) => ({ value: f }));\n\t\t},\n\t});\n\n\t// Note: AST option is now handled internally by V2 engine signals (complexity, cycles)\n\tconst answers = { file };\n\n\ttry {\n\t\tconst fullPath = resolve(process.cwd(), answers.file);\n\t\tconst text = await readFile(fullPath, \"utf-8\");\n\n\t\tconst spinner = ora(\"Analyzing file...\").start();\n\n\t\t// Use V2 engine adapter for analysis\n\t\tconst result = await engineAdapter.analyze({\n\t\t\tfiles: [{ path: answers.file, content: text }],\n\t\t\tformat: \"json\",\n\t\t});\n\n\t\tspinner.succeed(\"Analysis complete\");\n\n\t\t// Parse and display results\n\t\tlet riskData: { riskScore: number; riskLevel: string; signals?: Array<{ signal: string; value: number }> };\n\t\ttry {\n\t\t\triskData = JSON.parse(result.output);\n\t\t} catch {\n\t\t\triskData = { riskScore: result.riskScore, riskLevel: result.riskLevel };\n\t\t}\n\n\t\tconsole.log(chalk.cyan(\"Risk Level:\"), riskData.riskLevel.toUpperCase());\n\t\tconsole.log(chalk.cyan(\"Risk Score:\"), `${riskData.riskScore.toFixed(1)}/10`);\n\n\t\tif (riskData.signals && riskData.signals.length > 0) {\n\t\t\tconst activeSignals = riskData.signals.filter((s) => s.value > 0);\n\t\t\tif (activeSignals.length > 0) {\n\t\t\t\tconsole.log(chalk.yellow(\"\\nRisk Factors:\"));\n\t\t\t\tactiveSignals.forEach((signal) => {\n\t\t\t\t\tconsole.log(chalk.yellow(`   ${signal.signal}: ${signal.value.toFixed(1)}`));\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Ask if user wants to create a snapshot (V2 uses 0-10 scale, 5 = medium risk)\n\t\tconst createSnapshotPrompt = await confirm({\n\t\t\tmessage: \"Would you like to create a snapshot?\",\n\t\t\tdefault: riskData.riskScore > 5,\n\t\t});\n\n\t\tif (createSnapshotPrompt) {\n\t\t\tawait interactiveSnapshot({ files: [answers.file] });\n\t\t}\n\t} catch (error: any) {\n\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t}\n}\n\nasync function interactiveSnapshot(options: { files?: string[] } = {}) {\n\tconst message = await input({\n\t\tmessage: \"Add a message to your snapshot (optional):\",\n\t\tdefault: \"\",\n\t});\n\n\tlet files: string[] = options.files || [];\n\n\tif (!options.files || options.files.length === 0) {\n\t\tconst includeFiles = await confirm({\n\t\t\tmessage: \"Include specific files in this snapshot?\",\n\t\t\tdefault: false,\n\t\t});\n\n\t\tif (includeFiles) {\n\t\t\tconst cwd = process.cwd();\n\t\t\tconst allFiles = await getAllFiles(cwd);\n\n\t\t\tfiles = await checkbox({\n\t\t\t\tmessage: \"Select files to include in snapshot (use space to select):\",\n\t\t\t\tchoices: allFiles.slice(0, 50).map((f) => ({ value: f, name: f })),\n\t\t\t});\n\t\t}\n\t}\n\n\tconst spinner = ora(\"Creating snapshot...\").start();\n\n\ttry {\n\t\tconst storage: SnapshotStorage = await createSnapshotStorage(process.cwd());\n\t\tconst snap = await storage.create({\n\t\t\tdescription: message,\n\t\t\tprotected: false,\n\t\t\t...(files.length > 0 && { files }),\n\t\t});\n\n\t\tspinner.succeed(\"Snapshot created\");\n\t\tconsole.log(chalk.green(\"Created snapshot\"), snap.id);\n\t} catch (error: any) {\n\t\tspinner.fail(\"Failed to create snapshot\");\n\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t}\n}\n\nasync function interactiveList() {\n\tconst spinner = ora(\"Loading snapshots...\").start();\n\n\ttry {\n\t\tconst storage: SnapshotStorage = await createSnapshotStorage(process.cwd());\n\t\tconst snaps: Snapshot[] = await storage.list();\n\n\t\tspinner.succeed(\"Snapshots loaded\");\n\n\t\tif (snaps.length === 0) {\n\t\t\tconsole.log(chalk.yellow(\"No snapshots found\"));\n\t\t\treturn;\n\t\t}\n\n\t\t// Show detailed snapshot information\n\t\tconsole.log(chalk.blue(\"\\nSnapshots:\"));\n\t\tsnaps.forEach((snap: Snapshot, index: number) => {\n\t\t\tconsole.log(chalk.gray(`\\n${index + 1}. ${snap.id.substring(0, 8)}`));\n\t\t\tconsole.log(chalk.gray(`   Time: ${new Date(snap.timestamp).toISOString()}`));\n\t\t\tif (snap.meta?.message) {\n\t\t\t\tconsole.log(chalk.gray(`   Message: ${snap.meta.message}`));\n\t\t\t}\n\t\t\t// Note: The storage interface doesn't currently support files property\n\t\t\t// This would need to be added to the storage interface if needed\n\t\t});\n\t} catch (error: any) {\n\t\tspinner.fail(\"Failed to load snapshots\");\n\t\tconsole.error(chalk.red(\"Error:\"), error.message);\n\t}\n}\n\n// =============================================================================\n// SMART ROUTER - Intelligent no-args behavior\n// =============================================================================\n\n/**\n * Smart router for `snap` with no arguments.\n * Routes based on CLI state:\n * - First run  Launch wizard\n * - Not authenticated  Prompt login\n * - Not initialized  Prompt init\n * - Otherwise  Show status dashboard\n *\n * @returns true if handled (caller should exit), false to continue normal parsing\n */\nasync function smartRouter(): Promise<boolean> {\n\t// Only trigger for `snap` with no args (node, snap = 2 args)\n\tif (process.argv.length > 2) {\n\t\treturn false;\n\t}\n\n\tconst cwd = process.cwd();\n\n\ttry {\n\t\tconst isFirstRun = userState.isFirstRun();\n\t\tconst authenticated = await isLoggedIn();\n\t\tconst initialized = await isSnapbackInitialized(cwd);\n\n\t\tif (isFirstRun) {\n\t\t\t// First time user - run full wizard\n\t\t\tawait runWizard({ force: false });\n\t\t\treturn true;\n\t\t}\n\n\t\tif (!authenticated) {\n\t\t\tconsole.log(chalk.yellow(\"Not logged in.\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap login\"));\n\t\t\tconsole.log();\n\t\t\tconsole.log(chalk.gray(\"Or run: snap wizard  for guided setup\"));\n\t\t\treturn true;\n\t\t}\n\n\t\tif (!initialized) {\n\t\t\tconsole.log(chalk.yellow(\"Workspace not initialized.\"));\n\t\t\tconsole.log(chalk.gray(\"Run: snap init\"));\n\t\t\tconsole.log();\n\t\t\tconsole.log(chalk.gray(\"Or run: snap wizard  for guided setup\"));\n\t\t\treturn true;\n\t\t}\n\n\t\t// Show dashboard (status command)\n\t\tconst statusCommand = createStatusCommand();\n\t\tawait statusCommand.parseAsync([\"node\", \"snap\"]);\n\t\treturn true;\n\t} catch {\n\t\t// On any error, fall through to normal CLI behavior\n\t\treturn false;\n\t}\n}\n\n// Only execute the CLI if this file is run directly\nif (import.meta.url === new URL(process.argv[1], `file://${process.platform === \"win32\" ? \"/\" : \"\"}`).href) {\n\t(async () => {\n\t\t// Try smart routing first\n\t\tif (await smartRouter()) {\n\t\t\tprocess.exit(0);\n\t\t}\n\n\t\t// Otherwise, proceed with normal CLI parsing\n\t\tconst program = createCLI();\n\t\tawait program.parseAsync(process.argv);\n\t})();\n}\n\n// Export the program for testing\nexport const program = createCLI();\n"]}